<!DOCTYPE html>
<html lang="en">
<head>
<!--  2024-08-30 Fri 11:48  -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‎</title>
<meta name="author" content="Vindaar" />
<meta name="generator" content="Org Mode" />

<link type="text/css" rel="stylesheet" href="org_html_export.css" />
<script type="text/javascript">

document.addEventListener('DOMContentLoaded', function() {
    // Set the initial width for subfigures and their images
    document.querySelectorAll('figure.subfigure[data-width]').forEach(function(subfigure) {
        subfigure.style.width = subfigure.getAttribute('data-width');
    });

    document.querySelectorAll('figure.subfigure img[data-width]').forEach(function(img) {
        img.style.width = img.getAttribute('data-width');
    });

    // Event listener for images within subfigures
    document.querySelectorAll('figure.subfigure img[data-width]').forEach(function(img) {
        img.addEventListener('click', function() {
            // Determine the .figure-wrapper that contains the clicked image
            let wrapper = this.closest('.figure-wrapper');

            // If found, adjust the sizes of its subfigures
            if (wrapper) {
                let subfigures = wrapper.querySelectorAll('figure.subfigure');
                subfigures.forEach(subfigure => {
                    let width = parseFloat(subfigure.getAttribute('data-width'));
                    if (width < 50) { // Double size if less than 50%
                        subfigure.setAttribute('data-width', (width * 2) + '%');
                        subfigure.style.width = (width * 2) + '%';
                    } else { // Halve size otherwise
                        subfigure.setAttribute('data-width', (width / 2) + '%');
                        subfigure.style.width = (width / 2) + '%';
                    }
                });
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', function () {
    var headers = document.querySelectorAll('h1 .extended, h2 .extended, h3 .extended, h4 .extended, h5 .extended, h6 .extended');

    headers.forEach(function (header) {
        var foldableHeader = header.closest('h1, h2, h3, h4, h5, h6');
        if (foldableHeader) {
            foldableHeader.classList.add('foldable-header');
            var nextElement = foldableHeader.nextElementSibling;
            var contentToFold = [];
            while (nextElement && !nextElement.matches('h1, h2, h3, h4, h5, h6')) {
                contentToFold.push(nextElement);
                nextElement = nextElement.nextElementSibling;
            }
            contentToFold.forEach(function (element) {
                element.classList.add('folded-content');
            });

            foldableHeader.addEventListener('click', function () {
                contentToFold.forEach(function (element) {
                    if (element.style.display === 'none' || element.style.display == '') {
                        element.style.display = 'block';
                    } else {
                        element.style.display = 'none';
                    }
                });
            });
        }
    });
});

</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
<!-- /* --><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js", "[Contrib]/siunitx/siunitx.js", "[Contrib]/mhchem/mhchem.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"], ['$', '$'], ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 1.0,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        },
        TeX: {
              equationNumbers: { autoNumber: 'AMS' },
              Macros: {
                  ccsini: '{\\mathrm{Si}₃\\mathrm{N}₄}',
                  cefe: '{\\ce{^{55}Fe}}',
                  vektor: ['{\\begin{pmatrix}#1\\end{pmatrix}}', 1],
                  mtrix: ['{\\begin{pmatrix}#1\\end{pmatrix}}', 1],
                  cp: '{\\mathrm{CP}}',
                  cpt: '{\\mathrm{CPT}}',
                  dd: '{\\mathop{}\\!{\\mathrm{d}}}',
                  sinc: '{\\mathrm{sinc}}'
              }
        }
    });
/*]]>*///--&gt;
</script>
</head>
<body>
<div id="content" class="content">
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li>  <a href="./errata.html#sec:errata">1. Errata   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./introduction.html#sec:introduction">2. Introduction   <span class="tag">    <span class="Intro">Intro</span>  </span></a></li>
<li><a href="./about_thesis.html#sec:about_thesis">3. About this thesis   <span class="tag">  <span class="Intro">Intro</span></span></a>
<ul>
<li>  <a href="./about_thesis.html#orga1b3e2a">3.1. Extended notes for the extended thesis <code>[/]</code>   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./about_thesis.html#org38dbc88">3.2. Why Org mode   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./about_thesis.html#orgb22ef6d">3.3. Notes for future PhD students and IAXO analyses   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./theory.html#sec:theory">4. Theory of axions   <span class="tag">  <span class="Theory">Theory</span></span></a>
<ul>
<li>  <a href="./theory.html#sec:theory:useful_reading_material">4.1. Useful reading material   <span class="tag">    <span class="optional">optional</span>  </span></a></li>
<li>  <a href="./theory.html#sec:theory:illustration_cpt">4.2. Illustration of the \cpt symmetry <code>[/]</code>   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./theory.html#sec:theory:invisible_axion_models">4.3. Invisible axion models and axion couplings</a></li>
<li>  <a href="./theory.html#sec:theory:axion_interactions">4.4. Implications for axion interactions - conversion probability</a></li>
<li>  <a href="./theory.html#sec:theory:solar_axion_flux">4.5. Solar axion flux</a></li>
<li>  <a href="./theory.html#sec:theory:chameleon">4.6. Chameleons</a></li>
<li>  <a href="./theory.html#sec:theory:current_bounds">4.7. Current bounds on coupling constants</a></li>
</ul>
</li>
<li><a href="./helioscopes.html#sec:helioscopes">5. Axion helioscopes   <span class="tag">  <span class="Theory">Theory</span></span></a>
<ul>
<li>  <a href="./helioscopes.html#sec:helioscopes:cast">5.1. CERN Axion Solar Telescope (CAST)</a></li>
<li>  <a href="./helioscopes.html#sec:helioscopes:iaxo">5.2. International AXion Observatory (IAXO)</a></li>
</ul>
</li>
<li><a href="./theory_detector.html#sec:theory_detector">6. X-rays, cosmic muons and gaseous detectors   <span class="tag">  <span class="Theory">Theory</span></span></a>
<ul>
<li>  <a href="./theory_detector.html#sec:theory:particle_int">6.1. Particle interactions with matter</a></li>
<li>  <a href="./theory_detector.html#sec:theory:cosmic_radiation">6.2. Cosmic rays</a></li>
<li>  <a href="./theory_detector.html#sec:theory:gas_fundamentals">6.3. Gaseous detector fundamentals</a></li>
</ul>
</li>
<li><a href="./septemboard.html#sec:septemboard">7. Septemboard detector   <span class="tag">  <span class="Detector">Detector</span></span></a>
<ul>
<li>  <a href="./septemboard.html#sec:detector:micromegas">7.1. Micromegas working principle</a></li>
<li>  <a href="./septemboard.html#sec:detector:timepix">7.2. Timepix ASIC</a></li>
<li>  <a href="./septemboard.html#sec:detector:gridpix">7.3. GridPix</a></li>
<li>  <a href="./septemboard.html#sec:detector:detector_2014_15">7.4. 2014 / 2015 GridPix detector for CAST</a></li>
<li>  <a href="./septemboard.html#sec:detector:detector_overview">7.5. Septemboard detector overview</a></li>
<li>  <a href="./septemboard.html#org15645f3">7.6. Detector readout system</a></li>
<li>  <a href="./septemboard.html#sec:detector:scintillators">7.7. Scintillator vetoes</a></li>
<li>  <a href="./septemboard.html#sec:detector:fadc">7.8. FADC</a></li>
<li>  <a href="./septemboard.html#sec:detector:sin_window">7.9. SiN window</a></li>
<li>  <a href="./septemboard.html#sec:detector:septemboard">7.10. Septemboard - 6 GridPixes around a center one</a></li>
<li>  <a href="./septemboard.html#sec:detector:water_cooling">7.11. Water cooling and temperature readout for the septemboard</a></li>
<li>  <a href="./septemboard.html#sec:septem:efficiency">7.12. Detector efficiency</a></li>
<li>  <a href="./septemboard.html#sec:detector:daq">7.13. Data acquisition and detector monitoring</a></li>
</ul>
</li>
<li><a href="./operation_calibration.html#sec:operation_calibration">8. Detector calibration for operation   <span class="tag">  <span class="Detector">Detector</span></span></a>
<ul>
<li>  <a href="./operation_calibration.html#sec:operation_calibration:timepix">8.1. Timepix calibrations</a></li>
<li>  <a href="./operation_calibration.html#sec:operation_calibration:fadc">8.2. FADC calibration</a></li>
<li>  <a href="./operation_calibration.html#sec:operation_calibration:scintillators">8.3. Scintillator calibration</a></li>
</ul>
</li>
<li><a href="./reconstruction.html#sec:reconstruction">9. Data reconstruction   <span class="tag">  <span class="Reconstruction">Reconstruction</span></span></a>
<ul>
<li>  <a href="./reconstruction.html#sec:reco:tpa">9.1. <code>TimepixAnalysis</code> and Nim</a></li>
<li>  <a href="./reconstruction.html#sec:reco:tos_data_parsing">9.2. TOS data parsing</a></li>
<li>  <a href="./reconstruction.html#sec:reco:event_shape">9.3. Expectation of event shapes</a></li>
<li>  <a href="./reconstruction.html#sec:reco:data_reconstruction">9.4. Data reconstruction</a></li>
<li>  <a href="./reconstruction.html#sec:reco:fadc_data">9.5. FADC reconstruction</a></li>
<li>  <a href="./reconstruction.html#sec:reco:scintillator_data">9.6. Scintillator data</a></li>
</ul>
</li>
<li><a href="./cast.html#sec:cast">10. Detector installation &amp; data taking at CAST   <span class="tag">  <span class="CAST">CAST</span></span></a>
<ul>
<li>  <a href="./cast.html#sec:cast:timeline">10.1. Timeline</a></li>
<li>  <a href="./cast.html#sec:cast:alignment">10.2. Alignment</a></li>
<li>  <a href="sec:cast:detector_setup">10.3. Detector setup at CAST</a></li>
<li>  <a href="sec:cast:window_accident">10.4. Window accident</a></li>
<li>  <a href="sec:cast:data_taking_woes">10.5. Data taking woes</a></li>
<li>  <a href="sec:cast:data_taking_campaigns">10.6. Summary of CAST data taking</a></li>
</ul>
</li>
<li><a href="./calibration.html#sec:calibration">11. Data calibration   <span class="tag">  <span class="Calibration">Calibration</span></span></a>
<ul>
<li>  <a href="./calibration.html#sec:calibration:energy">11.1. Energy calibration - in principle</a></li>
<li>  <a href="./calibration.html#sec:calib:detector_behavior_over_time">11.2. Detector behavior over time</a></li>
<li>  <a href="./calibration.html#sec:calib:final_energy_calibration">11.3. Energy calibration dependence on the gas gain</a></li>
<li>  <a href="./calibration.html#sec:calib:fadc">11.4. FADC</a></li>
</ul>
</li>
<li><a href="./background.html#sec:background">12. Finding signal and defining background | Background rate computation   <span class="tag">  <span class="Analysis">Analysis</span></span></a>
<ul>
<li>  <a href="./background.html#sec:background:likelihood_method">12.1. Likelihood method</a></li>
<li>  <a href="./background.html#sec:cdl">12.2. CAST Detector Lab</a></li>
<li>  <a href="./background.html#sec:background:likelihood_cut">12.3. Application of likelihood cut for background rate</a></li>
<li>  <a href="./background.html#sec:background:mlp">12.4. Artificial neural networks as cluster classifiers</a></li>
<li>  <a href="./background.html#sec:background:additional_vetoes">12.5. Additional detector features as vetoes</a></li>
<li>  <a href="./background.html#sec:background:all_vetoes_combined">12.6. Background rates of combined vetoes and efficiencies</a></li>
</ul>
</li>
<li><a href="./limit.html#sec:limit">13. Limit calculation   <span class="tag">  <span class="Limit">Limit</span></span></a>
<ul>
<li>  <a href="./limit.html#sec:limit:method_introduction">13.1. Limit method - introduction</a></li>
<li>  <a href="./limit.html#sec:limit:method_likelihood">13.2. Limit method - likelihood function \(\mathcal{L}\)</a></li>
<li>  <a href="./limit.html#sec:limit:method_computing_L">13.3. Limit method - computing \(\mathcal{L}\)</a></li>
<li>  <a href="./limit.html#sec:limit:method_computing_a_limit">13.4. Limit method - computing a limit</a></li>
<li>  <a href="./limit.html#sec:limit:method_expected_limit">13.5. Limit method - toy candidate sets and expected limits</a></li>
<li>  <a href="./limit.html#sec:limit:method_systematics">13.6. Limit method - extending \(\mathcal{L}\) for systematics</a></li>
<li>  <a href="./limit.html#sec:limit:method_mcmc">13.7. Limit method - evaluating \(\mathcal{L}\) with nuisance parameters</a></li>
<li>  <a href="./limit.html#orge02bf4f">13.8. Note about likelihood integral   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./limit.html#org163b03f">13.9. Derivation of short form of \(\mathcal{L}\) <code>[/]</code>   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./limit.html#sec:limit:ingredients">13.10. Likelihood ingredients in detail</a></li>
<li>  <a href="./limit.html#sec:limit:systematics">13.11. Systematics</a></li>
<li>  <a href="./limit.html#sec:limit:mcmc_calc_limit">13.12. MCMC to sample the distribution and compute a limit</a></li>
<li>  <a href="./limit.html#sec:limit:expected_limits">13.13. Expected limits of different setups</a></li>
<li>  <a href="./limit.html#sec:limit:candidates">13.14. Solar tracking candidates</a></li>
<li>  <a href="./limit.html#sec:limit:observed_limit">13.15. Observed limit - \(g_{ae}\)</a></li>
<li>  <a href="./limit.html#sec:limit:other_couplings">13.16. Other coupling constants</a></li>
<li>  <a href="./limit.html#org30511b7">13.17. Comparison to 2013 limit (using their method)   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./limit.html#org840cf92">13.18. Observed limit for different axion masses   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li>  <a href="./outlook.html#sec:outlook">14. Outlook</a></li>
<li>  <a href="./summary.html#sec:summary">15. Summary &amp; conclusion</a></li>
<li>  <a href="./bibliography.html#sec:bibliography">16. Bibliography   <span class="tag">    <span class="html">html</span>  </span></a></li>
<li><a href="./daq.html#sec:daq">17. Data acquisition and detector monitoring   <span class="tag"><span class="Appendix">Appendix</span> <span class="Detector">Detector</span></span></a>
<ul>
<li>  <a href="./daq.html#sec:daq:tof">17.1. Timepix Operating Firmware - TOF</a></li>
<li>  <a href="./daq.html#sec:daq:tos">17.2. Timepix Operating Software - TOS</a></li>
<li>  <a href="./daq.html#sec:daq:septemboard_event_display">17.3. Septemboard event display</a></li>
</ul>
</li>
<li><a href="./configuration.html#sec:appendix:configuration">18. Configuration and TOS / TOF versions   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./configuration.html#sec:appendix:configuration:tos_config">18.1. TOS configuration file</a></li>
<li>  <a href="./configuration.html#sec:appendix:configuration:tos_tof_versions">18.2. TOS and TOF versions used at CAST</a></li>
</ul>
</li>
<li><a href="./calibration.html#sec:appendix:calibration">19. Calibrations   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./calibration.html#sec:appendix:calibration:timepix">19.1. Timepix calibrations</a></li>
<li>  <a href="./calibration.html#sec:appendix:septemboard_calibrations">19.2. Septemboard calibration</a></li>
<li>  <a href="./calibration.html#sec:appendix:scintillator_calibration_notes">19.3. Calibration measurements of the veto scintillator paddle   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./cast_operations.html#sec:appendix:cast_operations">20. CAST operation procedures   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./cast_operations.html#sec:appendix:cast_operations:terminology">20.1. CAST terminology</a></li>
<li>  <a href="./cast_operations.html#sec:cast:high_voltage">20.2. High voltage supply</a></li>
<li>  <a href="./cast_operations.html#sec:cast:vacuum_system">20.3. Vacuum system</a></li>
<li>  <a href="./cast_operations.html#sec:cast:watercooling_gas">20.4. Watercooling system &amp; gas supply</a></li>
<li>  <a href="./cast_operations.html#sec:cast:interlock_systems">20.5. Interlock systems</a></li>
<li>  <a href="./cast_operations.html#sec:appendix:cast_log_files">20.6. CAST log files</a></li>
</ul>
</li>
<li><a href="./cast_run_list.html#sec:appendix:cast_run_list">21. CAST data taking run list   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./cast_run_list.html#orga725a40">21.1. Full version   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./cast_data_taking_notes.html#sec:appendix:cast_data_taking_notes">22. CAST data taking notes <code>[0/1]</code>   <span class="tag"><span class="Appendix">Appendix</span> <span class="extended">extended</span></span></a>
<ul>
<li>  <a href="./cast_data_taking_notes.html#orgce8ce40">22.1. Run table</a></li>
<li>  <a href="./cast_data_taking_notes.html#org2f2342c">22.2. Data runs</a></li>
<li>  <a href="./cast_data_taking_notes.html#orgd44b68f">22.3. Calibration runs</a></li>
<li>  <a href="./cast_data_taking_notes.html#org7db44e8">22.4. Automatically generated run list</a></li>
<li>  <a href="./cast_data_taking_notes.html#orgc6ed0d4">22.5. Automatically calculated total run times</a></li>
<li>  <a href="./cast_data_taking_notes.html#org808b330">22.6. InGrid temperature from shift forms</a></li>
</ul>
</li>
<li><a href="./cabling_and_softwar_setup.html#sec:appendix:cabling_and_softwar_setup">23. Cabling &amp; software setup <code>[/]</code>   <span class="tag"><span class="Appendix">Appendix</span> <span class="extended">extended</span></span></a>
<ul>
<li>  <a href="./cabling_and_softwar_setup.html#orgd292057">23.1. Virtex V6 cabling</a></li>
<li>  <a href="./cabling_and_softwar_setup.html#org4675471">23.2. Detector cabling</a></li>
<li>  <a href="./cabling_and_softwar_setup.html#org3cce3c5">23.3. Vivado / ISE on void linux &amp; flashing Virtex V6</a></li>
<li>  <a href="./cabling_and_softwar_setup.html#org5a96763">23.4. Setting up the chips in TOS</a></li>
</ul>
</li>
<li><a href="./vacuum_contamination.html#sec:appendix:vacuum_contamination">24. Window rupture and vacuum contamination   <span class="tag"><span class="Appendix">Appendix</span> <span class="extended">extended</span></span></a>
<ul>
<li>  <a href="./vacuum_contamination.html#orgf89d314">24.1. Calculation of vacuum volume</a></li>
<li>  <a href="./vacuum_contamination.html#orgd98996c">24.2. Calculation of potential influx of gas</a></li>
<li>  <a href="./vacuum_contamination.html#org1975af5">24.3. Consider pumping of pumps</a></li>
<li>  <a href="./vacuum_contamination.html#org54b8f34">24.4. Calculation of possible contamination</a></li>
</ul>
</li>
<li><a href="./detector_time_behavior.html#sec:appendix:detector_time_behavior">25. Detector behavior over time   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./detector_time_behavior.html#sec:appendix:choice_gas_gain_binning">25.1. Choice of gas gain binning time interval</a></li>
<li>  <a href="./detector_time_behavior.html#sec:appendix:correlation_gas_gain_ambient_temp">25.2. Correlation of gas gain and ambient CAST temperature</a></li>
</ul>
</li>
<li><a href="./cast_detector_lab.html#sec:appendix:cast_detector_lab">26. CAST Detector Lab data   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./cast_detector_lab.html#orgeb1033e">26.1. Generate all spectrum plots split by run   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./cast_detector_lab.html#sec:appendix:cdl_spectra_by_run">26.2. All spectra split by run</a></li>
<li>  <a href="./cast_detector_lab.html#sec:appendix:cdl:all_spectra_fits">26.3. All CDL spectra with line fits   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./cast_detector_lab.html#sec:appendix:cdl:all_spectra_fits_by_run">26.4. All CDL spectra with line fits by run</a></li>
</ul>
</li>
<li><a href="./fit_by_run_justification.html#sec:appendix:fit_by_run_justification">27. CAST Detector Lab variations and fitting by run   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./fit_by_run_justification.html#sec:appendix:fit_by_run:gas_gain_var_cluster_prop">27.1. Influence of gas gain variations on cluster properties</a></li>
<li>  <a href="./fit_by_run_justification.html#orgfa5264f">27.2. Data overview with pixel spectra <code>[/]</code>   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra">28. Morphing of CDL reference spectra   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./morphing_cdl_spectra.html#org8681488">28.1. Generate all morphing / tile related plots   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./morphing_cdl_spectra.html#org3438df6">28.2. Generate plot comparing likelihood behavior   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra:tilemaps">28.3. Tilemap of each likelihood dataset</a></li>
<li>  <a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra:interpolation_raster">28.4. Interpolation of each likelihood dataset</a></li>
<li>  <a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra:binwise_linear">28.5. Binwise linear interpolations for each likelihood dataset</a></li>
<li>  <a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra:notes">28.6. Notes on CDL morphing development   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./occupancy.html#sec:appendix:occupancy">29. Occupancy maps   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./occupancy.html#org07a2a99">29.1. Run-2</a></li>
<li>  <a href="./occupancy.html#org570623a">29.2. Run-3</a></li>
<li>  <a href="./occupancy.html#org3ff625e">29.3. Generate occupancy map plots   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./fadc.html#sec:appendix:fadc">30. FADC   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./fadc.html#sec:appendix:fadc:rise_fall">30.1. FADC rise and fall time</a></li>
<li>  <a href="./fadc.html#sec:appendix:background:fadc">30.2. FADC veto</a></li>
<li>  <a href="./fadc.html#org4890337">30.3. Generate plot of rise time vs skewness   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./fadc.html#sec:appendix:fadc_veto_empirical_cluster_length">30.4. Expected cluster size</a></li>
</ul>
</li>
<li><a href="./background_rates.html#sec:appendix:background_rates">31. Raw data and background rates   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./background_rates.html#sec:appendix:background_rates:full_chip">31.1. Background rates over full chip</a></li>
<li>  <a href="./background_rates.html#org919d6f0">31.2. Generate rate without any vetoes over full chip   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./background_rates.html#org88f3670">31.3. Generate background rates over full chip   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./background_rates.html#orge9a97ef">31.4. Generate table of background rates for all setups   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li>  <a href="./background_interpolation_chip_area.html#sec:appendix:background_interpolation_chip_area">32. Background interpolation chip cutout correction   <span class="tag">    <span class="Appendix">Appendix</span>  </span></a></li>
<li><a href="./limit_additional.html#sec:appendix:limit_additional">33. Additional limit information   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./limit_additional.html#sec:appendix:conversion_probability">33.1. Conversion probability as a function of mass   <span class="tag">    <span class="Appendix">Appendix</span>  </span></a></li>
<li>  <a href="./limit_additional.html#sec:appendix:exp_limit_percentiles">33.2. Expected limit table with percentiles</a></li>
<li>  <a href="./limit_additional.html#sec:appendix:limit_additional:axion_photon">33.3. Observed limit - axion photon \(g_{aγ}\)</a></li>
<li>  <a href="./limit_additional.html#sec:appendix:limit_additional:chameleon">33.4. Observed limit - chameleon \(β_γ\)</a></li>
</ul>
</li>
<li><a href="./software.html#sec:appendix:software">34. Software   <span class="tag"><span class="Software">Software</span> <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./software.html#orgad65478">34.1. Why did I start writing my own analysis framework?   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./software.html#org4b928ea">34.2. Nim   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./software.html#sec:appendix:timepix_analysis">34.3. TimepixAnalysis</a></li>
<li>  <a href="./software.html#org08aac22">34.4. Other libraries relevant for TimepixAnalysis</a></li>
</ul>
</li>
<li><a href="./full_data_reconstruction.html#sec:appendix:full_data_reconstruction">35. Full data reconstruction   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./full_data_reconstruction.html#org28e7632">35.1. Raw data parsing and reconstruction</a></li>
<li>  <a href="./full_data_reconstruction.html#orgd526926">35.2. Parse and reconstruct the CDL data</a></li>
<li>  <a href="./full_data_reconstruction.html#org719c0fb">35.3. Add tracking information to background files</a></li>
<li>  <a href="./full_data_reconstruction.html#org604ee5e">35.4. Using <code>runAnalysisChain</code></a></li>
<li>  <a href="./full_data_reconstruction.html#org0cf4ae0">35.5. Applying a classifier</a></li>
<li>  <a href="./full_data_reconstruction.html#org50f2f77">35.6. Computing limits</a></li>
</ul>
</li>
<li><a href="./average_depth_xrays_argon.html#sec:appendix:average_depth_xrays_argon">36. Average distance X-rays travel in argon at CAST conditions   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./average_depth_xrays_argon.html#org4cae8b7">36.1. Reference to original document   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./average_depth_xrays_argon.html#org454640a">36.2. Calculate conversion point numerically</a></li>
<li>  <a href="./average_depth_xrays_argon.html#org725c5d5">36.3. Compiling and running the code   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./raytracing.html#sec:appendix:raytracing">37. Raytracing   <span class="tag"><span class="Software">Software</span> <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:traxer">37.1. TrAXer - An interactive axion raytracer</a></li>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:llnl_telescope">37.2. A few more details about the LLNL telescope</a></li>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:panter">37.3. Comparison of TrAXer results with PANTER measurements</a></li>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:axion_image">37.4. Computing an axion image with TrAXer</a></li>
<li>  <a href="./raytracing.html#orgeb8bda8">37.5. Reproducing an X-ray finger run with TrAXer   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./raytracing.html#orgbeb36ce">37.6. <span class="done DONE">DONE</span> Can we finish our interactive ray tracer?   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./raytracing.html#org6f14f11">37.7. Rerunning Al Kα after replacing target   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./raytracing.html#org005b7d8">37.8. Figure error development notes   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li>  <a href="./acknowledgments.html#sec:appendix:acknowledgments">38. Acknowledgments   <span class="tag">    <span class="Ack">Ack</span>  </span></a></li>
</ul>
</div>
</nav>
<div id="outline-container-sec:helioscopes" class="outline-2">
<h2 id="sec:helioscopes"><span class="section-number-2">5.</span> Axion helioscopes   <span class="tag">  <span class="Theory">Theory</span></span></h2>
<div id="text-sec:helioscopes" class="outline-text-2">
<p>
As discussed in the previous chapter in section
<a href="./theory.html#sec:theory:solar_axion_flux">4.5</a>, stars are strong axion factories. In 1983
Pierre Sikivie proposed (<a href="./bibliography.html#citeproc_bib_item_216">Sikivie 1983</a>, <a href="./bibliography.html#citeproc_bib_item_217">1985</a>)
multiple methods to potentially detect axions, one of these making use
of this solar axion production. The fundamental realization is that a
transverse magnetic field can act as a means to reconvert axions back
into photons, as discussed in
sec. <a href="./theory.html#sec:theory:axion_interactions">4.4</a>. This allows to design a kind of
telescope consisting of a magnet, which tracks the Sun. One expects a
small fraction of the axions produced in the Sun to reconvert to
photons inside of the magnetic field via the inverse Primakoff
effect. These photons will carry the energy of the original particles
that produced the axions, namely the energy corresponding to the
temperature in the solar core. Some kind of X-ray detector is
installed behind the magnet. Ideally, an X-ray telescope can be added
to focus any potential X-rays from the full magnet volume onto a
smaller area of the detector to massively increase the signal-to-noise
ratio.
</p>

<p>
The first implementation of the helioscope idea was the
Rochester-Brookhaven-Florida experiment
(<a href="./bibliography.html#citeproc_bib_item_44">Van Bibber et al. 1989</a>; <a href="./bibliography.html#citeproc_bib_item_145">Lazarus et al. 1992</a>). It was followed by the SUMICO
experiment in Tokyo (<a href="./bibliography.html#citeproc_bib_item_163">Moriyama et al. 1998</a>; <a href="./bibliography.html#citeproc_bib_item_122">Inoue et al. 2002</a>; <a href="./bibliography.html#citeproc_bib_item_121">Inoue et al. 2008</a>). The
third and latest helioscope is the CERN Axion Solar Telescope (CAST),
which we will present in more detail in section
<a href="./helioscopes.html#sec:helioscopes:cast">5.1</a>. In the final section we will introduce the next
generation of axion helioscopes, the International AXion Observatory
(IAXO), section <a href="./helioscopes.html#sec:helioscopes:iaxo">5.2</a>.
</p>
</div>
<div id="outline-container-sec:helioscopes:cast" class="outline-3">
<h3 id="sec:helioscopes:cast"><span class="section-number-3">5.1.</span> CERN Axion Solar Telescope (CAST)</h3>
<div id="text-sec:helioscopes:cast" class="outline-text-3">
<p>
The CERN Axion Solar Telescope (CAST) was proposed in 1999
(<a href="./bibliography.html#citeproc_bib_item_244">Zioutas et al. 1999</a>) and started data taking in 2003
(<a href="./bibliography.html#citeproc_bib_item_245">Zioutas et al. 2005</a>). Fig. <a href="#fig:helioscopes:cast:cast">1</a> shows a
panorama view of the experiment in its final year of data taking
during some maintenance work.
</p>


<figure id="fig:helioscopes:cast:cast">
<img alt="CAST_panorama_mine.jpg" src="./figs/home/basti/phd/Figs/CAST_panorama_mine.jpg" />

<figcaption>Figure 1: <span class="figure-number">Figure 3: </span>Panorama view of the CAST experiment during some maintenance work.</figcaption>
</figure>

<p>
Using a \(\SI{9.26}{m}\) long Large Hadron Collider (LHC) prototype
dipole magnet that was available from the developments for the LHC,
CAST features an \(\SI{8.8}{T}\) <sup>  <a id="fnr.1" href="#fn.1" class="footref" role="doc-backlink">1</a></sup> strong transverse
magnetic field for axion-photon conversion produced by a current of
\(\SI{13}{kA}\) in the superconducting \(\ce{Nb Ti}\) wires
(<a href="./bibliography.html#citeproc_bib_item_48">Bona et al. 1992</a>) at \(\SI{1.8}{K}\) (<a href="./bibliography.html#citeproc_bib_item_49">Bona et al. 1994</a>). It is
placed on a movable platform that allows for solar tracking both
during sunrise as well as sunset. The vertical range of movement is
about \(\sim\pm\SI{8}{°}\), but practically within
\(\sim\SIrange{-7}{7.7}{°}\) <sup>  <a id="fnr.2" href="#fn.2" class="footref" role="doc-backlink">2</a></sup>. This range of motion
allows for solar tracking of approximately \(\SI{90}{\minute}\) each
during sunrise and sunset per day, the exact duration depending on
time of the year. Due to the incredibly feeble interactions of axions,
solar tracking can already start before sunrise and stop after sunset
as they easily traverse through large distances of Earth&apos;s mantle.
</p>

<p>
An LHC dipole magnet has two bores for the two proton beams running in
reverse order. Being a prototype magnet it is <b>not</b> bent to the
curvature required by the LHC. These two bores have a diameter of
\(\SI{4.3}{cm}\). <sup>  <a id="fnr.3" href="#fn.3" class="footref" role="doc-backlink">3</a></sup> In total then, two bores on each side allow for 4
experiments to be installed at CAST, two for data taking during
sunrise and two during sunset. 
</p>

<p>
The first data taking period (often referred to as &apos;phase I&apos;) took
place in 2003 for 6 months between May and November and was a pure
vacuum run with 3 different detectors. On the side observing during
sunset was a Time Projection Chamber (TPC) that covered both bores. On
the &apos;sunrise&apos; side a Micromegas detector (Micromesh Gaseous Detector)
and a Charged Coupled Device (CCD) detector were installed. The CCD
was further behind a still in place X-ray telescope originally
designed as a spare for the ABRIXAS X-ray space telescope
(<a href="./bibliography.html#citeproc_bib_item_186">Richter et al. 1995</a>; <a href="./bibliography.html#citeproc_bib_item_90">Friedrich 1998</a>). (<a href="./bibliography.html#citeproc_bib_item_245">Zioutas et al. 2005</a>)
</p>

<p>
The full first phase I data taking period comprises of data taken in
2003 and 2004 and achieved a best limit of \(g_{aγ} &lt; \SI{8.8e-11}{\GeV^{-1}}\) (<a href="./bibliography.html#citeproc_bib_item_12">Andriamonje et al. 2007</a>).
</p>

<p>
In what is typically referred to as &apos;phase II&apos; of the CAST data
taking, the magnet was filled with helium as a buffer gas to increase
the sensitivity for higher axion masses by inducing an effective
photon mass (as mentioned in sec. <a href="./theory.html#sec:theory:buffer_gas">4.4.1</a>). First
between late 2005 and early 2007 with \(^4\text{He}\). From March 2008 a
run with \(^3\text{He}\) was started, which ran until 2011
(<a href="./bibliography.html#citeproc_bib_item_22">Arik et al. 2009</a>; <a href="./bibliography.html#citeproc_bib_item_23">Arik et al. 2015</a>). \(\num{160}\) steps of different gas
pressures were used to optimize sensitivity against time per step. In
2012 another \(^4\text{He}\) data run took place
(<a href="./bibliography.html#citeproc_bib_item_23">Arik et al. 2015</a>).
</p>

<p>
From 2013 on the CAST experiment has only run under vacuum
configuration (<a href="./bibliography.html#citeproc_bib_item_68">Collaboration and others 2017</a>). Further, the physics scope has been
extended to include searches for chameleons
(<a href="./bibliography.html#citeproc_bib_item_65">Christoph Krieger 2018</a>; <a href="./bibliography.html#citeproc_bib_item_9">Anastassopoulos et al. 2019</a>, <a href="./bibliography.html#citeproc_bib_item_8">2015</a>; <a href="./bibliography.html#citeproc_bib_item_31">Baier, n.d.</a>; <a href="./bibliography.html#citeproc_bib_item_75">Cuendis et al. 2019</a>)
and axions in the galactic halo via cavity experiments
(<a href="./bibliography.html#citeproc_bib_item_76">Cuendis 2021</a>; <a href="./bibliography.html#citeproc_bib_item_159">Melcón et al. 2021</a>; <a href="./bibliography.html#citeproc_bib_item_157">Maroudas 2022</a>; <a href="./bibliography.html#citeproc_bib_item_2">Adair et al. 2022</a>).
</p>

<p>
A video showing the CAST magnet during a typical solar tracking can be
found under the link in this <sup>  <a id="fnr.4" href="#fn.4" class="footref" role="doc-backlink">4</a></sup> footnote.
</p>
</div>
<div id="outline-container-org9f2e27e" class="outline-4">
<h4 id="org9f2e27e"><span class="section-number-4">5.1.1.</span> Generate a plot of the CAST magnet&apos;s magnetic field   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-5-1-1" class="outline-text-4">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #F92672;">cd</span> ~/CastData/ExternCode/TimepixAnalysis/LogReader/
./cast_log_reader sc -p ../resources/LogFiles/SCLogs/2017_18 -s Version.idx
</pre>
</div>


<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>SAVE A PLOT</b></li>
<li class="off"><code>[ ]</code> GET TABLE FROM JAIME&apos;s THESIS</li>
<li class="off"><code>[ ]</code> FIND REFERENCE OF JAIME&apos;s TABLE</li>
</ul>
</div>
</div>
<div id="outline-container-org90d221b" class="outline-4">
<h4 id="org90d221b"><span class="section-number-4">5.1.2.</span> Calculate the maximum tilting angles of the magnet   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-5-1-2" class="outline-text-4">
<p>
The tilting angles of the CAST magnet are stored (among others, the
tracking files also contain angle data, as well as the &quot;angles&quot; file
{that existed at some point at least?} ) in the slow control log
files.
</p>

<p>
We&apos;ll use our log file parser to parse all the log files between 2016
and
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #F92672;">cd</span> ~/CastData/ExternCode/TimepixAnalysis/LogReader/
./cast_log_reader sc -p ../resources/LogFiles/SCLogs -s Version.idx
</pre>
</div>

<p>
This yields fig. <a href="#fig:cast:vertical_angles_data_taking">2</a> where we can see
that the real angles are between \(\sim\SIrange{-7}{7.7}{°}\).
</p>


<figure id="fig:cast:vertical_angles_data_taking">
<img alt="CAST_magnet_vertical_angle.svg" class="org-svg" src="./figs/home/basti/phd/Figs/CAST_magnet_vertical_angle.svg" />

<figcaption>Figure 2: <span class="figure-number">Figure 4: </span>Vertical angle of the CAST magnet during the data taking discussed in this thesis. The magnet moves in a range of \(\sim\SIrange{-7}{7.7}{°}\) during trackings.</figcaption>
</figure>


<p>
We also have <span class="underline">all</span> of the slow control logs in
<a href="./../CastData/ExternCode/TimepixAnalysis/resources/LogFiles/AllLogs/logfiles/">./../CastData/ExternCode/TimepixAnalysis/resources/LogFiles/AllLogs/logfiles/</a>. Feel
free to run the command on this directory. But don&apos;t expect amazing
performance given the amount of data!
</p>

<p>
A PNG of the full data in fig. <a href="#fig:cast:vertical_angle_all_data">3</a>
showing the same range as the figure only showing the data taking
period discussed in this thesis.
</p>


<figure id="fig:cast:vertical_angle_all_data">
<img alt="cast_magnet_vertical_angles_2005_2021.png" src="./figs/home/basti/org/Figs/statusAndProgress/cast_magnet_vertical_angles_2005_2021.png" />

<figcaption>Figure 3: <span class="figure-number">Figure 5: </span>Vertical angle of the CAST magnet during (almost) the entire data taking period from 2005 to end of 2021. Angles go from roughty \(\SI{-7}{°}\) to about \(\SI{7.7}{°}\).</figcaption>
</figure>
</div>
</div>
<div id="outline-container-sec:helioscopes:cast:xray_optics" class="outline-4">
<h4 id="sec:helioscopes:cast:xray_optics"><span class="section-number-4">5.1.3.</span> CAST X-ray optics</h4>
<div id="text-sec:helioscopes:cast:xray_optics" class="outline-text-4">
<p>
The first X-ray telescope used at CAST as a focusing optics for the
expected axion induced X-ray flux was a Wolter I type X-ray telescope
(<a href="./bibliography.html#citeproc_bib_item_239">Wolter 1952</a>) originally built for a proposed German space
based X-ray telescope mission, ABRIXAS (<a href="./bibliography.html#citeproc_bib_item_186">Richter et al. 1995</a>; <a href="./bibliography.html#citeproc_bib_item_90">Friedrich 1998</a>). The telescope
consists of 27 gold coated parabolic and hyperbolic shells and has a
focal length of \(\SI{1.6}{m}\). Due to the small size of the dipole
magnet&apos;s bores of only \(\SI{43}{mm}\) only a single section of the
telescope can be exposed. The telescope is thus placed off-axis from
the magnet bore to expose a single mirror section. An image of the
mirror system with a rough indication of the exposed section is shown
in fig. <a href="#fig:cast:abrixas_mirrors">4(b)</a>.
</p>

<p>
The telescope is owned by the &apos;Max Planck Institut für
extraterrestrische Physik&apos; in Garching. For that reason it will often
be referred to as the &apos;MPE telescope&apos; in the context of CAST.
</p>

<p>
The efficiency of the telescope reaches about \(\SI{48}{\%}\) as the peak
at around \(\SI{1.5}{keV}\), drops sharply at around \(\SI{2.3}{keV}\) to only
about \(\SI{30}{\%}\) up to about \(\SI{7}{keV}\). From there it continues to
drop until about \(\SI{5}{\%}\) efficiency at \(\SI{10}{keV}\). The efficiency
is shown in a comparison with another telescope in the next section
<a href="./helioscopes.html#sec:helioscopes:llnl_telescope">5.1.4</a> in
fig. <a href="#fig:cast:telescope_efficiency_comparison_mpe_llnl">7</a>.
</p>

<p>
A picture of the telescope installed at CAST behind the magnet on the
&apos;sunrise&apos; side of the magnet is shown in
fig. <a href="#fig:cast:abrixas_installed">4(a)</a>. <sup>  <a id="fnr.5" href="#fn.5" class="footref" role="doc-backlink">5</a></sup> This telescope
was used for the data taking campaign in 2014 and 2015 using a GridPix
based detector discussed in (<a href="./bibliography.html#citeproc_bib_item_65">Christoph Krieger 2018</a>) and serves as a
comparison for certain aspects in this thesis.
</p>


<figure id="fig:cast:abrixas" class="figure-wrapper">
<figure id="fig:cast:abrixas_installed" class="subfigure" data-width="55%">  <img src="./figs/home/basti/org/Figs/thesis/CAST/cast_abrixas_telescope_image_clear.png" data-width="94%" />  <figcaption>Figure 4(a): Side view</figcaption></figure> <figure id="fig:cast:abrixas_mirrors" class="subfigure" data-width="43%">  <img src="./figs/home/basti/org/Figs/thesis/CAST/abrixas_cast_telescope_system.png" data-width="94%" />  <figcaption>Figure 4(b): Mirrors</figcaption></figure>
<figcaption>Figure 4: <a href="#fig:cast:abrixas_installed">4(a)</a>: Image of the ABRIXAS telescope installed at CAST on the &apos;sunrise&apos; side.
           The image is taken from (<a href="./bibliography.html#citeproc_bib_item_142">Kuster et al. 2007</a>) as it provides a 
           relatively clear image of the telescope, which is hard to take nowadays.<a href="#fig:cast:abrixas_mirrors">4(b)</a>: Image of the ABRIXAS telescope mirror system. The different shells of the 
           Wolter I type telescope system are visible. One section is exposed to the 
           magnet bore, the white line indicating roughly the extent of the bore. The 
           sproke like structure is the support for the mirror shells.
           Image taken from (NO_ITEM_DATA:CAST_telescope_ccd.)
</figcaption>
<h4 id="sec:helioscopes:llnl_telescope"><span class="section-number-4">5.1.4.</span> Lawrence Livermore National Laboratory (LLNL) telescope</h4>
<div id="text-sec:helioscopes:llnl_telescope" class="outline-text-4">
<p>
Up to 2014 there was only a single X-ray telescope in use at CAST. In
August 2014 a second X-ray optic was installed on the second bore next
to the ABRIXAS telescope. This telescope, using technologies
originally developed for the space based NuSTAR telescope by NASA
(<a href="./bibliography.html#citeproc_bib_item_106">Harrison et al. 2013</a>, <a href="./bibliography.html#citeproc_bib_item_105">2006</a>; <a href="./bibliography.html#citeproc_bib_item_137">Koglin et al. 2009</a>; <a href="./bibliography.html#citeproc_bib_item_71">Craig et al. 2011</a>; <a href="./bibliography.html#citeproc_bib_item_103">Hailey et al. 2010</a>),
was purpose built for axion searches and in particular the CAST
experiment. Contrary to the ABRIXAS telescope only a single telescope
section of \(\SI{30}{°}\) wide mirrors of the telescope was built as the
small bore cannot expose more area anyway. It uses a cone
approximation to a Wolter I optic, meaning the hyperbolic and
parabolic mirrors are replaced by cone sections (<a href="./bibliography.html#citeproc_bib_item_176">Petre and Serlemitsos 1985</a>). A side
view and rear view of the open telescope after decommissioning at CAST
are seen in fig. <a href="#fig:cast:llnl">5</a>. It consists of 13 platinum /
carbon coated glass shells in each telescope section, for a total of
26 mirrors. Each mirror uses one of four different depth graded
multilayer (see sec. <a href="./theory_detector.html#sec:theory:xray_reflectivity">6.1.2</a>) coating recipes to
improve reflectivity over a larger energy and angle range. Further,
the focal length was shortened to \(\SI{1.5}{m}\). The telescope section
is rotated such that the focal point is pointing away from the other
magnet bore to make more space for two detectors side by
side. <sup>  <a id="fnr.6" href="#fn.6" class="footref" role="doc-backlink">6</a></sup> This can be seen in the render of the
2017/18 detector setup in fig. <a href="llnl_telescope_setup_2017_render">6</a>, seen
from the top. The development process of the telescope is documented
in the PhD thesis by A. Jakobsen
(<a href="./bibliography.html#citeproc_bib_item_125">Jakobsen 2015</a>). (<a href="./bibliography.html#citeproc_bib_item_28">Aznar et al. 2015</a>) gives an
overview and shows preliminary results from CAST. The telescope was
characterized and calibrated at the PANTER X-ray test facility in
Munich.
</p>


<figure id="fig:cast:llnl" class="figure-wrapper">
<figure id="fig:cast:llnl_side_view" class="subfigure" data-width="74%">  <img src="./figs/home/basti/phd/Figs/LLNL/llnl_side_view_cropped.jpg" data-width="94%" />  <figcaption>Figure 5(a): Side view</figcaption></figure> <figure id="fig:cast:llnl_back_view" class="subfigure" data-width="24%">  <img src="./figs/home/basti/phd/Figs/LLNL/llnl_open_back_rotated.jpg" data-width="94%" />  <figcaption>Figure 5(b): Rear view</figcaption></figure>
<figcaption>Figure 5: <a href="#fig:cast:llnl_side_view">5(a)</a>: Image of the LLNL telescope outside its housing after decommissioning at CAST.
           Entrance side towards the magnet on the right with the largest shell radii.
           Both sets of mirror shells are clearly seperated in the middle.<a href="#fig:cast:llnl_back_view">5(b)</a>: View of the telescope shells as seen from the detector side. Installed at CAST
          the telescope was rotated by about $\SI{76}{°}$ counter clockwise from
          this view.
          Both images courtesy of Cristina Margalejo Blasco.</figcaption>
</figure>



<figure id="llnl_telescope_setup_2017_render">
<img alt="llnl_cast_gridpix_render_small_annotated.png" src="./figs/home/basti/phd/Figs/llnl_cast_gridpix_render_small_annotated.png" />

<figcaption>Figure 6: <span class="figure-number">Figure 6: </span>Render of the setup of the GridPix septemboard detector in 2017/18 showing the LLNL telescope on the left side. The diversion away from the extension of the bore is visible, to have more space for detector installation. The lead shielding and veto scintillator are not shown in the render. Render created by Tobias Schiffer.</figcaption>
</figure>

<p>
This telescope achieves a significantly higher effective area than the
ABRIXAS telescope in the energy range between \(\SIrange{2}{3}{keV}\)
fig. <a href="#fig:cast:telescope_efficiency_comparison_mpe_llnl">7</a> (relevant for
axion searches, compare with
fig. <a href="#fig:theory:solar_axion_flux:differential_flux">#fig:theory:solar_axion_flux:differential_flux</a>). But outside
this range the efficiency is comparable or lower.
</p>

<p>
The precise understanding of the position, size and shape of the focal
point as well as the effective area is essential for the limit
calculation later in the thesis. In appendix <a href="./raytracing.html#sec:appendix:raytracing">37</a>
we discuss a raytracing simulation of this telescope. The aim is to
simulate the expected distribution of axions from the Sun.
</p>


<figure id="fig:cast:telescope_efficiency_comparison_mpe_llnl">
<img alt="effective_area_mpe_llnl.svg" class="org-svg" src="./figs/home/basti/phd/Figs/telescopes/effective_area_mpe_llnl.svg" />

<figcaption>Figure 7: <span class="figure-number">Figure 7: </span>Comparison of the efficiency between the two telescopes, the MPE (ABRIXAS) as the original CAST telescope and the LLNL telescope purpose built for axion searches. The LLNL telescope has superior efficiency in the energy range where the axion flux is assumed to dominate, but falls off sharper at high energies. The data for the LLNL telescope is extracted from fig. 3 in <a href="cite:llnl_telescope_first_cast_results">cite:llnl_telescope_first_cast_results</a>, whereas for the ABRIXAS telescope it is extracted from the red line in fig. 4 of <a href="cite:CAST_telescope_ccd">cite:CAST_telescope_ccd</a>.</figcaption>
</figure>
</div>
<div id="outline-container-orgc42fc78" class="outline-5">
<h5 id="orgc42fc78"><span class="section-number-5">5.1.4.1.</span> Generate effective area plot for LLNL and MPE telescopes <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-5-1-4-1" class="outline-text-5">
<p>
We&apos;ll now create the comparison plot of the effective areas for the
two X-ray telescopes used at CAST.
</p>

<p>
For the MPE telescope: As mentioned in the caption of the figure
above, the data for the MPE telescope is extracted from fig. 4 of
(<a href="./bibliography.html#citeproc_bib_item_142">Kuster et al. 2007</a>), also found here
<img alt="mpe_xray_telescope_cast_effective_area.svg" class="org-svg" src="./figs/home/basti/phd/resources/MPE/mpe_xray_telescope_cast_effective_area.svg" />. This
is done using <a href="./code/other/extractDataFromPlot.nim">./code/other/extractDataFromPlot.nim</a> using a
simplified version of fig. 4 as an input (i.e. crop the plot to
exactly the area of the actual plot and remove any lines that are not
the data to be extracted. This plot looks like
<img alt="mpe_xray_telescope_cast_effective_area_cropped_no_axes.png" src="file:///home/basti/phd/resources/MPE/mpe_xray_telescope_cast_effective_area_cropped_no_axes.png" />.
</p>

<p>
Then run
</p>
<div class="org-src-container">
<pre class="src src-sh">./extractDataFromPlot <span style="color: #E6DB74; font-weight: bold;">\</span>
    -f ~/phd/resources/MPE/mpe_xray_telescope_cast_effective_area_cropped_no_axes.png <span style="color: #E6DB74; font-weight: bold;">\</span>
    --xLow 0.305 --xHigh 10.0 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --yLow 0.0 --yHigh 8.0
</pre>
</div>
<p>
which produces a plot from the extracted data and writes a CSV file,
which 
</p>

<ul class="org-ul">
<li class="on"><code>[X]</code> Make sure to add the effective area files to a <code>resources</code>
directory of the thesis repo!</li>

<li class="off"><code>[ ]</code> Ask Jaime if this really looks sensible, because to me it does
not! That&apos;s barely better than the MPE telescope…</li>
</ul>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> ggplotnim, ggplotnim/ggplot_sdl2
<span style="color: #F92672;">import</span> unchained
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">mpe </span>= <span style="color: #E6DB74;">&quot;~/phd/resources/MPE/mpe_xray_telescope_cast_effective_area.csv&quot;</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">llnl </span>= <span style="color: #E6DB74;">&quot;~/phd/resources/LLNL/EffectiveArea.txt&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfMpe </span>= readCsv<span style="color: #AE81FF;">(</span>mpe<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfLLNL </span>= readCsv<span style="color: #AE81FF;">(</span>llnl, sep = <span style="color: #E6DB74;">&apos; &apos;</span><span style="color: #AE81FF;">)</span>
  .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Energy[keV]&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;E(keV)&quot;</span><span style="color: #66D9EF;">}</span>,
          f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;EffectiveArea[cm²]&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;Area(cm^2)&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= bind_rows<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span><span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;MPE&quot;</span>, dfMpe<span style="color: #A6E22E;">)</span>, <span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;LLNL&quot;</span>, dfLLNL<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;Telescope&quot;</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">areaBore </span>= <span style="color: #AE81FF;">(</span><span style="font-style: italic;">4</span>.<span style="font-style: italic;">3</span>.cm / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>^<span style="font-style: italic;">2</span> * π <span style="color: #E6DB74;">## Area of the CAST bore in cm²</span>
ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Energy[keV]&quot;</span>, <span style="color: #E6DB74;">&quot;EffectiveArea[cm²]&quot;</span>, color = <span style="color: #E6DB74;">&quot;Telescope&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Energy [\si{keV}]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;EffectiveArea [\si{cm^2}]&quot;</span><span style="color: #AE81FF;">)</span> +
  scale_y_continuous<span style="color: #AE81FF;">(</span>secAxis = secAxis<span style="color: #66D9EF;">(</span>f<span style="color: #A6E22E;">{</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / areaBore.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">}</span>, name = r<span style="color: #E6DB74;">&quot;Transmission [\si{\%}]&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">83</span>, -<span style="font-style: italic;">0</span>.<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">600</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> + 
  ggshow<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;~/phd/Figs/telescopes/effective_area_mpe_llnl.pdf&quot;</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
</div>
</div>
</figure>
<h4 id="org74b20a6"><span class="section-number-4">5.1.5.</span> Best limits set by CAST</h4>
<div id="text-5-1-5" class="outline-text-4">
<p>
In the many years of data taking and countless detectors taking data
at the CAST experiment, it has put the most stringent limits on
different coupling constants over the years.
</p>

<p>
Specifically, CAST sets the current best helioscope limits on the:
</p>
<ul class="org-ul">
<li>Axion-photon coupling \(g_{aγ}\)</li>
<li>Axion-electron coupling \(g_{ae}\)</li>
<li>Chameleon-photon coupling \(β_γ\)</li>
</ul>

<p>
For the axion-photon coupling the best limit is from (<a href="./bibliography.html#citeproc_bib_item_68">Collaboration and others 2017</a>)
in 2017 based on the full Micromegas dataset including the data behind
the LLNL telescope and constricts the coupling to
\(g_{aγ} &lt; \SI{6.6e-11}{\GeV^{-1}}\).
</p>

<p>
For the axion-electron coupling the best limit is still from 2013 in
(<a href="./bibliography.html#citeproc_bib_item_38">Barth et al. 2013</a>) using the theoretical calculations for an expected
solar axion flux done by J. Redondo in (<a href="./bibliography.html#citeproc_bib_item_185">Redondo 2013</a>) for a limit
on the product of the axion-electron and axion-photon coupling of
\(g_{ae} · g_{aγ} &lt; \SI{8.1e-23}{\GeV^{-1}}\). The limit calculation was
based on data taken in CAST phase I in 2003 - 2005 with a pn-CCD
detector behind the MPE telescope.
</p>

<p>
CAST was also used to set a limit on the hypothetical chameleon
particle. The best current limit on the chameleon-photon coupling
\(β_γ\) is based on a single GridPix based detector with data taken in
2014 and 2015 by C. Krieger in (<a href="./bibliography.html#citeproc_bib_item_65">Christoph Krieger 2018</a>; <a href="./bibliography.html#citeproc_bib_item_9">Anastassopoulos et al. 2019</a>), limiting the
coupling to \(β_γ &lt; \num{5.74e10}\), which is the first limit below the
solar luminosity bound.
</p>
</div>
</div>
</div>
<div id="outline-container-sec:helioscopes:iaxo" class="outline-3">
<h3 id="sec:helioscopes:iaxo"><span class="section-number-3">5.2.</span> International AXion Observatory (IAXO)</h3>
<div id="text-sec:helioscopes:iaxo" class="outline-text-3">
<p>
Barring a revolution in detector development or a lucky find of a non
QCD axion, the CAST experiment was unlikely to detect any signals. A
fourth generation axion helioscope to possibly reach towards the QCD
band in the mass-coupling constant phase space is a natural idea.
</p>

<p>
The first proposal for a next generation axion helioscope was
published in 2011 (<a href="./bibliography.html#citeproc_bib_item_123">Irastorza et al. 2011</a>), with the name International AXion
Observatory (IAXO) first appearing in 2013 (<a href="./bibliography.html#citeproc_bib_item_227">Vogel et al. 2013</a>). A
conceptual design report (CDR) was further published in 2014
(<a href="./bibliography.html#citeproc_bib_item_24">Armengaud et al. 2014</a>). 
</p>

<p>
The proposed experiment is supposed to have a total magnet length of \(\SI{25}{m}\)
length with eight  \(\SI{60}{cm}\) bores with an average transverse
magnetic field of \(\SI{2.5}{T}\) <sup>  <a id="fnr.7" href="#fn.7" class="footref" role="doc-backlink">7</a></sup>. With a cryostat and magnet design
specifically built for the experiment, much larger tilting angles of
the magnet of about \(\pm\SI{25}{°}\) are proposed to allow for solar
tracking for \(\SI{12}{\hour}\) per day for a 1:1 data split between
tracking and background data. (<a href="./bibliography.html#citeproc_bib_item_24">Armengaud et al. 2014</a>)
</p>

<p>
In (<a href="./bibliography.html#citeproc_bib_item_123">Irastorza et al. 2011</a>) a &apos;figure of merit&apos; (FOM) is introduced
to quantify the improvements possible by IAXO over CAST, defined by
</p>

<p>
\[
f = f_M f_{\text{DO}} f_T = (B² L² A)_M \left(\frac{ε_d ε_o}{\sqrt{b a}}\right)_{\text{DO}} (\sqrt{ε_t t})_T
\]
</p>

<p>
which is split into individual FOMs for the magnet \(f_M\), the detector
and optics \(f_{\text{DO}}\) and the total tracking time \(f_T\) (\(B\):
magnetic field, \(L\): magnet length, \(A\): total bore area of all bores,
\(ε_d\): detector efficiency, \(ε_o\): X-ray optic efficiency, \(b\):
background in counts per area and time, \(a\): area of the X-ray optic
focal spot, \(ε_t\): data taking efficiency, \(t\): total solar tracking
time). The biggest improvements would come from the magnet FOM (MFOM),
due to the much larger magnet volume. Compared to the CAST MFOM
\(f_{M,\text{CAST}} = \SI{19.3}{T^2.m^4}\) IAXO would achieve a relative
improvement of \(f_{M,\text{CAST}} / f_{M,\text{IAXO}} \approx 300\)
with its \(f_{M,\text{IAXO}} = \SI{5654.9}{T^2.m^4}\). As the number of
expected counts in a helioscope scales with
\(g^4\) <sup>  <a id="fnr.8" href="#fn.8" class="footref" role="doc-backlink">8</a></sup>, the figure of merit directly relates
possible limits of a helioscope in case of a non-detection. The
aspirational target for IAXO would be a full \(f_{\text{CAST}} /
f_{\text{IAXO}} &gt; \num{10000}\)  for a possible improvement on \(g\)
bounds by an order of magnitude.
</p>

<p>
A schematic of the proposed design can be seen in
fig. <a href="#fig:helioscopes:iaxo">8(a)</a>. Given the comparatively large budget
requirements for such an experiment, a compromise was envisioned to
prove the required technologies, in particular the magnet design. This
intermediate experiment called BabyIAXO will be discussed in the next
section, <a href="./helioscopes.html#sec:helioscopes:baby_iaxo">5.2.2</a>.
</p>


<figure id="fig:helioscopes:iaxo_babyiaxo_schematics" class="figure-wrapper">
<figure id="fig:helioscopes:iaxo" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/IAXO/iaxo_annotated_schematic.png" data-width="94%" />  <figcaption>Figure 8(a): IAXO</figcaption></figure> <figure id="fig:helioscopes:baby_iaxo" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/IAXO/babyIAXO_schematic_annotated_ringwald23.png" data-width="94%" />  <figcaption>Figure 8(b): BabyIAXO</figcaption></figure>
<figcaption>Figure 8: <a href="#fig:helioscopes:iaxo">8(a)</a>An annotated schematic of a potential IAXO design with 8 magnet bores. Taken from the IAXO CDR (<a href="./bibliography.html#citeproc_bib_item_24">Armengaud et al. 2014</a>). <a href="#fig:helioscopes:baby_iaxo">8(b)</a>An annotated schematic of the current BabyIAXO design, showing the two bores. One bore intended
          for an XMM-Newton optic of \SI{7.5}{m} focal length, and a shorter \SI{5}{m} focal
          length custom optic behind the other bore. Taken from (NO_ITEM_DATA:ringwald23_axions_hamburg.)
</figcaption>
<h4 id="orgc15bde6"><span class="section-number-4">5.2.1.</span> Calculate magnet figure of merit   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-5-2-1" class="outline-text-4">
<p>
For more details on the figure of merit calculation, see sec. 3.1 in
(<a href="./bibliography.html#citeproc_bib_item_123">Irastorza et al. 2011</a>).
</p>

<p>
For completeness, the figure of merit is:
</p>

<p>
\[
f = f_M f_{\text{DO}} f_T = (B² L² A)_M (\frac{ε_d ε_o}{\sqrt{b a}})_{\text{DO}} (\sqrt{ε_t t})_T
\]
</p>

<p>
The full relationship with the axion-photon coupling is:
</p>

\begin{align*}
  N_γ ∝ N_a · g⁴ &amp;= f · g⁴ \\
  N_b &amp;= b a ε_t t
\end{align*}

<p>
So 10,000 more &quot;produced&quot; (i.e. not produced) photons due to f&apos;/f =
10,000 for IAXO over CAST would imply the bounds on \(g\) could be
improved by a factor of 10, one order of magnitude.
</p>

<p>
Let&apos;s calculate the figure of merit for the CAST magnet as well as the
IAXO / BabyIAXO magnets:
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained

defUnit<span style="color: #AE81FF;">(</span>T²•m⁴<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">fMagnet</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">B</span>: <span style="color: #66D9EF;">Tesla</span>, <span style="color: #66D9EF;">L</span>: <span style="color: #66D9EF;">Meter</span>, d: <span style="color: #66D9EF;">CentiMeter</span><span style="color: #AE81FF;">)</span>: T²•m⁴ = <span style="color: #66D9EF;">B</span>^<span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">L</span>^<span style="font-style: italic;">2</span> * <span style="color: #AE81FF;">(</span>d / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>^<span style="font-style: italic;">2</span> * π
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">fCAST </span>= fMagnet<span style="color: #AE81FF;">(</span><span style="font-style: italic;">8</span>.<span style="font-style: italic;">8</span>.<span style="color: #66D9EF;">T</span>, <span style="font-style: italic;">9</span>.<span style="font-style: italic;">26</span>.m, <span style="font-style: italic;">4</span>.<span style="font-style: italic;">3</span>.cm<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;CAST magnet, single bore f_M = &quot;</span>, fCAST, <span style="color: #E6DB74;">&quot; at 8.8 T&quot;</span>
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;CAST, both bores f_M = &quot;</span>, fCAST * <span style="font-style: italic;">2</span>

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">fIAXO </span>= fMagnet<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>.<span style="font-style: italic;">5</span>.<span style="color: #66D9EF;">T</span>, <span style="font-style: italic;">20</span>.m, <span style="font-style: italic;">60</span>.cm<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;IAXO magnet, single bore f_M = &quot;</span>, fIAXO, <span style="color: #E6DB74;">&quot; at 2.5 T *average* field, 20 m length.&quot;</span>
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;IAXO, all bores f_M = &quot;</span>, fIAXO * <span style="font-style: italic;">8</span>

<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;IAXO FOM over CAST: &quot;</span>, fIAXO * <span style="font-style: italic;">8</span> / <span style="color: #AE81FF;">(</span>fCAST * <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>
</pre>
</div>


<p>
Time scaling:
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained, math
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">g </span>= 8e-<span style="font-style: italic;">11</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">g4 </span>= g^<span style="font-style: italic;">4</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">t </span>= <span style="font-style: italic;">1</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">g⁴ = √t</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">g⁴ / √t = g&apos;⁴ / √t&apos;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">tp </span>= <span style="font-style: italic;">2</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">g4p </span>= g4 * sqrt<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;New g for twice the time: &quot;</span>, pow<span style="color: #AE81FF;">(</span>g4p, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">25</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained, math
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">g </span>= 8e-<span style="font-style: italic;">11</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">g4 </span>= g^<span style="font-style: italic;">4</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">t </span>= <span style="font-style: italic;">1</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">g⁴ · √t = N # &lt;- some number of photons: we observe 0</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">g⁴&apos; · √t&apos; = N&apos; # &lt;- new number of photons: we still observe 0</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">So</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">g⁴ · √t = g⁴&apos; · √t&apos;</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">should hold, meaning</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">g⁴ · √1 = g⁴&apos; · √2</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">g⁴&apos; = g⁴ / √2</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">g4p </span>= g4 / sqrt<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;New g for twice the time: &quot;</span>, pow<span style="color: #AE81FF;">(</span>g4p, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">25</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
</div>
</figure>
<h4 id="sec:helioscopes:baby_iaxo"><span class="section-number-4">5.2.2.</span> BabyIAXO</h4>
<div id="text-sec:helioscopes:baby_iaxo" class="outline-text-4">
<p>
The major difference between full grown IAXO and BabyIAXO is
restricting the setup to 2 bores instead of 8 with a magnet length of
only \(\SI{10}{m}\) to prove the magnet design works, before building a
larger version of said design. Since the first conceptual design of
IAXO (<a href="./bibliography.html#citeproc_bib_item_24">Armengaud et al. 2014</a>) the bore diameter for the two bores of
BabyIAXO has increased from \(\SI{60}{cm}\) to
\(\SI{70}{cm}\). (<a href="./bibliography.html#citeproc_bib_item_69">Collaboration et al. 2021</a>)
</p>

<p>
The BabyIAXO design was approved by the &apos;Deutsches
Elektronen-Synchrotron&apos; (DESY) for construction onsite. The project has
suffered multiple delays most notably due to the magnet
construction. First COVID19 due to its severe effects on supply chains
and in 2022 the horrific Russian invasion of Ukraine have caused multi
year delays. The latter in particular was problematic as the only two
companies being able to supply the type of superconducting cable
needed for the magnet are from Russia. The magnet situation is still
in flow as of writing this thesis.
</p>

<p>
For the two bores two different X-ray telescopes are planned to be
operated. One bore will be used with a flight spare of the XMM-Newton
X-ray satellite mission with a focal length of \(\SI{7.5}{m}\). The
second bore would receive a custom built X-ray optic based on a hybrid
design of a NuSTAR-like optic for the inner part – similar to the LLNL
telescope introduced in sec. <a href="./helioscopes.html#sec:helioscopes:llnl_telescope">5.1.4</a> (just as
a full telescope) – and a cold slumped glass design following
(<a href="./bibliography.html#citeproc_bib_item_66">Civitani et al. 2016</a>) for the outer part. This
optic would have a focal length of only \(\SI{5}{m}\).
</p>

<p>
An annotaded schematic of the BabyIAXO design can be seen in
fig. <a href="#fig:helioscopes:baby_iaxo">8(b)</a>. The magnet figure of merit for
BabyIAXO is aimed at being at least a factor 10 higher than for CAST,
with (<a href="./bibliography.html#citeproc_bib_item_69">Collaboration et al. 2021</a>) listing values between
\(\SIrange{232}{326}{T^2.m^4}\) depending on how it is calculated.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:theory_detector" class="outline-2">
<h2 id="sec:theory_detector"><span class="section-number-2">6.</span> X-rays, cosmic muons and gaseous detectors   <span class="tag">  <span class="Theory">Theory</span></span></h2>
<div id="text-sec:theory_detector" class="outline-text-2">
<p>
As we have seen in the previous two chapters, solar axions should
produce photons in the soft X-ray energy range. In experiments like CAST,
gaseous detectors – like the one used in this thesis – are therefore
a common and suitable choice for the detection of the X-rays focused
by the X-ray optics. In order to give a guiding reference for the
relevant physics associated with the detection of particles at CAST,
we will now cover each aspect that we make use of in explanations or
calculations. The focus will be on aspects either not commonly
discussed (for example depth graded multilayers for X-ray telescopes)
or essential for explanation (gas diffusion).
</p>

<p>
We start with a section on particle interactions with matter,
sec. <a href="./theory_detector.html#sec:theory:particle_int">6.1</a>, where we discuss X-ray interactions as
well as charged particles in gases. Next in
sec. <a href="./theory_detector.html#sec:theory:cosmic_radiation">6.2</a> follows a short section about cosmic
radiation, in particular the expected muon flux as it serves as a
dominant source of background in experiments like CAST. Finally, in
sec. <a href="./theory_detector.html#sec:theory:gas_fundamentals">6.3</a> we cover concepts of gaseous
detector physics that we depend on.
</p>
</div>
<div id="outline-container-sec:theory:particle_int" class="outline-3">
<h3 id="sec:theory:particle_int"><span class="section-number-3">6.1.</span> Particle interactions with matter</h3>
<div id="text-sec:theory:particle_int" class="outline-text-3">
<p>
On the one hand we will discuss how X-rays interact with matter. Both
in terms of solids as well as gases, focused on their attenuation,
because this is required to describe signal attenuation due to – for
example – a detector window of a gaseous detector or the absorption
of X-rays in the detector gas. In addition, X-ray reflectivity will be
discussed as it is of interest for the behavior of X-ray
telescopes. On the other hand the interaction of highly energetic
charged particles with matter will be discussed and its relation to
cosmic radiation as a source of background. Finally, X-ray
fluorescence will be covered as well. As a source of background in an
axion helioscope experiment it is indistinguishable <sup>  <a id="fnr.9" href="#fn.9" class="footref" role="doc-backlink">9</a></sup> from
axion-induced X-rays.
</p>

<p>
For a detailed overview of the interaction of X-rays with matter, see the X-ray data
booklet (<a href="./bibliography.html#citeproc_bib_item_237">Williams 2001</a>).
</p>
</div>
<div id="outline-container-sec:theory:xray_matter_gas" class="outline-4">
<h4 id="sec:theory:xray_matter_gas"><span class="section-number-4">6.1.1.</span> X-rays in solid matter &amp; gases</h4>
<div id="text-sec:theory:xray_matter_gas" class="outline-text-4">
<p>
Lambert-Beer&apos;s law (<a href="./bibliography.html#citeproc_bib_item_50">Bouguer 1729</a>; <a href="./bibliography.html#citeproc_bib_item_143">Lambert 1760</a>; <a href="./bibliography.html#citeproc_bib_item_39">Beer 1852</a>)
</p>

\begin{equation}
\label{eq:theory:beer_lambert_law}
I(z) = I_0 e^{-μz},
\end{equation}

<p>
gives the intensity of radiation \(I(z)\) after traversing through a
medium with constant attenuation \(μ\) of length \(z\), given a starting
intensity of \(I_0\). Directly related is of course the absorption
length \(l_{\text{abs}} = 1/μ\) (or mean free path), which is a useful
property when considering typical absorption depths.
</p>

<p>
This law is of vital importance for the behavior of X-rays traversing
through matter, which is needed to compute the efficiency of a gaseous
detector with an entrance window. In addition, it is also related to
the mean free path of X-rays in a gas, which is an important parameter
in gaseous detectors to understand the absorption efficiency of X-rays
at different energies and the resulting expected diffusion.
</p>

<p>
In the context of X-rays the factor \(μ\) is typically rewritten via the
&apos;mass attenuation coefficient&apos; \(μ_m = μ · ρ\) with \(ρ\) the density of
the material, commonly in \(\si{g.cm^{-3}}\). \(μ_m\) is then defined by
</p>

<p>
\[
μ_m = \frac{N_A}{M} σ_A,
\]
</p>

<p>
where \(N_A\) is Avogadro&apos;s number, \(M\) the molar mass of the medium in
units of \(\si{g\per\mol}\) and \(σ_A\) is the photoabsorption cross section
in units of \(\si{cm^2}\). Thus, the mass attenuation coefficient is
usually given in \(\si{cm^2.g^{-1}}\) such that \(μ = μ_m · ρ\) is of inverse length
as expected. This directly yields the definition of the absorption
length,
</p>

<p>
\[
l_{\text{abs}} = \frac{1}{μ}.
\]
</p>

<p>
Further, the photoabsorption cross section can be described via the
atomic scattering factor \(f₂\)
</p>

<p>
\[
σ_A = 2 r_e λ f₂,
\]
</p>

<p>
where \(r_e\) is the classical electron radius and \(λ\) the wavelength of
the X-ray. \(f₂\) is the imaginary part of the forward scattering factor
\(f\)
</p>

<p>
\[
f = f₁ - i f₂
\]
</p>

<p>
which itself is the simplification of the general atomic scattering
factor that describes the atom specific part of the scattering cross
section.
</p>

<p>
This way of expressing it has the nice property of relying on a well
tabulated parameter \(f₂\). Together with \(f₁\) these tabulated values
can be used to compute everything from the refractive index at a
specific X-ray energy of a compound to the attenuation coefficient and
even reflectivity of a multi-layer substrate. It generalizes from
single element to compounds easily by
</p>

<p>
\[
μ_m = \frac{N_A}{M_c} \sum_i n_i σ_{A,i},
\]
</p>

<p>
with \(M_c\) the molar weight of the compound and \(n_i\) the number of
atoms of kind \(i\). X-ray absorption and transmission properties can be
calculated from this only requiring the atomic scattering factors,
which can be found tabulated for different elements, for example by
<a href="https://www.nist.gov/pml/x-ray-form-factor-attenuation-and-scattering-tables">NIST</a> and <a href="https://henke.lbl.gov/optical_constants/asf.html">Henke</a>.
</p>

<p>
There is an online calculator for calculations of X-ray transmission
found under <sup>  <a id="fnr.10" href="#fn.10" class="footref" role="doc-backlink">10</a></sup> (<a href="./bibliography.html#citeproc_bib_item_109">Henke, Gullikson, and Davis 1993</a>), as well as a library
implementation developed during the course of this thesis
under <sup>  <a id="fnr.11" href="#fn.11" class="footref" role="doc-backlink">11</a></sup> (<a href="./bibliography.html#citeproc_bib_item_204">Schmidt and SciNim contributors 2022</a>)
for this purpose. 
</p>

<p>
Fig. <a href="#fig:theory:transmission_examples">9</a> shows an example of X-ray
transmission through a \(\SI{300}{nm}\) thick layer of \ccsini as well
as transmission through \(\SI{3}{cm}\) of argon at normal temperature and
pressure (NTP), \(\SI{1}{atm}\), \(\SI{20}{°C}\). All information about
the absorption lines and general transmission is encoded in \(f₂\). 
</p>


<figure id="fig:theory:transmission_examples">
<img alt="transmission_example.svg" class="org-svg" src="./figs/home/basti/phd/Figs/theory/transmission_example.svg" />

<figcaption>Figure 9: <span class="figure-number">Figure 8: </span>X-ray transmission through a \SI{300}{nm} thick layer of \ccsini and \SI{3}{cm} of argon calculated with <a href="cite:Schmidt_xrayAttenuation_2022">cite:Schmidt_xrayAttenuation_2022</a>. Calculation of the transmission based on tabulated scattering form factors.</figcaption>
</figure>
</div>
<div id="outline-container-org023f543" class="outline-5">
<h5 id="org023f543"><span class="section-number-5">6.1.1.1.</span> Absorption length of Argon   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-6-1-1-1" class="outline-text-5">
<p>
Fig. <a href="#fig:theory:absorption_length_argon">11</a> also shows the absorption
length for argon at NTP.
</p>


<figure id="fig:theory:absorption_length_argon">
<img alt="absorption_length_example.svg" class="org-svg" src="./figs/home/basti/phd/Figs/theory/absorption_length_example.svg" />

<figcaption>Figure 11: <span class="figure-number">Figure 9: </span>Absorption length of \SI{3}{cm} of argon calculated with <a href="cite:Schmidt_xrayAttenuation_2022">cite:Schmidt_xrayAttenuation_2022</a>. Calculation based on tabulated scattering form factors.</figcaption>
</figure>
</div>
</div>
<div id="outline-container-sec:theory:generate_transmission_plot" class="outline-5">
<h5 id="sec:theory:generate_transmission_plot"><span class="section-number-5">6.1.1.2.</span> Generation of \ccsini transmission figure   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-sec:theory:generate_transmission_plot" class="outline-text-5">
<p>
Let&apos;s compute an example transmission plot using the Lambert-Beer law
as presented above based on <code>xrayAttenuation</code> now, on the one hand for
\ccsini as well as argon (common detector gas).
</p>

<p>
<b>TODO</b>: update ginger to use <code>-output-directory</code> to put the plot in
the right path &amp; turn it into a TikZ plot.
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / strutils
<span style="color: #F92672;">import</span> xrayAttenuation, ggplotnim
<span style="color: #75715E;"># </span><span style="color: #75715E;">generate a compound of silicon and nitrogen with correct number of atoms</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">Si</span>₃N₄ = compound<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Si</span>, <span style="font-style: italic;">3</span><span style="color: #66D9EF;">)</span>, <span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">N</span>, <span style="font-style: italic;">4</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">instantiate an Argon instance</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ar </span>= <span style="color: #66D9EF;">Argon</span>.init<span style="color: #AE81FF;">()</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">compute the density using ideal gas law at 1 atm</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ρ_Ar </span>= density<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1013</span>.<span style="font-style: italic;">25</span>.mbar.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Pascal</span><span style="color: #66D9EF;">)</span>, <span style="font-style: italic;">293</span>.<span style="font-style: italic;">15</span>.<span style="color: #66D9EF;">K</span>, ar.molarMass<span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">define energies in which to compute the transmission</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">(we don&apos;t start at 0, as at 0 energy the parameters are not well defined)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= linspace<span style="color: #AE81FF;">(</span>1e-<span style="font-style: italic;">2</span>, <span style="font-style: italic;">10</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">compTrans</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">T</span>: <span style="color: #66D9EF;">AnyCompound</span><span style="color: #AE81FF;">](</span>el: <span style="color: #66D9EF;">T</span>, ρ: g•cm⁻³, length: <span style="color: #66D9EF;">Meter</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> =
  <span style="color: #FD971F;">result</span> = toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span> : energies <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">float</span>: <span style="color: #E6DB74;">&quot;μ&quot;</span> ~ el.attenuationCoefficient<span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span><span style="color: #E6DB74;">)</span>.keV<span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">}</span>,
            f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">float</span>: <span style="color: #E6DB74;">&quot;Trans&quot;</span> ~ transmission<span style="color: #A6E22E;">(</span>`μ`.cm²•g⁻¹, ρ, length<span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">}</span>,
            f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">float</span>: <span style="color: #E6DB74;">&quot;l_abs&quot;</span> ~ absorptionLength<span style="color: #A6E22E;">(</span>el, ρ, idx<span style="color: #E6DB74;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span><span style="color: #E6DB74;">)</span>.keV<span style="color: #A6E22E;">)</span>.to<span style="color: #A6E22E;">(</span>cm<span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">}</span>,
            f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Compound&quot;</span> &lt;- el.name<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">compute transmission for Si₃N₄ (known density and desired length)</span>
df.<span style="color: #F92672;">add</span> Si₃N₄.compTrans<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>.<span style="font-style: italic;">44</span>.g•cm⁻³, <span style="font-style: italic;">300</span>.nm.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Meter</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">and for argon </span>
df.<span style="color: #F92672;">add</span> ar.compTrans<span style="color: #AE81FF;">(</span>ρ_Ar, <span style="font-style: italic;">3</span>.cm.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Meter</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">create a plot for the transmissions</span>
<span style="color: #F92672;">echo</span> df
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">dS </span>= pretty<span style="color: #AE81FF;">(</span><span style="font-style: italic;">300</span>.nm, <span style="font-style: italic;">3</span>, short = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">dA </span>= pretty<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>.cm, <span style="font-style: italic;">1</span>, short = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">si </span>= r<span style="color: #E6DB74;">&quot;$\mathrm{Si}₃\mathrm{N}₄$&quot;</span>
ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span>, <span style="color: #E6DB74;">&quot;Trans&quot;</span>, color = <span style="color: #E6DB74;">&quot;Compound&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Energy [$\si{keV}$]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Transmission&quot;</span><span style="color: #AE81FF;">)</span> +
  ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Transmission examples of </span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;"> </span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;"> and </span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;"> Argon at NTP&quot;</span> % <span style="color: #66D9EF;">[</span>dS, si, dA<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">600</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> +
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/theory/transmission_example.pdf&quot;</span>,
         useTex = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">dff </span>= df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">float</span> -&gt; <span style="color: #66D9EF;">bool</span>: classify<span style="color: #A6E22E;">(</span>`l_abs`<span style="color: #A6E22E;">)</span> != fcInf<span style="color: #66D9EF;">}</span>,
                    f<span style="color: #66D9EF;">{</span>`<span style="color: #66D9EF;">Compound</span>` == <span style="color: #E6DB74;">&quot;Argon&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> dff
ggplot<span style="color: #AE81FF;">(</span>dff, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span>, <span style="color: #E6DB74;">&quot;l_abs&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Energy [$\si{keV}$]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Absorption length [$\si{cm}$]&quot;</span><span style="color: #AE81FF;">)</span> +
  ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Absorption length of </span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;"> Argon at NTP&quot;</span> % <span style="color: #66D9EF;">[</span>dA<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">600</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> +  
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/theory/absorption_length_example.pdf&quot;</span>,
         useTex = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span><span style="color: #AE81FF;">)</span>
  
</pre>
</div>


<p>
The absorption length of pure argon at NTP is seen in
fig. <a href="#fig:theory:absorption_length_argon">11</a>.
</p>


<figure id="fig:theory:absorption_length_argon">
<img alt="absorption_length_example.svg" class="org-svg" src="./figs/home/basti/phd/Figs/theory/absorption_length_example.svg" />

<figcaption>Figure 11: <span class="figure-number">Figure 10: </span>Absorption length of argon at NTP. The absorption edge and long absorption length around the Kα line is clearly visible showing the reason for the escape peak in the \cefe spectrum.</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-sec:theory:xray_reflectivity" class="outline-4">
<h4 id="sec:theory:xray_reflectivity"><span class="section-number-4">6.1.2.</span> X-ray reflectivity &amp; scattering</h4>
<div id="text-sec:theory:xray_reflectivity" class="outline-text-4">
<p>
The same atomic scattering factors \(f₁\) and \(f₂\) introduced in section
<a href="./theory_detector.html#sec:theory:xray_matter_gas">6.1.1</a> for the attenuation can also be used to
compute the reflectivity of X-rays under shallow angles. A great
overview of the relevant physics for X-ray reflectivity is found in
(<a href="./bibliography.html#citeproc_bib_item_238">Windt 1998</a>), which introduces the <code>IMD</code> program for the
simulation of multilayer coatings for X-rays.
</p>

<p>
By defining the combined scattering factor
</p>

<p>
\[
f(E) = f₁(E) + i f₂(E)
\]
</p>

<p>
at energy \(E\), the refractive index \(n\) of a medium can be computed using
</p>

<p>
\[
n(E) = 1 - r_e \frac{λ²}{2π} \sum_i n_{ai} f_i(E)
\]
</p>

<p>
where \(n_{ai}\) is the number density of the \(i\text{-th}\) compound of the
medium. By expressing the refractive index for X-rays in this fashion,
reflectivity can be expressed using the Fresnel equations, just like
for visible light. The reflectivity for s-polarization is calculated
by
</p>
\begin{equation}
\label{eq:theory:fresnell_reflectance_s}
r^s_{ik} = \frac{n_i · \cos(θ_i) - n_k · \cos(θ_k)}{n_i · \cos(θ_i) + n_k · \cos(θ_k)}
\end{equation}
<p>
while for p-polarization it is done via
</p>
\begin{equation}
\label{eq:theory:fresnell_reflectance_p}
r^p_{ik} = \frac{n_i · \cos(θ_k) - n_k · \cos(θ_i)}{n_i · \cos(θ_k) + n_k · \cos(θ_i)}.
\end{equation}

<p>
Here \(θ_i\), \(θ_k\) are the incident and refracted angles and \(n_i\), \(n_k\) the
refractive indices on the incident and outgoing
side \(i\) and \(k\), respectively.
</p>

<p>
The total reflected energy, the reflectance \(R\), is expressed as
</p>

<p>
\[
R = \frac{1}{2}\left( \left|r^s\right|² + \left|r^p\right|²\right)
\]
</p>

<p>
for unpolarized light. This can be generalized to multiple layers of
material on a substrate and including a surface roughness. Combined,
these provide the essence for a realistic computation of the
efficiency of an X-ray telescope mirror shell. 
</p>

<p>
This is also implemented in <sup>  <a id="fnr.11" href="#fn.11" class="footref" role="doc-backlink">11</a></sup>
(<a href="./bibliography.html#citeproc_bib_item_204">Schmidt and SciNim contributors 2022</a>) and <sup>  <a id="fnr.10" href="#fn.10" class="footref" role="doc-backlink">10</a></sup>
(<a href="./bibliography.html#citeproc_bib_item_109">Henke, Gullikson, and Davis 1993</a>) also provides an online calculator for such
reflectivities.
</p>

<dl class="org-dl">
<dt>Depth graded multilayers</dt><dd><p>
One particular kind of surface, the
depth graded multilayer, is used in certain kinds of modern X-ray
telescopes, for example the LLNL telescope at CAST following the
NuSTAR design. In such a multilayer, repeating layers of a low atomic
number \(Z\) material and a high \(Z\) material are stacked at
decreasing thicknesses.
</p>

<p>
A depth-graded multilayer is described by the equation:
\[
  d_i = \frac{a}{(b + i)^c}
  \]
where \(d_i\) is the depth of layer \(i\) (out of \(N\) layers),
\[
  a = d_{\text{min}} (b + N)^c
  \]
and
\[
  b = \frac{1 - N k}{k - 1}
  \]
with
\[
  k = \left(\frac{d_{\text{min}}}{d_{\text{max}}}\right)^{\frac{1}{c}}
  \]
where \(d_{\text{min}}\) and \(d_{\text{max}}\) are the thickness of the
bottom and top most layers, respectively.
</p>

<p>
For example for the the LLNL telescope a Pt/C depth graded
multilayer is used, in which a top layer of carbon is stacked on top
of a platinum layer. Between 2 to 5 repetitions of decreasing
thickness are stacked with a ratio of \(\SIrange{40}{45}{\%}\) carbon
to platinum in thickness. More details on this will be discussed in
appendix <a href="./raytracing.html#sec:appendix:raytracing">37</a>, as it is of vital importance to
calculate the axion image required for the limit calculation
correctly.
</p>

<p>
The reflectivity for a depth-graded multilayer is computed
recursively from the bottom of the stack to the top layer using
</p>

<p>
\[
  r_i = \frac{r_{ik} + r_k \exp(2 i β_i)}{1 + r_{ik} r_k \exp(2 i β_i)}
  \]
</p>

<p>
with
</p>

<p>
\[
  β_i = 2π · d_i · \frac{\cos(θ_i)}{λ},
  \]
</p>

<p>
where \(θ_i\) as seen from the normal axis and with the wavelength of
the incoming X-rays \(λ\). The \(r_{ik}\) values are computed following
equations \eqref{eq:theory:fresnell_reflectance_s} and
\eqref{eq:theory:fresnell_reflectance_p}. Such multilayers work by summing
the reflecting contributions from the different layer
transitions. Different thicknesses of the different multilayers mean
X-rays at different energies and angles are best reflected from
different layers. Thus, a much improved overall reflectivity over a
wider energy and angle range can be achieved compared to a normal
single layer on a substrate (e.g. a gold coating as used for the
XMM-Newton or ABRIXAS optics).
</p></dd>
</dl>
</div>
<div id="outline-container-org7ab42bf" class="outline-5">
<h5 id="org7ab42bf"><span class="section-number-5">6.1.2.1.</span> Other notes   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-6-1-2-1" class="outline-text-5">
<p>
\[
R = \left| \frac{k_m - k_p}{k_m + k_p} \right|²
\]
</p>

<p>
where \(k_m\) and \(k_p\) are
</p>

<p>
\[
k_m = \sqrt{k² - (k \cos{θ})²}
\]
</p>

<p>
and
</p>

<p>
\[
k_p = \sqrt{ k² n² - (k \cos{θ})² }
\]
</p>

<p>
defined via the wave number \(k\), which itself is computed via
</p>

<p>
\[
k = 2π \sin{θ} / λ.
\]
</p>
</div>
</div>
</div>
<div id="outline-container-sec:theory:bethe_bloch" class="outline-4">
<h4 id="sec:theory:bethe_bloch"><span class="section-number-4">6.1.3.</span> Bethe-Bloch equation</h4>
<div id="text-sec:theory:bethe_bloch" class="outline-text-4">
<p>
Another relevant aspect for gaseous detectors is the energy deposition
of charged particles. In particular for experiments that sit near
Earth&apos;s surface, a major source of background is due to cosmic
radiation, with cosmic muons making up more than \(\SI{95}{\%}\)
(<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>) of radiation (aside from neutrinos) at the surface,
see sec. <a href="./theory_detector.html#sec:theory:cosmic_radiation">6.2</a>. 
</p>

<p>
The energy loss of such muons can be calculated with the Bethe-Bloch
equation, which describes the average energy loss per distance for a
charged particle with charge \(z\) in a homogeneous medium with charge
carriers \(Z\). (<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>) <sup>  <a id="fnr.12" href="#fn.12" class="footref" role="doc-backlink">12</a></sup> 
</p>

\begin{equation}
\label{eq:theory:bethe_bloch_eq}
  \left⟨ -\frac{\mathrm{d}E}{\mathrm{d}x} \right⟩ = 
    K z² \frac{Z}{A} \frac{1}{β²} \left[ 
      \frac{1}{2} \ln\frac{2m_e c² β² γ² W_{\text{max}}}{I²} - β² - \frac{δ(βγ)}{2} 
    \right]
\end{equation}
<p>
where the different variables are as follows:
</p>
<ul class="org-ul">
<li>\(K = 4π N_A r_e² m_e c² = \SI{0.307075}{MeV.mol^{-1}.cm^2}\)</li>
<li>\(W_{\text{max}}\): maximum possible energy transfer to an electron in
a single interaction</li>
<li>\(I\): mean excitation energy of the absorber material in \si{\eV}</li>
<li>\(δ(βγ)\): density-effect correction to energy loss</li>
<li>and \(r_e = \frac{e²}{4π ε_0 m_e c²}\) the classical electron radius,
\(N_A\) Avogadro&apos;s number, \(m_e\) electron mass, \(c\) speed of light
in vacuum, \(z\) charge number of incident particle, \(Z\) atomic number
of absorber material, \(A\) atomic mass of absorber material, \(β =
  v/c\) speed of incident particle, \(γ\) Lorentz factor</li>
</ul>

<p>
This interaction behavior of muons leads to a specific, expected
energy loss per distance. Commonly they are &apos;minimum ionizing
particles&apos; (MIPs), as their energies lies between
\(\SIrange{0.1}{100}{GeV}\), the large &apos;valley&apos; in which the Bethe
equation is applicable <sup>  <a id="fnr.13" href="#fn.13" class="footref" role="doc-backlink">13</a></sup>. For argon gas at normal
conditions this is shown in fig. <a href="#fig:theory:muon_argon_3cm_bethe_loss">12</a>.
</p>

<p>
As the Bethe formula was derived from quantum mechanical perturbation
theory, higher order corrections can be computed. For our purposes
here the leading order is enough. It is important to keep in mind that
the Bethe-Bloch equation gives the <i>mean energy</i> per distance. When
considering short distances as typically encountered in particle
detectors, this mean is skewed by rare interactions that deposit large
amounts of energy (towards \(W_{\text{max}}\)). The energy deposition
along short distances is typically described by a Landau-Vavilov
distribution (similar, but different from a normal Landau
distribution) (<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>; <a href="./bibliography.html#citeproc_bib_item_46">Bichsel 2006</a>). The most probable
energy loss is often a more appropriate number to look at. It can be
expressed as
</p>

\begin{equation}
\label{eq:theory:most_probable_loss}
Δ_p = ξ \left[ \ln{ \frac{2 m_e c² β² γ²}{I}} + \ln{\frac{ξ}{I}} + j - β² - δ(βγ) \right],
\end{equation}

<p>
where \(ξ\) is
</p>

<p>
\[
ξ = \frac{1}{2} K z² \left⟨ \frac{Z}{A} \right⟩ \frac{x}{β²} \, \si{MeV},
\]
</p>

<p>
for a detector in which the material column the particle travels
through is expressed as \(x = d · ρ\) of a distance \(d\) in
\(\si{g.cm^{-2}}\). \(j = \num{0.200}\) is an empirical constant
(<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>; <a href="./bibliography.html#citeproc_bib_item_45">Bichsel 1988</a>). Further, \(⟨Z / A⟩\) is simply
the average \(Z/A\) for a material compound \(⟨Z/A⟩ = \sum_i w_i Z_i / A_i\).
</p>

<p>
The large difference typically encountered between the most probable
and the mean value for the energy loss in particle detectors, makes
studying the expected signals a complicated topic. For a detailed
description relevant for thin gaseous detectors, see especially
(<a href="./bibliography.html#citeproc_bib_item_46">Bichsel 2006</a>). 
</p>

<p>
Fig. <a href="#fig:theory:muon_argon_3cm_bethe_loss">12</a> shows the comparison of the
most probable energy loss via equation \eqref{eq:theory:most_probable_loss}
and the mean energy loss via the Bethe-Bloch equation
\eqref{eq:theory:bethe_bloch_eq} for muons of different energies traversing
\(\SI{3}{cm}\) of argon gas.
</p>


<figure id="fig:theory:muon_argon_3cm_bethe_loss">
<img alt="ar_energy_loss_cast.svg" class="org-svg" src="./figs/home/basti/phd/Figs/muonStudies/ar_energy_loss_cast.svg" />

<figcaption>Figure 12: <span class="figure-number">Figure 11: </span>Mean energy loss via Bethe-Bloch (purple) equation of muons in \SI{3}{\cm} of argon at conditions in use in GridPix detector at CAST. \SI{1050}{mbar} of chamber pressure at room temperature. Note that the mean is skewed by events that transfer a large amount of energy, but are very rare! As such care must be taken interpreting the numbers. Green shows the most probable energy loss, based on the peak of the Landau-Vavilov distribution underlying the Bethe-Bloch mean value.</figcaption>
</figure>
</div>
<div id="outline-container-orgf885293" class="outline-5">
<h5 id="orgf885293"><span class="section-number-5">6.1.3.1.</span> Parameters Bethe-Bloch long   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-6-1-3-1" class="outline-text-5">
<ul class="org-ul">
<li>\(K = 4π N_A r_e² m_e c² = \SI{0.307075}{MeV.mol^{-1}.cm^2}\)</li>
<li>\(r_e = \frac{e²}{4π ε_0 m_e c²} = \SI{2.817 940 3227(19)}{fm}\): classical</li>
<li><p>
\(N_A = \SI{6.022 140 857(74)e23}{\mol^{-1}}\): Avogadro&apos;s number
</p>

<p>
electron radius
</p></li>
<li>\(m_e = \SI{9.1093837015(28)e-31}{\kg}\): electron mass</li>
<li>\(c = \SI{299792458}{\meter\per\second}\): speed of light in vacuum</li>
<li>\(z\): charge number of incident particle</li>
<li>\(Z\): atomic number of absorber material</li>
<li>\(A\): atomic mass of absorber material</li>
<li>\(β = \frac{v}{c}\): speed of incident particle</li>
<li>\(γ = \frac{1}{\sqrt{1 - β²}}\): Lorentz factor</li>
<li>\(W_{\text{max}}\): Maximum possible energy transfer to an electron in
a single interaction</li>
<li>\(I\): mean excitation energy of the absorber material in \si{\eV}</li>
<li>\(δ(βγ)\): density-effect correction to energy loss</li>
</ul>
</div>
</div>
<div id="outline-container-org142b9f1" class="outline-5">
<h5 id="org142b9f1"><span class="section-number-5">6.1.3.2.</span> Bethe equation for muons traversing \(\SI{3}{\cm}\) of argon gas   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-6-1-3-2" class="outline-text-5">
<p>
We will now compute the energy loss for muons traversing the
\SI{3}{\cm} of argon gas that are seen by a muon traversing
orthogonally to the readout plane (i.e. such that it may look like a
photon).
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> math, macros, unchained, ggplotnim, sequtils, strformat, strutils
<span style="color: #F92672;">import</span> thesisHelpers
<span style="color: #F92672;">import</span> ggplotnim / ggplot_vegatex

<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">K</span> = <span style="font-style: italic;">4</span> * π * <span style="color: #66D9EF;">N_A</span> * r_e^<span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">usually in: [MeV mol⁻¹ cm²]</span>

defUnit<span style="color: #AE81FF;">(</span>cm³•g⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">J</span>•m⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>cm⁻³<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>g•mol⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">MeV</span>•g⁻¹•cm²<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>mol⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>keV•cm⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>g•cm⁻³<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>g•cm⁻²<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">I</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">](</span>z: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">T</span> =
  <span style="color: #E6DB74;">## use Bloch approximation for all but Argon (better use tabulated values!)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #F92672;">if</span> z == <span style="font-style: italic;">18</span>.<span style="font-style: italic;">0</span>: <span style="font-style: italic;">188</span>.<span style="font-style: italic;">0</span>.eV.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">)</span> 
           <span style="color: #F92672;">else</span>: <span style="color: #AE81FF;">(</span><span style="font-style: italic;">10</span>.eV * z<span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">calcβ</span><span style="color: #AE81FF;">(</span>γ: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">UnitLess</span> =
  <span style="color: #FD971F;">result</span> = sqrt<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / <span style="color: #66D9EF;">(</span>γ^<span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">betheBloch</span><span style="color: #AE81FF;">(</span>z, <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>, <span style="color: #66D9EF;">A</span>: g•mol⁻¹, γ: <span style="color: #66D9EF;">UnitLess</span>, <span style="color: #66D9EF;">M</span>: kg<span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">MeV</span>•g⁻¹•cm² =
  <span style="color: #E6DB74;">## result in MeV cm² g⁻¹ (normalized by density)</span>
  <span style="color: #E6DB74;">## z: charge of particle</span>
  <span style="color: #E6DB74;">## Z: charge of particles making up medium</span>
  <span style="color: #E6DB74;">## A: atomic mass of particles making up medium</span>
  <span style="color: #E6DB74;">## γ: Lorentz factor of particle</span>
  <span style="color: #E6DB74;">## M: mass of particle in MeV (or same mass as `</span><span style="color: #AE81FF;">m_e</span><span style="color: #E6DB74;">` defined as)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">β </span>= calcβ<span style="color: #AE81FF;">(</span>γ<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">W_max</span> = <span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> * β^<span style="font-style: italic;">2</span> * γ^<span style="font-style: italic;">2</span> / <span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span> + <span style="font-style: italic;">2</span> * γ * m_e / <span style="color: #66D9EF;">M</span> + <span style="color: #66D9EF;">(</span>m_e / <span style="color: #66D9EF;">M</span><span style="color: #66D9EF;">)</span>^<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">lnArg </span>= <span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> * β^<span style="font-style: italic;">2</span> * γ^<span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">W_max</span> / <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">I</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">Joule</span><span style="color: #66D9EF;">](</span><span style="color: #66D9EF;">Z</span><span style="color: #66D9EF;">)</span>^<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">K</span> * z^<span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">Z</span> / <span style="color: #66D9EF;">A</span> * <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / <span style="color: #66D9EF;">(</span>β^<span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span> * <span style="color: #66D9EF;">(</span>
   <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span> * ln<span style="color: #A6E22E;">(</span>lnArg<span style="color: #A6E22E;">)</span> - β^<span style="font-style: italic;">2</span>
  <span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">MeV</span>•g⁻¹•cm²<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">mostProbableLoss</span><span style="color: #AE81FF;">(</span>z, <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>, <span style="color: #66D9EF;">A</span>: g•mol⁻¹, γ: <span style="color: #66D9EF;">UnitLess</span>,
                      x: g•cm⁻²<span style="color: #AE81FF;">)</span>: keV =
  <span style="color: #E6DB74;">## Computes the most probable value, corresponding to the peak of the Landau</span>
  <span style="color: #E6DB74;">## distribution, that gives rise to the Bethe-Bloch formula.</span>
  <span style="color: #E6DB74;">##</span>
  <span style="color: #E6DB74;">## Taken from PDG chapter &apos;Passage of particles through matter&apos; equation</span>
  <span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">34.12</span><span style="color: #E6DB74;">` in &apos;Fluctuations in energy loss&apos;, version 2020).</span>
  <span style="color: #E6DB74;">##</span>
  <span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">x</span><span style="color: #E6DB74;">` is the &quot;thickness&quot;. Density times length, `</span><span style="color: #AE81FF;">x = ρ * d</span><span style="color: #E6DB74;">`. The other parameters</span>
  <span style="color: #E6DB74;">## are as in `</span><span style="color: #AE81FF;">betheBloch</span><span style="color: #E6DB74;">` above.</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">β </span>= calcβ<span style="color: #AE81FF;">(</span>γ<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ξ </span>= <span style="color: #66D9EF;">K</span> / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> * <span style="color: #66D9EF;">Z</span> / <span style="color: #66D9EF;">A</span> * z*z * <span style="color: #AE81FF;">(</span>x / <span style="color: #66D9EF;">(</span>β*β<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">j </span>= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">200</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">I</span> = <span style="color: #66D9EF;">I</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">Joule</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">Z</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>ξ * <span style="color: #66D9EF;">(</span> ln<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">(</span><span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> * β^<span style="font-style: italic;">2</span> * γ^<span style="font-style: italic;">2</span><span style="color: #E6DB74;">)</span>.to<span style="color: #E6DB74;">(</span><span style="color: #66D9EF;">Joule</span><span style="color: #E6DB74;">)</span> / <span style="color: #66D9EF;">I</span><span style="color: #A6E22E;">)</span> + ln<span style="color: #A6E22E;">(</span>ξ.to<span style="color: #E6DB74;">(</span><span style="color: #66D9EF;">Joule</span><span style="color: #E6DB74;">)</span> / <span style="color: #66D9EF;">I</span><span style="color: #A6E22E;">)</span> + j - β^<span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>keV<span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">- δ*(β*γ)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">density</span><span style="color: #AE81FF;">(</span>p: mbar, <span style="color: #66D9EF;">M</span>: g•mol⁻¹, temp: <span style="color: #66D9EF;">Kelvin</span><span style="color: #AE81FF;">)</span>: g•cm⁻³ =
  <span style="color: #E6DB74;">## returns the density of the gas for the given pressure.</span>
  <span style="color: #E6DB74;">## The pressure is assumed in `</span><span style="color: #AE81FF;">mbar</span><span style="color: #E6DB74;">` and the temperature (in `</span><span style="color: #AE81FF;">K</span><span style="color: #E6DB74;">`).</span>
  <span style="color: #E6DB74;">## The default temperature corresponds to BabyIAXO aim.</span>
  <span style="color: #E6DB74;">## Returns the density in `</span><span style="color: #AE81FF;">g / cm^3</span><span style="color: #E6DB74;">`</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">gasConstant </span>= <span style="font-style: italic;">8</span>.<span style="font-style: italic;">314</span>.<span style="color: #66D9EF;">J</span>•K⁻¹•mol⁻¹ <span style="color: #75715E;"># </span><span style="color: #75715E;">joule K^-1 mol^-1</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">pressure </span>= p.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Pa</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">pressure in Pa</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>pressure * <span style="color: #66D9EF;">M</span> / <span style="color: #66D9EF;">(</span>gasConstant * temp<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>g•cm⁻³<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E</span>: <span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">UnitLess</span> =
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">E</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Joule</span><span style="color: #AE81FF;">)</span> / <span style="color: #AE81FF;">(</span>m_μ * c^<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> + <span style="font-style: italic;">1</span>

<span style="color: #F92672;">type</span>
  <span style="color: #66D9EF;">Element</span> = <span style="color: #F92672;">object</span>
    name: <span style="color: #66D9EF;">string</span>
    <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>
    <span style="color: #66D9EF;">M</span>: g•mol⁻¹
    <span style="color: #66D9EF;">A</span>: <span style="color: #66D9EF;">UnitLess</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">numerically same as `</span><span style="color: #AE81FF;">M</span><span style="color: #75715E;">`</span>
    ρ: g•cm⁻³

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initElement</span><span style="color: #AE81FF;">(</span>name: <span style="color: #66D9EF;">string</span>, <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>, <span style="color: #66D9EF;">M</span>: g•mol⁻¹, ρ: g•cm⁻³<span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Element</span> =
  <span style="color: #66D9EF;">Element</span><span style="color: #AE81FF;">(</span>name: name, <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">Z</span>, <span style="color: #66D9EF;">M</span>: <span style="color: #66D9EF;">M</span>, <span style="color: #66D9EF;">A</span>: <span style="color: #66D9EF;">M</span>.<span style="color: #66D9EF;">UnitLess</span>, ρ: ρ<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">M_Ar</span> = <span style="font-style: italic;">39</span>.<span style="font-style: italic;">95</span>.g•mol⁻¹ <span style="color: #75715E;"># </span><span style="color: #75715E;">molar mass. Numerically same as relative atomic mass</span>
<span style="color: #75715E;">#</span><span style="color: #75715E;">let ρAr = density(1050.mbar, M_Ar, temp = 293.15.K)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ρAr </span>= density<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1013</span>.mbar, <span style="color: #66D9EF;">M_Ar</span>, temp = <span style="font-style: italic;">293</span>.<span style="font-style: italic;">15</span>.<span style="color: #66D9EF;">K</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">Argon</span> = initElement<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;ar&quot;</span>, <span style="font-style: italic;">18</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">UnitLess</span>, <span style="font-style: italic;">39</span>.<span style="font-style: italic;">95</span>.g•mol⁻¹, ρAr<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">intBethe</span><span style="color: #AE81FF;">(</span>e: <span style="color: #66D9EF;">Element</span>, d_total: cm, <span style="color: #66D9EF;">E0</span>: eV, dx = <span style="font-style: italic;">1</span>.μm<span style="color: #AE81FF;">)</span>: eV =
  <span style="color: #E6DB74;">## integrated energy loss of bethe formula after `</span><span style="color: #AE81FF;">d</span><span style="color: #E6DB74;">` cm of matter</span>
  <span style="color: #E6DB74;">## and returns the energy remaining</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">γ</span>: <span style="color: #66D9EF;">UnitLess</span> = <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E0</span>.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">d</span>: cm
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">E0</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">totalLoss </span>= <span style="font-style: italic;">0</span>.eV
  <span style="color: #F92672;">while</span> d &lt; d_total <span style="color: #F92672;">and</span> <span style="color: #FD971F;">result</span> &gt; <span style="font-style: italic;">0</span>.eV:
    <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_loss</span>: <span style="color: #66D9EF;">MeV</span> = betheBloch<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span>, e.<span style="color: #66D9EF;">Z</span>, e.<span style="color: #66D9EF;">M</span>, γ, m_μ<span style="color: #AE81FF;">)</span> * e.ρ * dx
    <span style="color: #FD971F;">result</span> = <span style="color: #FD971F;">result</span> - <span style="color: #66D9EF;">E_loss</span>.to<span style="color: #AE81FF;">(</span>eV<span style="color: #AE81FF;">)</span>
    γ = <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #FD971F;">result</span>.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
    d = d + dx.to<span style="color: #AE81FF;">(</span>cm<span style="color: #AE81FF;">)</span>
    totalLoss = totalLoss + <span style="color: #66D9EF;">E_loss</span>.to<span style="color: #AE81FF;">(</span>eV<span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">float</span>, <span style="color: #FD971F;">result</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>.eV

<span style="color: #F92672;">func</span> <span style="color: #A6E22E;">argonLabel</span><span style="color: #AE81FF;">()</span>: <span style="color: #66D9EF;">string</span> = <span style="color: #E6DB74;">&quot;fig:theory:muon_argon_3cm_bethe_loss&quot;</span>

<span style="color: #E6DB74;">## TODO: add in the most probable value calc!  </span>
<span style="color: #F92672;">func</span> <span style="color: #A6E22E;">argonCaption</span><span style="color: #AE81FF;">()</span>: <span style="color: #66D9EF;">string</span> = 
  <span style="color: #FD971F;">result</span> = r<span style="color: #E6DB74;">&quot;Mean energy loss via Bethe-Bloch (purple) equation of muons in \SI{3}{\cm} of argon at &quot;</span> &amp;
    r<span style="color: #E6DB74;">&quot;conditions in use in GridPix detector at CAST. \SI{1050}{mbar} of chamber pressure at room &quot;</span> &amp;
    r<span style="color: #E6DB74;">&quot;temperature. Note that the mean is skewed by events that transfer a large amount of energy, &quot;</span> &amp;
    r<span style="color: #E6DB74;">&quot;but are very rare! As such care must be taken interpreting the numbers. Green shows the most &quot;</span> &amp;
    r<span style="color: #E6DB74;">&quot;probable energy loss, based on the peak of the Landau-Vavilov distribution underlying the &quot;</span> &amp;
    r<span style="color: #E6DB74;">&quot;Bethe-Bloch mean value.&quot;</span> &amp;
    interactiveVega<span style="color: #AE81FF;">(</span>argonLabel<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotDetectorAbsorption</span><span style="color: #AE81FF;">(</span>element: <span style="color: #66D9EF;">Element</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_float</span> = logspace<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">2</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= <span style="color: #66D9EF;">E_float</span>.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_loss</span> = energies.mapIt<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>it.to<span style="color: #A6E22E;">(</span>eV<span style="color: #A6E22E;">)</span> - intBethe<span style="color: #A6E22E;">(</span>element, <span style="font-style: italic;">3</span>.cm, it.to<span style="color: #E6DB74;">(</span>eV<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>.to<span style="color: #66D9EF;">(</span>keV<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_lossMP</span> = energies.mapIt<span style="color: #AE81FF;">(</span>mostProbableLoss<span style="color: #66D9EF;">(</span>-<span style="font-style: italic;">1</span>, element.<span style="color: #66D9EF;">Z</span>, element.<span style="color: #66D9EF;">M</span>, <span style="color: #66D9EF;">E_to_γ</span><span style="color: #A6E22E;">(</span>it<span style="color: #A6E22E;">)</span>, ρ_Ar * <span style="font-style: italic;">3</span>.cm<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= seqsToDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">E_float</span>, <span style="color: #E6DB74;">&quot;Bethe-Bloch (BB)&quot;</span> : <span style="color: #66D9EF;">E_loss</span>, <span style="color: #E6DB74;">&quot;Most probable (MP)&quot;</span> : <span style="color: #66D9EF;">E_lossMP</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    .gather<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;Bethe-Bloch (BB)&quot;</span>, <span style="color: #E6DB74;">&quot;Most probable (MP)&quot;</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;Type&quot;</span>, <span style="color: #E6DB74;">&quot;Value&quot;</span><span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;E_float&quot;</span>, <span style="color: #E6DB74;">&quot;Value&quot;</span>, color = <span style="color: #E6DB74;">&quot;Type&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    <span style="color: #75715E;">#</span><span style="color: #75715E;">xlab(r&quot;μ Energy [\si{\GeV}]&quot;) + ylab(r&quot;$-\left\langle \frac{\mathrm{d}E}{\mathrm{d}x}\right\rangle$ [\si{\keV}]&quot;) +</span>
    xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;μ Energy [\si{\GeV}]&quot;</span><span style="color: #AE81FF;">)</span> +
    ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;$-\left\langle \frac{\mathrm{d}E}{\mathrm{d}x}\right\rangle$ (BB), $Δ_p$ (MP) [\si{\keV}]&quot;</span><span style="color: #AE81FF;">)</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
    themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">600</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> +
    margin<span style="color: #AE81FF;">(</span>right = <span style="font-style: italic;">6</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Energy loss of Muons in \SI{3}{\cm} &quot;</span> &amp; &amp;<span style="color: #E6DB74;">&quot;{element.name.capitalizeAscii} at CAST conditions&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muonStudies/{element.name}_energy_loss_cast.pdf&quot;</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;">#</span><span style="color: #75715E;">ggvegatex(&amp;&quot;/home/basti/phd/Figs/muonStudies/{element.name}_energy_loss_cast&quot;,</span>
    <span style="color: #75715E;">#          </span><span style="color: #75715E;">onlyTikZ = false,</span>
    <span style="color: #75715E;">#          </span><span style="color: #75715E;">caption = argonCaption(),</span>
    <span style="color: #75715E;">#          </span><span style="color: #75715E;">label = argonLabel(),</span>
    <span style="color: #75715E;">#          </span><span style="color: #75715E;">width = 600, height = 360)</span>
plotDetectorAbsorption<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Argon</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotMostProbable</span><span style="color: #AE81FF;">(</span>e: <span style="color: #66D9EF;">Element</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_float</span> = logspace<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= <span style="color: #66D9EF;">E_float</span>.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_loss</span> = energies.mapIt<span style="color: #AE81FF;">(</span>mostProbableLoss<span style="color: #66D9EF;">(</span>-<span style="font-style: italic;">1</span>, e.<span style="color: #66D9EF;">Z</span>, e.<span style="color: #66D9EF;">M</span>, <span style="color: #66D9EF;">E_to_γ</span><span style="color: #A6E22E;">(</span>it<span style="color: #A6E22E;">)</span>, ρ_Ar * <span style="font-style: italic;">3</span>.cm<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;E_loss&quot;</span> : <span style="color: #66D9EF;">E_loss</span>.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>, <span style="color: #66D9EF;">E_float</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;E_float&quot;</span>, <span style="color: #E6DB74;">&quot;E_loss&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> + 
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Energy [GeV]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Most probable loss [keV]&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/tmp/most_probable_loss.pdf&quot;</span><span style="color: #AE81FF;">)</span>
plotMostProbable<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Argon</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:theory:xray_fluorescence" class="outline-4">
<h4 id="sec:theory:xray_fluorescence"><span class="section-number-4">6.1.4.</span> X-ray fluorescence</h4>
<div id="text-sec:theory:xray_fluorescence" class="outline-text-4">
<p>
Cosmic muons in their interactions with matter can ionize atoms,
leading to the possible emission of X-rays if the removed electron is
part of an inner shell, mostly K (and some L) shell electrons. This
leads to a form of background based on real X-rays and thus represents
a kind of background that is impossible to distinguish from any kind
of axion signal unless external scintillator based vetoes are used. Of
course, to be relevant as a form of detector background the material
must be close to the detector, as the X-rays will otherwise be
absorbed. This makes the detector material, the gas itself and all
material in the direction of the detectors&apos; sensitivity a candidate
for X-ray fluorescence background.
</p>

<p>
Table <a href="#tab:theory:xray_fluorescence">1</a> lists the X-ray fluorescence lines
for elements one commonly encounters in the context of gaseous
detectors for a helioscope experiment. Table
<a href="#tab:theory:binding_energies">2</a> lists the atomic binding energies of the
same elements. This is intended as a useful reference to understand
possible lines in background, potential targets for an X-ray tube for
reference X-ray data and understand the absorption edges for
materials.
</p>

<p>
The difference between the binding energy and the energies of the most
likely fluorescence lines is the explanation for why commonly a
material is more transparent for a fluorescence X-ray than energies
slightly above it. This (among other effects) explains the &apos;escape
peak&apos; seen in many types of gaseous detectors. For example see
fig. <a href="#fig:theory:transmission_examples">9</a> for the argon transmission. The
argon \(K 1s\) binding energy of \(\SI{3.2}{keV}\) is visible in the form
of the sudden drop in transmission (which is of course directly
proportional to the absorption length!). At the same time an X-ray
produced by an ionized argon atom from the \(K 1s\) electron via the Kα
line yields an X-ray of only \(\SI{2.95}{keV}\) and thus argon gas is
extremely transparent for such X-rays (this is the cause of so called
&apos;escape photons&apos;, see sec. <a href="./theory_detector.html#sec:theory:escape_peaks_55fe">6.3.8</a>).
</p>

<table id="tab:theory:xray_fluorescence">
<caption class="t-above"><span class="table-number">Table 1:</span> Excerpt of X-ray fluorescence energies of K, L and M emission lines for different elements mostly relevant for the context of this thesis in in \si{eV}. Taken from the X-ray data book <a href="cite:williams2001x">cite:williams2001x</a>, specifically <a href="https://xdb.lbl.gov/Section1/Table_1-2.pdf">https://xdb.lbl.gov/Section1/Table_1-2.pdf</a>.</caption>

<colgroup>
<col class="org-right" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Z</th>
<th scope="col" class="org-left">Element</th>
<th scope="col" class="org-left">Kα1</th>
<th scope="col" class="org-left">Kα2</th>
<th scope="col" class="org-left">Kβ1</th>
<th scope="col" class="org-left">Lα1</th>
<th scope="col" class="org-left">Lα2</th>
<th scope="col" class="org-left">Lβ1</th>
<th scope="col" class="org-left">Lβ2</th>
<th scope="col" class="org-left">Lγ1</th>
<th scope="col" class="org-left">Mα1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">6</td>
<td class="org-left">C</td>
<td class="org-left">277</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">N</td>
<td class="org-left">392.4</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">O</td>
<td class="org-left">524.9</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">Al</td>
<td class="org-left">1,486.70</td>
<td class="org-left">1,486.27</td>
<td class="org-left">1,557.45</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">Si</td>
<td class="org-left">1,739.98</td>
<td class="org-left">1,739.38</td>
<td class="org-left">1,835.94</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">18</td>
<td class="org-left">Ar</td>
<td class="org-left">2,957.70</td>
<td class="org-left">2,955.63</td>
<td class="org-left">3,190.5</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">22</td>
<td class="org-left">Ti</td>
<td class="org-left">4,510.84</td>
<td class="org-left">4,504.86</td>
<td class="org-left">4,931.81</td>
<td class="org-left">452.2</td>
<td class="org-left">452.2</td>
<td class="org-left">458.4</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">25</td>
<td class="org-left">Mn</td>
<td class="org-left">5,898.75</td>
<td class="org-left">5,887.65</td>
<td class="org-left">6,490.45</td>
<td class="org-left">637.4</td>
<td class="org-left">637.4</td>
<td class="org-left">648.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">26</td>
<td class="org-left">Fe</td>
<td class="org-left">6,403.84</td>
<td class="org-left">6,390.84</td>
<td class="org-left">7,057.98</td>
<td class="org-left">705.0</td>
<td class="org-left">705.0</td>
<td class="org-left">718.5</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">28</td>
<td class="org-left">Ni</td>
<td class="org-left">7,478.15</td>
<td class="org-left">7,460.89</td>
<td class="org-left">8,264.66</td>
<td class="org-left">851.5</td>
<td class="org-left">851.5</td>
<td class="org-left">868.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">29</td>
<td class="org-left">Cu</td>
<td class="org-left">8,047.78</td>
<td class="org-left">8,027.83</td>
<td class="org-left">8,905.29</td>
<td class="org-left">929.7</td>
<td class="org-left">929.7</td>
<td class="org-left">949.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">47</td>
<td class="org-left">Ag</td>
<td class="org-left">22,162.92</td>
<td class="org-left">21,990.3</td>
<td class="org-left">24,942.4</td>
<td class="org-left">2,984.31</td>
<td class="org-left">2,978.21</td>
<td class="org-left">3,150.94</td>
<td class="org-left">3,347.81</td>
<td class="org-left">3,519.59</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">54</td>
<td class="org-left">Xe</td>
<td class="org-left">29,779</td>
<td class="org-left">29,458</td>
<td class="org-left">33,624</td>
<td class="org-left">4,109.9</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left"> </td>
<td class="org-left">—</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">78</td>
<td class="org-left">Pt</td>
<td class="org-left">66,832</td>
<td class="org-left">65,112</td>
<td class="org-left">75,748</td>
<td class="org-left">9,442.3</td>
<td class="org-left">9,361.8</td>
<td class="org-left">11,070.7</td>
<td class="org-left">11,250.5</td>
<td class="org-left">12,942.0</td>
<td class="org-left">2,050.5</td>
</tr>

<tr>
<td class="org-right">79</td>
<td class="org-left">Au</td>
<td class="org-left">68,803.7</td>
<td class="org-left">66,989.5</td>
<td class="org-left">77,984</td>
<td class="org-left">9,713.3</td>
<td class="org-left">9,628.0</td>
<td class="org-left">11,442.3</td>
<td class="org-left">11,584.7</td>
<td class="org-left">13,381.7</td>
<td class="org-left">2,122.9</td>
</tr>

<tr>
<td class="org-right">82</td>
<td class="org-left">Pb</td>
<td class="org-left">74,969.4</td>
<td class="org-left">72,804.2</td>
<td class="org-left">84,936</td>
<td class="org-left">10,551.5</td>
<td class="org-left">10,449.5</td>
<td class="org-left">12,613.7</td>
<td class="org-left">12,622.6</td>
<td class="org-left">14,764.4</td>
<td class="org-left">2,345.5</td>
</tr>
</tbody>
</table>

<table id="tab:theory:binding_energies">
<caption class="t-above"><span class="table-number">Table 2:</span> Excerpt of electron binding energies of elements mostly relevant for the context of this thesis in \si{eV}. Taken from the X-ray data book <a href="cite:williams2001x">cite:williams2001x</a>, specifically <a href="https://xdb.lbl.gov/Section1/Table_1-1.pdf">https://xdb.lbl.gov/Section1/Table_1-1.pdf</a>.</caption>

<colgroup>
<col class="org-right" />

<col class="org-left" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Z</th>
<th scope="col" class="org-left">Element</th>
<th scope="col" class="org-right">K 1s</th>
<th scope="col" class="org-right">L1 2s</th>
<th scope="col" class="org-right">L2 2p1/2</th>
<th scope="col" class="org-right">L3 2p3/2</th>
<th scope="col" class="org-right">M1 3s</th>
<th scope="col" class="org-right">M2 3p1/2</th>
<th scope="col" class="org-right">M3 3p3/2</th>
<th scope="col" class="org-left">M4 3d3/2</th>
<th scope="col" class="org-left">M5 3d5/2</th>
<th scope="col" class="org-left"> </th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">6</td>
<td class="org-left">C</td>
<td class="org-right">284.2</td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">N</td>
<td class="org-right">409.9</td>
<td class="org-right">37.3</td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">O</td>
<td class="org-right">543.1</td>
<td class="org-right">41.6</td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">Al</td>
<td class="org-right">1559.6</td>
<td class="org-right">117.8</td>
<td class="org-right">72.95</td>
<td class="org-right">72.55</td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">Si</td>
<td class="org-right">1839</td>
<td class="org-right">149.7</td>
<td class="org-right">99.82</td>
<td class="org-right">99.42</td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">18</td>
<td class="org-left">Ar</td>
<td class="org-right">3205.9</td>
<td class="org-right">326.3</td>
<td class="org-right">250.6</td>
<td class="org-right">248.4</td>
<td class="org-right">29.3</td>
<td class="org-right">15.9</td>
<td class="org-right">15.7</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">22</td>
<td class="org-left">Ti</td>
<td class="org-right">4966</td>
<td class="org-right">560.9</td>
<td class="org-right">460.2</td>
<td class="org-right">453.8</td>
<td class="org-right">58.7</td>
<td class="org-right">32.6</td>
<td class="org-right">32.6</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">25</td>
<td class="org-left">Mn</td>
<td class="org-right">6539</td>
<td class="org-right">769.1</td>
<td class="org-right">649.9</td>
<td class="org-right">638.7</td>
<td class="org-right">82.3</td>
<td class="org-right">47.2</td>
<td class="org-right">47.2</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">26</td>
<td class="org-left">Fe</td>
<td class="org-right">7112</td>
<td class="org-right">844.6</td>
<td class="org-right">719.9</td>
<td class="org-right">706.8</td>
<td class="org-right">91.3</td>
<td class="org-right">52.7</td>
<td class="org-right">52.7</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">28</td>
<td class="org-left">Ni</td>
<td class="org-right">8333</td>
<td class="org-right">1008.6</td>
<td class="org-right">870.0</td>
<td class="org-right">852.7</td>
<td class="org-right">110.8</td>
<td class="org-right">68.0</td>
<td class="org-right">66.2</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">29</td>
<td class="org-left">Cu</td>
<td class="org-right">8979</td>
<td class="org-right">1096.7</td>
<td class="org-right">952.3</td>
<td class="org-right">932.7</td>
<td class="org-right">122.5</td>
<td class="org-right">77.3</td>
<td class="org-right">75.1</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">47</td>
<td class="org-left">Ag</td>
<td class="org-right">25514</td>
<td class="org-right">3806</td>
<td class="org-right">3524</td>
<td class="org-right">3351</td>
<td class="org-right">719.0</td>
<td class="org-right">603.8</td>
<td class="org-right">573.0</td>
<td class="org-left">374.0</td>
<td class="org-left">368.3</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">54</td>
<td class="org-left">Xe</td>
<td class="org-right">34561</td>
<td class="org-right">5453</td>
<td class="org-right">5107</td>
<td class="org-right">4786</td>
<td class="org-right">1148.7</td>
<td class="org-right">1002.1</td>
<td class="org-right">940.6</td>
<td class="org-left">689.0</td>
<td class="org-left">676.4</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">78</td>
<td class="org-left">Pt</td>
<td class="org-right">78395</td>
<td class="org-right">13880</td>
<td class="org-right">13273</td>
<td class="org-right">11564</td>
<td class="org-right">3296</td>
<td class="org-right">3027</td>
<td class="org-right">2645</td>
<td class="org-left">2202</td>
<td class="org-left">2122</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">79</td>
<td class="org-left">Au</td>
<td class="org-right">80725</td>
<td class="org-right">14353</td>
<td class="org-right">13734</td>
<td class="org-right">11919</td>
<td class="org-right">3425</td>
<td class="org-right">3148</td>
<td class="org-right">2743</td>
<td class="org-left">2291</td>
<td class="org-left">2206</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">82</td>
<td class="org-left">Pb</td>
<td class="org-right">88005</td>
<td class="org-right">15861</td>
<td class="org-right">15200</td>
<td class="org-right">13035</td>
<td class="org-right">3851</td>
<td class="org-right">3554</td>
<td class="org-right">3066</td>
<td class="org-left">2586</td>
<td class="org-left">2484</td>
<td class="org-left">891.8</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">Z</td>
<td class="org-left">Element</td>
<td class="org-right">N1 4s</td>
<td class="org-right">N2 4p1/2</td>
<td class="org-right">N3 4p3/2</td>
<td class="org-right">N4 4d3/2</td>
<td class="org-right">N5 4d5/2</td>
<td class="org-right">N6 4f5/2</td>
<td class="org-right">N7 4f7/2</td>
<td class="org-left">O1 5s</td>
<td class="org-left">O2 5p1/2</td>
<td class="org-left">O3 5p3/2</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">47</td>
<td class="org-left">Ag</td>
<td class="org-right">97.0</td>
<td class="org-right">63.7</td>
<td class="org-right">58.3</td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">54</td>
<td class="org-left">Xe</td>
<td class="org-right">213.2</td>
<td class="org-right">146.7</td>
<td class="org-right">145.5</td>
<td class="org-right">69.5</td>
<td class="org-right">67.5</td>
<td class="org-right">---</td>
<td class="org-right">---</td>
<td class="org-left">23.3</td>
<td class="org-left">13.4</td>
<td class="org-left">12.1</td>
</tr>

<tr>
<td class="org-right">78</td>
<td class="org-left">Pt</td>
<td class="org-right">725.4</td>
<td class="org-right">609.1</td>
<td class="org-right">519.4</td>
<td class="org-right">331.6</td>
<td class="org-right">314.6</td>
<td class="org-right">74.5</td>
<td class="org-right">71.2</td>
<td class="org-left">101.7</td>
<td class="org-left">65.3</td>
<td class="org-left">51.7</td>
</tr>

<tr>
<td class="org-right">79</td>
<td class="org-left">Au</td>
<td class="org-right">762.1</td>
<td class="org-right">642.7</td>
<td class="org-right">546.3</td>
<td class="org-right">353.2</td>
<td class="org-right">335.1</td>
<td class="org-right">87.6</td>
<td class="org-right">84.0</td>
<td class="org-left">107.2</td>
<td class="org-left">74.2</td>
<td class="org-left">57.2</td>
</tr>

<tr>
<td class="org-right">82</td>
<td class="org-left">Pb</td>
<td class="org-right">761.9</td>
<td class="org-right">643.5</td>
<td class="org-right">434.3</td>
<td class="org-right">412.2</td>
<td class="org-right">141.7</td>
<td class="org-right">136.9</td>
<td class="org-right">147</td>
<td class="org-left">106.4</td>
<td class="org-left">83.3</td>
<td class="org-left">20.7</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-orgf0d158f" class="outline-5">
<h5 id="orgf0d158f"><span class="section-number-5">6.1.4.1.</span> Full tables for X-ray fluorescence lines and binding energies   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-6-1-4-1" class="outline-text-5">
<table id="tab_all_xray_fluorescence">
<caption class="t-above"><span class="table-number">Table 3:</span> Photon energies of K, L and M emission lines for different elements in \si{eV}. Taken from <a href="cite:williams2001x">cite:williams2001x</a>, specifically <a href="https://xdb.lbl.gov/Section1/Table_1-2.pdf">https://xdb.lbl.gov/Section1/Table_1-2.pdf</a>.</caption>

<colgroup>
<col class="org-right" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Z</th>
<th scope="col" class="org-left">Element</th>
<th scope="col" class="org-left">Kα1</th>
<th scope="col" class="org-left">Kα2</th>
<th scope="col" class="org-left">Kβ1</th>
<th scope="col" class="org-left">Lα1</th>
<th scope="col" class="org-left">Lα2</th>
<th scope="col" class="org-left">Lβ1</th>
<th scope="col" class="org-left">Lβ2</th>
<th scope="col" class="org-left">Lγ1</th>
<th scope="col" class="org-left">Mα1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">3</td>
<td class="org-left">Li</td>
<td class="org-left">54.3</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">Be</td>
<td class="org-left">108.5</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">B</td>
<td class="org-left">183.3</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">C</td>
<td class="org-left">277</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">N</td>
<td class="org-left">392.4</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">O</td>
<td class="org-left">524.9</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">F</td>
<td class="org-left">676.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">Ne</td>
<td class="org-left">848.6</td>
<td class="org-left">848.6</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">Na</td>
<td class="org-left">1,040.98</td>
<td class="org-left">1,040.98</td>
<td class="org-left">1,071.1</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">Mg</td>
<td class="org-left">1,253.60</td>
<td class="org-left">1,253.60</td>
<td class="org-left">1,302.2</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">Al</td>
<td class="org-left">1,486.70</td>
<td class="org-left">1,486.27</td>
<td class="org-left">1,557.45</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">Si</td>
<td class="org-left">1,739.98</td>
<td class="org-left">1,739.38</td>
<td class="org-left">1,835.94</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">P</td>
<td class="org-left">2,013.7</td>
<td class="org-left">2,012.7</td>
<td class="org-left">2,139.1</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">16</td>
<td class="org-left">S</td>
<td class="org-left">2,307.84</td>
<td class="org-left">2,306.64</td>
<td class="org-left">2,464.04</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">17</td>
<td class="org-left">Cl</td>
<td class="org-left">2,622.39</td>
<td class="org-left">2,620.78</td>
<td class="org-left">2,815.6</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">18</td>
<td class="org-left">Ar</td>
<td class="org-left">2,957.70</td>
<td class="org-left">2,955.63</td>
<td class="org-left">3,190.5</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">19</td>
<td class="org-left">K</td>
<td class="org-left">3,313.8</td>
<td class="org-left">3,311.1</td>
<td class="org-left">3,589.6</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">20</td>
<td class="org-left">Ca</td>
<td class="org-left">3,691.68</td>
<td class="org-left">3,688.09</td>
<td class="org-left">4,012.7</td>
<td class="org-left">341.3</td>
<td class="org-left">341.3</td>
<td class="org-left">344.9</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">Sc</td>
<td class="org-left">4,090.6</td>
<td class="org-left">4,086.1</td>
<td class="org-left">4,460.5</td>
<td class="org-left">395.4</td>
<td class="org-left">395.4</td>
<td class="org-left">399.6</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">Z</td>
<td class="org-left">Element</td>
<td class="org-left">Kα1</td>
<td class="org-left">Kα2</td>
<td class="org-left">Kβ1</td>
<td class="org-left">Lα1</td>
<td class="org-left">Lα2</td>
<td class="org-left">Lβ1</td>
<td class="org-left">Lβ2</td>
<td class="org-left">Lγ1</td>
<td class="org-left">Mα1</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">22</td>
<td class="org-left">Ti</td>
<td class="org-left">4,510.84</td>
<td class="org-left">4,504.86</td>
<td class="org-left">4,931.81</td>
<td class="org-left">452.2</td>
<td class="org-left">452.2</td>
<td class="org-left">458.4</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">23</td>
<td class="org-left">V</td>
<td class="org-left">4,952.20</td>
<td class="org-left">4,944.64</td>
<td class="org-left">5,427.29</td>
<td class="org-left">511.3</td>
<td class="org-left">511.3</td>
<td class="org-left">519.2</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">24</td>
<td class="org-left">Cr</td>
<td class="org-left">5,414.72</td>
<td class="org-left">5,405.509</td>
<td class="org-left">5,946.71</td>
<td class="org-left">572.8</td>
<td class="org-left">572.8</td>
<td class="org-left">582.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">25</td>
<td class="org-left">Mn</td>
<td class="org-left">5,898.75</td>
<td class="org-left">5,887.65</td>
<td class="org-left">6,490.45</td>
<td class="org-left">637.4</td>
<td class="org-left">637.4</td>
<td class="org-left">648.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">26</td>
<td class="org-left">Fe</td>
<td class="org-left">6,403.84</td>
<td class="org-left">6,390.84</td>
<td class="org-left">7,057.98</td>
<td class="org-left">705.0</td>
<td class="org-left">705.0</td>
<td class="org-left">718.5</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">27</td>
<td class="org-left">Co</td>
<td class="org-left">6,930.32</td>
<td class="org-left">6,915.30</td>
<td class="org-left">7,649.43</td>
<td class="org-left">776.2</td>
<td class="org-left">776.2</td>
<td class="org-left">791.4</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">28</td>
<td class="org-left">Ni</td>
<td class="org-left">7,478.15</td>
<td class="org-left">7,460.89</td>
<td class="org-left">8,264.66</td>
<td class="org-left">851.5</td>
<td class="org-left">851.5</td>
<td class="org-left">868.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">29</td>
<td class="org-left">Cu</td>
<td class="org-left">8,047.78</td>
<td class="org-left">8,027.83</td>
<td class="org-left">8,905.29</td>
<td class="org-left">929.7</td>
<td class="org-left">929.7</td>
<td class="org-left">949.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">30</td>
<td class="org-left">Zn</td>
<td class="org-left">8,638.86</td>
<td class="org-left">8,615.78</td>
<td class="org-left">9,572.0</td>
<td class="org-left">1,011.7</td>
<td class="org-left">1,011.7</td>
<td class="org-left">1,034.7</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">31</td>
<td class="org-left">Ga</td>
<td class="org-left">9,251.74</td>
<td class="org-left">9,224.82</td>
<td class="org-left">10,264.2</td>
<td class="org-left">1,097.92</td>
<td class="org-left">1,097.92</td>
<td class="org-left">1,124.8</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">32</td>
<td class="org-left">Ge</td>
<td class="org-left">9,886.42</td>
<td class="org-left">9,855.32</td>
<td class="org-left">10,982.1</td>
<td class="org-left">1,188.00</td>
<td class="org-left">1,188.00</td>
<td class="org-left">1,218.5</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">33</td>
<td class="org-left">As</td>
<td class="org-left">10,543.72</td>
<td class="org-left">10,507.99</td>
<td class="org-left">11,726.2</td>
<td class="org-left">1,282.0</td>
<td class="org-left">1,282.0</td>
<td class="org-left">1,317.0</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">34</td>
<td class="org-left">Se</td>
<td class="org-left">11,222.4</td>
<td class="org-left">11,181.4</td>
<td class="org-left">12,495.9</td>
<td class="org-left">1,379.10</td>
<td class="org-left">1,379.10</td>
<td class="org-left">1,419.23</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">35</td>
<td class="org-left">Br</td>
<td class="org-left">11,924.2</td>
<td class="org-left">11,877.6</td>
<td class="org-left">13,291.4</td>
<td class="org-left">1,480.43</td>
<td class="org-left">1,480.43</td>
<td class="org-left">1,525.90</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">36</td>
<td class="org-left">Kr</td>
<td class="org-left">12,649</td>
<td class="org-left">12,598</td>
<td class="org-left">14,112</td>
<td class="org-left">1,586.0</td>
<td class="org-left">1,586.0</td>
<td class="org-left">1,636.6</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">37</td>
<td class="org-left">Rb</td>
<td class="org-left">13,395.3</td>
<td class="org-left">13,335.8</td>
<td class="org-left">14,961.3</td>
<td class="org-left">1,694.13</td>
<td class="org-left">1,692.56</td>
<td class="org-left">1,752.17</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">38</td>
<td class="org-left">Sr</td>
<td class="org-left">14,165</td>
<td class="org-left">14,097.9</td>
<td class="org-left">15,835.7</td>
<td class="org-left">1,806.56</td>
<td class="org-left">1,804.74</td>
<td class="org-left">1,871.72</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">39</td>
<td class="org-left">Y</td>
<td class="org-left">14,958.4</td>
<td class="org-left">14,882.9</td>
<td class="org-left">16,737.8</td>
<td class="org-left">1,922.56</td>
<td class="org-left">1,920.47</td>
<td class="org-left">1,995.84</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">40</td>
<td class="org-left">Zr</td>
<td class="org-left">15,775.1</td>
<td class="org-left">15,690.9</td>
<td class="org-left">17,667.8</td>
<td class="org-left">2,042.36</td>
<td class="org-left">2,039.9</td>
<td class="org-left">2,124.4</td>
<td class="org-left">2,219.4</td>
<td class="org-left">2,302.7</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">41</td>
<td class="org-left">Nb</td>
<td class="org-left">16,615.1</td>
<td class="org-left">16,521.0</td>
<td class="org-left">18,622.5</td>
<td class="org-left">2,165.89</td>
<td class="org-left">2,163.0</td>
<td class="org-left">2,257.4</td>
<td class="org-left">2,367.0</td>
<td class="org-left">2,461.8</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">42</td>
<td class="org-left">Mo</td>
<td class="org-left">17,479.34</td>
<td class="org-left">17,374.3</td>
<td class="org-left">19,608.3</td>
<td class="org-left">2,293.16</td>
<td class="org-left">2,289.85</td>
<td class="org-left">2,394.81</td>
<td class="org-left">2,518.3</td>
<td class="org-left">2,623.5</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">43</td>
<td class="org-left">Tc</td>
<td class="org-left">18,367.1</td>
<td class="org-left">18,250.8</td>
<td class="org-left">20,619</td>
<td class="org-left">2,424</td>
<td class="org-left">2,420</td>
<td class="org-left">2,538</td>
<td class="org-left">2,674</td>
<td class="org-left">2,792</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">44</td>
<td class="org-left">Ru</td>
<td class="org-left">19,279.2</td>
<td class="org-left">19,150.4</td>
<td class="org-left">21,656.8</td>
<td class="org-left">2,558.55</td>
<td class="org-left">2,554.31</td>
<td class="org-left">2,683.23</td>
<td class="org-left">2,836.0</td>
<td class="org-left">2,964.5</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">45</td>
<td class="org-left">Rh</td>
<td class="org-left">20,216.1</td>
<td class="org-left">20,073.7</td>
<td class="org-left">22,723.6</td>
<td class="org-left">2,696.74</td>
<td class="org-left">2,692.05</td>
<td class="org-left">2,834.41</td>
<td class="org-left">3,001.3</td>
<td class="org-left">3,143.8</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">46</td>
<td class="org-left">Pd</td>
<td class="org-left">21,177.1</td>
<td class="org-left">21,020.1</td>
<td class="org-left">23,818.7</td>
<td class="org-left">2,838.61</td>
<td class="org-left">2,833.29</td>
<td class="org-left">2,990.22</td>
<td class="org-left">3,171.79</td>
<td class="org-left">3,328.7</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">47</td>
<td class="org-left">Ag</td>
<td class="org-left">22,162.92</td>
<td class="org-left">21,990.3</td>
<td class="org-left">24,942.4</td>
<td class="org-left">2,984.31</td>
<td class="org-left">2,978.21</td>
<td class="org-left">3,150.94</td>
<td class="org-left">3,347.81</td>
<td class="org-left">3,519.59</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">48</td>
<td class="org-left">Cd</td>
<td class="org-left">23,173.6</td>
<td class="org-left">22,984.1</td>
<td class="org-left">26,095.5</td>
<td class="org-left">3,133.73</td>
<td class="org-left">3,126.91</td>
<td class="org-left">3,316.57</td>
<td class="org-left">3,528.12</td>
<td class="org-left">3,716.86</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">49</td>
<td class="org-left">In</td>
<td class="org-left">24,209.7</td>
<td class="org-left">24,002.0</td>
<td class="org-left">27,275.9</td>
<td class="org-left">3,286.94</td>
<td class="org-left">3,279.29</td>
<td class="org-left">3,487.21</td>
<td class="org-left">3,713.81</td>
<td class="org-left">3,920.81</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">50</td>
<td class="org-left">Sn</td>
<td class="org-left">25,271.3</td>
<td class="org-left">25,044.0</td>
<td class="org-left">28,486.0</td>
<td class="org-left">3,443.98</td>
<td class="org-left">3,435.42</td>
<td class="org-left">3,662.80</td>
<td class="org-left">3,904.86</td>
<td class="org-left">4,131.12</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">51</td>
<td class="org-left">Sb</td>
<td class="org-left">26,359.1</td>
<td class="org-left">26,110.8</td>
<td class="org-left">29,725.6</td>
<td class="org-left">3,604.72</td>
<td class="org-left">3,595.32</td>
<td class="org-left">3,843.57</td>
<td class="org-left">4,100.78</td>
<td class="org-left">4,347.79</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">52</td>
<td class="org-left">Te</td>
<td class="org-left">27,472.3</td>
<td class="org-left">27,201.7</td>
<td class="org-left">30,995.7</td>
<td class="org-left">3,769.33</td>
<td class="org-left">3,758.8</td>
<td class="org-left">4,029.58</td>
<td class="org-left">4,301.7</td>
<td class="org-left">4,570.9</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">53</td>
<td class="org-left">I</td>
<td class="org-left">28,612.0</td>
<td class="org-left">28,317.2</td>
<td class="org-left">32,294.7</td>
<td class="org-left">3,937.65</td>
<td class="org-left">3,926.04</td>
<td class="org-left">4,220.72</td>
<td class="org-left">4,507.5</td>
<td class="org-left">4,800.9</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">54</td>
<td class="org-left">Xe</td>
<td class="org-left">29,779</td>
<td class="org-left">29,458</td>
<td class="org-left">33,624</td>
<td class="org-left">4,109.9</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">55</td>
<td class="org-left">Cs</td>
<td class="org-left">30,972.8</td>
<td class="org-left">30,625.1</td>
<td class="org-left">34,986.9</td>
<td class="org-left">4,286.5</td>
<td class="org-left">4,272.2</td>
<td class="org-left">4,619.8</td>
<td class="org-left">4,935.9</td>
<td class="org-left">5,280.4</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">56</td>
<td class="org-left">Ba</td>
<td class="org-left">32,193.6</td>
<td class="org-left">31,817.1</td>
<td class="org-left">36,378.2</td>
<td class="org-left">4,466.26</td>
<td class="org-left">4,450.90</td>
<td class="org-left">4,827.53</td>
<td class="org-left">5,156.5</td>
<td class="org-left">5,531.1</td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">57</td>
<td class="org-left">La</td>
<td class="org-left">33,441.8</td>
<td class="org-left">33,034.1</td>
<td class="org-left">37,801.0</td>
<td class="org-left">4,650.97</td>
<td class="org-left">4,634.23</td>
<td class="org-left">5,042.1</td>
<td class="org-left">5,383.5</td>
<td class="org-left">5,788.5</td>
<td class="org-left">833</td>
</tr>

<tr>
<td class="org-right">58</td>
<td class="org-left">Ce</td>
<td class="org-left">34,719.7</td>
<td class="org-left">34,278.9</td>
<td class="org-left">39,257.3</td>
<td class="org-left">4,840.2</td>
<td class="org-left">4,823.0</td>
<td class="org-left">5,262.2</td>
<td class="org-left">5,613.4</td>
<td class="org-left">6,052</td>
<td class="org-left">883</td>
</tr>

<tr>
<td class="org-right">59</td>
<td class="org-left">Pr</td>
<td class="org-left">36,026.3</td>
<td class="org-left">35,550.2</td>
<td class="org-left">40,748.2</td>
<td class="org-left">5,033.7</td>
<td class="org-left">5,013.5</td>
<td class="org-left">5,488.9</td>
<td class="org-left">5,850</td>
<td class="org-left">6,322.1</td>
<td class="org-left">929</td>
</tr>

<tr>
<td class="org-right">60</td>
<td class="org-left">Nd</td>
<td class="org-left">37,361.0</td>
<td class="org-left">36,847.4</td>
<td class="org-left">42,271.3</td>
<td class="org-left">5,230.4</td>
<td class="org-left">5,207.7</td>
<td class="org-left">5,721.6</td>
<td class="org-left">6,089.4</td>
<td class="org-left">6,602.1</td>
<td class="org-left">978</td>
</tr>

<tr>
<td class="org-right">61</td>
<td class="org-left">Pm</td>
<td class="org-left">38,724.7</td>
<td class="org-left">38,171.2</td>
<td class="org-left">43,826</td>
<td class="org-left">5,432.5</td>
<td class="org-left">5,407.8</td>
<td class="org-left">5,961</td>
<td class="org-left">6,339</td>
<td class="org-left">6,892</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">62</td>
<td class="org-left">Sm</td>
<td class="org-left">40,118.1</td>
<td class="org-left">39,522.4</td>
<td class="org-left">45,413</td>
<td class="org-left">5,636.1</td>
<td class="org-left">5,609.0</td>
<td class="org-left">6,205.1</td>
<td class="org-left">6,586</td>
<td class="org-left">7,178</td>
<td class="org-left">1,081</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">Z</td>
<td class="org-left">Element</td>
<td class="org-left">Kα1</td>
<td class="org-left">Kα2</td>
<td class="org-left">Kβ1</td>
<td class="org-left">Lα1</td>
<td class="org-left">Lα2</td>
<td class="org-left">Lβ1</td>
<td class="org-left">Lβ2</td>
<td class="org-left">Lγ1</td>
<td class="org-left">Mα1</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">63</td>
<td class="org-left">Eu</td>
<td class="org-left">41,542.2</td>
<td class="org-left">40,901.9</td>
<td class="org-left">47,037.9</td>
<td class="org-left">5,845.7</td>
<td class="org-left">5,816.6</td>
<td class="org-left">6,456.4</td>
<td class="org-left">6,843.2</td>
<td class="org-left">7,480.3</td>
<td class="org-left">1,131</td>
</tr>

<tr>
<td class="org-right">64</td>
<td class="org-left">Gd</td>
<td class="org-left">42,996.2</td>
<td class="org-left">42,308.9</td>
<td class="org-left">48,697</td>
<td class="org-left">6,057.2</td>
<td class="org-left">6,025.0</td>
<td class="org-left">6,713.2</td>
<td class="org-left">7,102.8</td>
<td class="org-left">7,785.8</td>
<td class="org-left">1,185</td>
</tr>

<tr>
<td class="org-right">65</td>
<td class="org-left">Tb</td>
<td class="org-left">44,481.6</td>
<td class="org-left">43,744.1</td>
<td class="org-left">50,382</td>
<td class="org-left">6,272.8</td>
<td class="org-left">6,238.0</td>
<td class="org-left">6,978</td>
<td class="org-left">7,366.7</td>
<td class="org-left">8,102</td>
<td class="org-left">1,240</td>
</tr>

<tr>
<td class="org-right">66</td>
<td class="org-left">Dy</td>
<td class="org-left">45,998.4</td>
<td class="org-left">45,207.8</td>
<td class="org-left">52,119</td>
<td class="org-left">6,495.2</td>
<td class="org-left">6,457.7</td>
<td class="org-left">7,247.7</td>
<td class="org-left">7,635.7</td>
<td class="org-left">8,418.8</td>
<td class="org-left">1,293</td>
</tr>

<tr>
<td class="org-right">67</td>
<td class="org-left">Ho</td>
<td class="org-left">47,546.7</td>
<td class="org-left">46,699.7</td>
<td class="org-left">53,877</td>
<td class="org-left">6,719.8</td>
<td class="org-left">6,679.5</td>
<td class="org-left">7,525.3</td>
<td class="org-left">7,911</td>
<td class="org-left">8,747</td>
<td class="org-left">1,348</td>
</tr>

<tr>
<td class="org-right">68</td>
<td class="org-left">Er</td>
<td class="org-left">49,127.7</td>
<td class="org-left">48,221.1</td>
<td class="org-left">55,681</td>
<td class="org-left">6,948.7</td>
<td class="org-left">6,905.0</td>
<td class="org-left">7,810.9</td>
<td class="org-left">8,189.0</td>
<td class="org-left">9,089</td>
<td class="org-left">1,406</td>
</tr>

<tr>
<td class="org-right">69</td>
<td class="org-left">Tm</td>
<td class="org-left">50,741.6</td>
<td class="org-left">49,772.6</td>
<td class="org-left">57,517</td>
<td class="org-left">7,179.9</td>
<td class="org-left">7,133.1</td>
<td class="org-left">8,101</td>
<td class="org-left">8,468</td>
<td class="org-left">9,426</td>
<td class="org-left">1,462</td>
</tr>

<tr>
<td class="org-right">70</td>
<td class="org-left">Yb</td>
<td class="org-left">52,388.9</td>
<td class="org-left">51,354.0</td>
<td class="org-left">59,370</td>
<td class="org-left">7,415.6</td>
<td class="org-left">7,367.3</td>
<td class="org-left">8,401.8</td>
<td class="org-left">8,758.8</td>
<td class="org-left">9,780.1</td>
<td class="org-left">1,521.4</td>
</tr>

<tr>
<td class="org-right">71</td>
<td class="org-left">Lu</td>
<td class="org-left">54,069.8</td>
<td class="org-left">52,965.0</td>
<td class="org-left">61,283</td>
<td class="org-left">7,655.5</td>
<td class="org-left">7,604.9</td>
<td class="org-left">8,709.0</td>
<td class="org-left">9,048.9</td>
<td class="org-left">10,143.4</td>
<td class="org-left">1,581.3</td>
</tr>

<tr>
<td class="org-right">72</td>
<td class="org-left">Hf</td>
<td class="org-left">55,790.2</td>
<td class="org-left">54,611.4</td>
<td class="org-left">63,234</td>
<td class="org-left">7,899.0</td>
<td class="org-left">7,844.6</td>
<td class="org-left">9,022.7</td>
<td class="org-left">9,347.3</td>
<td class="org-left">10,515.8</td>
<td class="org-left">1,644.6</td>
</tr>

<tr>
<td class="org-right">73</td>
<td class="org-left">Ta</td>
<td class="org-left">57,532</td>
<td class="org-left">56,277</td>
<td class="org-left">65,223</td>
<td class="org-left">8,146.1</td>
<td class="org-left">8,087.9</td>
<td class="org-left">9,343.1</td>
<td class="org-left">9,651.8</td>
<td class="org-left">10,895.2</td>
<td class="org-left">1,710</td>
</tr>

<tr>
<td class="org-right">74</td>
<td class="org-left">W</td>
<td class="org-left">59,318.24</td>
<td class="org-left">57,981.7</td>
<td class="org-left">67,244.3</td>
<td class="org-left">8,397.6</td>
<td class="org-left">8,335.2</td>
<td class="org-left">9,672.35</td>
<td class="org-left">9,961.5</td>
<td class="org-left">11,285.9</td>
<td class="org-left">1,775.4</td>
</tr>

<tr>
<td class="org-right">75</td>
<td class="org-left">Re</td>
<td class="org-left">61,140.3</td>
<td class="org-left">59,717.9</td>
<td class="org-left">69,310</td>
<td class="org-left">8,652.5</td>
<td class="org-left">8,586.2</td>
<td class="org-left">10,010.0</td>
<td class="org-left">10,275.2</td>
<td class="org-left">11,685.4</td>
<td class="org-left">1,842.5</td>
</tr>

<tr>
<td class="org-right">76</td>
<td class="org-left">Os</td>
<td class="org-left">63,000.5</td>
<td class="org-left">61,486.7</td>
<td class="org-left">71,413</td>
<td class="org-left">8,911.7</td>
<td class="org-left">8,841.0</td>
<td class="org-left">10,355.3</td>
<td class="org-left">10,598.5</td>
<td class="org-left">12,095.3</td>
<td class="org-left">1,910.2</td>
</tr>

<tr>
<td class="org-right">77</td>
<td class="org-left">Ir</td>
<td class="org-left">64,895.6</td>
<td class="org-left">63,286.7</td>
<td class="org-left">73,560.8</td>
<td class="org-left">9,175.1</td>
<td class="org-left">9,099.5</td>
<td class="org-left">10,708.3</td>
<td class="org-left">10,920.3</td>
<td class="org-left">12,512.6</td>
<td class="org-left">1,979.9</td>
</tr>

<tr>
<td class="org-right">78</td>
<td class="org-left">Pt</td>
<td class="org-left">66,832</td>
<td class="org-left">65,112</td>
<td class="org-left">75,748</td>
<td class="org-left">9,442.3</td>
<td class="org-left">9,361.8</td>
<td class="org-left">11,070.7</td>
<td class="org-left">11,250.5</td>
<td class="org-left">12,942.0</td>
<td class="org-left">2,050.5</td>
</tr>

<tr>
<td class="org-right">79</td>
<td class="org-left">Au</td>
<td class="org-left">68,803.7</td>
<td class="org-left">66,989.5</td>
<td class="org-left">77,984</td>
<td class="org-left">9,713.3</td>
<td class="org-left">9,628.0</td>
<td class="org-left">11,442.3</td>
<td class="org-left">11,584.7</td>
<td class="org-left">13,381.7</td>
<td class="org-left">2,122.9</td>
</tr>

<tr>
<td class="org-right">80</td>
<td class="org-left">Hg</td>
<td class="org-left">70,819</td>
<td class="org-left">68,895</td>
<td class="org-left">80,253</td>
<td class="org-left">9,988.8</td>
<td class="org-left">9,897.6</td>
<td class="org-left">11,822.6</td>
<td class="org-left">11,924.1</td>
<td class="org-left">13,830.1</td>
<td class="org-left">2,195.3</td>
</tr>

<tr>
<td class="org-right">81</td>
<td class="org-left">Tl</td>
<td class="org-left">72,871.5</td>
<td class="org-left">70,831.9</td>
<td class="org-left">82,576</td>
<td class="org-left">10,268.5</td>
<td class="org-left">10,172.8</td>
<td class="org-left">12,213.3</td>
<td class="org-left">12,271.5</td>
<td class="org-left">14,291.5</td>
<td class="org-left">2,270.6</td>
</tr>

<tr>
<td class="org-right">82</td>
<td class="org-left">Pb</td>
<td class="org-left">74,969.4</td>
<td class="org-left">72,804.2</td>
<td class="org-left">84,936</td>
<td class="org-left">10,551.5</td>
<td class="org-left">10,449.5</td>
<td class="org-left">12,613.7</td>
<td class="org-left">12,622.6</td>
<td class="org-left">14,764.4</td>
<td class="org-left">2,345.5</td>
</tr>

<tr>
<td class="org-right">83</td>
<td class="org-left">Bi</td>
<td class="org-left">77,107.9</td>
<td class="org-left">74,814.8</td>
<td class="org-left">87,343</td>
<td class="org-left">10,838.8</td>
<td class="org-left">10,730.91</td>
<td class="org-left">13,023.5</td>
<td class="org-left">12,979.9</td>
<td class="org-left">15,247.7</td>
<td class="org-left">2,422.6</td>
</tr>

<tr>
<td class="org-right">84</td>
<td class="org-left">Po</td>
<td class="org-left">79,290</td>
<td class="org-left">76,862</td>
<td class="org-left">89,800</td>
<td class="org-left">11,130.8</td>
<td class="org-left">11,015.8</td>
<td class="org-left">13,447</td>
<td class="org-left">13,340.4</td>
<td class="org-left">15,744</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">85</td>
<td class="org-left">At</td>
<td class="org-left">81,520</td>
<td class="org-left">78,950</td>
<td class="org-left">92,300</td>
<td class="org-left">11,426.8</td>
<td class="org-left">11,304.8</td>
<td class="org-left">13,876</td>
<td class="org-left">—</td>
<td class="org-left">16,251</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">86</td>
<td class="org-left">Rn</td>
<td class="org-left">83,780</td>
<td class="org-left">81,070</td>
<td class="org-left">94,870</td>
<td class="org-left">11,727.0</td>
<td class="org-left">11,597.9</td>
<td class="org-left">14,316</td>
<td class="org-left">—</td>
<td class="org-left">16,770</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">87</td>
<td class="org-left">Fr</td>
<td class="org-left">86,100</td>
<td class="org-left">83,230</td>
<td class="org-left">97,470</td>
<td class="org-left">12,031.3</td>
<td class="org-left">11,895.0</td>
<td class="org-left">14,770</td>
<td class="org-left">14,450</td>
<td class="org-left">17,303</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">88</td>
<td class="org-left">Ra</td>
<td class="org-left">88,470</td>
<td class="org-left">85,430</td>
<td class="org-left">100,130</td>
<td class="org-left">12,339.7</td>
<td class="org-left">12,196.2</td>
<td class="org-left">15,235.8</td>
<td class="org-left">14,841.4</td>
<td class="org-left">17,849</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">89</td>
<td class="org-left">Ac</td>
<td class="org-left">90,884</td>
<td class="org-left">87,670</td>
<td class="org-left">102,850</td>
<td class="org-left">12,652.0</td>
<td class="org-left">12,500.8</td>
<td class="org-left">15,713</td>
<td class="org-left">—</td>
<td class="org-left">18,408</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">90</td>
<td class="org-left">Th</td>
<td class="org-left">93,350</td>
<td class="org-left">89,953</td>
<td class="org-left">105,609</td>
<td class="org-left">12,968.7</td>
<td class="org-left">12,809.6</td>
<td class="org-left">16,202.2</td>
<td class="org-left">15,623.7</td>
<td class="org-left">18,982.5</td>
<td class="org-left">2,996.1</td>
</tr>

<tr>
<td class="org-right">91</td>
<td class="org-left">Pa</td>
<td class="org-left">95,868</td>
<td class="org-left">92,287</td>
<td class="org-left">108,427</td>
<td class="org-left">13,290.7</td>
<td class="org-left">13,122.2</td>
<td class="org-left">16,702</td>
<td class="org-left">16,024</td>
<td class="org-left">19,568</td>
<td class="org-left">3,082.3</td>
</tr>

<tr>
<td class="org-right">92</td>
<td class="org-left">U</td>
<td class="org-left">98,439</td>
<td class="org-left">94,665</td>
<td class="org-left">111,300</td>
<td class="org-left">13,614.7</td>
<td class="org-left">13,438.8</td>
<td class="org-left">17,220.0</td>
<td class="org-left">16,428.3</td>
<td class="org-left">20,167.1</td>
<td class="org-left">3,170.8</td>
</tr>

<tr>
<td class="org-right">93</td>
<td class="org-left">Np</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">13,944.1</td>
<td class="org-left">13,759.7</td>
<td class="org-left">17,750.2</td>
<td class="org-left">16,840.0</td>
<td class="org-left">20,784.8</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">94</td>
<td class="org-left">Pu</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">14,278.6</td>
<td class="org-left">14,084.2</td>
<td class="org-left">18,293.7</td>
<td class="org-left">17,255.3</td>
<td class="org-left">21,417.3</td>
<td class="org-left">—</td>
</tr>

<tr>
<td class="org-right">95</td>
<td class="org-left">Am</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">—</td>
<td class="org-left">14,617.2</td>
<td class="org-left">14,411.9</td>
<td class="org-left">18,852.0</td>
<td class="org-left">17,676.5</td>
<td class="org-left">22,065.2</td>
<td class="org-left">—</td>
</tr>
</tbody>
</table>

<p>
X-Ray Data Booklet Table 1-1. Electron binding energies, in electron
volts, for the elements in their natural forms.  
<a href="https://xdb.lbl.gov/Section1/Table_1-1.pdf">https://xdb.lbl.gov/Section1/Table_1-1.pdf</a>
</p>

<table id="tab_all_atomic_binding_energies">
<caption class="t-above"><span class="table-number">Table 4:</span> Electron binding energies of all elements up to uranium in \si{eV}. Taken from the X-ray data book <a href="cite:williams2001x">cite:williams2001x</a>, specifically <a href="https://xdb.lbl.gov/Section1/Table_1-1.pdf">https://xdb.lbl.gov/Section1/Table_1-1.pdf</a>.</caption>

<colgroup>
<col class="org-right" />

<col class="org-left" />

<col class="org-right" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />

<col class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Z</th>
<th scope="col" class="org-left">Element</th>
<th scope="col" class="org-right">K 1s</th>
<th scope="col" class="org-left">L1 2s</th>
<th scope="col" class="org-left">L2 2p1/2</th>
<th scope="col" class="org-left">L3 2p3/2</th>
<th scope="col" class="org-left">M1 3s</th>
<th scope="col" class="org-left">M2 3p1/2</th>
<th scope="col" class="org-left">M3 3p3/2</th>
<th scope="col" class="org-left">M4 3d3/2</th>
<th scope="col" class="org-left">M5 3d5/2</th>
<th scope="col" class="org-left">N1 4s</th>
<th scope="col" class="org-left">N2 4p1/2</th>
<th scope="col" class="org-left">N3 4p3/2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">H</td>
<td class="org-right">13.6</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">He</td>
<td class="org-right">24.6*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">Li</td>
<td class="org-right">54.7*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">Be</td>
<td class="org-right">111.5*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">B</td>
<td class="org-right">188*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">C</td>
<td class="org-right">284.2*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">N</td>
<td class="org-right">409.9*</td>
<td class="org-left">37.3*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">O</td>
<td class="org-right">543.1*</td>
<td class="org-left">41.6*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">F</td>
<td class="org-right">696.7*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">Ne</td>
<td class="org-right">870.2*</td>
<td class="org-left">48.5*</td>
<td class="org-left">21.7*</td>
<td class="org-left">21.6*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">Na</td>
<td class="org-right">1070.8†</td>
<td class="org-left">63.5†</td>
<td class="org-left">30.65</td>
<td class="org-left">30.81</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">Mg</td>
<td class="org-right">1303.0†</td>
<td class="org-left">88.7</td>
<td class="org-left">49.78</td>
<td class="org-left">49.50</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">Al</td>
<td class="org-right">1559.6</td>
<td class="org-left">117.8</td>
<td class="org-left">72.95</td>
<td class="org-left">72.55</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">Si</td>
<td class="org-right">1839</td>
<td class="org-left">149.7*b</td>
<td class="org-left">99.82</td>
<td class="org-left">99.42</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">P</td>
<td class="org-right">2145.5</td>
<td class="org-left">189*</td>
<td class="org-left">136*</td>
<td class="org-left">135*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">16</td>
<td class="org-left">S</td>
<td class="org-right">2472</td>
<td class="org-left">230.9</td>
<td class="org-left">163.6*</td>
<td class="org-left">162.5*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">17</td>
<td class="org-left">Cl</td>
<td class="org-right">2822.4</td>
<td class="org-left">270*</td>
<td class="org-left">202*</td>
<td class="org-left">200*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">18</td>
<td class="org-left">Ar</td>
<td class="org-right">3205.9*</td>
<td class="org-left">326.3*</td>
<td class="org-left">250.6†</td>
<td class="org-left">248.4*</td>
<td class="org-left">29.3*</td>
<td class="org-left">15.9*</td>
<td class="org-left">15.7*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">19</td>
<td class="org-left">K</td>
<td class="org-right">3608.4*</td>
<td class="org-left">378.6*</td>
<td class="org-left">297.3*</td>
<td class="org-left">294.6*</td>
<td class="org-left">34.8*</td>
<td class="org-left">18.3*</td>
<td class="org-left">18.3*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">20</td>
<td class="org-left">Ca</td>
<td class="org-right">4038.5*</td>
<td class="org-left">438.4†</td>
<td class="org-left">349.7†</td>
<td class="org-left">346.2†</td>
<td class="org-left">44.3</td>
<td class="org-left">†</td>
<td class="org-left">25.4†</td>
<td class="org-left">25.4†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">Sc</td>
<td class="org-right">4492</td>
<td class="org-left">498.0*</td>
<td class="org-left">403.6*</td>
<td class="org-left">398.7*</td>
<td class="org-left">51.1*</td>
<td class="org-left">28.3*</td>
<td class="org-left">28.3*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">22</td>
<td class="org-left">Ti</td>
<td class="org-right">4966</td>
<td class="org-left">560.9†</td>
<td class="org-left">460.2†</td>
<td class="org-left">453.8†</td>
<td class="org-left">58.7†</td>
<td class="org-left">32.6†</td>
<td class="org-left">32.6†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">23</td>
<td class="org-left">V</td>
<td class="org-right">5465</td>
<td class="org-left">626.7†</td>
<td class="org-left">519.8†</td>
<td class="org-left">512.1†</td>
<td class="org-left">66.3†</td>
<td class="org-left">37.2†</td>
<td class="org-left">37.2†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">24</td>
<td class="org-left">Cr</td>
<td class="org-right">5989</td>
<td class="org-left">696.0†</td>
<td class="org-left">583.8†</td>
<td class="org-left">574.1†</td>
<td class="org-left">74.1†</td>
<td class="org-left">42.2†</td>
<td class="org-left">42.2†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">25</td>
<td class="org-left">Mn</td>
<td class="org-right">6539</td>
<td class="org-left">769.1†</td>
<td class="org-left">649.9†</td>
<td class="org-left">638.7†</td>
<td class="org-left">82.3†</td>
<td class="org-left">47.2†</td>
<td class="org-left">47.2†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">26</td>
<td class="org-left">Fe</td>
<td class="org-right">7112</td>
<td class="org-left">844.6†</td>
<td class="org-left">719.9†</td>
<td class="org-left">706.8†</td>
<td class="org-left">91.3†</td>
<td class="org-left">52.7†</td>
<td class="org-left">52.7†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">27</td>
<td class="org-left">Co</td>
<td class="org-right">7709</td>
<td class="org-left">925.1†</td>
<td class="org-left">793.2†</td>
<td class="org-left">778.1†</td>
<td class="org-left">101.0†</td>
<td class="org-left">58.9†</td>
<td class="org-left">59.9†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">28</td>
<td class="org-left">Ni</td>
<td class="org-right">8333</td>
<td class="org-left">1008.6†</td>
<td class="org-left">870.0†</td>
<td class="org-left">852.7†</td>
<td class="org-left">110.8†</td>
<td class="org-left">68.0†</td>
<td class="org-left">66.2†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">29</td>
<td class="org-left">Cu</td>
<td class="org-right">8979</td>
<td class="org-left">1096.7†</td>
<td class="org-left">952.3†</td>
<td class="org-left">932.7</td>
<td class="org-left">122.5†</td>
<td class="org-left">77.3†</td>
<td class="org-left">75.1†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">30</td>
<td class="org-left">Zn</td>
<td class="org-right">9659</td>
<td class="org-left">1196.2*</td>
<td class="org-left">1044.9*</td>
<td class="org-left">1021.8*</td>
<td class="org-left">139.8*</td>
<td class="org-left">91.4*</td>
<td class="org-left">88.6*</td>
<td class="org-left">10.2*</td>
<td class="org-left">10.1*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">31</td>
<td class="org-left">Ga</td>
<td class="org-right">10367</td>
<td class="org-left">1299.0*b</td>
<td class="org-left">1143.2†</td>
<td class="org-left">1116.4†</td>
<td class="org-left">159.5†</td>
<td class="org-left">103.5†</td>
<td class="org-left">100.0†</td>
<td class="org-left">18.7†</td>
<td class="org-left">18.7†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">32</td>
<td class="org-left">Ge</td>
<td class="org-right">11103</td>
<td class="org-left">1414.6*b</td>
<td class="org-left">1248.1*b</td>
<td class="org-left">1217.0*b</td>
<td class="org-left">180.1*</td>
<td class="org-left">124.9*</td>
<td class="org-left">120.8*</td>
<td class="org-left">29.8</td>
<td class="org-left">29.2</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">33</td>
<td class="org-left">As</td>
<td class="org-right">11867</td>
<td class="org-left">1527.0*b</td>
<td class="org-left">1359.1*b</td>
<td class="org-left">1323.6*b</td>
<td class="org-left">204.7*</td>
<td class="org-left">146.2*</td>
<td class="org-left">141.2*</td>
<td class="org-left">41.7*</td>
<td class="org-left">41.7*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">34</td>
<td class="org-left">Se</td>
<td class="org-right">12658</td>
<td class="org-left">1652.0*b</td>
<td class="org-left">1474.3*b</td>
<td class="org-left">1433.9*b</td>
<td class="org-left">229.6*</td>
<td class="org-left">166.5*</td>
<td class="org-left">160.7*</td>
<td class="org-left">55.5*</td>
<td class="org-left">54.6*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">35</td>
<td class="org-left">Br</td>
<td class="org-right">13474</td>
<td class="org-left">1782*</td>
<td class="org-left">1596*</td>
<td class="org-left">1550*</td>
<td class="org-left">257*</td>
<td class="org-left">189*</td>
<td class="org-left">182*</td>
<td class="org-left">70*</td>
<td class="org-left">69*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">36</td>
<td class="org-left">Kr</td>
<td class="org-right">14326</td>
<td class="org-left">1921</td>
<td class="org-left">1730.9*</td>
<td class="org-left">1678.4*</td>
<td class="org-left">292.8*</td>
<td class="org-left">222.2*</td>
<td class="org-left">214.4</td>
<td class="org-left">95.0*</td>
<td class="org-left">93.8*</td>
<td class="org-left">27.5*</td>
<td class="org-left">14.1*</td>
<td class="org-left">14.1*</td>
</tr>

<tr>
<td class="org-right">37</td>
<td class="org-left">Rb</td>
<td class="org-right">15200</td>
<td class="org-left">2065</td>
<td class="org-left">1864</td>
<td class="org-left">1804</td>
<td class="org-left">326.7*</td>
<td class="org-left">248.7*</td>
<td class="org-left">239.1*</td>
<td class="org-left">113.0*</td>
<td class="org-left">112*</td>
<td class="org-left">30.5*</td>
<td class="org-left">16.3*</td>
<td class="org-left">15.3*</td>
</tr>

<tr>
<td class="org-right">38</td>
<td class="org-left">Sr</td>
<td class="org-right">16105</td>
<td class="org-left">2216</td>
<td class="org-left">2007</td>
<td class="org-left">1940</td>
<td class="org-left">358.7†</td>
<td class="org-left">280.3†</td>
<td class="org-left">270.0†</td>
<td class="org-left">136.0†</td>
<td class="org-left">134.2†</td>
<td class="org-left">38.9†</td>
<td class="org-left">21.3</td>
<td class="org-left">20.1†</td>
</tr>

<tr>
<td class="org-right">39</td>
<td class="org-left">Y</td>
<td class="org-right">17038</td>
<td class="org-left">2373</td>
<td class="org-left">2156</td>
<td class="org-left">2080</td>
<td class="org-left">392.0*b</td>
<td class="org-left">310.6*</td>
<td class="org-left">298.8*</td>
<td class="org-left">157.7†</td>
<td class="org-left">155.8†</td>
<td class="org-left">43.8*</td>
<td class="org-left">24.4*</td>
<td class="org-left">23.1*</td>
</tr>

<tr>
<td class="org-right">40</td>
<td class="org-left">Zr</td>
<td class="org-right">17998</td>
<td class="org-left">2532</td>
<td class="org-left">2307</td>
<td class="org-left">2223</td>
<td class="org-left">430.3†</td>
<td class="org-left">343.5†</td>
<td class="org-left">329.8†</td>
<td class="org-left">181.1†</td>
<td class="org-left">178.8†</td>
<td class="org-left">50.6†</td>
<td class="org-left">28.5†</td>
<td class="org-left">27.1†</td>
</tr>

<tr>
<td class="org-right">41</td>
<td class="org-left">Nb</td>
<td class="org-right">18986</td>
<td class="org-left">2698</td>
<td class="org-left">2465</td>
<td class="org-left">2371</td>
<td class="org-left">466.6†</td>
<td class="org-left">376.1†</td>
<td class="org-left">360.6†</td>
<td class="org-left">205.0†</td>
<td class="org-left">202.3†</td>
<td class="org-left">56.4†</td>
<td class="org-left">32.6†</td>
<td class="org-left">30.8†</td>
</tr>

<tr>
<td class="org-right">42</td>
<td class="org-left">Mo</td>
<td class="org-right">20000</td>
<td class="org-left">2866</td>
<td class="org-left">2625</td>
<td class="org-left">2520</td>
<td class="org-left">506.3†</td>
<td class="org-left">411.6†</td>
<td class="org-left">394.0†</td>
<td class="org-left">231.1†</td>
<td class="org-left">227.9†</td>
<td class="org-left">63.2†</td>
<td class="org-left">37.6†</td>
<td class="org-left">35.5†</td>
</tr>

<tr>
<td class="org-right">43</td>
<td class="org-left">Tc</td>
<td class="org-right">21044</td>
<td class="org-left">3043</td>
<td class="org-left">2793</td>
<td class="org-left">2677</td>
<td class="org-left">544*</td>
<td class="org-left">447.6</td>
<td class="org-left">417.7</td>
<td class="org-left">257.6</td>
<td class="org-left">253.9*</td>
<td class="org-left">69.5*</td>
<td class="org-left">42.3*</td>
<td class="org-left">39.9*</td>
</tr>

<tr>
<td class="org-right">44</td>
<td class="org-left">Ru</td>
<td class="org-right">22117</td>
<td class="org-left">3224</td>
<td class="org-left">2967</td>
<td class="org-left">2838</td>
<td class="org-left">586.1*</td>
<td class="org-left">483.5†</td>
<td class="org-left">461.4†</td>
<td class="org-left">284.2†</td>
<td class="org-left">280.0†</td>
<td class="org-left">75.0†</td>
<td class="org-left">46.3†</td>
<td class="org-left">43.2†</td>
</tr>

<tr>
<td class="org-right">45</td>
<td class="org-left">Rh</td>
<td class="org-right">23220</td>
<td class="org-left">3412</td>
<td class="org-left">3146</td>
<td class="org-left">3004</td>
<td class="org-left">628.1†</td>
<td class="org-left">521.3†</td>
<td class="org-left">496.5†</td>
<td class="org-left">311.9†</td>
<td class="org-left">307.2†</td>
<td class="org-left">81.4*b</td>
<td class="org-left">50.5†</td>
<td class="org-left">47.3†</td>
</tr>

<tr>
<td class="org-right">46</td>
<td class="org-left">Pd</td>
<td class="org-right">24350</td>
<td class="org-left">3604</td>
<td class="org-left">3330</td>
<td class="org-left">3173</td>
<td class="org-left">671.6†</td>
<td class="org-left">559.9†</td>
<td class="org-left">532.3†</td>
<td class="org-left">340.5†</td>
<td class="org-left">335.2†</td>
<td class="org-left">87.1*b</td>
<td class="org-left">55.7†a</td>
<td class="org-left">50.9†</td>
</tr>

<tr>
<td class="org-right">47</td>
<td class="org-left">Ag</td>
<td class="org-right">25514</td>
<td class="org-left">3806</td>
<td class="org-left">3524</td>
<td class="org-left">3351</td>
<td class="org-left">719.0†</td>
<td class="org-left">603.8†</td>
<td class="org-left">573.0†</td>
<td class="org-left">374.0†</td>
<td class="org-left">368.3</td>
<td class="org-left">97.0†</td>
<td class="org-left">63.7†</td>
<td class="org-left">58.3†</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">Z</td>
<td class="org-left">Element</td>
<td class="org-right">K 1s</td>
<td class="org-left">L1 2s</td>
<td class="org-left">L2 2p1/2</td>
<td class="org-left">L3 2p3/2</td>
<td class="org-left">M1 3s</td>
<td class="org-left">M2 3p1/2</td>
<td class="org-left">M3 3p3/2</td>
<td class="org-left">M4 3d3/2</td>
<td class="org-left">M5 3d5/2</td>
<td class="org-left">N 4s</td>
<td class="org-left">N2 4p1/2</td>
<td class="org-left">N3 4p3/2</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">48</td>
<td class="org-left">Cd</td>
<td class="org-right">26711</td>
<td class="org-left">4018</td>
<td class="org-left">3727</td>
<td class="org-left">3538</td>
<td class="org-left">772.0†</td>
<td class="org-left">652.6†</td>
<td class="org-left">618.4†</td>
<td class="org-left">411.9†</td>
<td class="org-left">405.2†</td>
<td class="org-left">109.8†</td>
<td class="org-left">63.9†a</td>
<td class="org-left">63.9†a</td>
</tr>

<tr>
<td class="org-right">49</td>
<td class="org-left">In</td>
<td class="org-right">27940</td>
<td class="org-left">4238</td>
<td class="org-left">3938</td>
<td class="org-left">3730</td>
<td class="org-left">827.2†</td>
<td class="org-left">703.2†</td>
<td class="org-left">665.3†</td>
<td class="org-left">451.4†</td>
<td class="org-left">443.9†</td>
<td class="org-left">122.9†</td>
<td class="org-left">73.5†a</td>
<td class="org-left">73.5†a</td>
</tr>

<tr>
<td class="org-right">50</td>
<td class="org-left">Sn</td>
<td class="org-right">29200</td>
<td class="org-left">4465</td>
<td class="org-left">4156</td>
<td class="org-left">3929</td>
<td class="org-left">884.7†</td>
<td class="org-left">756.5†</td>
<td class="org-left">714.6†</td>
<td class="org-left">493.2†</td>
<td class="org-left">484.9†</td>
<td class="org-left">137.1†</td>
<td class="org-left">83.6†a</td>
<td class="org-left">83.6†a</td>
</tr>

<tr>
<td class="org-right">51</td>
<td class="org-left">Sb</td>
<td class="org-right">30491</td>
<td class="org-left">4698</td>
<td class="org-left">4380</td>
<td class="org-left">4132</td>
<td class="org-left">946†</td>
<td class="org-left">812.7†</td>
<td class="org-left">766.4†</td>
<td class="org-left">537.5†</td>
<td class="org-left">528.2†</td>
<td class="org-left">153.2†</td>
<td class="org-left">95.6†a</td>
<td class="org-left">95.6†a</td>
</tr>

<tr>
<td class="org-right">52</td>
<td class="org-left">Te</td>
<td class="org-right">31814</td>
<td class="org-left">4939</td>
<td class="org-left">4612</td>
<td class="org-left">4341</td>
<td class="org-left">1006†</td>
<td class="org-left">870.8†</td>
<td class="org-left">820.0†</td>
<td class="org-left">583.4†</td>
<td class="org-left">573.0†</td>
<td class="org-left">169.4†</td>
<td class="org-left">103.3†a</td>
<td class="org-left">103.3†a</td>
</tr>

<tr>
<td class="org-right">53</td>
<td class="org-left">I</td>
<td class="org-right">33169</td>
<td class="org-left">5188</td>
<td class="org-left">4852</td>
<td class="org-left">4557</td>
<td class="org-left">1072*</td>
<td class="org-left">931*</td>
<td class="org-left">875*</td>
<td class="org-left">630.8</td>
<td class="org-left">619.3</td>
<td class="org-left">186*</td>
<td class="org-left">123*</td>
<td class="org-left">123*</td>
</tr>

<tr>
<td class="org-right">54</td>
<td class="org-left">Xe</td>
<td class="org-right">34561</td>
<td class="org-left">5453</td>
<td class="org-left">5107</td>
<td class="org-left">4786</td>
<td class="org-left">1148.7*</td>
<td class="org-left">1002.1*</td>
<td class="org-left">940.6*</td>
<td class="org-left">689.0*</td>
<td class="org-left">676.4*</td>
<td class="org-left">213.2*</td>
<td class="org-left">146.7</td>
<td class="org-left">145.5*</td>
</tr>

<tr>
<td class="org-right">55</td>
<td class="org-left">Cs</td>
<td class="org-right">35985</td>
<td class="org-left">5714</td>
<td class="org-left">5359</td>
<td class="org-left">5012</td>
<td class="org-left">1211*b</td>
<td class="org-left">1071*</td>
<td class="org-left">1003*</td>
<td class="org-left">740.5*</td>
<td class="org-left">726.6*</td>
<td class="org-left">232.3*</td>
<td class="org-left">172.4*</td>
<td class="org-left">161.3*</td>
</tr>

<tr>
<td class="org-right">56</td>
<td class="org-left">Ba</td>
<td class="org-right">37441</td>
<td class="org-left">5989</td>
<td class="org-left">5624</td>
<td class="org-left">5247</td>
<td class="org-left">1293*b</td>
<td class="org-left">1137*b</td>
<td class="org-left">1063*b</td>
<td class="org-left">795.7†</td>
<td class="org-left">780.5*</td>
<td class="org-left">253.5†</td>
<td class="org-left">192</td>
<td class="org-left">178.6†</td>
</tr>

<tr>
<td class="org-right">57</td>
<td class="org-left">La</td>
<td class="org-right">38925</td>
<td class="org-left">6266</td>
<td class="org-left">5891</td>
<td class="org-left">5483</td>
<td class="org-left">1362*b</td>
<td class="org-left">1209*b</td>
<td class="org-left">1128*b</td>
<td class="org-left">853*</td>
<td class="org-left">836*</td>
<td class="org-left">274.7*</td>
<td class="org-left">205.8</td>
<td class="org-left">196.0*</td>
</tr>

<tr>
<td class="org-right">58</td>
<td class="org-left">Ce</td>
<td class="org-right">40443</td>
<td class="org-left">6549</td>
<td class="org-left">6164</td>
<td class="org-left">5723</td>
<td class="org-left">1436*b</td>
<td class="org-left">1274*b</td>
<td class="org-left">1187*b</td>
<td class="org-left">902.4*</td>
<td class="org-left">883.8*</td>
<td class="org-left">291.0*</td>
<td class="org-left">223.2</td>
<td class="org-left">206.5*</td>
</tr>

<tr>
<td class="org-right">59</td>
<td class="org-left">Pr</td>
<td class="org-right">41991</td>
<td class="org-left">6835</td>
<td class="org-left">6440</td>
<td class="org-left">5964</td>
<td class="org-left">1511</td>
<td class="org-left">1337</td>
<td class="org-left">1242</td>
<td class="org-left">948.3*</td>
<td class="org-left">928.8*</td>
<td class="org-left">304.5</td>
<td class="org-left">236.3</td>
<td class="org-left">217.6</td>
</tr>

<tr>
<td class="org-right">60</td>
<td class="org-left">Nd</td>
<td class="org-right">43569</td>
<td class="org-left">7126</td>
<td class="org-left">6722</td>
<td class="org-left">6208</td>
<td class="org-left">1575</td>
<td class="org-left">1403</td>
<td class="org-left">1297</td>
<td class="org-left">1003.3*</td>
<td class="org-left">980.4*</td>
<td class="org-left">319.2*</td>
<td class="org-left">243.3</td>
<td class="org-left">224.6</td>
</tr>

<tr>
<td class="org-right">61</td>
<td class="org-left">Pm</td>
<td class="org-right">45184</td>
<td class="org-left">7428</td>
<td class="org-left">7013</td>
<td class="org-left">6459</td>
<td class="org-left">---</td>
<td class="org-left">1471</td>
<td class="org-left">1357</td>
<td class="org-left">1052</td>
<td class="org-left">1027</td>
<td class="org-left">---</td>
<td class="org-left">242</td>
<td class="org-left">242</td>
</tr>

<tr>
<td class="org-right">62</td>
<td class="org-left">Sm</td>
<td class="org-right">46834</td>
<td class="org-left">7737</td>
<td class="org-left">7312</td>
<td class="org-left">6716</td>
<td class="org-left">1723</td>
<td class="org-left">1541</td>
<td class="org-left">1420</td>
<td class="org-left">1110.9*</td>
<td class="org-left">1083.4*</td>
<td class="org-left">347.2*</td>
<td class="org-left">265.6</td>
<td class="org-left">247.4</td>
</tr>

<tr>
<td class="org-right">63</td>
<td class="org-left">Eu</td>
<td class="org-right">48519</td>
<td class="org-left">8052</td>
<td class="org-left">7617</td>
<td class="org-left">6977</td>
<td class="org-left">1800</td>
<td class="org-left">1614</td>
<td class="org-left">1481</td>
<td class="org-left">1158.6*</td>
<td class="org-left">1127.5*</td>
<td class="org-left">360</td>
<td class="org-left">284</td>
<td class="org-left">257</td>
</tr>

<tr>
<td class="org-right">64</td>
<td class="org-left">Gd</td>
<td class="org-right">50239</td>
<td class="org-left">8376</td>
<td class="org-left">7930</td>
<td class="org-left">7243</td>
<td class="org-left">1881</td>
<td class="org-left">1688</td>
<td class="org-left">1544</td>
<td class="org-left">1221.9*</td>
<td class="org-left">1189.6*</td>
<td class="org-left">378.6*</td>
<td class="org-left">286</td>
<td class="org-left">271</td>
</tr>

<tr>
<td class="org-right">65</td>
<td class="org-left">Tb</td>
<td class="org-right">51996</td>
<td class="org-left">8708</td>
<td class="org-left">8252</td>
<td class="org-left">7514</td>
<td class="org-left">1968</td>
<td class="org-left">1768</td>
<td class="org-left">1611</td>
<td class="org-left">1276.9*</td>
<td class="org-left">1241.1*</td>
<td class="org-left">396.0*</td>
<td class="org-left">322.4*</td>
<td class="org-left">284.1*</td>
</tr>

<tr>
<td class="org-right">66</td>
<td class="org-left">Dy</td>
<td class="org-right">53789</td>
<td class="org-left">9046</td>
<td class="org-left">8581</td>
<td class="org-left">7790</td>
<td class="org-left">2047</td>
<td class="org-left">1842</td>
<td class="org-left">1676</td>
<td class="org-left">1333</td>
<td class="org-left">1292.6*</td>
<td class="org-left">414.2*</td>
<td class="org-left">333.5*</td>
<td class="org-left">293.2*</td>
</tr>

<tr>
<td class="org-right">67</td>
<td class="org-left">Ho</td>
<td class="org-right">55618</td>
<td class="org-left">9394</td>
<td class="org-left">8918</td>
<td class="org-left">8071</td>
<td class="org-left">2128</td>
<td class="org-left">1923</td>
<td class="org-left">1741</td>
<td class="org-left">1392</td>
<td class="org-left">1351</td>
<td class="org-left">432.4*</td>
<td class="org-left">343.5</td>
<td class="org-left">308.2*</td>
</tr>

<tr>
<td class="org-right">68</td>
<td class="org-left">Er</td>
<td class="org-right">57486</td>
<td class="org-left">9751</td>
<td class="org-left">9264</td>
<td class="org-left">8358</td>
<td class="org-left">2207</td>
<td class="org-left">2006</td>
<td class="org-left">1812</td>
<td class="org-left">1453</td>
<td class="org-left">1409</td>
<td class="org-left">449.8*</td>
<td class="org-left">366.2</td>
<td class="org-left">320.2*</td>
</tr>

<tr>
<td class="org-right">69</td>
<td class="org-left">Tm</td>
<td class="org-right">59390</td>
<td class="org-left">10116</td>
<td class="org-left">9617</td>
<td class="org-left">8648</td>
<td class="org-left">2307</td>
<td class="org-left">2090</td>
<td class="org-left">1885</td>
<td class="org-left">1515</td>
<td class="org-left">1468</td>
<td class="org-left">470.9*</td>
<td class="org-left">385.9*</td>
<td class="org-left">332.6*</td>
</tr>

<tr>
<td class="org-right">70</td>
<td class="org-left">Yb</td>
<td class="org-right">61332</td>
<td class="org-left">10486</td>
<td class="org-left">9978</td>
<td class="org-left">8944</td>
<td class="org-left">2398</td>
<td class="org-left">2173</td>
<td class="org-left">1950</td>
<td class="org-left">1576</td>
<td class="org-left">1528</td>
<td class="org-left">480.5*</td>
<td class="org-left">388.7*</td>
<td class="org-left">339.7*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">Z</td>
<td class="org-left">Element</td>
<td class="org-right">N4 4d3/2</td>
<td class="org-left">N5 4d5/2</td>
<td class="org-left">N6 4f5/2</td>
<td class="org-left">N7 4f7/2</td>
<td class="org-left">O1 5s</td>
<td class="org-left">O2 5p1/2</td>
<td class="org-left">O3 5p3/2</td>
<td class="org-left">O4 5d3/2</td>
<td class="org-left">O5 5d5/2</td>
<td class="org-left">P1 6s</td>
<td class="org-left">P2 6p1/2</td>
<td class="org-left">P3 6p3/2</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">48</td>
<td class="org-left">Cd</td>
<td class="org-right">11.7†</td>
<td class="org-left">l0.7†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">49</td>
<td class="org-left">In</td>
<td class="org-right">17.7†</td>
<td class="org-left">16.9†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">50</td>
<td class="org-left">Sn</td>
<td class="org-right">24.9†</td>
<td class="org-left">23.9†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">51</td>
<td class="org-left">Sb</td>
<td class="org-right">33.3†</td>
<td class="org-left">32.1†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">52</td>
<td class="org-left">Te</td>
<td class="org-right">41.9†</td>
<td class="org-left">40.4†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">53</td>
<td class="org-left">I</td>
<td class="org-right">50.6</td>
<td class="org-left">48.9</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">54</td>
<td class="org-left">Xe</td>
<td class="org-right">69.5*</td>
<td class="org-left">67.5*</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">23.3*</td>
<td class="org-left">13.4*</td>
<td class="org-left">12.1*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">55</td>
<td class="org-left">Cs</td>
<td class="org-right">79.8*</td>
<td class="org-left">77.5*</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">22.7</td>
<td class="org-left">14.2*</td>
<td class="org-left">12.1*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">56</td>
<td class="org-left">Ba</td>
<td class="org-right">92.6†</td>
<td class="org-left">89.9†</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">30.3†</td>
<td class="org-left">17.0†</td>
<td class="org-left">14.8†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">57</td>
<td class="org-left">La</td>
<td class="org-right">105.3*</td>
<td class="org-left">102.5*</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">34.3*</td>
<td class="org-left">19.3*</td>
<td class="org-left">16.8*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">58</td>
<td class="org-left">Ce</td>
<td class="org-right">109*</td>
<td class="org-left">---</td>
<td class="org-left">0.1</td>
<td class="org-left">0.1</td>
<td class="org-left">37.8</td>
<td class="org-left">19.8*</td>
<td class="org-left">17.0*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">59</td>
<td class="org-left">Pr</td>
<td class="org-right">115.1*</td>
<td class="org-left">115.1*</td>
<td class="org-left">2.0</td>
<td class="org-left">2.0</td>
<td class="org-left">37.4</td>
<td class="org-left">22.3</td>
<td class="org-left">22.3</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">60</td>
<td class="org-left">Nd</td>
<td class="org-right">120.5*</td>
<td class="org-left">120.5*</td>
<td class="org-left">1.5</td>
<td class="org-left">1.5</td>
<td class="org-left">37.5</td>
<td class="org-left">21.1</td>
<td class="org-left">21.1</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">61</td>
<td class="org-left">Pm</td>
<td class="org-right">120</td>
<td class="org-left">120</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">62</td>
<td class="org-left">Sm</td>
<td class="org-right">129</td>
<td class="org-left">129</td>
<td class="org-left">5.2</td>
<td class="org-left">5.2</td>
<td class="org-left">37.4</td>
<td class="org-left">21.3</td>
<td class="org-left">21.3</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">63</td>
<td class="org-left">Eu</td>
<td class="org-right">133</td>
<td class="org-left">127.7*</td>
<td class="org-left">0</td>
<td class="org-left">0</td>
<td class="org-left">32</td>
<td class="org-left">22</td>
<td class="org-left">22</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">64</td>
<td class="org-left">Gd</td>
<td class="org-right">---</td>
<td class="org-left">142.6*</td>
<td class="org-left">8.6*</td>
<td class="org-left">8.6*</td>
<td class="org-left">36</td>
<td class="org-left">28</td>
<td class="org-left">21</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">65</td>
<td class="org-left">Tb</td>
<td class="org-right">150.5*</td>
<td class="org-left">150.5*</td>
<td class="org-left">7.7*</td>
<td class="org-left">2.4*</td>
<td class="org-left">45.6*</td>
<td class="org-left">28.7*</td>
<td class="org-left">22.6*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">66</td>
<td class="org-left">Dy</td>
<td class="org-right">153.6*</td>
<td class="org-left">153.6*</td>
<td class="org-left">8.0*</td>
<td class="org-left">4.3*</td>
<td class="org-left">49.9*</td>
<td class="org-left">26.3</td>
<td class="org-left">26.3</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">67</td>
<td class="org-left">Ho</td>
<td class="org-right">160*</td>
<td class="org-left">160*</td>
<td class="org-left">8.6*</td>
<td class="org-left">5.2*</td>
<td class="org-left">49.3*</td>
<td class="org-left">30.8*</td>
<td class="org-left">24.1*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">68</td>
<td class="org-left">Er</td>
<td class="org-right">167.6*</td>
<td class="org-left">167.6*</td>
<td class="org-left">---</td>
<td class="org-left">4.7*</td>
<td class="org-left">50.6*</td>
<td class="org-left">31.4*</td>
<td class="org-left">24.7*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">69</td>
<td class="org-left">Tm</td>
<td class="org-right">175.5*</td>
<td class="org-left">175.5*</td>
<td class="org-left">---</td>
<td class="org-left">4.6</td>
<td class="org-left">54.7*</td>
<td class="org-left">31.8*</td>
<td class="org-left">25.0*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">70</td>
<td class="org-left">Yb</td>
<td class="org-right">191.2*</td>
<td class="org-left">182.4*</td>
<td class="org-left">2.5*</td>
<td class="org-left">1.3*</td>
<td class="org-left">52.0*</td>
<td class="org-left">30.3*</td>
<td class="org-left">24.1*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">Z</td>
<td class="org-left">Element</td>
<td class="org-right">K 1s</td>
<td class="org-left">L1 2s</td>
<td class="org-left">L2 2p1/2</td>
<td class="org-left">L3 2p3/2</td>
<td class="org-left">M1 3s</td>
<td class="org-left">M2 3p1/2</td>
<td class="org-left">M3 3p3/2</td>
<td class="org-left">M4 3d3/2</td>
<td class="org-left">M5 3d5/2</td>
<td class="org-left">N1 4s</td>
<td class="org-left">N2 4p1/2</td>
<td class="org-left">N3 4p3/2</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">71</td>
<td class="org-left">Lu</td>
<td class="org-right">63314</td>
<td class="org-left">10870</td>
<td class="org-left">10349</td>
<td class="org-left">9244</td>
<td class="org-left">2491</td>
<td class="org-left">2264</td>
<td class="org-left">2024</td>
<td class="org-left">1639</td>
<td class="org-left">1589</td>
<td class="org-left">506.8*</td>
<td class="org-left">412.4*</td>
<td class="org-left">359.2*</td>
</tr>

<tr>
<td class="org-right">72</td>
<td class="org-left">Hf</td>
<td class="org-right">65351</td>
<td class="org-left">11271</td>
<td class="org-left">10739</td>
<td class="org-left">9561</td>
<td class="org-left">2601</td>
<td class="org-left">2365</td>
<td class="org-left">2108</td>
<td class="org-left">1716</td>
<td class="org-left">1662</td>
<td class="org-left">538*</td>
<td class="org-left">438.2†</td>
<td class="org-left">380.7†</td>
</tr>

<tr>
<td class="org-right">73</td>
<td class="org-left">Ta</td>
<td class="org-right">67416</td>
<td class="org-left">11682</td>
<td class="org-left">11136</td>
<td class="org-left">9881</td>
<td class="org-left">2708</td>
<td class="org-left">2469</td>
<td class="org-left">2194</td>
<td class="org-left">1793</td>
<td class="org-left">1735</td>
<td class="org-left">563.4†</td>
<td class="org-left">463.4†</td>
<td class="org-left">400.9†</td>
</tr>

<tr>
<td class="org-right">74</td>
<td class="org-left">W</td>
<td class="org-right">69525</td>
<td class="org-left">12100</td>
<td class="org-left">11544</td>
<td class="org-left">10207</td>
<td class="org-left">2820</td>
<td class="org-left">2575</td>
<td class="org-left">2281</td>
<td class="org-left">1872</td>
<td class="org-left">1809</td>
<td class="org-left">594.1†</td>
<td class="org-left">490.4†</td>
<td class="org-left">423.6†</td>
</tr>

<tr>
<td class="org-right">75</td>
<td class="org-left">Re</td>
<td class="org-right">71676</td>
<td class="org-left">12527</td>
<td class="org-left">11959</td>
<td class="org-left">10535</td>
<td class="org-left">2932</td>
<td class="org-left">2682</td>
<td class="org-left">2367</td>
<td class="org-left">1949</td>
<td class="org-left">1883</td>
<td class="org-left">625.4†</td>
<td class="org-left">518.7†</td>
<td class="org-left">446.8†</td>
</tr>

<tr>
<td class="org-right">76</td>
<td class="org-left">Os</td>
<td class="org-right">73871</td>
<td class="org-left">12968</td>
<td class="org-left">12385</td>
<td class="org-left">10871</td>
<td class="org-left">3049</td>
<td class="org-left">2792</td>
<td class="org-left">2457</td>
<td class="org-left">2031</td>
<td class="org-left">1960</td>
<td class="org-left">658.2†</td>
<td class="org-left">549.1†</td>
<td class="org-left">470.7†</td>
</tr>

<tr>
<td class="org-right">77</td>
<td class="org-left">Ir</td>
<td class="org-right">76111</td>
<td class="org-left">13419</td>
<td class="org-left">12824</td>
<td class="org-left">11215</td>
<td class="org-left">3174</td>
<td class="org-left">2909</td>
<td class="org-left">2551</td>
<td class="org-left">2116</td>
<td class="org-left">2040</td>
<td class="org-left">691.1†</td>
<td class="org-left">577.8†</td>
<td class="org-left">495.8†</td>
</tr>

<tr>
<td class="org-right">78</td>
<td class="org-left">Pt</td>
<td class="org-right">78395</td>
<td class="org-left">13880</td>
<td class="org-left">13273</td>
<td class="org-left">11564</td>
<td class="org-left">3296</td>
<td class="org-left">3027</td>
<td class="org-left">2645</td>
<td class="org-left">2202</td>
<td class="org-left">2122</td>
<td class="org-left">725.4†</td>
<td class="org-left">609.1†</td>
<td class="org-left">519.4†</td>
</tr>

<tr>
<td class="org-right">79</td>
<td class="org-left">Au</td>
<td class="org-right">80725</td>
<td class="org-left">14353</td>
<td class="org-left">13734</td>
<td class="org-left">11919</td>
<td class="org-left">3425</td>
<td class="org-left">3148</td>
<td class="org-left">2743</td>
<td class="org-left">2291</td>
<td class="org-left">2206</td>
<td class="org-left">762.1†</td>
<td class="org-left">642.7†</td>
<td class="org-left">546.3†</td>
</tr>

<tr>
<td class="org-right">80</td>
<td class="org-left">Hg</td>
<td class="org-right">83102</td>
<td class="org-left">14839</td>
<td class="org-left">14209</td>
<td class="org-left">12284</td>
<td class="org-left">3562</td>
<td class="org-left">3279</td>
<td class="org-left">2847</td>
<td class="org-left">2385</td>
<td class="org-left">2295</td>
<td class="org-left">802.2†</td>
<td class="org-left">680.2†</td>
<td class="org-left">576.6†</td>
</tr>

<tr>
<td class="org-right">81</td>
<td class="org-left">Tl</td>
<td class="org-right">85530</td>
<td class="org-left">15347</td>
<td class="org-left">14698</td>
<td class="org-left">12658</td>
<td class="org-left">3704</td>
<td class="org-left">3416</td>
<td class="org-left">2957</td>
<td class="org-left">2485</td>
<td class="org-left">2389</td>
<td class="org-left">846.2†</td>
<td class="org-left">720.5†</td>
<td class="org-left">609.5†</td>
</tr>

<tr>
<td class="org-right">82</td>
<td class="org-left">Pb</td>
<td class="org-right">88005</td>
<td class="org-left">15861</td>
<td class="org-left">15200</td>
<td class="org-left">13035</td>
<td class="org-left">3851</td>
<td class="org-left">3554</td>
<td class="org-left">3066</td>
<td class="org-left">2586</td>
<td class="org-left">2484</td>
<td class="org-left">891.8†</td>
<td class="org-left">761.9†</td>
<td class="org-left">643.5†</td>
</tr>

<tr>
<td class="org-right">83</td>
<td class="org-left">Bi</td>
<td class="org-right">90524</td>
<td class="org-left">16388</td>
<td class="org-left">15711</td>
<td class="org-left">13419</td>
<td class="org-left">3999</td>
<td class="org-left">3696</td>
<td class="org-left">3177</td>
<td class="org-left">2688</td>
<td class="org-left">2580</td>
<td class="org-left">939†</td>
<td class="org-left">805.2†</td>
<td class="org-left">678.8†</td>
</tr>

<tr>
<td class="org-right">84</td>
<td class="org-left">Po</td>
<td class="org-right">93105</td>
<td class="org-left">16939</td>
<td class="org-left">16244</td>
<td class="org-left">13814</td>
<td class="org-left">4149</td>
<td class="org-left">3854</td>
<td class="org-left">3302</td>
<td class="org-left">2798</td>
<td class="org-left">2683</td>
<td class="org-left">995*</td>
<td class="org-left">851*</td>
<td class="org-left">705*</td>
</tr>

<tr>
<td class="org-right">85</td>
<td class="org-left">At</td>
<td class="org-right">95730</td>
<td class="org-left">17493</td>
<td class="org-left">16785</td>
<td class="org-left">14214</td>
<td class="org-left">4317</td>
<td class="org-left">4008</td>
<td class="org-left">3426</td>
<td class="org-left">2909</td>
<td class="org-left">2787</td>
<td class="org-left">1042*</td>
<td class="org-left">886*</td>
<td class="org-left">740*</td>
</tr>

<tr>
<td class="org-right">86</td>
<td class="org-left">Rn</td>
<td class="org-right">98404</td>
<td class="org-left">18049</td>
<td class="org-left">17337</td>
<td class="org-left">14619</td>
<td class="org-left">4482</td>
<td class="org-left">4159</td>
<td class="org-left">3538</td>
<td class="org-left">3022</td>
<td class="org-left">2892</td>
<td class="org-left">1097*</td>
<td class="org-left">929*</td>
<td class="org-left">768*</td>
</tr>

<tr>
<td class="org-right">87</td>
<td class="org-left">Fr</td>
<td class="org-right">101137</td>
<td class="org-left">18639</td>
<td class="org-left">17907</td>
<td class="org-left">15031</td>
<td class="org-left">4652</td>
<td class="org-left">4327</td>
<td class="org-left">3663</td>
<td class="org-left">3136</td>
<td class="org-left">3000</td>
<td class="org-left">1153*</td>
<td class="org-left">980*</td>
<td class="org-left">810*</td>
</tr>

<tr>
<td class="org-right">88</td>
<td class="org-left">Ra</td>
<td class="org-right">103922</td>
<td class="org-left">19237</td>
<td class="org-left">18484</td>
<td class="org-left">15444</td>
<td class="org-left">4822</td>
<td class="org-left">4490</td>
<td class="org-left">3792</td>
<td class="org-left">3248</td>
<td class="org-left">3105</td>
<td class="org-left">1208*</td>
<td class="org-left">1058</td>
<td class="org-left">879*</td>
</tr>

<tr>
<td class="org-right">89</td>
<td class="org-left">Ac</td>
<td class="org-right">106755</td>
<td class="org-left">19840</td>
<td class="org-left">19083</td>
<td class="org-left">15871</td>
<td class="org-left">5002</td>
<td class="org-left">4656</td>
<td class="org-left">3909</td>
<td class="org-left">3370</td>
<td class="org-left">3219</td>
<td class="org-left">1269*</td>
<td class="org-left">1080*</td>
<td class="org-left">890*</td>
</tr>

<tr>
<td class="org-right">90</td>
<td class="org-left">Th</td>
<td class="org-right">109651</td>
<td class="org-left">20472</td>
<td class="org-left">19693</td>
<td class="org-left">16300</td>
<td class="org-left">5182</td>
<td class="org-left">4830</td>
<td class="org-left">4046</td>
<td class="org-left">3491</td>
<td class="org-left">3332</td>
<td class="org-left">1330*</td>
<td class="org-left">1168*</td>
<td class="org-left">966.4†</td>
</tr>

<tr>
<td class="org-right">91</td>
<td class="org-left">Pa</td>
<td class="org-right">112601</td>
<td class="org-left">21105</td>
<td class="org-left">20314</td>
<td class="org-left">16733</td>
<td class="org-left">5367</td>
<td class="org-left">5001</td>
<td class="org-left">4174</td>
<td class="org-left">3611</td>
<td class="org-left">3442</td>
<td class="org-left">1387*</td>
<td class="org-left">1224*</td>
<td class="org-left">1007*</td>
</tr>

<tr>
<td class="org-right">92</td>
<td class="org-left">U</td>
<td class="org-right">115606</td>
<td class="org-left">21757</td>
<td class="org-left">20948</td>
<td class="org-left">17166</td>
<td class="org-left">5548</td>
<td class="org-left">5182</td>
<td class="org-left">4303</td>
<td class="org-left">3728</td>
<td class="org-left">3552</td>
<td class="org-left">1439*b</td>
<td class="org-left">1271*b</td>
<td class="org-left">1043†</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">Z</td>
<td class="org-left">Element</td>
<td class="org-right">N4 4d3/2</td>
<td class="org-left">N5 4d5/2</td>
<td class="org-left">N6 4f5/2</td>
<td class="org-left">N7 4f7/2</td>
<td class="org-left">O1 5s</td>
<td class="org-left">O2 5p1/2</td>
<td class="org-left">O3 5p3/2</td>
<td class="org-left">O4 5d3/2</td>
<td class="org-left">O5 5d5/2</td>
<td class="org-left">P1 6s</td>
<td class="org-left">P2 6p1/2</td>
<td class="org-left">P3 6p3/2</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">71</td>
<td class="org-left">Lu</td>
<td class="org-right">206.1*</td>
<td class="org-left">196.3*</td>
<td class="org-left">8.9*</td>
<td class="org-left">7.5*</td>
<td class="org-left">57.3*</td>
<td class="org-left">33.6*</td>
<td class="org-left">26.7*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">72</td>
<td class="org-left">Hf</td>
<td class="org-right">220.0†</td>
<td class="org-left">211.5†</td>
<td class="org-left">15.9†</td>
<td class="org-left">14.2†</td>
<td class="org-left">64.2†</td>
<td class="org-left">38*</td>
<td class="org-left">29.9†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">73</td>
<td class="org-left">Ta</td>
<td class="org-right">237.9†</td>
<td class="org-left">226.4†</td>
<td class="org-left">23.5†</td>
<td class="org-left">21.6†</td>
<td class="org-left">69.7†</td>
<td class="org-left">42.2*</td>
<td class="org-left">32.7†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">74</td>
<td class="org-left">W</td>
<td class="org-right">255.9†</td>
<td class="org-left">243.5†</td>
<td class="org-left">33.6*</td>
<td class="org-left">31.4†</td>
<td class="org-left">75.6†</td>
<td class="org-left">45.3*b</td>
<td class="org-left">36.8†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">75</td>
<td class="org-left">Re</td>
<td class="org-right">273.9†</td>
<td class="org-left">260.5†</td>
<td class="org-left">42.9*</td>
<td class="org-left">40.5*</td>
<td class="org-left">83†</td>
<td class="org-left">45.6*</td>
<td class="org-left">34.6*b</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">76</td>
<td class="org-left">Os</td>
<td class="org-right">293.1†</td>
<td class="org-left">278.5†</td>
<td class="org-left">53.4†</td>
<td class="org-left">50.7†</td>
<td class="org-left">84*</td>
<td class="org-left">58*</td>
<td class="org-left">44.5†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">77</td>
<td class="org-left">Ir</td>
<td class="org-right">311.9†</td>
<td class="org-left">296.3†</td>
<td class="org-left">63.8†</td>
<td class="org-left">60.8†</td>
<td class="org-left">95.2*b</td>
<td class="org-left">63.0*b</td>
<td class="org-left">48.0†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">78</td>
<td class="org-left">Pt</td>
<td class="org-right">331.6†</td>
<td class="org-left">314.6†</td>
<td class="org-left">74.5†</td>
<td class="org-left">71.2†</td>
<td class="org-left">101.7*b</td>
<td class="org-left">65.3*b</td>
<td class="org-left">51.7†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">79</td>
<td class="org-left">Au</td>
<td class="org-right">353.2†</td>
<td class="org-left">335.1†</td>
<td class="org-left">87.6†</td>
<td class="org-left">84.0</td>
<td class="org-left">107.2*b</td>
<td class="org-left">74.2†</td>
<td class="org-left">57.2†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">80</td>
<td class="org-left">Hg</td>
<td class="org-right">378.2†</td>
<td class="org-left">358.8†</td>
<td class="org-left">104.0†</td>
<td class="org-left">99.9†</td>
<td class="org-left">127†</td>
<td class="org-left">83.1†</td>
<td class="org-left">64.5†</td>
<td class="org-left">9.6†</td>
<td class="org-left">7.8†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">81</td>
<td class="org-left">Tl</td>
<td class="org-right">405.7†</td>
<td class="org-left">385.0†</td>
<td class="org-left">122.2†</td>
<td class="org-left">117.8†</td>
<td class="org-left">136.0*b</td>
<td class="org-left">94.6†</td>
<td class="org-left">73.5†</td>
<td class="org-left">14.7†</td>
<td class="org-left">12.5†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">82</td>
<td class="org-left">Pb</td>
<td class="org-right">434.3†</td>
<td class="org-left">412.2†</td>
<td class="org-left">141.7†</td>
<td class="org-left">136.9†</td>
<td class="org-left">147*b</td>
<td class="org-left">106.4†</td>
<td class="org-left">83.3†</td>
<td class="org-left">20.7†</td>
<td class="org-left">18.1†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">83</td>
<td class="org-left">Bi</td>
<td class="org-right">464.0†</td>
<td class="org-left">440.1†</td>
<td class="org-left">162.3†</td>
<td class="org-left">157.0†</td>
<td class="org-left">159.3*b</td>
<td class="org-left">119.0†</td>
<td class="org-left">92.6†</td>
<td class="org-left">26.9†</td>
<td class="org-left">23.8†</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">84</td>
<td class="org-left">Po</td>
<td class="org-right">500*</td>
<td class="org-left">473*</td>
<td class="org-left">184*</td>
<td class="org-left">184*</td>
<td class="org-left">177*</td>
<td class="org-left">132*</td>
<td class="org-left">104*</td>
<td class="org-left">31*</td>
<td class="org-left">31*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">85</td>
<td class="org-left">At</td>
<td class="org-right">533*</td>
<td class="org-left">507</td>
<td class="org-left">210*</td>
<td class="org-left">210*</td>
<td class="org-left">195*</td>
<td class="org-left">148*</td>
<td class="org-left">115*</td>
<td class="org-left">40*</td>
<td class="org-left">40*</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">86</td>
<td class="org-left">Rn</td>
<td class="org-right">567*</td>
<td class="org-left">541*</td>
<td class="org-left">238*</td>
<td class="org-left">238*</td>
<td class="org-left">214*</td>
<td class="org-left">164*</td>
<td class="org-left">127*</td>
<td class="org-left">48*</td>
<td class="org-left">48*</td>
<td class="org-left">26</td>
<td class="org-left"> </td>
<td class="org-left"> </td>
</tr>

<tr>
<td class="org-right">87</td>
<td class="org-left">Fr</td>
<td class="org-right">603*</td>
<td class="org-left">577*</td>
<td class="org-left">268*</td>
<td class="org-left">268*</td>
<td class="org-left">234*</td>
<td class="org-left">182*</td>
<td class="org-left">140*</td>
<td class="org-left">58*</td>
<td class="org-left">58*</td>
<td class="org-left">34</td>
<td class="org-left">15</td>
<td class="org-left">15</td>
</tr>

<tr>
<td class="org-right">88</td>
<td class="org-left">Ra</td>
<td class="org-right">636*</td>
<td class="org-left">603*</td>
<td class="org-left">299*</td>
<td class="org-left">299*</td>
<td class="org-left">254*</td>
<td class="org-left">200*</td>
<td class="org-left">153*</td>
<td class="org-left">68*</td>
<td class="org-left">68*</td>
<td class="org-left">44</td>
<td class="org-left">19</td>
<td class="org-left">19</td>
</tr>

<tr>
<td class="org-right">89</td>
<td class="org-left">Ac</td>
<td class="org-right">675*</td>
<td class="org-left">639*</td>
<td class="org-left">319*</td>
<td class="org-left">319*</td>
<td class="org-left">272*</td>
<td class="org-left">215*</td>
<td class="org-left">167*</td>
<td class="org-left">80*</td>
<td class="org-left">80*</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
</tr>

<tr>
<td class="org-right">90</td>
<td class="org-left">Th</td>
<td class="org-right">712.1†</td>
<td class="org-left">675.2†</td>
<td class="org-left">342.4†</td>
<td class="org-left">333.1†</td>
<td class="org-left">290*a</td>
<td class="org-left">229*a</td>
<td class="org-left">182*a</td>
<td class="org-left">92.5†</td>
<td class="org-left">85.4†</td>
<td class="org-left">41.4†</td>
<td class="org-left">24.5†</td>
<td class="org-left">16.6†</td>
</tr>

<tr>
<td class="org-right">91</td>
<td class="org-left">Pa</td>
<td class="org-right">743*</td>
<td class="org-left">708*</td>
<td class="org-left">371*</td>
<td class="org-left">360*</td>
<td class="org-left">310*</td>
<td class="org-left">232*</td>
<td class="org-left">232*</td>
<td class="org-left">94*</td>
<td class="org-left">94*</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
<td class="org-left">---</td>
</tr>

<tr>
<td class="org-right">92</td>
<td class="org-left">U</td>
<td class="org-right">778.3†</td>
<td class="org-left">736.2†</td>
<td class="org-left">388.2*</td>
<td class="org-left">377.4†</td>
<td class="org-left">321*ab</td>
<td class="org-left">257*ab</td>
<td class="org-left">192*ab</td>
<td class="org-left">102.8†</td>
<td class="org-left">94.2†</td>
<td class="org-left">43.9†</td>
<td class="org-left">26.8†</td>
<td class="org-left">16.8†</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:theory:cosmic_radiation" class="outline-3">
<h3 id="sec:theory:cosmic_radiation"><span class="section-number-3">6.2.</span> Cosmic rays</h3>
<div id="text-sec:theory:cosmic_radiation" class="outline-text-3">
<p>
Cosmic rays, or cosmic radiation refers to two aspects of a related
phenomenon. Primary cosmic radiation is the radiation arriving at
Earth from the Sun, galactic and extragalactic sources. The main
contribution are highly energetic protons, but other long lived
elementary particles and nuclei also contribute to a lesser
extent. Cosmic rays are isotropic at most energies, because of the
influence of galactic magnetic fields. Their energies range from
\(\SI{1e9}{eV}\) up to \(\SI{1e21}{eV}\). It is generally assumed that
particles below \(\SI{1e18}{eV}\) are of mainly galactic origin, whereas
the above is dominated by extragalactic sources. The flux of the
primary cosmic rays generally follows a power law
distribution. Different contributions follow a generally similar power
law (also see (<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>), chapter on cosmic rays).
</p>

<p>
When cosmic rays interact with the molecules of Earth&apos;s atmosphere,
mesons are produced, mainly pions. Neutral pions generate showers of
photons and electron-positron pairs. Charged pions on the other hand
decay into muons and anti muon-neutrinos. Muons are produced over
electrons in this case, due to chirality. As they are more massive
than electrons they have a larger component of the opposite chirality
to the neutrino, which is necessary for this &apos;forbidden&apos; decay due to
angular momentum conservation.
</p>

<p>
They are produced at an altitude of roughly \(\SI{15}{km}\). A large
fraction of them reaches the surface as they are highly
relativistic. Their spectrum is described by a convolution of the
production energy, their energy loss due to ionization in the
atmosphere and possible decay.
</p>

<p>
Muons are of interest in the context of helioscope experiments, as
they present a dominant source of background, especially in gaseous
detectors (directly and indirectly due to fluorescence). And because
current helioscope experiments are built near Earth&apos;s surface, little
attenuation of muon flux happens. Therefore, a good understanding of
the expected muon flux is required.
</p>

<p>
Above \(\SI{100}{GeV}\) muon decay is negligible. At those energies the
muon flux at the surface strictly follows the same power law as the
primary cosmic ray flux. Following (<a href="./bibliography.html#citeproc_bib_item_92">Gaisser, Engel, and Resconi 2016</a>), in this
regime it can be described by
</p>

\begin{equation}
\label{eq:theory:muon_flux_gaisser}
\frac{\mathrm{d}N_μ}{\mathrm{d}E_μ \mathrm{d}Ω} \approx \frac{0.14
E_μ^{-2.7}}{\si{\centi\meter\squared \second \steradian \giga\electronvolt}} \times \left[ \frac{1}{1 + \frac{1.1
E_μ \cos ϑ}{\SI{115}{GeV}}} + \frac{0.054}{1 + \frac{1.1 E_μ \cos
ϑ}{\SI{850}{GeV}}} \right]
\end{equation}

<p>
where the first term in parenthesis is the pion and the second the
kaon contribution.
</p>

<p>
For lower energies, (<a href="./bibliography.html#citeproc_bib_item_215">Shukla and Sankrith 2018</a>) provide a set
of fitted functions based on \eqref{eq:theory:muon_flux_gaisser} with a
single power law
</p>

<p>
\[
I(E, θ) = I_0 N (E_0 + E)^{-n} \left(1 + \frac{E}{ε}\right)^{-1} D(θ)^{-(n - 1)},
\]
</p>

<p>
where \(I_0\), the intensity under zenith angle \(θ\), and \(ε\) is another
fit parameter for the replacement of the separate meson masses in
eq. \eqref{eq:theory:muon_flux_gaisser}. \(D(θ)\) is the path length through the
atmosphere under an angle \(θ\) from the zenith. \(N\) is a normalization
constant given by
</p>

<p>
\[
N = (n - 1) (E_0 + E_c)^{n-1},
\]
</p>

<p>
where \(n\) corresponds to the effective power of the cosine behavior
and is the final fit parameter. \(E_0\) accounts for the energy loss due
to interactions in the atmosphere and \(E_c\) is the lowest energy given
in a data set.
</p>

<p>
If the Earth is assumed flat, it is \(D(θ) = 1/\cosθ\) (which is often
assumed for simplicity and is a reasonable approximation as long as
only angles close to \(θ = 0\) are considered). To describe a trajectory
through Earth&apos;s curved atmosphere however, \(D(θ)\) can be modified to:
</p>

<p>
\[
D(θ) = \sqrt{
  \left(
    \frac{R²}{d²} \cos² θ + 2\frac{R}{d} + 1
  \right)
} -
  \frac{R}{d}\cos θ
\]
where \(R\) is the Earth radius, \(d\) the vertical path length (i.e. the
height at which the muon is created) and \(θ\) the zenith angle.
</p>

<p>
While this parametrization is very useful to describe the few specific
datasets shown in (<a href="./bibliography.html#citeproc_bib_item_215">Shukla and Sankrith 2018</a>) and provides a
way to fit any measured muon flux at a specific location, it is
limited in applicability to arbitrary locations, altitudes and
angles. For that an approach that does not require a fit to a dataset
is preferable, namely by utilizing a combination of the approximation
by Gaisser, eq. \eqref{eq:theory:muon_flux_gaisser}, and the interaction of
muons with the atmosphere. As such, we modify the equation for the
intensity \(I\) to the following:
</p>

<p>
\[
I(E, θ) = I_0 (n-1) (E_θ(E, θ) + E_c)^{n-1} (E_θ(E, θ) + E)^{-n} \left[ \frac{1}{1 + \frac{1.1
E_μ \cos ϑ}{\SI{115}{GeV}}} + \frac{0.054}{1 + \frac{1.1 E_μ \cos
ϑ}{\SI{850}{GeV}}} \right] D(θ)^{-(n - 1)},
\]
</p>

<p>
where we take \(n = 3\) exactly. One could put in the best fit for the
general cosine behavior under zenith angles, \(n = n_{\text{fit}} + 1\),
but for simplicity we just use 3 here. Take \(E_θ(E, θ)\) to be the
energy of a muon left from initial energy \(E\) at generation in the
upper atmosphere after transporting it through the atmosphere under
the angle \(θ\). The transport must take into account the density change
using the barometric height formula of the atmosphere. Transport is
done using the Bethe-Bloch equation as introduced in
sec. <a href="./theory_detector.html#sec:theory:bethe_bloch">6.1.3</a> assuming an atmosphere made up of
nitrogen, oxygen and argon. As such we remove all parameters except an
initial intensity \(I_0\), which can be set to the best fit of the
integrated muon flux at the zenith angle at sea level. In the
following figures we simply use \(I_0 = \SI{90}{\per\meter\squared
\per\steradian \per\second}\). Figure <a href="#fig:theory:muon_flux_surface">13</a>
shows the expected differential muon flux using these parameters for
different angles at sea level. In
<a href="#fig:theory:muon_flux_surface:initial">13(a)</a> the initial energy of the
muons is shown before transporting through the atmosphere. For each
angle the lines cut off at the energy below which the muon would
likely be stopped by the atmosphere according to its energy loss per
distance or reaches the surface with less than \(\SI{300}{MeV}\). On the
right we see the final energy of the same muons at the surface. The
lines in <a href="#fig:theory:muon_flux_surface:final">13(b)</a> are ragged, because
muon decay is simulated using Monte Carlo. <sup>  <a id="fnr.14" href="#fn.14" class="footref" role="doc-backlink">14</a></sup>
</p>

<p>
These numbers match reasonably well with different datasets for
different locations under different angles, but they should <i>not</i> be
considered as more than a starting point for a general
expectation. However, they are still useful as a reference to consider
when evaluating muon fluxes under different angles at CAST.
</p>


<figure id="fig:theory:muon_flux_surface" class="figure-wrapper">
<figure id="fig:theory:muon_flux_surface:initial" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/muons/initial_energy_vs_flux_and_angle_cosmic_muons.svg" data-width="99%" />  <figcaption>Figure 13(a): Initial energy</figcaption></figure> <figure id="fig:theory:muon_flux_surface:final" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/muons/final_energy_vs_flux_and_angle_cosmic_muons.svg" data-width="99%" />  <figcaption>Figure 13(b): Final energy</figcaption></figure>
<figcaption>Figure 13: Differential muon flux at sea level for different zenith angles. <a href="#fig:theory:muon_flux_surface:initial">13(a)</a> shows the initial energy of the muon. The cutoff corresponds to the
          lowest energy transported through the atmosphere; muons still arrive at the surface without decay or stopping. <a href="#fig:theory:muon_flux_surface:final">13(b)</a> shows the final muon energy at the surface, with the lowest muon $\SI{300}{MeV}$ at the surface. </figcaption>
</figure>
</div>
<div id="outline-container-sec:theory:calc_muon_angular_flux" class="outline-4">
<h4 id="sec:theory:calc_muon_angular_flux"><span class="section-number-4">6.2.1.</span> Calculation of muon angular / energy dependence at surface   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-sec:theory:calc_muon_angular_flux" class="outline-text-4">
<p>
The code here is directly based on code written in my notes
<a href="./../org/Doc/StatusAndProgress.html">./../org/Doc/StatusAndProgress.html</a> being tangled into a file
<code>/tmp/muon_flux.nim</code>.
</p>

<p>
Aside from the figures included in the main thesis, this also produces
fig. <a href="#fig:theory:flux_at_88deg_CAST">14</a>.
</p>


<figure id="fig:theory:flux_at_88deg_CAST">
<img alt="flux_at_cast_88_deg.svg" class="org-svg" src="./figs/home/basti/phd/Figs/muons/flux_at_cast_88_deg.svg" />

<figcaption>Figure 14: <span class="figure-number">Figure 12: </span>Expected muon flux under an angle of \(\SI{88}{°}\) at CAST.</figcaption>
</figure>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> math, macros, unchained
<span style="color: #F92672;">import</span> seqmath, ggplotnim, sequtils, strformat

<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">K</span> = <span style="font-style: italic;">4</span> * π * <span style="color: #66D9EF;">N_A</span> * r_e^<span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">usually in: [MeV mol⁻¹ cm²]</span>

defUnit<span style="color: #AE81FF;">(</span>cm³•g⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">J</span>•m⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>cm⁻³<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>g•mol⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">MeV</span>•g⁻¹•cm²<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>mol⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>keV•cm⁻¹<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>g•cm⁻³<span style="color: #AE81FF;">)</span>
defUnit<span style="color: #AE81FF;">(</span>g•cm⁻²<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">electronDensity</span><span style="color: #AE81FF;">(</span>ρ: g•cm⁻³, <span style="color: #66D9EF;">Z</span>, <span style="color: #66D9EF;">A</span>: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: cm⁻³ =
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">N_A</span> * <span style="color: #66D9EF;">Z</span> * ρ / <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">A</span> * <span style="color: #66D9EF;">M_u</span>.to<span style="color: #66D9EF;">(</span>g•mol⁻¹<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">I</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">](</span>z: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">T</span> =
  <span style="color: #E6DB74;">## use Bloch approximation for all but Argon (better use tabulated values!)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">188.0 eV from NIST table </span>
  <span style="color: #FD971F;">result</span> = <span style="color: #F92672;">if</span> z == <span style="font-style: italic;">18</span>.<span style="font-style: italic;">0</span>: <span style="font-style: italic;">188</span>.<span style="font-style: italic;">0</span>.eV.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">)</span> 
           <span style="color: #F92672;">else</span>: <span style="color: #AE81FF;">(</span><span style="font-style: italic;">10</span>.eV * z<span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">calcβ</span><span style="color: #AE81FF;">(</span>γ: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">UnitLess</span> =
  <span style="color: #FD971F;">result</span> = sqrt<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / <span style="color: #66D9EF;">(</span>γ^<span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">betheBloch</span><span style="color: #AE81FF;">(</span>z, <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>,
                   <span style="color: #66D9EF;">A</span>: g•mol⁻¹,
                   γ: <span style="color: #66D9EF;">UnitLess</span>,
                   <span style="color: #66D9EF;">M</span>: kg<span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">MeV</span>•g⁻¹•cm² =
  <span style="color: #E6DB74;">## result in MeV cm² g⁻¹ (normalized by density)</span>
  <span style="color: #E6DB74;">## z: charge of particle</span>
  <span style="color: #E6DB74;">## Z: charge of particles making up medium</span>
  <span style="color: #E6DB74;">## A: atomic mass of particles making up medium</span>
  <span style="color: #E6DB74;">## γ: Lorentz factor of particle</span>
  <span style="color: #E6DB74;">## M: mass of particle in MeV (or same mass as `</span><span style="color: #AE81FF;">m_e</span><span style="color: #E6DB74;">` defined as)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">β </span>= calcβ<span style="color: #AE81FF;">(</span>γ<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">W_max</span> = <span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> * β^<span style="font-style: italic;">2</span> * γ^<span style="font-style: italic;">2</span> /
    <span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span> + <span style="font-style: italic;">2</span> * γ * m_e / <span style="color: #66D9EF;">M</span> + <span style="color: #66D9EF;">(</span>m_e / <span style="color: #66D9EF;">M</span><span style="color: #66D9EF;">)</span>^<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">lnArg </span>= <span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> * β^<span style="font-style: italic;">2</span> * γ^<span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">W_max</span> / <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">I</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">Joule</span><span style="color: #66D9EF;">](</span><span style="color: #66D9EF;">Z</span><span style="color: #66D9EF;">)</span>^<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">K</span> * z^<span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">Z</span> / <span style="color: #66D9EF;">A</span> * <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / <span style="color: #66D9EF;">(</span>β^<span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span> * <span style="color: #66D9EF;">(</span>
    <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span> * ln<span style="color: #A6E22E;">(</span>lnArg<span style="color: #A6E22E;">)</span> - β^<span style="font-style: italic;">2</span>
  <span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">MeV</span>•g⁻¹•cm²<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">mostProbableLoss</span><span style="color: #AE81FF;">(</span>z, <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>, <span style="color: #66D9EF;">A</span>: g•mol⁻¹, γ: <span style="color: #66D9EF;">UnitLess</span>,
                      x: g•cm⁻²<span style="color: #AE81FF;">)</span>: keV =
  <span style="color: #E6DB74;">## Computes the most probable value, corresponding to the peak of the Landau</span>
  <span style="color: #E6DB74;">## distribution, that gives rise to the Bethe-Bloch formula.</span>
  <span style="color: #E6DB74;">##</span>
  <span style="color: #E6DB74;">## Taken from PDG chapter &apos;Passage of particles through matter&apos; equation</span>
  <span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">34.12</span><span style="color: #E6DB74;">` in &apos;Fluctuations in energy loss&apos;, version 2020).</span>
  <span style="color: #E6DB74;">##</span>
  <span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">x</span><span style="color: #E6DB74;">` is the &quot;thickness&quot;. Density times length, `</span><span style="color: #AE81FF;">x = ρ * d</span><span style="color: #E6DB74;">`. The other parameters</span>
  <span style="color: #E6DB74;">## are as in `</span><span style="color: #AE81FF;">betheBloch</span><span style="color: #E6DB74;">` above.</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">β </span>= calcβ<span style="color: #AE81FF;">(</span>γ<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ξ </span>= <span style="color: #66D9EF;">K</span> / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> * <span style="color: #66D9EF;">Z</span> / <span style="color: #66D9EF;">A</span> * z*z * <span style="color: #AE81FF;">(</span>x / <span style="color: #66D9EF;">(</span>β*β<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">j </span>= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">200</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">I</span> = <span style="color: #66D9EF;">I</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">Joule</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">Z</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>ξ * <span style="color: #66D9EF;">(</span> ln<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">(</span><span style="font-style: italic;">2</span> * m_e * c^<span style="font-style: italic;">2</span> * β^<span style="font-style: italic;">2</span> * γ^<span style="font-style: italic;">2</span><span style="color: #E6DB74;">)</span>.to<span style="color: #E6DB74;">(</span><span style="color: #66D9EF;">Joule</span><span style="color: #E6DB74;">)</span> / <span style="color: #66D9EF;">I</span><span style="color: #A6E22E;">)</span> + ln<span style="color: #A6E22E;">(</span>ξ.to<span style="color: #E6DB74;">(</span><span style="color: #66D9EF;">Joule</span><span style="color: #E6DB74;">)</span> / <span style="color: #66D9EF;">I</span><span style="color: #A6E22E;">)</span> + j - β^<span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>keV<span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">- δ*(β*γ)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">density</span><span style="color: #AE81FF;">(</span>p: mbar, <span style="color: #66D9EF;">M</span>: g•mol⁻¹, temp: <span style="color: #66D9EF;">Kelvin</span><span style="color: #AE81FF;">)</span>: g•cm⁻³ =
  <span style="color: #E6DB74;">## returns the density of the gas for the given pressure.</span>
  <span style="color: #E6DB74;">## The pressure is assumed in `</span><span style="color: #AE81FF;">mbar</span><span style="color: #E6DB74;">` and the temperature (in `</span><span style="color: #AE81FF;">K</span><span style="color: #E6DB74;">`).</span>
  <span style="color: #E6DB74;">## The default temperature corresponds to BabyIAXO aim.</span>
  <span style="color: #E6DB74;">## Returns the density in `</span><span style="color: #AE81FF;">g / cm^3</span><span style="color: #E6DB74;">`</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">gasConstant </span>= <span style="font-style: italic;">8</span>.<span style="font-style: italic;">314</span>.<span style="color: #66D9EF;">J</span>•K⁻¹•mol⁻¹ <span style="color: #75715E;"># </span><span style="color: #75715E;">joule K^-1 mol^-1</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">pressure </span>= p.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Pa</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">pressure in Pa</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">factor 1000 for conversion of M in g / mol to kg / mol</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>pressure * <span style="color: #66D9EF;">M</span> / <span style="color: #66D9EF;">(</span>gasConstant * temp<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>g•cm⁻³<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E</span>: <span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">UnitLess</span> =
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">E</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Joule</span><span style="color: #AE81FF;">)</span> / <span style="color: #AE81FF;">(</span>m_μ * c^<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> + <span style="font-style: italic;">1</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">γ_to_E</span><span style="color: #AE81FF;">(</span>γ: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">GeV</span> =
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>γ - <span style="font-style: italic;">1</span><span style="color: #66D9EF;">)</span> * m_μ * c^<span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">type</span>
  <span style="color: #66D9EF;">Element</span> = <span style="color: #F92672;">object</span>
    <span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>
    <span style="color: #66D9EF;">M</span>: g•mol⁻¹
    <span style="color: #66D9EF;">A</span>: <span style="color: #66D9EF;">UnitLess</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">numerically same as `</span><span style="color: #AE81FF;">M</span><span style="color: #75715E;">`</span>
    ρ: g•cm⁻³
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initElement</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">UnitLess</span>, <span style="color: #66D9EF;">M</span>: g•mol⁻¹, ρ: g•cm⁻³<span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Element</span> =
  <span style="color: #66D9EF;">Element</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Z</span>: <span style="color: #66D9EF;">Z</span>, <span style="color: #66D9EF;">M</span>: <span style="color: #66D9EF;">M</span>, <span style="color: #66D9EF;">A</span>: <span style="color: #66D9EF;">M</span>.<span style="color: #66D9EF;">UnitLess</span>, ρ: ρ<span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">molar mass. Numerically same as relative atomic mass</span>
<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">M_Ar</span> = <span style="font-style: italic;">39</span>.<span style="font-style: italic;">95</span>.g•mol⁻¹
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ρAr </span>= density<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1050</span>.mbar, <span style="color: #66D9EF;">M_Ar</span>, temp = <span style="font-style: italic;">293</span>.<span style="font-style: italic;">15</span>.<span style="color: #66D9EF;">K</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">Argon</span> = initElement<span style="color: #AE81FF;">(</span><span style="font-style: italic;">18</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">UnitLess</span>, <span style="font-style: italic;">39</span>.<span style="font-style: italic;">95</span>.g•mol⁻¹, ρAr<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">intBethe</span><span style="color: #AE81FF;">(</span>e: <span style="color: #66D9EF;">Element</span>, d_total: cm, <span style="color: #66D9EF;">E0</span>: eV, dx = <span style="font-style: italic;">1</span>.μm<span style="color: #AE81FF;">)</span>: eV =
  <span style="color: #E6DB74;">## integrated energy loss of bethe formula after `</span><span style="color: #AE81FF;">d</span><span style="color: #E6DB74;">` cm of matter</span>
  <span style="color: #E6DB74;">## and returns the energy remaining</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">γ</span>: <span style="color: #66D9EF;">UnitLess</span> = <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E0</span>.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">d</span>: cm
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">E0</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">totalLoss </span>= <span style="font-style: italic;">0</span>.eV
  <span style="color: #F92672;">while</span> d &lt; d_total <span style="color: #F92672;">and</span> <span style="color: #FD971F;">result</span> &gt; <span style="font-style: italic;">0</span>.eV:
    <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_loss</span>: <span style="color: #66D9EF;">MeV</span> = betheBloch<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span>, e.<span style="color: #66D9EF;">Z</span>, e.<span style="color: #66D9EF;">M</span>, γ, m_μ<span style="color: #AE81FF;">)</span> * e.ρ * dx
    <span style="color: #FD971F;">result</span> = <span style="color: #FD971F;">result</span> - <span style="color: #66D9EF;">E_loss</span>.to<span style="color: #AE81FF;">(</span>eV<span style="color: #AE81FF;">)</span>
    γ = <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #FD971F;">result</span>.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
    d = d + dx.to<span style="color: #AE81FF;">(</span>cm<span style="color: #AE81FF;">)</span>
    totalLoss = totalLoss + <span style="color: #66D9EF;">E_loss</span>.to<span style="color: #AE81FF;">(</span>eV<span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">float</span>, <span style="color: #FD971F;">result</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>.eV

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotDetectorAbsorption</span><span style="color: #AE81FF;">()</span> =
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_float</span> = logspace<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">2</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= <span style="color: #66D9EF;">E_float</span>.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_loss</span> = energies.mapIt<span style="color: #AE81FF;">(</span>
    <span style="color: #66D9EF;">(</span>it.to<span style="color: #A6E22E;">(</span>eV<span style="color: #A6E22E;">)</span> - intBethe<span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">Argon</span>, <span style="font-style: italic;">3</span>.cm, it.to<span style="color: #E6DB74;">(</span>eV<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>.to<span style="color: #66D9EF;">(</span>keV<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span>
  <span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E_float</span>, <span style="color: #66D9EF;">E_loss</span><span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;E_float&quot;</span>, <span style="color: #E6DB74;">&quot;E_loss&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;μ Energy [GeV]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;ΔE [keV]&quot;</span><span style="color: #AE81FF;">)</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Energy loss of Muons in 3 cm Ar at CAST conditions&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/ar_energy_loss_cast.pdf&quot;</span><span style="color: #AE81FF;">)</span>
plotDetectorAbsorption<span style="color: #AE81FF;">()</span>

<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">Atmosphere</span> = @<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">78084</span>, initElement<span style="color: #A6E22E;">(</span><span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">UnitLess</span>, <span style="font-style: italic;">14</span>.<span style="font-style: italic;">006</span>.g•mol⁻¹, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">2506</span>.g•dm⁻³.to<span style="color: #E6DB74;">(</span>g•cm⁻³<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>, <span style="color: #75715E;"># </span><span style="color: #75715E;">N2</span>
                   <span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">20964</span>, initElement<span style="color: #A6E22E;">(</span><span style="font-style: italic;">8</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">UnitLess</span>, <span style="font-style: italic;">15</span>.<span style="font-style: italic;">999</span>.g•mol⁻¹, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">429</span>.g•dm⁻³.to<span style="color: #E6DB74;">(</span>g•cm⁻³<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>,  <span style="color: #75715E;"># </span><span style="color: #75715E;">O2</span>
                   <span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">00934</span>, initElement<span style="color: #A6E22E;">(</span><span style="font-style: italic;">18</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">UnitLess</span>, <span style="font-style: italic;">39</span>.<span style="font-style: italic;">95</span>.g•mol⁻¹, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">784</span>.g•dm⁻³.to<span style="color: #E6DB74;">(</span>g•cm⁻³<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span>  <span style="color: #75715E;"># </span><span style="color: #75715E;">Ar</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotMuonBethe</span><span style="color: #AE81FF;">()</span> =
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_float</span> = logspace<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">2</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= <span style="color: #66D9EF;">E_float</span>.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dEdxs </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">for</span> e <span style="color: #F92672;">in</span> energies:
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dEdx </span>= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">MeV</span>•g⁻¹•cm²
    <span style="color: #F92672;">for</span> elTup <span style="color: #F92672;">in</span> <span style="color: #66D9EF;">Atmosphere</span>:
      <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>w, element<span style="color: #AE81FF;">)</span> = elTup
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">γ </span>= <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span>e<span style="color: #AE81FF;">)</span>
      dEdx += w * betheBloch<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span>, element.<span style="color: #66D9EF;">Z</span>, element.<span style="color: #66D9EF;">M</span>, γ, m_μ<span style="color: #AE81FF;">)</span>
    dEdxs.<span style="color: #F92672;">add</span> dEdx.<span style="color: #66D9EF;">float</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E_float</span>, dEdxs<span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;E_float&quot;</span>, <span style="color: #E6DB74;">&quot;dEdxs&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;μ Energy [GeV]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;dE/dx [MeV•g⁻¹•cm²]&quot;</span><span style="color: #AE81FF;">)</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Energy loss of Muons in atmosphere&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/energy_loss_muons_atmosphere.pdf&quot;</span><span style="color: #AE81FF;">)</span>  
plotMuonBethe<span style="color: #AE81FF;">()</span>
<span style="color: #75715E;">#</span><span style="color: #75715E;">if true: quit()</span>
<span style="color: #F92672;">import</span> math, unchained, ggplotnim, sequtils

<span style="color: #F92672;">const</span> <span style="color: #66D9EF;">R_Earth</span> = <span style="font-style: italic;">6371</span>.km
<span style="color: #F92672;">func</span> <span style="color: #A6E22E;">distanceAtmosphere</span><span style="color: #AE81FF;">(</span>θ: <span style="color: #66D9EF;">Radian</span>, d: <span style="color: #66D9EF;">KiloMeter</span> = <span style="font-style: italic;">36</span>.<span style="font-style: italic;">6149</span>.km<span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">UnitLess</span> =
  <span style="color: #E6DB74;">## NOTE: The default value for `</span><span style="color: #AE81FF;">d</span><span style="color: #E6DB74;">` is not to be understood as a proper height. It.s an</span>
  <span style="color: #E6DB74;">## approximation based on a fit to get `</span><span style="color: #AE81FF;">R_Earth / d = 174</span><span style="color: #E6DB74;">`!</span>
  <span style="color: #FD971F;">result</span> = sqrt<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">R_Earth</span> / d * cos<span style="color: #A6E22E;">(</span>θ<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>^<span style="font-style: italic;">2</span> + <span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">R_Earth</span> / d + <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> - <span style="color: #66D9EF;">R_Earth</span> / d * cos<span style="color: #AE81FF;">(</span>θ<span style="color: #AE81FF;">)</span>

defUnit<span style="color: #AE81FF;">(</span>cm⁻²•s⁻¹•sr⁻¹<span style="color: #AE81FF;">)</span>  
defUnit<span style="color: #AE81FF;">(</span>m⁻²•s⁻¹•sr⁻¹<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">muonFlux</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E</span>: <span style="color: #66D9EF;">GeV</span>, θ: <span style="color: #66D9EF;">Radian</span>, E₀, <span style="color: #66D9EF;">E_c</span>: <span style="color: #66D9EF;">GeV</span>,
              I₀: m⁻²•s⁻¹•sr⁻¹,
              ε: <span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>: m⁻²•s⁻¹•sr⁻¹ =
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">n </span>= <span style="font-style: italic;">3</span>.<span style="font-style: italic;">0</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">N</span> = <span style="color: #AE81FF;">(</span>n - <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> * pow<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>E₀ + <span style="color: #66D9EF;">E_c</span><span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span>, n - <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = I₀ * <span style="color: #66D9EF;">N</span> * pow<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>E₀ + <span style="color: #66D9EF;">E</span><span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span>, -n<span style="color: #AE81FF;">)</span> *
    <span style="color: #75715E;">#</span><span style="color: #75715E;">pow((1 + E / ε).float, -1) *</span>
    <span style="color: #AE81FF;">(</span> <span style="color: #66D9EF;">(</span> <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / <span style="color: #A6E22E;">(</span><span style="font-style: italic;">1</span> + <span style="font-style: italic;">1</span>.<span style="font-style: italic;">1</span> * <span style="color: #66D9EF;">E</span> * cos<span style="color: #E6DB74;">(</span>θ<span style="color: #E6DB74;">)</span> / <span style="font-style: italic;">115</span>.<span style="color: #66D9EF;">GeV</span><span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">)</span> + <span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">054</span> / <span style="color: #A6E22E;">(</span><span style="font-style: italic;">1</span> + <span style="font-style: italic;">1</span>.<span style="font-style: italic;">1</span> * <span style="color: #66D9EF;">E</span> * cos<span style="color: #E6DB74;">(</span>θ<span style="color: #E6DB74;">)</span> / <span style="font-style: italic;">850</span>.<span style="color: #66D9EF;">GeV</span><span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">)</span> <span style="color: #AE81FF;">)</span> * 
    pow<span style="color: #AE81FF;">(</span>distanceAtmosphere<span style="color: #66D9EF;">(</span>θ<span style="color: #66D9EF;">)</span>, -<span style="color: #66D9EF;">(</span>n - <span style="font-style: italic;">1</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">from</span> numericalnim/integrate <span style="color: #F92672;">import</span> simpson
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotE_vs_flux</span><span style="color: #AE81FF;">(</span>θ: <span style="color: #66D9EF;">Radian</span>, E₀, <span style="color: #66D9EF;">E_c</span>: <span style="color: #66D9EF;">GeV</span>, I₀: m⁻²•s⁻¹•sr⁻¹, ε: <span style="color: #66D9EF;">GeV</span>,
                   suffix = <span style="color: #E6DB74;">&quot;&quot;</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= linspace<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E_c</span>.<span style="color: #66D9EF;">float</span>, <span style="font-style: italic;">100</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E</span> = energies.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">flux </span>= <span style="color: #66D9EF;">E</span>.mapIt<span style="color: #AE81FF;">(</span>muonFlux<span style="color: #66D9EF;">(</span>it, θ, E₀, <span style="color: #66D9EF;">E_c</span>, I₀, ε<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">.to(cm⁻²•s⁻¹•sr⁻¹)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>energies, flux<span style="color: #AE81FF;">)</span>

  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Integrated flux: &quot;</span>, simpson<span style="color: #AE81FF;">(</span>flux, energies<span style="color: #AE81FF;">)</span>
  
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;flux&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Energy [GeV]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Flux [m⁻²•s⁻¹•sr⁻¹]&quot;</span><span style="color: #AE81FF;">)</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
    ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Flux dependency on the energy of muons at θ = {θ.to(°)}{suffix}&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/energy_vs_flux_cosmic_muons{suffix}.pdf&quot;</span><span style="color: #AE81FF;">)</span>
plotE_vs_flux<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">Radian</span>,
              <span style="font-style: italic;">2</span>.<span style="font-style: italic;">5</span>.<span style="color: #66D9EF;">GeV</span>, <span style="color: #75715E;">#</span><span style="color: #75715E;">4.29.GeV,</span>
              <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>.<span style="color: #66D9EF;">GeV</span>, <span style="font-style: italic;">70</span>.<span style="font-style: italic;">7</span>.m⁻²•s⁻¹•sr⁻¹, <span style="font-style: italic;">854</span>.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>


<span style="color: #F92672;">let</span> <span style="color: #FD971F;">E</span>₀ = <span style="font-style: italic;">25</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">GeV</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">I</span>₀ = <span style="font-style: italic;">90</span>.<span style="font-style: italic;">0</span>.m⁻²•s⁻¹•sr⁻¹
<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_c</span> = <span style="font-style: italic;">1</span>.<span style="color: #66D9EF;">GeV</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ε </span>= <span style="font-style: italic;">2000</span>.<span style="color: #66D9EF;">GeV</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotFlux_at_CAST</span><span style="color: #AE81FF;">()</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= linspace<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, <span style="font-style: italic;">100</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E</span> = energies.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">flux </span>= <span style="color: #66D9EF;">E</span>.mapIt<span style="color: #AE81FF;">(</span>muonFlux<span style="color: #66D9EF;">(</span>it, <span style="font-style: italic;">88</span>.<span style="font-style: italic;">0</span>.degToRad.<span style="color: #66D9EF;">Radian</span>, E₀, <span style="color: #66D9EF;">E_c</span>, I₀, ε<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>energies, flux<span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;flux&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Energy [GeV]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Flux [m⁻²•s⁻¹•sr⁻¹]&quot;</span><span style="color: #AE81FF;">)</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Flux dependency on the energy at θ = 88° at CAST altitude&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/flux_at_cast_88_deg.pdf&quot;</span><span style="color: #AE81FF;">)</span>
plotFlux_at_CAST<span style="color: #AE81FF;">()</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">computeMeanEnergyLoss</span><span style="color: #AE81FF;">()</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= linspace<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, <span style="font-style: italic;">100</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E</span> = energies.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">flux </span>= <span style="color: #66D9EF;">E</span>.mapIt<span style="color: #AE81FF;">(</span>muonFlux<span style="color: #66D9EF;">(</span>
    it, <span style="font-style: italic;">88</span>.<span style="font-style: italic;">0</span>.degToRad.<span style="color: #66D9EF;">Radian</span>, E₀, <span style="color: #66D9EF;">E_c</span>, I₀, ε<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span>
  <span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_loss</span> = <span style="color: #66D9EF;">E</span>.mapIt<span style="color: #AE81FF;">(</span>
    <span style="color: #66D9EF;">(</span>it.to<span style="color: #A6E22E;">(</span>eV<span style="color: #A6E22E;">)</span> - intBethe<span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">Argon</span>, <span style="font-style: italic;">3</span>.cm, it.to<span style="color: #E6DB74;">(</span>eV<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>.to<span style="color: #66D9EF;">(</span>keV<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span>
  <span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fluxSum </span>= flux.sum
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>energies, <span style="color: #66D9EF;">E_loss</span>, flux<span style="color: #AE81FF;">)</span>
      .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;flux&quot;</span> ~ `flux` / fluxSum<span style="color: #66D9EF;">}</span>,
              f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;AdjFlux&quot;</span> ~ `<span style="color: #66D9EF;">E_loss</span>` * `flux`<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Mean energy loss: &quot;</span>, df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;AdjFlux&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.sum
computeMeanEnergyLoss<span style="color: #AE81FF;">()</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">computeHeight</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">S</span>: <span style="color: #66D9EF;">Meter</span>, θ: <span style="color: #66D9EF;">Radian</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">KiloMeter</span> =
  <span style="color: #E6DB74;">## For given remaining distance distance along the path of a muon</span>
  <span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">S</span><span style="color: #E6DB74;">` (see fig. 1 in 1606.06907) computes the remaining height above</span>
  <span style="color: #E6DB74;">## ground. Formula is the result of inverting eq. 7 to `</span><span style="color: #AE81FF;">d</span><span style="color: #E6DB74;">` using quadratic</span>
  <span style="color: #E6DB74;">## formula. Positive result, because negative is negative.</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> * <span style="color: #66D9EF;">R_Earth</span> + sqrt<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">R_Earth</span>^<span style="font-style: italic;">2</span> + <span style="color: #66D9EF;">S</span>^<span style="font-style: italic;">2</span> + <span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">S</span> * <span style="color: #66D9EF;">R_Earth</span> * cos<span style="color: #A6E22E;">(</span>θ<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>.m<span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>km<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">import</span> algorithm
defUnit<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">K</span>•m⁻¹<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">barometricFormula</span><span style="color: #AE81FF;">(</span>h: <span style="color: #66D9EF;">KiloMeter</span><span style="color: #AE81FF;">)</span>: g•cm⁻³ =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">hs </span>= @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>.km, <span style="font-style: italic;">11</span>.<span style="font-style: italic;">0</span>.km<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ρs </span>= @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">225</span>.kg•m⁻³, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">36391</span>.kg•m⁻³<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">Ts</span> = @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">288</span>.<span style="font-style: italic;">15</span>.<span style="color: #66D9EF;">K</span>, <span style="font-style: italic;">216</span>.<span style="font-style: italic;">65</span>.<span style="color: #66D9EF;">K</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">Ls</span> = @<span style="color: #AE81FF;">[</span>-<span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> * <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0065</span>.<span style="color: #66D9EF;">K</span>•m⁻¹, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">K</span>•m⁻¹<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">M_air</span> = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0289644</span>.kg•mol⁻¹
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">R</span> = <span style="font-style: italic;">8</span>.<span style="font-style: italic;">3144598</span>.<span style="color: #66D9EF;">N</span>•m•mol⁻¹•K⁻¹
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">g_0 </span>= <span style="font-style: italic;">9</span>.<span style="font-style: italic;">80665</span>.m•s⁻²
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">idx </span>= hs.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>.lowerBound<span style="color: #AE81FF;">(</span>h.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span> - <span style="font-style: italic;">1</span>
  <span style="color: #F92672;">case</span> idx
  <span style="color: #F92672; font-style: italic;">of</span> <span style="font-style: italic;">0</span>:
    <span style="color: #75715E;"># </span><span style="color: #75715E;">in Troposphere, using regular barometric formula for denities</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">expArg </span>= g_0 * <span style="color: #66D9EF;">M_air</span> / <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">R</span> * <span style="color: #66D9EF;">Ls</span><span style="color: #66D9EF;">[</span>idx<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
    <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>ρs<span style="color: #66D9EF;">[</span>idx<span style="color: #66D9EF;">]</span> * pow<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Ts</span><span style="color: #A6E22E;">[</span>idx<span style="color: #A6E22E;">]</span> / <span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">Ts</span><span style="color: #E6DB74;">[</span>idx<span style="color: #E6DB74;">]</span> + <span style="color: #66D9EF;">Ls</span><span style="color: #E6DB74;">[</span>idx<span style="color: #E6DB74;">]</span> * <span style="color: #E6DB74;">(</span>h - hs<span style="color: #FD971F;">[</span>idx<span style="color: #FD971F;">]</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span>, expArg<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>g•cm⁻³<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672; font-style: italic;">of</span> <span style="font-style: italic;">1</span>:
    <span style="color: #75715E;"># </span><span style="color: #75715E;">in Tropopause, use equation valid for L_b = 0</span>
    <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>ρs<span style="color: #66D9EF;">[</span>idx<span style="color: #66D9EF;">]</span> * exp<span style="color: #66D9EF;">(</span>-<span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> * g_0 * <span style="color: #66D9EF;">M_air</span> * <span style="color: #A6E22E;">(</span>h - hs<span style="color: #E6DB74;">[</span>idx<span style="color: #E6DB74;">]</span><span style="color: #A6E22E;">)</span> / <span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">R</span> * <span style="color: #66D9EF;">Ts</span><span style="color: #E6DB74;">[</span>idx<span style="color: #E6DB74;">]</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>g•cm⁻³<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">else</span>: <span style="color: #F92672;">doAssert</span> <span style="color: #AE81FF;">false</span>, <span style="color: #E6DB74;">&quot;Invalid height! Outside of range!&quot;</span>

<span style="color: #F92672;">import</span> random
randomize<span style="color: #AE81FF;">(</span><span style="font-style: italic;">430</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">intBetheAtmosphere</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E</span>: <span style="color: #66D9EF;">GeV</span>, θ: <span style="color: #66D9EF;">Radian</span>, dx = <span style="font-style: italic;">10</span>.cm<span style="color: #AE81FF;">)</span>: eV =
  <span style="color: #E6DB74;">## integrated energy loss using Bethe formula for muons generated at</span>
  <span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">15.km</span><span style="color: #E6DB74;">` under an angle of `</span><span style="color: #AE81FF;">θ</span><span style="color: #E6DB74;">` to the observer for a muon of energy</span>
  <span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">E</span><span style="color: #E6DB74;">`.</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">Main contributions in Earth&apos;s atmosphere</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">τ </span>= <span style="font-style: italic;">2</span>.<span style="font-style: italic;">19618</span>.μs <span style="color: #75715E;"># </span><span style="color: #75715E;">muon half life</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">elements </span>= <span style="color: #66D9EF;">Atmosphere</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">γ</span>: <span style="color: #66D9EF;">UnitLess</span> = <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E</span>.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">E</span>.to<span style="color: #AE81FF;">(</span>eV<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">totalLoss </span>= <span style="font-style: italic;">0</span>.eV
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">h_muon </span>= <span style="font-style: italic;">15</span>.km <span style="color: #75715E;"># </span><span style="color: #75715E;">assume creation happens in `</span><span style="color: #AE81FF;">15.km</span><span style="color: #75715E;">`</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">S</span> = h_muon.to<span style="color: #AE81FF;">(</span>m<span style="color: #AE81FF;">)</span> * distanceAtmosphere<span style="color: #AE81FF;">(</span>θ.rad, d = h_muon<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #66D9EF;">S_prime</span> = <span style="color: #66D9EF;">S</span>
  <span style="color: #F92672;">while</span> <span style="color: #66D9EF;">S_prime</span> &gt; <span style="font-style: italic;">0</span>.m <span style="color: #F92672;">and</span> <span style="color: #FD971F;">result</span> &gt; <span style="font-style: italic;">0</span>.eV:
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">h </span>= computeHeight<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">S_prime</span>, θ<span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ρ_at_h </span>= barometricFormula<span style="color: #AE81FF;">(</span>h<span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">var</span> <span style="color: #66D9EF;">E_loss</span> = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">MeV</span>
    <span style="color: #F92672;">for</span> eTup <span style="color: #F92672;">in</span> elements: <span style="color: #75715E;"># </span><span style="color: #75715E;">compute the weighted contribution of the element fraction</span>
      <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>w, e<span style="color: #AE81FF;">)</span> = eTup
      <span style="color: #66D9EF;">E_loss</span> += w * betheBloch<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span>, e.<span style="color: #66D9EF;">Z</span>, e.<span style="color: #66D9EF;">M</span>, γ, m_μ<span style="color: #AE81FF;">)</span> * ρ_at_h * dx

    <span style="color: #E6DB74;">## Add step for radioactive decay of muon.</span>
    <span style="color: #E6DB74;">## - given `</span><span style="color: #AE81FF;">dx</span><span style="color: #E6DB74;">` compute likelihood of decay</span>
    <span style="color: #E6DB74;">## - eigen time of muon: dx / v = dt. dτ = dt / γ</span>
    <span style="color: #E6DB74;">## - muon decay is λ = 1 / 2.2e-6s</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">β </span>= calcβ<span style="color: #AE81FF;">(</span>γ<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">compute effective time in lab frame</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">δt </span>= dx / <span style="color: #AE81FF;">(</span>β * c<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">compute eigen time</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">δτ </span>= δt / γ
    <span style="color: #75715E;"># </span><span style="color: #75715E;">probability of a decay in this time frame</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">p </span>= pow<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span> / math.<span style="color: #66D9EF;">E</span>, δτ / τ<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">decay with likelihood `</span><span style="color: #AE81FF;">p</span><span style="color: #75715E;">`</span>
    <span style="color: #75715E;">#</span><span style="color: #75715E;">echo &quot;γ = &quot;, γ, &quot; yields &quot;, p, &quot; in δτ &quot;, δτ, &quot; for energy &quot;, E</span>
    <span style="color: #F92672;">if</span> rand<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> &lt; <span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - p<span style="color: #AE81FF;">)</span>:
      <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Particle decayed after: &quot;</span>, <span style="color: #66D9EF;">S_prime</span>
      <span style="color: #F92672;">return</span> <span style="font-style: italic;">0</span>.eV
          
    <span style="color: #FD971F;">result</span> = <span style="color: #FD971F;">result</span> - <span style="color: #66D9EF;">E_loss</span>.to<span style="color: #AE81FF;">(</span>eV<span style="color: #AE81FF;">)</span>
    <span style="color: #66D9EF;">S_prime</span> = <span style="color: #66D9EF;">S_prime</span> - dx
    γ = <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="color: #FD971F;">result</span>.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
    totalLoss = totalLoss + <span style="color: #66D9EF;">E_loss</span>.to<span style="color: #AE81FF;">(</span>eV<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;total Loss &quot;</span>, totalLoss.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">float</span>, <span style="color: #FD971F;">result</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>.eV

<span style="color: #F92672;">block</span> <span style="color: #66D9EF;">MuonLimits</span>:
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">τ_μ </span>= <span style="font-style: italic;">2</span>.<span style="font-style: italic;">1969811</span>.μs
  <span style="color: #75715E;"># </span><span style="color: #75715E;">naively this means given some distance `</span><span style="color: #AE81FF;">s</span><span style="color: #75715E;">` the muon can</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">traverse `</span><span style="color: #AE81FF;">s = c • τ_μ</span><span style="color: #75715E;">` (approximating its speed by `</span><span style="color: #AE81FF;">c</span><span style="color: #75715E;">`) before</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">it has decayed with a 1/e chance</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">due to special relativity this is extended by γ</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">s </span>= c * τ_μ
  <span style="color: #F92672;">echo</span> s
  <span style="color: #75715E;"># </span><span style="color: #75715E;">given production in 15 km, means</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">h </span>= <span style="font-style: italic;">15</span>.km
  <span style="color: #F92672;">echo</span> h / s
  <span style="color: #75715E;"># </span><span style="color: #75715E;">so a reduction of (1/e)^22. So 0.</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">now it&apos;s not 15 km but under an angle `</span><span style="color: #AE81FF;">θ = 88°</span><span style="color: #75715E;">`.</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">R_over_d</span> = <span style="font-style: italic;">174</span>.<span style="color: #66D9EF;">UnitLess</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">n </span>= <span style="font-style: italic;">3</span>.<span style="font-style: italic;">0</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">E</span>₀ = <span style="font-style: italic;">25</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">GeV</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">I</span>₀ = <span style="font-style: italic;">90</span>.<span style="font-style: italic;">0</span>.m⁻²•s⁻¹•sr⁻¹
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_c</span> = <span style="font-style: italic;">1</span>.<span style="color: #66D9EF;">GeV</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ε </span>= <span style="font-style: italic;">2000</span>.<span style="color: #66D9EF;">GeV</span>

  <span style="color: #75715E;"># </span><span style="color: #75715E;">distance atmospher gives S / d, where `</span><span style="color: #AE81FF;">d</span><span style="color: #75715E;">` corresponds to our `</span><span style="color: #AE81FF;">h</span><span style="color: #75715E;">` up there</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">S</span> = h * distanceAtmosphere<span style="color: #AE81FF;">(</span><span style="font-style: italic;">88</span>.<span style="font-style: italic;">0</span>.degToRad.rad<span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">so about 203 km</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">so let&apos;s say 5 * mean distance is ok, means we ned</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">S_max</span> = <span style="color: #66D9EF;">S</span> / <span style="font-style: italic;">5</span>.<span style="font-style: italic;">0</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">so need a `</span><span style="color: #AE81FF;">γ</span><span style="color: #75715E;">` such that `</span><span style="color: #AE81FF;">s</span><span style="color: #75715E;">` is stretched to `</span><span style="color: #AE81FF;">S_max</span><span style="color: #75715E;">`</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">γ </span>= <span style="color: #66D9EF;">S_max</span> / s
  <span style="color: #F92672;">echo</span> γ
  <span style="color: #75715E;"># </span><span style="color: #75715E;">ouch. Something has to be wrong. γ of 61?</span>

  <span style="color: #75715E;"># </span><span style="color: #75715E;">corresponds to an energy loss of what?</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">Nitrogen</span> = initElement<span style="color: #AE81FF;">(</span><span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">UnitLess</span>, <span style="font-style: italic;">14</span>.<span style="font-style: italic;">006</span>.g•mol⁻¹, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">2506</span>.g•dm⁻³.to<span style="color: #66D9EF;">(</span>g•cm⁻³<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;================================================================================&quot;</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Energy left: &quot;</span>, intBethe<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Nitrogen</span>, <span style="color: #66D9EF;">S</span>.to<span style="color: #66D9EF;">(</span>cm<span style="color: #66D9EF;">)</span>, <span style="font-style: italic;">6</span>.<span style="color: #66D9EF;">GeV</span>.to<span style="color: #66D9EF;">(</span>eV<span style="color: #66D9EF;">)</span>, dx = <span style="font-style: italic;">1</span>.m.to<span style="color: #66D9EF;">(</span>μm<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">print</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E</span>: <span style="color: #66D9EF;">GeV</span>, θ: <span style="color: #66D9EF;">Radian</span><span style="color: #AE81FF;">)</span> =
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">left </span>= intBetheAtmosphere<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E</span>, θ = θ<span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;E = &quot;</span>, <span style="color: #66D9EF;">E</span>, <span style="color: #E6DB74;">&quot;, θ = &quot;</span>, θ, <span style="color: #E6DB74;">&quot;, Bethe = &quot;</span>, <span style="color: #66D9EF;">E</span> - left
  print<span style="color: #AE81FF;">(</span><span style="font-style: italic;">6</span>.<span style="color: #66D9EF;">GeV</span>, <span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">Radian</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">print(200.GeV, 0.Radian)  </span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">print(200.GeV, 88.°.to(Radian))</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">print(200.GeV, 75.°.to(Radian))</span>

  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_loss75</span> = <span style="font-style: italic;">100</span>.<span style="color: #66D9EF;">GeV</span> - intBetheAtmosphere<span style="color: #AE81FF;">(</span><span style="font-style: italic;">100</span>.<span style="color: #66D9EF;">GeV</span>, <span style="font-style: italic;">75</span>.°.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Radian</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  plotE_vs_flux<span style="color: #AE81FF;">(</span><span style="font-style: italic;">75</span>.°.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Radian</span><span style="color: #66D9EF;">)</span>,
                <span style="color: #66D9EF;">E_loss75</span>, <span style="color: #75715E;">#</span><span style="color: #75715E;">23.78.GeV, #25.GeV, #E_loss75,</span>
                <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">GeV</span>,
                <span style="font-style: italic;">90</span>.m⁻²•s⁻¹•sr⁻¹, <span style="color: #75715E;">#</span><span style="color: #75715E;">65.2.m⁻²•s⁻¹•sr⁻¹,</span>
                <span style="font-style: italic;">2000</span>.<span style="color: #66D9EF;">GeV</span>, <span style="color: #75715E;"># </span><span style="color: #75715E;">854.GeV,</span>
                <span style="color: #E6DB74;">&quot;_at_75deg&quot;</span><span style="color: #AE81FF;">)</span>

  
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;S@75° = &quot;</span>, h * distanceAtmosphere<span style="color: #AE81FF;">(</span><span style="font-style: italic;">75</span>.<span style="font-style: italic;">0</span>.degToRad.rad, d = <span style="font-style: italic;">15</span>.<span style="font-style: italic;">0</span>.km<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;================================================================================&quot;</span>  
<span style="color: #F92672;">echo</span> <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="font-style: italic;">4</span>.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> <span style="color: #66D9EF;">E_to_γ</span><span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotE_vs_flux_and_angles</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E_c</span>: <span style="color: #66D9EF;">GeV</span>, I₀: m⁻²•s⁻¹•sr⁻¹, ε: <span style="color: #66D9EF;">GeV</span>,
                              suffix = <span style="color: #E6DB74;">&quot;&quot;</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #E6DB74;">## Generates a plot of the muon flux vs energy for a fixed set of different</span>
  <span style="color: #E6DB74;">## angles.</span>
  <span style="color: #E6DB74;">##</span>
  <span style="color: #E6DB74;">## The energy loss is computed using a fixed </span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= logspace<span style="color: #AE81FF;">(</span>log10<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">E_c</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">)</span>, <span style="font-style: italic;">2</span>.<span style="color: #66D9EF;">float</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">angles </span>= linspace<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">80</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">9</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">block</span> <span style="color: #66D9EF;">CalcLossEachMuon</span>:
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>
    <span style="color: #F92672;">for</span> angle <span style="color: #F92672;">in</span> angles:
      <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E</span> = energies.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">θ </span>= angle.°.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Radian</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">var</span> <span style="color: #FD971F;">flux </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
      <span style="color: #F92672;">var</span> <span style="color: #66D9EF;">E_initials</span> = <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
      <span style="color: #F92672;">var</span> <span style="color: #66D9EF;">E_lefts</span> = <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
      <span style="color: #F92672;">var</span> <span style="color: #FD971F;">lastDropped </span>= <span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">GeV</span>
      <span style="color: #F92672;">for</span> e <span style="color: #F92672;">in</span> <span style="color: #66D9EF;">E</span>:
        <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_left</span> = intBetheAtmosphere<span style="color: #AE81FF;">(</span>e, θ<span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
        <span style="color: #F92672;">if</span> <span style="color: #66D9EF;">E_left</span> &lt;= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">GeV</span>:
          <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Skipping energy : &quot;</span>, e, <span style="color: #E6DB74;">&quot; as muon was lost in atmosphere&quot;</span>
          <span style="color: #F92672;">continue</span>
        <span style="color: #F92672;">elif</span> <span style="color: #66D9EF;">E_left</span> &lt;= <span style="color: #66D9EF;">E_c</span>:
          <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Skipping energy : &quot;</span>, e, <span style="color: #E6DB74;">&quot; as muon has less than E_c = &quot;</span>, <span style="color: #66D9EF;">E_c</span>, <span style="color: #E6DB74;">&quot; energy left&quot;</span>
          lastDropped = e
          <span style="color: #F92672;">continue</span>
        <span style="color: #F92672;">let</span> <span style="color: #FD971F;">E</span>₀ = e - <span style="color: #66D9EF;">E_left</span>
        flux.<span style="color: #F92672;">add</span> muonFlux<span style="color: #AE81FF;">(</span>e, θ, E₀, <span style="color: #66D9EF;">E_c</span>, I₀, ε<span style="color: #AE81FF;">)</span>.<span style="color: #66D9EF;">float</span>
        <span style="color: #66D9EF;">E_initials</span>.<span style="color: #F92672;">add</span> e.<span style="color: #66D9EF;">float</span>        
        <span style="color: #66D9EF;">E_lefts</span>.<span style="color: #F92672;">add</span> <span style="color: #66D9EF;">E_left</span>.<span style="color: #66D9EF;">float</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfLoc </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">E_initials</span>, <span style="color: #66D9EF;">E_lefts</span>, flux, <span style="color: #E6DB74;">&quot;angle [°]&quot;</span> : angle<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
      <span style="color: #75715E;">#  </span><span style="color: #75715E;">.filter(f{`</span><span style="color: #AE81FF;">E_initials</span><span style="color: #75715E;">` &gt;= lastDropped.float})</span>
      df.<span style="color: #F92672;">add</span> dfLoc

    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">theme </span>= themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">600</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span>
    theme.tickWidth = some<span style="color: #AE81FF;">(</span>theme.tickWidth.get / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    theme.tickLength = some<span style="color: #AE81FF;">(</span>theme.tickLength.get / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>    
    theme.gridLineWidth = some<span style="color: #AE81FF;">(</span>theme.gridLineWidth.get / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>    
    ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;E_initials&quot;</span>, <span style="color: #E6DB74;">&quot;flux&quot;</span>, color = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;angle [°]&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
      geom_line<span style="color: #AE81FF;">()</span> +
      xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Initial energy [\si{GeV}]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Flux [\si{m^{-2}.s^{-1}.sr^{-1}}]&quot;</span>, margin = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> +
      scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
      margin<span style="color: #AE81FF;">(</span>right = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + 
      ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Muon flux at different angles{suffix}&quot;</span><span style="color: #AE81FF;">)</span> +
      theme + 
      ggsave<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/initial_energy_vs_flux_and_angle_cosmic_muons{suffix}.pdf&quot;</span>,
             useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">450</span><span style="color: #AE81FF;">)</span>
  
    ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;E_lefts&quot;</span>, <span style="color: #E6DB74;">&quot;flux&quot;</span>, color = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;angle [°]&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
      geom_line<span style="color: #AE81FF;">()</span> +
      xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Energy at surface [\si{GeV}]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Flux [\si{m^{-2}.s^{-1}.sr^{-1}}]&quot;</span>, margin = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> +
      scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
      margin<span style="color: #AE81FF;">(</span>right = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +       
      theme + 
      ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Muon flux at different angles{suffix}&quot;</span><span style="color: #AE81FF;">)</span> +
      ggsave<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/final_energy_vs_flux_and_angle_cosmic_muons{suffix}.pdf&quot;</span>,
             useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">450</span><span style="color: #AE81FF;">)</span>              
  <span style="color: #F92672;">block</span> <span style="color: #66D9EF;">StaticLoss</span>:
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>
    <span style="color: #F92672;">for</span> angle <span style="color: #F92672;">in</span> angles:
      <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E</span> = energies.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">θ </span>= angle.°.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Radian</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">E</span>₀ = <span style="font-style: italic;">100</span>.<span style="color: #66D9EF;">GeV</span> - intBetheAtmosphere<span style="color: #AE81FF;">(</span><span style="font-style: italic;">100</span>.<span style="color: #66D9EF;">GeV</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>.<span style="color: #66D9EF;">Radian</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>    
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">flux </span>= <span style="color: #66D9EF;">E</span>.mapIt<span style="color: #AE81FF;">(</span>muonFlux<span style="color: #66D9EF;">(</span>it, θ, E₀, <span style="color: #66D9EF;">E_c</span>, I₀, ε<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfLoc </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span>energies, flux, <span style="color: #E6DB74;">&quot;angle [°]&quot;</span> : angle<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
      df.<span style="color: #F92672;">add</span> dfLoc
    ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;flux&quot;</span>, color = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;angle [°]&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
      geom_line<span style="color: #AE81FF;">()</span> +
      xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Energy [GeV]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Flux [m⁻²•s⁻¹•sr⁻¹]&quot;</span><span style="color: #AE81FF;">)</span> +
      scale_x_log10<span style="color: #AE81FF;">()</span> + scale_y_log10<span style="color: #AE81FF;">()</span> +
      ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Differential muon flux dependency at different angles{suffix}&quot;</span><span style="color: #AE81FF;">)</span> +
      ggsave<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/energy_vs_flux_and_angle_cosmic_muons{suffix}.pdf&quot;</span><span style="color: #AE81FF;">)</span>


<span style="color: #75715E;">#</span><span style="color: #75715E;">proc plotE_vs_flux_and_angles(E_c: GeV, I₀: m⁻²•s⁻¹•sr⁻¹, ε: GeV,</span>
<span style="color: #75715E;">#                              </span><span style="color: #75715E;">suffix = &quot;&quot;) =</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">## Generates a plot of the integrated muon flux vs angles for a fixed set of different</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">## energies.</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">let angles = linspace(0.0, 90.0, 100)</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">var df = newDataFrame()</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">let energies = linspace(E_c.float, 100.0, 1000)</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">let E = energies.mapIt(it.GeV)</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">for angle in angles:</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">let θ = angle.°.to(Radian)</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">let E₀ = 100.GeV - intBetheAtmosphere(100.GeV, θ).to(GeV)</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">let flux = E.mapIt(muonFlux(it, θ, E₀, E_c, I₀, ε).float) </span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">let dfLoc = toDf({energies, flux, &quot;angle [°]&quot; : angle})</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">df.add dfLoc</span>
<span style="color: #75715E;">#  </span><span style="color: #75715E;">ggplot(df, aes(&quot;energies&quot;, &quot;flux&quot;, color = factor(&quot;angle [°]&quot;))) +</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">geom_line() +</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">xlab(&quot;Energy [GeV]&quot;) + ylab(&quot;Flux [m⁻²•s⁻¹•sr⁻¹]&quot;) +</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">scale_x_log10() + scale_y_log10() +</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">ggtitle(&amp;&quot;Differential muon flux dependency at different angles{suffix}&quot;) +</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">ggsave(&amp;&quot;/home/basti/phd/Figs/muons/energy_vs_flux_and_angle_cosmic_muons{suffix}.pdf&quot;)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">different angles!      </span>
<span style="color: #F92672;">block</span> <span style="color: #66D9EF;">MuonBehavior</span>:
  plotE_vs_flux_and_angles<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">3</span>.<span style="color: #66D9EF;">GeV</span>, <span style="font-style: italic;">90</span>.m⁻²•s⁻¹•sr⁻¹, <span style="font-style: italic;">854</span>.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">unbinnedCdf</span><span style="color: #AE81FF;">(</span>x: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>: <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span>, <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #E6DB74;">## Computes the CDF of unbinned data</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">cdf </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span>x.<span style="color: #F92672;">len</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">for</span> i <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; x.<span style="color: #F92672;">len</span>:
    cdf<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = i.<span style="color: #66D9EF;">float</span> / x.<span style="color: #F92672;">len</span>.<span style="color: #66D9EF;">float</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>x.sorted, cdf<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">import</span> random, algorithm
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">sampleFlux</span><span style="color: #AE81FF;">(</span>samples = <span style="font-style: italic;">1_000_000</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> =
  randomize<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1337</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= linspace<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>, <span style="font-style: italic;">100</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">100_000</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">let energies = logspace(0, 2, 1000)</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E</span> = energies.mapIt<span style="color: #AE81FF;">(</span>it.<span style="color: #66D9EF;">GeV</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">flux </span>= <span style="color: #66D9EF;">E</span>.mapIt<span style="color: #AE81FF;">(</span>muonFlux<span style="color: #66D9EF;">(</span>it, <span style="font-style: italic;">88</span>.<span style="font-style: italic;">0</span>.degToRad.<span style="color: #66D9EF;">Radian</span>, E₀, <span style="color: #66D9EF;">E_c</span>, I₀, ε<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">given flux compute CDF</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fluxCS </span>= flux.cumSum<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fluxCS_sorted </span>= flux.sorted.cumSum<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fluxCDF </span>= fluxCS.mapIt<span style="color: #AE81FF;">(</span>it / fluxCS<span style="color: #66D9EF;">[</span>^<span style="font-style: italic;">1</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fluxCDF_sorted </span>= fluxCS_sorted.mapIt<span style="color: #AE81FF;">(</span>it / fluxCS_sorted<span style="color: #66D9EF;">[</span>^<span style="font-style: italic;">1</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>

  <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>data, cdf<span style="color: #AE81FF;">)</span> = unbinnedCdf<span style="color: #AE81FF;">(</span>flux<span style="color: #AE81FF;">)</span>

  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfX </span>= toDf<span style="color: #AE81FF;">(</span>energies, fluxCS, fluxCS_sorted, fluxCDF, fluxCDF_sorted<span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>dfX, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;fluxCS&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/t/cumsum_test.pdf&quot;</span><span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>dfX, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;fluxCDF&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/t/cdf_test.pdf&quot;</span><span style="color: #AE81FF;">)</span>    
  ggplot<span style="color: #AE81FF;">(</span>dfX, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;fluxCS_sorted&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/t/cumsum_sorted_test.pdf&quot;</span><span style="color: #AE81FF;">)</span>    
  ggplot<span style="color: #AE81FF;">(</span>dfX, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;fluxCDF_sorted&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/t/cdf_sorted_test.pdf&quot;</span><span style="color: #AE81FF;">)</span>

  ggplot<span style="color: #AE81FF;">(</span>toDf<span style="color: #66D9EF;">(</span>data, cdf<span style="color: #66D9EF;">)</span>, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;data&quot;</span>, <span style="color: #E6DB74;">&quot;cdf&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/t/unbinned_cdf.pdf&quot;</span><span style="color: #AE81FF;">)</span>
  
  <span style="color: #75715E;">#</span><span style="color: #75715E;">if true: quit()</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">lossesBB </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">lossesMP </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">energySamples </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>

  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dedxmin </span>= <span style="font-style: italic;">1</span>.<span style="font-style: italic;">519</span>.<span style="color: #66D9EF;">MeV</span>•cm²•g⁻¹
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Loss = &quot;</span>, <span style="color: #AE81FF;">(</span>dedxmin * <span style="color: #66D9EF;">Argon</span>.ρ * <span style="font-style: italic;">3</span>.cm<span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>keV<span style="color: #AE81FF;">)</span>
  
  <span style="color: #F92672;">for</span> i <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; samples:
    <span style="color: #75715E;"># </span><span style="color: #75715E;">given the fluxCDF sample different energies, which correspond to the</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">distribution expected at CAST</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">idx </span>= fluxCdf.lowerBound<span style="color: #AE81FF;">(</span>rand<span style="color: #66D9EF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">E_element</span> = <span style="color: #66D9EF;">E</span><span style="color: #AE81FF;">[</span>idx<span style="color: #AE81FF;">]</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">given this energy `</span><span style="color: #AE81FF;">E</span><span style="color: #75715E;">` compute the loss</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">lossBB </span>= <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">E_element</span>.to<span style="color: #66D9EF;">(</span>eV<span style="color: #66D9EF;">)</span> - intBethe<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Argon</span>, <span style="font-style: italic;">3</span>.cm, <span style="color: #66D9EF;">E_element</span>.to<span style="color: #A6E22E;">(</span>eV<span style="color: #A6E22E;">)</span>, dx = <span style="font-style: italic;">50</span>.μm<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>.to<span style="color: #AE81FF;">(</span>keV<span style="color: #AE81FF;">)</span>.<span style="color: #66D9EF;">float</span>
    lossesBB.<span style="color: #F92672;">add</span> lossBB
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">lossMP </span>= mostProbableLoss<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span>, <span style="color: #66D9EF;">Argon</span>.<span style="color: #66D9EF;">Z</span>, <span style="color: #66D9EF;">Argon</span>.<span style="color: #66D9EF;">M</span>, <span style="color: #66D9EF;">E_Element</span>.<span style="color: #66D9EF;">E_to_γ</span><span style="color: #66D9EF;">()</span>, <span style="color: #66D9EF;">Argon</span>.ρ * <span style="font-style: italic;">3</span>.cm<span style="color: #AE81FF;">)</span>
    lossesMP.<span style="color: #F92672;">add</span> lossMP.<span style="color: #66D9EF;">float</span>
    <span style="color: #75715E;">#</span><span style="color: #75715E;">echo &quot;Index &quot;, i, &quot; yields energy &quot;, E_element, &quot; and loss &quot;, loss</span>
    energySamples.<span style="color: #F92672;">add</span> <span style="color: #66D9EF;">E_element</span>.<span style="color: #66D9EF;">float</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>energySamples, lossesBB, lossesMP<span style="color: #AE81FF;">)</span>
    .gather<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;lossesBB&quot;</span>, <span style="color: #E6DB74;">&quot;lossesMP&quot;</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;Type&quot;</span>, <span style="color: #E6DB74;">&quot;Value&quot;</span><span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Value&quot;</span>, fill = <span style="color: #E6DB74;">&quot;Type&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_histogram<span style="color: #AE81FF;">(</span>bins = <span style="font-style: italic;">300</span>, hdKind = hdOutline, alpha = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, position = <span style="color: #E6DB74;">&quot;identity&quot;</span><span style="color: #AE81FF;">)</span> +
    margin<span style="color: #AE81FF;">(</span>top = <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> +
    xlim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">5</span>, <span style="font-style: italic;">15</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Energy loss of muon flux at CAST based on MC sampling with {samples} samples&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/sampled_energy_loss.pdf&quot;</span><span style="color: #AE81FF;">)</span>

  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energySamples&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_histogram<span style="color: #AE81FF;">(</span>bins = <span style="font-style: italic;">300</span><span style="color: #AE81FF;">)</span> +
    margin<span style="color: #AE81FF;">(</span>top = <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Sampled energies for energy loss of muon flux at CAST&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/sampled_energy_for_energy_loss.pdf&quot;</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>samples, bins<span style="color: #AE81FF;">)</span> = histogram<span style="color: #AE81FF;">(</span>energySamples, bins = <span style="font-style: italic;">300</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfH </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;bins&quot;</span> : bins<span style="color: #A6E22E;">[</span><span style="font-style: italic;">0</span> ..&lt; ^<span style="font-style: italic;">1</span><span style="color: #A6E22E;">]</span>, samples<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    .filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>`bins` &gt; <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span> <span style="color: #F92672;">and</span> `samples`.<span style="color: #66D9EF;">float</span> &gt; <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>dfH, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;bins&quot;</span>, <span style="color: #E6DB74;">&quot;samples&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> + 
    margin<span style="color: #AE81FF;">(</span>top = <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Sampled energies for energy loss of muon flux at CAST&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/muons/sampled_energy_for_energy_loss_manual.pdf&quot;</span><span style="color: #AE81FF;">)</span>

  ggplot<span style="color: #AE81FF;">(</span>toDf<span style="color: #66D9EF;">(</span>energies, flux<span style="color: #66D9EF;">)</span>, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;flux&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    scale_x_log10<span style="color: #AE81FF;">()</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/tmp/starting_data_e_flux.pdf&quot;</span><span style="color: #AE81FF;">)</span>

  ggplot<span style="color: #AE81FF;">(</span>toDf<span style="color: #66D9EF;">(</span>energies, flux<span style="color: #66D9EF;">)</span>, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;energies&quot;</span>, <span style="color: #E6DB74;">&quot;flux&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/tmp/linear_starting_data_e_flux.pdf&quot;</span><span style="color: #AE81FF;">)</span>
    

<span style="color: #F92672;">discard</span> sampleFlux<span style="color: #AE81FF;">(</span>samples = <span style="font-style: italic;">1_000_000</span><span style="color: #AE81FF;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">ntangle thesis.org &amp;&amp; nim c -d:release code/muons
code/muons
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:theory:gas_fundamentals" class="outline-3">
<h3 id="sec:theory:gas_fundamentals"><span class="section-number-3">6.3.</span> Gaseous detector fundamentals</h3>
<div id="text-sec:theory:gas_fundamentals" class="outline-text-3">
<p>
Gaseous detectors consist of a volume filled with gas, usually a noble
gas with a small amount of molecular gas. For low rate, low energy
experiments an entrance window allows the particles to be detected, to
enter. An electric field is applied over the gas volume, strong enough
to cause electron-ion pairs created by ionization of the incoming
particles to drift to opposite ends of the volume (magnetic fields may
be utilized in addition). At least on the side of the anode (where the
electrons arrive), a readout of some form is installed to measure the
time of arrival, amount of collected charge and / or the position of
the electrons. Depending on the details, this in principle allows for
a 3D reconstruction of the initial event in the gas volume. The
details of choice of detector gas, applied electric fields, gas volume
dimensions and types of readout have a very large impact on the
applications a detector is useful for. In the following we will focus
on the physics concepts required for gaseous detectors with few
\(\si{cm}\) long drift volumes and high spatial resolution readouts.
</p>

<p>
Note: this section covers the basic fundamentals that will be later
referenced in the thesis. For a much more in-depth understanding of
these concepts, see references (<a href="./bibliography.html#citeproc_bib_item_192">Sauli 2014</a>) and
(<a href="./bibliography.html#citeproc_bib_item_138">Kolanoski and Wermes 2020</a>) and to some extent the PDG
(<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>) (in particular chapters on particle detectors and
passage of particles through matter; chapter number varies by year).
</p>
</div>
<div id="outline-container-sec:theory:daltons_law" class="outline-4">
<h4 id="sec:theory:daltons_law"><span class="section-number-4">6.3.1.</span> Gas mixtures and Dalton&apos;s law</h4>
<div id="text-sec:theory:daltons_law" class="outline-text-4">
<p>
Of common interest when dealing with gas mixtures is the notion of
partial pressures. In ideal gas theory, a mixture of gases at a
pressure \(P\) can be considered to be the sum of the &apos;partial
pressures&apos; of each gas species
</p>

<p>
\[
P = \sum_i p_i,
\]
</p>

<p>
initially noted by John Dalton in 1802 (<a href="./bibliography.html#citeproc_bib_item_78">Dalton 1802</a>).
</p>

<p>
The contribution of each gas only depends on the species&apos; mole
fraction. Typically when considering gas mixtures the fractions of
each gas species is given as a percentage. The percentage already
refers to the mole fraction of each species. As such, the partial
pressure of a single species can be expressed as:
</p>

<p>
\[
p_i = n_i P
\]
</p>

<p>
where \(n_i\) is the mole fraction of species \(i\).
</p>

<p>
This is an extremely valuable property when computing different
interactions of particles with gas mixtures. For example when
computing the absorption of X-rays after propagating through a certain
distance of a gas mixture, as one can compute absorption for each
partial pressure independently and combine the contributions after
(whether they be added, multiplied or something else of course depends
on the considered process).
</p>
</div>
</div>
<div id="outline-container-orgec4f69f" class="outline-4">
<h4 id="orgec4f69f"><span class="section-number-4">6.3.2.</span> Ionization energy and average energy per electron-ion pair</h4>
<div id="text-6-3-2" class="outline-text-4">
<p>
In order to understand the signals detected by a gaseous detector, the
average number of electrons liberated by an incident particle should
be known. This can be calculated given the energy loss in a gas required to
produce a single electron-ion pair, called the \(W\text{-value}\),
</p>

<p>
\[
W = \frac{I}{⟨N⟩}.
\]
</p>

<p>
Here, \(I\) is the mean ionization energy of the gas and \(⟨N⟩\) the
average number of electron-ion pairs generated per interaction. \(⟨N⟩\)
is usually smaller than one, \(\numrange{0.6}{0.7}\) for noble gases and
even below \(\num{0.5}\) for molecular gases. Not all energy of the
incoming particle is always deposited in the form of generation of,
for example, a photoelectron. Other forms of energy loss are
possible. In molecular gases vibrational and rotational modes offer
even more possibilities, resulting in the smaller values.
</p>

<p>
The mean excitation energy \(I\) of an element is the weighted
combination of the most likely energy levels the element is ionized
from. The exact values are dependent on the specific element and
tabulated values like from NIST (<a href="./bibliography.html#citeproc_bib_item_117">Hubbell and Seltzer 1996</a>) exist. Above some
\(Z\) (roughly argon, \(Z = 18\)) a rough approximation of \(I =
\SI{10}{eV} · Z\) can be substituted (<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>), developed by
Bloch (<a href="./bibliography.html#citeproc_bib_item_47">Bloch 1933</a>).
</p>

<p>
The precise number for \(W\) strongly depends on the used gas mixture
and typically requires experimental measurements to determine. Monte
Carlo based simulations can be used as a rough guide, but care must be
taken interpreting the results as significant uncertainty can
remain. Tools for such Monte Carlo simulations include GEANT4
(<a href="./bibliography.html#citeproc_bib_item_4">Agostinelli and others 2003</a>) <sup>  <a id="fnr.15" href="#fn.15" class="footref" role="doc-backlink">15</a></sup> and MCNelectron
(<a href="./bibliography.html#citeproc_bib_item_180">Poškus 2015</a>) <sup>  <a id="fnr.16" href="#fn.16" class="footref" role="doc-backlink">16</a></sup>. These are
based on atomic excitation cross sections, which are well tabulated in
projects like ENDF (<a href="./bibliography.html#citeproc_bib_item_56">Brown et al. 2018</a>) (citation for the latest data
release) <sup>  <a id="fnr.17" href="#fn.17" class="footref" role="doc-backlink">17</a></sup> and LXCat
(<a href="./bibliography.html#citeproc_bib_item_167">Pancheshnyi et al. 2012</a>; <a href="./bibliography.html#citeproc_bib_item_178">Pitchford et al. 2016</a>; <a href="./bibliography.html#citeproc_bib_item_61">Carbone et al. 2021</a>) <sup>  <a id="fnr.18" href="#fn.18" class="footref" role="doc-backlink">18</a></sup>.
</p>
</div>
</div>
<div id="outline-container-org4feeeba" class="outline-4">
<h4 id="org4feeeba"><span class="section-number-4">6.3.3.</span> Mean free path</h4>
<div id="text-6-3-3" class="outline-text-4">
<p>
While we have already discussed the mean free path for X-rays in
sec. <a href="./theory_detector.html#sec:theory:xray_matter_gas">6.1.1</a>, we should revisit it quickly for
electrons in a gas. It is a necessary concept when trying to
understand other gaseous detector physics concepts, in particular for the gas
amplification. <sup>  <a id="fnr.19" href="#fn.19" class="footref" role="doc-backlink">19</a></sup>
</p>

<p>
The mean free path of an electron in a gas can be described by
</p>

\begin{equation}
\label{eq:theory:mean_free_path_e_def}
λ = \frac{1}{nσ}
\end{equation}

<p>
where \(n = N/V\) is the number density (atoms or molecules per unit
volume) of the gas particles and \(σ\) the cross section of electrons
interacting with them. Such cross sections are tabulated for different
elements, for example again see LXCat
(<a href="./bibliography.html#citeproc_bib_item_167">Pancheshnyi et al. 2012</a>; <a href="./bibliography.html#citeproc_bib_item_178">Pitchford et al. 2016</a>; <a href="./bibliography.html#citeproc_bib_item_61">Carbone et al. 2021</a>).
</p>

<p>
Based on the ideal gas law, we can express it as a function of
pressure \(p\) and temperature \(T\) to
</p>

<p>
\[
p V = N k_B T ⇔ p = n k_B T,
\]
</p>

<p>
with the Boltzmann constant \(k_B\).  Inserting this via \(n\) into
eq. \eqref{eq:theory:mean_free_path_e_def} yields
</p>

\begin{equation}
\label{eq:theory:mean_free_path_e}
λ = \frac{k_B T}{p σ}.
\end{equation}
</div>
</div>
<div id="outline-container-sec:theory:gas_diffusion" class="outline-4">
<h4 id="sec:theory:gas_diffusion"><span class="section-number-4">6.3.4.</span> Diffusion</h4>
<div id="text-sec:theory:gas_diffusion" class="outline-text-4">
<p>
Diffusion in the context of gaseous detectors is the process of the
random walk of electrons either in longitudinal or transverse (to the
electric field) direction they exhibit, when drifting towards the
readout. Depending on the specific detector technology, some
transverse diffusion may be a desired property. For long drift
distances, magnetic fields can be used to significantly reduce the
transverse diffusion.
</p>

<p>
For an overview of the mathematics of diffusion as a random walk
process, see (<a href="./bibliography.html#citeproc_bib_item_40">Berg 1993</a>). In the context of gaseous detectors
see for example any of
(<a href="./bibliography.html#citeproc_bib_item_192">Sauli 2014</a>; <a href="./bibliography.html#citeproc_bib_item_138">Kolanoski and Wermes 2020</a>; <a href="./bibliography.html#citeproc_bib_item_110">Hilke and Riegler 2020</a>) In general, for
precise numbers measurements must be taken. Monte Carlo simulations
using tools like Magboltz (<a href="./bibliography.html#citeproc_bib_item_43">Biagi 1995b</a>) or PyBoltz
(<a href="./bibliography.html#citeproc_bib_item_27">Atoum et al. 2020</a>) can be used as a general reference if no measurements are
available.
</p>

<p>
The mean distance \(σ_t\) from a starting point after a certain amount
of time \(t\) is given by
</p>

<p>
\[
σ_t = \sqrt{ 2 N D t }
\]
</p>

<p>
for a random walk in \(N\) dimensions, where \(D\) is a diffusion
coefficient specifying the movement in distance squared per time.  For
example for a point like source of multiple electrons, after diffusion
of some distance a 2 dimensional gaussian distribution will be
expected with a standard deviation of \(σ_t\). By relating the time to
the drift velocity \(v\) along an axis and introducing the diffusion
constant \(D_t\)
</p>

<p>
\[
D_t = \sqrt{ \frac{2 N D}{v} }
\]
</p>

<p>
we can further express \(σ_t\) as
</p>

\begin{equation}
\label{eq:gas_physics:diffusion_after_drift}
σ_t = D_t · \sqrt{x},
\end{equation}

<p>
which is often practically useful to estimate the expected diffusion
after a certain drift length. 
</p>

<p>
Note that the terminology of &quot;diffusion constant&quot;, &quot;diffusion
coefficient&quot; and similar is often used ambiguously as to whether they
refer to \(D\) or \(D_t\) (or sometimes even \(σ_t\)). Nor is the considered
dimensionality \(N\) always clearly indicated. Keeping \(N = 1\) and
handling multiple dimensions as independent random walks is a
practical approach to take (as long as it is valid in the
application). <sup>  <a id="fnr.20" href="#fn.20" class="footref" role="doc-backlink">20</a></sup>
</p>
</div>
</div>
<div id="outline-container-org7c8ed01" class="outline-4">
<h4 id="org7c8ed01"><span class="section-number-4">6.3.5.</span> Drift velocity</h4>
<div id="text-6-3-5" class="outline-text-4">
<p>
The drift velocity is the average speed at which electrons move
towards the anode in a gaseous detector under the influence of an
electric field. It is required to understand how recorded time
information relates to longitudinal shape information of recorded
data. Based on the so called &apos;friction force model&apos; an analytical
expression for the drift velocity in an electromagnetic field can be
written to:
</p>

<p>
\[
\vec{v} = \frac{e}{m_e} \frac{τ}{1 + ω²τ²}\left( \vec{E} + \frac{ωτ}{B} (\vec{E}
× \vec{B}) + \frac{ω²τ²}{B²}(\vec{E} · \vec{B}) \vec{B} \right)
\]
</p>

<p>
with the electron charge \(e\) and mass \(m_e\), in an electric field
\(\vec{E}\) and magnetic field \(\vec{B}\), given the Lamor frequency \(ω =
eB / m_e\) and the mean collision time \(τ\). (<a href="./bibliography.html#citeproc_bib_item_246">Zyla and others 2020</a>)
</p>

<p>
For detectors without a magnetic field \(B = 0, ω = 0\) and a constant,
homogeneous electric field \(E\), this reduces to the Townsend
expression:
</p>

<p>
\[
v = \frac{e E τ}{m_e}.
\]
</p>

<p>
If measurements are not available, these can also be computed by Magboltz
(<a href="./bibliography.html#citeproc_bib_item_43">Biagi 1995b</a>) or PyBoltz (<a href="./bibliography.html#citeproc_bib_item_27">Atoum et al. 2020</a>), which solve the
underlying transport equation, the Boltzmann equation.
</p>
</div>
</div>
<div id="outline-container-sec:theory:gas_gain_polya" class="outline-4">
<h4 id="sec:theory:gas_gain_polya"><span class="section-number-4">6.3.6.</span> Gas amplification</h4>
<div id="text-sec:theory:gas_gain_polya" class="outline-text-4">
<p>
In order to turn the individual electrons into a measurable signal,
gaseous detectors use some form of gas amplification. Details vary,
but it is usually a region in the gas volume close to the readout with
a very strong electric field (multiple \(\si{kV.cm^{-1}}\)) such that
each electron causes many secondary ionizations, leading to an
avalanche effect. In case of the detectors described in this thesis,
amplification factors between \(\numrange{2000}{4500}\) are desired.
</p>

<p>
An electron in a strong electric field \(\vec{E}\) will gain enough
energy to ionize an atom of the gas after a distance
</p>

<p>
\[
l \geq \frac{I}{|\vec{E}|}
\]
</p>

<p>
with the ionization potential of the gas, \(I\). This needs to be put
into relation with the mean free path,
eq. \eqref{eq:theory:mean_free_path_e}. If \(l \ll λ\) no secondary ionization
takes place and if \(l \gg λ\) every interaction leads to ionization,
likely resulting in a breakdown causing an arc (see also Paschen&apos;s
law (<a href="./bibliography.html#citeproc_bib_item_168">Paschen 1889</a>), not covered here). In the intermediate range some interactions
cause secondary ionization, some does not.
</p>

<p>
We can make the statistical argument that
</p>

<p>
\[
\mathcal{N} = e^{-l/λ}
\]
</p>

<p>
is the relative number of collisions with \(l &gt; λ\). This
allows to define the probability of finding a number of ionizations
per unit length to be
</p>

<p>
\[
P(l) = \frac{1}{λ} e^{-l / λ} = α,
\]
</p>

<p>
where we introduce the definition of the &apos;first Townsend coefficient&apos;,
\(α\).  We can insert the definition of the mean free path,
eq. \eqref{eq:theory:mean_free_path_e}, and \(l\) into this equation to obtain
</p>

\begin{equation}
\label{eq:theory:townsend_coefficient}
α(T) = \frac{pσ}{kT} \exp\left( - \frac{I}{|\vec{E}|}\frac{pσ}{kT}\right).
\end{equation}

<p>
With this we have an expression for the temperature and pressure
dependency of the first Townsend coefficient. <sup>  <a id="fnr.21" href="#fn.21" class="footref" role="doc-backlink">21</a></sup> This
derivation followed (<a href="./bibliography.html#citeproc_bib_item_193">Scharenberg 2019</a>) based on (<a href="./bibliography.html#citeproc_bib_item_86">Engel and Marton 1965</a>), but
see (<a href="./bibliography.html#citeproc_bib_item_18">Aoyama 1985</a>) for a more general treatment. Similarly to
diffusion and drift parameters, the first Townsend coefficient can be
computed numerically using tools like Magboltz.
</p>

<p>
Note that (<a href="./bibliography.html#citeproc_bib_item_192">Sauli 2014</a>) introduces the Townsend coefficient
as \(α = \frac{1}{λ}\), introducing a specific \(λ\) and \(σ\) referring to
the <i>ionization</i> mean free path and <i>ionizing</i> cross sections. This
can be misleading as it makes it seem as if the Townsend coefficient
is inversely proportional to the temperature. This is of course only
the case in the regime where each interaction actually causes another
ionization.
</p>

<p>
The first Townsend coefficient can be used to express the
multiplication factor – or gas amplification – used in a detector,
</p>

<p>
\[
G = e^{α x}
\]
</p>

<p>
as the number increases by \(α\) after each step \(\mathrm{d}x\).
</p>

<p>
The statistical distribution describing the number of electrons after
gas amplification is the Pólya distribution
</p>


\begin{equation}
\label{eq:theory:polya_distribution}
p(x) = \frac{N}{G} \frac{(1 + θ)^{1 + θ}}{Γ(1 + θ)}
\left(\frac{x}{G}\right)^θ \exp\left[- \frac{(1 + θ) x}{G}\right]
\end{equation}

<p>
where \(N\) is a normalization constant, \(θ\) is another parameter
performing shaping of the distribution and \(G\) is the effective gas
gain. \(Γ\) refers to the gamma function. It is to note that the term
&quot;polya distribution&quot; in this context is different from other
mathematical definitions, in which polya distribution usually means a
negative binomial distribution. The above definition goes back to
Alkhazov (<a href="./bibliography.html#citeproc_bib_item_5">Alkhazov 1970</a>) and in slight variations is
commonly used. Due to the complexity of this definition, care needs to
be taken when performing numerical fits to data with this function
(using bounded parameters and preferring more general non-linear
optimization routines instead of a normal Levenberg-Marquardt
non-linear least squares approach).
</p>

<p>
Based on eq. \eqref{eq:theory:townsend_coefficient} the largest impacts on the
expected gas amplification have the electric field, the choice of gas
and the temperature of the gas. While the former two parameters are
comparatively easy to control, the temperature in the amplification
region may vary and is hard to measure. As such depending on the
detector details and application, gas gain variations are expected and
corrections based on a running gas gain value may be necessary.
</p>

<p>
As the large number of interactions in the amplification region can
excite many atoms of the (typically) noble gas, UV photons can be
produced. Their mean free path is comparatively long relative to the
size of the amplification region. They can start further avalanches,
potentially away from the location of the initial avalanche start,
lowering spatial resolution and increasing apparent primary electron
counts. Molecular gases are added – often only in small fractions –
to the gas mixture to provide rotational or vibrational modes to
dissipate energy without emitting UV photons. In this context the
molecular additions are called &apos;quencher gases&apos;.
</p>
</div>
</div>
<div id="outline-container-org7fbc8e9" class="outline-4">
<h4 id="org7fbc8e9"><span class="section-number-4">6.3.7.</span> Energy resolution</h4>
<div id="text-6-3-7" class="outline-text-4">
<p>
Because of the statistical processes associated with the full
detection method used in gaseous detectors, even a perfect delta like
signal in energy, will lead to a natural spread of the measured
signal. The convolution of different ionization yields, potential
losses and gas gain variation all contribute to such a spread.
</p>

<p>
As such a typical measure of interest for gaseous detectors is the
energy resolution, which is commonly defined by
</p>

<p>
\[
ΔE = \frac{σ}{E}
\]
</p>

<p>
where \(σ\) is the standard deviation of the normal distribution
associated with the resolved peak in the detectors data, assuming a –
for practical purposes – delta peak as the input spectrum. Sometimes
definitions using the full width at half maximum (FWHM) are also used
in place of \(σ\). Typical values for the energy resolution defined like
this are smaller than \(\SI{15}{\%}\).
</p>

<p>
If the absolute magnitude of the \(σ\) at a given energy is constant,
which at least is partially reasonable as the width is not fully due
to energy dependent effects, the energy resolution is proportional to
\(1/E\).
</p>

<p>
The Fano factor (<a href="./bibliography.html#citeproc_bib_item_88">Fano 1963</a>), defined by the variance over the mean of
a distribution \(F = σ² / μ\) (typically within some time window),
improves the ideal energy resolution. It arises in the associated
statistical processes, because there are a finite number of possible
interaction states. For X-rays an additional aspect is due to the
maximum energy transferable into the gas due to the X-rays energy. In
practice though the energy resolution of gaseous detectors is usually
limited by other effects.
</p>
</div>
<div id="outline-container-orgb165970" class="outline-5">
<h5 id="orgb165970"><span class="section-number-5">6.3.7.1.</span> More notes on Fano factor   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-6-3-7-1" class="outline-text-5">
<p>
The Fano factor is related to the fact that the average energy needed
to produce an electron-ion pair in each interaction. 
</p>

<p>
(<a href="./bibliography.html#citeproc_bib_item_138">Kolanoski and Wermes 2020</a>) derives the Fano factor on page 783 in
sec. 17.10.2. The relationship to the W-value is studied in
(<a href="./bibliography.html#citeproc_bib_item_55">Bronic 1992</a>) and mentioned in (<a href="./bibliography.html#citeproc_bib_item_192">Sauli 2014</a>) on
page 62.  
</p>
</div>
</div>
</div>
<div id="outline-container-sec:theory:escape_peaks_55fe" class="outline-4">
<h4 id="sec:theory:escape_peaks_55fe"><span class="section-number-4">6.3.8.</span> Escape photons and peaks | 55Fe as a typical calibration source</h4>
<div id="text-sec:theory:escape_peaks_55fe" class="outline-text-4">
<p>
Finally, gaseous detectors need to be calibrated, monitored and
tested. This is commonly done with a \cefe source. \cefe is a
radioactive isotope of iron, which decays under inverse beta decay to
\(\ce{^{55}Mn}\). Due to the required restructuring of the electronic
shells, the manganese is in an excited state. While the emission of an
Auger electron with \(\SI{5.19}{keV}\) dominates with a probability of
\(\SI{67.2}{\%}\)
(<a href="./bibliography.html#citeproc_bib_item_139">Krause 1979</a>; <a href="./bibliography.html#citeproc_bib_item_206">Schoonjans et al. 2011</a>; <a href="./bibliography.html#citeproc_bib_item_57">Brunetti et al. 2004</a>), as an
X-ray source the Kα₁ and Kα₂ lines with combined energies of about
\(\SI{5.9}{keV}\) are of note.
</p>

<p>
When using such a \cefe source as a calibration source for an argon
filled gaseous detector, the \(\SI{5.9}{keV}\) photons will produce a
photoelectron in argon. Mostly an inner shell electron will be
liberated, producing a photoelectron of around \(\SI{2.7}{keV}\). The
excited argon atom can now emit an Auger electron in about
\(\SI{88.2}{\%}\) of cases
(<a href="./bibliography.html#citeproc_bib_item_139">Krause 1979</a>; <a href="./bibliography.html#citeproc_bib_item_206">Schoonjans et al. 2011</a>; <a href="./bibliography.html#citeproc_bib_item_57">Brunetti et al. 2004</a>), which
will fully deposit its remaining energy into the surrounding gas via
further ionizations, resulting in the &apos;photopeak&apos; at around
\(\SI{5.9}{keV}\).
</p>

<p>
If however another photon is produced with an energy below the \(K 1s\)
energy of argon (\(\SI{3.2}{keV}\)) – for example via Kα₁ or Kα₂
fluorescence of argon, both at about \(\SI{2.95}{keV}\) – such a photon
has a very long absorption length in the gas volume, about
\(l_{\text{abs}} = \SI{3.5}{cm}\)
(cf. fig. <a href="#fig:theory:transmission_examples">9</a>). This can cause it to
easily escape the active detection region, especially if the sensitive
region of the detector is comparatively small. The result is a
measured signal of \(E_i - E_k = \SI{5.9}{keV} - \SI{2.95}{keV} \approx
\SI{2.9}{keV}\), called the &apos;escape
peak&apos;. (<a href="./bibliography.html#citeproc_bib_item_192">Sauli 2014</a>; <a href="./bibliography.html#citeproc_bib_item_138">Kolanoski and Wermes 2020</a>; <a href="./bibliography.html#citeproc_bib_item_117">Hubbell and Seltzer 1996</a>)
</p>

<p>
Such an additional escape peak is useful as a calibration tool, as it
gives two distinct peaks in a \cefe calibration spectrum, which can be
utilized for an energy calibration. One important consideration of
such an escape peak is however, that this escape peak of about
\(\SI{3}{keV}\) is not equivalent to a real \(\SI{3}{keV}\) X-ray. As the
original X-ray is still the \(\SI{5.9}{keV}\) photon with its distinct
absorption length, the geometric properties of ensembles of escape
peak events and real \(\SI{3}{keV}\) photons is different. This will be
important later in sec. <a href="./background.html#sec:background:mlp:effective_efficiency">12.4.7</a>.
</p>
</div>
</div>
<div id="outline-container-org4c678b3" class="outline-4">
<h4 id="org4c678b3"><span class="section-number-4">6.3.9.</span> Note on origin of fluorescence yields / fraction of Auger electrons   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-6-3-9" class="outline-text-4">
<p>
The fluorescence yield is the fraction with which an excited nucleus
decays via a radiative emission of an X-ray instead of an Auger
electron.
</p>

<p>
So the relevant terms are either &apos;fluorescene yield&apos; or &apos;Auger yield&apos;
depending.
</p>

<p>
The main resource still often compared to is this paper by Krause
(<a href="./bibliography.html#citeproc_bib_item_139">Krause 1979</a>). The paper contains a very useful table of the
fluorescence yields of the different elements.
</p>

<p>
There is a C library for such calculations,
(<a href="./bibliography.html#citeproc_bib_item_206">Schoonjans et al. 2011</a>; <a href="./bibliography.html#citeproc_bib_item_57">Brunetti et al. 2004</a>). They have produced a PDF
with similar tables for different elements, which can be found here:
</p>

<p>
<a href="http://ftp.esrf.fr/pub/scisoft/xraylib/xraylib_tables_v2.3.pdf">http://ftp.esrf.fr/pub/scisoft/xraylib/xraylib_tables_v2.3.pdf</a>
</p>

<p>
One might encounter the term &apos;jump factor&apos; in this context: It refers
to the ratio of how the absorption changes from directly below to
directly above the absorption edge.
</p>

<p>
So for Argon see page 31 in this PDF (or page 9 in Krause&apos;s paper) to
find \(ω_K = \num{0.118}\), where
</p>

<p>
\[
ω_K + a_K = 1
\]
</p>

<p>
the fluorescence yield \(ω_K\) + auger yield \(a_K\) needs to be one.
<b>NOTE</b>: Technically \(ω_K\), \(a_K\) is only for the K shell, so just an
approximation. You will find \(ω_1, ω_2\), … etc for L shells.
</p>

<p>
For Manganese (because Manganese is the excited nucleus after \cefe
decay) you&apos;ll find it on page 47 (or page 9 in Krause&apos;s paper). They
sum to \(ω_{K+L} = 0.345\).
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:septemboard" class="outline-2">
<h2 id="sec:septemboard"><span class="section-number-2">7.</span> Septemboard detector   <span class="tag">  <span class="Detector">Detector</span></span></h2>
<div id="text-sec:septemboard" class="outline-text-2">
<p>
With the theoretical aspects of gaseous detectors out of the way, in
sec. <a href="./septemboard.html#sec:detector:micromegas">7.1</a> we will introduce the &apos;Micromegas&apos; type
of gaseous detector. Micromegas can be read out in different ways. One
option is the Timepix ASIC, sec. <a href="./septemboard.html#sec:detector:timepix">7.2</a>, by way of the
&apos;GridPix&apos;, sec. <a href="./septemboard.html#sec:detector:gridpix">7.3</a>.
</p>

<p>
The GridPix detector in use in the 2014 / 2015 CAST data taking
campaign, to be presented in section <a href="./septemboard.html#sec:detector:detector_2014_15">7.4</a>,
had a few significant drawbacks for more sensitive searches. In
particular for searches at low energies \(\lesssim\SI{2}{\keV}\) and
searches requiring low backgrounds over larger areas on the chip (for
example the chameleon search done in (<a href="./bibliography.html#citeproc_bib_item_65">Christoph Krieger 2018</a>)). For this
reason a new detector was built in an attempt to improve each
shortcoming of the detector.
</p>

<p>
We introduce the &apos;Septemboard&apos; detector with a basic overview in
section <a href="./septemboard.html#sec:detector:detector_overview">7.5</a>. From there we continue
looking at each of the new detector features motivating their
addition. All detector upgrades were done to alleviate one or more of
the old detector&apos;s drawbacks. For each new detector feature we will
highlight the aspects it is intended to improve on.
</p>

<p>
Section <a href="./septemboard.html#sec:detector:scintillators">7.7</a> introduces two new scintillators
as vetoes. These require the addition of an external shutter for the
Timepix, which is realized by usage of a flash ADC (FADC), see section
<a href="./septemboard.html#sec:detector:fadc">7.8</a>. Further, an independent but extremely important
addition is the replacement of the Mylar window by a silicon nitride
window, section <a href="./septemboard.html#sec:detector:sin_window">7.9</a>. Another aspect is the
addition of 6 GridPixes around the central GridPix, the &apos;Septemboard&apos;
introduced in section <a href="./septemboard.html#sec:detector:septemboard">7.10</a>. Due to the additional
heat produced by 6 more GridPix, a water cooling system is used,
sec. <a href="./septemboard.html#sec:detector:water_cooling">7.11</a>. Lastly, in
sec. <a href="./septemboard.html#sec:septem:efficiency">7.12</a> we will also discuss the combined
detection efficiency of this detector.
</p>
</div>
<div id="outline-container-sec:detector:micromegas" class="outline-3">
<h3 id="sec:detector:micromegas"><span class="section-number-3">7.1.</span> Micromegas working principle</h3>
<div id="text-sec:detector:micromegas" class="outline-text-3">
<p>
\textbf{Micro} \textbf{Me}sh \textbf{Ga}seous \textbf{S}tructures
(Micromegas) are a kind of \textbf{M}icro\textbf{p}attern
\textbf{G}aseous \textbf{D}etectors (MPGDs) first introduced in 1996
(<a href="./bibliography.html#citeproc_bib_item_96">Giomataris et al. 1996</a>; <a href="./bibliography.html#citeproc_bib_item_95">Giomataris 1998</a>). The modern Micromegas is
the Microbulk Micromegas (<a href="./bibliography.html#citeproc_bib_item_11">Andriamonje et al. 2010</a>).
</p>

<p>
Interestingly, the name Micromegas is based on the novella Micromégas
by Voltaire published in 1752 (<a href="./bibliography.html#citeproc_bib_item_228">Voltaire 1752</a>), an early
example of a science fiction story. (<a href="./bibliography.html#citeproc_bib_item_96">Giomataris et al. 1996</a>)
</p>

<p>
These detectors are – as the name implies – gaseous detectors
containing a &apos;micro mesh&apos;. In the most basic form they are a made of a
closed detector volume that is filled with a suitable gas, allowing
for ionization (often argon based gas mixtures are used; xenon based
detectors for axion helioscopes are in the prototype phase). The
volume is split into two different sections, a large drift volume
typically \(\mathcal{O}(\text{few }\si{cm})\) and an amplification
region, sized \(\mathcal{O}(\SIrange{50}{100}{μm})\). At the top of the
volume is a cathode to apply an electric field. Below the mesh is the
readout area at the bottom of the volume. In standard Micromegas
detectors, strips or pads are used as a readout. The electric field in
the drift region is strong enough to avoid recombination of the
created electron-ion pairs and to provide reasonably fast drift
velocities \(\mathcal{O}(\si{cm.μs⁻¹})\). The amplification gap on the
other hand is precisely used to multiply the primary electrons using
an avalanche effect. Thus, the electric field reaches values of
\(\mathcal{O}(\SI{50}{kV.cm⁻¹})\). These drift and amplification volumes
are achieved by an electric field between a cathode and the mesh as
well as the mesh and the readout area.
</p>

<p>
Fig. <a href="micromegas_schematic">15</a> shows a schematic for the general working
principle of such detectors
</p>


<figure id="micromegas_schematic">
<img alt="micromegas_schematic.svg" class="org-svg" src="./figs/home/basti/org/Figs/thesis/detectors/micromegas_schematic.svg" />

<figcaption>Figure 15: <span class="figure-number">Figure 13: </span>Working principle of a general Micromegas detector. Specific distances and gas mixture are exemplary. An ionizing photon enters through the detector window into the gas-filled detector body. After a certain distance it produces a photoelectron, which ionizes further gas molecules for a specific number of primary electrons (depending on the incoming photon&apos;s energy) and gas mixture. The primary electrons drift towards the micromesh due to the drift voltage, thereby experiencing diffusion. In the much higher voltage in the amplification gap an avalanche of electrons is produced, enough to trigger the readout electronics (strips or pads).</figcaption>
</figure>
</div>
</div>
<div id="outline-container-sec:detector:timepix" class="outline-3">
<h3 id="sec:detector:timepix"><span class="section-number-3">7.2.</span> Timepix ASIC</h3>
<div id="text-sec:detector:timepix" class="outline-text-3">
<p>
The Timepix ASIC (Application Specific Integrated Circuit) is a \(256 ×
256\) pixel ASIC with each pixel \(\num{55}·\SI{55}{μm^2}\) in size. It
is based on the Medipix ASIC, developed for medical imaging
applications by the Medipix Collaboration (<a href="./bibliography.html#citeproc_bib_item_152">Llopart et al. 2002</a>). The pixels are
distributed over an active area of
\(\num{1.41}\times\SI{1.41}{\cm^2}\). Each pixel contains a charge
sensitive amplifier, a single threshold discriminator and a
\(\SI{14}{bit}\) pseudo random counting logic. It requires use of an
external clock, in the range of \(\SIrange{10}{150}{MHz}\), with
\(\SI{40}{MHz}\) being the clock frequency used for the applications in
this thesis. (<a href="./bibliography.html#citeproc_bib_item_148">Llopart Cudie 2007</a>; <a href="./bibliography.html#citeproc_bib_item_151">Llopart et al. 2007</a>; <a href="./bibliography.html#citeproc_bib_item_149">Llopart and Poikela 2006</a>)
A good overview of the Timepix is also given in
(<a href="./bibliography.html#citeproc_bib_item_153">Lupberger 2016</a>). A picture of a Timepix ASIC is shown in
fig. <a href="#fig:detector:timepix_asic">16(a)</a>.
</p>

<p>
The Timepix uses a shutter based readout, either with a fixed shutter
time or using an external trigger to close a frame. After the shutter
is closed in the Timepix, the readout is performed during which the
detector is insensitive. Each pixel further can work in four
different modes:
</p>

<dl class="org-dl">
<dt>hit counting mode / single hit mode</dt><dd>simply counts the number of
times the threshold of a pixel was crossed (or whether a pixel was
activated once in single hit mode).</dd>
<dt>\textbf{T}ime \textbf{o}ver \textbf{T}hreshold (ToT)</dt><dd>In the ToT
mode the counter of a pixel will count the number of clock cycles
that the charge on the pixel exceeds the set threshold, which is set
by an \(\SI{8}{bit}\) \textbf{D}igital to \textbf{A}nalog
\textbf{C}onverter (DAC) while the shutter is open. ToT is
equivalent to the collected charge of each pixel.</dd>
<dt>\textbf{T}ime \textbf{o}f \textbf{A}rrival (ToA)</dt><dd>The ToA mode
records the number of clock cycles from the first time the pixel&apos;s
threshold is exceeded to the end of the shutter window. Thus, it
allows to calculate the time at which the pixel first crossed the
threshold.</dd>
</dl>

<p>
In the context of this thesis only the ToT mode was used.  
</p>
</div>
<div id="outline-container-sec:detector:timepix3" class="outline-4">
<h4 id="sec:detector:timepix3"><span class="section-number-4">7.2.1.</span> Timepix3</h4>
<div id="text-sec:detector:timepix3" class="outline-text-4">
<p>
The Timepix3 is the successor of the
Timepix. (<a href="./bibliography.html#citeproc_bib_item_179">Poikela et al. 2014</a>; <a href="./bibliography.html#citeproc_bib_item_150">Llopart and Poikela 2015</a>) It is generally
similar to the Timepix, but would provide 3 important advantages if
used in a gaseous detector for the applications in this thesis:
</p>
<ul class="org-ul">
<li>clock rates of up to \SI{300}{MHz} for higher possible data rates
(less interesting for data taking in an axion helioscope)</li>
<li>a stream based data readout. This means no fixed shutter times and
no dead time during readout. Instead data is sent out when it is
recorded in parallel.</li>
<li>each pixel can record ToT <i>and</i> ToA information at the same
time. This allows to record the charge recorded by a pixel as well
as the time it was activated, yielding 3D event reconstruction with
precise charge information.</li>
</ul>

<p>
An open source readout was developed by the University of Bonn and is
available under (<a href="./bibliography.html#citeproc_bib_item_101">Gruber et al. 2023</a>) <sup>  <a id="fnr.22" href="#fn.22" class="footref" role="doc-backlink">22</a></sup>. A gaseous
detector based on this is currently in the prototyping phase, see the
upcoming (<a href="./bibliography.html#citeproc_bib_item_194">Schiffer 2024</a>).
</p>
</div>
</div>
</div>
<div id="outline-container-sec:detector:gridpix" class="outline-3">
<h3 id="sec:detector:gridpix"><span class="section-number-3">7.3.</span> GridPix</h3>
<div id="text-sec:detector:gridpix" class="outline-text-3">
<p>
First experiments of combining a Micromegas with a Timepix readout
were done in 2005 (<a href="./bibliography.html#citeproc_bib_item_59">Campbell et al. 2005</a>) by using classical
approaches to place a micromesh on top of the Timepix, at the time
still called <i>TimePixGrid</i>. While this worked in principle, it showed
a Moiré pattern, due to slight misalignment between the holes of the
micromesh and the pixels of the Timepix. Shortly after, an approach
based on photolithographic post-processing was developed to perfectly
align the Timepix pixels each with a hole of a micromesh
(<a href="./bibliography.html#citeproc_bib_item_62">Chefdeville et al. 2006</a>), called the <i>InGrid</i> (integrated grid). The
commonly used name for a gaseous detector using an InGrid is
GridPix. For an overview of the process to produce InGrids nowadays,
see (<a href="./bibliography.html#citeproc_bib_item_193">Scharenberg 2019</a>).
</p>

<p>
The InGrid consists of a \(\SI{1}{μm}\) thick aluminum grid, resting on
small pillars \(\SI{50}{μm}\) above the Timepix. A silicon-nitride
\(\ce{Si_x N_y}\) <sup>  <a id="fnr.23" href="#fn.23" class="footref" role="doc-backlink">23</a></sup> layer protects the Timepix from
direct exposure to the amplification processes. The main advantage
over previous Micromegas technologies of the GridPix is its ability to
detect single electrons.  As long as the diffusion distance is long
enough to avoid multiple electrons entering a single hole of the
InGrid, each primary electron produced during the initial ionization
event is recorded. Fig. <a href="#fig:detector:ingrid_explanation">16(b)</a> shows an
image of such an InGrid.
</p>


<figure id="fig:detector:timepix_and_ingrid" class="figure-wrapper">
<figure id="fig:detector:timepix_asic" class="subfigure" data-width="43%">  <img src="./figs/home/basti/phd/Figs/timepix_gold.png" data-width="94%" />  <figcaption>Figure 16(a): Timepix ASIC</figcaption></figure> <figure id="fig:detector:ingrid_explanation" class="subfigure" data-width="55%">  <img src="./figs/home/basti/phd/Figs/ingrid_principle.svg" data-width="94%" />  <figcaption>Figure 16(b): InGrid</figcaption></figure>
<figcaption>Figure 16: <a href="#fig:detector:timepix_asic">16(a)</a> Picture of a bare Timepix ASIC. <a href="#fig:detector:ingrid_explanation">16(b)</a> Image of an InGrid, which was partially cut for inspection under an
          electron microscope. The pillars support the micromesh and
          have a height of $\SI{50}{μm}$. Each hole is perfectly aligned with
          a pixel of the Timepix below. Typical voltages applied between
          the grid and the Timepix are shown.</figcaption>
</figure>
</div>
</div>
<div id="outline-container-sec:detector:detector_2014_15" class="outline-3">
<h3 id="sec:detector:detector_2014_15"><span class="section-number-3">7.4.</span> 2014 / 2015 GridPix detector for CAST</h3>
<div id="text-sec:detector:detector_2014_15" class="outline-text-3">
<p>
In the course of (<a href="./bibliography.html#citeproc_bib_item_65">Christoph Krieger 2018</a>) a first GridPix based
detector for usage at an axion helioscope, CAST, was developed. While
the main result was on the coupling constant of the chameleon
particle, an axion-electron coupling result was computed in
(<a href="./bibliography.html#citeproc_bib_item_197">Schmidt 2016</a>).
</p>

<p>
The detector consists of a single GridPix in a \(\SI{78}{mm}\) diameter
gas volume and a drift distance of \(\SI{3}{cm}\). The detector has a
\(\SI{2}{μm}\) thick Mylar (\(\ce{C10 H8 O4}\)) entrance window for
X-rays. This detector serves as the foundation the detector used in
the course of this thesis was built on. See
fig. <a href="#fig:detector:exploded_schematic">17</a> for an exploded schematic of the
detector. Further, fig. <a href="#fig:detector:background_rate_2014">18</a> shows the
achieved background rate of this detector in the center \(\num{5}
\times \SI{5}{mm^2}\) region of the detector. The background rate shows
the copper Kα line near \(\SI{8}{keV}\), possibly overlaid with a muon
contribution as well as the expected argon Kα lines at
\(\SI{3}{keV}\). Below \(\SI{2}{keV}\) the background rises the lower the
energy becomes, likely due to background- and signal-like events being
less geometrically different at low energies (fewer pixels). The
average background rate in the range from \(\SIrange{0}{8}{keV}\) is
\(\sim\SI{2.9e-05}{keV^{-1}.cm^{-2}.s^{-1}}\).
</p>


<figure id="fig:detector:exploded_schematic">
<img alt="ingrid_detector_exploded_krieger_thesis.png" src="./figs/home/basti/org/Figs/ingrid_detector_exploded_krieger_thesis.png" />

<figcaption>Figure 17: <span class="figure-number">Figure 14: </span>Exploded view of the GridPix detector used during the 2014/15 data taking campaign at CAST. Consists of a \SI{3}{cm} drift volume with a \SI{78}{mm} inner diameter and a single GridPix at the center.</figcaption>
</figure>


<figure id="fig:detector:background_rate_2014">
<img alt="background_rate_2014_gold.svg" class="org-svg" src="./figs/home/basti/phd/Figs/background_rate_2014_gold.svg" />

<figcaption>Figure 18: <span class="figure-number">Figure 15: </span>Background rate in the center \(\num{5} \times \SI{5}{mm^2}\) for the GridPix used in 2014/15 at CAST. It corresponds to a background rate of \(\sim\SI{2.9e-05}{keV^{-1}.cm^{-2}.s^{-1}}\) in the range from \(\SIrange{0}{8}{keV}\).</figcaption>
</figure>
</div>
<div id="outline-container-orgf065206" class="outline-4">
<h4 id="orgf065206"><span class="section-number-4">7.4.1.</span> Create background rate plot for 2014 data   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-4-1" class="outline-text-4">
<p>
We simply generate the code with our background rate plotting script,
as the 2014/15 dataset background rate is stored in our resources of
the TPA repository. It also outputs the integrated background rates.
</p>
<div class="org-src-container">
<pre class="src src-sh">plotBackgroundRate --show2014 --energyMax 10.0 <span style="color: #E6DB74; font-weight: bold;">\</span>
  --title <span style="color: #E6DB74;">&quot;Background rate in center 5·5 mm² for GridPix 2014/15 CAST data&quot;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
  --useTeX <span style="color: #E6DB74; font-weight: bold;">\</span>
  --outpath ~/phd/Figs/ <span style="color: #E6DB74; font-weight: bold;">\</span>
  --outfile background_rate_2014_gold.pdf
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:detector:detector_overview" class="outline-3">
<h3 id="sec:detector:detector_overview"><span class="section-number-3">7.5.</span> Septemboard detector overview</h3>
<div id="text-sec:detector:detector_overview" class="outline-text-3">
<p>
Generally, the detector follows the same design as the old detector
shown in sec. <a href="./septemboard.html#sec:detector:detector_2014_15">7.4</a>, mainly so that mounting
it inside of the lead shielding and to the vacuum pipes at CAST is
possible without significant changes. An exploded view of the full
detector can be seen in fig. <a href="#fig:detector:full_septemboard_exploded">19</a>.
</p>

<p>
At the center of the new detector is the &apos;septemboard&apos;, 7 GridPixes
replace the single GridPix on the carrier board,
sec. <a href="./septemboard.html#sec:detector:septemboard">7.10</a>. Analogue signals induced by the
amplified charges on the center GridPix are now read out using a flash
ADC (FADC), sec. <a href="./septemboard.html#sec:detector:fadc">7.8</a>. The housing with an inner
diameter of \(\SI{78}{mm}\) is again made of acrylic glass, same as in
the old detector. The detector entrance window is replaced by a
\(\SI{300}{nm}\) \ccsini window (sec. <a href="./septemboard.html#sec:detector:sin_window">7.9</a>),
which also acts as part of the detector cathode. The copper anode
slots in right above the septemboard. The carrier board sits on the
intermediate board. Below the intermediate board is a bespoke water
cooling made of oxygen-free copper to cool the heat emitted by the
additional 6 GridPixes, sec. <a href="./septemboard.html#sec:detector:water_cooling">7.11</a>. On the
underside of the intermediate board is a new small silicone
photomultiplier (SiPM), sec. <a href="./septemboard.html#sec:detector:scintillators">7.7</a>. Finally, a
large veto scintillator is installed above the detector setup at CAST,
also sec. <a href="./septemboard.html#sec:detector:scintillators">7.7</a>.
</p>

<p>
During developments multiple septemboards were built and tested. The
septemboard used in the final detector is septemboard &apos;H&apos;. The GridPixes of
the final board are listed in tab. <a href="#tab:detector:septem_h_chips">5</a>.
</p>

<table id="tab:detector:septem_h_chips">
<caption class="t-above"><span class="table-number">Table 5:</span> Overview of the different chips on septemboard H. The first part of the name corresponds to the position on the wafer and <code>W69</code> is Timepix wafer number \num{69}.</caption>

<colgroup>
<col class="org-left" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Chip</th>
<th scope="col" class="org-right">Number</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">E 6 W69</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">K 6 W69</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">H 9 W69</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">H10 W69</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">G10 W69</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">D 9 W69</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-left">L 8 W69</td>
<td class="org-right">6</td>
</tr>
</tbody>
</table>



<figure id="fig:detector:full_septemboard_exploded">
<img alt="detector-mk4c-assembly-exploded-whitebg-no-cables-cropped.jpg" src="./figs/home/basti/phd/Figs/detector/detector-mk4c-assembly-exploded-whitebg-no-cables-cropped.jpg" />

<figcaption>Figure 19: <span class="figure-number">Figure 16: </span>Exploded view of the main GridPix septemboard detector. The FADC and large veto scintillator paddle are not shown for obvious reasons. At the center of the detector is the &apos;septemboard&apos;, 7 GridPixes on a carrier board. The housing is made of acrylic glass, same as in the old detector. The top shows the \SI{300}{nm} \ce{Si_3 N_4} window. Below the intermediate board is the water cooling made of pure copper. At the bottom, the SiPM veto scintillator can be seen.</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org15645f3" class="outline-3">
<h3 id="org15645f3"><span class="section-number-3">7.6.</span> Detector readout system</h3>
<div id="text-7-6" class="outline-text-3">
<p>
The detector is operated by a Xilinx Virtex-6 \textbf{F}ield
\textbf{P}rogrammable \textbf{G}ate \textbf{A}rray (FPGA) in the form
of a Virtex-6 ML605 evaluation board. <sup>  <a id="fnr.24" href="#fn.24" class="footref" role="doc-backlink">24</a></sup> It is
connected to the intermediate board via two
\textbf{H}igh-\textbf{D}efinition \textbf{M}ultimedia
\textbf{I}nterface (HDMI) cables. The Virtex-6 contains the firmware
controlling the Timepix ASICs and correlating the scintillator and
FADC signals (see appendix sec. <a href="./daq.html#sec:daq:tof">17.1</a>), the Timepix Operating Firmware
(TOF). The high voltage (HV) supply both for the septemboard as well
as for the scintillators sit inside a VME crate, which also houses the
FADC. A USB connection is used to read out and control the FADC and HV
supply via the computer running the data acquisition and control
software (see sec. <a href="./daq.html#sec:daq:tos">17.2</a>), the Timepix Operating Software
(TOS). A schematic of this setup is shown in
fig. <a href="#fig:detector:flowchart_setup">20</a>, which leaves out the SiPM and
temperature readout.
</p>


<figure id="fig:detector:flowchart_setup">
<img alt="2016_detector_setup_schematic.svg" class="org-svg" src="./figs/home/basti/org/Doc/Detector/figs/2016_detector_setup_schematic.svg" />

<figcaption>Figure 20: <span class="figure-number">Figure 17: </span>Flowchart of the whole detector and readout system</figcaption>
</figure>
</div>
</div>
<div id="outline-container-sec:detector:scintillators" class="outline-3">
<h3 id="sec:detector:scintillators"><span class="section-number-3">7.7.</span> Scintillator vetoes</h3>
<div id="text-sec:detector:scintillators" class="outline-text-3">
<p>
The first general improvement is the addition of two scintillators for
veto purposes. While both have slightly different goals, each is there
to help with the removal of muon signals or muon induced events (for
example X-ray fluorescence) in the detector. Given that cosmic muons
(ref. section <a href="./theory_detector.html#sec:theory:cosmic_radiation">6.2</a>) dominate the background by
flux, statistically there is a high chance of muons creating X-ray
like signatures in the detector. By tagging muons before they interact
near the detector, these can be correlated with events seen on the
GridPix and thus possibly be vetoed if precise time information is
available.
</p>

<p>
The first scintillator is a large &apos;paddle&apos; installed above the
detector and beamline, aiming to tag a large fraction of cosmic muons
traversing in the area around the detector. It has a Canberra 2007
base and the photomultiplier tube (PMT) is a Bicron
Corp. 31.49x15.74M2BC408/2-X (first two numbers: dimensions in
inches). The full outer dimensions of the scintillator paddle are
closer to \(\SI{42}{cm} \times \SI{82}{cm}\). It is the same
scintillator paddle used during the Micromegas data taking behind the
LLNL telescope prior and after the data taking campaign with the
detector described in this thesis.
</p>

<p>
For this scintillator, muons which traverse through it and the gaseous
detector volume are not the main use case. They can be easily
identified by the geometric properties of the induced tracks (their
zenith angles are relatively small, resulting in track like signatures
as the GridPix readout is orthogonal to the zenith angle). There is a
small chance however that a muon can ionize an atom of the detector
material, which may emit an X-ray upon recombination. One particular
source of background can be attributed to the presence of copper whose
Kα lines are at \(\sim\SI{8.04}{\keV}\) as well as fluorescence of the
argon gas with its Kα lines at \(\sim\SI{2.95}{keV}\) (see. table
<a href="#tab:theory:xray_fluorescence">1</a> in sec. <a href="./theory_detector.html#sec:theory:xray_fluorescence">6.1.4</a> and
sec. <a href="./theory_detector.html#sec:theory:xray_fluorescence">6.1.4</a>).
</p>

<p>
Fig. <a href="#fig:detector:fadc_veto_paddle_expl">21(a)</a> shows a schematic of a
side view of the detector chamber with the scintillator paddle on top.
When a muon traverses the scintillator, a counter \(t_{\text{Veto}}\)
starts on the FPGA. Two different cases are shown. In the extreme, a
muon may traverse close to the cathode or close to the anode / readout
plane. This changes the time of the total drift time and therefore the
time difference between the trigger time \(t_{\text{Veto}}\) and the
readout time, which in the readout is precisely the value of the
counter on the FPGA. The drift velocity of \(\sim\SI{2}{cm.μs⁻¹}\) and
height of the detector chamber (\(\SI{3}{cm}\)) therefore allow to set
an upper limit on the maximum time between a veto paddle trigger and
the GridPix readout of about \(\SI{1.5}{μs}\). At a clock speed of
\(\SI{40}{MHz}\) this corresponds to \(\SI{60}{clock\;cycles}\), a number
we will later try to see in the data (see
sec. <a href="./background.html#sec:background:scinti_veto">12.5.1</a>). As the location at which the muon
traverses through the detector is random and homogeneous throughout
the detection volume, we expect to see a flat distribution up to the
maximum possible time and then a sharp drop (equivalent to muons at
the cathode).
</p>

<p>
The second scintillator is a small silicon photomultiplier (SiPM)
installed on the underside of the PCB on which the septemboard is
installed. This scintillator was calibrated and set up as part of
(<a href="./bibliography.html#citeproc_bib_item_205">Schmitz 2017</a>). We are interested in tagging precisely those muons,
which enter the detector orthogonally to the readout plane. This
implies zenith angles of almost \(\SI{90}{°}\) such that the elongation
in the transverse direction of the muon track is small enough to
result in a small eccentricity. From the Bethe equation the mean
energy loss of muons in the used gas mixture is about \(\SI{8}{\keV}\)
along the \(\SI{3}{\cm}\) of drift volume in the detector (see
fig. <a href="#fig:theory:muon_argon_3cm_bethe_loss">12</a> for the energy loss). This
coincides with the copper Kα lines and should lead to another source
of background in this energy range. Although the muon background will
have a much wider energy distribution than the copper lines, which are
dominated by the energy resolution of the detector. In a similar
manner to the veto paddle we can make an estimate on the typical time
scales associated from the time of the scintillator trigger to the
GridPix detection. A muon that traverses orthogonally trough the
detector can be taken to leave an instant ionization track and trigger
the SiPM at the same time (\(\mathcal{O}(\SI{100}{ps}) \ll \SI{25}{ns}\)
for one clock cycle). As such, the relevant time scale is the drift
time until enough charge has drifted towards the grid as to pass the
activation threshold.
</p>

<p>
Ionization of a muon is a statistical process, as indicated in
fig. <a href="#fig:detector:fadc_sipm_expl">21(b)</a>. Depending on the density of the
charge cloud for muons orthogonal to readout plane, time to accumulate
enough charge to trigger FADC differs. With an average energy
deposition of a muon in argon gas of \(\sim\SI{2.67}{keV.cm^{-1}}\), and
drift velocity again of \(\SI{2}{cm.μs⁻¹}\) the accumulation time can be
estimated. For example assuming an FADC activation threshold of
\(\SI{1.5}{keV}\) the necessary charge is accumulated on
\(\SI{0.56}{cm}\), which takes about \(\SI{280}{ns} \approx
\SI{11}{clock.cycles}\) to accumulate. Different tracks will have
deposited different amounts of energy. Therefore, we expect a peak at
relatively low clock cycles with a tail up to the same
\(\SI{60}{clock.cycles}\) (in case the full \(\SI{3}{cm}\) track needs to
be accumulated to activate the FADC).
</p>


<figure id="fig:detector:fadc_scintillators_explanation" class="figure-wrapper">
<figure id="fig:detector:fadc_veto_paddle_expl" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/fadc_scintillators/FADC_veto_explanation_StixTwo.svg" data-width="94%" />  <figcaption>Figure 21(a): Veto paddle</figcaption></figure> <figure id="fig:detector:fadc_sipm_expl" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/fadc_scintillators/FADC_sipm_explanation_StixTwo.svg" data-width="94%" />  <figcaption>Figure 21(b): SiPM</figcaption></figure>
<figcaption>Figure 21: <a href="#fig:detector:fadc_veto_paddle_expl">21(a)</a>Schematic of expected signals for different muons from the zenith passing through scintillator
          paddle and detector. $t_{\text{Veto}}$ marks beginning of a counter. Where the muon
          traverses changes drift time and thus time difference between two times. <a href="#fig:detector:fadc_sipm_expl">21(b)</a>Ionization of a muon is a statistical process. Depending on the density of the charge cloud
           for muons orthogonal to readout plane, time to accumulate enough charge to trigger FADC differs.</figcaption>
</figure>
</div>
<div id="outline-container-org2d0c3ad" class="outline-4">
<h4 id="org2d0c3ad"><span class="section-number-4">7.7.1.</span> Discussion of orthogonal muons on the FADC   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-7-1" class="outline-text-4">
<p>
While writing the thesis at some point I had the following thoughs:
</p>
<blockquote>
<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>QUESTION</b>: This is <b>VERY IMPORTANT</b> for our interpretation.
Given the &apos;slow&apos; drift velocity of about 2cm/μs, this means
orthogonal muons of course take about 1.5μs to traverse the
detector. The FADC trigger window is 2560 ns = 2.56 μs.
So: Does the FADC even <b>TRIGGER</b> if the charge accumulates that
slowly??? <b>UHHHHHH</b>
I mean from this we expect to have signals that are extremely long,
no? 1.5/2.5 = 0.58 of the whole trigger window! In <b>RISING EDGE</b> Or
rather a sort of flat thing, as the charge is removed &apos;quickly&apos; on
those time scales. Very confusing thought….
I mean there is a chance the FADC <b>DID NOT</b> trigger in those events,
which could explain why the FADC + SIPM aren&apos;t that effective!
-&gt; We <b>could</b> study this a bit, if we look into the FADC dataset in
which we placed the detector towards the zenith. Question: what does
the data look like, in which the <b>FADC DID NOT TRIGGER</b>? If there is
significant contribution of spherical events of ~8 keV then DUHHH.</li>
</ul>
</blockquote>

<p>
To investigate this we can use <code>plotData</code> from <code>TimepixAnalysis</code> to
make a bunch of plots comparing properties like the energy of clusters
with and without FADC. Both for the raw data as well as for the
results of the <code>likelihood</code> application (i.e. after all cuts).
</p>

<p>
We will use the entire Run-3 dataset for both cases, because the
scintillators were fully working in those.
</p>

<p>
First the plots of the raw data without FADC:
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/CastData/data/DataRuns2018_Reco.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, -0.1, 0.5)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold
</pre>
</div>

<p>
where we only plot chip 3 in the center 5·5 cm² and apply the cut to
the <code>fadcReadout</code> flag (such that we avoid any floating point
issues). <code>fadcReadout == 0</code> means no FADC and <code>1</code> means FADC.
</p>

<p>
Let&apos;s wrap them all up in one PDF:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/DataRuns2018_Reco_2023-10-03_22-41-58
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_no_fadc_histograms.pdf
</pre>
</div>


<figure id="org64f06cd">
<img alt="run3_no_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_no_fadc_histograms.svg" />

</figure>

<p>
Now the same <span class="underline">with</span> the FADC. Note for this plot change the rise time
in <code>config.toml</code> to 2500 upper and 500 bins!
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/CastData/data/DataRuns2018_Reco.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, 0.5, 1.1)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold <span style="color: #E6DB74; font-weight: bold;">\</span>
    --quiet
</pre>
</div>

<p>
Let&apos;s wrap them all up in one PDF:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/DataRuns2018_Reco_2023-10-03_23-45-37
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_with_fadc_histograms.pdf
</pre>
</div>


<figure id="org038bd7e">
<img alt="run3_with_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_with_fadc_histograms.svg" />

</figure>


<p>
And now for the result of the data with all cuts applied:
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/org/resources/lhood_lnL_04_07_23/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, -0.1, 0.5)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster_2023-10-03_22-46-10
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_lhood_no_fadc_histograms.pdf
</pre>
</div>


<figure id="org3193e43">
<img alt="run3_lhood_no_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_no_fadc_histograms.svg" />

</figure>

<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/org/resources/lhood_lnL_04_07_23/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, 0.5, 1.1)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster_2023-10-03_22-46-44
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_lhood_with_fadc_histograms.pdf
</pre>
</div>


<figure id="org760dbd6">
<img alt="run3_lhood_with_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_with_fadc_histograms.svg" />

</figure>


<p>
To summarize the results:
</p>
<ul class="org-ul">
<li><img alt="run3_no_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_no_fadc_histograms.svg" />
-&gt; This file shows that there are barely any events near the
\(\SI{8}{keV}\) range for events without an FADC trigger. This already
seems to indicate that orthogonal muons <span class="underline">should</span> be triggering the
FADC.</li>
<li><img alt="run3_with_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_with_fadc_histograms.svg" />
-&gt; Shows much higher statistics in the same range. Rise time shows a
very long tail, but no visible peaks at higher values.</li>
<li><img alt="run3_lhood_no_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_no_fadc_histograms.svg" />
-&gt; There are literally <b>no</b> events in the \(\SI{8}{keV}\) range after
the likelihood cuts without an FADC trigger!</li>
<li><img alt="run3_lhood_with_fadc_histograms.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_with_fadc_histograms.svg" />
-&gt; There are plenty of events in the \(\SI{8}{keV}\) range after
the likelihood cuts <b>with</b> the FADC. And all their rise times are
between 45 and 70 clock cycles! This means either there are no
orthogonal muons in this dataset or for some reason their rise time
is also exceptionally short, which seems surprising.</li>
</ul>

<p>
At this point we could investigate further and see what the
correlation of rise times actually looks like more generally, but
well. At least for <span class="underline">all</span> data the rise time looks unsuspicious. It&apos;s
just a long exponential like tail. 
</p>
</div>
</div>
<div id="outline-container-org8cfe316" class="outline-4">
<h4 id="org8cfe316"><span class="section-number-4">7.7.2.</span> Maximum allowed angle before being vetoed   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-7-2" class="outline-text-4">
<p>
The section below explains the reasoning behind why an angle of
\(\SI{88}{°}\) was chosen when computing the muon flux at CAST under
shallow angles in sec. <a href="./theory_detector.html#sec:theory:calc_muon_angular_flux">6.2.1</a> and why
this is the smallest angle at which a muon is likely going to pass the
normal likelihood cut and thus requires the SiPM.
</p>

<p>
The reason ϑ = 88° was chosen is due to the restriction on the maximum
allowed eccentricity for a cluster to still end up as a possible
cluster in our 8-10 keV hump. See the <code>eccentricity</code> subplot in
fig. <a href="8_10_keV_properties">26</a>.
</p>


<figure id="8_10_keV_properties">
<img alt="lhood_facet_remaining_8_10_keV.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/muonStudies/lhood_facet_remaining_8_10_keV.svg" />

<figcaption>Figure 26: <span class="figure-number">Figure 18: </span>See the eccentricity subplot for an upper limit on the allowed eccentricity for events in the 8-10 keV hump. Values should not be above ε = 1.3.</figcaption>
</figure>

<p>
From this we can deduce the eccentricity should be smaller than ε =
1.3. What does this imply for the largest possible angles allowed in
our detector? And how does the opening of the &quot;lead pipe window&quot;
correspond to this?
</p>

<p>
Let&apos;s compute by modeling a muon track as a cylinder. Reading off the
mean <code>width</code> from the above fig. to w = 5 mm and taking into account
the detector height of 3 cm we can compute the relation between
different angles and corresponding eccentricities.
</p>

<p>
In addition we will compute the largest possible angle a muon (from
the front of the detector of course) can enter, under which it does
not see the lead shielding.
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained, ggplotnim, strformat, sequtils
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">w </span>= <span style="font-style: italic;">5</span>.mm <span style="color: #75715E;"># </span><span style="color: #75715E;">mean width of a track in 8-10keV hump</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h </span>= <span style="font-style: italic;">3</span>.cm <span style="color: #75715E;"># </span><span style="color: #75715E;">detector height</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">computeLength</span><span style="color: #AE81FF;">(</span>α: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: mm =  <span style="color: #E6DB74;">## todo: add degrees?</span>
  <span style="color: #E6DB74;">## α: float # Incidence angle</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">w_prime </span>= w / cos<span style="color: #AE81FF;">(</span>α<span style="color: #AE81FF;">)</span>       <span style="color: #75715E;"># </span><span style="color: #75715E;">projected width taking incidence</span>
                                 <span style="color: #75715E;"># </span><span style="color: #75715E;">angle into account</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">L_prime</span> = tan<span style="color: #AE81FF;">(</span>α<span style="color: #AE81FF;">)</span> * h       <span style="color: #75715E;"># </span><span style="color: #75715E;">projected `</span><span style="color: #AE81FF;">&apos;length&apos;</span><span style="color: #75715E;">` of track</span>
                                 <span style="color: #75715E;"># </span><span style="color: #75715E;">from center to center</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">L_full</span> = <span style="color: #66D9EF;">L_prime</span> + w_prime <span style="color: #75715E;"># </span><span style="color: #75715E;">full `</span><span style="color: #AE81FF;">&apos;length&apos;</span><span style="color: #75715E;">` is bottom to top, thus</span>
                                 <span style="color: #75715E;"># </span><span style="color: #75715E;">+ w_prime</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">L_full</span>.to<span style="color: #AE81FF;">(</span>mm<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">computeEccentricity</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">L_full</span>, w: mm, α: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">UnitLess</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">w_prime </span>= w / cos<span style="color: #AE81FF;">(</span>α<span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">L_full</span> / w_prime

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">αs </span>= linspace<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, degToRad<span style="color: #66D9EF;">(</span><span style="font-style: italic;">25</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">εs </span>= αs.mapIt<span style="color: #AE81FF;">(</span>it.computeLength.computeEccentricity<span style="color: #66D9EF;">(</span>w, it<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">αsDeg </span>= αs.mapIt<span style="color: #AE81FF;">(</span>it.radToDeg<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>αsDeg, εs<span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">maximum eccentricity for text annotation</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">max_εs </span>= <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span>εs<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">max_αs </span>= <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span>αsDeg<span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">compute the maximum angle under which `</span><span style="color: #AE81FF;">no</span><span style="color: #75715E;">` lead is seen</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">d_open </span>= <span style="font-style: italic;">28</span>.cm <span style="color: #75715E;"># </span><span style="color: #75715E;">assume 28 cm from readout to end of lead shielding</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h_open </span>= <span style="font-style: italic;">5</span>.cm <span style="color: #75715E;"># </span><span style="color: #75715E;">assume open height is 10 cm, so 5 cm from center</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">α_limit </span>= arctan<span style="color: #AE81FF;">(</span>h_open / d_open<span style="color: #AE81FF;">)</span>.radToDeg

<span style="color: #75715E;"># </span><span style="color: #75715E;">data for the limit of 8-10 keV eccentricity</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ε_max_hump </span>= <span style="font-style: italic;">1</span>.<span style="font-style: italic;">3</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">1.2 is more reasonable, but 1.3 is the</span>
                     <span style="color: #75715E;"># </span><span style="color: #75715E;">absolute upper limit</span>
<span style="color: #F92672;">echo</span> df.head<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> α_limit
<span style="color: #F92672;">echo</span> ε_max_hump
<span style="color: #F92672;">echo</span> max_εs
<span style="color: #F92672;">echo</span> max_αs
ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;αsDeg&quot;</span>, <span style="color: #E6DB74;">&quot;εs&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = α_limit, yMin = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, yMax = max_εs<span style="color: #66D9EF;">)</span>,
                 color = color<span style="color: #66D9EF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>y = ε_max_hump, xMin = <span style="font-style: italic;">0</span>, xMax = max_αs<span style="color: #66D9EF;">)</span>,
                 color = color<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_text<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = α_limit, y = max_εs + <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>,
                      text = <span style="color: #E6DB74;">&quot;Maximum angle no lead traversed&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_text<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = <span style="font-style: italic;">17</span>.<span style="font-style: italic;">5</span>, y = ε_max_hump + <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>,
                      text = r<span style="color: #E6DB74;">&quot;Largest $ε$ in $\SIrange{8}{10}{keV}$ hump&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;$α$: Incidence angle [°]&quot;</span><span style="color: #AE81FF;">)</span> +
  ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;$ε$: Eccentricity&quot;</span><span style="color: #AE81FF;">)</span> +
  ylim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
  ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Expected eccentricity for tracks of mean width {w}&quot;</span><span style="color: #AE81FF;">)</span> +
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;~/phd/Figs/muonStudies/exp_eccentricity_given_incidence_angle.pdf&quot;</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>,
        width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span><span style="color: #AE81FF;">)</span>
</pre>
</div>


<p>
Resulting in fig. <a href="exp_eccentricity_given_incidence_angle">27</a>.
</p>


<figure id="exp_eccentricity_given_incidence_angle">
<img alt="exp_eccentricity_given_incidence_angle.svg" class="org-svg" src="./figs/home/basti/phd/Figs/muonStudies/exp_eccentricity_given_incidence_angle.svg" />

<figcaption>Figure 27: <span class="figure-number">Figure 19: </span>Relationship between incidence angle of muons of a width of 5 mm and their expected mean eccentricity. Drawn as well are the maximum angle under which no lead is seen (from the front) as well as the larges ε seen in the data.</figcaption>
</figure>

<p>
This leads to an upper bound of ~3° from the horizontal. Hence the
(somewhat arbitrary choice) of 88° for the ϑ angle above.
</p>
</div>
</div>
</div>
<div id="outline-container-sec:detector:fadc" class="outline-3">
<h3 id="sec:detector:fadc"><span class="section-number-3">7.8.</span> FADC</h3>
<div id="text-sec:detector:fadc" class="outline-text-3">
<p>
As the Timepix is read out in a shutter based fashion and typical
shutter lengths for low rate experiments are long compared to the rate
of cosmic muons, the scintillators introduced in previous section
require an external trigger to close the Timepix shutter early if a
signal is measured on the Timepix. This is one the main purposes of
the \text{f}lash \textbf{a}nalog to \textbf{d}igital
\textbf{c}onverter (FADC) that is part of the detector. This is done
by decoupling the induced analogue signals from the grid of the center
GridPix.
</p>

<p>
The specific FADC used for the detector is a Caen V1792a. It runs at
an internal \(\SI{50}{MHz}\) or \(\SI{100}{MHz}\) clock and utilizes virtual
frequency multiplication to achieve sampling rates of \(\SI{1}{GHz}\) or
\(\SI{2}{GHz}\), respectively. It has 4 channels, each with a cyclic
register of \(\num{2560}\) channels. At an operating clock frequency of
\(\SI{1}{GHz}\) that means each channel covers the last
\(\sim\SI{2.5}{\micro\second}\) at any time. (<a href="./bibliography.html#citeproc_bib_item_58">CAEN 2010</a>)
</p>

<p>
The raw signal decoupled from the grid is first fed into an Ortec 142
B pre-amplifier and then feeds into an Ortec 474 shaping amplifier,
which integrates and shapes the signal as well as amplifies it. For a
detailed introduction to this FADC system, see the thesis of
A. Deisting (<a href="./bibliography.html#citeproc_bib_item_80">Deisting 2014</a>) and (<a href="./bibliography.html#citeproc_bib_item_197">Schmidt 2016</a>) for further work
integrating it into this detector. In addition see the FADC manual
(<a href="./bibliography.html#citeproc_bib_item_58">CAEN 2010</a>) <sup>  <a id="fnr.25" href="#fn.25" class="footref" role="doc-backlink">25</a></sup> for a deep explanation of the
working principle of this FADC.
</p>

<p>
The analogue signal of the center grid is decoupled via a small
\(C_{\text{dec}} = \SI{10}{nF}\) capacitor in parallel to the high
voltage line. For a schematic of the circuit see
fig. <a href="#fig:detector:fadc_circuit">28</a>. When a primary electron traverses
through a hole in the grid and is amplified, the back flowing ions
induce a small voltage spike on top of the constant high voltage
applied to the grid. The parallel capacitor filters out the constant
high voltage and only transmits the time varying induced signals. Such
signals – the envelope of possibly many primary electrons – are
measured by the FADC.
</p>


<figure id="fig:detector:fadc_circuit">
<img alt="decouple_fadc.svg" class="org-svg" src="./figs/home/basti/phd/Figs/decouple_fadc.svg" />

<figcaption>Figure 28: <span class="figure-number">Figure 20: </span>Schematic of the setup to decouple signals induced on the grid of the InGrid. The signal is decoupled in the sense that the capacitor essentially acts as a low pass filter, thus removing the constant HV. Only the high frequency components of the induced signals on top of the HV pass into the branch leading to the FADC. In the detector of this thesis, a capacitance of \SI{10}{nF} was used instead. The decoupling is implemented on the intermediate board. Schematic taken from <a href="cite:Deisting">cite:Deisting</a>.</figcaption>
</figure>

<p>
This signal can be used for three distinct things:
</p>
<ol class="org-ol">
<li>it may be used as a trigger to close the shutter of the ongoing
event. Ideally, we want to only measure a single physical event
within one shutter window. A long shutter time can statistically
result in multiple events happening, which the FADC trigger helps
to alleviate. This allows us to reduce the number of events with
multiple physical events and acts as a trigger for the
scintillators. This in turn means possible muon induced X-ray
fluorescence can be vetoed.</li>
<li>By nature of the signal production and drift properties of the
primary electrons before they reach the grid, the signal shape can
theoretically be used to determine a rough longitudinal shape of
the event. The length of the FADC event should be proportional to
the size of the primary electron cloud distribution along the
&apos;vertical&apos; detector axis. This potentially allows to differentiate
between a muon traversing orthogonally through the readout plane
and an X-ray due to their longitudinal shape difference, see
sec. <a href="./background.html#sec:background:fadc_veto">12.5.2</a>.</li>
<li>Finally, it provides an independent measure of the collected charge
on the center chip. This will prove useful in understanding the
detector behavior over time later in
sec. <a href="./calibration.html#sec:calib:causes_variability">11.2.2</a>.</li>
</ol>

<p>
The working principle of how the FADC and the scintillators can be
used together to remove certain types of background, by correlating
events in the scintillators, the FADC and the GridPix, is shown in
fig. <a href="#fig:detector:scintillator_fadc_shutter_close">29</a>.
</p>


<figure id="fig:detector:scintillator_fadc_shutter_close">
<img alt="scintillator_fadc_shutter_close.svg" class="org-svg" src="./figs/home/basti/phd/Figs/scintillator_fadc_shutter_close.svg" />

<figcaption>Figure 29: <span class="figure-number">Figure 21: </span>Schematic showing how the FADC and scintillators are used together to tag possible coincidence events and close the shutter early to reduce the likelihood of multi-hit events. If the scintillator triggers when the shutter is open, a clock starts counting up to 4096 clock cycles. On every new trigger this clock is reset. If the FADC triggers, the scintillator clock values are read out and can be used to correlate events in the scintillator with FADC and GridPix information. Further, the FADC trigger is used to close the Timepix shutter \(\SI{5}{μs}\) after the trigger.</figcaption>
</figure>
</div>
<div id="outline-container-org01a16f6" class="outline-4">
<h4 id="org01a16f6"><span class="section-number-4">7.8.1.</span> Update schematic   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-8-1" class="outline-text-4">
<p>
Need to type out μs because we don&apos;t use <code>unicode-math</code> by default in LaTeXDSL.
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> latexdsl
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">body </span>= r<span style="color: #E6DB74;">&quot;If $Δt \lesssim \mathcal{O}(\SI{2}{\micro\second})$ events considered correlated, flag them.&quot;</span>
compile<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/tmp/text_fadc_scintillator.tex&quot;</span>, body<span style="color: #AE81FF;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:detector:sin_window" class="outline-3">
<h3 id="sec:detector:sin_window"><span class="section-number-3">7.9.</span> SiN window</h3>
<div id="text-sec:detector:sin_window" class="outline-text-3">
<p>
Next up, a major limitation of the previous detector was its limited
combined efficiency below \(\SI{2}{keV}\), due to its \(\SI{2}{μm}\) Mylar
window. Therefore, the next improvement for the new detector is an
ultra-thin silicon nitride \(\ce{Si_3 N_4}\) window of \(\SI{300}{nm}\)
thickness and \(\SI{14}{mm}\) diameter, developed by
Norcada <sup>  <a id="fnr.26" href="#fn.26" class="footref" role="doc-backlink">26</a></sup>. A strongback support structure
consisting of 4 lines of \(\SI{200}{μm}\) thick and \(\SI{500}{μm}\) wide
\(\ce{Si_3 N_4}\), helps to support a pressure difference of up to
\(\SI{1.5}{bar}\). On the outer side a \(\SI{20}{nm}\) thin layer of
aluminum is coated to allow the window to be part of the detector
cathode. The strongback occludes about \(\SI{17}{\%}\) of the full
window area. In reality it is slightly more, as the strongbacks become
somewhat wider towards the edges. In the centermost region they are
straight and in the center \(\num{5} \times \SI{5}{mm²}\) area, they
occlude \(\SI{22.2}{\%}\).
</p>

<p>
Fig. <a href="#fig:detector:strongback_structure_mc">30(a)</a> shows the idealized strongback
structure without a widening towards the edges of the
window. Fig. <a href="#fig:detector:window_image">30(b)</a> shows an image of one such
window under testing conditions in the laboratory, as it withstands a
pressure difference of \(\SI{1.5}{bar}\).
</p>


<figure id="fig:detector:window_image_and_strongback" class="figure-wrapper">
<figure id="fig:detector:strongback_structure_mc" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/SiN_window_occlusion.svg" data-width="99%" />  <figcaption>Figure 30(a): Window strongback schematic</figcaption></figure> <figure id="fig:detector:window_image" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/300nm_SiN_holds.jpg" data-width="99%" />  <figcaption>Figure 30(b): Image</figcaption></figure>
<figcaption>Figure 30: <a href="#fig:detector:strongback_structure_mc">30(a)</a>shows an idealized schematic of the window strongback based on a simple MC simulation. $\SI{22.2}{\percent}$ of the area inside the inner $\num{5} \times \SI{5}{mm^2}$ area (black square) are occluded.<a href="#fig:detector:window_image">30(b)</a>shows an image of one such window while testing in the laboratory, if it holds $\SI{1.5}{bar}$. Image courtesy of Christoph Krieger.</figcaption>
</figure>


<p>
As the main purpose is the increase of transmission at low energies,
fig. <a href="#fig:detector:window_efficiency_comparison">31</a> shows the transmission
of the mylar window of the old detector and the new \(\ce{Si_3 N_4}\)
window in the energy range below \(\SI{3}{keV}\). The \(\ce{Si_3 N_4}\) window
shows a significant increase in transmission below \(\SI{2}{keV}\), which
is very important for the sensitivity in solar axion-electron and
chameleon searches, which both peak near \(\SI{1}{keV}\) in their solar
flux. The window alone significantly increases the signal to noise
ratio of these physics searches.
</p>


<figure id="fig:detector:window_efficiency_comparison">
<img alt="window_transmisson_comparison.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/window_transmisson_comparison.svg" />

<figcaption>Figure 31: <span class="figure-number">Figure 22: </span>Comparison of the transmission of a \(\SI{2}{μm}\) Mylar window and a \(\SI{300}{nm}\) \(\ce{Si_3 N_4}\) window. The efficiency gains become more and more pronounced the lower the energy is, aside from the absorption edge of carbon at around \(\SI{250}{eV}\) and above about \(\SI{1.75}{keV}\). In the interesting range around \(\SI{1}{keV}\) significant transmission gains are achieved.</figcaption>
</figure>
</div>
<div id="outline-container-org2f3ed40" class="outline-4">
<h4 id="org2f3ed40"><span class="section-number-4">7.9.1.</span> Calculation of strongback window structure plot   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-9-1" class="outline-text-4">
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #E6DB74;">## Super dumb MC sampling over the entrance window using the Johanna&apos;s code from `</span><span style="color: #AE81FF;">raytracer2018.nim</span><span style="color: #E6DB74;">`</span>
<span style="color: #E6DB74;">## to check the coverage of the strongback of the 2018 window</span>
<span style="color: #E6DB74;">##</span>
<span style="color: #E6DB74;">## Of course one could just color areas based on the analytical description of where the</span>
<span style="color: #E6DB74;">## strongbacks are, but this is more interesting and looks fun. The good thing is it also</span>
<span style="color: #E6DB74;">## allows us to easily compute the fraction of pixels within and outside the strongbacks.</span>
<span style="color: #F92672;">import</span> ggplotnim, random, chroma
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">colorMe</span><span style="color: #AE81FF;">(</span>y: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">bool</span> =
  <span style="color: #F92672;">const</span>
    stripDistWindow = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">3</span>  <span style="color: #75715E;">#</span><span style="color: #75715E;">mm</span>
    stripWidthWindow = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">mm</span>
  <span style="color: #F92672;">if</span> <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &gt; stripDistWindow / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> <span style="color: #F92672;">and</span>
     <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &lt; stripDistWindow / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> + stripWidthWindow <span style="color: #F92672;">or</span>
     <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &gt; <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span> * stripDistWindow + stripWidthWindow <span style="color: #F92672;">and</span>
     <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &lt; <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span> * stripDistWindow + <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> * stripWidthWindow:
    <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">true</span>
  <span style="color: #F92672;">else</span>:
    <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">false</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">sample</span><span style="color: #AE81FF;">()</span> =
  randomize<span style="color: #AE81FF;">(</span><span style="font-style: italic;">423</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">nmc </span>= <span style="font-style: italic;">5_000_000</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">black </span>= color<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dataX </span>= newSeqOfCap<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span>nmc<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dataY </span>= newSeqOfCap<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span>nmc<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">strongback </span>= newSeqOfCap<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">bool</span><span style="color: #AE81FF;">](</span>nmc<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">for</span> idx <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; nmc:
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">x </span>= rand<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span> .. <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">y </span>= rand<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span> .. <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">if</span> x*x + y*y &lt; <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span> * <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span>:
      dataX.<span style="color: #F92672;">add</span> x
      dataY.<span style="color: #F92672;">add</span> y
      strongback.<span style="color: #F92672;">add</span> colorMe<span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>dataX, dataY, strongback<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;A fraction of &quot;</span>, df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>`strongback` == <span style="color: #AE81FF;">true</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>.<span style="color: #F92672;">len</span> / df.<span style="color: #F92672;">len</span>, <span style="color: #E6DB74;">&quot; is occluded by the strongback&quot;</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfGold </span>= df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #F92672;">abs</span><span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span>`dataX`, <span style="color: #66D9EF;">float</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span> &lt;= <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span> <span style="color: #F92672;">and</span>
                           <span style="color: #F92672;">abs</span><span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span>`dataY`, <span style="color: #66D9EF;">float</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span> &lt;= <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Gold region: A fraction of &quot;</span>, dfGold.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>`strongback` == <span style="color: #AE81FF;">true</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>.<span style="color: #F92672;">len</span> / dfGold.<span style="color: #F92672;">len</span>, <span style="color: #E6DB74;">&quot; is occluded by the strongback&quot;</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;dataX&quot;</span>, <span style="color: #E6DB74;">&quot;dataY&quot;</span>, fill = <span style="color: #E6DB74;">&quot;strongback&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">(</span>size = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    <span style="color: #75715E;"># </span><span style="color: #75715E;">draw the gold region as a black rectangle</span>
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>y = <span style="font-style: italic;">0</span>, x = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>y = <span style="font-style: italic;">0</span>, x = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = <span style="font-style: italic;">0</span>, y = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = <span style="font-style: italic;">0</span>, y = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;x [mm]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;y [mm]&quot;</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Idealized layout, strongback in purple&quot;</span><span style="color: #AE81FF;">)</span> +
    themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">640</span>, height = <span style="font-style: italic;">480</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span> +           
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/SiN_window_occlusion.pdf&quot;</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>, dataAsBitmap = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span><span style="color: #75715E;">#</span><span style="color: #75715E;">width = 1150, height = 1000)</span>
sample<span style="color: #AE81FF;">()</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:detector:septemboard" class="outline-3">
<h3 id="sec:detector:septemboard"><span class="section-number-3">7.10.</span> Septemboard - 6 GridPixes around a center one</h3>
<div id="text-sec:detector:septemboard" class="outline-text-3">
<p>
The main motivation for extending the readout area from a single chip
to a 7 chip readout is to reduce background towards the outer sides of
the chip, in particular in the corners. Against common intuition
however, it also plays a role for events which have cluster centers
near the center of the readout. The latter is, because diffusion can
produce quite large clusters even at low energies. In particular in
lower energy events, tracks may have gaps in them large enough to
avoid being detected as a single cluster for standard radii in cluster
searching algorithms. This is particularly of interest as different
searches produce an &apos;image&apos; at different positions and sizes on the
detector. While the center chip is large enough to fully cover the
image for essentially all models, it may not be in the regions of
lowest background. Hence, improvements to larger areas are needed.
</p>

<p>
The septemboard is implemented in such a way to optimize the loss of
active area due to bonding requirements and general manufacturing
realities. As the Timepix ASIC is a \(\SI{16.1}{mm}\) by \(\SI{14.1}{mm}\)
large chip (the bonding area adding \(\SI{2}{mm}\) on one side), the upper
two rows are installed such that they are inverted to another. The
bonding area is above the upper row and below the center row. The
bottom row again has its bonding area below. This way the top two rows
are as close together as realistically possible, with a decent gap on
the order of \(\SI{2}{mm}\) between the middle and bottom row. Any gap is
potentially problematic as it implies loss of signal in that area,
complicating the possible reconstruction methods. The layout can be
seen in fig. <a href="#fig:detector:occupancy_sparking_run_241">34</a> in the next section.
</p>

<p>
All 7 GridPix are connected in a daisy-chained way. This means that in
particular for data readout, all chips are read out in serial
order. The dead time for readouts therefore is approximately 7 times
the readout time of a single Timepix. A single Timepix has a readout
time of \(\sim\SI{25}{ms}\) at a clock frequency of \(\SI{40}{MHz}\) (the
frequency used for this detector). This leads to an expected readout
time of the full septemboard of
\(\SI{175}{ms}\). <sup>  <a id="fnr.27" href="#fn.27" class="footref" role="doc-backlink">27</a></sup> Such a long readout time
leads to a strong restriction of the possible applications for such a
detector. Fortunately, for the use cases in a very low rate experiment
such as CAST, long shutter times are possible, mitigating the effect
on the fractional dead time to a large extent.
</p>

<p>
Fig. <a href="#fig:detector:cluster_centers_likelihood">32</a> shows a heatmap of all
cluster centers during roughly \(\SI{2000}{h}\) of background data after
passing these clusters through a likelihood based cut method aiming to
filter out non X-ray like clusters (details of this follow later in
sec. <a href="./background.html#sec:background:likelihood_method">12.1</a>). It is clearly visible that the further
a cluster center is towards the chip edges, and especially the
corners, the more likely it is to be considered an X-ray like
cluster. This has an easy geometric explanation. Consider a perfect
track traversing over the whole chip. In this case it is very
eccentric. Move the same track such that its center is in one of the
corners and rotate it by \(\SI{45}{°}\) and suddenly the majority of the
track won&apos;t be detected on the chip anymore. Instead something roughly
circular remains visible, &apos;fooling&apos; the likelihood method. For a
schematic illustrating this, see fig. <a href="#fig:detector:gridpix_ring_veto_idea">33</a>.
</p>

<p>
The septemboard therefore is expected to significantly reduce the
background over the whole center chip, with the biggest effect in the
regions with the most amount of background. 
</p>


<figure id="fig:detector:cluster_centers_likelihood">
<img alt="background_cluster_centers.svg" class="org-svg" src="./figs/home/basti/phd/Figs/backgroundClusters/background_cluster_centers.svg" />

<figcaption>Figure 32: <span class="figure-number">Figure 23: </span>Cluster centers left after likelihood cut applied to about \(\SI{2000}{h}\) of background data. Background increasing dramatically towards edges and corners.</figcaption>
</figure>


<figure id="fig:detector:gridpix_ring_veto_idea">
<img alt="septem_explanation_lnL_monokai_StixTwo.svg" class="org-svg" src="./figs/home/basti/org/Figs/InGridSeptemExplanation/septem_explanation_lnL_monokai_StixTwo.svg" />

<figcaption>Figure 33: <span class="figure-number">Figure 24: </span>Illustration of the basic idea behind the GridPix veto ring. If a cluster on the center chip is X-ray like and near the corners, checking the outer chips close to the corner for a track containing the center cluster can overrule the X-ray like definition of the center chip only.</figcaption>
</figure>
</div>
<div id="outline-container-org9055ab0" class="outline-4">
<h4 id="org9055ab0"><span class="section-number-4">7.10.1.</span> GridPix veto ring illustration   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-10-1" class="outline-text-4">
<p>
The event used in the illustration is event 23707 of run 242.
</p>

<p>
The full event display:
<img alt="example_track_corner_gridpix_ring_run242_event23707.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/exampleEvents/example_track_corner_gridpix_ring_run242_event23707.svg" />
</p>

<p>
and the SVG of the illustration:
<img alt="septem_explanation_lnL_monokai.svg" class="org-svg" src="./../org/Figs/InGridSeptemExplanation/septem_explanation_lnL_monokai.svg" />
</p>
</div>
</div>
<div id="outline-container-org4922644" class="outline-4">
<h4 id="org4922644"><span class="section-number-4">7.10.2.</span> Compute the cluster backgrounds   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-10-2" class="outline-text-4">
<p>
To compute these cluster backgrounds, we need the following
ingredients:
</p>
<ul class="org-ul">
<li>the fully reconstructed data files <code>DataRuns201*_Reco.h5</code></li>
<li>the prepared CDL data from the 2019 dataset
<code>calibration-cdl_2019.h5</code> and the X-ray reference datasets that
define the X-ray like properties.</li>
<li>apply the likelihood method to all background events in one of the
files (gives enough statistics) to get a resulting file containing
only passed clusters <b>over the whole chip</b>.</li>
</ul>

<p>
With the resulting file we can then use
<a href="./../CastData/ExternCode/TimepixAnalysis/Plotting/plotBackgroundClusters/plotBackgroundClusters.nim">./../CastData/ExternCode/TimepixAnalysis/Plotting/plotBackgroundClusters/plotBackgroundClusters.nim</a>
to plot these cluster centers.
</p>

<p>
Assuming the reconstructed data files are found in <b>…</b> and the CDL
data files in <b>…</b>, let&apos;s generate the data after likelihood method:
(this takes ~2 minutes or so, so better run it in a terminal instead of
via C-c C-c)
</p>
<div class="org-src-container">
<pre class="src src-sh">likelihood <span style="color: #E6DB74; font-weight: bold;">\</span>
    -f ~/CastData/data/DataRuns2017_Reco.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5out /tmp/lhood_2017_full_chip.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cdlYear=2018 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region=crAll <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cdlFile=/home/basti/CastData/data/CDL_2019/calibration-cdl-2018.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --lnL
</pre>
</div>

<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>WHY DOES THIS</b> produce background suppression numbers below 1
towards the corners?</li>
</ul>


<p>
Compile the plotting tool if not done:
</p>
<div class="org-src-container">
<pre class="src src-sh">nim c -d:danger --threads:on plotBackgroundClusters.nim
</pre>
</div>

<p>
Now we can create the plot. Note that we use <code>fWidth = 0.8</code> so that
(as of right now <span class="timestamp-wrapper">  <span class="timestamp">&lt;2023-12-06 Wed 12:11&gt;</span></span>) the heatmap fits on one page
with the septem veto illustration.
</p>
<div class="org-src-container">
<pre class="src src-sh">plotBackgroundClusters <span style="color: #E6DB74; font-weight: bold;">\</span>
    -f ~/org/resources/lhood_lnL_17_11_23_septem_fixed/lhood_c18_R2_crAll_sEff_0.8_lnL.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --title <span style="color: #E6DB74;">&quot;2000 h background data, lnL cut applied&quot;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --outpath ~/phd/Figs/backgroundClusters/ <span style="color: #E6DB74; font-weight: bold;">\</span>
    --energyMin 0.2 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --energyMax 12.0 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --zMax 15.0 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --singlePlot <span style="color: #E6DB74; font-weight: bold;">\</span>
    --fWidth 0.8 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --useTikZ
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:detector:water_cooling" class="outline-3">
<h3 id="sec:detector:water_cooling"><span class="section-number-3">7.11.</span> Water cooling and temperature readout for the septemboard</h3>
<div id="text-sec:detector:water_cooling" class="outline-text-3">
<p>
During development of the septemboard one particular set of problems
manifested. While testing a prototype board with 5 active GridPix in a
gaseous detector, the readout was plagued by excessive noise
problems. The detector exhibited a large number of frames with more
than \(\num{4096}\) active pixels (the limit for a zero suppressed
readout) and common pixel values of \(\num{11810}\) indicating overrun ToT
counters. On an occupancy (sum of all active pixels) of the individual
chips, it is quite visible the data is clearly not due to cosmic
background. Fig. <a href="#fig:detector:occupancy_sparking_run_241">34</a> shows such an
occupancy with the color scale topping out at the \(80^{\text{th}}\)
percentile of the counts for each chip individually. The chip in the
bottom left shows a large number of sparks (overlapping half ellipses
pointing downwards) at the top end. Especially the center chip in the
top row shows highly structured activity, which is in contrast to the
expectation of a homogeneous occupancy for a normal background
run. In addition, on all chips some level of general noise on certain
pixels is visible (some being clearly more active than others
resulting in a scatter of &apos;points&apos;).
</p>


<figure id="fig:detector:occupancy_sparking_run_241">
<img alt="sparking_occupancy_80_quantile_run_241.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/sparking/sparking_occupancy_80_quantile_run_241.svg" />

<figcaption>Figure 34: <span class="figure-number">Figure 25: </span>Occupancy of a testing background run with \(\mathcal{O}(\SI{1}{s})\) long frames using septemboard F during development without any kind of cooling. This also shows the layout of the full septemboard with realistic spacing.</figcaption>
</figure>

<p>
The intermediate board and carrier board used during these tests were
the first boards equipped with two PT1000 temperature sensors. One on
the bottom side of the carrier board and another on the intermediate
board. Each is read out using a <code>MAX31685</code> micro controllers. Both of
which are communicated with via a <code>MCP2210</code> USB-to-SPI micro
controllers over a single USB port on the intermediate board. The
single <code>MCP2210</code> communicates with both temperature sensors via the
Serial Peripheral Interface (SPI) (see
sec. <a href="./daq.html#sec:daq:temperature_readout">17.2.4</a> for more information about the
temperature logging and readout). In the run shown in
fig. <a href="#fig:detector:occupancy_sparking_run_241">34</a> the temperature sensors
were not functional yet, as the readout software was not written. The
required logic was added to the Timepix Operating Software (TOS), the
readout software of the detector, motivated by this noise activity to
monitor the temperature before and during a data taking period. The
temperature on the carrier board indicated temperatures of
\(\sim\SI{75}{\celsius}\) in background runs similar to the one of
fig. <a href="#fig:detector:occupancy_sparking_run_241">34</a>. One way to get a measure
for the noise-like activity seen on the detector is to look at the
rate of active pixels over time. With values well above numbers
expected due to background, excess temperature seemed a possible cause
for the issues. As no proper cooling mechanism was available, a
regular desk fan was placed pointing at the detector when it was run
without any kind of shielding. This saw the temperature under the
carrier board drop from \(\SI{76}{\celsius}\) down to
\(\SI{68}{\celsius}\). As a result the majority of noise disappeared as
can be seen in fig. <a href="#fig:detector:sparking_run_with_fan_mean_hits">35(b)</a>
with the temperature curve during the full run in
fig. <a href="#fig:detector:sparking_run_with_fan_temps">35(a)</a>. <sup>  <a id="fnr.28" href="#fn.28" class="footref" role="doc-backlink">28</a></sup> <sup>, </sup><sup>  <a id="fnr.29" href="#fn.29" class="footref" role="doc-backlink">29</a></sup>
</p>

<p>
The features visible in the occupancy plots are thus likely multiple
different artifacts due to too high temperatures. A mixture of real
sparks (bottom left chip in
fig. <a href="#fig:detector:occupancy_sparking_run_241">34</a>) and possible
instabilities that possibly affect voltages for the pixels (and thus
change the thresholds of each pixel). As the temperature is measured
on the bottom side of the carrier board, temperatures in the
amplification region are likely higher. 
</p>


<figure id="fig:detector:sparking_run_with_fan" class="figure-wrapper">
<figure id="fig:detector:sparking_run_with_fan_temps" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/sparking/temperature_sparking_run_268.svg" data-width="99%" />  <figcaption>Figure 35(a): Temperature</figcaption></figure> <figure id="fig:detector:sparking_run_with_fan_mean_hits" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/sparking/mean_hit_rate_sparking_run_268.svg" data-width="99%" />  <figcaption>Figure 35(b): Mean hit rate</figcaption></figure>
<figcaption>Figure 35: <a href="#fig:detector:sparking_run_with_fan_temps">35(a)</a> shows the temperature on the bottom side of the
          carrier board (&apos;septem&apos;) and intermediate board (&apos;IMB&apos;) during the background run. The point at which
          the desk fan is placed next to the detector is clearly visible by the $\SI{8}{\celsius}$ drop in
          temperature from about $\SI{76}{\celsius}$ to $\SI{68}{\celsius}$. <a href="#fig:detector:sparking_run_with_fan_mean_hits">35(b)</a> shows the mean hit rate of each of the 5 chips
          installed on the carrier board at the time during the same run. The placement of the desk fan is easily
          visible as a reduction in mean rate on all chips.</figcaption>
</figure>


<p>
Following this a bespoke water cooling was designed by T. Schiffer,
made from oxygen-free copper with \(\SI{3}{mm}\) channels for water to
circulate through the copper body. (<a href="./bibliography.html#citeproc_bib_item_194">Schiffer 2024</a>) The body has the
same diameter as the intermediate board and is installed right
below. The water circulation is handled by an off-the-shelf pump and
radiator from Alphacool <sup>  <a id="fnr.30" href="#fn.30" class="footref" role="doc-backlink">30</a></sup> intended for water
cooling setups for desktop computers. The pump manages a water flow
rate of about \(\SI{0.3}{\liter\per\minute}\) through the \(\SI{3}{mm}\)
channels in the copper. In common operation the temperatures on the
carrier board are between \(\SIrange{45}{50}{\celsius}\) and noise free
operation is possible.
</p>
</div>
<div id="outline-container-sec:detector:sparking_behavior" class="outline-4">
<h4 id="sec:detector:sparking_behavior"><span class="section-number-4">7.11.1.</span> Sparking behavior   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-sec:detector:sparking_behavior" class="outline-text-4">
<p>
See the mails containing &quot;Septem F&quot; (among other things) for the
information about sparking behavior. From that we can also deduce the
run numbers of the noisy runs (run 241 is one of them); just keep in
mind that the run numbers are overlapping with some CAST run numbers,
as for CAST we started again at 0.
</p>

<p>
Specific run path of noisy run used in occupancy plot above:
<code>Run_241_170216-13-49</code>
So run from February 2017.
</p>


<p>
Let&apos;s plot the temperature during the sparking run in which we
installed the fan.
</p>

<p>
This is essentially a reproducible version of the following plot:
<img alt="temps_plot_septemF_76_68deg_1s.svg" class="org-svg" src="./figs/home/basti/org/Figs/temps_plot_septemF_76_68deg_1s.svg" />
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> ggplotnim, times

<span style="color: #75715E;"># </span><span style="color: #75715E;">Laptop:</span>
<span style="color: #75715E;">#</span><span style="color: #75715E;">const path = &quot;/mnt/1TB/CAST/2017/development/Run_268_170418-05-43/temp_log.txt&quot;</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">Desktop:</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;~/CastData/data/2017/development/Run_268_170418-05-43/temp_log.txt&quot;</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">p</span><span style="color: #AE81FF;">(</span>x: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DateTime</span> =
  <span style="color: #FD971F;">result</span> = x.parse<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;YYYY-MM-dd&apos;.&apos;HH:mm:ss&quot;</span>, local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= readCsv<span style="color: #AE81FF;">(</span>path, sep = <span style="color: #E6DB74;">&apos;\t&apos;</span>, skipLines = <span style="font-style: italic;">2</span>, colNames = @<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;IMB&quot;</span>, <span style="color: #E6DB74;">&quot;Septem&quot;</span>, <span style="color: #E6DB74;">&quot;DateTime&quot;</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  .filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">string</span> -&gt; <span style="color: #66D9EF;">bool</span>: p<span style="color: #A6E22E;">(</span>`<span style="color: #66D9EF;">DateTime</span>`<span style="color: #A6E22E;">)</span> &lt; initDateTime<span style="color: #A6E22E;">(</span><span style="font-style: italic;">19</span>, mApr, <span style="font-style: italic;">2017</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, local<span style="color: #E6DB74;">()</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  .gather<span style="color: #AE81FF;">(</span>@<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;IMB&quot;</span>, <span style="color: #E6DB74;">&quot;Septem&quot;</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;Type&quot;</span>, <span style="color: #E6DB74;">&quot;Temperature&quot;</span><span style="color: #AE81FF;">)</span>
  .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span> ~ p<span style="color: #A6E22E;">(</span>`<span style="color: #66D9EF;">DateTime</span>`<span style="color: #A6E22E;">)</span>.toTime<span style="color: #A6E22E;">()</span>.toUnix<span style="color: #A6E22E;">()</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>

<span style="color: #E6DB74;">## XXX: fix plotting of string columns as date scales, due to discrete / continuous mismatch and lacking</span>
<span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">dataScale</span><span style="color: #E6DB74;">` field</span>
ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span>, <span style="color: #E6DB74;">&quot;Temperature&quot;</span>, color = <span style="color: #E6DB74;">&quot;Type&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  <span style="color: #75715E;"># </span><span style="color: #75715E;">scale_x_continuous() +</span>
  ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Temperature on 2017/04/18 with fan&quot;</span><span style="color: #AE81FF;">)</span> + 
  xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Time of day&quot;</span>, margin = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">25</span>, rotate = -<span style="font-style: italic;">45</span>.<span style="font-style: italic;">0</span>, alignTo = <span style="color: #E6DB74;">&quot;right&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Temperature [°C]&quot;</span><span style="color: #AE81FF;">)</span> +
  margin<span style="color: #AE81FF;">(</span>bottom = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span>, right = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + 
  scale_x_date<span style="color: #AE81FF;">(</span>isTimestamp = <span style="color: #AE81FF;">true</span>,
               formatString = <span style="color: #E6DB74;">&quot;HH:mm:ss&quot;</span>,
               dateSpacing = initDuration<span style="color: #66D9EF;">(</span>hours = <span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>,
               dateAlgo = dtaAddDuration,
               timeZone = local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">420</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/temperature_sparking_run_268.pdf&quot;</span>,
        width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
df.writeCsv<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/resources/temperature_sparking_run_268.csv&quot;</span><span style="color: #AE81FF;">)</span>  
</pre>
</div>

<p>
Next up we need to compute the mean hit rate of the four most active
chips and plot it against time.
</p>

<p>
How will we go about doing that? Read and reconstruct the run, then
manually extract hits per time, bin by time and that&apos;s it?
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #75715E;"># </span><span style="color: #75715E;">cd /mnt/1TB/CAST/2017/development/</span>
<span style="color: #F92672;">cd</span> ~/CastData/data/2017/development/
raw_data_manipulation -p Run_268_170418-05-43 --runType background --out raw_268_sparking.h5
reconstruction -i raw_268_sparking.h5 --out reco_268_sparking.h5
</pre>
</div>

<p>
With the resulting file, we can now generate the plot of the hits over
time.
</p>

<p>
This is a reproducible version of the following plot:
<img alt="hitrate_per_time_septemF_76_68deg_1s.svg" class="org-svg" src="./figs/home/basti/org/Figs/hitrate_per_time_septemF_76_68deg_1s.svg" />
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>options, sequtils, times<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> ggplotnim, nimhdf5, unchained
defUnit<span style="color: #AE81FF;">(</span>Second⁻¹<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">import</span> ingrid / tos_helpers
<span style="color: #75715E;"># </span><span style="color: #75715E;">Laptop</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">const path = &quot;/mnt/1TB/CAST/2017/development/reco_268_sparking.h5&quot;</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">Desktop</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;~/CastData/data/2017/development/reco_268_sparking.h5&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>path, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>
<span style="color: #F92672;">var</span> <span style="color: #FD971F;">dfR </span>= newDataFrame<span style="color: #AE81FF;">()</span>
<span style="color: #F92672;">for</span> chip <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">5</span>:
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dsets </span>= @<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;hits&quot;</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfC </span>= h5f.readRunDsets<span style="color: #AE81FF;">(</span>
    <span style="font-style: italic;">268</span>,
    chipDsets = some<span style="color: #66D9EF;">(</span><span style="color: #A6E22E;">(</span>chip: chip, dsets: dsets<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>,
    commonDsets = @<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;timestamp&quot;</span><span style="color: #66D9EF;">]</span>
  <span style="color: #AE81FF;">)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;chip&quot;</span> &lt;- chip<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    .arrange<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;timestamp&quot;</span><span style="color: #AE81FF;">)</span>
  df.<span style="color: #F92672;">add</span> dfC

  <span style="color: #75715E;"># </span><span style="color: #75715E;">and directly compute the hit frequency</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">hits </span>= dfC<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;hits&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">time </span>= dfC<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;timestamp&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ts </span>= time.map_inline<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>x - time<span style="color: #A6E22E;">[</span><span style="font-style: italic;">0</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">)</span>.s<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">const</span> <span style="color: #66D9EF;">Interval</span> = <span style="font-style: italic;">30</span>.<span style="color: #F92672;">min</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">i </span>= <span style="font-style: italic;">0</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">rate </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span>Second⁻¹<span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">rateTime </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">while</span> i &lt; time.<span style="color: #F92672;">len</span>:
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">h </span>= <span style="font-style: italic;">0</span>
    <span style="color: #F92672;">var</span> <span style="color: #66D9EF;">Δt</span> = <span style="font-style: italic;">0</span>.s
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">t0 </span>= time<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
    <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Starting at t0 = &quot;</span>, t0
    <span style="color: #F92672;">while</span> <span style="color: #66D9EF;">Δt</span> &lt; <span style="color: #66D9EF;">Interval</span> <span style="color: #F92672;">and</span> i &lt; time.<span style="color: #F92672;">len</span>:
      h += hits<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
      <span style="color: #F92672;">if</span> i &gt; <span style="font-style: italic;">0</span>:
        <span style="color: #66D9EF;">Δt</span> += ts<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> - ts<span style="color: #AE81FF;">[</span>i-<span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>
      <span style="color: #F92672;">inc</span> i
    rate.<span style="color: #F92672;">add</span> <span style="color: #AE81FF;">(</span>h.<span style="color: #66D9EF;">float</span> / <span style="color: #66D9EF;">Δt</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;To &quot;</span>, time<span style="color: #AE81FF;">[</span>i-<span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>
    rateTime.<span style="color: #F92672;">add</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>time<span style="color: #A6E22E;">[</span>i-<span style="font-style: italic;">1</span><span style="color: #A6E22E;">]</span> + t0<span style="color: #66D9EF;">)</span> / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    h = <span style="font-style: italic;">0</span>
  dfR.<span style="color: #F92672;">add</span> toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;rate&quot;</span> : rate.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>, rateTime, <span style="color: #E6DB74;">&quot;chip&quot;</span> : chip<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> df
<span style="color: #F92672;">echo</span> dfR

dfR = dfR.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">int</span> -&gt; <span style="color: #66D9EF;">bool</span>: fromUnix<span style="color: #A6E22E;">(</span>`rateTime`<span style="color: #A6E22E;">)</span>.inZone<span style="color: #A6E22E;">(</span>local<span style="color: #E6DB74;">()</span><span style="color: #A6E22E;">)</span> &lt; initDateTime<span style="color: #A6E22E;">(</span><span style="font-style: italic;">19</span>, mApr, <span style="font-style: italic;">2017</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, local<span style="color: #E6DB74;">()</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
ggplot<span style="color: #AE81FF;">(</span>dfR, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;rateTime&quot;</span>, <span style="color: #E6DB74;">&quot;rate&quot;</span>, color = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;chip&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_point<span style="color: #AE81FF;">()</span> +
  scale_y_log10<span style="color: #AE81FF;">()</span> + 
  scale_x_date<span style="color: #AE81FF;">(</span>isTimestamp = <span style="color: #AE81FF;">true</span>,
               formatString = <span style="color: #E6DB74;">&quot;HH:mm:ss&quot;</span>,
               dateSpacing = initDuration<span style="color: #66D9EF;">(</span>hours = <span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>,
               dateAlgo = dtaAddDuration,
               timeZone = local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">420</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span> +
  margin<span style="color: #AE81FF;">(</span>bottom = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span>, right = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +   
  xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Time of day&quot;</span>, margin = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">25</span>, rotate = -<span style="font-style: italic;">45</span>.<span style="font-style: italic;">0</span>, alignTo = <span style="color: #E6DB74;">&quot;right&quot;</span><span style="color: #AE81FF;">)</span> + 
  ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Rate [$\si{pixel.s^{-1}}$]&quot;</span><span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/mean_hit_rate_sparking_run_268.pdf&quot;</span>,
        width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span>, useTex = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>

dfR.writeCsv<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/resources/mean_hit_rate_sparking_run_268.csv&quot;</span>, precision = <span style="font-style: italic;">10</span><span style="color: #AE81FF;">)</span>
</pre>
</div>

<p>
Finally, combine both and plot together:
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / times
<span style="color: #F92672;">import</span> ggplotnim
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/home/basti/phd/resources/&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= readCsv<span style="color: #AE81FF;">(</span>path &amp; <span style="color: #E6DB74;">&quot;temperature_sparking_run_268.csv&quot;</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfR </span>= readCsv<span style="color: #AE81FF;">(</span>path &amp; <span style="color: #E6DB74;">&quot;mean_hit_rate_sparking_run_268.csv&quot;</span><span style="color: #AE81FF;">)</span>
  .group_by<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;chip&quot;</span><span style="color: #AE81FF;">)</span>
  .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;rateNorm&quot;</span> ~ `rate` / <span style="color: #F92672;">max</span><span style="color: #A6E22E;">(</span>`rate`<span style="color: #A6E22E;">)</span> * <span style="font-style: italic;">80</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;rateTime&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">sa </span>= secAxis<span style="color: #AE81FF;">(</span>name = <span style="color: #E6DB74;">&quot;Hit rate [a.u.]&quot;</span>,
                 trans = f<span style="color: #66D9EF;">{</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / <span style="font-style: italic;">80</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
                 <span style="color: #75715E;">#</span><span style="color: #75715E;">invTransFn = f{`</span><span style="color: #AE81FF;">rateNorm</span><span style="color: #75715E;">` * 80.0})</span>

ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span>, <span style="color: #E6DB74;">&quot;Temperature&quot;</span>, color = <span style="color: #E6DB74;">&quot;Type&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  geom_point<span style="color: #AE81FF;">(</span>data = dfR, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span>, <span style="color: #E6DB74;">&quot;rateNorm&quot;</span>, color = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;chip&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> + 
  <span style="color: #75715E;"># </span><span style="color: #75715E;">ggtitle(&quot;Temperature during run on 2017/04/18 in which fan was placed next to detector&quot;) + </span>
  xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Time of day&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Temperature [°C]&quot;</span><span style="color: #AE81FF;">)</span> +
  margin<span style="color: #AE81FF;">(</span>top = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
  scale_y_continuous<span style="color: #AE81FF;">(</span>secAxis = sa<span style="color: #AE81FF;">)</span> + 
  scale_x_date<span style="color: #AE81FF;">(</span>isTimestamp = <span style="color: #AE81FF;">true</span>,
               formatString = <span style="color: #E6DB74;">&quot;HH:mm:ss&quot;</span>,
               dateSpacing = initDuration<span style="color: #66D9EF;">(</span>hours = <span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>,
               dateAlgo = dtaAddDuration,
               timeZone = local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span> + 
  legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">835</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> +
  yMargin<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">05</span><span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/temperature_and_sparking_run_268.pdf&quot;</span><span style="color: #AE81FF;">)</span>

</pre>
</div>


<p>
And finally, let&apos;s also recreate the occupancy plot
<img alt="occupancy_sparking_septem5chips_300V.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/sparking/occupancy_sparking_septem5chips_300V.svg" /> of run 241 during
development to showcase the sparking behavior.
</p>

<p>
In order to do that, we first need to reconstruct the run containing
the data:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #F92672;">cd</span> /mnt/1TB/CAST/2017/development/
raw_data_manipulation -p Run_241_170216-13-49 --runType background --out raw_241_sparking.h5
reconstruction raw_241_sparking.h5 --out reco_241_sparking.h5
</pre>
</div>

<p>
With the reconstructed data file at hand, we can first of all generate
a large number of plots for each chip:
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData --h5file reco_241_sparking.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
         --runType rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
         --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
         --ingrid --occupancy
</pre>
</div>
<p>
which can be adjusted according to the user&apos;s preference of course.
</p>

<p>
(For this plot in particular it&apos;s really important not use the <code>ToT</code>
cutting feature in <code>raw_data_manipulation</code> via the <code>rmToTLow</code> and
<code>rmToTHigh</code> in the <code>config.toml</code> file)
</p>

<p>
With the file in place, let&apos;s now create the plot of the occupancies
for each chip, embedded in the layout of the septemboard (at least for
the 5 chips that were on this septemboard F).
</p>


<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>REPLACE BELOW PLACEMENT BY <code>geometry.nim</code> IMPLEMENTATION</b></li>
</ul>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / os <span style="color: #F92672;">except</span> <span style="color: #66D9EF;">FileInfo</span>
<span style="color: #F92672;">import</span> std / strutils
<span style="color: #F92672;">import</span> ingrid / <span style="color: #AE81FF;">[</span>tos_helpers, ingrid_types<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> nimhdf5, ggplotnim, ginger

<span style="color: #E6DB74;">## The Septemboard layout code is a port of the code used in the python based event </span>
<span style="color: #E6DB74;">## display for TOS.</span>

<span style="color: #F92672;">const</span>
  <span style="color: #66D9EF;">Width</span> = <span style="font-style: italic;">14</span>.<span style="font-style: italic;">1</span>
  <span style="color: #66D9EF;">Height</span> = <span style="font-style: italic;">14</span>.<span style="font-style: italic;">1</span>
  <span style="color: #66D9EF;">BondHeight</span> = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span>
  <span style="color: #66D9EF;">FullHeight</span> = <span style="color: #66D9EF;">Height</span> + <span style="color: #66D9EF;">BondHeight</span>
  <span style="color: #66D9EF;">NumChips</span> = <span style="font-style: italic;">7</span>

  <span style="color: #75715E;"># </span><span style="color: #75715E;">If this is set to `</span><span style="color: #AE81FF;">true</span><span style="color: #75715E;">` the final plot will only contain the actual raster image. No legend or axes</span>
  <span style="color: #66D9EF;">OnlyRaster</span> = <span style="color: #AE81FF;">true</span>

  <span style="color: #66D9EF;">Run</span> = <span style="font-style: italic;">241</span>

<span style="color: #F92672;">type</span>
  <span style="color: #66D9EF;">SeptemRow</span> = <span style="color: #F92672;">object</span>
    left: <span style="color: #66D9EF;">float</span>
    right: <span style="color: #66D9EF;">float</span>
    wspace: <span style="color: #66D9EF;">float</span>
    top: <span style="color: #66D9EF;">float</span>
    bottom: <span style="color: #66D9EF;">float</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initSeptemRow</span><span style="color: #AE81FF;">(</span>nChips: <span style="color: #66D9EF;">int</span>, x_size, y_size, x_dist, x_offset, y_t_offset, y_b_offset, dist_to_row_below: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">SeptemRow</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">this class implements a single row of chips of the septem board</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">nChips: number of chips in row</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">x_dist: distance in x direction between each chip</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">x_offset: offset of left edge of first chip in row from</span>
  <span style="color: #75715E;">#           </span><span style="color: #75715E;">left side of center row</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">calculate width and height of row, based on chips and dist</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">width </span>= nChips.<span style="color: #66D9EF;">float</span> * <span style="color: #66D9EF;">Width</span> + <span style="color: #AE81FF;">(</span>nChips - <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span>.<span style="color: #66D9EF;">float</span> * x_dist
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">height_active </span>= <span style="color: #66D9EF;">Height</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">height_full </span>= <span style="color: #66D9EF;">FullHeight</span> + dist_to_row_below
  <span style="color: #75715E;"># </span><span style="color: #75715E;">using calc gridspec one calculates the coordinates of the row on</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">the figure in relative canvas coordinates</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">include padding by adding or subtracting from left, right, top, bottom</span>
  <span style="color: #FD971F;">result</span>.left      = x_offset / x_size
  <span style="color: #FD971F;">result</span>.right     = <span style="color: #FD971F;">result</span>.left + width / x_size
  <span style="color: #FD971F;">result</span>.wspace    = x_dist / x_size
  <span style="color: #FD971F;">result</span>.top       = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - y_t_offset / y_size
  <span style="color: #FD971F;">result</span>.bottom    = <span style="color: #FD971F;">result</span>.top - height_active / y_size

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initSeptemBoard</span><span style="color: #AE81FF;">(</span>padding, fig_x_size, fig_y_size, scaling_factor: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">SeptemRow</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">implements the septem board, being built from 3 septem rows</span>

  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initRows</span><span style="color: #AE81FF;">(</span>y_size, scaled_x_size, scaled_y_size, y_row1_row2, y_row2_row3, row2_x_dist: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">SeptemRow</span><span style="color: #AE81FF;">]</span> =
    <span style="color: #75715E;"># </span><span style="color: #75715E;">this function creates the row objects for the septem class</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">calculation of row 1 top and bottom (in abs. coords.):</span>
    <span style="color: #F92672;">let</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">(top need to add padding to top of row 1)</span>
      row1_y_top    = y_size - <span style="color: #66D9EF;">BondHeight</span> - <span style="color: #66D9EF;">Height</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">bottom in abs. coords.</span>
      row1_y_bottom = <span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">FullHeight</span> + y_row1_row2 + y_row2_row3 - <span style="color: #66D9EF;">Height</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">offset of left side from septem in abs. coords.</span>
      row1_x_offset = <span style="font-style: italic;">6</span>.<span style="font-style: italic;">95</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">now create the first row with all absolute coordinates</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> initSeptemRow<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>, scaled_x_size, scaled_y_size, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">85</span>, row1_x_offset, row1_y_top, row1_y_bottom, y_row1_row2<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">calculation of row 2 top and bottom (top &amp; bottom of row2 not affected by padding):</span>
    <span style="color: #F92672;">let</span>
      row2_y_top    = y_size - <span style="color: #66D9EF;">FullHeight</span> - y_row1_row2 - <span style="color: #66D9EF;">Height</span>
      row2_y_bottom = <span style="color: #66D9EF;">FullHeight</span> + y_row2_row3 + <span style="color: #66D9EF;">BondHeight</span> - <span style="color: #66D9EF;">Height</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">no offset for row2, defines our left most position in abs. coords.</span>
      row2_x_offset = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">padding * x_size</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> initSeptemRow<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>, scaled_x_size, scaled_y_size, row2_x_dist, row2_x_offset, row2_y_top, row2_y_bottom, y_row2_row3<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">calculation of row 3 top and bottom (add padding to bottom):</span>
    <span style="color: #F92672;">let</span>
      row3_y_top    = y_size - <span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">FullHeight</span> - y_row1_row2 - y_row2_row3 - <span style="color: #66D9EF;">Height</span>
      row3_y_bottom = <span style="color: #66D9EF;">BondHeight</span> - <span style="color: #66D9EF;">Height</span>
      row3_x_offset = <span style="font-style: italic;">7</span>.<span style="font-style: italic;">22</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> initSeptemRow<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>, scaled_x_size, scaled_y_size, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">35</span>, row3_x_offset, row3_y_top, row3_y_bottom, <span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>

  <span style="color: #75715E;"># </span><span style="color: #75715E;">include a padding all around the septem event display of &apos;padding&apos;</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">use size of figure to scale septem accordingly to have it always properly</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">scaled for the given figure</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">take the inverse of the scaling factor (want 1/2 as input to scale to half size)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">scaling_factor </span>= <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / scaling_factor
  <span style="color: #75715E;"># </span><span style="color: #75715E;">first calculate the ratio of the figure</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fig_ratio </span>= <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>fig_x_size<span style="color: #AE81FF;">)</span> / <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>fig_y_size<span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">distances between different rows in absolute coordinates</span>
  <span style="color: #F92672;">let</span>
    y_row1_row2 = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">38</span>
    y_row2_row3 = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">1</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">size in y direction of whole septem board in absolute coordinates</span>
    y_size      = <span style="font-style: italic;">3</span> * <span style="color: #66D9EF;">FullHeight</span> + y_row1_row2 + y_row2_row3
    <span style="color: #75715E;"># </span><span style="color: #75715E;">already define row2_x_dist here (in absolute coordinates) to calculate x_size</span>
    row2_x_dist = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">35</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">3 chips * width + 2 * distance between chips (in absolute coordinates)</span>
    x_size      = <span style="font-style: italic;">3</span> * <span style="color: #66D9EF;">Width</span> + <span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span> - <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> * row2_x_dist
  <span style="color: #75715E;"># </span><span style="color: #75715E;">calculate the ratio of the septem board</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">ratio </span>= <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>x_size<span style="color: #AE81FF;">)</span> / <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>y_size<span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">now calculate the needed ratio to get the correct scaling of the septem on any</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">figure scale. fig_ratio / own ratio</span>
  ratio = fig_ratio / ratio
  <span style="color: #F92672;">let</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">scaled x and y sizes</span>
    scaled_x_size = x_size * ratio * scaling_factor
    scaled_y_size = y_size * scaling_factor
  <span style="color: #75715E;"># </span><span style="color: #75715E;">and now create the row objects</span>
  <span style="color: #FD971F;">result</span> = initRows<span style="color: #AE81FF;">(</span>y_size, scaled_x_size, scaled_y_size, y_row1_row2, y_row2_row3, row2_x_dist<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readVlen</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>,
              fileInfo: <span style="color: #66D9EF;">FileInfo</span>,
              runNumber: <span style="color: #66D9EF;">int</span>,
              dsetName: <span style="color: #66D9EF;">string</span>,
              chipNumber = <span style="font-style: italic;">0</span>,
              dtype: <span style="color: #66D9EF;">typedesc</span> = <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span>dtype<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #E6DB74;">## reads variable length data `</span><span style="color: #AE81FF;">dsetName</span><span style="color: #E6DB74;">` and returns it</span>
  <span style="color: #E6DB74;">## In contrast to `</span><span style="color: #AE81FF;">read</span><span style="color: #E6DB74;">` this proc does *not* convert the data.</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">vlenDtype </span>= special_type<span style="color: #AE81FF;">(</span>dtype<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dset </span>= h5f<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span>fileInfo.dataPath<span style="color: #A6E22E;">(</span>runNumber, chipNumber<span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">string</span> / dsetName<span style="color: #66D9EF;">)</span>.dset_str<span style="color: #AE81FF;">]</span>
  <span style="color: #FD971F;">result</span> = dset<span style="color: #AE81FF;">[</span>vlenDType, dtype<span style="color: #AE81FF;">]</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">calcOccupancy</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">](</span>x, y: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #66D9EF;">T</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span>, z: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #66D9EF;">uint16</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span> = @<span style="color: #66D9EF;">[]</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Tensor</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #E6DB74;">## calculates the occupancy of the given x and y datasets</span>
  <span style="color: #E6DB74;">## Either for a `</span><span style="color: #AE81FF;">seq[seq[T: SomeInteger]]</span><span style="color: #E6DB74;">` in which case we&apos;re calculating</span>
  <span style="color: #E6DB74;">## the occupancy of a raw clusters or `</span><span style="color: #AE81FF;">seq[T: SomeFloat]</span><span style="color: #E6DB74;">` in which case</span>
  <span style="color: #E6DB74;">## we&apos;re dealing with center positions of clusters</span>
  <span style="color: #FD971F;">result</span> = newTensor<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">NPix</span>, <span style="color: #66D9EF;">NPix</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">iterate over events</span>
  <span style="color: #F92672;">for</span> i <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> .. x.<span style="color: #F92672; font-style: italic;">high</span>:
    <span style="color: #F92672;">let</span>
      xEv = x<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
      yEv = y<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">zEv</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">uint16</span><span style="color: #AE81FF;">]</span>
    <span style="color: #F92672;">if</span> z.<span style="color: #F92672;">len</span> &gt; <span style="font-style: italic;">0</span>:
      zEv = z<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
    <span style="color: #E6DB74;">## continue if full event.</span>
    <span style="color: #E6DB74;">## TODO: replace by solution that also works for clusters!!</span>
    <span style="color: #75715E;">#</span><span style="color: #75715E;">if xEv.len &gt;= 4095: continue</span>
    <span style="color: #F92672;">for</span> j <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> .. xEv.<span style="color: #F92672; font-style: italic;">high</span>:
      <span style="color: #F92672;">if</span> zEv.<span style="color: #F92672;">len</span> &gt; <span style="font-style: italic;">0</span>:
        <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>xEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span>, yEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span> += zEv<span style="color: #AE81FF;">[</span>j<span style="color: #AE81FF;">]</span>.<span style="color: #66D9EF;">float</span>
      <span style="color: #F92672;">else</span>:
        <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>xEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span>, yEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span> += <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">occForChip</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>, chip: <span style="color: #66D9EF;">int</span>, fileInfo: <span style="color: #66D9EF;">FileInfo</span><span style="color: #AE81FF;">)</span>: <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">]</span>, <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">]</span>, <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> =        
  <span style="color: #F92672;">const</span> <span style="color: #66D9EF;">NPix</span> = <span style="font-style: italic;">256</span>
  <span style="color: #F92672;">let</span>
    xD = h5f.readVlen<span style="color: #AE81FF;">(</span>fileInfo, <span style="color: #66D9EF;">Run</span>, <span style="color: #E6DB74;">&quot;x&quot;</span>, chip, dtype = <span style="color: #66D9EF;">uint8</span><span style="color: #AE81FF;">)</span>
    yD = h5f.readVlen<span style="color: #AE81FF;">(</span>fileInfo, <span style="color: #66D9EF;">Run</span>, <span style="color: #E6DB74;">&quot;y&quot;</span>, chip, dtype = <span style="color: #66D9EF;">uint8</span><span style="color: #AE81FF;">)</span>
    zD = h5f.readVlen<span style="color: #AE81FF;">(</span>fileInfo, <span style="color: #66D9EF;">Run</span>, <span style="color: #E6DB74;">&quot;ToT&quot;</span>, chip, dtype = <span style="color: #66D9EF;">uint16</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">occ </span>= calcOccupancy<span style="color: #AE81FF;">(</span>xD, yD<span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">, zD)</span>
  <span style="color: #F92672;">var</span>
    x = newTensorUninit<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">NPix</span> * <span style="color: #66D9EF;">NPix</span><span style="color: #AE81FF;">)</span>
    y = newTensorUninit<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">NPix</span> * <span style="color: #66D9EF;">NPix</span><span style="color: #AE81FF;">)</span>
    z = newTensorUninit<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">NPix</span> * <span style="color: #66D9EF;">NPix</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">i </span>= <span style="font-style: italic;">0</span>
  <span style="color: #F92672;">for</span> idx, val <span style="color: #F92672;">in</span> occ:
    x<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = idx<span style="color: #AE81FF;">[</span><span style="font-style: italic;">0</span><span style="color: #AE81FF;">]</span>
    y<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = idx<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>
    z<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = val
    <span style="color: #F92672;">inc</span> i
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span>
      
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">handleOccupancy</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>,
                     chip: <span style="color: #66D9EF;">int</span>,
                     fileInfo: <span style="color: #66D9EF;">FileInfo</span>,
                     quant: <span style="color: #66D9EF;">float</span> = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">PlotView</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">get x and y datasets, stack and get occupancies</span>
  <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span> = h5f.occForChip<span style="color: #AE81FF;">(</span>chip, fileInfo<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">quant </span>= quant
  <span style="color: #F92672;">if</span> quant == <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>:
    quant = percentile<span style="color: #AE81FF;">(</span>z, <span style="font-style: italic;">80</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = ggcreate<span style="color: #AE81FF;">(</span>
    <span style="color: #F92672;">block</span>:
      <span style="color: #F92672;">var</span> <span style="color: #FD971F;">plt </span>= 
        ggplot<span style="color: #66D9EF;">(</span>df, aes<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;y&quot;</span>, fill = <span style="color: #E6DB74;">&quot;z&quot;</span><span style="color: #A6E22E;">)</span>, backend = bkCairo<span style="color: #66D9EF;">)</span> +
          geom_raster<span style="color: #66D9EF;">()</span> +
          scale_fill_continuous<span style="color: #66D9EF;">(</span>scale = <span style="color: #A6E22E;">(</span><span style="color: #F92672; font-style: italic;">low</span>: <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="color: #F92672; font-style: italic;">high</span>: quant<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span> + <span style="color: #75715E;">#</span><span style="color: #75715E;">high: 1600.0)) +</span>
          xlim<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>, <span style="color: #66D9EF;">NPix</span><span style="color: #66D9EF;">)</span> + ylim<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>, <span style="color: #66D9EF;">NPix</span><span style="color: #66D9EF;">)</span>
      <span style="color: #F92672;">if</span> <span style="color: #66D9EF;">OnlyRaster</span>:
        plt = plt + theme_void<span style="color: #66D9EF;">()</span> + hideLegend<span style="color: #66D9EF;">()</span>
      plt
  <span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">ggplot(df, aes(&quot;x&quot;, &quot;y&quot;, fill = &quot;z&quot;), backend = bkCairo) +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">geom_raster() +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">scale_fill_continuous(scale = (low: 0.0, high: 1600.0)) +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">xlim(0, NPix) + ylim(0, NPix) +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">ggsave(&quot;/t/test_occ_0_.pdf&quot;)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">drawBounds</span><span style="color: #AE81FF;">(</span>v: <span style="color: #66D9EF;">Viewport</span><span style="color: #AE81FF;">)</span> =
  v.drawBoundary<span style="color: #AE81FF;">(</span>writeName = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">for</span> ch <span style="color: #F92672;">in</span> <span style="color: #F92672;">mitems</span><span style="color: #AE81FF;">(</span>v.children<span style="color: #AE81FF;">)</span>:
    ch.drawBounds<span style="color: #AE81FF;">()</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">calcQuantileChip3</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>, fileInfo: <span style="color: #66D9EF;">FileInfo</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">float</span> =
  <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span> = h5f.occForChip<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>, fileInfo<span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = percentile<span style="color: #AE81FF;">(</span>z, <span style="font-style: italic;">80</span><span style="color: #AE81FF;">)</span>  

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">addRow</span><span style="color: #AE81FF;">(</span>view: <span style="color: #66D9EF;">Viewport</span>, h5f: <span style="color: #66D9EF;">H5File</span>, septem: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">SeptemRow</span><span style="color: #66D9EF;">]</span>, fileInfo: <span style="color: #66D9EF;">FileInfo</span>, i, num, chipStart: <span style="color: #66D9EF;">int</span>, showEmpty = <span style="color: #AE81FF;">false</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">width </span>= septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.right - septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.left
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">height </span>= septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.top - septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.bottom

  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">row </span>= view.addViewport<span style="color: #AE81FF;">(</span>left = septem<span style="color: #66D9EF;">[</span>i<span style="color: #66D9EF;">]</span>.left, bottom = septem<span style="color: #66D9EF;">[</span>i<span style="color: #66D9EF;">]</span>.bottom,
                             width = width, height = height<span style="color: #AE81FF;">)</span>
  row.layout<span style="color: #AE81FF;">(</span>num, <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">, margin = quant(septem[i].wspace, ukRelative))</span>

  <span style="color: #75715E;">#</span><span style="color: #75715E;">let quant = calcQuantileChip3()</span>
  
  <span style="color: #F92672;">for</span> j <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; num:
    <span style="color: #F92672;">if</span> <span style="color: #F92672;">not</span> showEmpty:
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">plt </span>= handleOccupancy<span style="color: #AE81FF;">(</span>h5f, chipStart + j, fileInfo<span style="color: #AE81FF;">)</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">, quant)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">v </span>= <span style="color: #F92672;">if</span> <span style="color: #66D9EF;">OnlyRaster</span>: plt.view<span style="color: #AE81FF;">[</span><span style="font-style: italic;">4</span><span style="color: #AE81FF;">]</span> <span style="color: #F92672;">else</span>: plt.view
      <span style="color: #F92672;">var</span> <span style="color: #FD971F;">pltView </span>= v.relativeTo<span style="color: #AE81FF;">(</span>row<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> 
      row.embedAt<span style="color: #AE81FF;">(</span>j, pltView<span style="color: #AE81FF;">)</span>
    row<span style="color: #AE81FF;">[</span>j<span style="color: #AE81FF;">]</span>.drawBoundary<span style="color: #AE81FF;">()</span>

  view.children.<span style="color: #F92672;">add</span> row

<span style="color: #E6DB74;">## Read the data from the reconstructed H5 file of run 241</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/mnt/1TB/CAST/2017/development/reco_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">_sparking.h5&quot;</span> % $<span style="color: #66D9EF;">Run</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>path, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">fileInfo </span>= getFileInfo<span style="color: #AE81FF;">(</span>h5f<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">let</span>
  fig_x_size = <span style="font-style: italic;">10</span>.<span style="font-style: italic;">0</span>
  fig_y_size = <span style="font-style: italic;">12</span>.<span style="font-style: italic;">04186</span>
  ratio = fig_x_size / fig_y_size

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">septem </span>= initSeptemBoard<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, fig_x_size, fig_y_size, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">ImageSize</span> = fig_x_size * <span style="color: #66D9EF;">DPI</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">view </span>= initViewport<span style="color: #AE81FF;">(</span>c<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span>,
                        quant<span style="color: #66D9EF;">(</span>fig_x_size, ukInch<span style="color: #66D9EF;">)</span>, quant<span style="color: #66D9EF;">(</span>fig_y_size, ukInch<span style="color: #66D9EF;">)</span>, backend = bkCairo,
                        wImg = <span style="color: #66D9EF;">ImageSize</span>, hImg = <span style="color: #66D9EF;">ImageSize</span> / ratio<span style="color: #AE81FF;">)</span>

view.addRow<span style="color: #AE81FF;">(</span>h5f, septem, fileInfo, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">5</span>, showEmpty = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
view.addRow<span style="color: #AE81FF;">(</span>h5f, septem, fileInfo, <span style="font-style: italic;">1</span>, <span style="font-style: italic;">3</span>, <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>
view.addRow<span style="color: #AE81FF;">(</span>h5f, septem, fileInfo, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>

view.draw<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/sparking_occupancy_80_quantile_run_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.pdf&quot;</span> % $<span style="color: #66D9EF;">Run</span><span style="color: #AE81FF;">)</span>
</pre>
</div>

<p>
Running the above code for run 268 (the run we installed the fan and
had temperature readout) yields fig. <a href="#fig:detector:occupancy_sparking_run_268">36</a>.
</p>


<figure id="fig:detector:occupancy_sparking_run_268">
<img alt="sparking_occupancy_80_quantile_run_268.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/sparking/sparking_occupancy_80_quantile_run_268.svg" />

<figcaption>Figure 36: <span class="figure-number">Figure 26: </span>Occupancy of a testing background run with \(\mathcal{O}(\SI{1}{s})\) long frames using septemboard F during development without any kind of cooling and temperature logging. Temperatures on the underside of the carrier board reached \SI{76}{\celsius} before the fan was placed next to it.</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-sec:septem:efficiency" class="outline-3">
<h3 id="sec:septem:efficiency"><span class="section-number-3">7.12.</span> Detector efficiency</h3>
<div id="text-sec:septem:efficiency" class="outline-text-3">
<p>
For the applications at CAST, the detector is filled with \(\ce{Ar}\) / \(\ce{iC_4 H_{10}}\) :
\(\SI{97.7}{\%} / \SI{2.3}{\%}\) gas. Combined with its \SI{300}{nm}
\(\ce{Si_3 N_4}\) window, the combined detection efficiency can be
computed, if the \(\SI{20}{nm}\) \(\ce{Al}\) coating for the detector cathode
is included by computing the product of the different
efficiencies. The efficiency of the window and coating are the
transmissions of X-rays at different energies for each material \(t_i\). For
the gas, the absorption probability of the gas \(a_i\) is needed. As such
</p>

<p>
\[
ε_{\text{tot}} = t_{\ce{Si_3 N_4}} · t_{\ce{Al}} · a_{\ce{Ar} / \ce{iC_4H_{10}}}
\]
</p>

<p>
describes the full detector efficiency assuming the parts of the
detector, which are not obstructed by the window strongbacks. For a
statistical measure of detection efficiency the occlusion of the
window needs to be taken into account. Because it is position
(and thus area) dependent, the need to include it is decided on a case
by case basis. For the absorption of a gas mixture, we can use
Dalton&apos;s law and compute the absorption of the individual gases according
to their mole fractions (their percentage as indicated by the gas
mixture) and then compute it for each partial pressure
</p>

<p>
\[
a_i = \text{Absorption}(P_{\text{total}} · f_i)
\]
</p>

<p>
where \(P_{\text{total}}\) is the total pressure of the gas mixture (in
this case \(\SI{1050}{mbar}\)) and \(f_i\) is the fraction of the gas
\(i\). &apos;Absorption&apos; simply refers to the generic function computing the
absorption for a gas at a given pressure (see
sec. <a href="./theory_detector.html#sec:theory:daltons_law">6.3.1</a> and sec. <a href="./theory_detector.html#sec:theory:xray_matter_gas">6.1.1</a>).
</p>

<p>
The full combined efficiency as presented here is shown in
fig. <a href="#fig:detector:combined_efficiency">37</a>. Different aspects dominate the
combined efficiency (purple line) in different energy ranges. At
energies above \(\SI{5}{keV}\) the probability of X-rays to not generate a
photoelectron within the \(\SI{3}{cm}\) of drift distance becomes the
major factor for a loss in efficiency. This means the combined
efficiency at \(\SI{10}{keV}\) is slightly below \(\SI{30}{\%}\). The
best combined efficiency of about \(\SI{95}{\%}\) is reached at
about \(\SI{3.75}{keV}\) where both the absorption is likely and the
energy is high enough to transmit well through the window. The argon
\(K 1s\) absorption edge is clearly visible at around \(\SI{3.2}{keV}\). At
energies below the mean free path of X-rays is significantly longer as
the \(K 1s\) absorption is a significant factor in the possible
generation of a photoelectron. The window leads to a similar, but inverse, effect
namely due to the \(K 1s\) line of \(\ce{Si}\) at around
\(\SI{1.84}{keV}\). Because transmission is desired through the window
material, the efficiency <i>increases</i> once we go below that
energy. Finally, the nitrogen \(K 1s\) line also contributes to an
increase in efficiency once we cross below about \(\SI{400}{eV}\). The
average efficiencies in the energy ranges between \(\SIrange{0}{3}{keV}\) and
\(\SIrange{0}{10}{keV}\) are \(\SI{73.42}{\%}\) and \(\SI{67.84}{\%}\), respectively.
</p>

<p>
The improvement in efficiency at energies below \(\SI{3}{keV}\) in
comparison to the mylar window used in the 2014/15 detector (see
sec. <a href="./septemboard.html#sec:detector:sin_window">7.9</a>) leads to a significant
improvement in possible signal detection at those energies, which is
especially important for searches with peak fluxes around
\(\SIrange{1}{2}{keV}\) as is the case for the axion-electron coupling or
a possible chameleon coupling.
</p>


<figure id="fig:detector:combined_efficiency">
<img alt="detector_efficiency.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/detector_efficiency.svg" />

<figcaption>Figure 37: <span class="figure-number">Figure 27: </span>Combined detection efficiency for the full detector, taking into account the gas filling of \(\SI{1050}{mbar}\) \(\ce{Ar}\) / \(\ce{iC_4 H_{10}}\), the \(\SI{300}{nm}\) \(\ce{Si_3 N_4}\) window and its \(\SI{20}{nm}\) \(\ce{Al}\) coating.</figcaption>
</figure>
</div>
<div id="outline-container-orga143b27" class="outline-4">
<h4 id="orga143b27"><span class="section-number-4">7.12.1.</span> Calculation of full detection efficiency   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-7-12-1" class="outline-text-4">
<p>
<b>Note</b>: We also have
<a href="./../CastData/ExternCode/TimepixAnalysis/Tools/septemboardDetectionEff/septemboardDetectionEff.nim">./../CastData/ExternCode/TimepixAnalysis/Tools/septemboardDetectionEff/septemboardDetectionEff.nim</a>
which includes the LLNL effective area (designed for the limit
calculation) now!
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / strutils
<span style="color: #F92672;">import</span> xrayAttenuation, ggplotnim
<span style="color: #75715E;"># </span><span style="color: #75715E;">generate a compound of silicon and nitrogen with correct number of atoms</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">Si</span>₃N₄ = compound<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Si</span>, <span style="font-style: italic;">3</span><span style="color: #66D9EF;">)</span>, <span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">N</span>, <span style="font-style: italic;">4</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">al </span>= <span style="color: #66D9EF;">Aluminium</span>.init<span style="color: #AE81FF;">()</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">define energies in which to compute the transmission</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">(we don&apos;t start at 0, as at 0 energy the parameters are not well defined)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">energies </span>= linspace<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">03</span>, <span style="font-style: italic;">10</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">instantiate an Argon instance</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ar </span>= <span style="color: #66D9EF;">Argon</span>.init<span style="color: #AE81FF;">()</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">and isobutane</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">iso </span>= compound<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">C</span>, <span style="font-style: italic;">4</span><span style="color: #66D9EF;">)</span>, <span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">H</span>, <span style="font-style: italic;">10</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">compTrans</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">T</span>: <span style="color: #66D9EF;">AnyCompound</span><span style="color: #AE81FF;">](</span>el: <span style="color: #66D9EF;">T</span>, ρ: g•cm⁻³, length: <span style="color: #66D9EF;">Meter</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Column</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span> : energies <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">float</span>: <span style="color: #E6DB74;">&quot;μ&quot;</span> ~ el.attenuationCoefficient<span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span><span style="color: #E6DB74;">)</span>.keV<span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">}</span>,
            f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">float</span>: <span style="color: #E6DB74;">&quot;Trans&quot;</span> ~ transmission<span style="color: #A6E22E;">(</span>`μ`.cm²•g⁻¹, ρ, length<span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">}</span>,
            f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Compound&quot;</span> &lt;- el.name<span style="color: #A6E22E;">()</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Trans&quot;</span><span style="color: #AE81FF;">]</span>
    
<span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span> : energies <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">compute transmission for Si₃N₄ (known density and desired length)</span>
df<span style="color: #AE81FF;">[</span>Si₃N₄.name<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">]</span> = Si₃N₄.compTrans<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>.<span style="font-style: italic;">44</span>.g•cm⁻³, <span style="font-style: italic;">300</span>.nm.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Meter</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">and aluminum coating</span>
df<span style="color: #AE81FF;">[</span>al.name<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">]</span> = al.compTrans<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>.<span style="font-style: italic;">7</span>.g•cm⁻³, <span style="font-style: italic;">20</span>.nm.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Meter</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">and now for the gas mixture.</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">first compute partial pressures</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">fracAr </span>= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">977</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">fracIso </span>= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">023</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">using it we can compute the density of each by partial pressure theorem (Dalton&apos;s law)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ρ_Ar </span>= density<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1050</span>.mbar.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Pascal</span><span style="color: #66D9EF;">)</span> * fracAr, <span style="font-style: italic;">293</span>.<span style="color: #66D9EF;">K</span>, ar.molarMass<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ρ_Iso </span>= density<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1050</span>.mbar.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Pascal</span><span style="color: #66D9EF;">)</span> * fracIso, <span style="font-style: italic;">293</span>.<span style="color: #66D9EF;">K</span>, iso.molarWeight<span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">now add transmission of argon and iso</span>
df<span style="color: #AE81FF;">[</span>ar.name<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">]</span> = ar.compTrans<span style="color: #AE81FF;">(</span>ρ_Ar, <span style="font-style: italic;">3</span>.cm.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Meter</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
df<span style="color: #AE81FF;">[</span>iso.name<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">]</span> = iso.compTrans<span style="color: #AE81FF;">(</span>ρ_Iso, <span style="font-style: italic;">3</span>.cm.to<span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">Meter</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">nSiN </span>= r<span style="color: #E6DB74;">&quot;$\SI{300}{nm}$ $\ce{Si_3 N_4}$&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">nAl </span>= r<span style="color: #E6DB74;">&quot;$\SI{20}{nm}$ $\ce{Al}$&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">nAr </span>= r<span style="color: #E6DB74;">&quot;$\SI{3}{cm}$ $\ce{Ar}$ Absorption&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">nIso </span>= r<span style="color: #E6DB74;">&quot;$\SI{3}{cm}$ $\ce{iC_4 H_{10}}$ Absorption&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">nArIso </span>= r<span style="color: #E6DB74;">&quot;$\SI{3}{cm}$ $\SI{97.7}{\percent} \ce{Ar} / \SI{2.3}{\percent} \ce{iC_4 H_{10}}$&quot;</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">finally just need to combine all of them in useful ways</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">- argon + iso</span>
df = df.mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Trans_ArIso&quot;</span> ~ `<span style="color: #66D9EF;">Argon</span>` * `<span style="color: #66D9EF;">C4H10</span>`<span style="color: #66D9EF;">}</span>,
               f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Abs ArIso&quot;</span> ~ <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - `<span style="color: #66D9EF;">Trans_ArIso</span>`<span style="color: #66D9EF;">}</span>,
               f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Abs Ar&quot;</span> ~ <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - `<span style="color: #66D9EF;">Argon</span>`<span style="color: #66D9EF;">}</span>,
               f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Abs Iso&quot;</span> ~ <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - `<span style="color: #66D9EF;">C4H10</span>`<span style="color: #66D9EF;">}</span>,
               f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Efficiency&quot;</span> ~ idx<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;Abs ArIso&quot;</span><span style="color: #A6E22E;">)</span> * `<span style="color: #66D9EF;">Si3N4</span>` * `<span style="color: #66D9EF;">Aluminium</span>`<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>nSiN &lt;- <span style="color: #E6DB74;">&quot;Si3N4&quot;</span><span style="color: #66D9EF;">}</span>,
          f<span style="color: #66D9EF;">{</span>nAl &lt;- <span style="color: #E6DB74;">&quot;Aluminium&quot;</span><span style="color: #66D9EF;">}</span>,
          f<span style="color: #66D9EF;">{</span>nAr &lt;- <span style="color: #E6DB74;">&quot;Abs Ar&quot;</span><span style="color: #66D9EF;">}</span>,
          f<span style="color: #66D9EF;">{</span>nIso &lt;- <span style="color: #E6DB74;">&quot;Abs Iso&quot;</span><span style="color: #66D9EF;">}</span>,
          f<span style="color: #66D9EF;">{</span>nArIso &lt;- <span style="color: #E6DB74;">&quot;Abs ArIso&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">,                    </span>
  .gather<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span>nSiN, nAl, nAr, nIso, nArIso, <span style="color: #E6DB74;">&quot;Efficiency&quot;</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;Material&quot;</span>, <span style="color: #E6DB74;">&quot;Efficiency&quot;</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Mean efficiency 0-3  keV = &quot;</span>, df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>idx<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span><span style="color: #A6E22E;">)</span> &lt; <span style="font-style: italic;">3</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)[</span><span style="color: #E6DB74;">&quot;Efficiency&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.mean  
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Mean efficiency 0-5  keV = &quot;</span>, df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>idx<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span><span style="color: #A6E22E;">)</span> &lt; <span style="font-style: italic;">5</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)[</span><span style="color: #E6DB74;">&quot;Efficiency&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.mean
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Mean efficiency 0-10 keV = &quot;</span>, df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>idx<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span><span style="color: #A6E22E;">)</span> &lt; <span style="font-style: italic;">10</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)[</span><span style="color: #E6DB74;">&quot;Efficiency&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.mean

ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span>, <span style="color: #E6DB74;">&quot;Efficiency&quot;</span>, color = <span style="color: #E6DB74;">&quot;Material&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Energy [keV]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Efficiency&quot;</span><span style="color: #AE81FF;">)</span> +
  xlim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">10</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + 
  ggtitle<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Transmission (absorption for gases) of relevant detector materials and combined \\&quot;</span> &amp;
    <span style="color: #E6DB74;">&quot;detection efficiency of the Septemboard detector&quot;</span><span style="color: #AE81FF;">)</span> +
  margin<span style="color: #AE81FF;">(</span>top = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span>, right = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
  titlePosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">8</span><span style="color: #AE81FF;">)</span> + 
  legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">42</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">15</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">400</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/detector_efficiency.pdf&quot;</span>,
         width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">400</span>,
         <span style="color: #75715E;">#</span><span style="color: #75715E;">width = 800, height = 600,</span>
         useTex = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span> 
</pre>
</div>
<p>
Mean efficiency 0-3  keV = 0.7342084765204602
Mean efficiency 0-5  keV = 0.7544999372201439
Mean efficiency 0-10 keV = 0.6783959312693081
</p>
</div>
</div>
</div>
<div id="outline-container-sec:detector:daq" class="outline-3">
<h3 id="sec:detector:daq"><span class="section-number-3">7.13.</span> Data acquisition and detector monitoring</h3>
<div id="text-sec:detector:daq" class="outline-text-3">
<p>
The data acquisition software used for the Septemboard detector, the
Timepix Operating Software (TOS), is not of direct importance for the
thesis. But a longer section about it can be found in appendix
<a href="./daq.html#sec:daq">17</a>. It includes discussions about how the software works
internally, how it is used, what the data format produced looks like
and its configuration files. Further, it goes over the temperature
readout functionality and finally presents the software used for
detector monitoring, in the form of an event display used at CAST.
</p>
</div>
</div>
</div>
<div id="outline-container-sec:operation_calibration" class="outline-2">
<h2 id="sec:operation_calibration"><span class="section-number-2">8.</span> Detector calibration for operation   <span class="tag">  <span class="Detector">Detector</span></span></h2>
<div id="text-sec:operation_calibration" class="outline-text-2">
<p>
This chapter introduces the calibrations required to get the
Septemboard detector into a usable state for data taking at an
experiment, in particular to interpret the data taken with it,
sec. <a href="./operation_calibration.html#sec:operation_calibration:timepix">8.1</a>. Those calibrations purely
related to the Timepix ASIC itself – to work noise free at the lowest
possible thresholds – can be found in appendix
<a href="./calibration.html#sec:appendix:calibration:timepix">19.1</a>. Also the correct working parameters
for the FADC are discussed in
sec. <a href="./operation_calibration.html#sec:operation_calibration:fadc">8.2</a>. The scintillators need to be set
to their correct discriminator thresholds, see
sec. <a href="./operation_calibration.html#sec:operation_calibration:scintillators">8.3</a>.
</p>
</div>
<div id="outline-container-sec:operation_calibration:timepix" class="outline-3">
<h3 id="sec:operation_calibration:timepix"><span class="section-number-3">8.1.</span> Timepix calibrations</h3>
<div id="text-sec:operation_calibration:timepix" class="outline-text-3">
<p>
As alluded to above, here we will focus on interpreting data taken
with a Timepix ASIC. This means introducing the Time over Threshold
(ToT) calibration method used to interpret ToT values as recorded
charges, sec. <a href="./operation_calibration.html#sec:operation_calibration:tot_calibration">8.1.1</a>. Further,
based on recorded charge the gas gain can be determined. This is
discussed in sec. <a href="./operation_calibration.html#sec:daq:polya_distribution">8.1.2</a>.
</p>

<p>
Important references for the Timepix in general and for the
calibration procedures explained below and in the appendix are
(<a href="./bibliography.html#citeproc_bib_item_151">Llopart et al. 2007</a>; <a href="./bibliography.html#citeproc_bib_item_148">Llopart Cudie 2007</a>; <a href="./bibliography.html#citeproc_bib_item_149">Llopart and Poikela 2006</a>; <a href="./bibliography.html#citeproc_bib_item_153">Lupberger 2016</a>).
</p>
</div>
<div id="outline-container-sec:operation_calibration:tot_calibration" class="outline-4">
<h4 id="sec:operation_calibration:tot_calibration"><span class="section-number-4">8.1.1.</span> ToT calibration</h4>
<div id="text-sec:operation_calibration:tot_calibration" class="outline-text-4">
<p>
The purpose of the <code>ToT</code> (\textbf{T}ime \textbf{o}ver
\textbf{T}hreshold) calibration is not to perform a calibration for
stable operation of a Timepix based detector, but rather to interpret
the data received. It is needed to interpret the <code>ToT</code> values recorded
by each pixel as a charge, i.e. a number of recorded electrons.
</p>

<p>
This is done by injecting charges onto the individual pixels – &apos;test
pulses&apos;. Capacitors are present to inject very precise voltage bursts
onto the pixels. In case of the Timepix 1, each pixel uses a
capacitance of \(\SI{8}{fF}\) (<a href="./bibliography.html#citeproc_bib_item_149">Llopart and Poikela 2006</a>). Knowing the
capacitance and the voltage induced on them, the number of injected
electrons can be easily calculated from
</p>

<p>
\[
Q = C U.
\]
</p>

<p>
By varying the injected charge and recording the resulting ToT values
of the pixels, a relation between electrons and ToT values is
determined:
</p>

<p>
\[
f(p) = a p + b - \frac{c}{p - t}
\]
where \(a, b, c\) and \(t\) are parameters to be determined via a
numerical fit and \(p\) is the test pulse height in \(\si{mV}\).
</p>

<p>
As such, inverting the relation this can be used to compute a charge
for a given <code>ToT</code> value: 
</p>

<p>
\[
  f(\mathtt{ToT}) = \frac{α}{2 a} \left( \mathtt{ToT} - (b - a t) +
    \sqrt{ \left( \mathtt{ToT} - (b - a t) \right)^2 + 4 (a b t + a c -
    a t \mathtt{ToT} ) } \right)
\]
where \(\mathtt{ToT}\) is the time over threshold value recorded for a
pixel, the constants \(a, b, c, t\) the fit parameters determined above
and \(α\) the conversion factor relating the number of electrons from a
pulse height of \(\SI{1}{mV}\). 
</p>

<p>
An example of a ToT calibration of one chip is shown in
fig. <a href="#fig:septem:tot_calibration_example">38</a>.
</p>


<figure id="fig:septem:tot_calibration_example">
<img alt="tot_calib_Run2_chip_3.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/calibration/tot_calib_Run2_chip_3.svg" />

<figcaption>Figure 38: <span class="figure-number">Figure 28: </span>Example of a ToT calibration measurement for the chip H10 W69, the center chip of the Septemboard, as it was done for the CAST data taking period 2.</figcaption>
</figure>
</div>
<div id="outline-container-sec:operation_calibration:gen_tot_calib_plot" class="outline-5">
<h5 id="sec:operation_calibration:gen_tot_calib_plot"><span class="section-number-5">8.1.1.1.</span> Generate plots for the ToT calibration   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-sec:operation_calibration:gen_tot_calib_plot" class="outline-text-5">
<p>
The plots for all calibrations (of this sort) are produced using the
<code>plotCalibration</code> tool,
<a href="./../CastData/ExternCode/TimepixAnalysis/Plotting/plotCalibration/plotCalibration.nim">./../CastData/ExternCode/TimepixAnalysis/Plotting/plotCalibration/plotCalibration.nim</a>.
For a single plot we can produce the plot (used for the thesis above)
like this:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #75715E;"># </span><span style="color: #75715E;">To generate fig:septem:tot_calibration_example</span>
plotCalibration --tot --runPeriod=Run2 --useTeX <span style="color: #E6DB74; font-weight: bold;">\</span>
                --file ~/CastData/ExternCode/TimepixAnalysis/resources/ChipCalibrations/Run2/chip3/TOTCalib3.txt <span style="color: #E6DB74; font-weight: bold;">\</span>
                --outpath ~/phd/Figs/detector/calibration/
</pre>
</div>

<p>
Note that we hand the calibration data file and do not use the InGrid
database. We could do either (if you pass a chip number and a run
period instead of the ToT calib text file it would read from the
database instead).
</p>

<p>
See appendix section <a href="./calibration.html#sec:appendix:calibration:gen_tot_calibration">19.2.1</a> for
all ToT calibrations for all Septemboard chips.
</p>

<p>
The following is the doc string of the function for the ToT
calibration function used in <code>TimepixAnalysis</code>. 
</p>
<div class="org-src-container">
<pre class="src src-nim">  <span style="color: #E6DB74;">## calculates the charge in electrons from the TOT value, based on the TOT calibration</span>
  <span style="color: #E6DB74;">## from MarlinTPC:</span>
  <span style="color: #E6DB74;">## measured and fitted is ToT[clock cycles] in dependency of TestPuseHeight [mV]</span>
  <span style="color: #E6DB74;">## fit function is:</span>
  <span style="color: #E6DB74;">##   ToT[clock cycles] = a*TestPuseHeight [mV]  + b - ( c / (TestPuseHeight [mV] -t) )</span>
  <span style="color: #E6DB74;">## isolating TestPuseHeight gives:</span>
  <span style="color: #E6DB74;">##   TestPuseHeight [mV] = 1/(2*a) * (ToT[clock cycles] - (b - a*t) +</span>
  <span style="color: #E6DB74;">##                         SQRT( (ToT[clock cycles] - (b - a*t))^2 +</span>
  <span style="color: #E6DB74;">##                               4*(a*b*t + a*c - a*t*ToT[clock cycles]) ) )</span>
  <span style="color: #E6DB74;">## conversion from charge to electrons:</span>
  <span style="color: #E6DB74;">##   electrons = 50 * testpulse[mV]</span>
  <span style="color: #E6DB74;">## so we have:</span>
  <span style="color: #E6DB74;">## Charge[electrons] = 50 / (2*a) * (ToT[clock cycles] - (b - a*t) +</span>
  <span style="color: #E6DB74;">##                     SQRT( (ToT[clock cycles] - (b - a*t))^2 +</span>
  <span style="color: #E6DB74;">##                           4*(a*b*t + a*c - a*t*ToT[clock cycles]) ) )</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:daq:polya_distribution" class="outline-4">
<h4 id="sec:daq:polya_distribution"><span class="section-number-4">8.1.2.</span> Pólya distribution &amp; gas gain</h4>
<div id="text-sec:daq:polya_distribution" class="outline-text-4">
<p>
In sec. <a href="./theory_detector.html#sec:theory:gas_gain_polya">6.3.6</a> we introduced the Pólya
distribution to describe the statistical distribution of the gas
amplification stage. In the practical context of the Septemboard
detector and the ToT calibration then, this is the histogram of all
charge values recorded by the detector (and related of all ToT
values). As the ToT calibration function is non-linear though, the
histogram of the Pólya distribution has equal bin widths in ToT space,
but increasing bin widths in charge space. 
</p>

<p>
Such a histogram can be seen in fig. <a href="#fig:daq:polya_example_chip3">39</a>, for
a \(\SI{90}{min}\) slice of background data of the center chip of the
Septemboard. The reasoning behind looking at a fixed time interval for
the Pólya will be explained in section
<a href="./calibration.html#sec:calib:gas_gain_time_binning">11.2.3</a>. The pink line represents the fit of
the Pólya distribution following eq. \eqref{eq:theory:polya_distribution} to
the data. The dashed part of the line was not used for the fit and is
only an extension using the final fit parameters. At the lower end of
charge values, a cutoff due to the chip&apos;s activation threshold is
clearly visible. Note also how the bin widths increase from low to
high charge values. The fit determines a gas gain of 
\(\num{3604.3}\), compared to the mean of the data yielding
\(\num{3171.0}\). Following (<a href="./bibliography.html#citeproc_bib_item_65">Christoph Krieger 2018</a>) any number for the gas
gain used in the remainder of the thesis refers to the <i>mean of the
data</i> and not the fit parameter. We use the fit mainly as a
verification of the general behavior.
</p>


<figure id="fig:daq:polya_example_chip3">
<img alt="gas_gain_run_267_chip_3_2_90_min_1541650002.svg" class="org-svg" src="./figs/home/basti/phd/Figs/gas_gain_run_267_chip_3_2_90_min_1541650002.svg" />

<figcaption>Figure 39: <span class="figure-number">Figure 29: </span>An example of a Pólya distribution of chip 3 using the calibration of July 2018 based on \SI{90}{min} of background data. A cutoff at low charges is visible. The pink line represents the fit of the Pólya distribution to the data. In the dashed region the line was extended using the final fit parameters.</figcaption>
</figure>

<p>
A secondary use case for the Pólya distribution is the determination
of the activation threshold via the seen cutoff. More on this in
appendix <a href="./calibration.html#sec:appendix:calibration:polya_distribution_threshold">19.1.4</a>.
</p>
</div>
<div id="outline-container-orgb081a01" class="outline-5">
<h5 id="orgb081a01"><span class="section-number-5">8.1.2.1.</span> Generate Polya plot for chip 3, run period 3 <code>[0/1]</code>   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-8-1-2-1" class="outline-text-5">
<p>
We will produce a Pólya plot by performing the reconstruction of a
single run. In principle during the entire reconstruction all gas gain
plots are produced anyway, but that means we&apos;d just copy over a single
file. Better to showcase how they are produced in a standalone
fashion.
</p>

<p>
Say we use run 267 and it is in some directory:
</p>
<div class="org-src-container">
<pre class="src src-sh">cp ~/CastData/data/2018_2/Run_267_181108-02-05_rtBackground.tar.gz /tmp/Run_267_181108-02-05.tar.gz
<span style="color: #F92672;">cd</span> /tmp
raw_data_manipulation -p Run_267_181108-02-05.tar.gz --runType background --out raw_267.h5
reconstruction -i raw_267.h5 --out reco_267.h5
reconstruction -i reco_267.h5 --only_charge
reconstruction -i reco_267.h5 --only_gas_gain --useTeX
</pre>
</div>

<p>
where we first copy the raw data to <code>/tmp</code>, parse it, reconstruct it,
perform charge calibration and finally fit the gas gain data. That
produces plots in <a href="./../../../tmp/out/raw_267_2023-11-30_15-01-39/">./../../../tmp/out/raw_267_2023-11-30_15-01-39/</a>.
For the thesis we use:
<code>gas_gain_run_267_chip_3_2_90_min_1541650002.pdf</code>
</p>

<p>
The gas gain of the fit and from the data are both in the title of the
plot.
</p>

<p>
Fit: 3604.3
Data: 3171.0
</p>
</div>
</div>
</div>
<div id="outline-container-sec:operation_calibration:final_septemboard_calibration" class="outline-4">
<h4 id="sec:operation_calibration:final_septemboard_calibration"><span class="section-number-4">8.1.3.</span> Final Septemboard calibrations</h4>
<div id="text-sec:operation_calibration:final_septemboard_calibration" class="outline-text-4">
<p>
The detector was calibrated according to the descriptions of the
previous sections and appendix <a href="./calibration.html#sec:appendix:calibration">19</a> prior to both
major data taking campaigns at CAST (see
sec. <a href="sec:cast:data_taking_campaigns">10.6</a> for a detailed overview of both
campaigns), once in October 2017 and then again in July 2018.
</p>

<p>
For an overview of all calibration parameters of interest, see the
appendix <a href="./calibration.html#sec:appendix:septemboard_calibrations">19.2</a>. Tables
<a href="#tab:daq:thl_ths_calibration_run2">6</a> and <a href="#tab:daq:thl_ths_calibration_run3">7</a>
show the <code>THL</code> and <code>THS</code> DAC <sup>  <a id="fnr.31" href="#fn.31" class="footref" role="doc-backlink">31</a></sup> values used for the Septemboard
detector at CAST during the data taking campaign from October 2017 to
March 2018 (Run-2) and October 2018 to December 2018 (Run-3),
respectively. The other DACs were all set to the same values for all
chips in both data taking campaigns with the detector, shown in
tab. <a href="#tab:daq:common_dac_values">8</a>.
</p>

<table id="tab:daq:thl_ths_calibration_run2">
<caption class="t-above"><span class="table-number">Table 6:</span> The <code>THL</code> and <code>THS</code> DAC values for each of the chips of the Septemboard (board H) detector used at CAST for the data taking campaign from October 2017 to March 2018 (Run-2).</caption>

<colgroup>
<col class="org-left" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DAC</th>
<th scope="col" class="org-right">E6 W69</th>
<th scope="col" class="org-right">K6 W69</th>
<th scope="col" class="org-right">H9 W69</th>
<th scope="col" class="org-right">H10 W69</th>
<th scope="col" class="org-right">G10 W69</th>
<th scope="col" class="org-right">D9 W69</th>
<th scope="col" class="org-right">L8 W69</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">THL</td>
<td class="org-right">435</td>
<td class="org-right">435</td>
<td class="org-right">405</td>
<td class="org-right">450</td>
<td class="org-right">450</td>
<td class="org-right">400</td>
<td class="org-right">470</td>
</tr>

<tr>
<td class="org-left">THS</td>
<td class="org-right">66</td>
<td class="org-right">69</td>
<td class="org-right">66</td>
<td class="org-right">64</td>
<td class="org-right">66</td>
<td class="org-right">65</td>
<td class="org-right">66</td>
</tr>
</tbody>
</table>


<table id="tab:daq:thl_ths_calibration_run3">
<caption class="t-above"><span class="table-number">Table 7:</span> The <code>THL</code> and <code>THS</code> DAC values for each of the chips of the Septemboard (board H) detector used at CAST for the data taking campaign from October 2018 to December 2018 (Run-3).</caption>

<colgroup>
<col class="org-left" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DAC</th>
<th scope="col" class="org-right">E6 W69</th>
<th scope="col" class="org-right">K6 W69</th>
<th scope="col" class="org-right">H9 W69</th>
<th scope="col" class="org-right">H10 W69</th>
<th scope="col" class="org-right">G10 W69</th>
<th scope="col" class="org-right">D9 W69</th>
<th scope="col" class="org-right">L8 W69</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">THL</td>
<td class="org-right">419</td>
<td class="org-right">386</td>
<td class="org-right">369</td>
<td class="org-right">434</td>
<td class="org-right">439</td>
<td class="org-right">402</td>
<td class="org-right">462</td>
</tr>

<tr>
<td class="org-left">THS</td>
<td class="org-right">68</td>
<td class="org-right">66</td>
<td class="org-right">66</td>
<td class="org-right">65</td>
<td class="org-right">69</td>
<td class="org-right">65</td>
<td class="org-right">64</td>
</tr>
</tbody>
</table>

<table id="tab:daq:common_dac_values">
<caption class="t-above"><span class="table-number">Table 8:</span> DAC values and settings that are common between data taking periods and all chips of the Septemboard for CAST, from the <code>fsr</code> configuration file.</caption>

<colgroup>
<col class="org-left" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DAC</th>
<th scope="col" class="org-right">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">IKrum</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-left">Hist</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">GND</td>
<td class="org-right">80</td>
</tr>

<tr>
<td class="org-left">Coarse</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-left">CTPR</td>
<td class="org-right">4294967295</td>
</tr>

<tr>
<td class="org-left">BiasLVDS</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">SenseDAC</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">DACCode</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-left">RefLVDS</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">Vcas</td>
<td class="org-right">130</td>
</tr>

<tr>
<td class="org-left">ExtDAC</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">Disc</td>
<td class="org-right">127</td>
</tr>

<tr>
<td class="org-left">Preamp</td>
<td class="org-right">255</td>
</tr>

<tr>
<td class="org-left">FBK</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">BuffAnalogA</td>
<td class="org-right">127</td>
</tr>

<tr>
<td class="org-left">BuffAnalogB</td>
<td class="org-right">127</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-sec:calib:generate_fsr_table" class="outline-5">
<h5 id="sec:calib:generate_fsr_table"><span class="section-number-5">8.1.3.1.</span> Generate the FSR tables for all chips and each run period   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-sec:calib:generate_fsr_table" class="outline-text-5">
<p>
Let&apos;s generate the tables containing the table for the FSR DAC values
for all chips for each of the different run periods.
</p>

<p>
We will use the <code>ChipCalibrations</code> directory that is part of the
<code>TimepixAnalysis</code> repository in the <code>resources</code> directory.
</p>

<p>
Further, we will create a plot of all pixels showing the noise peak in
THL values based on the optimized equalization.
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>sequtils, strutils, os, tables, algorithm<span style="color: #AE81FF;">]</span>

<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/home/basti/CastData/ExternCode/TimepixAnalysis/resources/ChipCalibrations/&quot;</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">periods </span>= <span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Run2&quot;</span>, <span style="color: #E6DB74;">&quot;Run3&quot;</span><span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">chipInfo </span>= <span style="color: #E6DB74;">&quot;chipInfo.txt&quot;</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">thrMean </span>= <span style="color: #E6DB74;">&quot;thresholdMeans</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.txt&quot;</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">chips </span>= toSeq<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span> .. <span style="font-style: italic;">6</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">import</span> ggplotnim
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readThresholdMeans</span><span style="color: #AE81FF;">(</span>path: <span style="color: #66D9EF;">string</span>, chip: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> =
  <span style="color: #F92672;">echo</span> path / thrMean
  <span style="color: #FD971F;">result</span> = readCsv<span style="color: #AE81FF;">(</span>path / <span style="color: #66D9EF;">(</span>thrMean % $chip<span style="color: #66D9EF;">)</span>, sep = <span style="color: #E6DB74;">&apos;\t&apos;</span>, colNames = @<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;y&quot;</span>, <span style="color: #E6DB74;">&quot;min&quot;</span>, <span style="color: #E6DB74;">&quot;max&quot;</span>, <span style="color: #E6DB74;">&quot;bit&quot;</span>, <span style="color: #E6DB74;">&quot;opt&quot;</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
    .select<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;opt&quot;</span><span style="color: #AE81FF;">)</span>
    .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;THL&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;opt&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;chip&quot;</span> &lt;- chip<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">parse the names of the chips from the run info file</span>
<span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>    
<span style="color: #F92672;">for</span> period <span style="color: #F92672;">in</span> periods:
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">header </span>= @<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;DAC&quot;</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">tab </span>= initTable<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">int</span>, <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">string</span>, <span style="color: #66D9EF;">int</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dfPeriod </span>= newDataFrame<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">for</span> chip <span style="color: #F92672;">in</span> chips:
    <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">toTuple</span><span style="color: #AE81FF;">(</span>s: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #66D9EF;">string</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">string</span>, <span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span> =
      <span style="color: #F92672;">for</span> x <span style="color: #F92672;">in</span> s:
        <span style="color: #F92672;">doAssert</span> x.<span style="color: #F92672;">len</span> == <span style="font-style: italic;">2</span>
        <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> <span style="color: #AE81FF;">(</span>x<span style="color: #66D9EF;">[</span><span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span>, x<span style="color: #66D9EF;">[</span><span style="font-style: italic;">1</span><span style="color: #66D9EF;">]</span>.parseInt<span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">chipPath </span>= path / period / <span style="color: #E6DB74;">&quot;chip&quot;</span> &amp; $chip
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">data </span>= <span style="color: #F92672;">readFile</span><span style="color: #AE81FF;">(</span>chipPath / <span style="color: #E6DB74;">&quot;fsr&quot;</span> &amp; $chip &amp; <span style="color: #E6DB74;">&quot;.txt&quot;</span><span style="color: #AE81FF;">)</span>
      .splitLines
      .filterIt<span style="color: #AE81FF;">(</span>it.<span style="color: #F92672;">len</span> &gt; <span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
      .mapIt<span style="color: #AE81FF;">(</span>it.split<span style="color: #AE81FF;">)</span>
      .toTuple<span style="color: #AE81FF;">()</span>

    tab<span style="color: #AE81FF;">[</span>chip<span style="color: #AE81FF;">]</span> = data

    <span style="color: #75715E;"># </span><span style="color: #75715E;">read chip name and add to header</span>
    <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readChipName</span><span style="color: #AE81FF;">(</span>chip: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">string</span> =
      <span style="color: #FD971F;">result</span> = <span style="color: #F92672;">readFile</span><span style="color: #AE81FF;">(</span>chipPath / chipInfo<span style="color: #AE81FF;">)</span>
        .splitLines<span style="color: #AE81FF;">()[</span><span style="font-style: italic;">0</span><span style="color: #AE81FF;">]</span> 
      <span style="color: #FD971F;">result</span>.removePrefix<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;chipName: &quot;</span><span style="color: #AE81FF;">)</span>
    header.<span style="color: #F92672;">add</span> readChipName<span style="color: #AE81FF;">(</span>chip<span style="color: #AE81FF;">)</span>

    dfPeriod.<span style="color: #F92672;">add</span> readThresholdMeans<span style="color: #AE81FF;">(</span>chipPath, chip<span style="color: #AE81FF;">)</span>
  dfPeriod<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Run&quot;</span><span style="color: #AE81FF;">]</span> = period
  df.<span style="color: #F92672;">add</span> dfPeriod
  
  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">invertTable</span><span style="color: #AE81FF;">(</span>tab: <span style="color: #66D9EF;">Table</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">int</span>, <span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #E6DB74;">(</span><span style="color: #66D9EF;">string</span>, <span style="color: #66D9EF;">int</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Table</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">string</span>, <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">int</span>, <span style="color: #66D9EF;">int</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]</span> =
    <span style="color: #FD971F;">result</span> = initTable<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">string</span>, <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">int</span>, <span style="color: #66D9EF;">int</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]()</span>
    <span style="color: #F92672;">for</span> chip, data <span style="color: #F92672;">in</span> <span style="color: #F92672;">pairs</span><span style="color: #AE81FF;">(</span>tab<span style="color: #AE81FF;">)</span>:
      <span style="color: #F92672;">for</span> <span style="color: #AE81FF;">(</span>dac, value<span style="color: #AE81FF;">)</span> <span style="color: #F92672;">in</span> data:
        <span style="color: #F92672;">if</span> dac <span style="color: #F92672;">notin</span> <span style="color: #FD971F;">result</span>:
          <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>dac<span style="color: #AE81FF;">]</span> = <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">int</span>, <span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]()</span>
        <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>dac<span style="color: #AE81FF;">]</span>.<span style="color: #F92672;">add</span> <span style="color: #AE81FF;">(</span>chip, value<span style="color: #AE81FF;">)</span>

  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">wrap</span><span style="color: #AE81FF;">(</span>s: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">string</span> = <span style="color: #E6DB74;">&quot;|&quot;</span> &amp; s &amp; <span style="color: #E6DB74;">&quot;|\n&quot;</span>
  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">toOrgTable</span><span style="color: #AE81FF;">(</span>s: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #66D9EF;">string</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span>, header: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">string</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">string</span> =
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">tabLine </span>= wrap toSeq<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span> ..&lt; header.<span style="color: #F92672;">len</span><span style="color: #AE81FF;">)</span>.mapIt<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;------&quot;</span><span style="color: #AE81FF;">)</span>.join<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;|&quot;</span><span style="color: #AE81FF;">)</span>
    <span style="color: #FD971F;">result</span> = tabLine
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> wrap<span style="color: #AE81FF;">(</span>header.join<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;|&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> tabLine
    <span style="color: #F92672;">for</span> x <span style="color: #F92672;">in</span> s:
      <span style="color: #F92672;">doAssert</span> x.<span style="color: #F92672;">len</span> == header.<span style="color: #F92672;">len</span>
      <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> wrap<span style="color: #AE81FF;">(</span>x.join<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;|&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> tabLine

  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">toOrgTable</span><span style="color: #AE81FF;">(</span>tab: <span style="color: #66D9EF;">Table</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">string</span>, <span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #E6DB74;">(</span><span style="color: #66D9EF;">int</span>, <span style="color: #66D9EF;">int</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span>,
                  header: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">string</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">string</span> =
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">commonDacs </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">string</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]()</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">diffDacs </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">string</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]()</span>
    <span style="color: #F92672;">for</span> <span style="color: #AE81FF;">(</span>dac, row<span style="color: #AE81FF;">)</span> <span style="color: #F92672;">in</span> <span style="color: #F92672;">pairs</span><span style="color: #AE81FF;">(</span>tab<span style="color: #AE81FF;">)</span>:
      <span style="color: #F92672;">var</span> <span style="color: #FD971F;">fullRow </span>= @<span style="color: #AE81FF;">[</span>dac<span style="color: #AE81FF;">]</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">toAdd </span>= row.sortedByIt<span style="color: #AE81FF;">(</span>it<span style="color: #66D9EF;">[</span><span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>.mapIt<span style="color: #AE81FF;">(</span>$it<span style="color: #66D9EF;">[</span><span style="font-style: italic;">1</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">if</span> toAdd.deduplicate.<span style="color: #F92672;">len</span> &gt; <span style="font-style: italic;">1</span>:
        fullRow.<span style="color: #F92672;">add</span> toAdd
        diffDacs.<span style="color: #F92672;">add</span> fullRow 
      <span style="color: #F92672;">else</span>:
        commonDacs.<span style="color: #F92672;">add</span> @<span style="color: #AE81FF;">[</span>dac, toAdd.deduplicate<span style="color: #66D9EF;">[</span><span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> toOrgTable<span style="color: #AE81FF;">(</span>diffDacs, header<span style="color: #AE81FF;">)</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> <span style="color: #E6DB74;">&quot;\n\n&quot;</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> toOrgTable<span style="color: #AE81FF;">(</span>commonDacs, @<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;DAC&quot;</span>, <span style="color: #E6DB74;">&quot;Value&quot;</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">now add common dacs table</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Run: &quot;</span>, period
  <span style="color: #F92672;">echo</span> tab.invertTable.toOrgTable<span style="color: #AE81FF;">(</span>header<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">echo</span> df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;THL&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.<span style="color: #F92672;">min</span>  
ggplot<span style="color: #AE81FF;">(</span>df.filter<span style="color: #66D9EF;">(</span>f<span style="color: #A6E22E;">{</span>`<span style="color: #66D9EF;">THL</span>` &gt; <span style="font-style: italic;">100</span><span style="color: #A6E22E;">}</span><span style="color: #66D9EF;">)</span>, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;THL&quot;</span>, fill = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;chip&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  facet_wrap<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Run&quot;</span><span style="color: #AE81FF;">)</span> + 
  geom_histogram<span style="color: #AE81FF;">(</span>binWidth = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, position = <span style="color: #E6DB74;">&quot;identity&quot;</span>, alpha = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">7</span>, hdKind = hdOutline<span style="color: #AE81FF;">)</span> +
  ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Optimized THL distribution of the noise peak for each chip&quot;</span><span style="color: #AE81FF;">)</span> +
  ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;\# pixels&quot;</span>, margin = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
  facetHeaderText<span style="color: #AE81FF;">(</span>font = font<span style="color: #66D9EF;">(</span><span style="font-style: italic;">12</span>.<span style="font-style: italic;">0</span>, alignKind = taCenter<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">600</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> +
  scale_x_continuous<span style="color: #AE81FF;">(</span>breaks = <span style="font-style: italic;">8</span><span style="color: #AE81FF;">)</span> + 
  margin<span style="color: #AE81FF;">(</span>left = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">0</span>, right = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/calibration/septemboard_all_thl_optimized.pdf&quot;</span>,
         useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>,
         width = <span style="font-style: italic;">1000</span>, height = <span style="font-style: italic;">600</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
<p>
Run: Run2
</p>
<table>


<colgroup>
<col class="org-left" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DAC</th>
<th scope="col" class="org-right">E6 W69</th>
<th scope="col" class="org-right">K6 W69</th>
<th scope="col" class="org-right">H9 W69</th>
<th scope="col" class="org-right">H10 W69</th>
<th scope="col" class="org-right">G10 W69</th>
<th scope="col" class="org-right">D9 W69</th>
<th scope="col" class="org-right">L8 W69</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">THL</td>
<td class="org-right">435</td>
<td class="org-right">435</td>
<td class="org-right">405</td>
<td class="org-right">450</td>
<td class="org-right">450</td>
<td class="org-right">400</td>
<td class="org-right">470</td>
</tr>

<tr>
<td class="org-left">THS</td>
<td class="org-right">66</td>
<td class="org-right">69</td>
<td class="org-right">66</td>
<td class="org-right">64</td>
<td class="org-right">66</td>
<td class="org-right">65</td>
<td class="org-right">66</td>
</tr>
</tbody>
</table>


<table>


<colgroup>
<col class="org-left" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DAC</th>
<th scope="col" class="org-right">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">IKrum</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-left">Hist</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">GND</td>
<td class="org-right">80</td>
</tr>

<tr>
<td class="org-left">Coarse</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-left">CTPR</td>
<td class="org-right">4294967295</td>
</tr>

<tr>
<td class="org-left">BiasLVDS</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">SenseDAC</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">DACCode</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-left">RefLVDS</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">Vcas</td>
<td class="org-right">130</td>
</tr>

<tr>
<td class="org-left">ExtDAC</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">Disc</td>
<td class="org-right">127</td>
</tr>

<tr>
<td class="org-left">Preamp</td>
<td class="org-right">255</td>
</tr>

<tr>
<td class="org-left">FBK</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">BuffAnalogA</td>
<td class="org-right">127</td>
</tr>

<tr>
<td class="org-left">BuffAnalogB</td>
<td class="org-right">127</td>
</tr>
</tbody>
</table>

<p>
Run: Run3
</p>
<table>


<colgroup>
<col class="org-left" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DAC</th>
<th scope="col" class="org-right">E6 W69</th>
<th scope="col" class="org-right">K6 W69</th>
<th scope="col" class="org-right">H9 W69</th>
<th scope="col" class="org-right">H10 W69</th>
<th scope="col" class="org-right">G10 W69</th>
<th scope="col" class="org-right">D9 W69</th>
<th scope="col" class="org-right">L8 W69</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">THL</td>
<td class="org-right">419</td>
<td class="org-right">386</td>
<td class="org-right">369</td>
<td class="org-right">434</td>
<td class="org-right">439</td>
<td class="org-right">402</td>
<td class="org-right">462</td>
</tr>

<tr>
<td class="org-left">THS</td>
<td class="org-right">68</td>
<td class="org-right">66</td>
<td class="org-right">66</td>
<td class="org-right">65</td>
<td class="org-right">69</td>
<td class="org-right">65</td>
<td class="org-right">64</td>
</tr>
</tbody>
</table>


<table>


<colgroup>
<col class="org-left" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DAC</th>
<th scope="col" class="org-right">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">IKrum</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-left">Hist</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">GND</td>
<td class="org-right">80</td>
</tr>

<tr>
<td class="org-left">Coarse</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-left">CTPR</td>
<td class="org-right">4294967295</td>
</tr>

<tr>
<td class="org-left">BiasLVDS</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">SenseDAC</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">DACCode</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-left">RefLVDS</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">Vcas</td>
<td class="org-right">130</td>
</tr>

<tr>
<td class="org-left">ExtDAC</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">Disc</td>
<td class="org-right">127</td>
</tr>

<tr>
<td class="org-left">Preamp</td>
<td class="org-right">255</td>
</tr>

<tr>
<td class="org-left">FBK</td>
<td class="org-right">128</td>
</tr>

<tr>
<td class="org-left">BuffAnalogA</td>
<td class="org-right">127</td>
</tr>

<tr>
<td class="org-left">BuffAnalogB</td>
<td class="org-right">127</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-sec:operation_calibration:high_voltage" class="outline-4">
<h4 id="sec:operation_calibration:high_voltage"><span class="section-number-4">8.1.4.</span> High voltage</h4>
<div id="text-sec:operation_calibration:high_voltage" class="outline-text-4">
<p>
The high voltage (HV) settings used for the Septemboard detector are shown
in tab. <a href="#tab:operation_calibration:hv_settings">9</a>. The target is a drift
field on the order of \(\SI{500}{V.cm⁻¹}\) and an amplification field of
about \(\SI{60}{kV.cm⁻¹}\). The main voltages to choose are the grid
voltage (to determine the amplification field) and the cathode voltage (to
determine the drift field). The other voltages are computed based on a
constant field gradient. Entries ring 1 and ring 29 are the voltages
applied to the field shaping ring running around the detector volume
to achieve a more homogeneous field. The HV for the Septemboard is
controlled via an iseg <sup>  <a id="fnr.32" href="#fn.32" class="footref" role="doc-backlink">32</a></sup> HV module, while the veto
scintillator (requiring positive high voltage) is controlled via a
CAEN N470 <sup>  <a id="fnr.33" href="#fn.33" class="footref" role="doc-backlink">33</a></sup>.
</p>

<table id="tab:operation_calibration:hv_settings">
<caption class="t-above"><span class="table-number">Table 9:</span> Table of high voltages in use for the InGrid Mk. IV. Note that the veto scintillator is not controlled via the iseg module, but by a CAEN N470.</caption>

<colgroup>
<col class="org-left" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-right">Channel</th>
<th scope="col" class="org-right">Voltage / V</th>
<th scope="col" class="org-right">TripCurrent / mA</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">grid</td>
<td class="org-right">0</td>
<td class="org-right">-300</td>
<td class="org-right">0.050</td>
</tr>

<tr>
<td class="org-left">anode</td>
<td class="org-right">1</td>
<td class="org-right">-375</td>
<td class="org-right">0.050</td>
</tr>

<tr>
<td class="org-left">cathode</td>
<td class="org-right">2</td>
<td class="org-right">-1875</td>
<td class="org-right">0.050</td>
</tr>

<tr>
<td class="org-left">ring 1</td>
<td class="org-right">3</td>
<td class="org-right">-415</td>
<td class="org-right">0.100</td>
</tr>

<tr>
<td class="org-left">ring 29</td>
<td class="org-right">4</td>
<td class="org-right">-1830</td>
<td class="org-right">0.100</td>
</tr>

<tr>
<td class="org-left">veto scinti</td>
<td class="org-right">5</td>
<td class="org-right">+1200</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">SiPM</td>
<td class="org-right">6</td>
<td class="org-right">-65.6</td>
<td class="org-right">0.05</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-sec:operation_calibration:fadc" class="outline-3">
<h3 id="sec:operation_calibration:fadc"><span class="section-number-3">8.2.</span> FADC calibration</h3>
<div id="text-sec:operation_calibration:fadc" class="outline-text-3">
<p>
The FADC requires care about multiple aspects. First, the settings need
to be chosen that configure both the operating characteristics, data
readout and trigger threshold. Next, the Ortec 474 shaping amplifier
has multiple different settings. Finally, in order to interpret the
signals received from the FADC, a so-called &quot;pedestal run&quot; should be
recorded.
</p>

<dl class="org-dl">
<dt>FADC settings</dt><dd>The FADC settings – more details in the
configuration file explanation of appendix section
<a href="./daq.html#sec:daq:tos_config_file">17.2.2</a> – configure the FADC to run at a frequency
of \(\SI{1}{GHz}\) as to cover a running time interval of
\(\SI{2.56}{μs}\) in each channel. While it could run at up to
\(\SI{2}{GHz}\), \(\SI{1}{ns}\) per time bin is accurate enough given
the time scales associated with the amplifier (see below) and a
longer interval is more useful. Further, an external trigger is sent
out to TOS if the threshold is exceeded. The threshold itself is set
to \(\SI{-40}{mV}\) <sup>  <a id="fnr.34" href="#fn.34" class="footref" role="doc-backlink">34</a></sup>. The value was chosen based
on trial and error to avoid no triggers based on baseline
noise. Given the range of up to \(\SI{-1}{V}\), the relative threshold
is pretty low. Finally, the operation mode and data readout is set,
the input channel is chosen and the pedestal run parameters are
configured (see below).</dd>
<dt>Amplifier settings</dt><dd>The 474 Ortec shaping amplifier has 3 settings
of note. The absolute gain as a multiplier and a signal integration as
well as differentiation time. The initial settings were set to an
amplification of <code>6x</code>, an integration time of \(\SI{50}{ns}\) and a
differentiation time of \(\SI{50}{ns}\). However, these were changed
during the data taking campaign, see more on this in section
<a href="./calibration.html#sec:calibration:fadc_noise">11.4.1</a>.</dd>
<dt>Pedestals</dt><dd>The \(4 · \num{2560}\) registers of the FADC are part of
4 separate cyclic registers. Due to hardware implementation details,
the absolute recorded values of each register is arbitrary. In a
pedestal run multiple measurements, \(\mathcal{O}(10)\) of a certain
length (\(\SI{100}{ms}\) in our case), are performed and the pedestal
values averaged. The resulting values represent a mean value for the
typical value in each register, hence the name &apos;pedestal&apos;. To
interpret a real measured signal, these pedestals are subtracted
from the recorded signal. Each of the 4 FADC channels may have very
different pedestal values, but within a single channel they are
usually within \(\lesssim\num{50}\) ADC
values. Fig. <a href="#fig:daq:fadc_pedestal_run">40</a> shows the pedestals of all 4
FADC channels as they were recorded before CAST data taking
started. The pedestals drift over time, but the associated time
scales are long. Alternatively, the pedestals can be computed from
real data by computing a truncated mean in each register, which
we&apos;ll discuss later in sec. <a href="./reconstruction.html#sec:reco:fadc_pedestal_calc">9.5.1</a>.</dd>
</dl>

<p>
More details to each of these will be given later where it is of
importance.
</p>


<figure id="fig:daq:fadc_pedestal_run">
<img alt="fadc_pedestal_split_by_channel.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/calibration/fadc_pedestal_split_by_channel.svg" />

<figcaption>Figure 40: <span class="figure-number">Figure 30: </span>The FADC pedestal run used for CAST data initially, split by each of the 4 FADC channels. Each channel&apos;s pedestals vary by about \(\mathcal{O}(30)\) ADC values. The first few registers in each channel are not shown, as they are outlying by \(\sim\num{100}\).</figcaption>
</figure>
</div>
<div id="outline-container-org4677dd9" class="outline-4">
<h4 id="org4677dd9"><span class="section-number-4">8.2.1.</span> Generate plot of pedestals   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-8-2-1" class="outline-text-4">
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>strutils, os, sequtils, algorithm<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> ggplotnim

<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/home/basti/CastData/ExternCode/TimepixAnalysis/resources/pedestalRuns/&quot;</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">file </span>= <span style="color: #E6DB74;">&quot;pedestalRun000042_1_182143774.txt-fadc&quot;</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">read the FADC files using our CSV parser. Everything `</span><span style="color: #AE81FF;">#</span><span style="color: #75715E;">` is header</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">aside from the last 3 lines. Skip those using `</span><span style="color: #AE81FF;">maxLines</span><span style="color: #75715E;">`</span>
<span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= readCsv<span style="color: #AE81FF;">(</span>path / file, header = <span style="color: #E6DB74;">&quot;#&quot;</span>, maxLines = <span style="font-style: italic;">10240</span><span style="color: #AE81FF;">)</span>
  .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;val&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;nb of channels: 0&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">generate indices 0, 0, 0, 0, 1, 1, 1, 1, ..., 2559, 2559, 2559, 2559 </span>
df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Register&quot;</span><span style="color: #AE81FF;">]</span> = toSeq<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">4</span><span style="color: #AE81FF;">)</span>.concat.sorted
df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #AE81FF;">]</span> = @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">3</span>, <span style="font-style: italic;">4</span><span style="color: #AE81FF;">]</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.concat
<span style="color: #F92672;">when</span> <span style="color: #AE81FF;">false</span>:
  df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #AE81FF;">]</span> = @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">3</span>, <span style="font-style: italic;">4</span><span style="color: #AE81FF;">]</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>
  df = df.mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">int</span> -&gt; <span style="color: #66D9EF;">bool</span>: <span style="color: #E6DB74;">&quot;even?&quot;</span> ~ `<span style="color: #66D9EF;">Channel</span>` <span style="color: #F92672;">mod</span> <span style="font-style: italic;">2</span> == <span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> df
  <span style="color: #F92672;">echo</span> df.tail<span style="color: #AE81FF;">(</span><span style="font-style: italic;">20</span><span style="color: #AE81FF;">)</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Channel&quot;</span>, <span style="color: #E6DB74;">&quot;val&quot;</span>, color = <span style="color: #E6DB74;">&quot;even?&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">(</span>size = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;FADC channel values of pedestal run&quot;</span><span style="color: #AE81FF;">)</span> +  
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/calibration/fadc_pedestal_run.pdf&quot;</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#         </span><span style="color: #75715E;">useTeX = true, standalone = true)</span>
  ggplot<span style="color: #AE81FF;">(</span>df.group_by<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;even?&quot;</span><span style="color: #66D9EF;">)</span>.filter<span style="color: #66D9EF;">(</span>f<span style="color: #A6E22E;">{</span><span style="color: #66D9EF;">float</span> -&gt; <span style="color: #66D9EF;">bool</span>: `val` &lt; percentile<span style="color: #E6DB74;">(</span>col<span style="color: #FD971F;">(</span><span style="color: #E6DB74;">&quot;val&quot;</span><span style="color: #FD971F;">)</span>, <span style="font-style: italic;">95</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">}</span><span style="color: #66D9EF;">)</span>,
         aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Channel&quot;</span>, <span style="color: #E6DB74;">&quot;val&quot;</span>, color = <span style="color: #E6DB74;">&quot;even?&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    facet_wrap<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;even?&quot;</span>, scales = <span style="color: #E6DB74;">&quot;free&quot;</span><span style="color: #AE81FF;">)</span> +
    facetMargin<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> +
    margin<span style="color: #AE81FF;">(</span>bottom = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, right = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">(</span>size = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">91</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;FADC channel values of pedestal run, split by even and odd channel numbers&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/calibration/fadc_pedestal_split_even_odd.pdf&quot;</span>, width = <span style="font-style: italic;">1200</span>, height = <span style="font-style: italic;">600</span><span style="color: #AE81FF;">)</span><span style="color: #75715E;">#</span>
  <span style="color: #75715E;">#         </span><span style="color: #75715E;">useTeX = true, standalone = true)</span>
<span style="color: #F92672;">else</span>:
  ggplot<span style="color: #AE81FF;">(</span>df.group_by<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #66D9EF;">)</span>.filter<span style="color: #66D9EF;">(</span>f<span style="color: #A6E22E;">{</span><span style="color: #66D9EF;">float</span> -&gt; <span style="color: #66D9EF;">bool</span>: `val` &lt; percentile<span style="color: #E6DB74;">(</span>col<span style="color: #FD971F;">(</span><span style="color: #E6DB74;">&quot;val&quot;</span><span style="color: #FD971F;">)</span>, <span style="font-style: italic;">99</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">}</span><span style="color: #66D9EF;">)</span>,
         aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Register&quot;</span>, <span style="color: #E6DB74;">&quot;val&quot;</span>, color = <span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    facet_wrap<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Channel&quot;</span>, scales = <span style="color: #E6DB74;">&quot;free&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">(</span>size = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    facetMargin<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">7</span><span style="color: #AE81FF;">)</span> +
    margin<span style="color: #AE81FF;">(</span>bottom = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, right = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    scale_y_continuous<span style="color: #AE81FF;">(</span>breaks = <span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> + 
    legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">87</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + 
    ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Register&quot;</span><span style="color: #AE81FF;">)</span> + 
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;FADC register pedestal values, split by channels&quot;</span><span style="color: #AE81FF;">)</span> +    
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Channel&quot;</span>, margin = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, width = <span style="font-style: italic;">600</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> + 
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/calibration/fadc_pedestal_split_by_channel.pdf&quot;</span>,
          useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9f92327" class="outline-4">
<h4 id="org9f92327"><span class="section-number-4">8.2.2.</span> Calculate pedestals from real FADC data <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-8-2-2" class="outline-text-4">
<p>
We will now see what happens if we compute the FADC pedestals from the
raw data by computing a truncated mean of all FADC files in a single
run and comparing to the real pedestal run we normally use as a
reference.
</p>

<p>
<b>UPDATE</b>: <span class="timestamp-wrapper">  <span class="timestamp">&lt;2022-12-26 Mon 00:48&gt; </span></span> This was a big success. We will use
this in our real data from now on, move this to <code>statusAndProgress</code>
and rewrite the section above with that in mind, i.e. explain how to
calc pedestals.
</p>
<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>REWRITE MAIN TEXT</b></li>

<li class="off"><code>[ ]</code> <b>TEST PEDESTAL CALC FOR BACKGROUND DATA</b></li>

<li class="off"><code>[ ]</code> look at c-blake&apos;s ideas using `MovingStat`, a logarithmic histogram etc. to avoid
the multiple passes over the data as we do using `sort`! See my journal.org notes about
this!</li>
</ul>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>strutils, os, sequtils, sugar, algorithm<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> ggplotnim

<span style="color: #75715E;"># </span><span style="color: #75715E;">to read from H5 input</span>
<span style="color: #F92672;">import</span> nimhdf5
<span style="color: #F92672;">import</span> ingrid / tos_helpers
<span style="color: #F92672;">import</span> ingrid / ingrid_types

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readFadc</span><span style="color: #AE81FF;">(</span>f: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">read the FADC files using our CSV parser. Everything `</span><span style="color: #AE81FF;">#</span><span style="color: #75715E;">` is header</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">aside from the last 3 lines. Skip those using `</span><span style="color: #AE81FF;">maxLines</span><span style="color: #75715E;">`</span>
  <span style="color: #FD971F;">result</span> = readCsv<span style="color: #AE81FF;">(</span>f, header = <span style="color: #E6DB74;">&quot;#&quot;</span>, maxLines = <span style="font-style: italic;">10240</span><span style="color: #AE81FF;">)</span>
    .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;val&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;nb of channels: 0&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">result[&quot;Channel&quot;] = toSeq(0 ..&lt; result.len)</span>
  <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Register&quot;</span><span style="color: #AE81FF;">]</span> = toSeq<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">4</span><span style="color: #AE81FF;">)</span>.concat.sorted
  <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #AE81FF;">]</span> = @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">3</span>, <span style="font-style: italic;">4</span><span style="color: #AE81FF;">]</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.concat

<span style="color: #F92672;">const</span> <span style="color: #66D9EF;">Size</span> = <span style="font-style: italic;">5000</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">getFadcDset</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>, runNumber: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">H5DataSet</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fadcGroup </span>= fadcRawPath<span style="color: #AE81FF;">(</span>runNumber<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">doAssert</span> fadcGroup <span style="color: #F92672;">in</span> h5f
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">group </span>= h5f<span style="color: #AE81FF;">[</span>fadcGroup.grp_str<span style="color: #AE81FF;">]</span>
  <span style="color: #FD971F;">result</span> = h5f<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span>group.name / <span style="color: #E6DB74;">&quot;raw_fadc&quot;</span><span style="color: #66D9EF;">)</span>.dset_str<span style="color: #AE81FF;">]</span>
  
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readChannel</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>, dset: <span style="color: #66D9EF;">H5DataSet</span>, start: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">uint16</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">toRead </span>= <span style="color: #F92672;">min</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Size</span>, dset.shape<span style="color: #66D9EF;">[</span><span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span> - start<span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = read_hyperslab<span style="color: #AE81FF;">(</span>dset, <span style="color: #66D9EF;">uint16</span>,
                          offset = @<span style="color: #66D9EF;">[</span>start, <span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span>,
                          count = @<span style="color: #66D9EF;">[</span>toRead, dset.shape<span style="color: #A6E22E;">[</span><span style="font-style: italic;">1</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  
<span style="color: #F92672;">import</span> weave
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">percIdx</span><span style="color: #AE81FF;">(</span>q: <span style="color: #66D9EF;">float</span>, <span style="color: #F92672;">len</span>: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">int</span> = <span style="color: #AE81FF;">(</span><span style="color: #F92672;">len</span>.<span style="color: #66D9EF;">float</span> * q<span style="color: #AE81FF;">)</span>.round.<span style="color: #66D9EF;">int</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E; font-weight: bold; font-style: italic;">biasedTruncMean*</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">](</span>x: <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">T</span><span style="color: #66D9EF;">]</span>, axis: <span style="color: #66D9EF;">int</span>, qLow, qHigh: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Tensor</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #E6DB74;">## Computes the *biased* truncated mean of `</span><span style="color: #AE81FF;">x</span><span style="color: #E6DB74;">` by removing the quantiles `</span><span style="color: #AE81FF;">qLow</span><span style="color: #E6DB74;">` on the</span>
  <span style="color: #E6DB74;">## bottom end and `</span><span style="color: #AE81FF;">qHigh</span><span style="color: #E6DB74;">` on the upper end.</span>
  <span style="color: #E6DB74;">## ends of the data. `</span><span style="color: #AE81FF;">q</span><span style="color: #E6DB74;">` should be given as a fraction of events to remove on both ends.</span>
  <span style="color: #E6DB74;">## E.g. `</span><span style="color: #AE81FF;">qLow = 0.05, qHigh = 0.99</span><span style="color: #E6DB74;">` removes anything below the 5-th percentile and above the 99-th.</span>
  <span style="color: #E6DB74;">##</span>
  <span style="color: #E6DB74;">## Note: uses `</span><span style="color: #AE81FF;">weave</span><span style="color: #E6DB74;">` internally to multithread along the desired axis!</span>
  <span style="color: #F92672;">doAssert</span> x.rank == <span style="font-style: italic;">2</span>
  <span style="color: #FD971F;">result</span> = newTensorUninit<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span>x.shape<span style="color: #66D9EF;">[</span>axis<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  init<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Weave</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xBuf </span>= x.toUnsafeView<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">resBuf </span>= <span style="color: #FD971F;">result</span>.toUnsafeView<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">notAxis </span>= <span style="color: #F92672;">if</span> axis == <span style="font-style: italic;">0</span>: <span style="font-style: italic;">1</span> <span style="color: #F92672;">else</span>: <span style="font-style: italic;">0</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">numH </span>= x.shape<span style="color: #AE81FF;">[</span>notAxis<span style="color: #AE81FF;">]</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">assuming row column major, 0 is # rows, 1 is # cols</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">numW </span>= x.shape<span style="color: #AE81FF;">[</span>axis<span style="color: #AE81FF;">]</span>
  parallelFor i <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; numW:
    captures: <span style="color: #AE81FF;">{</span>xBuf, resBuf, numH, numW, axis, qLow, qHigh<span style="color: #AE81FF;">}</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xT </span>= xBuf.fromBuffer<span style="color: #AE81FF;">(</span>numH, numW<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">get a sorted slice for index `</span><span style="color: #AE81FF;">i</span><span style="color: #75715E;">`</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">subSorted </span>= xT.atAxisIndex<span style="color: #AE81FF;">(</span>axis, i<span style="color: #AE81FF;">)</span>.squeeze.sorted
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">plow </span>= percIdx<span style="color: #AE81FF;">(</span>qLow, numH<span style="color: #AE81FF;">)</span> 
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">phih </span>= percIdx<span style="color: #AE81FF;">(</span>qHigh, numH<span style="color: #AE81FF;">)</span>

    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">resT </span>= resBuf.fromBuffer<span style="color: #AE81FF;">(</span>numW<span style="color: #AE81FF;">)</span>
    <span style="color: #E6DB74;">## compute the biased truncated mean by slicing sorted data to lower and upper</span>
    <span style="color: #E6DB74;">## percentile index</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">red </span>= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span> 
    <span style="color: #F92672;">for</span> j <span style="color: #F92672;">in</span> <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, plow<span style="color: #AE81FF;">)</span> ..&lt; <span style="color: #F92672;">min</span><span style="color: #AE81FF;">(</span>numH, phih<span style="color: #AE81FF;">)</span>: <span style="color: #75715E;"># </span><span style="color: #75715E;">loop manually as data is `</span><span style="color: #AE81FF;">uint16</span><span style="color: #75715E;">` to convert</span>
      red += subSorted<span style="color: #AE81FF;">[</span>j<span style="color: #AE81FF;">]</span>.<span style="color: #66D9EF;">float</span>
    resT<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = red / <span style="color: #AE81FF;">(</span>phih - plow<span style="color: #AE81FF;">)</span>.<span style="color: #66D9EF;">float</span>
  syncRoot<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Weave</span><span style="color: #AE81FF;">)</span>
  exit<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Weave</span><span style="color: #AE81FF;">)</span>

defColumn<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">uint16</span>, <span style="color: #66D9EF;">uint8</span><span style="color: #AE81FF;">)</span>  
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readFadcH5</span><span style="color: #AE81FF;">(</span>f: <span style="color: #66D9EF;">string</span>, runNumber: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> = <span style="color: #75715E;">#</span><span style="color: #75715E;">seq[DataTable[colType(uint16, uint8)]] =</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>f, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">registers </span>= toSeq<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">4</span><span style="color: #AE81FF;">)</span>.concat.sorted
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">channels </span>= @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">3</span>, <span style="font-style: italic;">4</span><span style="color: #AE81FF;">]</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.concat
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">idxs </span>= arange<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>, <span style="font-style: italic;">2560</span>, <span style="font-style: italic;">4</span><span style="color: #AE81FF;">)</span>
  <span style="color: #E6DB74;">## XXX: maybe just read the hyperslab that corresponds to a single channel over</span>
  <span style="color: #E6DB74;">## the whole run? That&apos;s the whole point of those after all.</span>
  <span style="color: #E6DB74;">##  -&gt; That is way too slow unfortunately</span>
  <span style="color: #E6DB74;">## XXX: better replace logic by going row wise N elements instead of column wise.</span>
  <span style="color: #E6DB74;">## Has the advantage that our memory requirements are constant and not dependent</span>
  <span style="color: #E6DB74;">## on the number of elements in the run. If we then average over the resulting N</span>
  <span style="color: #E6DB74;">## pedestals, it should be fine.</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dset </span>= getFadcDset<span style="color: #AE81FF;">(</span>h5f, runNumber<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">val </span>= newTensor<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span><span style="font-style: italic;">2560</span> * <span style="font-style: italic;">4</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">when</span> <span style="color: #AE81FF;">true</span>:
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">slices </span>= <span style="font-style: italic;">0</span>
    <span style="color: #F92672;">for</span> i <span style="color: #F92672;">in</span> arange<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, dset.shape<span style="color: #66D9EF;">[</span><span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span>, <span style="color: #66D9EF;">Size</span><span style="color: #AE81FF;">)</span>:
      <span style="color: #75715E;"># </span><span style="color: #75715E;">read </span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">data </span>= readChannel<span style="color: #AE81FF;">(</span>h5f, dset, i<span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">toRead </span>= <span style="color: #F92672;">min</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Size</span>, dset.shape<span style="color: #66D9EF;">[</span><span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span> - i<span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Reading...&quot;</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dT </span>= data.toTensor.reshape<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span>toRead, data.<span style="color: #F92672;">len</span> <span style="color: #F92672;">div</span> toRead<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Read &quot;</span>, i, <span style="color: #E6DB74;">&quot; to read up to : &quot;</span>, toRead, <span style="color: #E6DB74;">&quot; now processing...&quot;</span>
      <span style="color: #F92672;">inc</span> slices
      val += biasedTruncMean<span style="color: #AE81FF;">(</span>dT, axis = <span style="font-style: italic;">1</span>, qLow = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">2</span>, qHigh = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">98</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">for</span> i <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span> * <span style="font-style: italic;">4</span>:
      val<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> /= slices.<span style="color: #66D9EF;">float</span>
  <span style="color: #FD971F;">result</span> = toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Channel&quot;</span> : channels, val, <span style="color: #E6DB74;">&quot;Register&quot;</span> : registers<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">for fadc in h5f.iterFadcFromH5(runNumber):</span>
  <span style="color: #75715E;">#  </span><span style="color: #75715E;">let datCh3 = fadc.data[idxs] # .mapIt(it.int)</span>
  <span style="color: #75715E;">#  </span><span style="color: #75715E;">var df = toDf({&quot;val&quot; : dat, &quot;Register&quot; : registers, &quot;Channel&quot; : channels})</span>
  <span style="color: #75715E;">#  </span><span style="color: #75715E;">result.add df</span>

<span style="color: #E6DB74;">## Main function to avoid bug of closure capturing old variable  </span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readFadcData</span><span style="color: #AE81FF;">(</span>path: <span style="color: #66D9EF;">string</span>, runNumber: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> =
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">if</span> path.endsWith<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;.h5&quot;</span><span style="color: #AE81FF;">)</span>:
    <span style="color: #F92672;">doAssert</span> runNumber &gt; <span style="font-style: italic;">0</span>
    df = readFadcH5<span style="color: #AE81FF;">(</span>path, runNumber<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">else</span>:
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dfs </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">DataFrame</span><span style="color: #AE81FF;">]()</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">i </span>= <span style="font-style: italic;">0</span>
    <span style="color: #F92672;">for</span> f <span style="color: #F92672;">in</span> walkFiles<span style="color: #AE81FF;">(</span>path / <span style="color: #E6DB74;">&quot;*.txt-fadc&quot;</span><span style="color: #AE81FF;">)</span>:
      <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Parsing &quot;</span>, f
      dfs.<span style="color: #F92672;">add</span> readFadc<span style="color: #AE81FF;">(</span>f<span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">inc</span> i
      <span style="color: #F92672;">if</span> i &gt; <span style="font-style: italic;">5000</span>: <span style="color: #F92672;">break</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfP </span>= assignStack<span style="color: #AE81FF;">(</span>dfs<span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">reg </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]()</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">val </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">chs </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]()</span>
    <span style="color: #F92672;">for</span> <span style="color: #AE81FF;">(</span>tup, subDf<span style="color: #AE81FF;">)</span> <span style="color: #F92672;">in</span> groups<span style="color: #AE81FF;">(</span>dfP.group_by<span style="color: #66D9EF;">(</span><span style="color: #A6E22E;">[</span><span style="color: #E6DB74;">&quot;Channel&quot;</span>, <span style="color: #E6DB74;">&quot;Register&quot;</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>:
      <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;At &quot;</span>, tup
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">p20 </span>= percentile<span style="color: #AE81FF;">(</span>subDf<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;val&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span>, <span style="font-style: italic;">20</span><span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">p80 </span>= percentile<span style="color: #AE81FF;">(</span>subDf<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;val&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span>, <span style="font-style: italic;">80</span><span style="color: #AE81FF;">)</span>
      reg.<span style="color: #F92672;">add</span> tup<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span><span style="color: #AE81FF;">][</span><span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>.<span style="color: #F92672;">toInt</span>
      chs.<span style="color: #F92672;">add</span> tup<span style="color: #AE81FF;">[</span><span style="font-style: italic;">0</span><span style="color: #AE81FF;">][</span><span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>.<span style="color: #F92672;">toInt</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfF </span>= <span style="color: #F92672;">if</span> p80 - p20 &gt; <span style="font-style: italic;">0</span>: subDf.filter<span style="color: #AE81FF;">(</span>dfFn<span style="color: #66D9EF;">(</span>subDf, f<span style="color: #A6E22E;">{</span><span style="color: #66D9EF;">float</span>: `val` &gt;= p20 <span style="color: #F92672;">and</span> `val` &lt;= p80<span style="color: #A6E22E;">}</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
                <span style="color: #F92672;">else</span>: subDf
      val.<span style="color: #F92672;">add</span> dfF<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;val&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.mean
    df = toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Channel&quot;</span> : chs, val, <span style="color: #E6DB74;">&quot;Register&quot;</span> : reg<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  df.writeCsv<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/t/pedestal.csv&quot;</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> df.pretty<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = df

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">main</span><span style="color: #AE81FF;">(</span>path: <span style="color: #66D9EF;">string</span>, outfile: <span style="color: #66D9EF;">string</span> = <span style="color: #E6DB74;">&quot;/t/empirical_fadc_pedestal_diff.pdf&quot;</span>,
          plotVoltage = <span style="color: #AE81FF;">false</span>,
          runNumber = -<span style="font-style: italic;">1</span>,
          onlyCsv = <span style="color: #AE81FF;">false</span>
         <span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">pData </span>= readFadcData<span style="color: #AE81FF;">(</span>path, runNumber<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">if</span> onlyCsv: <span style="color: #F92672;">return</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/home/basti/CastData/ExternCode/TimepixAnalysis/resources/pedestalRuns/&quot;</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">file </span>= <span style="color: #E6DB74;">&quot;pedestalRun000042_1_182143774.txt-fadc&quot;</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">pReal </span>= readFadc<span style="color: #AE81FF;">(</span>path / file<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;DATA= &quot;</span>, pData
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;REAL= &quot;</span>, pReal
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= bind_rows<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span><span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;Data&quot;</span>, pData<span style="color: #A6E22E;">)</span>, <span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;Real&quot;</span>, pReal<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;ID&quot;</span><span style="color: #AE81FF;">)</span>
    .spread<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;ID&quot;</span>, <span style="color: #E6DB74;">&quot;val&quot;</span><span style="color: #AE81FF;">)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Diff&quot;</span> ~ <span style="color: #F92672;">abs</span><span style="color: #A6E22E;">(</span>`<span style="color: #66D9EF;">Data</span>` - `<span style="color: #66D9EF;">Real</span>`<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">alternatively compute the voltage corresponding to the FADC register values,</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">assuming 12 bit working mode (sampling_mode == 0)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;DiffVolt&quot;</span> ~ `<span style="color: #66D9EF;">Diff</span>` / <span style="font-style: italic;">2048</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">plt</span>: <span style="color: #66D9EF;">GgPlot</span>
  <span style="color: #F92672;">if</span> plotVoltage:
    plt = ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Register&quot;</span>, <span style="color: #E6DB74;">&quot;DiffVolt&quot;</span>, color = <span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
      ylim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, <span style="font-style: italic;">100</span>.<span style="font-style: italic;">0</span> / <span style="font-style: italic;">2048</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>    
  <span style="color: #F92672;">else</span>:
    plt = ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Register&quot;</span>, <span style="color: #E6DB74;">&quot;Diff&quot;</span>, color = <span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
      ylim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, <span style="font-style: italic;">100</span><span style="color: #AE81FF;">)</span>
  plt +
    geom_point<span style="color: #AE81FF;">(</span>size = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span>, alpha = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">75</span><span style="color: #AE81FF;">)</span> +
    ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Difference between mean and actual pedestal [ADC]&quot;</span><span style="color: #AE81FF;">)</span> + 
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Attempt at computing pedestal values based on truncated mean of data&quot;</span><span style="color: #AE81FF;">)</span> +
    margin<span style="color: #AE81FF;">(</span>top = <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> +
    xlim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, <span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span> + 
    ggsave<span style="color: #AE81FF;">(</span>outfile<span style="color: #AE81FF;">)</span>
  
<span style="color: #F92672;">when</span> <span style="color: #AE81FF;">isMainModule</span>:
  <span style="color: #F92672;">import</span> cligen
  dispatch main
</pre>
</div>

<p>
We can call it on different runs with FADC data:
</p>
<div class="org-src-container">
<pre class="src src-sh">code/attempt_fadc_pedestals_from_data <span style="color: #E6DB74; font-weight: bold;">\</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">-p /mnt/1TB/CAST/2017/DataRuns/Run_77_171102-05-24 \</span>
    -p ~/CastData/data/2017/Run_96_171123-10-42 <span style="color: #E6DB74; font-weight: bold;">\</span>
<span style="color: #75715E;">#    </span><span style="color: #75715E;">--outfile ~/phd/Figs/detector/calibration/pedestal_from_data_compare_real_run77.pdf</span>
    --outfile ~/phd/Figs/detector/calibration/pedestal_from_data_compare_real_run96.pdf    
</pre>
</div>

<p>
for an early 2017 run
</p>
<div class="org-src-container">
<pre class="src src-sh">code/attempt_fadc_pedestals_from_data <span style="color: #E6DB74; font-weight: bold;">\</span>
    -p /mnt/1TB/CAST/2018_2/DataRuns/Run_303_181217-16-52 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --outfile ~/phd/Figs/detector/calibration/pedestal_from_data_compare_real_run303.pdf
</pre>
</div>

<p>
for a late 2018 run.
</p>

<p>
These yield fig. <a href="#fig:daq:fadc_pedestals_from_data_compare_real">41</a>
</p>


<figure id="fig:daq:fadc_pedestals_from_data_compare_real" class="figure-wrapper">
<figure id="fig:daq:fadc_pedestals_from_data_compare_real_run77" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/calibration/pedestal_from_data_compare_real_run77.svg" data-width="99%" />  <figcaption>Figure 41(a): Run 77</figcaption></figure> <figure id="fig:reco:fadc_pedestals_from_data_compare_real_run303" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/calibration/pedestal_from_data_compare_real_run303.svg" data-width="99%" />  <figcaption>Figure 41(b): Run 303</figcaption></figure>
<figcaption>Figure 41: Calculation of the FADC pedestals from data by averaging all channels
    over all FADC data files of a single run using a truncated mean from the 20-th
    to 80-th percentile of the distribution. Both data runs show a comparatively small
    variance. Arguably it may make sense to \textit{always} compute it based on each
    run instead of relying on a pedestal run though.</figcaption>
</figure>


<p>
Surprisingly, the deviation for the end 2018 run is lower than for the
2017 run, despite the 2017 run being closer in time to the real
pedestal run.
</p>

<p>
Keep in mind that in our data taking we used the 12 bit readout
mode. This means the register values divided by \num{2048} correspond
to the voltages recorded by the register. As such the absolute values
of the deviations are quite a bit smaller than \(\lesssim \SI{48}{mV}\)
(which is small given the absolute range of \(±\SI{1}{V}\) of the FADC.
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> nimhdf5, ggplotnim
<span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>strutils, os, sequtils<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> ingrid / <span style="color: #AE81FF;">[</span>tos_helpers, fadc_helpers, ingrid_types, fadc_analysis<span style="color: #AE81FF;">]</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">stripPrefix</span><span style="color: #AE81FF;">(</span>s, p: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">string</span> =
  <span style="color: #FD971F;">result</span> = s
  <span style="color: #FD971F;">result</span>.removePrefix<span style="color: #AE81FF;">(</span>p<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotIdx</span><span style="color: #AE81FF;">(</span>df: <span style="color: #66D9EF;">DataFrame</span>, fadcData: <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span>, idx: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xmin </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;argMinval&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xminY </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;minvals&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xminlineX </span>= @<span style="color: #AE81FF;">[</span>xmin, xmin<span style="color: #AE81FF;">]</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">one point for x of min, max</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fData </span>= fadcData<span style="color: #AE81FF;">[</span>idx, _<span style="color: #AE81FF;">]</span>.squeeze
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xminlineY </span>= linspace<span style="color: #AE81FF;">(</span>fData.<span style="color: #F92672;">min</span>, fData.<span style="color: #F92672;">max</span>, <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>

  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">riseStart </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;riseStart&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fallStop </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;fallStop&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">riseStartX </span>= @<span style="color: #AE81FF;">[</span>riseStart, riseStart<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fallStopX </span>= @<span style="color: #AE81FF;">[</span>fallStop, fallStop<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">baseline </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;baseline&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>  
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">baselineY </span>= @<span style="color: #AE81FF;">[</span>baseline, baseline<span style="color: #AE81FF;">]</span>
  
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;x&quot;</span>         : toSeq<span style="color: #A6E22E;">(</span><span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span><span style="color: #A6E22E;">)</span>,
                  <span style="color: #E6DB74;">&quot;baseline&quot;</span>  : baseline,
                  <span style="color: #E6DB74;">&quot;data&quot;</span>      : fData,
                  <span style="color: #E6DB74;">&quot;xminX&quot;</span>     : xminlineX, 
                  <span style="color: #E6DB74;">&quot;xminY&quot;</span>     : xminlineY,
                  <span style="color: #E6DB74;">&quot;riseStart&quot;</span> : riseStartX,
                  <span style="color: #E6DB74;">&quot;fallStop&quot;</span>  : fallStopX <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
                  <span style="color: #75715E;"># </span><span style="color: #75715E;">Comparison has to be done by hand unfortunately</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/t/fadc_spectrum_baseline.pdf&quot;</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;data&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    geom_point<span style="color: #AE81FF;">(</span>color = color<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>data = df.head<span style="color: #66D9EF;">(</span><span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;baseline&quot;</span><span style="color: #66D9EF;">)</span>,
                     color = <span style="color: #E6DB74;">&quot;blue&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>data = df.head<span style="color: #66D9EF;">(</span><span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;xminX&quot;</span>, <span style="color: #E6DB74;">&quot;xminY&quot;</span><span style="color: #66D9EF;">)</span>,
                     color = <span style="color: #E6DB74;">&quot;red&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>data = df.head<span style="color: #66D9EF;">(</span><span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;riseStart&quot;</span>, <span style="color: #E6DB74;">&quot;xminY&quot;</span><span style="color: #66D9EF;">)</span>,
                     color = <span style="color: #E6DB74;">&quot;green&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>data = df.head<span style="color: #66D9EF;">(</span><span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;fallStop&quot;</span>, <span style="color: #E6DB74;">&quot;xminY&quot;</span><span style="color: #66D9EF;">)</span>,
                     color = <span style="color: #E6DB74;">&quot;pink&quot;</span><span style="color: #AE81FF;">)</span> +
    ggsave<span style="color: #AE81FF;">(</span>path<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotCompare</span><span style="color: #AE81FF;">(</span>data, real: <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/t/fadc_spectrum_compare.pdf&quot;</span>
  <span style="color: #F92672;">for</span> idx <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; data.shape<span style="color: #AE81FF;">[</span><span style="font-style: italic;">0</span><span style="color: #AE81FF;">]</span>:
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;x&quot;</span> : toSeq<span style="color: #A6E22E;">(</span><span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span><span style="color: #A6E22E;">)</span>,
                    <span style="color: #E6DB74;">&quot;data&quot;</span> : data<span style="color: #A6E22E;">[</span>idx, _<span style="color: #A6E22E;">]</span>.squeeze,
                    <span style="color: #E6DB74;">&quot;real&quot;</span> : real<span style="color: #A6E22E;">[</span>idx, _<span style="color: #A6E22E;">]</span>.squeeze <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
      .gather<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;data&quot;</span>, <span style="color: #E6DB74;">&quot;real&quot;</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;type&quot;</span>, <span style="color: #E6DB74;">&quot;vals&quot;</span><span style="color: #AE81FF;">)</span>
    ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;vals&quot;</span>, color = <span style="color: #E6DB74;">&quot;type&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
      geom_line<span style="color: #AE81FF;">()</span> +
      <span style="color: #75715E;">#</span><span style="color: #75715E;">geom_point(color = color(0.1, 0.1, 0.1, 0.1)) +</span>
      ggsave<span style="color: #AE81FF;">(</span>path<span style="color: #AE81FF;">)</span>
    sleep<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">getFadcData</span><span style="color: #AE81FF;">(</span>fadcRun: <span style="color: #66D9EF;">ProcessedFadcRun</span>, pedestal: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">uint16</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Tensor</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ch0 </span>= getCh0Indices<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">let</span>
    fadc_ch0_indices = getCh0Indices<span style="color: #AE81FF;">()</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">we demand at least 4 dips, before we can consider an event as noisy</span>
    n_dips = <span style="font-style: italic;">4</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">the percentile considered for the calculation of the minimum</span>
    min_percentile = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">95</span>
    numFiles = fadcRun.eventNumber.<span style="color: #F92672;">len</span>
  
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">fData </span>= <span style="color: #66D9EF;">ReconstructedFadcRun</span><span style="color: #AE81FF;">(</span>
    fadc_data: newTensorUninit<span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">](</span><span style="color: #A6E22E;">[</span>numFiles, <span style="font-style: italic;">2560</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">)</span>,
    eventNumber: fadcRun.eventNumber,
    noisy: <span style="color: #F92672;">newSeq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">](</span>numFiles<span style="color: #66D9EF;">)</span>,
    minVals: <span style="color: #F92672;">newSeq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">](</span>numFiles<span style="color: #66D9EF;">)</span>
  <span style="color: #AE81FF;">)</span>

  <span style="color: #F92672;">for</span> i <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; fadcRun.eventNumber.<span style="color: #F92672;">len</span>:
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">slice </span>= fadcRun.rawFadcData<span style="color: #AE81FF;">[</span>i, _<span style="color: #AE81FF;">]</span>.squeeze
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">data </span>= slice.fadcFileToFadcData<span style="color: #AE81FF;">(</span>
      pedestal,
      fadcRun.trigRecs<span style="color: #66D9EF;">[</span>i<span style="color: #66D9EF;">]</span>, fadcRun.settings.postTrig, fadcRun.settings.bitMode14,
      fadc_ch0_indices<span style="color: #AE81FF;">)</span>.data
    fData.fadc_data<span style="color: #AE81FF;">[</span>i, _<span style="color: #AE81FF;">]</span> = data.unsqueeze<span style="color: #AE81FF;">(</span>axis = <span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    fData.noisy<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>        = data.isFadcFileNoisy<span style="color: #AE81FF;">(</span>n_dips<span style="color: #AE81FF;">)</span>
    fData.minVals<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>      = data.calcMinOfPulse<span style="color: #AE81FF;">(</span>min_percentile<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">when</span> <span style="color: #AE81FF;">false</span>:
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">data </span>= fData.fadcData.toSeq2D
    <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>baseline, xMin, riseStart, fallStop, riseTime, fallTime<span style="color: #AE81FF;">)</span> = calcRiseAndFallTime<span style="color: #AE81FF;">(</span>
      data, 
      <span style="color: #AE81FF;">false</span>
    <span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;argMinval&quot;</span> : xMin.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>,
                    <span style="color: #E6DB74;">&quot;baseline&quot;</span> : baseline.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>,
                    <span style="color: #E6DB74;">&quot;riseStart&quot;</span> : riseStart.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>,
                    <span style="color: #E6DB74;">&quot;fallStop&quot;</span> : fallStop.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>,
                    <span style="color: #E6DB74;">&quot;riseTime&quot;</span> : riseTime.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>,
                    <span style="color: #E6DB74;">&quot;fallTime&quot;</span> : fallTime.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>,
                    <span style="color: #E6DB74;">&quot;minvals&quot;</span> : fData.minvals <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">for</span> idx <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; df.<span style="color: #F92672;">len</span>:
      plotIdx<span style="color: #AE81FF;">(</span>df, fData.fadc_data, idx<span style="color: #AE81FF;">)</span>
      sleep<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>

  <span style="color: #FD971F;">result</span> = fData.fadcData

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readFadc</span><span style="color: #AE81FF;">(</span>f: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">read the FADC files using our CSV parser. Everything `</span><span style="color: #AE81FF;">#</span><span style="color: #75715E;">` is header</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">aside from the last 3 lines. Skip those using `</span><span style="color: #AE81FF;">maxLines</span><span style="color: #75715E;">`</span>
  <span style="color: #FD971F;">result</span> = readCsv<span style="color: #AE81FF;">(</span>f, header = <span style="color: #E6DB74;">&quot;#&quot;</span>, maxLines = <span style="font-style: italic;">10240</span><span style="color: #AE81FF;">)</span>
    .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;val&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;nb of channels: 0&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">result[&quot;Channel&quot;] = toSeq(0 ..&lt; result.len)</span>
  <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Register&quot;</span><span style="color: #AE81FF;">]</span> = toSeq<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">4</span><span style="color: #AE81FF;">)</span>.concat.sorted
  <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #AE81FF;">]</span> = @<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">3</span>, <span style="font-style: italic;">4</span><span style="color: #AE81FF;">]</span>.repeat<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2560</span><span style="color: #AE81FF;">)</span>.concat

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">main</span><span style="color: #AE81FF;">(</span>fname: <span style="color: #66D9EF;">string</span>, runNumber: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>fname, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">pedestal </span>= readCsv<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/t/pedestal.csv&quot;</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">created from above</span>
    .arrange<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;Register&quot;</span>, <span style="color: #E6DB74;">&quot;Channel&quot;</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> pedestal
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/home/basti/CastData/ExternCode/TimepixAnalysis/resources/pedestalRuns/&quot;</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">file </span>= <span style="color: #E6DB74;">&quot;pedestalRun000042_1_182143774.txt-fadc&quot;</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">pReal </span>= readFadc<span style="color: #AE81FF;">(</span>path / file<span style="color: #AE81FF;">)</span>
  
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fileInfo </span>= h5f.getFileInfo<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">for</span> run <span style="color: #F92672;">in</span> fileInfo.runs:
    <span style="color: #F92672;">if</span> run == runNumber:
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fadcRun </span>= h5f.readFadcFromH5<span style="color: #AE81FF;">(</span>run<span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fromData </span>= fadcRun.getFadcData<span style="color: #AE81FF;">(</span>pedestal<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;val&quot;</span>, <span style="color: #66D9EF;">uint16</span><span style="color: #66D9EF;">]</span>.toSeq1D<span style="color: #AE81FF;">)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fromReal </span>= fadcRun.getFadcData<span style="color: #AE81FF;">(</span>pReal<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;val&quot;</span>, <span style="color: #66D9EF;">uint16</span><span style="color: #66D9EF;">]</span>.toSeq1D<span style="color: #AE81FF;">)</span>

      plotCompare<span style="color: #AE81FF;">(</span>fromData, fromReal<span style="color: #AE81FF;">)</span>
      
<span style="color: #F92672;">when</span> <span style="color: #AE81FF;">isMainModule</span>:
  <span style="color: #F92672;">import</span> cligen
  dispatch main
</pre>
</div>

<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>SHOW PLOT OF THE ABOVE (<code>plotCompare</code>) AS EXAMPLE OF BAD
PEDESTALS VS GOOD PEDESTALS?</b>
-&gt; Would be nice for extended thesis!</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec:operation_calibration:scintillators" class="outline-3">
<h3 id="sec:operation_calibration:scintillators"><span class="section-number-3">8.3.</span> Scintillator calibration</h3>
<div id="text-sec:operation_calibration:scintillators" class="outline-text-3">
<p>
The final piece of the detector requiring calibration, are the two
scintillators. As both of them are only used as digital triggers and
no analogue signal information is recorded, a suitable discriminator
threshold voltage has to be set.
</p>
</div>
<div id="outline-container-org49f609b" class="outline-4">
<h4 id="org49f609b"><span class="section-number-4">8.3.1.</span> Large scintillator paddle</h4>
<div id="text-8-3-1" class="outline-text-4">
<p>
The large veto scintillator paddle was calibrated at the RD51
laboratory at CERN prior to the data taking campaign in
March 2017. Using two smaller, calibrated scintillators to create a
coincidence setup of the three scintillators, measurements were taken
at different thresholds. Each measurement was \(\SI{10}{\minute}\) long.
An amplifier was installed after the PMT to increase the signal.
</p>

<p>
The Canberra 2007 base and Bicron Corp. 31.49x15.74M2BC408/2-X PMT
require a positive high voltage. It was supplied with
\(\SI{1200}{V}\). Table <a href="#tab-daq-scintillator_coincidence_measurements">10</a>
shows the recorded measurements. Based on these a threshold of
\(\SI{-110}{mV}\) was chosen for the CAST data
taking. Fig. <a href="#fig:daq:veto_scintillator_coincidence">42</a> also shows the data
from table. While the coincidence counts at \(\SI{-110}{mV}\) are lower
than the visible plateau starting at \(\SI{-100}{mV}\), this threshold
was chosen, because the raw counts were still considered too high
compared to expectation based on cosmic muon rate and the size of the
scintillator. <sup>  <a id="fnr.35" href="#fn.35" class="footref" role="doc-backlink">35</a></sup>
</p>

<table id="tab-daq-scintillator_coincidence_measurements">
<caption class="t-above"><span class="table-number">Table 10:</span> Measurements for the calibration of the large veto scintillator taken at RD51 at CERN with two smaller, calibrated scintillators in a coincidence. Each measurement was \SI{10}{min}. The thresholds set on the discriminator for the veto scintillator were originally measured with a 10x scaling and have been rescaled here to their correct values.</caption>

<colgroup>
<col class="org-right" />

<col class="org-right" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Threshold / mV</th>
<th scope="col" class="org-right">Counts Szinti</th>
<th scope="col" class="org-right">Counts Coincidence</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">-59.8</td>
<td class="org-right">31221</td>
<td class="org-right">634</td>
</tr>

<tr>
<td class="org-right">-70.0</td>
<td class="org-right">30132</td>
<td class="org-right">674</td>
</tr>

<tr>
<td class="org-right">-80.4</td>
<td class="org-right">28893</td>
<td class="org-right">635</td>
</tr>

<tr>
<td class="org-right">-90.3</td>
<td class="org-right">28076</td>
<td class="org-right">644</td>
</tr>

<tr>
<td class="org-right">-100.5</td>
<td class="org-right">27012</td>
<td class="org-right">684</td>
</tr>

<tr>
<td class="org-right">-110.3</td>
<td class="org-right">25259</td>
<td class="org-right">566</td>
</tr>

<tr>
<td class="org-right">-120.0</td>
<td class="org-right">22483</td>
<td class="org-right">495</td>
</tr>

<tr>
<td class="org-right">-130.3</td>
<td class="org-right">19314</td>
<td class="org-right">437</td>
</tr>

<tr>
<td class="org-right">-140.3</td>
<td class="org-right">16392</td>
<td class="org-right">356</td>
</tr>

<tr>
<td class="org-right">-150.5</td>
<td class="org-right">13677</td>
<td class="org-right">312</td>
</tr>

<tr>
<td class="org-right">-160.0</td>
<td class="org-right">11866</td>
<td class="org-right">267</td>
</tr>

<tr>
<td class="org-right">-170.1</td>
<td class="org-right">10008</td>
<td class="org-right">243</td>
</tr>
</tbody>
</table>


<figure id="fig:daq:veto_scintillator_coincidence">
<img alt="veto_scintillator_calibration_coinc_rd51.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/calibration/veto_scintillator_calibration_coinc_rd51.svg" />

<figcaption>Figure 42: <span class="figure-number">Figure 31: </span>Calibration measurements for the veto scintillator printed in table <a href="#tab-daq-scintillator_coincidence_measurements">10</a>. The line is an interconnection of all data points. The errors represent Poisson-like \(\sqrt{N}\) uncertainties.</figcaption>
</figure>
</div>
<div id="outline-container-org8cbf3db" class="outline-5">
<h5 id="org8cbf3db"><span class="section-number-5">8.3.1.1.</span> Generate the plots of the scintillator calibration data   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-8-3-1-1" class="outline-text-5">
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> ggplotnim, sequtils
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;Thr&quot;</span> : tbl<span style="color: #A6E22E;">[</span><span style="color: #E6DB74;">&quot;Threshold / mV&quot;</span><span style="color: #A6E22E;">]</span>,
                <span style="color: #E6DB74;">&quot;Szinti&quot;</span> : tbl<span style="color: #A6E22E;">[</span><span style="color: #E6DB74;">&quot;Counts Szinti&quot;</span><span style="color: #A6E22E;">]</span>,
                <span style="color: #E6DB74;">&quot;Coinc&quot;</span> : tbl<span style="color: #A6E22E;">[</span><span style="color: #E6DB74;">&quot;Counts Coincidence&quot;</span><span style="color: #A6E22E;">]</span> <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;SzintiErr&quot;</span> ~ sqrt<span style="color: #A6E22E;">(</span>`<span style="color: #66D9EF;">Szinti</span>`<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span>,
          f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;CoincErr&quot;</span> ~ sqrt<span style="color: #A6E22E;">(</span>`<span style="color: #66D9EF;">Coinc</span>`<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #E6DB74;">## XXX: `</span><span style="color: #AE81FF;">ebLinesT</span><span style="color: #E6DB74;">` is broken?!  </span>
ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Thr&quot;</span>, <span style="color: #E6DB74;">&quot;Szinti&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_point<span style="color: #AE81FF;">()</span> + geom_line<span style="color: #AE81FF;">()</span> +
  geom_errorbar<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>yMin = f<span style="color: #A6E22E;">{</span>`<span style="color: #66D9EF;">Szinti</span>` - `<span style="color: #66D9EF;">SzintiErr</span>`<span style="color: #A6E22E;">}</span>,
                          yMax = f<span style="color: #A6E22E;">{</span>`<span style="color: #66D9EF;">Szinti</span>` + `<span style="color: #66D9EF;">SzintiErr</span>`<span style="color: #A6E22E;">}</span><span style="color: #66D9EF;">)</span>,
                errorBarKind = ebLines,
                color = parseHex<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;FF00FF&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> + 
  xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Threshold [\si{mV}]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Counts [\#]&quot;</span><span style="color: #AE81FF;">)</span> +
  ggtitle<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Calibration measurements of \SI{10}{min} each&quot;</span><span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/calibration/veto_scintillator_calibration_rd51.pdf&quot;</span>,
         useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>

ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Thr&quot;</span>, <span style="color: #E6DB74;">&quot;Coinc&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_point<span style="color: #AE81FF;">()</span> + geom_line<span style="color: #AE81FF;">()</span> +
  geom_errorbar<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>yMin = f<span style="color: #A6E22E;">{</span>`<span style="color: #66D9EF;">Coinc</span>` - `<span style="color: #66D9EF;">CoincErr</span>`<span style="color: #A6E22E;">}</span>,
                          yMax = f<span style="color: #A6E22E;">{</span>`<span style="color: #66D9EF;">Coinc</span>` + `<span style="color: #66D9EF;">CoincErr</span>`<span style="color: #A6E22E;">}</span><span style="color: #66D9EF;">)</span>,
                errorBarKind = ebLines<span style="color: #AE81FF;">)</span> +   
  xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Threshold [\si{mV}]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Counts [\#]&quot;</span><span style="color: #AE81FF;">)</span> +
  ggtitle<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Calibration measurements of \SI{10}{min} each in 3-way coincidence&quot;</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">600</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/calibration/veto_scintillator_calibration_coinc_rd51.pdf&quot;</span>,
         useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9a2d002" class="outline-5">
<h5 id="org9a2d002"><span class="section-number-5">8.3.1.2.</span> Notes taken of calibration before CAST data taking   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-8-3-1-2" class="outline-text-5">
<p>
See the appendix <a href="./calibration.html#sec:appendix:scintillator_calibration_notes">19.3</a> for a
reproduction of the notes taken during the calibration of the veto
paddle scintillator.
</p>
</div>
</div>
<div id="outline-container-orgd36bcb4" class="outline-5">
<h5 id="orgd36bcb4"><span class="section-number-5">8.3.1.3.</span> Raw scintillator data   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-8-3-1-3" class="outline-text-5">

<figure id="fig:daq:veto_scintillator_raw_counts">
<img alt="veto_scintillator_calibration_rd51.svg" class="org-svg" src="./figs/home/basti/phd/Figs/detector/calibration/veto_scintillator_calibration_rd51.svg" />

<figcaption>Figure 43: <span class="figure-number">Figure 32: </span>Calibration measurements for the veto scintillator printed in table <a href="#tab-daq-scintillator_coincidence_measurements">10</a>. In this case the raw data is shown instead of the coincidence. The line is simply an interconnection of all data points. The errors are colored to be seen at all.</figcaption>
</figure>

<p>
In particular looking at the raw counts, in hindsight I would now
probably choose a threshold closer to \SI{-90}{mV} or
\SI{-95}{mV}. But well.
</p>
</div>
</div>
<div id="outline-container-org31a72cc" class="outline-5">
<h5 id="org31a72cc"><span class="section-number-5">8.3.1.4.</span> Calculate expected rate   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-8-3-1-4" class="outline-text-5">
<p>
Let&apos;s compute the expected rate based on a mean cosmic muon rate at
the surface and the area of the scintillator.
</p>

<ul class="org-ul">
<li class="on"><code>[X]</code> <p>
<b>NOTE: <span class="timestamp-wrapper">  <span class="timestamp">&lt;2023-03-14 Tue 11:49&gt;</span></span></b> The talk about the veto system of
the SDD detector at the IAXO collaboration meeting March 2023 had
the following number for the sea level muon rate:
0.017 Hz•cm⁻²
-&gt; Ah, this is close to ~1 cm⁻²•min⁻¹!
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">rate </span>= <span style="font-style: italic;">0</span>.<span style="font-style: italic;">017</span>.<span style="color: #66D9EF;">Hz</span>•cm⁻²
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Rate in &quot;</span>, rate.toDef<span style="color: #AE81FF;">(</span>min⁻¹•cm⁻²<span style="color: #AE81FF;">)</span>
</pre>
</div></li>
</ul>

<p>
The scintillator has a size of 31.49x15.74 inches and we roughly have
a mean cosmic muon rate of 1 per cm⁻² min⁻¹. Measurement time was 600 s.
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">rate </span>= <span style="font-style: italic;">1</span>.cm⁻²•min⁻¹
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">area </span>= <span style="font-style: italic;">31</span>.<span style="font-style: italic;">49</span>.inch * <span style="font-style: italic;">15</span>.<span style="font-style: italic;">74</span>.inch
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">time </span>= <span style="font-style: italic;">600</span>.s
<span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Expected rate: &quot;</span>, time * rate * area
</pre>
</div>

<p>
So about 32,000 counts in the 10 min time frame. It&apos;s a bit
frustrating that for some reason during that calibration we assumed a
muon rate of 100 Hz m⁻² sr⁻¹, so that we only got an expected number
of counts of about 20,000.
</p>

<p>
If we assume the 100 Hz m⁻² sr⁻¹ number and integrate only over \(θ\)
(not \(φ\) as we should also!) using the \(\cos² θ\) dependence we get a
more comparable number:
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">integral </span>= <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5708</span>.sr <span style="color: #75715E;"># </span><span style="color: #75715E;">∫_{-π/2}^{π/2} cos²(θ) dθ = 1.5708</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">rate </span>= <span style="font-style: italic;">100</span>.<span style="color: #66D9EF;">Hz</span>•m⁻²•sr⁻¹
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">angleInt </span>= <span style="font-style: italic;">2</span>*π
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">time </span>= <span style="font-style: italic;">600</span>.s
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">area </span>= <span style="font-style: italic;">31</span>.<span style="font-style: italic;">49</span>.inch * <span style="font-style: italic;">15</span>.<span style="font-style: italic;">74</span>.inch
<span style="color: #F92672;">echo</span> rate * time * area * integral
</pre>
</div>

<p>
In any case, it seems like our assumption of 20000 as seen in appendix
<a href="./calibration.html#sec:appendix:scintillator_calibration_notes">19.3</a> is clearly flawed and
lead to a possibly too large threshold for the discriminator.
</p>

<p>
In addition: why the hell did I not take note of the size of the
scintillators that Theodoros gave us? That would be a much better
cross check for the expected rate. It is certainly possible that our
choice of \(\SI{-110}{mV}\) was actually due to an expected coincidence
rate matching at that threshold given the sizes of the calibrated
scintillators, but I can&apos;t verify that anymore.
</p>
</div>
</div>
</div>
<div id="outline-container-orgd98383b" class="outline-4">
<h4 id="orgd98383b"><span class="section-number-4">8.3.2.</span> SiPM</h4>
<div id="text-8-3-2" class="outline-text-4">
<p>
The SiPM was calibrated during the bachelor thesis of Jannes Schmitz
in 2016 (<a href="./bibliography.html#citeproc_bib_item_205">Schmitz 2017</a>) based on a coincidence measurement with
calibrated scintillators.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:reconstruction" class="outline-2">
<h2 id="sec:reconstruction"><span class="section-number-2">9.</span> Data reconstruction   <span class="tag">  <span class="Reconstruction">Reconstruction</span></span></h2>
<div id="text-sec:reconstruction" class="outline-text-2">
<p>
We will now go through the general data reconstruction for data taken
with the Septemboard detector. Starting with a short introduction to
the data analysis framework <code>TimepixAnalysis</code> developed for this
thesis, sec. <a href="./reconstruction.html#sec:reco:tpa">9.1</a>. Then we cover the data parsing of the
ASCII based data format produced by TOS (see appendix
<a href="./daq.html#sec:daq:tos_output_format">17.2.1</a> for a description of the data format) in
sec. <a href="./reconstruction.html#sec:reco:tos_data_parsing">9.2</a>. At this point we shortly discuss our
expectation of the data properties recorded with the detector,
sec. <a href="./reconstruction.html#sec:reco:event_shape">9.3</a>, as it motivates the kind of reconstruction
that is performed. From here the explanation of the data
reconstruction starts, sec. <a href="./reconstruction.html#sec:reco:data_reconstruction">9.4</a>, including
cluster finding (sec. <a href="./reconstruction.html#sec:reco:cluster_finding">9.4.1</a>) and calculation of
geometric properties, sec. <a href="./reconstruction.html#sec:reco:cluster_geometry">9.4.2</a>.
</p>

<p>
The FADC data reconstruction follows in section
<a href="./reconstruction.html#sec:reco:fadc_data">9.5</a>. Finally, the scintillators are mentioned in
section <a href="./reconstruction.html#sec:reco:scintillator_data">9.6</a>.
</p>

<p>
There is an additional long section in the appendix
<a href="./software.html#sec:appendix:software">34</a> that goes through the software used for the
data reconstruction intended for people using these tools in the
future. And appendix <a href="./full_data_reconstruction.html#sec:appendix:full_data_reconstruction">35</a> shows how
the full data reconstruction for all CAST data presented in this
thesis is performed.
</p>
</div>
<div id="outline-container-sec:reco:tpa" class="outline-3">
<h3 id="sec:reco:tpa"><span class="section-number-3">9.1.</span> <code>TimepixAnalysis</code> and Nim</h3>
<div id="text-sec:reco:tpa" class="outline-text-3">
<p>
The data reconstruction software handling the processes mentioned in
the remainder of this chapter is the <code>TimepixAnalysis</code> (<a href="./bibliography.html#citeproc_bib_item_202">Schmidt 2022c</a>) <sup>  <a id="fnr.36" href="#fn.36" class="footref" role="doc-backlink">36</a></sup>
framework. It is only a &quot;framework&quot; in a loose sense, as it is a set
of programs to parse data from different Timepix (usually GridPix) DAQ
software packages, process and analyze it. In addition, it contains
a large number of tools to visualize that data as well as analyze
auxiliary data like lists of data taking runs, CAST log files and
more.
</p>

<p>
The entire code base is written in the Nim programming language
(<a href="./bibliography.html#citeproc_bib_item_191">Rumpf 2022</a>) <sup>  <a id="fnr.37" href="#fn.37" class="footref" role="doc-backlink">37</a></sup>. Nim is a statically typed, compiled language
with a Python-like whitespace sensitive syntax, taking inspirations
from Pascal, Modula and in particular ideas regarding type safety from
Ada. Further, it has a strong metaprogramming focus with full access
to its abstract syntax tree (AST) at compile time, offering Lisp-like
macro functionality. This allows to construct powerful and concise
domain specific languages (DSLs). Nim compiles its code by default
first to C code, which can then utilize the decades of compiler
optimization techniques available via GCC (<a href="./bibliography.html#citeproc_bib_item_97">GNU Project 2022</a>) or Clang
(<a href="./bibliography.html#citeproc_bib_item_144">Lattner and Adve 2004</a>), while allowing to target every single platform
supported by C (which effectively means almost all). As such it also
achieves performance on par with C, while providing high-level
features normally associated with languages like Python.
</p>

<p>
Nim was selected as the language of choice for <code>TimepixAnalysis</code>, due
to its combination of concise and clean syntax, high-level features
for productivity, high performance due to native code generation, easy
interfacing with existing C and C++ code bases and its strong
metaprogramming features, which allow to reduce boilerplate code to a
minimum.
</p>

<p>
Appendix <a href="./software.html#sec:appendix:timepix_analysis">34.3</a> contains a detailed overview of the
important tools part of <code>TimepixAnalysis</code> and how they are used for
the context of the data analysis presented in this thesis. Read it if
you wish to understand how to recreate the results presented in this thesis.
</p>
</div>
</div>
<div id="outline-container-sec:reco:tos_data_parsing" class="outline-3">
<h3 id="sec:reco:tos_data_parsing"><span class="section-number-3">9.2.</span> TOS data parsing</h3>
<div id="text-sec:reco:tos_data_parsing" class="outline-text-3">
<p>
The first part of the GridPix data reconstruction is the parsing of
the raw ASCII data files, presented in
<a href="./daq.html#sec:daq:tos_output_format">17.2.1</a>. This is implemented in the
<code>raw_data_manipulation</code> program <sup>  <a id="fnr.38" href="#fn.38" class="footref" role="doc-backlink">38</a></sup>, part of
<code>TimepixAnalysis</code> (<a href="./bibliography.html#citeproc_bib_item_202">Schmidt 2022c</a>). Its main purpose is the
conversion of the inefficient ASCII data format to the more
appropriate and easier to work with HDF5 <sup>  <a id="fnr.39" href="#fn.39" class="footref" role="doc-backlink">39</a></sup> (<a href="./bibliography.html#citeproc_bib_item_223">The HDF Group 1997</a>) format,
a binary file format intended for scientific datasets. While this data
conversion is the main purpose, pixels with <code>ToT</code> or <code>ToA</code> values
outside a user defined range can be filtered out at this
stage <sup>  <a id="fnr.40" href="#fn.40" class="footref" role="doc-backlink">40</a></sup>. Each data taking run is processed
separately and will be represented by one group (similar to a
directory on a file system) in the output HDF5 file. See appendix
section <a href="./software.html#sec:appendix:tos:raw_data_layout">34.3.4.1</a> for an explanation of the
produced data layout.
</p>

<p>
As the data is being processed anyway, at this time we already compute
an occupancy map for each chip in the run. This allows for a quick
glance at the (otherwise unprocessed) data.
</p>
</div>
<div id="outline-container-org1b3a195" class="outline-4">
<h4 id="org1b3a195"><span class="section-number-4">9.2.1.</span> Example of running <code>raw_data_manipulation</code> <code>[0/1]</code>   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-2-1" class="outline-text-4">
<ul class="org-ul">
<li class="off"><code>[ ]</code> GIVE EXAMPLE
-&gt; Need an actual run to work with. Use <code>TPAResources</code>?</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">raw_data_manipulation -p &lt;path&gt; --runType rtBackground --h5out /tmp/run_foo.h5
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:reco:event_shape" class="outline-3">
<h3 id="sec:reco:event_shape"><span class="section-number-3">9.3.</span> Expectation of event shapes</h3>
<div id="text-sec:reco:event_shape" class="outline-text-3">
<p>
Based on the theoretical aspects of a gaseous detector as explained in
chapter <a href="./theory_detector.html#sec:theory_detector">6</a> and the expected kinds of signal sources
at an experiment like CAST (see chapter <a href="./cast.html#sec:cast">10</a>), we can have a good
expectation of the kinds of signals that a GridPix detector records
for different types of events.
</p>

<p>
The signal source we are interested in for an axion helioscope are
soft energy X-rays, below \(\SI{10}{keV}\). The main goal in later
determining a background rate and computing a physics result from data
is to filter out these X-rays from the rest of the data the detector
records. The dominant source of background in any gaseous detector at
surface level is due to cosmic muons.
</p>

<p>
Fortunately, muons and X-rays behave very different in the
detector. X-rays generally produce a single photoelectron, which
creates further primary electrons in a local region. These drift under
transverse diffusion to the readout plane, which effectively gives
them a roughly circular shape. Muons on the other hand produce
electrons (which each produce further local primaries) on a track
along their entire path through the gas volume. Under most angles this
implies their shape is very eccentric, i.e. &apos;track-like&apos;.
</p>

<p>
Two example events, one of a \(\sim\SI{5.9}{keV}\) \cefe X-ray
and the other of a typical muon is shown in
fig. <a href="#fig:reco:example_signal_background_event">44</a>.
</p>


<figure id="fig:reco:example_signal_background_event">
<img alt="gridpix_example_events.svg" class="org-svg" src="./figs/home/basti/phd/Figs/reco/gridpix_example_events.svg" />

<figcaption>Figure 44: <span class="figure-number">Figure 33: </span>Two example events one might see in the detector, left a common background event of a (likely) muon track, which enters the readout plane (hence the slightly triangular shape) and right a classical \(\SI{5.9}{keV}\) X-ray from a \cefe calibration source.</figcaption>
</figure>

<p>
Given the distinct geometric properties of these different types of
events and the fact that a GridPix provides extremely high spatial
resolution and single electron efficiency, the data reconstruction
fully embraces this. Most of the computed properties, which we will
introduce in the next sections, are directly related to geometric
properties of the events.
</p>
</div>
<div id="outline-container-org0ebe7b1" class="outline-4">
<h4 id="org0ebe7b1"><span class="section-number-4">9.3.1.</span> Generate example events for known events   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-3-1" class="outline-text-4">
<p>
While we have two pretty nice events to plot as examples, in
principle, they are generated by <code>karaPlot</code> (an extensive plotting
tool part of TPA) and thus not quite suited to a thesis.
</p>

<p>
As we know the run number and event number, we can just generate them
quickly here. The two events (and plots) are:
</p>
<ul class="org-ul">
<li>  <img alt="background_event_run267_chip3_event1456_region_crAll_hits_200.0_250.0_centerX_4.5_9.5_centerY_4.5_9.5_applyAll_true_numIdxs_100.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/exampleEvents/background_event_run267_chip3_event1456_region_crAll_hits_200.0_250.0_centerX_4.5_9.5_centerY_4.5_9.5_applyAll_true_numIdxs_100.svg" /></li>
<li>  <img alt="calibration_event_run266_chip3_event5791_region_crAll_hits_200.0_250.0_centerX_4.5_9.5_centerY_4.5_9.5_applyAll_true_numIdxs_100.svg" class="org-svg" src="./figs/home/basti/org/Figs/statusAndProgress/exampleEvents/calibration_event_run266_chip3_event5791_region_crAll_hits_200.0_250.0_centerX_4.5_9.5_centerY_4.5_9.5_applyAll_true_numIdxs_100.svg" /></li>
</ul>
<p>
so run 267 and 266, events 1456 and 5791.
</p>

<p>
Ah, I had forgotten that these are not the event numbers, but their
indices of the clusters. Therefore, we&apos;ll just search for pretty
events in the same runs.
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #75715E;"># </span><span style="color: #75715E;">Laptop</span>
<span style="color: #75715E;">#</span><span style="color: #75715E;">const calib = &quot;/mnt/1TB/CAST/2018_2/CalibrationRuns/Run_266_181107-22-14&quot;</span>
<span style="color: #75715E;">#</span><span style="color: #75715E;">const back  = &quot;/mnt/1TB/CAST/2018_2/DataRuns/Run_267_181108-02-05&quot;</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">Desktop</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">All raw files found in `</span><span style="color: #AE81FF;">/mnt/4TB/CAST</span><span style="color: #75715E;">`. The two runs needed here copied to</span>
<span style="color: #F92672;">from</span> std/os <span style="color: #F92672;">import</span> expandTilde
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">calib </span>= <span style="color: #E6DB74;">&quot;~/CastData/data/2018_2/Run_266_181107-22-14&quot;</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">calibration</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">back  </span>= <span style="color: #E6DB74;">&quot;~/CastData/data/2018_2/Run_267_181108-02-05&quot;</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">data</span>

<span style="color: #F92672;">const</span> <span style="color: #FD971F;">cEv </span>= <span style="font-style: italic;">5898</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">bEv </span>= <span style="font-style: italic;">1829</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">this event is nice</span>
<span style="color: #F92672;">import</span> ingrid / tos_helpers
<span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>strformat, os, strutils, sequtils<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> ggplotnim

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">toFile</span><span style="color: #AE81FF;">(</span>i: <span style="color: #66D9EF;">int</span>, path: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">string</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">z </span>= align<span style="color: #AE81FF;">(</span>$i, <span style="font-style: italic;">6</span>, <span style="color: #E6DB74;">&apos;0&apos;</span><span style="color: #AE81FF;">)</span>
  path / &amp;<span style="color: #E6DB74;">&quot;data{z}.txt&quot;</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">drawPlot</span><span style="color: #AE81FF;">()</span> =   
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">protoFiles </span>= readMemFilesIntoBuffer<span style="color: #AE81FF;">(</span>@<span style="color: #66D9EF;">[</span>toFile<span style="color: #A6E22E;">(</span>cEv, calib.expandTilde<span style="color: #A6E22E;">)</span>, toFile<span style="color: #A6E22E;">(</span>bEv, back.expandTilde<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">names </span>= @<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;X-ray&quot;</span>, <span style="color: #E6DB74;">&quot;Background&quot;</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">for</span> <span style="color: #AE81FF;">(</span>pf, name<span style="color: #AE81FF;">)</span> <span style="color: #F92672;">in</span> zip<span style="color: #AE81FF;">(</span>protoFiles, names<span style="color: #AE81FF;">)</span>:
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ev </span>= processEventWithScanf<span style="color: #AE81FF;">(</span>pf<span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">pix </span>= ev.chips<span style="color: #AE81FF;">[</span><span style="font-style: italic;">3</span><span style="color: #AE81FF;">]</span>.pixels
    <span style="color: #F92672;">if</span> pix.<span style="color: #F92672;">len</span> == <span style="font-style: italic;">0</span>: <span style="color: #F92672;">return</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfL </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;x&quot;</span> : pix.mapIt<span style="color: #A6E22E;">(</span>it.x.<span style="color: #66D9EF;">int</span><span style="color: #A6E22E;">)</span>, <span style="color: #E6DB74;">&quot;y&quot;</span> : pix.mapIt<span style="color: #A6E22E;">(</span>it.y.<span style="color: #66D9EF;">int</span><span style="color: #A6E22E;">)</span>,
                     <span style="color: #E6DB74;">&quot;ToT&quot;</span> : pix.mapIt<span style="color: #A6E22E;">(</span>it.ch.<span style="color: #66D9EF;">int</span><span style="color: #A6E22E;">)</span>, <span style="color: #E6DB74;">&quot;type&quot;</span> : name <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    df.<span style="color: #F92672;">add</span> dfL
  <span style="color: #F92672;">echo</span> df
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;y&quot;</span>, color = <span style="color: #E6DB74;">&quot;ToT&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    facet_wrap<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;type&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">()</span> +
    xlim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, <span style="font-style: italic;">256</span><span style="color: #AE81FF;">)</span> + ylim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, <span style="font-style: italic;">256</span><span style="color: #AE81FF;">)</span> +
    <span style="color: #75715E;">#</span><span style="color: #75715E;">theme_font_scale(2.0) +</span>
    <span style="color: #75715E;">#</span><span style="color: #75715E;">margin(left = 3, bottom = 3, right = 5) +</span>
    margin<span style="color: #AE81FF;">(</span>right = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> + 
    <span style="color: #75715E;">#</span><span style="color: #75715E;">facetHeaderText(font = font(12.0, alignKind = taCenter)) +</span>
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;x [Pixel]&quot;</span>, margin = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;y [Pixel]&quot;</span>, margin = <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span> + 
    legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">88</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">9</span>, width = <span style="font-style: italic;">800</span>, height = <span style="font-style: italic;">400</span>, baseTheme = singlePlot<span style="color: #AE81FF;">)</span> + 
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/reco/gridpix_example_events.pdf&quot;</span>, width = <span style="font-style: italic;">800</span>, height = <span style="font-style: italic;">400</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>

drawPlot<span style="color: #AE81FF;">()</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:reco:data_reconstruction" class="outline-3">
<h3 id="sec:reco:data_reconstruction"><span class="section-number-3">9.4.</span> Data reconstruction</h3>
<div id="text-sec:reco:data_reconstruction" class="outline-text-3">
<p>
With the data stored in an HDF5 file after processing the raw data
with <code>raw_data_manipulation</code>, the actual data and event reconstruction
can begin. This is handled by the
<code>reconstruction</code> <sup>  <a id="fnr.41" href="#fn.41" class="footref" role="doc-backlink">41</a></sup> program. It continues from
the HDF5 file created before and proceeds to reconstruct all runs in
the given input file.
</p>

<p>
For each run, each GridPix chip is processed sequentially, while all
events for that chip are then processed in parallel using
multithreading. For each event, the data processing is essentially a
two step process:
</p>
<ol class="org-ol">
<li>perform cluster finding, see section <a href="./reconstruction.html#sec:reco:cluster_finding">9.4.1</a>.</li>
<li>compute geometric properties for each found cluster, see section
<a href="./reconstruction.html#sec:reco:cluster_geometry">9.4.2</a>.</li>
</ol>
</div>
<div id="outline-container-sec:reco:cluster_finding" class="outline-4">
<h4 id="sec:reco:cluster_finding"><span class="section-number-4">9.4.1.</span> Cluster finding</h4>
<div id="text-sec:reco:cluster_finding" class="outline-text-4">
<p>
The cluster finding algorithm splits a single event into possibly
multiple clusters. Clusters are defined based on a certain notion of
distance (the details depend on the clustering algorithm used). The
multiple clusters from a single event are then treated fully equally
for the rest of the analysis. The fact that they originate from the
same event has no further relevance (with a slight exception for one
veto technique, which utilizes clustering over multiple chips, more on
that in section <a href="./background.html#sec:background:septem_veto">12.5.3</a>).
</p>

<p>
There are two different cluster finding algorithms implemented for use
in <code>TimepixAnalysis</code>. The default one is strictly used for the general
cluster finding as part of the reconstruction, the other is intended
to be used for one of the vetoes (again, sec. <a href="./background.html#sec:background:septem_veto">12.5.3</a>). The
choice is user configurable however. <sup>  <a id="fnr.42" href="#fn.42" class="footref" role="doc-backlink">42</a></sup> 
</p>

<dl class="org-dl">
<dt>Default</dt><dd>The default one is the same clustering algorithm
introduced for the data reconstruction of the 2014/15 GridPix
detector in (<a href="./bibliography.html#citeproc_bib_item_65">Christoph Krieger 2018</a>). It defines a cluster by all
pixels within the squares of side length \(N\) centered around each
pixel. It is best thought of as a recursive square neighbor search
around each pixel. For each neighbor in the search square, start
another search square. Once no neighbor finds any neighbors not
already part of the cluster, it is finished.</dd>
<dt>DBSCAN</dt><dd>The secondary clustering algorithm is the
\textbf{D}ensity-\textbf{b}ased \textbf{s}patial \textbf{c}lustering
of \textbf{a}pplications with \textbf{n}oise (DBSCAN)
(<a href="./bibliography.html#citeproc_bib_item_87">Ester et al. 1996</a>) algorithm. In contrast to the default
algorithm it is – as the name implies – a density based
algorithm. This means it distinguishes points which have more
neighbors (high density) from those with few neighbors (low
density). The algorithm has a parameter <code>minSamples</code>, which defines
the density threshold. If a point has at least <code>minSamples</code> neighbors within a
(euclidean) distance of \(ε\) (the second parameter) it is considered
a &quot;core point&quot;. All core points build a cluster with all other
points in their reach. Those points in reach of a core point,
but do itself not have <code>minSamples</code> neighbors are still part of the
cluster. Any point <span class="underline">not</span> in reach of a core point is a &quot;noise
point&quot;. The main advantage of this algorithm over many other more
classical algorithms is the ability to separate clusters close to one
another, which are not separateable by a linear cut. This results in
a more humanly &quot;intuitive&quot; clustering.
DBSCAN is one of the most widely used clustering algorithm in many
scientific fields and even in 2017 was still considered highly
relevant (<a href="./bibliography.html#citeproc_bib_item_207">Schubert et al. 2017</a>).</dd>
</dl>

<p>
Another clustering algorithm (currently not implemented) is CLASSIX
(<a href="./bibliography.html#citeproc_bib_item_63">Chen and Güttel 2022</a>), which promises fast clustering based on sorting along
the first principal component axis. Based on its properties as
presented in its paper it could be an extremely useful algorithm for
our application and should be investigated in the future.
</p>
</div>
<div id="outline-container-org5526242" class="outline-5">
<h5 id="org5526242"><span class="section-number-5">9.4.1.1.</span> CLASSIX clustering algorithm <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-9-4-1-1" class="outline-text-5">
<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>OR SHOULD THIS GO INTO MAIN SECTION BEFORE?</b> OR AS :optional:?</li>
</ul>

<p>
There is one further clustering algorithm, which is extremely exciting
and seems like a great candidate for a clustering algorithm for
<code>TimepixAnalysis</code>. That is the CLASSIX algorithm, introduced as &quot;a
fast and explainable clustering method&quot; (<a href="./bibliography.html#citeproc_bib_item_63">Chen and Güttel 2022</a>).
</p>

<p>
See the GitHub page with many examples here:
<a href="https://github.com/nla-group/classix">https://github.com/nla-group/classix</a>
</p>

<p>
It is an algorithm, which first sorts the data based on the first
principal component in the data. 
</p>
</div>
</div>
<div id="outline-container-org67ba795" class="outline-5">
<h5 id="org67ba795"><span class="section-number-5">9.4.1.2.</span> Clustering bug in MarlinTPC for 2014/15 data   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-9-4-1-2" class="outline-text-5">
<p>
One of the initial goals of <code>TimepixAnalysis</code> was the reproduction of
the background rate computed for the 2014/15 data with the MarlinTPC
framework. While that whole ordeal wasted a lot of time trying to
achieve the exact same results from both frameworks to satisfy other
people, among other things it lead to the discovery of a clustering
bug in MarlinTPC (which was finally the point that let me drop this
pursuit).
</p>

<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>INSERT DISCUSSION FROM STATUSANDPROGRESS ABOUT MARLIN CLUSTER
BUG</b> See section <code>sec:marlin_vs_tpa_output</code> in TPA for the Marlin
clustering bug.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec:reco:cluster_geometry" class="outline-4">
<h4 id="sec:reco:cluster_geometry"><span class="section-number-4">9.4.2.</span> Calculation of geometric properties</h4>
<div id="text-sec:reco:cluster_geometry" class="outline-text-4">
<p>
For each individual cluster the geometric event reconstruction is up
next. As the basic differentiator between X-rays and common background
events is their circularity, most properties are in some sense related
to how eccentric clusters are. Therefore, the first thing to be
computed for each cluster, is the rotation angle <sup>  <a id="fnr.43" href="#fn.43" class="footref" role="doc-backlink">43</a></sup>.
</p>

<p>
The rotation angle is found via a non linear optimization of
</p>

\begin{align*}
  x&apos;_i &amp;= \cos(θ) \left( x_i - \bar{x} \right) · P - \sin(θ) \left( y_i - \bar{y} \right) · P \\
  y&apos;_i &amp;= \sin(θ) \left( x_i - \bar{x} \right) · P + \cos(θ) \left( y_i - \bar{y} \right) · P 
\end{align*}

<p>
where \(θ\) is the rotation angle (in the context of the optimization
the parameter to be fitted), \(x_i, y_i\) the coordinates of the \(i\text{-th}\)
pixel in the cluster, and \(\bar{x}, \bar{y}\) the center coordinates of
the cluster. \(P = \SI{55}{μm}\) is the pixel pitch of a Timepix. The
resulting variables \(x&apos;_i, y&apos;_i\) define a new rotated coordinate
system. From these coordinates, the RMS <sup>  <a id="fnr.44" href="#fn.44" class="footref" role="doc-backlink">44</a></sup> of each of these new axes is
computed via
</p>

\begin{align*}
  x_{\text{RMS}} &amp;= \sqrt{ \frac{1}{N} \left( \sum_i x^{\prime2}_i \right) - \frac{1}{N²} \left( \sum_i x&apos;_i \right)² }\\
  y_{\text{RMS}} &amp;= \sqrt{ \frac{1}{N} \left( \sum_i y^{\prime2}_i \right) - \frac{1}{N²} \left( \sum_i y&apos;_i \right)² }.
\end{align*}


<p>
Based on these we then simply redefine
</p>

\begin{align*}
σ_{\text{transverse}} &amp;= \text{min}(x_{\text{RMS}}, y_{\text{RMS}}) \\
σ_{\text{longitudinal}} &amp;= \text{max}(x_{\text{RMS}}, y_{\text{RMS}}),
\end{align*}

<p>
which then define the eccentricity \(ε\) to (see also fig. <a href="#fig:reco:prop_expl_ecc">45(b)</a>)
</p>

<p>
\[
ε = \frac{σ_{\text{longitudinal}}}{σ_{\text{transverse}}},
\]
</p>

<p>
guaranteeing \(ε \geq 1\).
</p>

<p>
During the non linear optimization, the algorithm attempts to maximize
the eccentricity. In a track like cluster, the maximum eccentricity is
found under the rotation angle \(θ\), which points along the longest
axis of the cluster. The resulting rotated coordinate system after the
fit has converged, is illustrated in fig. <a href="#fig:reco:prop_expl_axes">45(a)</a>.
</p>

<p>
Once the rotation angle and therefore the rotated coordinate system of
a cluster is defined, most other properties follow in a straight
forward fashion. In the rotated coordinate system the axis along the
long axis of the cluster is called &quot;longitudinal&quot; and the short axis
&quot;transverse&quot; in the following. The higher moments skewness and
kurtosis for each axis are computed as well as the length and width of
the cluster based on the biggest spread of pixels along each axis.  In
addition to the geometric properties a few other properties like the
number of pixels are also computed. Three of the most important
variables are illustrated in
fig. <a href="#fig:reco:property_explanations">45</a>. These enter the likelihood
cut definition as we will see in sec. <a href="./background.html#sec:background:likelihood_method">12.1</a>.
</p>


<figure id="fig:reco:property_explanations" class="figure-wrapper">
<figure id="fig:reco:prop_expl_axes" class="subfigure" data-width="49%">  <img src="./figs/home/basti/org/Figs/InGridPropExplanation/long_short_axis.svg" data-width="99%" />  <figcaption>Figure 45(a): Rotated axes</figcaption></figure> <figure id="fig:reco:prop_expl_ecc" class="subfigure" data-width="49%">  <img src="./figs/home/basti/org/Figs/InGridPropExplanation/eccentricity.svg" data-width="99%" />  <figcaption>Figure 45(b): Eccentricity</figcaption></figure> <figure id="fig:reco:prop_expl_fracRms" class="subfigure" data-width="49%">  <img src="./figs/home/basti/org/Figs/InGridPropExplanation/frac_in_trans_rms.svg" data-width="99%" />  <figcaption>Figure 45(c): Fraction in transverse RMS</figcaption></figure> <figure id="fig:reco:prop_expl_ldiv" class="subfigure" data-width="49%">  <img src="./figs/home/basti/org/Figs/InGridPropExplanation/length_div_rms_trans.svg" data-width="99%" />  <figcaption>Figure 45(d): Length divided by transverse RMS</figcaption></figure>
<figcaption>Figure 45: Schematic explanation of the basic cluster reconstruction and the three most 
    important geometric properties. <a href="#fig:reco:prop_expl_axes">45(a)</a> defines the rotated coordinate system found by non-linear optimization of the long and
     short cluster axis. Along the long and short axes, <a href="#fig:reco:prop_expl_ecc">45(b)</a>, the transverse standard deviation $σ_{\text{transverse}}$ is computed, which then defines the eccentricity 
     by this ratio. <a href="#fig:reco:prop_expl_fracRms">45(c)</a> shows the definition of a less obvious variable: the fraction of pixels within a 
     circle of one $σ_{\text{transverse}}$ radius around the cluster center.
     Similarly <a href="#fig:reco:prop_expl_ldiv">45(d)</a> shows the full cluster length defined by the furthest active pixels in the cluster
     divided by $σ_{\text{transverse}}$ as another variable. These three variables enter
     the likelihood cut used for background suppression.</figcaption>
</figure>


<p>
The following is a list of all properties of a single cluster computed
by the <code>reconstruction</code> tool. The <code>ig</code> prefix is due to the internal
naming convention. All but the likelihood, charge and energy
properties are computed during the first pass of the tool, namely in
the context discussed above. <sup>  <a id="fnr.45" href="#fn.45" class="footref" role="doc-backlink">45</a></sup>
</p>

<dl class="org-dl">
<dt>igEventNumber</dt><dd>The event number the cluster is part of (multiple
clusters may share the same event number).</dd>
<dt>igHits</dt><dd>The number of pixels in the cluster.</dd>
<dt>igCenterX / igCenterY</dt><dd>The center position of the cluster along
the <code>x</code> / <code>y</code> axis of the detector.</dd>
<dt>igRotationAngle</dt><dd>The rotation angle of the long axis of the
cluster over the chip coordinate system.</dd>
<dt>igLength</dt><dd>The length of the cluster along the long axis in the 
rotated coordinate system, defined by the furthest pixel at each
end in that direction.</dd>
<dt>igWidth</dt><dd>The equivalent of <b>igLength</b> for the short axis.</dd>
</dl>

<dl class="org-dl">
<dt>igRmsLongitudinal</dt><dd>The root mean square (RMS) along the long axis.</dd>
<dt>igRmsTransverse</dt><dd>The RMS along the short axis.</dd>
<dt>igSkewnessLongitudinal / igKurtosisLongitudinal</dt><dd>The skewness / kurtosis along the long axis.</dd>
<dt>igSkewnessTransverse / igKurtosisTransverse</dt><dd>The skewness / kurtosis along the short axis.</dd>
<dt>igEccentricity</dt><dd>The eccentricity of the cluster, defined by the
ratio of the longitudinal RMS over the transverse RMS.</dd>
<dt>igLengthDivRmsTrans</dt><dd>The length of the cluster divided by the
transverse RMS (see fig. <a href="#fig:reco:prop_expl_ldiv">45(d)</a>).</dd>
<dt>igFractionInTransverseRms</dt><dd>The fraction of all pixels within a
radius of the transverse RMS around the center (see fig. <a href="#fig:reco:prop_expl_fracRms">45(c)</a>).</dd>
</dl>

<dl class="org-dl">
<dt>igTotalCharge</dt><dd>The sum of the charge of the <code>ToT</code> calibrated
charges of all pixels in the cluster (see sec. <a href="./reconstruction.html#sec:reco:data_calibration">9.4.4</a>).</dd>
<dt>igEnergyFromCharge</dt><dd>The calibrated energy of the cluster in
\(\si{keV}\) (see sec. <a href="./calibration.html#sec:calibration:energy">11.1</a>).</dd>
<dt>igLikelihood</dt><dd>The likelihood value of the cluster for the
likelihood cut method, explained in detail in section
<a href="./background.html#sec:background:likelihood_method">12.1</a>.</dd>
</dl>

<p>
After the calculation of all geometric properties for all events and
chips, the data is written to an output HDF5 file (similar in format to
the output of <code>raw_data_manipulation</code>) for each run. This concludes
the first pass of <code>reconstruction</code> over the data. See appendix
section <a href="./software.html#sec:appendix:tos:reco_data_layout">34.3.5.2</a> for an explanation of the
produced data layout.
</p>
</div>
</div>
<div id="outline-container-org16d577c" class="outline-4">
<h4 id="org16d577c"><span class="section-number-4">9.4.3.</span> Example of data reconstruction <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-4-3" class="outline-text-4">
<ul class="org-ul">
<li class="off"><code>[ ]</code> GIVE EXAMPLE</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">reconstruction -i &lt;h5file&gt; --out /tmp/reco_foo.h5
</pre>
</div>
</div>
</div>
<div id="outline-container-sec:reco:data_calibration" class="outline-4">
<h4 id="sec:reco:data_calibration"><span class="section-number-4">9.4.4.</span> Data calibration</h4>
<div id="text-sec:reco:data_calibration" class="outline-text-4">
<p>
The next step of the reconstruction is the data calibration. This is a
separate pass over the data as it is optional on the one hand and
requires further inputs about each used GridPix than just the raw data
(different calibration files) on the other hand.
</p>

<p>
There are different calibrations to be performed:
</p>

<ol class="org-ol">
<li>the charge calibration via the application of the <code>ToT</code> calibration
as introduced in section <a href="./operation_calibration.html#sec:operation_calibration:tot_calibration">8.1.1</a>.</li>
<li>the calculation of the gas gain, introduced previously in section
<a href="./operation_calibration.html#sec:daq:polya_distribution">8.1.2</a> and more in sec. <a href="./calibration.html#sec:calib:gas_gain_time_binning">11.2.3</a>.</li>
<li>the energy calibration (see sec. <a href="./calibration.html#sec:calibration:energy">11.1</a> and
<a href="./calibration.html#sec:calib:final_energy_calibration">11.3</a>).</li>
</ol>

<p>
The <code>ToT</code> calibration is in principle performed simply by converting
each <code>ToT</code> value to an equivalent charge in electrons using the
calibration as presented in section
<a href="./operation_calibration.html#sec:operation_calibration:tot_calibration">8.1.1</a>. For each GridPix used in a
detector, a <code>ToT</code> calibration must be available.
</p>

<p>
<code>TimepixAnalysis</code> comes with a library and helper program, which
manages a simple database about different GridPixes, their
calibrations and their validity (in time and runs they apply to). The
user needs to add the chips for which they wish to perform a <code>ToT</code>
calibration to the database before it can be performed. See appendix
<a href="./software.html#sec:appendix:software:ingrid_database">34.3.10</a> for a detailed overview. For
any chip part of the database, the <code>ToT</code> calibration is a single pass
over the <code>ToT</code> values of all runs. This generates a calibrated charge
for every pixel of every cluster and a combined property, the
<code>totalCharge</code> of the full charge of each cluster.
</p>

<p>
Gas gain values are computed in \(\SI{90}{min}\) time intervals for each
chip. This strikes a good balance between enough statistics and
reduced sensitivity to variation in gas gain due to external
effects. As this deserves its own discussion, more on this in
sec. <a href="./calibration.html#sec:calib:gas_gain_time_binning">11.2.3</a>. 
</p>

<p>
Finally, while the energy calibration is also handled by <code>reconstruction</code>, we
will cover it in section <a href="./calibration.html#sec:calibration">11</a>, due to its more
complex nature.
</p>
</div>
<div id="outline-container-org1139c93" class="outline-5">
<h5 id="org1139c93"><span class="section-number-5">9.4.4.1.</span> Example of data calibration <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h5>
<div id="text-9-4-4-1" class="outline-text-5">
<p>
The following three commands perform the three calibration steps
mentioned above:
</p>
<dl class="org-dl">
<dt>ToT calibration</dt><dd>  <code>--only_charge</code></dd>
<dt>Gas gain calc</dt><dd>  <code>--only_gas_gain</code></dd>
<dt>Energy calibration</dt><dd>  <code>--only_energy_from_e</code></dd>
</dl>
<div class="org-src-container">
<pre class="src src-sh">reconstruction -i &lt;h5file&gt; --only_charge
reconstruction -i &lt;h5file&gt; --only_gas_gain
reconstruction -i &lt;h5file&gt; --only_energy_from_e
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:reco:event_duration" class="outline-4">
<h4 id="sec:reco:event_duration"><span class="section-number-4">9.4.5.</span> Event duration</h4>
<div id="text-sec:reco:event_duration" class="outline-text-4">
<p>
During the reconstruction of the data, another important parameter is
computed, namely the event duration of each individual event. In
principle each event has a fixed length, because the Timepix uses a
shutter based readout, with the shutter length predefined. However, as
the FADC is used as an external trigger to close the shutter early, if
it recorded a signal, all events with an FADC trigger have a shorter
duration.
</p>

<p>
For the fixed length duration events their length is computed by the
shutter length as indicated in TOS. In appendix
<a href="./daq.html#sec:daq:tos_output_format">17.2.1</a>, listing
<a href="code:daq:zero_suppressed_readout_run_header">2</a> the <code>shutterTime</code> and
<code>shutterMode</code> fields are listed. These define the absolute length of
the shutter opening in (effectively) number of clock cycles. The
<code>shutterMode</code> acts as a modifier to the number of clock cycles:
</p>

<p>
\[
t_{\text{clocks}}(\mathtt{mode}, t) = 256^{\mathtt{mode}} · t
\]
</p>

<p>
where \(t\) is the <code>shutterTime</code> and \(\mathtt{mode}\) corresponds to the
<code>shutterMode</code>. The available modes are:
</p>
<ul class="org-ul">
<li><code>short</code>: \num{0}</li>
<li><code>long</code>: \num{1}</li>
<li><code>verylong</code>: \num{2}</li>
</ul>

<p>
In case of the FADC triggering, the clock cycles after shutter opening
that were recorded up to the trigger is also reported in the data
files, see appendix sec. <a href="./daq.html#sec:daq:tos_output_format">17.2.1</a>, listing
<a href="code:daq:zero_suppressed_readout_event_header">3</a>. With the number of
clock cycles the shutter was open, the total event duration can then
be computed in either case via:
</p>

<p>
\[
d(t_{\text{clocks}}) = \frac{t_{\text{clocks}} · 46}{40 · \num{1000000}}.
\]
</p>
</div>
</div>
</div>
<div id="outline-container-sec:reco:fadc_data" class="outline-3">
<h3 id="sec:reco:fadc_data"><span class="section-number-3">9.5.</span> FADC reconstruction</h3>
<div id="text-sec:reco:fadc_data" class="outline-text-3">
<p>
The data files created from the FADC data sent upon a trigger are
essentially memory snapshots of the circular register of the FADC. We
will go through the necessary steps to convert that raw data into
usable signals, given the FADC settings we use and the data TOS
generates from it. See appendix sec. <a href="./daq.html#sec:daq:fadc_data_files">17.2.1.1</a> for an
overview of the raw FADC data files. For a detailed overview of the
FADC readout process see the FADC manual
(<a href="./bibliography.html#citeproc_bib_item_58">CAEN 2010</a>) <sup>  <a id="fnr.46" href="#fn.46" class="footref" role="doc-backlink">46</a></sup>.
</p>

<p>
In <code>TimepixAnalysis</code> FADC data is automatically parsed from the ASCII
data files into HDF5 files as part of <code>raw_data_manipulation</code> if FADC
files are present. The spectrum reconstruction is done automatically
as part of the <code>reconstruction</code> program, but calculation of the
baseline, rise and fall time is an optional step.
</p>
</div>
<div id="outline-container-sec:reco:fadc_pedestal_calc" class="outline-4">
<h4 id="sec:reco:fadc_pedestal_calc"><span class="section-number-4">9.5.1.</span> FADC pedestal calculation</h4>
<div id="text-sec:reco:fadc_pedestal_calc" class="outline-text-4">
<p>
As alluded to in sec. <a href="./operation_calibration.html#sec:operation_calibration:fadc">8.2</a> the pedestal
values cannot only be taken from a pedestal run recorded before data
taking, but can also be extracted from real data, under the condition
that a decent fraction of FADC registers in a single FADC event is on
the baseline and normally distributed between events.
</p>

<p>
The idea is to look at an ensemble of values for each register taken
from different events and remove all those events in each register, in
which it was involved in a real signal. Due to the cyclic nature of
the FADC registers, different registers will capture signals in each
event. At least in typical signals recorded with a GridPix the signal
lengths are \(\mathcal{O}(\SI{10}{\percent})\) of the window length,
leaving plenty of registers free to recover pedestal
information. Regular noise affects things, but is partially taken care
by the truncation and partially cancels out as real noise is normal
distributed around the actual pedestal. This latter approach is the
one used in the data analysis by calculating:
</p>

\begin{equation}
\label{fig:reco:fadc_pedestals_trunc_mean}
p_i(r) = \text{mean}_{20^{\text{th}}}^{98^{\text{th}}}(\{r_i\})
\end{equation}

<p>
where \(p_i(r)\) is the pedestal in register \(r_i\) and the mean is taken
over all data \(\{r_i\}\) in that register within the 20-th and
98-th percentile. All data refers to a full data run of
\(\sim\SI{1}{day}\). The highly biased nature is due to the real
signals being negative. Removing the smallest \(\SI{20}{\percent}\) of
data guarantees in the vast majority of events the full physical
signal is excluded given the typical signal lengths involved. A
small upper percentile is used to exclude possible significant
outliers to the top. While such a biased estimator will not result in
the real mean (and in case of signal and noise free input data thus
the real pedestals), a slight bias is irrelevant, as the baseline is
still calculated for each reconstructed signal which is used to
correct any global offset. 
</p>
</div>
</div>
<div id="outline-container-org4822218" class="outline-4">
<h4 id="org4822218"><span class="section-number-4">9.5.2.</span> FADC spectrum reconstruction</h4>
<div id="text-9-5-2" class="outline-text-4">
<p>
The first step to reconstruct the FADC signals, is to perform the pedestal
correction. This is simply done by subtracting the pedestals register
by register from the data file
</p>

<p>
\[
N_{i, \text{corr}} = N_{i, \text{raw}} - N_{i, \text{pedestal}}
\]
</p>

<p>
with the raw data \(N_{i, \text{raw}}\) and the pedestals \(N_{i,
\text{pedestal}}\) in register \(i\) (as computed according to
eq. \eqref{fig:reco:fadc_pedestals_trunc_mean}).
</p>

<p>
With the pedestals removed, the temporal correction is next to unfold
the data into the correct order. This needs to be performed on each of
the \(\num{2560}\) registers for each channel separately. The temporal
rotation is performed by shifting all registers by
</p>

<p>
\[
n_\text{rot} = (\mathtt{TRIG\_REC} - \mathtt{POSTTRIG}) · 20
\]
</p>

<p>
places to the left. The constants \(\mathtt{TRIG\_REC}\) and
\(\mathtt{POSTTRIG}\) are from appendix section <a href="./daq.html#sec:daq:fadc_data_files">17.2.1.1</a>,
written in each data file in the header.
</p>

<p>
The final step is to convert the ADC values of each register into
voltages in \(\si{V}\). Given that the ADC covers the range of
\(\SIrange{-1}{1}{V}\) as the ADC values 0 to 4096 (16384) with 12 (14)
bit <sup>  <a id="fnr.47" href="#fn.47" class="footref" role="doc-backlink">47</a></sup>, this means the conversion from ADC to volts is simply
</p>

<p>
\[
U_i = \frac{N_{i, \text{corr}} - 2048}{2048}
\]
</p>

<p>
when using the 12 bit operating mode for each register.
</p>

<p>
With these corrections applied, the recorded FADC spectrum is
recovered, centered around the trigger position.
</p>
</div>
</div>
<div id="outline-container-sec:fadc:definition_baseline_rise_fall_time" class="outline-4">
<h4 id="sec:fadc:definition_baseline_rise_fall_time"><span class="section-number-4">9.5.3.</span> Signal baseline, rise time and fall time</h4>
<div id="text-sec:fadc:definition_baseline_rise_fall_time" class="outline-text-4">
<p>
Assuming a singular event is recorded with the FADC, the main
properties of interest of the resulting signal pulse are the signal
baseline and based on that the rise and fall time.
</p>

<p>
Computing the position of the baseline is generally a non trivial
problem, as a priori the position, width and number of signals in the
spectrum is unknown. A reasonable expectation though is that the
majority of points in a signal should lie close to the baseline, as
the fraction of the FADC window covered by a signal is typically less
than a quarter. As such a somewhat empirical way to compute the
baseline \(B\) was chosen using a biased truncated mean 
</p>

<p>
\[
B = \text{mean}_{30^{\text{th}}}^{95^{\text{th}}}(S)  %\text{median}(S) + 0.1 · \max(S)
\]
</p>

<p>
between the \(30^{\text{th}}\) and \(95^{\text{th}}\) percentile of the
data. The bias is intended to remove the impact of the negative signal
amplitude and remove the worst positive outliers. An optimal solution
would perform a rigorous peak finding for a signal pulse, remove those
points and compute the mean of the remainder of the
points. <sup>  <a id="fnr.48" href="#fn.48" class="footref" role="doc-backlink">48</a></sup>
</p>

<p>
Once the baseline is defined it can be used to determine both the rise
and the fall time. These are generally computed based on the number of
registers between the minimum of the signal and some threshold
slightly below the baseline (compare with
fig. <a href="#fig:reco:fadc_reco_example">46</a>) in order to reduce the effect of
local noise variations. While configurable, the default value of the
threshold \(c_B\) (\(B\) for baseline) is
</p>

<p>
\[
c_B = B - 0.1 · \left| B - \text{min}(S)\right|,
\]
</p>

<p>
\(\SI{10}{\%}\) of the difference between the baseline \(B\) and the
minimum value of the spectrum \(S\) from the baseline. Similarly, for the
end of the rise time / beginning of the fall time a similar offset is
used. In this case the threshold value \(c_P\) (\(P\) for peak) is defined
as
</p>

<p>
\[
c_P = \text{min}(S) + 0.025 · \left| B - \text{min}(S)\right|,
\]
</p>

<p>
so \(\SI{2.5}{\%}\) of the amplitude above the minimum of the signal
\(S\). The position where either threshold is crossed in registers is
based on where the <span class="underline">simple moving average</span> (of window size 5) crosses
\(c_B\) and \(c_P\). The number of registers between \(c_B\) and \(c_P\)
defines the rise time (left of the peak) and fall time (right of the
peak). <sup>  <a id="fnr.49" href="#fn.49" class="footref" role="doc-backlink">49</a></sup> At the used clock frequency of
\(\SI{1}{GHz}\) each register corresponds to \(\SI{1}{ns}\) in time.
</p>

<p>
A reconstructed FADC spectrum including indications for baseline, rise
and fall time as well as the minimum is shown in
fig. <a href="#fig:reco:fadc_reco_example">46</a> <sup>  <a id="fnr.50" href="#fn.50" class="footref" role="doc-backlink">50</a></sup>, together with the
corresponding event on the Septemboard.
</p>


<figure id="fig:reco:fadc_reco_example">
<img alt="septem_fadc_run_239_event_1068_region_crAll.svg" class="org-svg" src="./figs/home/basti/phd/Figs/CalibrationRuns2018_Reco_2023-10-15_22-49-53/septemEvents/septem_fadc_run_239_event_1068_region_crAll.svg" />

<figcaption>Figure 46: <span class="figure-number">Figure 34: </span>Example of a fully reconstructed InGrid event and FADC spectrum from a \SI{5.9}{keV} X-ray recorded with the Septemboard detector during a calibration run. On the left of each plot are all properties computed for the data. In the FADC plot the blue line indicates the baseline. Green vertical: rise time from full to dashed line. Red vertical: point of spectrum minimum. Light red: fall time from dashed to full line. Rise / fall time stops \(\SI{2.5}{\%}\) before baseline is reached.</figcaption>
</figure>
</div>
</div>
<div id="outline-container-orgb641423" class="outline-4">
<h4 id="orgb641423"><span class="section-number-4">9.5.4.</span> Generate the FADC baseline plot <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-5-4" class="outline-text-4">
<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>GENERATE THE PLOT CURRENTLY USED IN THE ABOVE BODY HERE</b>
-&gt; The current version comes from the TPA test suite!</li>
</ul>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> nimhdf5, ggplotnim
<span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>strutils, os, sequtils<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> ingrid / <span style="color: #AE81FF;">[</span>tos_helpers, fadc_helpers, ingrid_types, fadc_analysis<span style="color: #AE81FF;">]</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">stripPrefix</span><span style="color: #AE81FF;">(</span>s, p: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">string</span> =
  <span style="color: #FD971F;">result</span> = s
  <span style="color: #FD971F;">result</span>.removePrefix<span style="color: #AE81FF;">(</span>p<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotIdx</span><span style="color: #AE81FF;">(</span>df: <span style="color: #66D9EF;">DataFrame</span>, fadcData: <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span>, runNumber, idx: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xmin </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;xmin&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xminY </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;minvals&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xminlineX </span>= @<span style="color: #AE81FF;">[</span>xmin, xmin<span style="color: #AE81FF;">]</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">one point for x of min, max</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fData </span>= fadcData<span style="color: #AE81FF;">[</span>idx, _<span style="color: #AE81FF;">]</span>.squeeze
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xminlineY </span>= linspace<span style="color: #AE81FF;">(</span>fData.<span style="color: #F92672;">min</span>, fData.<span style="color: #F92672;">max</span>, <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>

  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">riseStart </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;riseStart&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fallStop </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;fallStop&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">riseStartX </span>= @<span style="color: #AE81FF;">[</span>riseStart, riseStart<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fallStopX </span>= @<span style="color: #AE81FF;">[</span>fallStop, fallStop<span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">baseline </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;baseline&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">][</span>idx<span style="color: #AE81FF;">]</span>  
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">baselineY </span>= @<span style="color: #AE81FF;">[</span>baseline, baseline<span style="color: #AE81FF;">]</span>
  
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfLoc </span>= toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span> <span style="color: #E6DB74;">&quot;x&quot;</span>         : toSeq<span style="color: #A6E22E;">(</span><span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">2560</span><span style="color: #A6E22E;">)</span>,
                     <span style="color: #E6DB74;">&quot;baseline&quot;</span>  : baseline,
                     <span style="color: #E6DB74;">&quot;data&quot;</span>      : fData,
                     <span style="color: #E6DB74;">&quot;xminX&quot;</span>     : xminlineX, 
                     <span style="color: #E6DB74;">&quot;xminY&quot;</span>     : xminlineY,
                     <span style="color: #E6DB74;">&quot;riseStart&quot;</span> : riseStartX,
                     <span style="color: #E6DB74;">&quot;fallStop&quot;</span>  : fallStopX <span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
                     <span style="color: #75715E;"># </span><span style="color: #75715E;">Comparison has to be done by hand unfortunately</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/t/fadc_spectrum_baseline_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.pdf&quot;</span> % $idx
  ggplot<span style="color: #AE81FF;">(</span>dfLoc, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;data&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">()</span> +
    geom_point<span style="color: #AE81FF;">(</span>color = color<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;baseline&quot;</span><span style="color: #66D9EF;">)</span>,
              color = <span style="color: #E6DB74;">&quot;blue&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>data = dfLoc.head<span style="color: #66D9EF;">(</span><span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;xminX&quot;</span>, <span style="color: #E6DB74;">&quot;xminY&quot;</span><span style="color: #66D9EF;">)</span>,
                     color = <span style="color: #E6DB74;">&quot;red&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>data = dfLoc.head<span style="color: #66D9EF;">(</span><span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;riseStart&quot;</span>, <span style="color: #E6DB74;">&quot;xminY&quot;</span><span style="color: #66D9EF;">)</span>,
                     color = <span style="color: #E6DB74;">&quot;green&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_line<span style="color: #AE81FF;">(</span>data = dfLoc.head<span style="color: #66D9EF;">(</span><span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;fallStop&quot;</span>, <span style="color: #E6DB74;">&quot;xminY&quot;</span><span style="color: #66D9EF;">)</span>,
                     color = <span style="color: #E6DB74;">&quot;pink&quot;</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;FADC spectrum of run </span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;"> and index </span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">&quot;</span> % <span style="color: #66D9EF;">[</span>$runNumber, $idx<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> +
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;FADC Register&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;FADC signal voltage U [V]&quot;</span><span style="color: #AE81FF;">)</span> + 
    ggsave<span style="color: #AE81FF;">(</span>path<span style="color: #AE81FF;">)</span>
  copyFile<span style="color: #AE81FF;">(</span>path, <span style="color: #E6DB74;">&quot;/t/fadc_spectrum_baseline.pdf&quot;</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">toDf</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">U</span>: <span style="color: #F92672;">object</span><span style="color: #AE81FF;">](</span>x: <span style="color: #66D9EF;">U</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DataFrame</span> =
  <span style="color: #FD971F;">result</span> = newDataFrame<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">for</span> field, val <span style="color: #F92672;">in</span> <span style="color: #F92672;">fieldPairs</span><span style="color: #AE81FF;">(</span>x<span style="color: #AE81FF;">)</span>:
    <span style="color: #F92672;">type</span> <span style="color: #66D9EF;">T</span> = typeof<span style="color: #AE81FF;">(</span>val<span style="color: #66D9EF;">[</span><span style="font-style: italic;">0</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> 
    <span style="color: #F92672;">when</span> <span style="color: #66D9EF;">T</span> <span style="color: #F92672;">isnot</span> <span style="color: #66D9EF;">int</span> <span style="color: #F92672;">and</span> <span style="color: #66D9EF;">T</span> <span style="color: #F92672; font-style: italic;">is</span> <span style="color: #66D9EF;">SomeInteger</span>:
      <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>field<span style="color: #AE81FF;">]</span> = val.asType<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">elif</span> <span style="color: #66D9EF;">T</span> <span style="color: #F92672;">isnot</span> <span style="color: #66D9EF;">float</span> <span style="color: #F92672;">and</span> <span style="color: #66D9EF;">T</span> <span style="color: #F92672; font-style: italic;">is</span> <span style="color: #66D9EF;">SomeFloat</span>:
      <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>field<span style="color: #AE81FF;">]</span> = val.asType<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">else</span>:
      <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>field<span style="color: #AE81FF;">]</span> = val

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">plotFadc</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>, runNumber, sleep: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">run </span>= h5f.readRecoFadcRun<span style="color: #AE81FF;">(</span>runNumber<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">data </span>= h5f.readRecoFadc<span style="color: #AE81FF;">(</span>runNumber<span style="color: #AE81FF;">)</span>  
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= data.toDf<span style="color: #AE81FF;">()</span>
  df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;minvals&quot;</span><span style="color: #AE81FF;">]</span> = run.minvals
  <span style="color: #F92672;">for</span> idx <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; df.<span style="color: #F92672;">len</span>:
    plotIdx<span style="color: #AE81FF;">(</span>df, run.fadc_data, runNumber, idx<span style="color: #AE81FF;">)</span>
    sleep<span style="color: #AE81FF;">(</span>sleep<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">main</span><span style="color: #AE81FF;">(</span>fname: <span style="color: #66D9EF;">string</span>, runNumber: <span style="color: #66D9EF;">int</span>, sleep = <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>fname, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fileInfo </span>= h5f.getFileInfo<span style="color: #AE81FF;">()</span>
  <span style="color: #F92672;">for</span> run <span style="color: #F92672;">in</span> fileInfo.runs:
    <span style="color: #F92672;">if</span> run == runNumber:
      plotFadc<span style="color: #AE81FF;">(</span>h5f, run, sleep<span style="color: #AE81FF;">)</span>
      
<span style="color: #F92672;">when</span> <span style="color: #AE81FF;">isMainModule</span>:
  <span style="color: #F92672;">import</span> cligen
  dispatch main
</pre>
</div>

<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>MAKE PLOT PRETTY AND RERUN FOR THIS:</b>
run 281 and index 1533</li>
</ul>
</div>
</div>
<div id="outline-container-org0eac301" class="outline-4">
<h4 id="org0eac301"><span class="section-number-4">9.5.5.</span> Generate plot of InGrid and FADC event   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-5-5" class="outline-text-4">
<p>
The command to produce the plot as seen in the thesis is:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">W1</span>=825 <span style="color: #FD971F;">W2</span>=675 <span style="color: #FD971F;">G_LEFT</span>=0.65 <span style="color: #FD971F;">F_LEFT</span>=0.3 <span style="color: #FD971F;">L_MARGIN</span>=10 <span style="color: #FD971F;">R_MARGIN</span>=4 <span style="color: #FD971F;">USE_TEX</span>=true <span style="color: #FD971F;">SCALE</span>=1.3 plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
       --h5file ~/CastData/data/CalibrationRuns2018_Reco.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
       --runType=rtCalibration <span style="color: #E6DB74; font-weight: bold;">\</span>
       --eventDisplay --septemboard <span style="color: #E6DB74; font-weight: bold;">\</span>
       --events 1068 --runs 239
</pre>
</div>
<p>
The parameters used here are the default now outside the
<code>USE_TEX=true</code> and <code>SCALE=1.3</code>.
</p>

<p>
The resulting plot needs to be copied over to the <code>phd</code> repository
manually, as <code>plotData</code> currently does not support outputting a plot
to a specific file name (it&apos;s intended to produce many plots
automatically and act more as a fast way to visualize data under
different cuts).
</p>
</div>
</div>
<div id="outline-container-org838c546" class="outline-4">
<h4 id="org838c546"><span class="section-number-4">9.5.6.</span> Noise sensitive   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-5-6" class="outline-text-4">
<p>
Because of the small amplitude of the associated signals induced on
the grid, electromagnetic interference is a serious issue with this
FADC setup. Ideally, the detector should be installed in a Faraday
cage and a short, shielded LEMO cable should be used to connect it to
the pre-amplifier and amplifier.
</p>
</div>
</div>
<div id="outline-container-org119bcbb" class="outline-4">
<h4 id="org119bcbb"><span class="section-number-4">9.5.7.</span> FADC amplifier settings   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-5-7" class="outline-text-4">
<p>
The FADC does not require a proper calibration in the same sense as
the Timepix needs to be calibrated. However, the amplifier settings
have a large impact on the resulting signals. Better measurements of
the effect of the different integration / differentiation settings of
the amplifier would have been very valuable, but were never performed
for lack of time. The same holds for different amplifications as to
properly understand the data ranges the FADC can record and how the
trigger threshold in equivalent \(\si{keV}\) on the center GridPix is
related. This would have made smarter decisions about the settings
possible (e.g. to optimize the lowest possible activation to have the
FADC as a trigger for lower energies available). Only a single set of
measurements exists comparing the FADC integration time of
\(\SI{50}{ns}\) and \(\SI{100}{ns}\), which is only partially useful (in
particular because the other parameters (differentiation time,
amplification etc.) were not properly recorded for these. The problem
is especially that the TOS data does not record these parameters
anyway, as they are physical rotary knobs on the amplifier.
</p>

<p>
We will talk about these things in sec. <a href="./calibration.html#sec:calib:fadc">11.4</a> again when
discussing the impact of noise on the FADC data taking and changing
parameters that were done to mitigate that to an extent.
</p>
</div>
</div>
<div id="outline-container-org29fae1e" class="outline-4">
<h4 id="org29fae1e"><span class="section-number-4">9.5.8.</span> Example to reconstruct FADC data   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-9-5-8" class="outline-text-4">
<p>
As mentioned in the beginning of sec. <a href="./reconstruction.html#sec:reco:fadc_data">9.5</a>
reconstruction is done as part of <code>raw_data_manipulation</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">raw_data_manipulation -p &lt;run path&gt; --runType rtBackground --h5out /tmp/run_foo.h5
</pre>
</div>

<p>
In <code>reconstruction</code>:
</p>
<div class="org-src-container">
<pre class="src src-sh">reconstruction -i &lt;h5file&gt; --only_fadc
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec:reco:scintillator_data" class="outline-3">
<h3 id="sec:reco:scintillator_data"><span class="section-number-3">9.6.</span> Scintillator data</h3>
<div id="text-sec:reco:scintillator_data" class="outline-text-3">
<p>
For the scintillator signals we only record a trigger flag and the
number of clock cycles since the last scintillator trigger from the
moment the FADC triggered. These two pieces of information are part of
the Septemboard data files included in the
header. <sup>  <a id="fnr.51" href="#fn.51" class="footref" role="doc-backlink">51</a></sup> <sup>, </sup><sup>  <a id="fnr.52" href="#fn.52" class="footref" role="doc-backlink">52</a></sup>
</p>
</div>
</div>
</div>
<div id="outline-container-sec:cast" class="outline-2">
<h2 id="sec:cast"><span class="section-number-2">10.</span> Detector installation &amp; data taking at CAST   <span class="tag">  <span class="CAST">CAST</span></span></h2>
<div id="text-sec:cast" class="outline-text-2">
<p>
In this chapter we will cover the data taking with the Septemboard
detector at the CAST experiment. We will begin with a timeline of the
important events and the different data taking periods to give some
reference and put certain things into perspective,
sec. <a href="./cast.html#sec:cast:timeline">10.1</a>. We continue with the detector alignment in
sec. <a href="./cast.html#sec:cast:alignment">10.2</a>, as this is important for the position
uncertainty in the limit calculation. Then we discuss the detector
setup behind the LLNL telescope, sec. <a href="sec:cast:detector_setup">10.3</a>. Two
sections follow focusing on where things did not go according to our
plans, a window accident in sec. <a href="sec:cast:window_accident">10.4</a> and general
issues encountered in each run period in
sec. <a href="sec:cast:data_taking_woes">10.5</a>. We conclude with an overview of the
of the total data taken at CAST, sec. <a href="sec:cast:data_taking_campaigns">10.6</a>.
</p>

<p>
For an overview of the technical aspects of the CAST setup and
operation see the appendix <a href="./cast_operations.html#sec:appendix:cast_operations">20</a>. It contains
details about the operating procedures with respect to the gas supply
and vacuum system, interlocks and more. As the details of that are not
particularly relevant after shutdown of the experiment, it is not
discussed here.
</p>
</div>
<div id="outline-container-sec:cast:timeline" class="outline-3">
<h3 id="sec:cast:timeline"><span class="section-number-3">10.1.</span> Timeline</h3>
<div id="text-sec:cast:timeline" class="outline-text-3">
<p>
The Septemboard detector was prepared for data taking at the CAST
experiment in July 2017 for preliminary alignment and fit tests. The
detector beamline was prepared behind the LLNL telescope and aligned
with a laser from the opposite side of the magnet using an acrylic
glass target on <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-07-07 Fri&gt; </span></span> (see
fig. <a href="#fig:cast:laser_alignment1">47(a)</a>). Vacuum leak tests were performed
and the detector installed on <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-07-10 Mon&gt; </span></span> (see
fig. <a href="#fig:cast:detector_installed">47(b)</a>). In addition, geometer
measurements were done for final alignment and as a reference
measurement the day after. An Amptek COOL-X X-ray
generator <sup>  <a id="fnr.53" href="#fn.53" class="footref" role="doc-backlink">53</a></sup> (&apos;X-ray finger&apos;) was installed on the opposite
side of the magnet. A calibration measurement with the X-ray finger
ran from <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-07-13 Thu&gt; </span></span> over night. The aim of an X-ray finger run is to
roughly verify the focal spot of the X-ray telescope. After this
initial test the detector was dismounted to make space for the KWISP
experiment.
</p>

<p>
Two months later the detector was remounted between <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-09-11 Mon&gt;</span></span>
to <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-09-14 Thu&gt; </span></span> with another geometer measurement on the last
day. During an attempt to clean the detector water cooling system on
<span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-09-19 Tue&gt;</span></span>, the window of the detector was destroyed (see section
<a href="sec:cast:window_accident">10.4</a>). This required a detector dismount and
transport to Bonn for repairs as the detector was electronically dead
after the incident.
</p>

<p>
Near the end of October <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-10-23 Mon&gt; </span></span> the remount of the detector
started and was finished by <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-10-26 Thu&gt; </span></span> in time for another geometer
measurement and alignment. The next day the veto paddle scintillator
was calibrated using a 3-way coincidence in the RD51 laboratory (see
sec. <a href="./operation_calibration.html#sec:operation_calibration:scintillators">8.3</a>), followed by the installation
of the lead shielding and scintillator installation another day
later. With everything ready, data taking of the first data taking
period with the Septemboard detector started on <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-10-30 Mon&gt;</span></span>. During
the period until <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-12-22 Fri&gt; </span></span> few minor issues were encountered, see
sec. <a href="sec:cast:data_taking_woes_2017">10.5.1</a>. As CERN is typically closed over
Christmas and well into January, data taking was paused until
<span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-02-17 Fri&gt; </span></span> (further time is necessary to prepare the magnet for data
taking again).
</p>

<p>
The second part of the first data taking then continued on until
<span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-04-17 Mon&gt;</span></span>, with a few more small problems encountered, see
<a href="sec:cast:data_taking_woes_2018">10.5.2</a>. After data taking concluded,
dismounting of the detector began the next day by removing the veto
scintillator and the lead shielding. On <span class="timestamp-wrapper">  <span class="timestamp">&lt;2018-04-20 Fri&gt; </span></span> another X-ray
finger run was performed to get a sense of the placement of the
detector during its actual mount as it was during the first data
taking period. Afterwards, the detector was fully removed by
<span class="timestamp-wrapper">  <span class="timestamp">&lt;2018-04-26 Thu&gt; </span></span> to bring it back to Bonn to fix a few problems.
</p>

<p>
Data taking was initially intended to continue by summer of 2018. The
fully repaired detector was installed between <span class="timestamp-wrapper">  <span class="timestamp">&lt;2018-07-16 Mon&gt; </span></span> and
<span class="timestamp-wrapper">  <span class="timestamp">&lt;2018-07-19 Thu&gt; </span></span> with a few minor delays due to a change in mounting of
the lead shielding support to accommodate a parallel data taking with
KWISP. For alignment another geometer measurement was performed on
<span class="timestamp-wrapper">  <span class="timestamp">&lt;2018-07-23 Mon&gt;</span></span>. Unfortunately, external delays pushed the begin of the
data taking campaign back into late October. On <span class="timestamp-wrapper">  <span class="timestamp">&lt;2018-10-20 Sat&gt; </span></span> the data
taking finally begins after a power supply issue was fixed the day
before. The issues encountered during this data taking period, which
lasted until <span class="timestamp-wrapper">  <span class="timestamp">&lt;2018-12-20 Thu&gt; </span></span> are mentioned in
sec. <a href="sec:cast:data_taking_woes_2018_2">10.5.3</a>.
</p>

<p>
With the end of 2018 the data taking campaign of the Septemboard was
at an end. The detector was moved over from CAST to the CAST Detector
Lab (CDL) on <span class="timestamp-wrapper">  <span class="timestamp">&lt;2019-02-14 Thu&gt; </span></span> for a measurement campaign behind an X-ray
tube for calibration purposes. Data was taken until <span class="timestamp-wrapper">  <span class="timestamp">&lt;2019-02-21 Thu&gt; </span></span> with
a variety of targets and filters (covered in sec. <a href="./background.html#sec:cdl">12.2</a>
later). Afterwards the detector was dismounted and taken back to Bonn.
</p>

<p>
For the results of the different alignments, further see section
<a href="./cast.html#sec:cast:alignment">10.2</a>.
</p>


<figure id="fig:cast:alignment_detector" class="figure-wrapper">
<figure id="fig:cast:laser_alignment1" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/CAST_Alignment/laser_alignment_IMG_20170707_121738.jpg" data-width="94%" />  <figcaption>Figure 47(a): Laser alignment</figcaption></figure> <figure id="fig:cast:detector_installed" class="subfigure" data-width="49%">  <img src="./figs/home/basti/org/Figs/CAST_Alignment/detector_installed_after_laser_alignment_IMG_20170710_185009.jpg" data-width="94%" />  <figcaption>Figure 47(b): Detector installed after alignment</figcaption></figure>
<figcaption>Figure 47: <a href="#fig:cast:laser_alignment1">47(a)</a> Alignment of the telescope side pipes using an acrylic glass
           flange with a centered grid and a laser aligned to the magnet
           bore. The central laser spot is the point on the vertical line
           extending out from the center. The other points towards the lower right
           are further refractions. This was better visible by eye. <a href="#fig:cast:detector_installed">47(b)</a> Detector installed on the beamline behind the LLNL telescope on &lt;2017-07-10&gt;.</figcaption>
</figure>
</div>
<div id="outline-container-org28ef151" class="outline-4">
<h4 id="org28ef151"><span class="section-number-4">10.1.1.</span> Detailed technical timeline <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-10-1-1" class="outline-text-4">
<dl class="org-dl">
<dt>Initial installation 2017</dt><dd>  <ul class="org-ul">
<li>ref:
<a href="https://espace.cern.ch/cast-share/elog/Lists/Posts/Post.aspx?ID=3420">https://espace.cern.ch/cast-share/elog/Lists/Posts/Post.aspx?ID=3420</a>
and <code>~/org/Documents/InGrid_calibration_installation_2017_elog.pdf</code></li>
<li>June/July detector brought to CERN</li>
<li>before <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-07-07 Fri&gt; </span>  </span> alignment of LLNL telescope by Jaime</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-07-07 Fri&gt; </span>  </span> laser alignment (see <img alt="laser_alignment_IMG_20170707_121738.jpg" src="./figs/home/basti/org/Figs/CAST_Alignment/laser_alignment_IMG_20170707_121738.jpg" />)</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-07-10 Mon&gt; </span>  </span> vacuum leak tests &amp; installation of detector
(see:
<img alt="detector_installed_after_laser_alignment_IMG_20170710_185009.jpg" src="./figs/home/basti/org/Figs/CAST_Alignment/detector_installed_after_laser_alignment_IMG_20170710_185009.jpg" />)</li>
<li>after <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-07-10 Mon&gt; </span>  </span> installation of lead shielding</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-07-11 Tue&gt; </span>  </span> Geometer measurement of InGrid alignment for
X-ray finger run</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-07-13 Thu&gt; </span>  </span> - <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-07-14 Fri&gt;</span>  </span>: first X-ray finger run (not
useful to determine position of detector, due to dismount after)</li>
<li>after: dismounted to make space for KWISP</li>
</ul></dd>

<dt>Installation for data taking start</dt><dd>  <ul class="org-ul">
<li>Remount in September 2017 <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-09-11 Mon&gt; </span>  </span> - <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-09-14 Thu&gt;</span>  </span></li>
<li>installation from <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-09-11 Mon&gt; </span>  </span> to <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-09-15 Fri&gt; </span>  </span></li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-09-14 Thu&gt; </span>  </span> Alignment with geometers for data taking, magnet warm and under vacuum.</li>
</ul></dd>

<dt>Window explosion cleaning accident</dt><dd>  <ul class="org-ul">
<li>weekend: (ref: <a href="./../org/Talks/CCM_2017_Sep/CCM_2017_Sep.html">./../org/Talks/CCM_2017_Sep/CCM_2017_Sep.html</a>)
<ul class="org-ul">
<li>calibration (but all wrong)</li>
<li>water cooling stopped working</li>
</ul></li>
<li>next week: try fix water cooling</li>
<li>quick couplings: rubber disintegrating causing cooling flow to go to
zero</li>
<li>attempt to clean via compressed air</li>
<li>final cleaning <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-09-19 Tue&gt;</span>  </span>: wrong tube, compressed detector…</li>
<li>detector window exploded…
<ul class="org-ul">
<li>show image of window and inside detector</li>
</ul></li>
<li>detector investigation in CAST CDL <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-09-19 Tue&gt;</span>  </span>
see
<img alt="broken_window_close_IMG_20170919_152130.jpg" src="./figs/home/basti/org/Figs/CAST_detector_exploded/broken_window_close_IMG_20170919_152130.jpg" />
images &amp; timestamps of images</li>
<li>study of contamination &amp; end of Sep CCM</li>
<li>detector back to Bonn, fixed</li>
</ul></dd>

<dt>Reinstallation for data taking start (Run 2)</dt><dd>  <ul class="org-ul">
<li>detector installation before first data taking</li>
<li>reinstall in October for start of data taking in 30th Oct 2017</li>
<li>remount start <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-10-23 Mon&gt;</span>  </span></li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-10-26 Thu&gt; </span>  </span> Alignment with Geometers (after removal &amp;
remounting due to window accident) for data taking. Magnet <b>cold</b>
and under vacuum.</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-10-27 Fri&gt; </span>  </span> calibration of scintillator veto paddle in RD51 lab</li>
<li>remount installation finished incl. lead shielding <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-10-28 Sat&gt;</span>  </span>
(mail &quot;InGrid status update&quot; to Satan Forum on <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-11-09 Thu&gt;</span>  </span>)</li>
<li>&lt;data taking period from <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-10-30 Mon&gt; </span>  </span> to <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-12-22 Fri&gt; </span>  </span> in
2017&gt;
<ul class="org-ul">
<li>between runs 85 &amp; 86: fix of <code>src/waitconditions.cpp</code> TOS bug,
which caused scinti triggers to be written in all files up to next
FADC trigger</li>
<li>run 101 <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-11-29 Wed 06:40&gt; </span>  </span> was the first with FADC noise
significant enough to make me change settings:
<ul class="org-ul">
<li>Diff: 50 ns -&gt; 20 ns (one to left)</li>
<li>Coarse gain: 6x -&gt; 10x (one to right)</li>
</ul></li>
<li>run 109: <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-12-04 Mon&gt; </span>  </span> crazy amounts of noise on FADC</li>
<li>run 111: stopped early. tried to debug noise and blew a fuse in
gas interlock box by connecting NIM crate to wrong power cable</li>
<li>run 112: change FADC settings again due to noise:
<ul class="org-ul">
<li>integration: 50 ns -&gt; 100 ns
This was done at around <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-12-07 Thu 08:00&gt;</span>  </span></li>
<li>integration: 100 ns -&gt; 50 ns again at around
<span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-12-08 Fri 17:50&gt;</span>  </span>.</li>
</ul></li>
<li>run 121: Jochen set the FADC main amplifier
integration time from 50 -&gt; 100 ns again, around
<span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-12-15 Fri 10:20&gt;</span>  </span></li>
</ul></li>
<li>&lt;data taking period from <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-17 Sat&gt; </span>  </span> to <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-04-17 Tue&gt;</span>  </span>
beginning 2018&gt;
<ul class="org-ul">
<li>start of 2018 period: temperature sensor broken!</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-15 Thu&gt; </span>  </span> to <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-17 Sat&gt; </span>  </span> issues with moving THL
values &amp; weird detector behavior. Changed THL values temporarily
as an attempted fix, but in the end didn&apos;t help, problem got worse.
<span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-17 Sat&gt; </span>  </span> (ref: gmail &quot;Update 17/02&quot; and
<a href="./../org/Mails/cast_power_supply_problem_thlshift/power_supply_problem.html">./../org/Mails/cast_power_supply_problem_thlshift/power_supply_problem.html</a>)
issue with power supply causing severe drop in gain / increase
in THL (unclear, #hits in 55Fe dropped massively ; background
eventually only saw random active pixels).
Fixed by replugging all power cables and improving the grounding
situation.
iirc: this was later identified to be an issue with the
grounding between the water cooling system and the
detector.</li>
<li>by <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-17 Sat 20:41&gt; </span>  </span> everything was fixed and detector was
running correctly again.</li>
<li>  <p>
2 runs:
</p>
<ol class="org-ol">
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-15 Thu 07:01&gt;    </span>  </span>    <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-15 Thu 08:33&gt;</span>  </span></li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-16 Fri 07:00&gt;    </span>  </span>    <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-02-16 Fri 08:31&gt;</span>  </span></li>
</ol>
<p>
were missed because of this.
</p></li>
</ul></li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-04-18 Wed&gt; </span>  </span> removal of veto scintillator and lead shielding</li>
<li>X-ray finger run 2 on <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-04-20 Fri&gt;</span>  </span>. This run is actually
useful to determine the position of the detector.</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-04-24 Tue&gt; </span>  </span> Geometer measurement after warming up magnet and
not under vacuum. Serves as reference for difference between
vacuum &amp; cold on <span class="timestamp-wrapper">    <span class="timestamp">&lt;2017-10-26 Thu&gt;</span>  </span>!</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-04-26 Thu&gt; </span>  </span> detector fully removed and taken back to Bonn</li>
</ul></dd>

<dt>Reinstallation for data taking in Oct 2018 (Run 3)</dt><dd>  <ul class="org-ul">
<li>installation started <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-07-16 Mon&gt;</span>  </span>. Mounting due to lead shielding
support was more complicated than intended (see mails &quot;ingrid
installation&quot; including Damien Bedat)</li>
<li>shielding fixed by <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-07-19 Thu&gt; </span>  </span> and detector installed the next
couple of days</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-07-23 Mon&gt; </span>  </span> Alignment with Geometers for data taking. Magnet
warm and not under vacuum.</li>
<li>data taking was supposed to start end of September, but delayed.</li>
<li>detector had issue w/ power supply, finally fixed on
<span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-10-19 Fri&gt;</span>  </span>. Issue was a bad soldering joint on the Phoenix
connector on the intermediate board.
<b>Note</b>: See chain of mails titled &quot;Unser Detektor…&quot; starting on
<span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-10-03 Wed&gt; </span>  </span> for more information. Detector behavior was weird
from beginning Oct. Weird behavior seen on the voltages of the
detector. Initial worry: power supply dead or supercaps on
it. Replaced power supply (Phips brought it a few days after), but no change.</li>
<li>data taking starts <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-10-20 Sat&gt;</span>  </span></li>
<li>run 297, 298 showed lots of noise again, disabled FADC on
<span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-12-13 Thu 18:40&gt; </span>  </span> (went to CERN next day)</li>
<li>data taking ends <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-12-20 Thu&gt;</span>  </span></li>
<li>  <p>
runs that were missed:
</p>
<ol class="org-ol">
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-10-19 Fri 06:21&gt;    </span>  </span>    <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-10-19 Fri 07:51&gt;</span>  </span></li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-10-28 Sun 05:32&gt;    </span>  </span>    <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-10-28 Sun 07:05&gt;</span>  </span></li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-11-24 Sat 07:08&gt;    </span>  </span>    <span class="timestamp-wrapper">    <span class="timestamp">&lt;2018-11-24 Sat 07:30&gt;</span>  </span></li>
</ol>
<p>
The last one was not a full run.
</p>
<ul class="org-ul">
<li class="off">  <code>[ ]</code> <b>CHECK THE ELOG FOR WHAT THE LAST RUN WAS ABOUT</b></li>
</ul></li>
</ul></dd>

<dt>CAST Detector Lab measurements</dt><dd>  <ul class="org-ul">
<li>detector mounted in CAST Detector Lab <span class="timestamp-wrapper">    <span class="timestamp">&lt;2019-02-14 Thu&gt;</span>  </span></li>
<li>data taking from <span class="timestamp-wrapper">    <span class="timestamp">&lt;2019-02-15 Fri&gt; </span>  </span> to <span class="timestamp-wrapper">    <span class="timestamp">&lt;2019-02-21 Thu&gt;</span>  </span>.</li>
<li>detector dismounted and taken back to Bonn</li>
</ul></dd>

<dt>Outer chip 55Fe calibrations</dt><dd>  <ul class="org-ul">
<li>ref: <a href="./../org/outerRingNotes.html">./../org/outerRingNotes.html</a></li>
<li>calibration measurements of outer chips with a 55Fe source using a
custom anode &amp; window</li>
<li>between <span class="timestamp-wrapper">    <span class="timestamp">&lt;2021-05-20 Thu&gt; </span>  </span> and <span class="timestamp-wrapper">    <span class="timestamp">&lt;2021-05-31 Mon 09:54&gt; </span>  </span> calibrations
of each outer chip using Run 2 and Run 3 detector calibrations</li>
<li>  <span class="timestamp-wrapper">    <span class="timestamp">&lt;2021-08-31 Tue&gt; </span>  </span> start of a new detector calibration</li>
<li>another set of measurements between <span class="timestamp-wrapper">    <span class="timestamp">&lt;2021-10-12 Tue 18:00&gt; </span>  </span> to
<span class="timestamp-wrapper">    <span class="timestamp">&lt;2021-10-16 Sat 19:55&gt; </span>  </span> with a new set of calibrations</li>
</ul></dd>
</dl>
</div>
</div>
</div>
<div id="outline-container-sec:cast:alignment" class="outline-3">
<h3 id="sec:cast:alignment"><span class="section-number-3">10.2.</span> Alignment</h3>
<div id="text-sec:cast:alignment" class="outline-text-3">
<p>
Detector alignment with the X-ray telescope, the magnet and by
extension the solar core during solar tracking is obviously crucial
for a helioscope for a good physics result. The alignment procedure
used for the Septemboard detector is a three-fold approach:
</p>

<ol class="org-ol">
<li>alignment of the piping up to the detector using an acrylic glass
target with a millimeter spaced cross, as seen in
fig. <a href="#fig:cast:laser_alignment1">47(a)</a>. This target is mounted to the
vacuum pipes in the same way the detector is mounted. A laser is
installed on the opposite side of the magnet. With the magnet bores
fully open the laser is aligned such that it propagates the full
bore and is reflected by the X-ray telescope into the focal
spot. This alignment guarantees the focal spot location to be near
the center of the detector. Uncertainty is introduced due to the
need to remove the acrylic glass target and install the detector,
as the mounting screws allow for small movements. In addition the
vacuum pipes are also not perfectly fixed.</li>
<li>alignment of the fully installed detector using an X-ray
finger. The &apos;X-ray finger&apos; is a small electric X-ray generator (in
particular an Amptek COOL-X), which is installed in the magnet bore
at the opposite end of the magnet. The generated X-rays must
traverse the magnet and telescope, thereby being focused by the
telescope into the focal spot. As the X-ray finger does not emit
parallel light, the resulting distribution of the X-rays on the
detector is not a perfect focal spot, even if the telescope was
perfect and the detector placed right in the focus. The close
distance also implies the focal length is slightly different than
for an infinite source. The mean position of the taken data can
anyhow be used to determine the likely focal spot position. See
below, fig. <a href="#fig:cast:xray_finger_centers">48(a)</a>, for an example and the
resulting position from one of the X-ray finger runs.</li>
<li>alignment by the geometer group at CERN. A theodolite is installed
in the CAST hall and the location of many targets on the magnet,
telescope, vacuum pipes and the detector itself are measured up to
\(\SI{0.5}{mm}\) precision at \(1σ\) level. See
fig. <a href="#fig:cast:alignment_targets">48(b)</a> for a picture of such a
target. The initial geometer measurement from <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-07-11 Tue&gt; </span></span> mainly
serves as a baseline reference. As the first two alignment
procedures provide a good alignment, a measurement of the existing
position by the geometers can then later be used to re-align the
detector after it was removed relative to the previous baseline
position relative to the telescope. This assures the detector can
be remounted and placed in the right location without the need for
an additional laser alignment.</li>
</ol>

<p>
The X-ray finger run taken in April 2018 can be used as a reference
for the alignment as used during the first data taking. The center
positions of each cluster can be shown as a heatmap, where the number
of hits each pixel received is colored. Computing the mean position of
all those clusters yields the most likely center position of the focal
spot. See fig. <a href="#fig:cast:xray_finger_centers">48(a)</a> for an example of
this. The position of the center based on the mean of all cluster
centers is about \(\SI{0.4}{mm}\) away from the center in both axes.
</p>


<figure id="fig:cast:xray_finger_alignment" class="figure-wrapper">
<figure id="fig:cast:xray_finger_centers" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/CAST_Alignment/xray_finger_centers_run_189.svg" data-width="99%" />  <figcaption>Figure 48(a): X-ray finger clusters</figcaption></figure> <figure id="fig:cast:alignment_targets" class="subfigure" data-width="49%">  <img src="./figs/home/basti/phd/Figs/CAST_Alignment/detector_targets_for_alignment_small_crop.png" data-width="99%" />  <figcaption>Figure 48(b): Geometer target</figcaption></figure>
<figcaption>Figure 48: <a href="#fig:cast:xray_finger_centers">48(a)</a>: Cluster center positions of the X-ray finger run 189 from April
           2018. The red cross marks the center of all cluster centers,
           which is the most likely position of the focal spot. It is $\sim\SI{0.4}{mm}$ away from the chip center in both axes.
           The two parallel lines with less clusters are the window strongback.
           The orthogonal line is a graphite spacer in the center of the LLNL telescope. <a href="#fig:cast:alignment_targets">48(b)</a>: Image showing the targets on the detector. The acrylic glass
           cylinders are the fiducial marks used to hold the actual survey
           target. The survey target is a mirror to reflect the laser of the
           theodolite. Image from (NO_ITEM_DATA:geometer_1.)
</figcaption>
With this setup after each remounting a geometer measurement was
performed to align the detector back to the initial laser
alignment. As the second mounting of the detector in September 2017
was not used for any data taking, the associated geometer measurement
is irrelevant.
</figure>
Tab. <a href="#tab:cast:geometer_alignments">11</a> summarizes the values of the
geometer alignment results for each of the measurements using the
CenterR and CenterF positions defined based on the initial geometer
measurement in July 2017. In each case the shifts in X, Y and Z
direction is usually significantly less than \(\SI{1}{mm}\).
</div>
<caption class="t-above"><span class="table-number">Table 11:</span> Overview of the results of the different geometer alignment measurements. The first measuremnt serves as the baseline to define 2 points (CenterR and CenterF) relative to which alignment later is done. The initial alignment is done both by laser and X-ray finger. The second geometer measurement is not useful, as no data was taken with it, due to the window rupture accident.</caption>

<colgroup>
<col class="org-right" />

<col class="org-left" />

<col class="org-right" />

<col class="org-right" />

<col class="org-right" />

<col class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Measurement</th>
<th scope="col" class="org-left">Target</th>
<th scope="col" class="org-right">ΔX [\(\si{mm}\)]</th>
<th scope="col" class="org-right">ΔY [\(\si{mm}\)]</th>
<th scope="col" class="org-right">ΔZ [\(\si{mm}\)]</th>
<th scope="col" class="org-left">Useful</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">11.07.2017</td>
<td class="org-left"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-right"> </td>
<td class="org-left">yes</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">14.09.2017</td>
<td class="org-left">CenterR</td>
<td class="org-right">-0.1</td>
<td class="org-right">0.3</td>
<td class="org-right">-0.8</td>
<td class="org-left">no</td>
</tr>

<tr>
<td class="org-right"> </td>
<td class="org-left">CenterF</td>
<td class="org-right">-0.1</td>
<td class="org-right">0.3</td>
<td class="org-right">-0.9</td>
<td class="org-left"> </td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">26.10.2017</td>
<td class="org-left">CenterR</td>
<td class="org-right">0.2</td>
<td class="org-right">0.6</td>
<td class="org-right">0.2</td>
<td class="org-left">yes</td>
</tr>

<tr>
<td class="org-right"> </td>
<td class="org-left">CenterF</td>
<td class="org-right">0.1</td>
<td class="org-right">0.6</td>
<td class="org-right">-0.1</td>
<td class="org-left"> </td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">24.04.2018</td>
<td class="org-left">CenterR</td>
<td class="org-right">0.5</td>
<td class="org-right">0.5</td>
<td class="org-right">0.0</td>
<td class="org-left">yes</td>
</tr>

<tr>
<td class="org-right"> </td>
<td class="org-left">CenterF</td>
<td class="org-right">0.4</td>
<td class="org-right">0.5</td>
<td class="org-right">-0.3</td>
<td class="org-left"> </td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">23.07.2018</td>
<td class="org-left">CenterR</td>
<td class="org-right">1.1</td>
<td class="org-right">0.5</td>
<td class="org-right">0.6</td>
<td class="org-left">yes</td>
</tr>

<tr>
<td class="org-right"> </td>
<td class="org-left">CenterF</td>
<td class="org-right">1.0</td>
<td class="org-right">0.5</td>
<td class="org-right">0.3</td>
<td class="org-left"> </td>
</tr>
</tbody>
</div>
For a detailed overview of the geometer measurements see the public
EDMS links under (<a href="./bibliography.html#citeproc_bib_item_15">B. C. Antje Behrens 2017</a>; <a href="./bibliography.html#citeproc_bib_item_16">B. C. Antje Behrens Alexandre Beynel 2017a</a>, <a href="./bibliography.html#citeproc_bib_item_17">2017b</a>; <a href="./bibliography.html#citeproc_bib_item_14">Antje Behrens 2018b</a>, <a href="./bibliography.html#citeproc_bib_item_13">2018a</a>)
containing the PDF reports for each measurement.
</div>
<div id="outline-container-org619230d" class="outline-4">
<h4 id="org619230d"><span class="section-number-4">10.2.1.</span> Some extra info about the geometer alignment   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-10-2-1" class="outline-text-4">
<p>
The following is the snippet from the <span class="timestamp-wrapper">  <span class="timestamp">&lt;2017-09-14 Thu&gt; </span></span> PDF report about
the definition of the CenterR and CenterF positions.
</p>
<blockquote>
<p>
Goal of the operation has been to align the InGRID detector with
respect to the LLNL telescope as on 11.07.2017 after the alignment of
the setup with respect to the LASER installed.  Coordinates of the
measurement on 11.07.2017 are given below.
</p>

<p>
In order to compare InGRID position on 11.07 and 14.09, two points
close to the detector axis CenterR and CenterF have been defined on
11.07. Afterwards their coordinates for the measurement on 14.09 have
been calculated.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-sec:cast:alignment:xray_finger_plots" class="outline-4">
<h4 id="sec:cast:alignment:xray_finger_plots"><span class="section-number-4">10.2.2.</span> Generate X-ray heatmap <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-sec:cast:alignment:xray_finger_plots" class="outline-text-4">
<ul class="org-ul">
<li class="on"><code>[X]</code> <b>FIND XRAY FINGER RUN 2, RUN 189!</b>
<a href="./../CastData/data/XrayFingerRuns/">./../CastData/data/XrayFingerRuns/</a></li>
<li class="on"><code>[X]</code> <b>RECREATE BELOW FOR THE OTHER XRAY FINGER RUN!</b>
-&gt; Both are created and listed below.</li>
<li class="off"><code>[ ]</code> <b>RECREATE PLOTS AS TIKZ + VEGA</b>
-&gt; We create them on the Cairo backend using DejaVu Serif, same as
in the document of the thesis now. This is because the TikZ produced
vector graphic ends up much larger than the Cairo one.
Vega is on hold for now.</li>
<li class="on"><code>[X]</code> <b>VERIFY THAT WE (LIKELY) HAVE TO ROTATE THE DATA BY 90 DEGREES AS ONE OF THE VERTICAL LINES IS THE TELESCOPE AXIS WHICH SHOULD BE
HORIZONTAL TO THE GROUND</b>
-&gt; Yes, we do.</li>
</ul>

<p>
First let&apos;s reconstruct the X-ray finger run:
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> shell, strutils

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">main</span><span style="color: #AE81FF;">(</span>path: <span style="color: #66D9EF;">string</span>, run: <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">parse data</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">outfile </span>= <span style="color: #E6DB74;">&quot;/t/xray_finger_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.h5&quot;</span> % $run
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">recoOut </span>= <span style="color: #E6DB74;">&quot;/t/reco_xray_finger_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.h5&quot;</span> % $run
  
  shell:
    raw_data_manipulation -p <span style="color: #AE81FF;">(</span>$path<span style="color: #AE81FF;">)</span> <span style="color: #E6DB74;">&quot;--runType xray --out &quot;</span> <span style="color: #AE81FF;">(</span>$outfile<span style="color: #AE81FF;">)</span>
  shell:
    reconstruction -i <span style="color: #AE81FF;">(</span>$outfile<span style="color: #AE81FF;">)</span> <span style="color: #E6DB74;">&quot;--out &quot;</span> <span style="color: #AE81FF;">(</span>$recoOut<span style="color: #AE81FF;">)</span>
  
<span style="color: #F92672;">when</span> <span style="color: #AE81FF;">isMainModule</span>:
  <span style="color: #F92672;">import</span> cligen
  dispatch main
</pre>
</div>

<p>
And now we simply create a heatmap of the cluster centers:
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> nimhdf5, ggplotnim, options
<span style="color: #F92672;">import</span> ingrid / tos_helpers
<span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>strutils, tables<span style="color: #AE81FF;">]</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">main</span><span style="color: #AE81FF;">(</span>run: <span style="color: #66D9EF;">int</span>, switchAxes: <span style="color: #66D9EF;">bool</span> = <span style="color: #AE81FF;">false</span>, useTeX = <span style="color: #AE81FF;">false</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">file </span>= <span style="color: #E6DB74;">&quot;/t/reco_xray_finger_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.h5&quot;</span> % $run
  
  <span style="color: #75715E;">#</span><span style="color: #75715E;">proc readClusters(h5f: H5File): (seq[float], seq[float]) =</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>file, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>
  
  <span style="color: #75715E;"># </span><span style="color: #75715E;">compute counts based on number of each pixel hit</span>
  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">toIdx</span><span style="color: #AE81FF;">(</span>x: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">int</span> = <span style="color: #AE81FF;">(</span>x / <span style="font-style: italic;">14</span>.<span style="font-style: italic;">0</span> * <span style="font-style: italic;">256</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>.round.<span style="color: #66D9EF;">int</span>.<span style="color: #F92672;">clamp</span><span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>, <span style="font-style: italic;">255</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">ctab </span>= initCountTable<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">int</span>, <span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]()</span> 
  
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= readRunDsets<span style="color: #AE81FF;">(</span>h5f, run = run,
                        chipDsets = some<span style="color: #66D9EF;">(</span><span style="color: #A6E22E;">(</span>
                        chip: <span style="font-style: italic;">3</span>, dsets: @<span style="color: #E6DB74;">[</span><span style="color: #E6DB74;">&quot;centerX&quot;</span>, <span style="color: #E6DB74;">&quot;centerY&quot;</span><span style="color: #E6DB74;">]</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;xidx&quot;</span> ~ toIdx<span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span><span style="color: #E6DB74;">&quot;centerX&quot;</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span>,
            f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;yidx&quot;</span> ~ toIdx<span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span><span style="color: #E6DB74;">&quot;centerY&quot;</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">xidx </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;xidx&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">yidx </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;yidx&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span>
  forEach x <span style="color: #F92672;">in</span> xidx, y <span style="color: #F92672;">in</span> yidx:
    <span style="color: #F92672;">inc</span> cTab, <span style="color: #AE81FF;">(</span>x, y<span style="color: #AE81FF;">)</span>
  df = df.mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">int</span>: <span style="color: #E6DB74;">&quot;count&quot;</span> ~ cTab<span style="color: #A6E22E;">[</span><span style="color: #E6DB74;">(</span>`xidx`, `yidx`<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">centerX </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;centerX&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.mean
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">centerY </span>= df<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;centerY&quot;</span>, <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span>.mean
  <span style="color: #F92672;">discard</span> h5f.<span style="color: #F92672;">close</span><span style="color: #AE81FF;">()</span>
 
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Center position of the cluster is at: (x, y) = (&quot;</span>, centerX, <span style="color: #E6DB74;">&quot;, &quot;</span>, centerY, <span style="color: #E6DB74;">&quot;)&quot;</span>
  <span style="color: #E6DB74;">## NOTE: Exchanging the axes for X and Y is equivalent to a 90° clockwise rotation for our data</span>
  <span style="color: #E6DB74;">## because the centerX values are inverted `</span><span style="color: #AE81FF;">(256 - x), applyPitchConversion</span><span style="color: #E6DB74;">`. </span>
  <span style="color: #E6DB74;">## The real rotation of the Septemboard detector at CAST seen from the telescope onto the</span>
  <span style="color: #E6DB74;">## detector is precisely 90° clockwise. </span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">x </span>= <span style="color: #F92672;">if</span> switchAxes: <span style="color: #E6DB74;">&quot;centerY&quot;</span> <span style="color: #F92672;">else</span>: <span style="color: #E6DB74;">&quot;centerX&quot;</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">y </span>= <span style="color: #F92672;">if</span> switchAxes: <span style="color: #E6DB74;">&quot;centerX&quot;</span> <span style="color: #F92672;">else</span>: <span style="color: #E6DB74;">&quot;centerY&quot;</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">cX </span>= <span style="color: #F92672;">if</span> switchAxes: centerY <span style="color: #F92672;">else</span>: centerX
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">cY </span>= <span style="color: #F92672;">if</span> switchAxes: centerX <span style="color: #F92672;">else</span>: centerY
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span>x, y, color = <span style="color: #E6DB74;">&quot;count&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">(</span>size = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">75</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">(</span>data = newDataFrame<span style="color: #66D9EF;">()</span>, aes = aes<span style="color: #66D9EF;">(</span>x = cX, y = cY<span style="color: #66D9EF;">)</span>,
               color = <span style="color: #E6DB74;">&quot;red&quot;</span>, marker = mkRotCross<span style="color: #AE81FF;">)</span> + 
    scale_color_continuous<span style="color: #AE81FF;">()</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;X-ray finger clusters of run </span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">&quot;</span> % $run<span style="color: #AE81FF;">)</span> +
    xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;x [mm]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;y [mm]&quot;</span><span style="color: #AE81FF;">)</span> + 
    xlim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">14</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + ylim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">14</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    margin<span style="color: #AE81FF;">(</span>right = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">5</span><span style="color: #AE81FF;">)</span> + 
    <span style="color: #75715E;">#</span><span style="color: #75715E;">theme_scale(1.0, family = &quot;serif&quot;) +</span>
    coord_fixed<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + 
    themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">600</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span> +
    legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">83</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + 
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/CAST_Alignment/xray_finger_centers_run_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.pdf&quot;</span> % $run,
           useTeX = useTeX, standalone = useTeX, dataAsBitmap = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
           <span style="color: #75715E;">#</span><span style="color: #75715E;">useTeX = true, standalone = true)</span>

<span style="color: #F92672;">when</span> <span style="color: #AE81FF;">isMainModule</span>:
  <span style="color: #F92672;">import</span> cligen
  dispatch main
</pre>
</div>

<p>
First perform the data reconstruction:
</p>
<div class="org-src-container">
<pre class="src src-sh">./code/xray_finger_data_parsing -p ~/CastData/data/XrayFingerRuns/Run_21_170713-11-03 --run 21
./code/xray_finger_data_parsing -p ~/CastData/data/XrayFingerRuns/Run_189_180420-09-53 --run 189
</pre>
</div>
<p>
And now create the plots:
</p>
<div class="org-src-container">
<pre class="src src-sh">./code/xray_finger_center_plot -r 21 --switchAxes 
./code/xray_finger_center_plot -r 189 --switchAxes
</pre>
</div>

<p>
For run 21:
Center position of the cluster is at: (x, y) = (7.210714052855218,5.669514297250704)
For run 189:
Center position of the cluster is at: (x, y) = (7.428075467697270,6.594113570730057)
</p>

<p>
First the plot for the (unused) X-ray finger run taken at the first
installation before any data taking (detector removed afterwards):
<img alt="xray_finger_centers_run_21.svg" class="org-svg" src="./figs/home/basti/phd/Figs/CAST_Alignment/xray_finger_centers_run_21.svg" />
</p>

<p>
And second the plot of the 2018 X-ray finger run taken <span class="underline">before</span> the
detector was removed in Apr 2018. This is the baseline for our idea
where the focal spot is going to be.
<a href="Figs/CAST_Alignment/xray_finger_centers_run_189.pdf">Figs/CAST_Alignment/xray_finger_centers_run_189.pdf</a>
</p>

<p>
<b>NOTE</b>: For a longer explanation about the reasoning behind the
comment for <code>--switchAxes</code> in the code, see
sec. <a href="./limit.html#sec:limit:candidates:septemboard_layout_transformations">13.14.7</a>.
</p>
</div>
</div>
<div id="outline-container-org1fc29e2" class="outline-4">
<h4 id="org1fc29e2"><span class="section-number-4">10.2.3.</span> Generate spectrum of X-ray finger run   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-10-2-3" class="outline-text-4">
<p>
Let&apos;s also look at the spectrum of the X-ray finger run (at least
189).
</p>

<p>
Given the reconstructed H5 file of the run 189
</p>

<div class="org-src-container">
<pre class="src src-sh">plotBackgroundRate <span style="color: #E6DB74; font-weight: bold;">\</span>
    \t\reco_xray_finger_189.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --names <span style="color: #E6DB74;">&quot;X-ray finger&quot;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --title <span style="color: #E6DB74;">&quot;X-ray finger run 189 spectrum&quot;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --centerChip 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold <span style="color: #E6DB74; font-weight: bold;">\</span>
    --energyDset energyFromCharge <span style="color: #E6DB74; font-weight: bold;">\</span>
    --outfile xray_finger_spectrum_189.pdf <span style="color: #E6DB74; font-weight: bold;">\</span>
    --outpath ~/phd/Figs/XrayFinger/ <span style="color: #E6DB74; font-weight: bold;">\</span>
    --useTeX <span style="color: #E6DB74; font-weight: bold;">\</span>
    --quiet
</pre>
</div>

<p>
Which yields the following figure:
</p>

<figure id="fig:cast:xray_finger_189_spectrum">
<img alt="xray_finger_spectrum_189.svg" class="org-svg" src="./figs/home/basti/phd/Figs/XrayFinger/xray_finger_spectrum_189.svg" />

<figcaption>Figure 49: <span class="figure-number">Figure 35: </span>Spectrum of the X-ray finger run. Care needs to be taken interpreting it, because the spectrum passes <span class="underline">through</span> the telescope. Given that the telescope has very low efficiency above \(\SI{4}{keV}\), the rate of X-rays at higher energies is extremely suppressed.</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org8fb758b" class="outline-4">
<h4 id="org8fb758b"><span class="section-number-4">10.2.4.</span> Systematic uncertainty from graphite spacer rotation <code>[/]</code>   <span class="tag">  <span class="extended">extended</span></span></h4>
<div id="text-10-2-4" class="outline-text-4">
<ul class="org-ul">
<li class="on"><code>[X]</code> Determine the rotation angle of the graphite spacer from the
X-ray finger data
-&gt; do now.
X-ray finger run:
<img alt="xray_finger_centers_run_189.svg" class="org-svg" src="./figs/home/basti/phd/Figs/CAST_Alignment/xray_finger_centers_run_189.svg" />
-&gt;
<img alt="xray_finger_graphite_spacer_angle_run189.png" src="./figs/home/basti/org/Figs/statusAndProgress/xray_finger_graphite_spacer_angle_run189.png" />
-&gt; It comes out to 14.17°!
But for run 21 (between which detector was dismounted of course):
<img alt="xray_finger_graphite_spacer_angle_run21.png" src="./figs/home/basti/org/Figs/statusAndProgress/xray_finger_graphite_spacer_angle_run21.png" />
-&gt; Only 11.36°!
That&apos;s a huge uncertainty given the detector was only dismounted!
3°.</li>

<li class="off"><code>[ ]</code> rotation of telescope!</li>
<li class="off"><code>[ ]</code> Effect on systematic uncertainty!</li>
</ul>
</div>
</div>
</div>

<div id="footnotes"><h2 class="footnotes">Footnotes: </h2><div class="footdef"><sup>  <a id="fn.1" href="#fnr.1" class="footnum" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The magnetic field of \(\SI{8.8}{T}\) corresponds to
the actual field at which the magnet was operated at CAST, as taken
from the magnet slow control data.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.2" href="#fnr.2" class="footnum" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
These numbers are from CAST&apos;s slow control
logs. See the extended thesis.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.3" href="#fnr.3" class="footnum" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
There is some confusion about the
diameter and length of the magnet. The original CAST proposal
(<a href="#citeproc_bib_item_244">Zioutas et al. 1999</a>) talks about the prototype dipole magnets as
having a bore diameter of \(\SI{42.5}{mm}\) and a length of
\(\SI{9.25}{m}\). However, every CAST publication afterwards uses the
numbers \(\SI{43}{mm}\) and \(\SI{9.26}{m}\). Digging into references about
the prototype dipole magnets is inconclusive. For better compatibility
with all other CAST related publications, we will use the same
\(\SI{43}{mm}\) and \(\SI{9.26}{m}\) values in this thesis. Furthermore,
measurements were done indicating values around \(\SI{43}{mm}\).
</p></div></div>

<div class="footdef"><sup>  <a id="fn.4" href="#fnr.4" class="footnum" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://www.youtube.com/watch?v=XY2lFDXz8aQ">https://www.youtube.com/watch?v=XY2lFDXz8aQ</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.5" href="#fnr.5" class="footnum" role="doc-backlink">5</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
See appendix section
<a href="#sec:appendix:cast_operations:terminology">20.1</a> for a schematic of the
common terminology like &apos;sunrise&apos; used at CAST.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.6" href="#fnr.6" class="footnum" role="doc-backlink">6</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Because this telescope only consists of one
section, its focal point is &apos;parallel&apos; to the magnet bore. In a full
Wolter I like optic the focal point is exactly behind the center of
the optic. With only a portion of a telescope this implies an
offset. Further, the telescope is not actually rotated exactly
\(\SI{90}{°}\) to move the focal spot perfectly parallel to the two
bores, but only about \(\SI{76}{°}\).
</p></div></div>

<div class="footdef"><sup>  <a id="fn.7" href="#fnr.7" class="footnum" role="doc-backlink">7</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Due to the envisioned toroidal magnet design
and much larger diameter, the magnetic field inside such a bore would
not be as homogeneous as in the LHC dipole magnets. The peak field
would be about \(\SI{5.4}{T}\). This also means a correct \(f_M\)
calculation for IAXO must take into account the actual magnetic field
map.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.8" href="#fnr.8" class="footnum" role="doc-backlink">8</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
\(g⁴\) is a placeholder for \(g⁴_{aγ}\) or
\(g²_{aγ}·g²_{ae}\). The flux scales with this product as explained in
sec. <a href="#sec:theory:current_bounds">4.7</a> due to axion production and reconversion
happening via \(g²\) each.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.9" href="#fnr.9" class="footnum" role="doc-backlink">9</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Outside of vetoes to tag muons that cause fluorescence for
example. 
</p></div></div>

<div class="footdef"><sup>  <a id="fn.10" href="#fnr.10" class="footnum" role="doc-backlink">10</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://henke.lbl.gov/optical_constants/">https://henke.lbl.gov/optical_constants/</a> 
</p></div></div>

<div class="footdef"><sup>  <a id="fn.11" href="#fnr.11" class="footnum" role="doc-backlink">11</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://github.com/SciNim/xrayAttenuation">https://github.com/SciNim/xrayAttenuation</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.12" href="#fnr.12" class="footnum" role="doc-backlink">12</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Note that there are different common
parametrizations of the Bethe-Bloch equation.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.13" href="#fnr.13" class="footnum" role="doc-backlink">13</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Energies of muons detected near Earth&apos;s surface
are in this range precisely because they are MIPs. Below and above the
much stronger interactions result either in stopping and decay or loss
until they are in the MIP range.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.14" href="#fnr.14" class="footnum" role="doc-backlink">14</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The calculation is a &quot;hybrid&quot; Monte Carlo
approach. We don&apos;t sample a large number of muons and transport them
through the atmosphere. We just compute the loss through the
atmosphere and allow the muon to decay randomly, dropping a single
data point. This is for simplicity on the one hand and the fact that
there is a very sharp transition of &apos;most muons traverse&apos; to
&apos;essentially no muons traverse&apos; the atmosphere at a given energy. For
that reason the flux in <a href="#fig:theory:muon_flux_surface:final">#fig:theory:muon_flux_surface:final</a> at low
energies is to be taken with a grain of salt. The fluxes are literally
mappings from data points in <a href="#fig:theory:muon_flux_surface:initial">#fig:theory:muon_flux_surface:initial</a>
to the corresponding energy left at the surface (i.e. assuming no
muons decay). Further the \(\SI{300}{MeV}\) energy left is already well
inside the energy range where a large number of muons would already decay.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.15" href="#fnr.15" class="footnum" role="doc-backlink">15</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://geant4.cern.web.ch">https://geant4.cern.web.ch</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.16" href="#fnr.16" class="footnum" role="doc-backlink">16</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="http://web.vu.lt/ff/a.poskus/mcnelectron/">http://web.vu.lt/ff/a.poskus/mcnelectron/</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.17" href="#fnr.17" class="footnum" role="doc-backlink">17</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://www.nndc.bnl.gov/endf-b8.0/index.html">https://www.nndc.bnl.gov/endf-b8.0/index.html</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.18" href="#fnr.18" class="footnum" role="doc-backlink">18</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://lxcat.net">https://lxcat.net</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.19" href="#fnr.19" class="footnum" role="doc-backlink">19</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Its usefulness depends on the angle from which
different aspects are discussed of course. We mainly use it to
understand the gas amplification later.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.20" href="#fnr.20" class="footnum" role="doc-backlink">20</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Later in chapter
<a href="#sec:background:mlp:event_generation">12.4.2</a> we will discuss Monte Carlo event
generation, which use the diffusion coefficient as an input to
generate clusters after drift. Distance \(x\) and \(y\) are each sampled
individually according to eq. \eqref{eq:gas_physics:diffusion_after_drift} and
combined to a radial distance from the cluster center.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.21" href="#fnr.21" class="footnum" role="doc-backlink">21</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
This will be a useful reference later when discussing
possible temperature effects of the detector operated at CAST.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.22" href="#fnr.22" class="footnum" role="doc-backlink">22</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://github.com/SiLab-Bonn/tpx3-daq">https://github.com/SiLab-Bonn/tpx3-daq</a> 
</p></div></div>

<div class="footdef"><sup>  <a id="fn.23" href="#fnr.23" class="footnum" role="doc-backlink">23</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The \(x\), \(y\) notation is sometimes encountered when
the exact material composition is not known. Silicon-nitride is a term
used for a range of silicon to nitride ratios. Most commonly \(\ce{Si_3 N_4}\).
</p></div></div>

<div class="footdef"><sup>  <a id="fn.24" href="#fnr.24" class="footnum" role="doc-backlink">24</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://www.xilinx.com/products/boards-and-kits/ek-v6-ml605-g.html">https://www.xilinx.com/products/boards-and-kits/ek-v6-ml605-g.html</a>
(visited 2022/10/17)
</p></div></div>

<div class="footdef"><sup>  <a id="fn.25" href="#fnr.25" class="footnum" role="doc-backlink">25</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://archive.org/details/manualzilla-id-5646050/">https://archive.org/details/manualzilla-id-5646050/</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.26" href="#fnr.26" class="footnum" role="doc-backlink">26</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://www.norcada.com/">https://www.norcada.com/</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.27" href="#fnr.27" class="footnum" role="doc-backlink">27</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The ideal readout time for one chip is \(t =
\SI{917504}{bits} · \SI{25}{ns} = \SI{22.9942}{ms}\)
(<a href="#citeproc_bib_item_153">Lupberger 2016</a>), but this does not take into account overhead
from the FPGA, sending data to the computer and processing in TOS. We
will later see that the practical readout time of the final detector
is closer to almost \(\SI{500}{ms}\) under high rate conditions
(e.g. \cefe calibration runs) and \(\sim\SI{200}{ms}\) for low rate
background conditions.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.28" href="#fnr.28" class="footnum" role="doc-backlink">28</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
See the full thesis version for the
occupancy of the run with temperature readout in the subsection
after this if interested.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.29" href="#fnr.29" class="footnum" role="doc-backlink">29</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The realization that the issues are
purely due to temperature effects was only after several months of
eliminating many other options, both on the software as well as the
hardware side. In particular power supply instabilities were long
considered to be a source of problems. While they possibly also had an
impact, better power supplies were built with larger capacitors to
better deal with large variations in required power. 
</p></div></div>

<div class="footdef"><sup>  <a id="fn.30" href="#fnr.30" class="footnum" role="doc-backlink">30</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://www.alphacool.com/">https://www.alphacool.com/</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.31" href="#fnr.31" class="footnum" role="doc-backlink">31</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The <code>THL</code> DAC is the global threshold DAC of all pixels. The
<code>THS</code> DAC is responsible for the range in which each pixel can be
adjusted around the global value. See appendix
<a href="#sec:appendix:calibration:timepix">19.1</a> for more information.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.32" href="#fnr.32" class="footnum" role="doc-backlink">32</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://iseg-hv.com/">https://iseg-hv.com/</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.33" href="#fnr.33" class="footnum" role="doc-backlink">33</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://caen.it/">https://caen.it/</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.34" href="#fnr.34" class="footnum" role="doc-backlink">34</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The trigger threshold DAC is a 12-bit DAC. Its
values correspond to \(\SI{-1}{V}\) at <code>000</code> and \(\SI{1}{V}\) at
<code>FFF</code>. Hence \(\num{1966}\) (seen in the configuration file) is roughly
\(\SI{-40}{mV}\).
</p></div></div>

<div class="footdef"><sup>  <a id="fn.35" href="#fnr.35" class="footnum" role="doc-backlink">35</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
While it is unclear to me now given it&apos;s been
over 5 years, I believe at the time of the calibration we wrongly
assumed a muon rate of \(\SI{100}{Hz.m⁻².sr⁻¹}\) instead of about
\(\SI{1}{cm⁻².min⁻¹}\). The former number only works out if one
integrates it over the \(\cos^2(θ)\) dependence, <span class="underline">but only along \(θ\)</span>
and not \(φ\)!  Either way, the number seems problematic. However, it
did misguide us in likely choosing a too low threshold, as using the
former number yields an expected number of counts of \(\sim\num{32000}\)
compared to only \(\sim\num{20000}\) in our naive approach.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.36" href="#fnr.36" class="footnum" role="doc-backlink">36</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://github.com/Vindaar/TimepixAnalysis">https://github.com/Vindaar/TimepixAnalysis</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.37" href="#fnr.37" class="footnum" role="doc-backlink">37</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://nim-lang.org">https://nim-lang.org</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.38" href="#fnr.38" class="footnum" role="doc-backlink">38</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/raw_data_manipulation.nim">https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/raw_data_manipulation.nim</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.39" href="#fnr.39" class="footnum" role="doc-backlink">39</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
HDF5 (<a href="#citeproc_bib_item_223">The HDF Group 1997</a>) is the Hierarchical Data Format of
version 5. It is a binary data format intended for scientific
datasets, which uses an in-file layout similar to a virtual file
system. Datasets (equivalent to files) are stored in groups
(equivalent to directories). Metadata can be attached to either and
linking between datasets, even across files is supported. It supports
a large number of compression filters to reduce the file size of the
stored data.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.40" href="#fnr.40" class="footnum" role="doc-backlink">40</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
These type of cuts are applied at this
stage of the processing, because for certain use cases or certain
detectors specific <code>ToT</code> or <code>ToA</code> ranges are of no interest / contain
junk data (because of a faulty chip for example). In this case it is
useful to remove such data in this preprocessing stage to lighten the
workload for anything after.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.41" href="#fnr.41" class="footnum" role="doc-backlink">41</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/reconstruction.nim">https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/reconstruction.nim</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.42" href="#fnr.42" class="footnum" role="doc-backlink">42</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The clustering logic of TPA is found here: <a href="https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/private/clustering.nim">https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/private/clustering.nim</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.43" href="#fnr.43" class="footnum" role="doc-backlink">43</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Note that the absolute value of the rotation angle
is of secondary importance. For X-rays the rotation angle is going to
be random, as the definition of a long and short axis in a
(theoretically perfect) circle depends on the statistical distribution
of the pixels. However, for pure muons it allows to map the rotation
angle to the incidence angle.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.44" href="#fnr.44" class="footnum" role="doc-backlink">44</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The term &apos;root mean square&apos; is used although we
actually refer to the standard deviation of the sample. We follow
(<a href="#citeproc_bib_item_65">Christoph Krieger 2018</a>), but this ambiguity is often encountered unfortunately.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.45" href="#fnr.45" class="footnum" role="doc-backlink">45</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
In particular all these properties are computed
here: <a href="https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/private/geometry.nim#L331-L391">https://github.com/Vindaar/TimepixAnalysis/blob/master/Analysis/ingrid/private/geometry.nim#L331-L391</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.46" href="#fnr.46" class="footnum" role="doc-backlink">46</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
A PDF of the FADC manual is available here:
<a href="https://archive.org/details/manualzilla-id-5646050/">https://archive.org/details/manualzilla-id-5646050/</a>
</p></div></div>

<div class="footdef"><sup>  <a id="fn.47" href="#fnr.47" class="footnum" role="doc-backlink">47</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The FADC can be operated in a 12 or 14-bit mode. We run
in the 12-bit mode. Also see <a href="#sec:daq:fadc_data_files">17.2.1.1</a>.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.48" href="#fnr.48" class="footnum" role="doc-backlink">48</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Aside from performing peak fitting (which is
difficult and requires understanding of the expected signal shapes)
another approach might be a local linear smoothing (e.g. a
Savitzky-Golay filter with polynomial of order 1) in a suitable window
range. The result would be a much more stable spectrum. This could
then be used to compute the numerical derivative from which all those
intervals with a slope smaller than some epsilon provide the dataset
from which to compute the mean. The tricky aspect would be choice of
window size and the behavior in very noisy events.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.49" href="#fnr.49" class="footnum" role="doc-backlink">49</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
The naming of the rise and fall time in the
context of a negative pulse is slightly confusing. Rise time refers to
the <span class="underline">negative rise</span> towards the minimum of the pulse and the fall time
to the time to return-to-baseline.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.50" href="#fnr.50" class="footnum" role="doc-backlink">50</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Excuse the small text for the annotations. They are
not important, but may be interesting for some readers!
</p></div></div>

<div class="footdef"><sup>  <a id="fn.51" href="#fnr.51" class="footnum" role="doc-backlink">51</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
Important note for people potentially
investigating the raw data from 2017: There was a small bug in the
readout software during the beginning of the 2017 data taking period,
which wrote the scintillator trigger clock cycle values into
subsequent output files even if no FADC trigger was received (and thus
no scintillator trigger was actually read out). However, there is a
flag for an FADC trigger. To correctly read the first data runs it is
therefore required to not only look at the scintillator trigger clock
cycles, but also at whether the FADC actually triggered. This is
handled in the analysis framework.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.52" href="#fnr.52" class="footnum" role="doc-backlink">52</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
In addition to the above bug, there was
unfortunately a more serious bug, which rendered the scintillator
counts useless in the end of 2017 / beginning of 2018 data taking
period. The polarity of the signals was inverted in the detector
firmware, resulting in useless &quot;trigger&quot; information.
</p></div></div>

<div class="footdef"><sup>  <a id="fn.53" href="#fnr.53" class="footnum" role="doc-backlink">53</a></sup> <div class="footpara" role="doc-footnote">  <p class="footpara">
<a href="https://www.amptek.com/internal-products/obsolete-products/cool-x-pyroelectric-x-ray-generator">https://www.amptek.com/internal-products/obsolete-products/cool-x-pyroelectric-x-ray-generator</a>
</p></div></div>

</div>
<div class="hint-message">Click on any heading marked '<span class="extended">extended</span>' to open it</div>
</div>
</body>
</html>
