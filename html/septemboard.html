<!DOCTYPE html>
<html lang="en">
<head>
<!--  2024-06-19 Wed 12:01  -->
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1" name="viewport" />
<title>‎</title>
<meta content="Vindaar" name="author" />
<meta content="Org Mode" name="generator" />

<link type="text/css" rel="stylesheet" href="org_html_export.css" />
<script type="text/javascript">

document.addEventListener('DOMContentLoaded', function() {
    // Set the initial width for subfigures and their images
    document.querySelectorAll('figure.subfigure[data-width]').forEach(function(subfigure) {
        subfigure.style.width = subfigure.getAttribute('data-width');
    });

    document.querySelectorAll('figure.subfigure img[data-width]').forEach(function(img) {
        img.style.width = img.getAttribute('data-width');
    });

    // Event listener for images within subfigures
    document.querySelectorAll('figure.subfigure img[data-width]').forEach(function(img) {
        img.addEventListener('click', function() {
            // Determine the .figure-wrapper that contains the clicked image
            let wrapper = this.closest('.figure-wrapper');

            // If found, adjust the sizes of its subfigures
            if (wrapper) {
                let subfigures = wrapper.querySelectorAll('figure.subfigure');
                subfigures.forEach(subfigure => {
                    let width = parseFloat(subfigure.getAttribute('data-width'));
                    if (width < 50) { // Double size if less than 50%
                        subfigure.setAttribute('data-width', (width * 2) + '%');
                        subfigure.style.width = (width * 2) + '%';
                    } else { // Halve size otherwise
                        subfigure.setAttribute('data-width', (width / 2) + '%');
                        subfigure.style.width = (width / 2) + '%';
                    }
                });
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', function () {
    var headers = document.querySelectorAll('h1 .extended, h2 .extended, h3 .extended, h4 .extended, h5 .extended, h6 .extended');

    headers.forEach(function (header) {
        var foldableHeader = header.closest('h1, h2, h3, h4, h5, h6');
        if (foldableHeader) {
            foldableHeader.classList.add('foldable-header');
            var nextElement = foldableHeader.nextElementSibling;
            var contentToFold = [];
            while (nextElement && !nextElement.matches('h1, h2, h3, h4, h5, h6')) {
                contentToFold.push(nextElement);
                nextElement = nextElement.nextElementSibling;
            }
            contentToFold.forEach(function (element) {
                element.classList.add('folded-content');
            });

            foldableHeader.addEventListener('click', function () {
                contentToFold.forEach(function (element) {
                    if (element.style.display === 'none' || element.style.display == '') {
                        element.style.display = 'block';
                    } else {
                        element.style.display = 'none';
                    }
                });
            });
        }
    });
});

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
<script type="text/x-mathjax-config">
<!-- /* --><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js", "[Contrib]/siunitx/siunitx.js", "[Contrib]/mhchem/mhchem.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"], ['$', '$'], ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 1.0,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        },
        TeX: {
              equationNumbers: { autoNumber: 'AMS' },
              Macros: {
                  ccsini: '{\\mathrm{Si}₃\\mathrm{N}₄}',
                  cefe: '{\\ce{^{55}Fe}}',
                  vektor: ['{\\begin{pmatrix}#1\\end{pmatrix}}', 1],
                  mtrix: ['{\\begin{pmatrix}#1\\end{pmatrix}}', 1],
                  cp: '{\\mathrm{CP}}',
                  cpt: '{\\mathrm{CPT}}',
                  dd: '{\\mathop{}\\!{\\mathrm{d}}}',
                  sinc: '{\\mathrm{sinc}}'
              }
        }
    });
/*]]>*///--&gt;
</script>
</head>
<body>
<div id="content" class="content">
<nav role="doc-toc" id="table-of-contents">
<h2>Table of Contents</h2>
<div role="doc-toc" id="text-table-of-contents">
<ul>
<li>  <a href="./errata.html#sec:errata">1. Errata   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./introduction.html#sec:introduction">2. Introduction   <span class="tag">    <span class="Intro">Intro</span>  </span></a></li>
<li><a href="./about_thesis.html#sec:about_thesis">3. About this thesis   <span class="tag">  <span class="Intro">Intro</span></span></a>
<ul>
<li>  <a href="./about_thesis.html#orgcc5a826">3.1. Extended notes for the extended thesis <code>[/]</code>   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./about_thesis.html#org6bb3d01">3.2. Why Org mode   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./about_thesis.html#org5c64f4e">3.3. Notes for future PhD students and IAXO analyses   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./theory.html#sec:theory">4. Theory of axions   <span class="tag">  <span class="Theory">Theory</span></span></a>
<ul>
<li>  <a href="./theory.html#sec:theory:useful_reading_material">4.1. Useful reading material   <span class="tag">    <span class="optional">optional</span>  </span></a></li>
<li>  <a href="./theory.html#sec:theory:illustration_cpt">4.2. Illustration of the \cpt symmetry <code>[/]</code>   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./theory.html#sec:theory:invisible_axion_models">4.3. Invisible axion models and axion couplings</a></li>
<li>  <a href="./theory.html#sec:theory:axion_interactions">4.4. Implications for axion interactions - conversion probability</a></li>
<li>  <a href="./theory.html#sec:theory:solar_axion_flux">4.5. Solar axion flux</a></li>
<li>  <a href="./theory.html#sec:theory:chameleon">4.6. Chameleons</a></li>
<li>  <a href="./theory.html#sec:theory:current_bounds">4.7. Current bounds on coupling constants</a></li>
</ul>
</li>
<li><a href="./helioscopes.html#sec:helioscopes">5. Axion helioscopes   <span class="tag">  <span class="Theory">Theory</span></span></a>
<ul>
<li>  <a href="./helioscopes.html#sec:helioscopes:cast">5.1. CERN Axion Solar Telescope (CAST)</a></li>
<li>  <a href="./helioscopes.html#sec:helioscopes:iaxo">5.2. International AXion Observatory (IAXO)</a></li>
</ul>
</li>
<li><a href="./theory_detector.html#sec:theory_detector">6. X-rays, cosmic muons and gaseous detectors   <span class="tag">  <span class="Theory">Theory</span></span></a>
<ul>
<li>  <a href="./theory_detector.html#sec:theory:particle_int">6.1. Particle interactions with matter</a></li>
<li>  <a href="./theory_detector.html#sec:theory:cosmic_radiation">6.2. Cosmic rays</a></li>
<li>  <a href="./theory_detector.html#sec:theory:gas_fundamentals">6.3. Gaseous detector fundamentals</a></li>
</ul>
</li>
<li><a href="./septemboard.html#sec:septemboard">7. Septemboard detector   <span class="tag">  <span class="Detector">Detector</span></span></a>
<ul>
<li>  <a href="./septemboard.html#sec:detector:micromegas">7.1. Micromegas working principle</a></li>
<li>  <a href="./septemboard.html#sec:detector:timepix">7.2. Timepix ASIC</a></li>
<li>  <a href="./septemboard.html#sec:detector:gridpix">7.3. GridPix</a></li>
<li>  <a href="./septemboard.html#sec:detector:detector_2014_15">7.4. 2014 / 2015 GridPix detector for CAST</a></li>
<li>  <a href="./septemboard.html#sec:detector:detector_overview">7.5. Septemboard detector overview</a></li>
<li>  <a href="./septemboard.html#orgb47d68b">7.6. Detector readout system</a></li>
<li>  <a href="./septemboard.html#sec:detector:scintillators">7.7. Scintillator vetoes</a></li>
<li>  <a href="./septemboard.html#sec:detector:fadc">7.8. FADC</a></li>
<li>  <a href="./septemboard.html#sec:detector:sin_window">7.9. SiN window</a></li>
<li>  <a href="./septemboard.html#sec:detector:septemboard">7.10. Septemboard - 6 GridPixes around a center one</a></li>
<li>  <a href="./septemboard.html#sec:detector:water_cooling">7.11. Water cooling and temperature readout for the septemboard</a></li>
<li>  <a href="./septemboard.html#sec:septem:efficiency">7.12. Detector efficiency</a></li>
<li>  <a href="./septemboard.html#sec:detector:daq">7.13. Data acquisition and detector monitoring</a></li>
</ul>
</li>
<li><a href="./operation_calibration.html#sec:operation_calibration">8. Detector calibration for operation   <span class="tag">  <span class="Detector">Detector</span></span></a>
<ul>
<li>  <a href="./operation_calibration.html#sec:operation_calibration:timepix">8.1. Timepix calibrations</a></li>
<li>  <a href="./operation_calibration.html#sec:operation_calibration:fadc">8.2. FADC calibration</a></li>
<li>  <a href="./operation_calibration.html#sec:operation_calibration:scintillators">8.3. Scintillator calibration</a></li>
</ul>
</li>
<li><a href="./reconstruction.html#sec:reconstruction">9. Data reconstruction   <span class="tag">  <span class="Reconstruction">Reconstruction</span></span></a>
<ul>
<li>  <a href="./reconstruction.html#sec:reco:tpa">9.1. <code>TimepixAnalysis</code> and Nim</a></li>
<li>  <a href="./reconstruction.html#sec:reco:tos_data_parsing">9.2. TOS data parsing</a></li>
<li>  <a href="./reconstruction.html#sec:reco:event_shape">9.3. Expectation of event shapes</a></li>
<li>  <a href="./reconstruction.html#sec:reco:data_reconstruction">9.4. Data reconstruction</a></li>
<li>  <a href="./reconstruction.html#sec:reco:fadc_data">9.5. FADC reconstruction</a></li>
<li>  <a href="./reconstruction.html#sec:reco:scintillator_data">9.6. Scintillator data</a></li>
</ul>
</li>
<li><a href="./cast.html#sec:cast">10. Detector installation &amp; data taking at CAST   <span class="tag">  <span class="CAST">CAST</span></span></a>
<ul>
<li>  <a href="./cast.html#sec:cast:timeline">10.1. Timeline</a></li>
<li>  <a href="./cast.html#sec:cast:alignment">10.2. Alignment</a></li>
<li>  <a href="./cast.html#sec:cast:detector_setup">10.3. Detector setup at CAST</a></li>
<li>  <a href="./cast.html#sec:cast:window_accident">10.4. Window accident</a></li>
<li>  <a href="./cast.html#sec:cast:data_taking_woes">10.5. Data taking woes</a></li>
<li>  <a href="./cast.html#sec:cast:data_taking_campaigns">10.6. Summary of CAST data taking</a></li>
</ul>
</li>
<li><a href="./calibration.html#sec:calibration">11. Data calibration   <span class="tag">  <span class="Calibration">Calibration</span></span></a>
<ul>
<li>  <a href="./calibration.html#sec:calibration:energy">11.1. Energy calibration - in principle</a></li>
<li>  <a href="./calibration.html#sec:calib:detector_behavior_over_time">11.2. Detector behavior over time</a></li>
<li>  <a href="./calibration.html#sec:calib:final_energy_calibration">11.3. Energy calibration dependence on the gas gain</a></li>
<li>  <a href="./calibration.html#sec:calib:fadc">11.4. FADC</a></li>
</ul>
</li>
<li><a href="./background.html#sec:background">12. Finding signal and defining background | Background rate computation   <span class="tag">  <span class="Analysis">Analysis</span></span></a>
<ul>
<li>  <a href="./background.html#sec:background:likelihood_method">12.1. Likelihood method</a></li>
<li>  <a href="./background.html#sec:cdl">12.2. CAST Detector Lab</a></li>
<li>  <a href="./background.html#sec:background:likelihood_cut">12.3. Application of likelihood cut for background rate</a></li>
<li>  <a href="./background.html#sec:background:mlp">12.4. Artificial neural networks as cluster classifiers</a></li>
<li>  <a href="./background.html#sec:background:additional_vetoes">12.5. Additional detector features as vetoes</a></li>
<li>  <a href="./background.html#sec:background:all_vetoes_combined">12.6. Background rates of combined vetoes and efficiencies</a></li>
</ul>
</li>
<li><a href="./limit.html#sec:limit">13. Limit calculation   <span class="tag">  <span class="Limit">Limit</span></span></a>
<ul>
<li>  <a href="./limit.html#sec:limit:method_introduction">13.1. Limit method - introduction</a></li>
<li>  <a href="./limit.html#sec:limit:method_likelihood">13.2. Limit method - likelihood function \(\mathcal{L}\)</a></li>
<li>  <a href="./limit.html#sec:limit:method_computing_L">13.3. Limit method - computing \(\mathcal{L}\)</a></li>
<li>  <a href="./limit.html#sec:limit:method_computing_a_limit">13.4. Limit method - computing a limit</a></li>
<li>  <a href="./limit.html#sec:limit:method_expected_limit">13.5. Limit method - toy candidate sets and expected limits</a></li>
<li>  <a href="./limit.html#sec:limit:method_systematics">13.6. Limit method - extending \(\mathcal{L}\) for systematics</a></li>
<li>  <a href="./limit.html#sec:limit:method_mcmc">13.7. Limit method - evaluating \(\mathcal{L}\) with nuisance parameters</a></li>
<li>  <a href="./limit.html#orgc9cf5b1">13.8. Note about likelihood integral   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./limit.html#org632b2b1">13.9. Derivation of short form of \(\mathcal{L}\) <code>[/]</code>   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./limit.html#sec:limit:ingredients">13.10. Likelihood ingredients in detail</a></li>
<li>  <a href="./limit.html#sec:limit:systematics">13.11. Systematics</a></li>
<li>  <a href="./limit.html#sec:limit:mcmc_calc_limit">13.12. MCMC to sample the distribution and compute a limit</a></li>
<li>  <a href="./limit.html#sec:limit:expected_limits">13.13. Expected limits of different setups</a></li>
<li>  <a href="./limit.html#sec:limit:candidates">13.14. Solar tracking candidates</a></li>
<li>  <a href="./limit.html#sec:limit:observed_limit">13.15. Observed limit - \(g_{ae}\)</a></li>
<li>  <a href="./limit.html#sec:limit:other_couplings">13.16. Other coupling constants</a></li>
<li>  <a href="./limit.html#org590d25a">13.17. Comparison to 2013 limit (using their method)   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./limit.html#org828d95d">13.18. Observed limit for different axion masses   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li>  <a href="./outlook.html#sec:outlook">14. Outlook</a></li>
<li>  <a href="./summary.html#sec:summary">15. Summary &amp; conclusion</a></li>
<li>  <a href="./bibliography.html#sec:bibliography">16. Bibliography   <span class="tag">    <span class="html">html</span>  </span></a></li>
<li><a href="./daq.html#sec:daq">17. Data acquisition and detector monitoring   <span class="tag"><span class="Appendix">Appendix</span> <span class="Detector">Detector</span></span></a>
<ul>
<li>  <a href="./daq.html#sec:daq:tof">17.1. Timepix Operating Firmware - TOF</a></li>
<li>  <a href="./daq.html#sec:daq:tos">17.2. Timepix Operating Software - TOS</a></li>
<li>  <a href="./daq.html#sec:daq:septemboard_event_display">17.3. Septemboard event display</a></li>
</ul>
</li>
<li><a href="./configuration.html#sec:appendix:configuration">18. Configuration and TOS / TOF versions   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./configuration.html#sec:appendix:configuration:tos_config">18.1. TOS configuration file</a></li>
<li>  <a href="./configuration.html#sec:appendix:configuration:tos_tof_versions">18.2. TOS and TOF versions used at CAST</a></li>
</ul>
</li>
<li><a href="./calibration.html#sec:appendix:calibration">19. Calibrations   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./calibration.html#sec:appendix:calibration:timepix">19.1. Timepix calibrations</a></li>
<li>  <a href="./calibration.html#sec:appendix:septemboard_calibrations">19.2. Septemboard calibration</a></li>
<li>  <a href="./calibration.html#sec:appendix:scintillator_calibration_notes">19.3. Calibration measurements of the veto scintillator paddle   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./cast_operations.html#sec:appendix:cast_operations">20. CAST operation procedures   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./cast_operations.html#sec:appendix:cast_operations:terminology">20.1. CAST terminology</a></li>
<li>  <a href="./cast_operations.html#sec:cast:high_voltage">20.2. High voltage supply</a></li>
<li>  <a href="./cast_operations.html#sec:cast:vacuum_system">20.3. Vacuum system</a></li>
<li>  <a href="./cast_operations.html#sec:cast:watercooling_gas">20.4. Watercooling system &amp; gas supply</a></li>
<li>  <a href="./cast_operations.html#sec:cast:interlock_systems">20.5. Interlock systems</a></li>
<li>  <a href="./cast_operations.html#sec:appendix:cast_log_files">20.6. CAST log files</a></li>
</ul>
</li>
<li><a href="./cast_run_list.html#sec:appendix:cast_run_list">21. CAST data taking run list   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./cast_run_list.html#org2592d2e">21.1. Full version   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./cast_data_taking_notes.html#sec:appendix:cast_data_taking_notes">22. CAST data taking notes <code>[0/1]</code>   <span class="tag"><span class="Appendix">Appendix</span> <span class="extended">extended</span></span></a>
<ul>
<li>  <a href="./cast_data_taking_notes.html#org7528aaa">22.1. Run table</a></li>
<li>  <a href="./cast_data_taking_notes.html#org5e2f4f6">22.2. Data runs</a></li>
<li>  <a href="./cast_data_taking_notes.html#orgd35ca85">22.3. Calibration runs</a></li>
<li>  <a href="./cast_data_taking_notes.html#org8d05ac6">22.4. Automatically generated run list</a></li>
<li>  <a href="./cast_data_taking_notes.html#org44b9f29">22.5. Automatically calculated total run times</a></li>
<li>  <a href="./cast_data_taking_notes.html#orgb749477">22.6. InGrid temperature from shift forms</a></li>
</ul>
</li>
<li><a href="./cabling_and_softwar_setup.html#sec:appendix:cabling_and_softwar_setup">23. Cabling &amp; software setup <code>[/]</code>   <span class="tag"><span class="Appendix">Appendix</span> <span class="extended">extended</span></span></a>
<ul>
<li>  <a href="./cabling_and_softwar_setup.html#orgfadf61a">23.1. Virtex V6 cabling</a></li>
<li>  <a href="./cabling_and_softwar_setup.html#orge6068cd">23.2. Detector cabling</a></li>
<li>  <a href="./cabling_and_softwar_setup.html#orgf8388c3">23.3. Vivado / ISE on void linux &amp; flashing Virtex V6</a></li>
<li>  <a href="./cabling_and_softwar_setup.html#org33b1740">23.4. Setting up the chips in TOS</a></li>
</ul>
</li>
<li><a href="./vacuum_contamination.html#sec:appendix:vacuum_contamination">24. Window rupture and vacuum contamination   <span class="tag"><span class="Appendix">Appendix</span> <span class="extended">extended</span></span></a>
<ul>
<li>  <a href="./vacuum_contamination.html#org6860b71">24.1. Calculation of vacuum volume</a></li>
<li>  <a href="./vacuum_contamination.html#orgb699e1f">24.2. Calculation of potential influx of gas</a></li>
<li>  <a href="./vacuum_contamination.html#org5a010b5">24.3. Consider pumping of pumps</a></li>
<li>  <a href="./vacuum_contamination.html#org2d474fa">24.4. Calculation of possible contamination</a></li>
</ul>
</li>
<li><a href="./detector_time_behavior.html#sec:appendix:detector_time_behavior">25. Detector behavior over time   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./detector_time_behavior.html#sec:appendix:choice_gas_gain_binning">25.1. Choice of gas gain binning time interval</a></li>
<li>  <a href="./detector_time_behavior.html#sec:appendix:correlation_gas_gain_ambient_temp">25.2. Correlation of gas gain and ambient CAST temperature</a></li>
</ul>
</li>
<li><a href="./cast_detector_lab.html#sec:appendix:cast_detector_lab">26. CAST Detector Lab data   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./cast_detector_lab.html#orgb3fb613">26.1. Generate all spectrum plots split by run   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./cast_detector_lab.html#sec:appendix:cdl_spectra_by_run">26.2. All spectra split by run</a></li>
<li>  <a href="./cast_detector_lab.html#sec:appendix:cdl:all_spectra_fits">26.3. All CDL spectra with line fits   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./cast_detector_lab.html#sec:appendix:cdl:all_spectra_fits_by_run">26.4. All CDL spectra with line fits by run</a></li>
</ul>
</li>
<li><a href="./fit_by_run_justification.html#sec:appendix:fit_by_run_justification">27. CAST Detector Lab variations and fitting by run   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./fit_by_run_justification.html#sec:appendix:fit_by_run:gas_gain_var_cluster_prop">27.1. Influence of gas gain variations on cluster properties</a></li>
</ul>
</li>
<li><a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra">28. Morphing of CDL reference spectra   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./morphing_cdl_spectra.html#orgf6bac68">28.1. Generate all morphing / tile related plots   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./morphing_cdl_spectra.html#org87b76a1">28.2. Generate plot comparing likelihood behavior   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra:tilemaps">28.3. Tilemap of each likelihood dataset</a></li>
<li>  <a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra:interpolation_raster">28.4. Interpolation of each likelihood dataset</a></li>
<li>  <a href="./morphing_cdl_spectra.html#sec:appendix:morphing_cdl_spectra:binwise_linear">28.5. Binwise linear interpolations for each likelihood dataset</a></li>
<li>  <a href="./morphing_cdl_spectra.html#org6333e1a">28.6. Notes on CDL morphing development   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./occupancy.html#sec:appendix:occupancy">29. Occupancy maps   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./occupancy.html#org09d9790">29.1. Run-2</a></li>
<li>  <a href="./occupancy.html#org14d6465">29.2. Run-3</a></li>
<li>  <a href="./occupancy.html#orgb0e50b1">29.3. Generate occupancy map plots   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./fadc.html#sec:appendix:fadc">30. FADC   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./fadc.html#sec:appendix:fadc:rise_fall">30.1. FADC rise and fall time</a></li>
<li>  <a href="./fadc.html#sec:appendix:background:fadc">30.2. FADC veto</a></li>
<li>  <a href="./fadc.html#orgacfd0c0">30.3. Generate plot of rise time vs skewness   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./fadc.html#sec:appendix:fadc_veto_empirical_cluster_length">30.4. Expected cluster size</a></li>
</ul>
</li>
<li><a href="./background_rates.html#sec:appendix:background_rates">31. Raw data and background rates   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./background_rates.html#sec:appendix:background_rates:full_chip">31.1. Background rates over full chip</a></li>
<li>  <a href="./background_rates.html#org6a9ffb9">31.2. Generate rate without any vetoes over full chip   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./background_rates.html#org6b8af44">31.3. Generate background rates over full chip   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./background_rates.html#org3c65b09">31.4. Generate table of background rates for all setups   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li>  <a href="./background_interpolation_chip_area.html#sec:appendix:background_interpolation_chip_area">32. Background interpolation chip cutout correction   <span class="tag">    <span class="Appendix">Appendix</span>  </span></a></li>
<li><a href="./limit_additional.html#sec:appendix:limit_additional">33. Additional limit information   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./limit_additional.html#sec:appendix:conversion_probability">33.1. Conversion probability as a function of mass   <span class="tag">    <span class="Appendix">Appendix</span>  </span></a></li>
<li>  <a href="./limit_additional.html#sec:appendix:exp_limit_percentiles">33.2. Expected limit table with percentiles</a></li>
<li>  <a href="./limit_additional.html#sec:appendix:limit_additional:axion_photon">33.3. Observed limit - axion photon \(g_{aγ}\)</a></li>
<li>  <a href="./limit_additional.html#sec:appendix:limit_additional:chameleon">33.4. Observed limit - chameleon \(β_γ\)</a></li>
</ul>
</li>
<li><a href="./software.html#sec:appendix:software">34. Software   <span class="tag"><span class="Software">Software</span> <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./software.html#org436bedd">34.1. Why did I start writing my own analysis framework?   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./software.html#org86f63ec">34.2. Nim   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./software.html#sec:appendix:timepix_analysis">34.3. TimepixAnalysis</a></li>
<li>  <a href="./software.html#org8803ffa">34.4. Other libraries relevant for TimepixAnalysis</a></li>
</ul>
</li>
<li><a href="./full_data_reconstruction.html#sec:appendix:full_data_reconstruction">35. Full data reconstruction   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./full_data_reconstruction.html#orgdcf5166">35.1. Raw data parsing and reconstruction</a></li>
<li>  <a href="./full_data_reconstruction.html#orgb8d4b95">35.2. Parse and reconstruct the CDL data</a></li>
<li>  <a href="./full_data_reconstruction.html#orgf215b40">35.3. Add tracking information to background files</a></li>
<li>  <a href="./full_data_reconstruction.html#orgd02ba6b">35.4. Using <code>runAnalysisChain</code></a></li>
<li>  <a href="./full_data_reconstruction.html#orgeb8cb90">35.5. Applying a classifier</a></li>
<li>  <a href="./full_data_reconstruction.html#org4877c84">35.6. Computing limits</a></li>
</ul>
</li>
<li><a href="./average_depth_xrays_argon.html#sec:appendix:average_depth_xrays_argon">36. Average distance X-rays travel in argon at CAST conditions   <span class="tag">  <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./average_depth_xrays_argon.html#org154d979">36.1. Reference to original document   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./average_depth_xrays_argon.html#orgbcac2c8">36.2. Calculate conversion point numerically</a></li>
<li>  <a href="./average_depth_xrays_argon.html#org14e6f71">36.3. Compiling and running the code   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li><a href="./raytracing.html#sec:appendix:raytracing">37. Raytracing   <span class="tag"><span class="Software">Software</span> <span class="Appendix">Appendix</span></span></a>
<ul>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:traxer">37.1. TrAXer - An interactive axion raytracer</a></li>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:llnl_telescope">37.2. A few more details about the LLNL telescope</a></li>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:panter">37.3. Comparison of TrAXer results with PANTER measurements</a></li>
<li>  <a href="./raytracing.html#sec:appendix:raytracing:axion_image">37.4. Computing an axion image with TrAXer</a></li>
<li>  <a href="./raytracing.html#org4d72781">37.5. Reproducing an X-ray finger run with TrAXer   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
<li>  <a href="./raytracing.html#orgcf3cd15">37.6. Figure error development notes   <span class="tag">    <span class="extended">extended</span>  </span></a></li>
</ul>
</li>
<li>  <a href="./acknowledgments.html#sec:appendix:acknowledgments">38. Acknowledgments   <span class="tag">    <span class="Ack">Ack</span>  </span></a></li>
</ul>
</div>
</nav>
<div class="outline-2" id="outline-container-sec:septemboard">
<h2 id="sec:septemboard"><span class="section-number-2">7.</span> Septemboard detector   <span class="tag">  <span class="Detector">Detector</span></span></h2>
<div class="outline-text-2" id="text-sec:septemboard">
<p>
With the theoretical aspects of gaseous detectors out of the way, in
sec. <a href="./septemboard.html#sec:detector:micromegas">7.1</a> we will introduce the &apos;Micromegas&apos; type
of gaseous detector. Micromegas can be read out in different ways. One
option is the Timepix ASIC, sec. <a href="./septemboard.html#sec:detector:timepix">7.2</a>, by way of the
&apos;GridPix&apos;, sec. <a href="./septemboard.html#sec:detector:gridpix">7.3</a>.
</p>

<p>
The GridPix detector in use in the 2014 / 2015 CAST data taking
campaign, to be presented in section <a href="./septemboard.html#sec:detector:detector_2014_15">7.4</a>,
had a few significant drawbacks for more sensitive searches. In
particular for searches at low energies \(\lesssim\SI{2}{\keV}\) and
searches requiring low backgrounds over larger areas on the chip (for
example the chameleon search done in (<a href="./bibliography.html#citeproc_bib_item_137">Krieger 2018</a>)). For this
reason a new detector was built in an attempt to improve each
shortcoming of the detector.
</p>

<p>
We introduce the &apos;Septemboard&apos; detector with a basic overview in
section <a href="./septemboard.html#sec:detector:detector_overview">7.5</a>. From there we continue
looking at each of the new detector features motivating their
addition. All detector upgrades were done to alleviate one or more of
the old detector&apos;s drawbacks. For each new detector feature we will
highlight the aspects it is intended to improve on.
</p>

<p>
Section <a href="./septemboard.html#sec:detector:scintillators">7.7</a> introduces two new scintillators
as vetoes. These require the addition of an external shutter for the
Timepix, which is realized by usage of a flash ADC (FADC), see section
<a href="./septemboard.html#sec:detector:fadc">7.8</a>. Further, an independent but extremely important
addition is the replacement of the Mylar window by a silicon nitride
window, section <a href="./septemboard.html#sec:detector:sin_window">7.9</a>. Another aspect is the
addition of 6 GridPixes around the central GridPix, the &apos;Septemboard&apos;
introduced in section <a href="./septemboard.html#sec:detector:septemboard">7.10</a>. Due to the additional
heat produced by 6 more GridPix, a water cooling system is used,
sec. <a href="./septemboard.html#sec:detector:water_cooling">7.11</a>. Lastly, in
sec. <a href="./septemboard.html#sec:septem:efficiency">7.12</a> we will also discuss the combined
detection efficiency of this detector.
</p>
</div>

<div class="outline-3" id="outline-container-sec:detector:micromegas">
<h3 id="sec:detector:micromegas"><span class="section-number-3">7.1.</span> Micromegas working principle</h3>
<div class="outline-text-3" id="text-sec:detector:micromegas">
<p>
\textbf{Micro} \textbf{Me}sh \textbf{Ga}seous \textbf{S}tructures
(Micromegas) are a kind of \textbf{M}icro\textbf{p}attern
\textbf{G}aseous \textbf{D}etectors (MPGDs) first introduced in 1996
(<a href="./bibliography.html#citeproc_bib_item_94">Giomataris et al. 1996</a>; <a href="./bibliography.html#citeproc_bib_item_93">Giomataris 1998</a>). The modern Micromegas is
the Microbulk Micromegas (<a href="./bibliography.html#citeproc_bib_item_11">Andriamonje et al. 2010</a>).
</p>

<p>
Interestingly, the name Micromegas is based on the novella Micromégas
by Voltaire published in 1752 (<a href="./bibliography.html#citeproc_bib_item_226">Voltaire 1752</a>), an early
example of a science fiction story. (<a href="./bibliography.html#citeproc_bib_item_94">Giomataris et al. 1996</a>)
</p>

<p>
These detectors are – as the name implies – gaseous detectors
containing a &apos;micro mesh&apos;. In the most basic form they are a made of a
closed detector volume that is filled with a suitable gas, allowing
for ionization (often argon based gas mixtures are used; xenon based
detectors for axion helioscopes are in the prototype phase). The
volume is split into two different sections, a large drift volume
typically \(\mathcal{O}(\text{few }\si{cm})\) and an amplification
region, sized \(\mathcal{O}(\SIrange{50}{100}{μm})\). At the top of the
volume is a cathode to apply an electric field. Below the mesh is the
readout area at the bottom of the volume. In standard Micromegas
detectors, strips or pads are used as a readout. The electric field in
the drift region is strong enough to avoid recombination of the
created electron-ion pairs and to provide reasonably fast drift
velocities \(\mathcal{O}(\si{cm.μs⁻¹})\). The amplification gap on the
other hand is precisely used to multiply the primary electrons using
an avalanche effect. Thus, the electric field reaches values of
\(\mathcal{O}(\SI{50}{kV.cm⁻¹})\). These drift and amplification volumes
are achieved by an electric field between a cathode and the mesh as
well as the mesh and the readout area.
</p>

<p>
Fig. <a href="micromegas_schematic">1</a> shows a schematic for the general working
principle of such detectors
</p>


<figure id="micromegas_schematic">
<img src="./figs/home/basti/org/Figs/thesis/detectors/micromegas_schematic.svg" class="org-svg" alt="micromegas_schematic.svg" />

<figcaption>Figure 1: <span class="figure-number">Figure 13: </span>Working principle of a general Micromegas detector. Specific distances and gas mixture are exemplary. An ionizing photon enters through the detector window into the gas-filled detector body. After a certain distance it produces a photoelectron, which ionizes further gas molecules for a specific number of primary electrons (depending on the incoming photon&apos;s energy) and gas mixture. The primary electrons drift towards the micromesh due to the drift voltage, thereby experiencing diffusion. In the much higher voltage in the amplification gap an avalanche of electrons is produced, enough to trigger the readout electronics (strips or pads).</figcaption>
</figure>
</div>
</div>


<div class="outline-3" id="outline-container-sec:detector:timepix">
<h3 id="sec:detector:timepix"><span class="section-number-3">7.2.</span> Timepix ASIC</h3>
<div class="outline-text-3" id="text-sec:detector:timepix">
<p>
The Timepix ASIC (Application Specific Integrated Circuit) is a \(256 ×
256\) pixel ASIC with each pixel \(\num{55}·\SI{55}{μm^2}\) in size. It
is based on the Medipix ASIC, developed for medical imaging
applications by the Medipix Collaboration (<a href="./bibliography.html#citeproc_bib_item_150">Llopart et al. 2002</a>). The pixels are
distributed over an active area of
\(\num{1.41}\times\SI{1.41}{\cm^2}\). Each pixel contains a charge
sensitive amplifier, a single threshold discriminator and a
\(\SI{14}{bit}\) pseudo random counting logic. It requires use of an
external clock, in the range of \(\SIrange{10}{150}{MHz}\), with
\(\SI{40}{MHz}\) being the clock frequency used for the applications in
this thesis. (<a href="./bibliography.html#citeproc_bib_item_146">Llopart Cudie 2007</a>; <a href="./bibliography.html#citeproc_bib_item_149">Llopart et al. 2007</a>; <a href="./bibliography.html#citeproc_bib_item_147">Llopart and Poikela 2006</a>)
A good overview of the Timepix is also given in
(<a href="./bibliography.html#citeproc_bib_item_151">Lupberger 2016</a>). A picture of a Timepix ASIC is shown in
fig. <a href="#fig:detector:timepix_asic">2(a)</a>.
</p>

<p>
The Timepix uses a shutter based readout, either with a fixed shutter
time or using an external trigger to close a frame. After the shutter
is closed in the Timepix, the readout is performed during which the
detector is insensitive. Each pixel further can work in four
different modes:
</p>

<dl class="org-dl">
<dt>hit counting mode / single hit mode</dt><dd>simply counts the number of
times the threshold of a pixel was crossed (or whether a pixel was
activated once in single hit mode).</dd>
<dt>\textbf{T}ime \textbf{o}ver \textbf{T}hreshold (ToT)</dt><dd>In the ToT
mode the counter of a pixel will count the number of clock cycles
that the charge on the pixel exceeds the set threshold, which is set
by an \(\SI{8}{bit}\) \textbf{D}igital to \textbf{A}nalog
\textbf{C}onverter (DAC) while the shutter is open. ToT is
equivalent to the collected charge of each pixel.</dd>
<dt>\textbf{T}ime \textbf{o}f \textbf{A}rrival (ToA)</dt><dd>The ToA mode
records the number of clock cycles from the first time the pixel&apos;s
threshold is exceeded to the end of the shutter window. Thus, it
allows to calculate the time at which the pixel first crossed the
threshold.</dd>
</dl>

<p>
In the context of this thesis only the ToT mode was used.  
</p>
</div>

<div class="outline-4" id="outline-container-sec:detector:timepix3">
<h4 id="sec:detector:timepix3"><span class="section-number-4">7.2.1.</span> Timepix3</h4>
<div class="outline-text-4" id="text-sec:detector:timepix3">
<p>
The Timepix3 is the successor of the
Timepix. (<a href="./bibliography.html#citeproc_bib_item_177">Poikela et al. 2014</a>; <a href="./bibliography.html#citeproc_bib_item_148">Llopart and Poikela 2015</a>) It is generally
similar to the Timepix, but would provide 3 important advantages if
used in a gaseous detector for the applications in this thesis:
</p>
<ul class="org-ul">
<li>clock rates of up to \SI{300}{MHz} for higher possible data rates
(less interesting for data taking in an axion helioscope)</li>
<li>a stream based data readout. This means no fixed shutter times and
no dead time during readout. Instead data is sent out when it is
recorded in parallel.</li>
<li>each pixel can record ToT <i>and</i> ToA information at the same
time. This allows to record the charge recorded by a pixel as well
as the time it was activated, yielding 3D event reconstruction with
precise charge information.</li>
</ul>

<p>
An open source readout was developed by the University of Bonn and is
available under (<a href="./bibliography.html#citeproc_bib_item_99">Gruber et al. 2023</a>) <sup>  <a role="doc-backlink" class="footref" id="fnr.1" href="#fn.1">1</a></sup>. A gaseous
detector based on this is currently in the prototyping phase, see the
upcoming (<a href="./bibliography.html#citeproc_bib_item_193">Schiffer 2024</a>).
</p>
</div>
</div>
</div>

<div class="outline-3" id="outline-container-sec:detector:gridpix">
<h3 id="sec:detector:gridpix"><span class="section-number-3">7.3.</span> GridPix</h3>
<div class="outline-text-3" id="text-sec:detector:gridpix">
<p>
First experiments of combining a Micromegas with a Timepix readout
were done in 2005 (<a href="./bibliography.html#citeproc_bib_item_58">Campbell et al. 2005</a>) by using classical
approaches to place a micromesh on top of the Timepix, at the time
still called <i>TimePixGrid</i>. While this worked in principle, it showed
a Moiré pattern, due to slight misalignment between the holes of the
micromesh and the pixels of the Timepix. Shortly after, an approach
based on photolithographic post-processing was developed to perfectly
align the Timepix pixels each with a hole of a micromesh
(<a href="./bibliography.html#citeproc_bib_item_61">Chefdeville et al. 2006</a>), called the <i>InGrid</i> (integrated grid). The
commonly used name for a gaseous detector using an InGrid is
GridPix. For an overview of the process to produce InGrids nowadays,
see (<a href="./bibliography.html#citeproc_bib_item_192">Scharenberg 2019</a>).
</p>

<p>
The InGrid consists of a \(\SI{1}{μm}\) thick aluminum grid, resting on
small pillars \(\SI{50}{μm}\) above the Timepix. A silicon-nitride
\(\ce{Si_x N_y}\) <sup>  <a role="doc-backlink" class="footref" id="fnr.2" href="#fn.2">2</a></sup> layer protects the Timepix from
direct exposure to the amplification processes. The main advantage
over previous Micromegas technologies of the GridPix is its ability to
detect single electrons.  As long as the diffusion distance is long
enough to avoid multiple electrons entering a single hole of the
InGrid, each primary electron produced during the initial ionization
event is recorded. Fig. <a href="#fig:detector:ingrid_explanation">2(b)</a> shows an
image of such an InGrid.
</p>


<figure class="figure-wrapper" id="fig:detector:timepix_and_ingrid">
<figure class="subfigure" id="fig:detector:timepix_asic" data-width="43%">  <img src="./figs/home/basti/phd/Figs/timepix_gold.png" data-width="94%" />  <figcaption>Figure 2(a): Timepix ASIC</figcaption></figure> <figure class="subfigure" id="fig:detector:ingrid_explanation" data-width="55%">  <img src="./figs/home/basti/phd/Figs/ingrid_principle.svg" data-width="94%" />  <figcaption>Figure 2(b): InGrid</figcaption></figure>
<figcaption>Figure 2: <a href="#fig:detector:timepix_asic">2(a)</a> Picture of a bare Timepix ASIC. <a href="#fig:detector:ingrid_explanation">2(b)</a> Image of an InGrid, which was partially cut for inspection under an
          electron microscope. The pillars support the micromesh and
          have a height of $\SI{50}{μm}$. Each hole is perfectly aligned with
          a pixel of the Timepix below. Typical voltages applied between
          the grid and the Timepix are shown.</figcaption>
</figure>
</div>
</div>

<div class="outline-3" id="outline-container-sec:detector:detector_2014_15">
<h3 id="sec:detector:detector_2014_15"><span class="section-number-3">7.4.</span> 2014 / 2015 GridPix detector for CAST</h3>
<div class="outline-text-3" id="text-sec:detector:detector_2014_15">
<p>
In the course of (<a href="./bibliography.html#citeproc_bib_item_137">Krieger 2018</a>) a first GridPix based
detector for usage at an axion helioscope, CAST, was developed. While
the main result was on the coupling constant of the chameleon
particle, an axion-electron coupling result was computed in
(<a href="./bibliography.html#citeproc_bib_item_196">Schmidt 2016</a>).
</p>

<p>
The detector consists of a single GridPix in a \(\SI{78}{mm}\) diameter
gas volume and a drift distance of \(\SI{3}{cm}\). The detector has a
\(\SI{2}{μm}\) thick Mylar (\(\ce{C10 H8 O4}\)) entrance window for
X-rays. This detector serves as the foundation the detector used in
the course of this thesis was built on. See
fig. <a href="#fig:detector:exploded_schematic">3</a> for an exploded schematic of the
detector. Further, fig. <a href="#fig:detector:background_rate_2014">4</a> shows the
achieved background rate of this detector in the center \(\num{5}
\times \SI{5}{mm^2}\) region of the detector. The background rate shows
the copper Kα line near \(\SI{8}{keV}\), possibly overlaid with a muon
contribution as well as the expected argon Kα lines at
\(\SI{3}{keV}\). Below \(\SI{2}{keV}\) the background rises the lower the
energy becomes, likely due to background- and signal-like events being
less geometrically different at low energies (fewer pixels). The
average background rate in the range from \(\SIrange{0}{8}{keV}\) is
\(\sim\SI{2.9e-05}{keV^{-1}.cm^{-2}.s^{-1}}\).
</p>


<figure id="fig:detector:exploded_schematic">
<img src="./figs/home/basti/org/Figs/ingrid_detector_exploded_krieger_thesis.png" alt="ingrid_detector_exploded_krieger_thesis.png" />

<figcaption>Figure 3: <span class="figure-number">Figure 14: </span>Exploded view of the GridPix detector used during the 2014/15 data taking campaign at CAST. Consists of a \SI{3}{cm} drift volume with a \SI{78}{mm} inner diameter and a single GridPix at the center.</figcaption>
</figure>


<figure id="fig:detector:background_rate_2014">
<img src="./figs/home/basti/phd/Figs/background_rate_2014_gold.svg" class="org-svg" alt="background_rate_2014_gold.svg" />

<figcaption>Figure 4: <span class="figure-number">Figure 15: </span>Background rate in the center \(\num{5} \times \SI{5}{mm^2}\) for the GridPix used in 2014/15 at CAST. It corresponds to a background rate of \(\sim\SI{2.9e-05}{keV^{-1}.cm^{-2}.s^{-1}}\) in the range from \(\SIrange{0}{8}{keV}\).</figcaption>
</figure>
</div>
</div>

<div class="outline-3" id="outline-container-sec:detector:detector_overview">
<h3 id="sec:detector:detector_overview"><span class="section-number-3">7.5.</span> Septemboard detector overview</h3>
<div class="outline-text-3" id="text-sec:detector:detector_overview">
<p>
Generally, the detector follows the same design as the old detector
shown in sec. <a href="./septemboard.html#sec:detector:detector_2014_15">7.4</a>, mainly so that mounting
it inside of the lead shielding and to the vacuum pipes at CAST is
possible without significant changes. An exploded view of the full
detector can be seen in fig. <a href="#fig:detector:full_septemboard_exploded">5</a>.
</p>

<p>
At the center of the new detector is the &apos;septemboard&apos;, 7 GridPixes
replace the single GridPix on the carrier board,
sec. <a href="./septemboard.html#sec:detector:septemboard">7.10</a>. Analogue signals induced by the
amplified charges on the center GridPix are now read out using a flash
ADC (FADC), sec. <a href="./septemboard.html#sec:detector:fadc">7.8</a>. The housing with an inner
diameter of \(\SI{78}{mm}\) is again made of acrylic glass, same as in
the old detector. The detector entrance window is replaced by a
\(\SI{300}{nm}\) \ccsini window (sec. <a href="./septemboard.html#sec:detector:sin_window">7.9</a>),
which also acts as part of the detector cathode. The copper anode
slots in right above the septemboard. The carrier board sits on the
intermediate board. Below the intermediate board is a bespoke water
cooling made of oxygen-free copper to cool the heat emitted by the
additional 6 GridPixes, sec. <a href="./septemboard.html#sec:detector:water_cooling">7.11</a>. On the
underside of the intermediate board is a new small silicone
photomultiplier (SiPM), sec. <a href="./septemboard.html#sec:detector:scintillators">7.7</a>. Finally, a
large veto scintillator is installed above the detector setup at CAST,
also sec. <a href="./septemboard.html#sec:detector:scintillators">7.7</a>.
</p>

<p>
During developments multiple septemboards were built and tested. The
septemboard used in the final detector is septemboard &apos;H&apos;. The GridPixes of
the final board are listed in tab. <a href="#tab:detector:septem_h_chips">3</a>.
</p>

<table id="tab:detector:septem_h_chips">
<caption class="t-above"><span class="table-number">Table 3:</span> Overview of the different chips on septemboard H. The first part of the name corresponds to the position on the wafer and <code>W69</code> is Timepix wafer number \num{69}.</caption>

<colgroup>
<col class="org-left" />

<col class="org-right" />
</colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Chip</th>
<th class="org-right" scope="col">Number</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">E 6 W69</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">K 6 W69</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">H 9 W69</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">H10 W69</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">G10 W69</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">D 9 W69</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-left">L 8 W69</td>
<td class="org-right">6</td>
</tr>
</tbody>
</table>



<figure id="fig:detector:full_septemboard_exploded">
<img src="./figs/home/basti/phd/Figs/detector/detector-mk4c-assembly-exploded-whitebg-no-cables-cropped.jpg" alt="detector-mk4c-assembly-exploded-whitebg-no-cables-cropped.jpg" />

<figcaption>Figure 5: <span class="figure-number">Figure 16: </span>Exploded view of the main GridPix septemboard detector. The FADC and large veto scintillator paddle are not shown for obvious reasons. At the center of the detector is the &apos;septemboard&apos;, 7 GridPixes on a carrier board. The housing is made of acrylic glass, same as in the old detector. The top shows the \SI{300}{nm} \ce{Si_3 N_4} window. Below the intermediate board is the water cooling made of pure copper. At the bottom, the SiPM veto scintillator can be seen.</figcaption>
</figure>
</div>
</div>

<div class="outline-3" id="outline-container-orgb47d68b">
<h3 id="orgb47d68b"><span class="section-number-3">7.6.</span> Detector readout system</h3>
<div class="outline-text-3" id="text-7-6">
<p>
The detector is operated by a Xilinx Virtex-6 \textbf{F}ield
\textbf{P}rogrammable \textbf{G}ate \textbf{A}rray (FPGA) in the form
of a Virtex-6 ML605 evaluation board. <sup>  <a role="doc-backlink" class="footref" id="fnr.3" href="#fn.3">3</a></sup> It is
connected to the intermediate board via two
\textbf{H}igh-\textbf{D}efinition \textbf{M}ultimedia
\textbf{I}nterface (HDMI) cables. The Virtex-6 contains the firmware
controlling the Timepix ASICs and correlating the scintillator and
FADC signals (see appendix sec. <a href="./daq.html#sec:daq:tof">17.1</a>), the Timepix Operating Firmware
(TOF). The high voltage (HV) supply both for the septemboard as well
as for the scintillators sit inside a VME crate, which also houses the
FADC. A USB connection is used to read out and control the FADC and HV
supply via the computer running the data acquisition and control
software (see sec. <a href="./daq.html#sec:daq:tos">17.2</a>), the Timepix Operating Software
(TOS). A schematic of this setup is shown in
fig. <a href="#fig:detector:flowchart_setup">6</a>, which leaves out the SiPM and
temperature readout.
</p>


<figure id="fig:detector:flowchart_setup">
<img src="./figs/home/basti/org/Doc/Detector/figs/2016_detector_setup_schematic.svg" class="org-svg" alt="2016_detector_setup_schematic.svg" />

<figcaption>Figure 6: <span class="figure-number">Figure 17: </span>Flowchart of the whole detector and readout system</figcaption>
</figure>
</div>
</div>


<div class="outline-3" id="outline-container-sec:detector:scintillators">
<h3 id="sec:detector:scintillators"><span class="section-number-3">7.7.</span> Scintillator vetoes</h3>
<div class="outline-text-3" id="text-sec:detector:scintillators">
<p>
The first general improvement is the addition of two scintillators for
veto purposes. While both have slightly different goals, each is there
to help with the removal of muon signals or muon induced events (for
example X-ray fluorescence) in the detector. Given that cosmic muons
(ref. section <a href="./theory_detector.html#sec:theory:cosmic_radiation">6.2</a>) dominate the background by
flux, statistically there is a high chance of muons creating X-ray
like signatures in the detector. By tagging muons before they interact
near the detector, these can be correlated with events seen on the
GridPix and thus possibly be vetoed if precise time information is
available.
</p>

<p>
The first scintillator is a large &apos;paddle&apos; installed above the
detector and beamline, aiming to tag a large fraction of cosmic muons
traversing in the area around the detector. It has a Canberra 2007
base and the photomultiplier tube (PMT) is a Bicron
Corp. 31.49x15.74M2BC408/2-X (first two numbers: dimensions in
inches). The full outer dimensions of the scintillator paddle are
closer to \(\SI{42}{cm} \times \SI{82}{cm}\). It is the same
scintillator paddle used during the Micromegas data taking behind the
LLNL telescope prior and after the data taking campaign with the
detector described in this thesis.
</p>

<p>
For this scintillator, muons which traverse through it and the gaseous
detector volume are not the main use case. They can be easily
identified by the geometric properties of the induced tracks (their
zenith angles are relatively small, resulting in track like signatures
as the GridPix readout is orthogonal to the zenith angle). There is a
small chance however that a muon can ionize an atom of the detector
material, which may emit an X-ray upon recombination. One particular
source of background can be attributed to the presence of copper whose
Kα lines are at \(\sim\SI{8.04}{\keV}\) as well as fluorescence of the
argon gas with its Kα lines at \(\sim\SI{2.95}{keV}\) (see. table
<a href="#tab:theory:xray_fluorescence">1</a> in sec. <a href="./theory_detector.html#sec:theory:xray_fluorescence">6.1.4</a> and
sec. <a href="./theory_detector.html#sec:theory:xray_fluorescence">6.1.4</a>).
</p>

<p>
Fig. <a href="#fig:detector:fadc_veto_paddle_expl">7(a)</a> shows a schematic of a
side view of the detector chamber with the scintillator paddle on top.
When a muon traverses the scintillator, a counter \(t_{\text{Veto}}\)
starts on the FPGA. Two different cases are shown. In the extreme, a
muon may traverse close to the cathode or close to the anode / readout
plane. This changes the time of the total drift time and therefore the
time difference between the trigger time \(t_{\text{Veto}}\) and the
readout time, which in the readout is precisely the value of the
counter on the FPGA. The drift velocity of \(\sim\SI{2}{cm.μs⁻¹}\) and
height of the detector chamber (\(\SI{3}{cm}\)) therefore allow to set
an upper limit on the maximum time between a veto paddle trigger and
the GridPix readout of about \(\SI{1.5}{μs}\). At a clock speed of
\(\SI{40}{MHz}\) this corresponds to \(\SI{60}{clock\;cycles}\), a number
we will later try to see in the data (see
sec. <a href="./background.html#sec:background:scinti_veto">12.5.1</a>]]). As the location at which the muon
traverses through the detector is random and homogeneous throughout
the detection volume, we expect to see a flat distribution up to the
maximum possible time and then a sharp drop (equivalent to muons at
the cathode).
</p>

<p>
The second scintillator is a small silicon photomultiplier (SiPM)
installed on the underside of the PCB on which the septemboard is
installed. This scintillator was calibrated and set up as part of
(<a href="./bibliography.html#citeproc_bib_item_204">Schmitz 2017</a>). We are interested in tagging precisely those muons,
which enter the detector orthogonally to the readout plane. This
implies zenith angles of almost \(\SI{90}{°}\) such that the elongation
in the transverse direction of the muon track is small enough to
result in a small eccentricity. From the Bethe equation the mean
energy loss of muons in the used gas mixture is about \(\SI{8}{\keV}\)
along the \(\SI{3}{\cm}\) of drift volume in the detector (see
fig. <a href="#fig:theory:muon_argon_3cm_bethe_loss">11</a> for the energy loss). This
coincides with the copper Kα lines and should lead to another source
of background in this energy range. Although the muon background will
have a much wider energy distribution than the copper lines, which are
dominated by the energy resolution of the detector. In a similar
manner to the veto paddle we can make an estimate on the typical time
scales associated from the time of the scintillator trigger to the
GridPix detection. A muon that traverses orthogonally trough the
detector can be taken to leave an instant ionization track and trigger
the SiPM at the same time (\(\mathcal{O}(\SI{100}{ps}) \ll \SI{25}{ns}\)
for one clock cycle). As such, the relevant time scale is the drift
time until enough charge has drifted towards the grid as to pass the
activation threshold.
</p>

<p>
Ionization of a muon is a statistical process, as indicated in
fig. <a href="#fig:detector:fadc_sipm_expl">7(b)</a>. Depending on the density of the
charge cloud for muons orthogonal to readout plane, time to accumulate
enough charge to trigger FADC differs. With an average energy
deposition of a muon in argon gas of \(\sim\SI{2.67}{keV.cm^{-1}}\), and
drift velocity again of \(\SI{2}{cm.μs⁻¹}\) the accumulation time can be
estimated. For example assuming an FADC activation threshold of
\(\SI{1.5}{keV}\) the necessary charge is accumulated on
\(\SI{0.56}{cm}\), which takes about \(\SI{280}{ns} \approx
\SI{11}{clock.cycles}\) to accumulate. Different tracks will have
deposited different amounts of energy. Therefore, we expect a peak at
relatively low clock cycles with a tail up to the same
\(\SI{60}{clock.cycles}\) (in case the full \(\SI{3}{cm}\) track needs to
be accumulated to activate the FADC).
</p>


<figure class="figure-wrapper" id="fig:detector:fadc_scintillators_explanation">
<figure class="subfigure" id="fig:detector:fadc_veto_paddle_expl" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/fadc_scintillators/FADC_veto_explanation_StixTwo.svg" data-width="94%" />  <figcaption>Figure 7(a): Veto paddle</figcaption></figure> <figure class="subfigure" id="fig:detector:fadc_sipm_expl" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/fadc_scintillators/FADC_sipm_explanation_StixTwo.svg" data-width="94%" />  <figcaption>Figure 7(b): SiPM</figcaption></figure>
<figcaption>Figure 7: <a href="#fig:detector:fadc_veto_paddle_expl">7(a)</a>Schematic of expected signals for different muons from the zenith passing through scintillator
          paddle and detector. $t_{\text{Veto}}$ marks beginning of a counter. Where the muon
          traverses changes drift time and thus time difference between two times. <a href="#fig:detector:fadc_sipm_expl">7(b)</a>Ionization of a muon is a statistical process. Depending on the density of the charge cloud
           for muons orthogonal to readout plane, time to accumulate enough charge to trigger FADC differs.</figcaption>
</figure>
</div>



<div class="outline-4" id="outline-container-orgaea94d9">
<h4 id="orgaea94d9"><span class="section-number-4">7.7.1.</span> Discussion of orthogonal muons on the FADC   <span class="tag">  <span class="extended">extended</span></span></h4>
<div class="outline-text-4" id="text-7-7-1">
<p>
While writing the thesis at some point I had the following thoughs:
</p>
<blockquote>
<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>QUESTION</b>: This is <b>VERY IMPORTANT</b> for our interpretation.
Given the &apos;slow&apos; drift velocity of about 2cm/μs, this means
orthogonal muons of course take about 1.5μs to traverse the
detector. The FADC trigger window is 2560 ns = 2.56 μs.
So: Does the FADC even <b>TRIGGER</b> if the charge accumulates that
slowly??? <b>UHHHHHH</b>
I mean from this we expect to have signals that are extremely long,
no? 1.5/2.5 = 0.58 of the whole trigger window! In <b>RISING EDGE</b> Or
rather a sort of flat thing, as the charge is removed &apos;quickly&apos; on
those time scales. Very confusing thought….
I mean there is a chance the FADC <b>DID NOT</b> trigger in those events,
which could explain why the FADC + SIPM aren&apos;t that effective!
-&gt; We <b>could</b> study this a bit, if we look into the FADC dataset in
which we placed the detector towards the zenith. Question: what does
the data look like, in which the <b>FADC DID NOT TRIGGER</b>? If there is
significant contribution of spherical events of ~8 keV then DUHHH.</li>
</ul>
</blockquote>

<p>
To investigate this we can use <code>plotData</code> from <code>TimepixAnalysis</code> to
make a bunch of plots comparing properties like the energy of clusters
with and without FADC. Both for the raw data as well as for the
results of the <code>likelihood</code> application (i.e. after all cuts).
</p>

<p>
We will use the entire Run-3 dataset for both cases, because the
scintillators were fully working in those.
</p>

<p>
First the plots of the raw data without FADC:
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/CastData/data/DataRuns2018_Reco.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, -0.1, 0.5)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold
</pre>
</div>

<p>
where we only plot chip 3 in the center 5·5 cm² and apply the cut to
the <code>fadcReadout</code> flag (such that we avoid any floating point
issues). <code>fadcReadout == 0</code> means no FADC and <code>1</code> means FADC.
</p>

<p>
Let&apos;s wrap them all up in one PDF:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/DataRuns2018_Reco_2023-10-03_22-41-58
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_no_fadc_histograms.pdf
</pre>
</div>


<figure id="org322452b">
<img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_no_fadc_histograms.svg" class="org-svg" alt="run3_no_fadc_histograms.svg" />

</figure>

<p>
Now the same <span class="underline">with</span> the FADC. Note for this plot change the rise time
in <code>config.toml</code> to 2500 upper and 500 bins!
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/CastData/data/DataRuns2018_Reco.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, 0.5, 1.1)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold <span style="color: #E6DB74; font-weight: bold;">\</span>
    --quiet
</pre>
</div>

<p>
Let&apos;s wrap them all up in one PDF:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/DataRuns2018_Reco_2023-10-03_23-45-37
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_with_fadc_histograms.pdf
</pre>
</div>


<figure id="org5bfffac">
<img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_with_fadc_histograms.svg" class="org-svg" alt="run3_with_fadc_histograms.svg" />

</figure>


<p>
And now for the result of the data with all cuts applied:
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/org/resources/lhood_lnL_04_07_23/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, -0.1, 0.5)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster_2023-10-03_22-46-10
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_lhood_no_fadc_histograms.pdf
</pre>
</div>


<figure id="org7f86642">
<img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_no_fadc_histograms.svg" class="org-svg" alt="run3_lhood_no_fadc_histograms.svg" />

</figure>

<div class="org-src-container">
<pre class="src src-sh">plotData <span style="color: #E6DB74; font-weight: bold;">\</span>
    --h5file ~/org/resources/lhood_lnL_04_07_23/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --runType=rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
    --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
    --ingrid --fadc <span style="color: #E6DB74; font-weight: bold;">\</span>
    --cuts <span style="color: #E6DB74;">&apos;(&quot;../fadcReadout&quot;, 0.5, 1.1)&apos;</span> <span style="color: #E6DB74; font-weight: bold;">\</span>
    --applyAllCuts <span style="color: #E6DB74; font-weight: bold;">\</span>
    --chips 3 <span style="color: #E6DB74; font-weight: bold;">\</span>
    --region crGold
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FD971F;">dir</span>=figs/lhood_c18_R3_crAll_sEff_0.8_lnL_scinti_fadc_septem_line_vQ_0.99_default_cluster_2023-10-03_22-46-44
pdfunite $<span style="color: #FD971F;">dir</span>/*.pdf run3_lhood_with_fadc_histograms.pdf
</pre>
</div>


<figure id="org853d803">
<img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_with_fadc_histograms.svg" class="org-svg" alt="run3_lhood_with_fadc_histograms.svg" />

</figure>


<p>
To summarize the results:
</p>
<ul class="org-ul">
<li><img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_no_fadc_histograms.svg" class="org-svg" alt="run3_no_fadc_histograms.svg" />
-&gt; This file shows that there are barely any events near the
\(\SI{8}{keV}\) range for events without an FADC trigger. This already
seems to indicate that orthogonal muons <span class="underline">should</span> be triggering the
FADC.</li>
<li><img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_with_fadc_histograms.svg" class="org-svg" alt="run3_with_fadc_histograms.svg" />
-&gt; Shows much higher statistics in the same range. Rise time shows a
very long tail, but no visible peaks at higher values.</li>
<li><img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_no_fadc_histograms.svg" class="org-svg" alt="run3_lhood_no_fadc_histograms.svg" />
-&gt; There are literally <b>no</b> events in the \(\SI{8}{keV}\) range after
the likelihood cuts without an FADC trigger!</li>
<li><img src="./figs/home/basti/org/Figs/statusAndProgress/FADC/orthogonalMuonsOnFadc/run3_lhood_with_fadc_histograms.svg" class="org-svg" alt="run3_lhood_with_fadc_histograms.svg" />
-&gt; There are plenty of events in the \(\SI{8}{keV}\) range after
the likelihood cuts <b>with</b> the FADC. And all their rise times are
between 45 and 70 clock cycles! This means either there are no
orthogonal muons in this dataset or for some reason their rise time
is also exceptionally short, which seems surprising.</li>
</ul>

<p>
At this point we could investigate further and see what the
correlation of rise times actually looks like more generally, but
well. At least for <span class="underline">all</span> data the rise time looks unsuspicious. It&apos;s
just a long exponential like tail. 
</p>
</div>
</div>

<div class="outline-4" id="outline-container-org16cdd6e">
<h4 id="org16cdd6e"><span class="section-number-4">7.7.2.</span> Maximum allowed angle before being vetoed   <span class="tag">  <span class="extended">extended</span></span></h4>
<div class="outline-text-4" id="text-7-7-2">
<p>
The section below explains the reasoning behind why an angle of
\(\SI{88}{°}\) was chosen when computing the muon flux at CAST under
shallow angles in sec. <a href="./theory_detector.html#sec:theory:calc_muon_angular_flux">6.2.1</a> and why
this is the smallest angle at which a muon is likely going to pass the
normal likelihood cut and thus requires the SiPM.
</p>

<p>
The reason ϑ = 88° was chosen is due to the restriction on the maximum
allowed eccentricity for a cluster to still end up as a possible
cluster in our 8-10 keV hump. See the <code>eccentricity</code> subplot in
fig. <a href="8_10_keV_properties">12</a>.
</p>


<figure id="8_10_keV_properties">
<img src="./figs/home/basti/org/Figs/statusAndProgress/muonStudies/lhood_facet_remaining_8_10_keV.svg" class="org-svg" alt="lhood_facet_remaining_8_10_keV.svg" />

<figcaption>Figure 12: <span class="figure-number">Figure 18: </span>See the eccentricity subplot for an upper limit on the allowed eccentricity for events in the 8-10 keV hump. Values should not be above ε = 1.3.</figcaption>
</figure>

<p>
From this we can deduce the eccentricity should be smaller than ε =
1.3. What does this imply for the largest possible angles allowed in
our detector? And how does the opening of the &quot;lead pipe window&quot;
correspond to this?
</p>

<p>
Let&apos;s compute by modeling a muon track as a cylinder. Reading off the
mean <code>width</code> from the above fig. to w = 5 mm and taking into account
the detector height of 3 cm we can compute the relation between
different angles and corresponding eccentricities.
</p>

<p>
In addition we will compute the largest possible angle a muon (from
the front of the detector of course) can enter, under which it does
not see the lead shielding.
</p>

<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> unchained, ggplotnim, strformat, sequtils
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">w </span>= <span style="font-style: italic;">5</span>.mm <span style="color: #75715E;"># </span><span style="color: #75715E;">mean width of a track in 8-10keV hump</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h </span>= <span style="font-style: italic;">3</span>.cm <span style="color: #75715E;"># </span><span style="color: #75715E;">detector height</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">computeLength</span><span style="color: #AE81FF;">(</span>α: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: mm =  <span style="color: #E6DB74;">## todo: add degrees?</span>
  <span style="color: #E6DB74;">## α: float # Incidence angle</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">w_prime </span>= w / cos<span style="color: #AE81FF;">(</span>α<span style="color: #AE81FF;">)</span>       <span style="color: #75715E;"># </span><span style="color: #75715E;">projected width taking incidence</span>
                                 <span style="color: #75715E;"># </span><span style="color: #75715E;">angle into account</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">L_prime</span> = tan<span style="color: #AE81FF;">(</span>α<span style="color: #AE81FF;">)</span> * h       <span style="color: #75715E;"># </span><span style="color: #75715E;">projected `</span><span style="color: #AE81FF;">&apos;length&apos;</span><span style="color: #75715E;">` of track</span>
                                 <span style="color: #75715E;"># </span><span style="color: #75715E;">from center to center</span>
  <span style="color: #F92672;">let</span> <span style="color: #66D9EF;">L_full</span> = <span style="color: #66D9EF;">L_prime</span> + w_prime <span style="color: #75715E;"># </span><span style="color: #75715E;">full `</span><span style="color: #AE81FF;">&apos;length&apos;</span><span style="color: #75715E;">` is bottom to top, thus</span>
                                 <span style="color: #75715E;"># </span><span style="color: #75715E;">+ w_prime</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">L_full</span>.to<span style="color: #AE81FF;">(</span>mm<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">computeEccentricity</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">L_full</span>, w: mm, α: <span style="color: #66D9EF;">UnitLess</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">UnitLess</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">w_prime </span>= w / cos<span style="color: #AE81FF;">(</span>α<span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = <span style="color: #66D9EF;">L_full</span> / w_prime

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">αs </span>= linspace<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, degToRad<span style="color: #66D9EF;">(</span><span style="font-style: italic;">25</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span>, <span style="font-style: italic;">1000</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">εs </span>= αs.mapIt<span style="color: #AE81FF;">(</span>it.computeLength.computeEccentricity<span style="color: #66D9EF;">(</span>w, it<span style="color: #66D9EF;">)</span>.<span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">αsDeg </span>= αs.mapIt<span style="color: #AE81FF;">(</span>it.radToDeg<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>αsDeg, εs<span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">maximum eccentricity for text annotation</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">max_εs </span>= <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span>εs<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">max_αs </span>= <span style="color: #F92672;">max</span><span style="color: #AE81FF;">(</span>αsDeg<span style="color: #AE81FF;">)</span>

<span style="color: #75715E;"># </span><span style="color: #75715E;">compute the maximum angle under which `</span><span style="color: #AE81FF;">no</span><span style="color: #75715E;">` lead is seen</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">d_open </span>= <span style="font-style: italic;">28</span>.cm <span style="color: #75715E;"># </span><span style="color: #75715E;">assume 28 cm from readout to end of lead shielding</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h_open </span>= <span style="font-style: italic;">5</span>.cm <span style="color: #75715E;"># </span><span style="color: #75715E;">assume open height is 10 cm, so 5 cm from center</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">α_limit </span>= arctan<span style="color: #AE81FF;">(</span>h_open / d_open<span style="color: #AE81FF;">)</span>.radToDeg

<span style="color: #75715E;"># </span><span style="color: #75715E;">data for the limit of 8-10 keV eccentricity</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">ε_max_hump </span>= <span style="font-style: italic;">1</span>.<span style="font-style: italic;">3</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">1.2 is more reasonable, but 1.3 is the</span>
                     <span style="color: #75715E;"># </span><span style="color: #75715E;">absolute upper limit</span>
<span style="color: #F92672;">echo</span> df.head<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> α_limit
<span style="color: #F92672;">echo</span> ε_max_hump
<span style="color: #F92672;">echo</span> max_εs
<span style="color: #F92672;">echo</span> max_αs
ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;αsDeg&quot;</span>, <span style="color: #E6DB74;">&quot;εs&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = α_limit, yMin = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, yMax = max_εs<span style="color: #66D9EF;">)</span>,
                 color = color<span style="color: #66D9EF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>y = ε_max_hump, xMin = <span style="font-style: italic;">0</span>, xMax = max_αs<span style="color: #66D9EF;">)</span>,
                 color = color<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_text<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = α_limit, y = max_εs + <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>,
                      text = <span style="color: #E6DB74;">&quot;Maximum angle no lead traversed&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_text<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = <span style="font-style: italic;">17</span>.<span style="font-style: italic;">5</span>, y = ε_max_hump + <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span>,
                      text = r<span style="color: #E6DB74;">&quot;Largest $ε$ in $\SIrange{8}{10}{keV}$ hump&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  xlab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;$α$: Incidence angle [°]&quot;</span><span style="color: #AE81FF;">)</span> +
  ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;$ε$: Eccentricity&quot;</span><span style="color: #AE81FF;">)</span> +
  ylim<span style="color: #AE81FF;">(</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
  ggtitle<span style="color: #AE81FF;">(</span>&amp;<span style="color: #E6DB74;">&quot;Expected eccentricity for tracks of mean width {w}&quot;</span><span style="color: #AE81FF;">)</span> +
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;~/phd/Figs/muonStudies/exp_eccentricity_given_incidence_angle.pdf&quot;</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>,
        width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span><span style="color: #AE81FF;">)</span>
</pre>
</div>


<p>
Resulting in fig. <a href="exp_eccentricity_given_incidence_angle">13</a>.
</p>


<figure id="exp_eccentricity_given_incidence_angle">
<img src="./figs/home/basti/phd/Figs/muonStudies/exp_eccentricity_given_incidence_angle.svg" class="org-svg" alt="exp_eccentricity_given_incidence_angle.svg" />

<figcaption>Figure 13: <span class="figure-number">Figure 19: </span>Relationship between incidence angle of muons of a width of 5 mm and their expected mean eccentricity. Drawn as well are the maximum angle under which no lead is seen (from the front) as well as the larges ε seen in the data.</figcaption>
</figure>

<p>
This leads to an upper bound of ~3° from the horizontal. Hence the
(somewhat arbitrary choice) of 88° for the ϑ angle above.
</p>
</div>
</div>
</div>



<div class="outline-3" id="outline-container-sec:detector:fadc">
<h3 id="sec:detector:fadc"><span class="section-number-3">7.8.</span> FADC</h3>
<div class="outline-text-3" id="text-sec:detector:fadc">
<p>
As the Timepix is read out in a shutter based fashion and typical
shutter lengths for low rate experiments are long compared to the rate
of cosmic muons, the scintillators introduced in previous section
require an external trigger to close the Timepix shutter early if a
signal is measured on the Timepix. This is one the main purposes of
the \text{f}lash \textbf{a}nalog to \textbf{d}igital
\textbf{c}onverter (FADC) that is part of the detector. This is done
by decoupling the induced analogue signals from the grid of the center
GridPix.
</p>

<p>
The specific FADC used for the detector is a Caen V1792a. It runs at
an internal \(\SI{50}{MHz}\) or \(\SI{100}{MHz}\) clock and utilizes virtual
frequency multiplication to achieve sampling rates of \(\SI{1}{GHz}\) or
\(\SI{2}{GHz}\), respectively. It has 4 channels, each with a cyclic
register of \(\num{2560}\) channels. At an operating clock frequency of
\(\SI{1}{GHz}\) that means each channel covers the last
\(\sim\SI{2.5}{\micro\second}\) at any time. (<a href="./bibliography.html#citeproc_bib_item_57">CAEN 2010</a>)
</p>

<p>
The raw signal decoupled from the grid is first fed into an Ortec 142
B pre-amplifier and then feeds into an Ortec 474 shaping amplifier,
which integrates and shapes the signal as well as amplifies it. For a
detailed introduction to this FADC system, see the thesis of
A. Deisting (<a href="./bibliography.html#citeproc_bib_item_78">Deisting 2014</a>) and (<a href="./bibliography.html#citeproc_bib_item_196">Schmidt 2016</a>) for further work
integrating it into this detector. In addition see the FADC manual
(<a href="./bibliography.html#citeproc_bib_item_57">CAEN 2010</a>) <sup>  <a role="doc-backlink" class="footref" id="fnr.4" href="#fn.4">4</a></sup> for a deep explanation of the
working principle of this FADC.
</p>

<p>
The analogue signal of the center grid is decoupled via a small
\(C_{\text{dec}} = \SI{10}{nF}\) capacitor in parallel to the high
voltage line. For a schematic of the circuit see
fig. <a href="#fig:detector:fadc_circuit">14</a>. When a primary electron traverses
through a hole in the grid and is amplified, the back flowing ions
induce a small voltage spike on top of the constant high voltage
applied to the grid. The parallel capacitor filters out the constant
high voltage and only transmits the time varying induced signals. Such
signals – the envelope of possibly many primary electrons – are
measured by the FADC.
</p>


<figure id="fig:detector:fadc_circuit">
<img src="./figs/home/basti/phd/Figs/decouple_fadc.svg" class="org-svg" alt="decouple_fadc.svg" />

<figcaption>Figure 14: <span class="figure-number">Figure 20: </span>Schematic of the setup to decouple signals induced on the grid of the InGrid. The signal is decoupled in the sense that the capacitor essentially acts as a low pass filter, thus removing the constant HV. Only the high frequency components of the induced signals on top of the HV pass into the branch leading to the FADC. In the detector of this thesis, a capacitance of \SI{10}{nF} was used instead. The decoupling is implemented on the intermediate board. Schematic taken from <a href="Deisting">Deisting</a>.</figcaption>
</figure>

<p>
This signal can be used for three distinct things:
</p>
<ol class="org-ol">
<li>it may be used as a trigger to close the shutter of the ongoing
event. Ideally, we want to only measure a single physical event
within one shutter window. A long shutter time can statistically
result in multiple events happening, which the FADC trigger helps
to alleviate. This allows us to reduce the number of events with
multiple physical events and acts as a trigger for the
scintillators. This in turn means possible muon induced X-ray
fluorescence can be vetoed.</li>
<li>By nature of the signal production and drift properties of the
primary electrons before they reach the grid, the signal shape can
theoretically be used to determine a rough longitudinal shape of
the event. The length of the FADC event should be proportional to
the size of the primary electron cloud distribution along the
&apos;vertical&apos; detector axis. This potentially allows to differentiate
between a muon traversing orthogonally through the readout plane
and an X-ray due to their longitudinal shape difference, see
sec. <a href="./background.html#sec:background:fadc_veto">12.5.2</a>.</li>
<li>Finally, it provides an independent measure of the collected charge
on the center chip. This will prove useful in understanding the
detector behavior over time later in
sec. <a href="./calibration.html#sec:calib:causes_variability">11.2.1</a>.</li>
</ol>

<p>
The working principle of how the FADC and the scintillators can be
used together to remove certain types of background, by correlating
events in the scintillators, the FADC and the GridPix, is shown in
fig. <a href="#fig:detector:scintillator_fadc_shutter_close">15</a>.
</p>


<figure id="fig:detector:scintillator_fadc_shutter_close">
<img src="./figs/home/basti/phd/Figs/scintillator_fadc_shutter_close.svg" class="org-svg" alt="scintillator_fadc_shutter_close.svg" />

<figcaption>Figure 15: <span class="figure-number">Figure 21: </span>Schematic showing how the FADC and scintillators are used together to tag possible coincidence events and close the shutter early to reduce the likelihood of multi-hit events. If the scintillator triggers when the shutter is open, a clock starts counting up to 4096 clock cycles. On every new trigger this clock is reset. If the FADC triggers, the scintillator clock values are read out and can be used to correlate events in the scintillator with FADC and GridPix information. Further, the FADC trigger is used to close the Timepix shutter \(\SI{5}{μs}\) after the trigger.</figcaption>
</figure>
</div>
</div>

<div class="outline-3" id="outline-container-sec:detector:sin_window">
<h3 id="sec:detector:sin_window"><span class="section-number-3">7.9.</span> SiN window</h3>
<div class="outline-text-3" id="text-sec:detector:sin_window">
<p>
Next up, a major limitation of the previous detector was its limited
combined efficiency below \(\SI{2}{keV}\), due to its \(\SI{2}{μm}\) Mylar
window. Therefore, the next improvement for the new detector is an
ultra-thin silicon nitride \(\ce{Si_3 N_4}\) window of \(\SI{300}{nm}\)
thickness and \(\SI{14}{mm}\) diameter, developed by
Norcada <sup>  <a role="doc-backlink" class="footref" id="fnr.5" href="#fn.5">5</a></sup>. A strongback support structure
consisting of 4 lines of \(\SI{200}{μm}\) thick and \(\SI{500}{μm}\) wide
\(\ce{Si_3 N_4}\), helps to support a pressure difference of up to
\(\SI{1.5}{bar}\). On the outer side a \(\SI{20}{nm}\) thin layer of
aluminum is coated to allow the window to be part of the detector
cathode. The strongback occludes about \(\SI{17}{\%}\) of the full
window area. In reality it is slightly more, as the strongbacks become
somewhat wider towards the edges. In the centermost region they are
straight and in the center \(\num{5} \times \SI{5}{mm²}\) area, they
occlude \(\SI{22.2}{\%}\).
</p>

<p>
Fig. <a href="#fig:detector:strongback_structure_mc">16(a)</a> shows the idealized strongback
structure without a widening towards the edges of the
window. Fig. <a href="#fig:detector:window_image">16(b)</a> shows an image of one such
window under testing conditions in the laboratory, as it withstands a
pressure difference of \(\SI{1.5}{bar}\).
</p>


<figure class="figure-wrapper" id="fig:detector:window_image_and_strongback">
<figure class="subfigure" id="fig:detector:strongback_structure_mc" data-width="49%">  <img src="./figs/home/basti/phd/Figs/SiN_window_occlusion.svg" data-width="99%" />  <figcaption>Figure 16(a): Window strongback schematic</figcaption></figure> <figure class="subfigure" id="fig:detector:window_image" data-width="49%">  <img src="./figs/home/basti/phd/Figs/300nm_SiN_holds.jpg" data-width="99%" />  <figcaption>Figure 16(b): Image</figcaption></figure>
<figcaption>Figure 16: <a href="#fig:detector:strongback_structure_mc">16(a)</a>shows an idealized schematic of the window strongback based on a simple MC simulation. $\SI{22.2}{\percent}$ of the area inside the inner $\num{5} \times \SI{5}{mm^2}$ area (black square) are occluded.<a href="#fig:detector:window_image">16(b)</a>shows an image of one such window while testing in the laboratory, if it holds $\SI{1.5}{bar}$. Image courtesy of Christoph Krieger.</figcaption>
</figure>


<p>
As the main purpose is the increase of transmission at low energies,
fig. <a href="#fig:detector:window_efficiency_comparison">17</a> shows the transmission
of the mylar window of the old detector and the new \(\ce{Si_3 N_4}\)
window in the energy range below \(\SI{3}{keV}\). The \(\ce{Si_3 N_4}\) window
shows a significant increase in transmission below \(\SI{2}{keV}\), which
is very important for the sensitivity in solar axion-electron and
chameleon searches, which both peak near \(\SI{1}{keV}\) in their solar
flux. The window alone significantly increases the signal to noise
ratio of these physics searches.
</p>


<figure id="fig:detector:window_efficiency_comparison">
<img src="./figs/home/basti/phd/Figs/detector/window_transmisson_comparison.svg" class="org-svg" alt="window_transmisson_comparison.svg" />

<figcaption>Figure 17: <span class="figure-number">Figure 22: </span>Comparison of the transmission of a \(\SI{2}{μm}\) Mylar window and a \(\SI{300}{nm}\) \(\ce{Si_3 N_4}\) window. The efficiency gains become more and more pronounced the lower the energy is, aside from the absorption edge of carbon at around \(\SI{250}{eV}\) and above about \(\SI{1.75}{keV}\). In the interesting range around \(\SI{1}{keV}\) significant transmission gains are achieved.</figcaption>
</figure>
</div>

<div class="outline-4" id="outline-container-orgc631c78">
<h4 id="orgc631c78"><span class="section-number-4">7.9.1.</span> Calculation of strongback window structure plot   <span class="tag">  <span class="extended">extended</span></span></h4>
<div class="outline-text-4" id="text-7-9-1">
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #E6DB74;">## Super dumb MC sampling over the entrance window using the Johanna&apos;s code from `</span><span style="color: #AE81FF;">raytracer2018.nim</span><span style="color: #E6DB74;">`</span>
<span style="color: #E6DB74;">## to check the coverage of the strongback of the 2018 window</span>
<span style="color: #E6DB74;">##</span>
<span style="color: #E6DB74;">## Of course one could just color areas based on the analytical description of where the</span>
<span style="color: #E6DB74;">## strongbacks are, but this is more interesting and looks fun. The good thing is it also</span>
<span style="color: #E6DB74;">## allows us to easily compute the fraction of pixels within and outside the strongbacks.</span>
<span style="color: #F92672;">import</span> ggplotnim, random, chroma
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">colorMe</span><span style="color: #AE81FF;">(</span>y: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">bool</span> =
  <span style="color: #F92672;">const</span>
    stripDistWindow = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">3</span>  <span style="color: #75715E;">#</span><span style="color: #75715E;">mm</span>
    stripWidthWindow = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">mm</span>
  <span style="color: #F92672;">if</span> <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &gt; stripDistWindow / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> <span style="color: #F92672;">and</span>
     <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &lt; stripDistWindow / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> + stripWidthWindow <span style="color: #F92672;">or</span>
     <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &gt; <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span> * stripDistWindow + stripWidthWindow <span style="color: #F92672;">and</span>
     <span style="color: #F92672;">abs</span><span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span> &lt; <span style="font-style: italic;">1</span>.<span style="font-style: italic;">5</span> * stripDistWindow + <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span> * stripWidthWindow:
    <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">true</span>
  <span style="color: #F92672;">else</span>:
    <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">false</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">sample</span><span style="color: #AE81FF;">()</span> =
  randomize<span style="color: #AE81FF;">(</span><span style="font-style: italic;">423</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">const</span> <span style="color: #FD971F;">nmc </span>= <span style="font-style: italic;">5_000_000</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">black </span>= color<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dataX </span>= newSeqOfCap<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span>nmc<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">dataY </span>= newSeqOfCap<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span>nmc<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">strongback </span>= newSeqOfCap<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">bool</span><span style="color: #AE81FF;">](</span>nmc<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">for</span> idx <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; nmc:
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">x </span>= rand<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span> .. <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">y </span>= rand<span style="color: #AE81FF;">(</span>-<span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span> .. <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">if</span> x*x + y*y &lt; <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span> * <span style="font-style: italic;">7</span>.<span style="font-style: italic;">0</span>:
      dataX.<span style="color: #F92672;">add</span> x
      dataY.<span style="color: #F92672;">add</span> y
      strongback.<span style="color: #F92672;">add</span> colorMe<span style="color: #AE81FF;">(</span>y<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>dataX, dataY, strongback<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;A fraction of &quot;</span>, df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>`strongback` == <span style="color: #AE81FF;">true</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>.<span style="color: #F92672;">len</span> / df.<span style="color: #F92672;">len</span>, <span style="color: #E6DB74;">&quot; is occluded by the strongback&quot;</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfGold </span>= df.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #F92672;">abs</span><span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span>`dataX`, <span style="color: #66D9EF;">float</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span> &lt;= <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span> <span style="color: #F92672;">and</span>
                           <span style="color: #F92672;">abs</span><span style="color: #A6E22E;">(</span>idx<span style="color: #E6DB74;">(</span>`dataY`, <span style="color: #66D9EF;">float</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span> &lt;= <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Gold region: A fraction of &quot;</span>, dfGold.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span>`strongback` == <span style="color: #AE81FF;">true</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>.<span style="color: #F92672;">len</span> / dfGold.<span style="color: #F92672;">len</span>, <span style="color: #E6DB74;">&quot; is occluded by the strongback&quot;</span>
  ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;dataX&quot;</span>, <span style="color: #E6DB74;">&quot;dataY&quot;</span>, fill = <span style="color: #E6DB74;">&quot;strongback&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
    geom_point<span style="color: #AE81FF;">(</span>size = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
    <span style="color: #75715E;"># </span><span style="color: #75715E;">draw the gold region as a black rectangle</span>
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>y = <span style="font-style: italic;">0</span>, x = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>y = <span style="font-style: italic;">0</span>, x = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, yMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = <span style="font-style: italic;">0</span>, y = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    geom_linerange<span style="color: #AE81FF;">(</span>aes = aes<span style="color: #66D9EF;">(</span>x = <span style="font-style: italic;">0</span>, y = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMin = -<span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span>, xMax = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">25</span><span style="color: #66D9EF;">)</span>, color = <span style="color: #E6DB74;">&quot;black&quot;</span><span style="color: #AE81FF;">)</span> +
    xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;x [mm]&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;y [mm]&quot;</span><span style="color: #AE81FF;">)</span> +
    ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Idealized layout, strongback in purple&quot;</span><span style="color: #AE81FF;">)</span> +
    themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">640</span>, height = <span style="font-style: italic;">480</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span> +           
    ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/SiN_window_occlusion.pdf&quot;</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span>, dataAsBitmap = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span><span style="color: #75715E;">#</span><span style="color: #75715E;">width = 1150, height = 1000)</span>
sample<span style="color: #AE81FF;">()</span>
</pre>
</div>
</div>
</div>
</div>


<div class="outline-3" id="outline-container-sec:detector:septemboard">
<h3 id="sec:detector:septemboard"><span class="section-number-3">7.10.</span> Septemboard - 6 GridPixes around a center one</h3>
<div class="outline-text-3" id="text-sec:detector:septemboard">
<p>
The main motivation for extending the readout area from a single chip
to a 7 chip readout is to reduce background towards the outer sides of
the chip, in particular in the corners. Against common intuition
however, it also plays a role for events which have cluster centers
near the center of the readout. The latter is, because diffusion can
produce quite large clusters even at low energies. In particular in
lower energy events, tracks may have gaps in them large enough to
avoid being detected as a single cluster for standard radii in cluster
searching algorithms. This is particularly of interest as different
searches produce an &apos;image&apos; at different positions and sizes on the
detector. While the center chip is large enough to fully cover the
image for essentially all models, it may not be in the regions of
lowest background. Hence, improvements to larger areas are needed.
</p>

<p>
The septemboard is implemented in such a way to optimize the loss of
active area due to bonding requirements and general manufacturing
realities. As the Timepix ASIC is a \(\SI{16.1}{mm}\) by \(\SI{14.1}{mm}\)
large chip (the bonding area adding \(\SI{2}{mm}\) on one side), the upper
two rows are installed such that they are inverted to another. The
bonding area is above the upper row and below the center row. The
bottom row again has its bonding area below. This way the top two rows
are as close together as realistically possible, with a decent gap on
the order of \(\SI{2}{mm}\) between the middle and bottom row. Any gap is
potentially problematic as it implies loss of signal in that area,
complicating the possible reconstruction methods. The layout can be
seen in fig. <a href="#fig:detector:occupancy_sparking_run_241">20</a> in the next section.
</p>

<p>
All 7 GridPix are connected in a daisy-chained way. This means that in
particular for data readout, all chips are read out in serial
order. The dead time for readouts therefore is approximately 7 times
the readout time of a single Timepix. A single Timepix has a readout
time of \(\sim\SI{25}{ms}\) at a clock frequency of \(\SI{40}{MHz}\) (the
frequency used for this detector). This leads to an expected readout
time of the full septemboard of
\(\SI{175}{ms}\). <sup>  <a role="doc-backlink" class="footref" id="fnr.6" href="#fn.6">6</a></sup> Such a long readout time
leads to a strong restriction of the possible applications for such a
detector. Fortunately, for the use cases in a very low rate experiment
such as CAST, long shutter times are possible, mitigating the effect
on the fractional dead time to a large extent.
</p>

<p>
Fig. <a href="#fig:detector:cluster_centers_likelihood">18</a> shows a heatmap of all
cluster centers during roughly \(\SI{2000}{h}\) of background data after
passing these clusters through a likelihood based cut method aiming to
filter out non X-ray like clusters (details of this follow later in
sec. <a href="./background.html#sec:background:likelihood_method">12.1</a>). It is clearly visible that the further
a cluster center is towards the chip edges, and especially the
corners, the more likely it is to be considered an X-ray like
cluster. This has an easy geometric explanation. Consider a perfect
track traversing over the whole chip. In this case it is very
eccentric. Move the same track such that its center is in one of the
corners and rotate it by \(\SI{45}{°}\) and suddenly the majority of the
track won&apos;t be detected on the chip anymore. Instead something roughly
circular remains visible, &apos;fooling&apos; the likelihood method. For a
schematic illustrating this, see fig. <a href="#fig:detector:gridpix_ring_veto_idea">19</a>.
</p>

<p>
The septemboard therefore is expected to significantly reduce the
background over the whole center chip, with the biggest effect in the
regions with the most amount of background. 
</p>


<figure id="fig:detector:cluster_centers_likelihood">
<img src="./figs/home/basti/phd/Figs/backgroundClusters/background_cluster_centers.svg" class="org-svg" alt="background_cluster_centers.svg" />

<figcaption>Figure 18: <span class="figure-number">Figure 23: </span>Cluster centers left after likelihood cut applied to about \(\SI{2000}{h}\) of background data. Background increasing dramatically towards edges and corners.</figcaption>
</figure>


<figure id="fig:detector:gridpix_ring_veto_idea">
<img src="./figs/home/basti/org/Figs/InGridSeptemExplanation/septem_explanation_lnL_monokai_StixTwo.svg" class="org-svg" alt="septem_explanation_lnL_monokai_StixTwo.svg" />

<figcaption>Figure 19: <span class="figure-number">Figure 24: </span>Illustration of the basic idea behind the GridPix veto ring. If a cluster on the center chip is X-ray like and near the corners, checking the outer chips close to the corner for a track containing the center cluster can overrule the X-ray like definition of the center chip only.</figcaption>
</figure>
</div>
</div>




<div class="outline-3" id="outline-container-sec:detector:water_cooling">
<h3 id="sec:detector:water_cooling"><span class="section-number-3">7.11.</span> Water cooling and temperature readout for the septemboard</h3>
<div class="outline-text-3" id="text-sec:detector:water_cooling">
<p>
During development of the septemboard one particular set of problems
manifested. While testing a prototype board with 5 active GridPix in a
gaseous detector, the readout was plagued by excessive noise
problems. The detector exhibited a large number of frames with more
than \(\num{4096}\) active pixels (the limit for a zero suppressed
readout) and common pixel values of \(\num{11810}\) indicating overrun ToT
counters. On an occupancy (sum of all active pixels) of the individual
chips, it is quite visible the data is clearly not due to cosmic
background. Fig. <a href="#fig:detector:occupancy_sparking_run_241">20</a> shows such an
occupancy with the color scale topping out at the \(80^{\text{th}}\)
percentile of the counts for each chip individually. The chip in the
bottom left shows a large number of sparks (overlapping half ellipses
pointing downwards) at the top end. Especially the center chip in the
top row shows highly structured activity, which is in contrast to the
expectation of a homogeneous occupancy for a normal background
run. In addition, on all chips some level of general noise on certain
pixels is visible (some being clearly more active than others
resulting in a scatter of &apos;points&apos;).
</p>


<figure id="fig:detector:occupancy_sparking_run_241">
<img src="./figs/home/basti/phd/Figs/detector/sparking/sparking_occupancy_80_quantile_run_241.svg" class="org-svg" alt="sparking_occupancy_80_quantile_run_241.svg" />

<figcaption>Figure 20: <span class="figure-number">Figure 25: </span>Occupancy of a testing background run with \(\mathcal{O}(\SI{1}{s})\) long frames using septemboard F during development without any kind of cooling. This also shows the layout of the full septemboard with realistic spacing.</figcaption>
</figure>

<p>
The intermediate board and carrier board used during these tests were
the first boards equipped with two PT1000 temperature sensors. One on
the bottom side of the carrier board and another on the intermediate
board. Each is read out using a <code>MAX31685</code> micro controllers. Both of
which are communicated with via a <code>MCP2210</code> USB-to-SPI micro
controllers over a single USB port on the intermediate board. The
single <code>MCP2210</code> communicates with both temperature sensors via the
Serial Peripheral Interface (SPI) (see
sec. <a href="./daq.html#sec:daq:temperature_readout">17.2.4</a> for more information about the
temperature logging and readout). In the run shown in
fig. <a href="#fig:detector:occupancy_sparking_run_241">20</a> the temperature sensors
were not functional yet, as the readout software was not written. The
required logic was added to the Timepix Operating Software (TOS), the
readout software of the detector, motivated by this noise activity to
monitor the temperature before and during a data taking period. The
temperature on the carrier board indicated temperatures of
\(\sim\SI{75}{\celsius}\) in background runs similar to the one of
fig. <a href="#fig:detector:occupancy_sparking_run_241">20</a>. One way to get a measure
for the noise-like activity seen on the detector is to look at the
rate of active pixels over time. With values well above numbers
expected due to background, excess temperature seemed a possible cause
for the issues. As no proper cooling mechanism was available, a
regular desk fan was placed pointing at the detector when it was run
without any kind of shielding. This saw the temperature under the
carrier board drop from \(\SI{76}{\celsius}\) down to
\(\SI{68}{\celsius}\). As a result the majority of noise disappeared as
can be seen in fig. <a href="#fig:detector:sparking_run_with_fan_mean_hits">21(b)</a>
with the temperature curve during the full run in
fig. <a href="#fig:detector:sparking_run_with_fan_temps">21(a)</a>. <sup>  <a role="doc-backlink" class="footref" id="fnr.7" href="#fn.7">7</a></sup> <sup>, </sup><sup>  <a role="doc-backlink" class="footref" id="fnr.8" href="#fn.8">8</a></sup>
</p>

<p>
The features visible in the occupancy plots are thus likely multiple
different artifacts due to too high temperatures. A mixture of real
sparks (bottom left chip in
fig. <a href="#fig:detector:occupancy_sparking_run_241">20</a>) and possible
instabilities that possibly affect voltages for the pixels (and thus
change the thresholds of each pixel). As the temperature is measured
on the bottom side of the carrier board, temperatures in the
amplification region are likely higher. 
</p>


<figure class="figure-wrapper" id="fig:detector:sparking_run_with_fan">
<figure class="subfigure" id="fig:detector:sparking_run_with_fan_temps" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/sparking/temperature_sparking_run_268.svg" data-width="99%" />  <figcaption>Figure 21(a): Temperature</figcaption></figure> <figure class="subfigure" id="fig:detector:sparking_run_with_fan_mean_hits" data-width="49%">  <img src="./figs/home/basti/phd/Figs/detector/sparking/mean_hit_rate_sparking_run_268.svg" data-width="99%" />  <figcaption>Figure 21(b): Mean hit rate</figcaption></figure>
<figcaption>Figure 21: <a href="#fig:detector:sparking_run_with_fan_temps">21(a)</a> shows the temperature on the bottom side of the
          carrier board (&apos;septem&apos;) and intermediate board (&apos;IMB&apos;) during the background run. The point at which
          the desk fan is placed next to the detector is clearly visible by the $\SI{8}{\celsius}$ drop in
          temperature from about $\SI{76}{\celsius}$ to $\SI{68}{\celsius}$. <a href="#fig:detector:sparking_run_with_fan_mean_hits">21(b)</a> shows the mean hit rate of each of the 5 chips
          installed on the carrier board at the time during the same run. The placement of the desk fan is easily
          visible as a reduction in mean rate on all chips.</figcaption>
</figure>


<p>
Following this a bespoke water cooling was designed by T. Schiffer,
made from oxygen-free copper with \(\SI{3}{mm}\) channels for water to
circulate through the copper body. (<a href="./bibliography.html#citeproc_bib_item_193">Schiffer 2024</a>) The body has the
same diameter as the intermediate board and is installed right
below. The water circulation is handled by an off-the-shelf pump and
radiator from Alphacool <sup>  <a role="doc-backlink" class="footref" id="fnr.9" href="#fn.9">9</a></sup> intended for water
cooling setups for desktop computers. The pump manages a water flow
rate of about \(\SI{0.3}{\liter\per\minute}\) through the \(\SI{3}{mm}\)
channels in the copper. In common operation the temperatures on the
carrier board are between \(\SIrange{45}{50}{\celsius}\) and noise free
operation is possible.
</p>
</div>

<div class="outline-4" id="outline-container-sec:detector:sparking_behavior">
<h4 id="sec:detector:sparking_behavior"><span class="section-number-4">7.11.1.</span> Sparking behavior   <span class="tag">  <span class="extended">extended</span></span></h4>
<div class="outline-text-4" id="text-sec:detector:sparking_behavior">
<p>
See the mails containing &quot;Septem F&quot; (among other things) for the
information about sparking behavior. From that we can also deduce the
run numbers of the noisy runs (run 241 is one of them); just keep in
mind that the run numbers are overlapping with some CAST run numbers,
as for CAST we started again at 0.
</p>

<p>
Specific run path of noisy run used in occupancy plot above:
<code>Run_241_170216-13-49</code>
So run from February 2017.
</p>


<p>
Let&apos;s plot the temperature during the sparking run in which we
installed the fan.
</p>

<p>
This is essentially a reproducible version of the following plot:
<img src="./figs/home/basti/org/Figs/temps_plot_septemF_76_68deg_1s.svg" class="org-svg" alt="temps_plot_septemF_76_68deg_1s.svg" />
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> ggplotnim, times

<span style="color: #75715E;"># </span><span style="color: #75715E;">Laptop:</span>
<span style="color: #75715E;">#</span><span style="color: #75715E;">const path = &quot;/mnt/1TB/CAST/2017/development/Run_268_170418-05-43/temp_log.txt&quot;</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">Desktop:</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;~/CastData/data/2017/development/Run_268_170418-05-43/temp_log.txt&quot;</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">p</span><span style="color: #AE81FF;">(</span>x: <span style="color: #66D9EF;">string</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">DateTime</span> =
  <span style="color: #FD971F;">result</span> = x.parse<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;YYYY-MM-dd&apos;.&apos;HH:mm:ss&quot;</span>, local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= readCsv<span style="color: #AE81FF;">(</span>path, sep = <span style="color: #E6DB74;">&apos;\t&apos;</span>, skipLines = <span style="font-style: italic;">2</span>, colNames = @<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;IMB&quot;</span>, <span style="color: #E6DB74;">&quot;Septem&quot;</span>, <span style="color: #E6DB74;">&quot;DateTime&quot;</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  .filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">string</span> -&gt; <span style="color: #66D9EF;">bool</span>: p<span style="color: #A6E22E;">(</span>`<span style="color: #66D9EF;">DateTime</span>`<span style="color: #A6E22E;">)</span> &lt; initDateTime<span style="color: #A6E22E;">(</span><span style="font-style: italic;">19</span>, mApr, <span style="font-style: italic;">2017</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, local<span style="color: #E6DB74;">()</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  .gather<span style="color: #AE81FF;">(</span>@<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;IMB&quot;</span>, <span style="color: #E6DB74;">&quot;Septem&quot;</span><span style="color: #66D9EF;">]</span>, <span style="color: #E6DB74;">&quot;Type&quot;</span>, <span style="color: #E6DB74;">&quot;Temperature&quot;</span><span style="color: #AE81FF;">)</span>
  .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span> ~ p<span style="color: #A6E22E;">(</span>`<span style="color: #66D9EF;">DateTime</span>`<span style="color: #A6E22E;">)</span>.toTime<span style="color: #A6E22E;">()</span>.toUnix<span style="color: #A6E22E;">()</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>

<span style="color: #E6DB74;">## XXX: fix plotting of string columns as date scales, due to discrete / continuous mismatch and lacking</span>
<span style="color: #E6DB74;">## `</span><span style="color: #AE81FF;">dataScale</span><span style="color: #E6DB74;">` field</span>
ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span>, <span style="color: #E6DB74;">&quot;Temperature&quot;</span>, color = <span style="color: #E6DB74;">&quot;Type&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  <span style="color: #75715E;"># </span><span style="color: #75715E;">scale_x_continuous() +</span>
  ggtitle<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Temperature on 2017/04/18 with fan&quot;</span><span style="color: #AE81FF;">)</span> + 
  xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Time of day&quot;</span>, margin = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">25</span>, rotate = -<span style="font-style: italic;">45</span>.<span style="font-style: italic;">0</span>, alignTo = <span style="color: #E6DB74;">&quot;right&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Temperature [°C]&quot;</span><span style="color: #AE81FF;">)</span> +
  margin<span style="color: #AE81FF;">(</span>bottom = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span>, right = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> + 
  scale_x_date<span style="color: #AE81FF;">(</span>isTimestamp = <span style="color: #AE81FF;">true</span>,
               formatString = <span style="color: #E6DB74;">&quot;HH:mm:ss&quot;</span>,
               dateSpacing = initDuration<span style="color: #66D9EF;">(</span>hours = <span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>,
               dateAlgo = dtaAddDuration,
               timeZone = local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">420</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/temperature_sparking_run_268.pdf&quot;</span>,
        width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span>, useTeX = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
df.writeCsv<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/resources/temperature_sparking_run_268.csv&quot;</span><span style="color: #AE81FF;">)</span>  
</pre>
</div>

<p>
Next up we need to compute the mean hit rate of the four most active
chips and plot it against time.
</p>

<p>
How will we go about doing that? Read and reconstruct the run, then
manually extract hits per time, bin by time and that&apos;s it?
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #75715E;"># </span><span style="color: #75715E;">cd /mnt/1TB/CAST/2017/development/</span>
<span style="color: #F92672;">cd</span> ~/CastData/data/2017/development/
raw_data_manipulation -p Run_268_170418-05-43 --runType background --out raw_268_sparking.h5
reconstruction -i raw_268_sparking.h5 --out reco_268_sparking.h5
</pre>
</div>

<p>
With the resulting file, we can now generate the plot of the hits over
time.
</p>

<p>
This is a reproducible version of the following plot:
<img src="./figs/home/basti/org/Figs/hitrate_per_time_septemF_76_68deg_1s.svg" class="org-svg" alt="hitrate_per_time_septemF_76_68deg_1s.svg" />
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / <span style="color: #AE81FF;">[</span>options, sequtils, times<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> ggplotnim, nimhdf5, unchained
defUnit<span style="color: #AE81FF;">(</span>Second⁻¹<span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">import</span> ingrid / tos_helpers
<span style="color: #75715E;"># </span><span style="color: #75715E;">Laptop</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">const path = &quot;/mnt/1TB/CAST/2017/development/reco_268_sparking.h5&quot;</span>
<span style="color: #75715E;"># </span><span style="color: #75715E;">Desktop</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;~/CastData/data/2017/development/reco_268_sparking.h5&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>path, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">var</span> <span style="color: #FD971F;">df </span>= newDataFrame<span style="color: #AE81FF;">()</span>
<span style="color: #F92672;">var</span> <span style="color: #FD971F;">dfR </span>= newDataFrame<span style="color: #AE81FF;">()</span>
<span style="color: #F92672;">for</span> chip <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; <span style="font-style: italic;">5</span>:
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dsets </span>= @<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;hits&quot;</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfC </span>= h5f.readRunDsets<span style="color: #AE81FF;">(</span>
    <span style="font-style: italic;">268</span>,
    chipDsets = some<span style="color: #66D9EF;">(</span><span style="color: #A6E22E;">(</span>chip: chip, dsets: dsets<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>,
    commonDsets = @<span style="color: #66D9EF;">[</span><span style="color: #E6DB74;">&quot;timestamp&quot;</span><span style="color: #66D9EF;">]</span>
  <span style="color: #AE81FF;">)</span>
    .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;chip&quot;</span> &lt;- chip<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
    .arrange<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;timestamp&quot;</span><span style="color: #AE81FF;">)</span>
  df.<span style="color: #F92672;">add</span> dfC

  <span style="color: #75715E;"># </span><span style="color: #75715E;">and directly compute the hit frequency</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">hits </span>= dfC<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;hits&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">time </span>= dfC<span style="color: #AE81FF;">[</span><span style="color: #E6DB74;">&quot;timestamp&quot;</span>, <span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">ts </span>= time.map_inline<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>x - time<span style="color: #A6E22E;">[</span><span style="font-style: italic;">0</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">)</span>.s<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">const</span> <span style="color: #66D9EF;">Interval</span> = <span style="font-style: italic;">30</span>.<span style="color: #F92672;">min</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">i </span>= <span style="font-style: italic;">0</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">rate </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span>Second⁻¹<span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">rateTime </span>= <span style="color: #F92672;">newSeq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]()</span>
  <span style="color: #F92672;">while</span> i &lt; time.<span style="color: #F92672;">len</span>:
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">h </span>= <span style="font-style: italic;">0</span>
    <span style="color: #F92672;">var</span> <span style="color: #66D9EF;">Δt</span> = <span style="font-style: italic;">0</span>.s
    <span style="color: #F92672;">let</span> <span style="color: #FD971F;">t0 </span>= time<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
    <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;Starting at t0 = &quot;</span>, t0
    <span style="color: #F92672;">while</span> <span style="color: #66D9EF;">Δt</span> &lt; <span style="color: #66D9EF;">Interval</span> <span style="color: #F92672;">and</span> i &lt; time.<span style="color: #F92672;">len</span>:
      h += hits<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
      <span style="color: #F92672;">if</span> i &gt; <span style="font-style: italic;">0</span>:
        <span style="color: #66D9EF;">Δt</span> += ts<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> - ts<span style="color: #AE81FF;">[</span>i-<span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>
      <span style="color: #F92672;">inc</span> i
    rate.<span style="color: #F92672;">add</span> <span style="color: #AE81FF;">(</span>h.<span style="color: #66D9EF;">float</span> / <span style="color: #66D9EF;">Δt</span><span style="color: #AE81FF;">)</span>
    <span style="color: #F92672;">echo</span> <span style="color: #E6DB74;">&quot;To &quot;</span>, time<span style="color: #AE81FF;">[</span>i-<span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>
    rateTime.<span style="color: #F92672;">add</span><span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>time<span style="color: #A6E22E;">[</span>i-<span style="font-style: italic;">1</span><span style="color: #A6E22E;">]</span> + t0<span style="color: #66D9EF;">)</span> / <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
    h = <span style="font-style: italic;">0</span>
  dfR.<span style="color: #F92672;">add</span> toDf<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;rate&quot;</span> : rate.mapIt<span style="color: #A6E22E;">(</span>it.<span style="color: #66D9EF;">float</span><span style="color: #A6E22E;">)</span>, rateTime, <span style="color: #E6DB74;">&quot;chip&quot;</span> : chip<span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">echo</span> df
<span style="color: #F92672;">echo</span> dfR

dfR = dfR.filter<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #66D9EF;">int</span> -&gt; <span style="color: #66D9EF;">bool</span>: fromUnix<span style="color: #A6E22E;">(</span>`rateTime`<span style="color: #A6E22E;">)</span>.inZone<span style="color: #A6E22E;">(</span>local<span style="color: #E6DB74;">()</span><span style="color: #A6E22E;">)</span> &lt; initDateTime<span style="color: #A6E22E;">(</span><span style="font-style: italic;">19</span>, mApr, <span style="font-style: italic;">2017</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>, local<span style="color: #E6DB74;">()</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
ggplot<span style="color: #AE81FF;">(</span>dfR, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;rateTime&quot;</span>, <span style="color: #E6DB74;">&quot;rate&quot;</span>, color = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;chip&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_point<span style="color: #AE81FF;">()</span> +
  scale_y_log10<span style="color: #AE81FF;">()</span> + 
  scale_x_date<span style="color: #AE81FF;">(</span>isTimestamp = <span style="color: #AE81FF;">true</span>,
               formatString = <span style="color: #E6DB74;">&quot;HH:mm:ss&quot;</span>,
               dateSpacing = initDuration<span style="color: #66D9EF;">(</span>hours = <span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>,
               dateAlgo = dtaAddDuration,
               timeZone = local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span> +
  themeLatex<span style="color: #AE81FF;">(</span>fWidth = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">5</span>, width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">420</span>, baseTheme = sideBySide<span style="color: #AE81FF;">)</span> +
  margin<span style="color: #AE81FF;">(</span>bottom = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span>, right = <span style="font-style: italic;">4</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +   
  xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Time of day&quot;</span>, margin = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">25</span>, rotate = -<span style="font-style: italic;">45</span>.<span style="font-style: italic;">0</span>, alignTo = <span style="color: #E6DB74;">&quot;right&quot;</span><span style="color: #AE81FF;">)</span> + 
  ylab<span style="color: #AE81FF;">(</span>r<span style="color: #E6DB74;">&quot;Rate [$\si{pixel.s^{-1}}$]&quot;</span><span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/mean_hit_rate_sparking_run_268.pdf&quot;</span>,
        width = <span style="font-style: italic;">600</span>, height = <span style="font-style: italic;">360</span>, useTex = <span style="color: #AE81FF;">true</span>, standalone = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>

dfR.writeCsv<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/resources/mean_hit_rate_sparking_run_268.csv&quot;</span>, precision = <span style="font-style: italic;">10</span><span style="color: #AE81FF;">)</span>
</pre>
</div>

<p>
Finally, combine both and plot together:
</p>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / times
<span style="color: #F92672;">import</span> ggplotnim
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/home/basti/phd/resources/&quot;</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= readCsv<span style="color: #AE81FF;">(</span>path &amp; <span style="color: #E6DB74;">&quot;temperature_sparking_run_268.csv&quot;</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">dfR </span>= readCsv<span style="color: #AE81FF;">(</span>path &amp; <span style="color: #E6DB74;">&quot;mean_hit_rate_sparking_run_268.csv&quot;</span><span style="color: #AE81FF;">)</span>
  .group_by<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;chip&quot;</span><span style="color: #AE81FF;">)</span>
  .mutate<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;rateNorm&quot;</span> ~ `rate` / <span style="color: #F92672;">max</span><span style="color: #A6E22E;">(</span>`rate`<span style="color: #A6E22E;">)</span> * <span style="font-style: italic;">80</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
  .rename<span style="color: #AE81FF;">(</span>f<span style="color: #66D9EF;">{</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span> &lt;- <span style="color: #E6DB74;">&quot;rateTime&quot;</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">sa </span>= secAxis<span style="color: #AE81FF;">(</span>name = <span style="color: #E6DB74;">&quot;Hit rate [a.u.]&quot;</span>,
                 trans = f<span style="color: #66D9EF;">{</span><span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / <span style="font-style: italic;">80</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">}</span><span style="color: #AE81FF;">)</span>
                 <span style="color: #75715E;">#</span><span style="color: #75715E;">invTransFn = f{`</span><span style="color: #AE81FF;">rateNorm</span><span style="color: #75715E;">` * 80.0})</span>

ggplot<span style="color: #AE81FF;">(</span>df, aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span>, <span style="color: #E6DB74;">&quot;Temperature&quot;</span>, color = <span style="color: #E6DB74;">&quot;Type&quot;</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> +
  geom_line<span style="color: #AE81FF;">()</span> +
  geom_point<span style="color: #AE81FF;">(</span>data = dfR, aes = aes<span style="color: #66D9EF;">(</span><span style="color: #E6DB74;">&quot;Timestamp&quot;</span>, <span style="color: #E6DB74;">&quot;rateNorm&quot;</span>, color = factor<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;chip&quot;</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span> + 
  <span style="color: #75715E;"># </span><span style="color: #75715E;">ggtitle(&quot;Temperature during run on 2017/04/18 in which fan was placed next to detector&quot;) + </span>
  xlab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Time of day&quot;</span><span style="color: #AE81FF;">)</span> + ylab<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;Temperature [°C]&quot;</span><span style="color: #AE81FF;">)</span> +
  margin<span style="color: #AE81FF;">(</span>top = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span> +
  scale_y_continuous<span style="color: #AE81FF;">(</span>secAxis = sa<span style="color: #AE81FF;">)</span> + 
  scale_x_date<span style="color: #AE81FF;">(</span>isTimestamp = <span style="color: #AE81FF;">true</span>,
               formatString = <span style="color: #E6DB74;">&quot;HH:mm:ss&quot;</span>,
               dateSpacing = initDuration<span style="color: #66D9EF;">(</span>hours = <span style="font-style: italic;">2</span><span style="color: #66D9EF;">)</span>,
               dateAlgo = dtaAddDuration,
               timeZone = local<span style="color: #66D9EF;">()</span><span style="color: #AE81FF;">)</span> + 
  legendPosition<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">835</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> +
  yMargin<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">05</span><span style="color: #AE81FF;">)</span> + 
  ggsave<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/temperature_and_sparking_run_268.pdf&quot;</span><span style="color: #AE81FF;">)</span>

</pre>
</div>


<p>
And finally, let&apos;s also recreate the occupancy plot
<img src="./figs/home/basti/phd/Figs/detector/sparking/occupancy_sparking_septem5chips_300V.svg" class="org-svg" alt="occupancy_sparking_septem5chips_300V.svg" /> of run 241 during
development to showcase the sparking behavior.
</p>

<p>
In order to do that, we first need to reconstruct the run containing
the data:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #F92672;">cd</span> /mnt/1TB/CAST/2017/development/
raw_data_manipulation -p Run_241_170216-13-49 --runType background --out raw_241_sparking.h5
reconstruction raw_241_sparking.h5 --out reco_241_sparking.h5
</pre>
</div>

<p>
With the reconstructed data file at hand, we can first of all generate
a large number of plots for each chip:
</p>
<div class="org-src-container">
<pre class="src src-sh">plotData --h5file reco_241_sparking.h5 <span style="color: #E6DB74; font-weight: bold;">\</span>
         --runType rtBackground <span style="color: #E6DB74; font-weight: bold;">\</span>
         --config ~/CastData/ExternCode/TimepixAnalysis/Plotting/karaPlot/config.toml <span style="color: #E6DB74; font-weight: bold;">\</span>
         --ingrid --occupancy
</pre>
</div>
<p>
which can be adjusted according to the user&apos;s preference of course.
</p>

<p>
(For this plot in particular it&apos;s really important not use the <code>ToT</code>
cutting feature in <code>raw_data_manipulation</code> via the <code>rmToTLow</code> and
<code>rmToTHigh</code> in the <code>config.toml</code> file)
</p>

<p>
With the file in place, let&apos;s now create the plot of the occupancies
for each chip, embedded in the layout of the septemboard (at least for
the 5 chips that were on this septemboard F).
</p>


<ul class="org-ul">
<li class="off"><code>[ ]</code> <b>REPLACE BELOW PLACEMENT BY <code>geometry.nim</code> IMPLEMENTATION</b></li>
</ul>
<div class="org-src-container">
<pre class="src src-nim"><span style="color: #F92672;">import</span> std / os <span style="color: #F92672;">except</span> <span style="color: #66D9EF;">FileInfo</span>
<span style="color: #F92672;">import</span> std / strutils
<span style="color: #F92672;">import</span> ingrid / <span style="color: #AE81FF;">[</span>tos_helpers, ingrid_types<span style="color: #AE81FF;">]</span>
<span style="color: #F92672;">import</span> nimhdf5, ggplotnim, ginger

<span style="color: #E6DB74;">## The Septemboard layout code is a port of the code used in the python based event </span>
<span style="color: #E6DB74;">## display for TOS.</span>

<span style="color: #F92672;">const</span>
  <span style="color: #66D9EF;">Width</span> = <span style="font-style: italic;">14</span>.<span style="font-style: italic;">1</span>
  <span style="color: #66D9EF;">Height</span> = <span style="font-style: italic;">14</span>.<span style="font-style: italic;">1</span>
  <span style="color: #66D9EF;">BondHeight</span> = <span style="font-style: italic;">2</span>.<span style="font-style: italic;">0</span>
  <span style="color: #66D9EF;">FullHeight</span> = <span style="color: #66D9EF;">Height</span> + <span style="color: #66D9EF;">BondHeight</span>
  <span style="color: #66D9EF;">NumChips</span> = <span style="font-style: italic;">7</span>

  <span style="color: #75715E;"># </span><span style="color: #75715E;">If this is set to `</span><span style="color: #AE81FF;">true</span><span style="color: #75715E;">` the final plot will only contain the actual raster image. No legend or axes</span>
  <span style="color: #66D9EF;">OnlyRaster</span> = <span style="color: #AE81FF;">true</span>

  <span style="color: #66D9EF;">Run</span> = <span style="font-style: italic;">241</span>

<span style="color: #F92672;">type</span>
  <span style="color: #66D9EF;">SeptemRow</span> = <span style="color: #F92672;">object</span>
    left: <span style="color: #66D9EF;">float</span>
    right: <span style="color: #66D9EF;">float</span>
    wspace: <span style="color: #66D9EF;">float</span>
    top: <span style="color: #66D9EF;">float</span>
    bottom: <span style="color: #66D9EF;">float</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initSeptemRow</span><span style="color: #AE81FF;">(</span>nChips: <span style="color: #66D9EF;">int</span>, x_size, y_size, x_dist, x_offset, y_t_offset, y_b_offset, dist_to_row_below: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">SeptemRow</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">this class implements a single row of chips of the septem board</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">nChips: number of chips in row</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">x_dist: distance in x direction between each chip</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">x_offset: offset of left edge of first chip in row from</span>
  <span style="color: #75715E;">#           </span><span style="color: #75715E;">left side of center row</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">calculate width and height of row, based on chips and dist</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">width </span>= nChips.<span style="color: #66D9EF;">float</span> * <span style="color: #66D9EF;">Width</span> + <span style="color: #AE81FF;">(</span>nChips - <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span>.<span style="color: #66D9EF;">float</span> * x_dist
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">height_active </span>= <span style="color: #66D9EF;">Height</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">height_full </span>= <span style="color: #66D9EF;">FullHeight</span> + dist_to_row_below
  <span style="color: #75715E;"># </span><span style="color: #75715E;">using calc gridspec one calculates the coordinates of the row on</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">the figure in relative canvas coordinates</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">include padding by adding or subtracting from left, right, top, bottom</span>
  <span style="color: #FD971F;">result</span>.left      = x_offset / x_size
  <span style="color: #FD971F;">result</span>.right     = <span style="color: #FD971F;">result</span>.left + width / x_size
  <span style="color: #FD971F;">result</span>.wspace    = x_dist / x_size
  <span style="color: #FD971F;">result</span>.top       = <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> - y_t_offset / y_size
  <span style="color: #FD971F;">result</span>.bottom    = <span style="color: #FD971F;">result</span>.top - height_active / y_size

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initSeptemBoard</span><span style="color: #AE81FF;">(</span>padding, fig_x_size, fig_y_size, scaling_factor: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">SeptemRow</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">implements the septem board, being built from 3 septem rows</span>

  <span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">initRows</span><span style="color: #AE81FF;">(</span>y_size, scaled_x_size, scaled_y_size, y_row1_row2, y_row2_row3, row2_x_dist: <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">SeptemRow</span><span style="color: #AE81FF;">]</span> =
    <span style="color: #75715E;"># </span><span style="color: #75715E;">this function creates the row objects for the septem class</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">calculation of row 1 top and bottom (in abs. coords.):</span>
    <span style="color: #F92672;">let</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">(top need to add padding to top of row 1)</span>
      row1_y_top    = y_size - <span style="color: #66D9EF;">BondHeight</span> - <span style="color: #66D9EF;">Height</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">bottom in abs. coords.</span>
      row1_y_bottom = <span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">FullHeight</span> + y_row1_row2 + y_row2_row3 - <span style="color: #66D9EF;">Height</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">offset of left side from septem in abs. coords.</span>
      row1_x_offset = <span style="font-style: italic;">6</span>.<span style="font-style: italic;">95</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">now create the first row with all absolute coordinates</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> initSeptemRow<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>, scaled_x_size, scaled_y_size, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">85</span>, row1_x_offset, row1_y_top, row1_y_bottom, y_row1_row2<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">calculation of row 2 top and bottom (top &amp; bottom of row2 not affected by padding):</span>
    <span style="color: #F92672;">let</span>
      row2_y_top    = y_size - <span style="color: #66D9EF;">FullHeight</span> - y_row1_row2 - <span style="color: #66D9EF;">Height</span>
      row2_y_bottom = <span style="color: #66D9EF;">FullHeight</span> + y_row2_row3 + <span style="color: #66D9EF;">BondHeight</span> - <span style="color: #66D9EF;">Height</span>
      <span style="color: #75715E;"># </span><span style="color: #75715E;">no offset for row2, defines our left most position in abs. coords.</span>
      row2_x_offset = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">padding * x_size</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> initSeptemRow<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>, scaled_x_size, scaled_y_size, row2_x_dist, row2_x_offset, row2_y_top, row2_y_bottom, y_row2_row3<span style="color: #AE81FF;">)</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">calculation of row 3 top and bottom (add padding to bottom):</span>
    <span style="color: #F92672;">let</span>
      row3_y_top    = y_size - <span style="font-style: italic;">2</span> * <span style="color: #66D9EF;">FullHeight</span> - y_row1_row2 - y_row2_row3 - <span style="color: #66D9EF;">Height</span>
      row3_y_bottom = <span style="color: #66D9EF;">BondHeight</span> - <span style="color: #66D9EF;">Height</span>
      row3_x_offset = <span style="font-style: italic;">7</span>.<span style="font-style: italic;">22</span>
    <span style="color: #FD971F;">result</span>.<span style="color: #F92672;">add</span> initSeptemRow<span style="color: #AE81FF;">(</span><span style="font-style: italic;">2</span>, scaled_x_size, scaled_y_size, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">35</span>, row3_x_offset, row3_y_top, row3_y_bottom, <span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>

  <span style="color: #75715E;"># </span><span style="color: #75715E;">include a padding all around the septem event display of &apos;padding&apos;</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">use size of figure to scale septem accordingly to have it always properly</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">scaled for the given figure</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">take the inverse of the scaling factor (want 1/2 as input to scale to half size)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">scaling_factor </span>= <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span> / scaling_factor
  <span style="color: #75715E;"># </span><span style="color: #75715E;">first calculate the ratio of the figure</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">fig_ratio </span>= <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>fig_x_size<span style="color: #AE81FF;">)</span> / <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>fig_y_size<span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">distances between different rows in absolute coordinates</span>
  <span style="color: #F92672;">let</span>
    y_row1_row2 = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">38</span>
    y_row2_row3 = <span style="font-style: italic;">3</span>.<span style="font-style: italic;">1</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">size in y direction of whole septem board in absolute coordinates</span>
    y_size      = <span style="font-style: italic;">3</span> * <span style="color: #66D9EF;">FullHeight</span> + y_row1_row2 + y_row2_row3
    <span style="color: #75715E;"># </span><span style="color: #75715E;">already define row2_x_dist here (in absolute coordinates) to calculate x_size</span>
    row2_x_dist = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">35</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">3 chips * width + 2 * distance between chips (in absolute coordinates)</span>
    x_size      = <span style="font-style: italic;">3</span> * <span style="color: #66D9EF;">Width</span> + <span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span> - <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> * row2_x_dist
  <span style="color: #75715E;"># </span><span style="color: #75715E;">calculate the ratio of the septem board</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">ratio </span>= <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>x_size<span style="color: #AE81FF;">)</span> / <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">(</span>y_size<span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">now calculate the needed ratio to get the correct scaling of the septem on any</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">figure scale. fig_ratio / own ratio</span>
  ratio = fig_ratio / ratio
  <span style="color: #F92672;">let</span>
    <span style="color: #75715E;"># </span><span style="color: #75715E;">scaled x and y sizes</span>
    scaled_x_size = x_size * ratio * scaling_factor
    scaled_y_size = y_size * scaling_factor
  <span style="color: #75715E;"># </span><span style="color: #75715E;">and now create the row objects</span>
  <span style="color: #FD971F;">result</span> = initRows<span style="color: #AE81FF;">(</span>y_size, scaled_x_size, scaled_y_size, y_row1_row2, y_row2_row3, row2_x_dist<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">readVlen</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>,
              fileInfo: <span style="color: #66D9EF;">FileInfo</span>,
              runNumber: <span style="color: #66D9EF;">int</span>,
              dsetName: <span style="color: #66D9EF;">string</span>,
              chipNumber = <span style="font-style: italic;">0</span>,
              dtype: <span style="color: #66D9EF;">typedesc</span> = <span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span>dtype<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #E6DB74;">## reads variable length data `</span><span style="color: #AE81FF;">dsetName</span><span style="color: #E6DB74;">` and returns it</span>
  <span style="color: #E6DB74;">## In contrast to `</span><span style="color: #AE81FF;">read</span><span style="color: #E6DB74;">` this proc does *not* convert the data.</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">vlenDtype </span>= special_type<span style="color: #AE81FF;">(</span>dtype<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">dset </span>= h5f<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span>fileInfo.dataPath<span style="color: #A6E22E;">(</span>runNumber, chipNumber<span style="color: #A6E22E;">)</span>.<span style="color: #66D9EF;">string</span> / dsetName<span style="color: #66D9EF;">)</span>.dset_str<span style="color: #AE81FF;">]</span>
  <span style="color: #FD971F;">result</span> = dset<span style="color: #AE81FF;">[</span>vlenDType, dtype<span style="color: #AE81FF;">]</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">calcOccupancy</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">T</span><span style="color: #AE81FF;">](</span>x, y: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #66D9EF;">T</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span>, z: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">seq</span><span style="color: #A6E22E;">[</span><span style="color: #66D9EF;">uint16</span><span style="color: #A6E22E;">]</span><span style="color: #66D9EF;">]</span> = @<span style="color: #66D9EF;">[]</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">Tensor</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">]</span> =
  <span style="color: #E6DB74;">## calculates the occupancy of the given x and y datasets</span>
  <span style="color: #E6DB74;">## Either for a `</span><span style="color: #AE81FF;">seq[seq[T: SomeInteger]]</span><span style="color: #E6DB74;">` in which case we&apos;re calculating</span>
  <span style="color: #E6DB74;">## the occupancy of a raw clusters or `</span><span style="color: #AE81FF;">seq[T: SomeFloat]</span><span style="color: #E6DB74;">` in which case</span>
  <span style="color: #E6DB74;">## we&apos;re dealing with center positions of clusters</span>
  <span style="color: #FD971F;">result</span> = newTensor<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">NPix</span>, <span style="color: #66D9EF;">NPix</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;"># </span><span style="color: #75715E;">iterate over events</span>
  <span style="color: #F92672;">for</span> i <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> .. x.<span style="color: #F92672; font-style: italic;">high</span>:
    <span style="color: #F92672;">let</span>
      xEv = x<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
      yEv = y<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
    <span style="color: #F92672;">var</span> <span style="color: #FD971F;">zEv</span>: <span style="color: #66D9EF;">seq</span><span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">uint16</span><span style="color: #AE81FF;">]</span>
    <span style="color: #F92672;">if</span> z.<span style="color: #F92672;">len</span> &gt; <span style="font-style: italic;">0</span>:
      zEv = z<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>
    <span style="color: #E6DB74;">## continue if full event.</span>
    <span style="color: #E6DB74;">## TODO: replace by solution that also works for clusters!!</span>
    <span style="color: #75715E;">#</span><span style="color: #75715E;">if xEv.len &gt;= 4095: continue</span>
    <span style="color: #F92672;">for</span> j <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> .. xEv.<span style="color: #F92672; font-style: italic;">high</span>:
      <span style="color: #F92672;">if</span> zEv.<span style="color: #F92672;">len</span> &gt; <span style="font-style: italic;">0</span>:
        <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>xEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span>, yEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span> += zEv<span style="color: #AE81FF;">[</span>j<span style="color: #AE81FF;">]</span>.<span style="color: #66D9EF;">float</span>
      <span style="color: #F92672;">else</span>:
        <span style="color: #FD971F;">result</span><span style="color: #AE81FF;">[</span>xEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span>, yEv<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span>.<span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">]</span> += <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">occForChip</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>, chip: <span style="color: #66D9EF;">int</span>, fileInfo: <span style="color: #66D9EF;">FileInfo</span><span style="color: #AE81FF;">)</span>: <span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">]</span>, <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #66D9EF;">]</span>, <span style="color: #66D9EF;">Tensor</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> =        
  <span style="color: #F92672;">const</span> <span style="color: #66D9EF;">NPix</span> = <span style="font-style: italic;">256</span>
  <span style="color: #F92672;">let</span>
    xD = h5f.readVlen<span style="color: #AE81FF;">(</span>fileInfo, <span style="color: #66D9EF;">Run</span>, <span style="color: #E6DB74;">&quot;x&quot;</span>, chip, dtype = <span style="color: #66D9EF;">uint8</span><span style="color: #AE81FF;">)</span>
    yD = h5f.readVlen<span style="color: #AE81FF;">(</span>fileInfo, <span style="color: #66D9EF;">Run</span>, <span style="color: #E6DB74;">&quot;y&quot;</span>, chip, dtype = <span style="color: #66D9EF;">uint8</span><span style="color: #AE81FF;">)</span>
    zD = h5f.readVlen<span style="color: #AE81FF;">(</span>fileInfo, <span style="color: #66D9EF;">Run</span>, <span style="color: #E6DB74;">&quot;ToT&quot;</span>, chip, dtype = <span style="color: #66D9EF;">uint16</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">occ </span>= calcOccupancy<span style="color: #AE81FF;">(</span>xD, yD<span style="color: #AE81FF;">)</span> <span style="color: #75715E;"># </span><span style="color: #75715E;">, zD)</span>
  <span style="color: #F92672;">var</span>
    x = newTensorUninit<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">NPix</span> * <span style="color: #66D9EF;">NPix</span><span style="color: #AE81FF;">)</span>
    y = newTensorUninit<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">int</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">NPix</span> * <span style="color: #66D9EF;">NPix</span><span style="color: #AE81FF;">)</span>
    z = newTensorUninit<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">float</span><span style="color: #AE81FF;">](</span><span style="color: #66D9EF;">NPix</span> * <span style="color: #66D9EF;">NPix</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">i </span>= <span style="font-style: italic;">0</span>
  <span style="color: #F92672;">for</span> idx, val <span style="color: #F92672;">in</span> occ:
    x<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = idx<span style="color: #AE81FF;">[</span><span style="font-style: italic;">0</span><span style="color: #AE81FF;">]</span>
    y<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = idx<span style="color: #AE81FF;">[</span><span style="font-style: italic;">1</span><span style="color: #AE81FF;">]</span>
    z<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span> = val
    <span style="color: #F92672;">inc</span> i
  <span style="color: #FD971F;">result</span> = <span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span>
      
<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">handleOccupancy</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>,
                     chip: <span style="color: #66D9EF;">int</span>,
                     fileInfo: <span style="color: #66D9EF;">FileInfo</span>,
                     quant: <span style="color: #66D9EF;">float</span> = <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">PlotView</span> =
  <span style="color: #75715E;"># </span><span style="color: #75715E;">get x and y datasets, stack and get occupancies</span>
  <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span> = h5f.occForChip<span style="color: #AE81FF;">(</span>chip, fileInfo<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">df </span>= toDf<span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">quant </span>= quant
  <span style="color: #F92672;">if</span> quant == <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>:
    quant = percentile<span style="color: #AE81FF;">(</span>z, <span style="font-style: italic;">80</span><span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = ggcreate<span style="color: #AE81FF;">(</span>
    <span style="color: #F92672;">block</span>:
      <span style="color: #F92672;">var</span> <span style="color: #FD971F;">plt </span>= 
        ggplot<span style="color: #66D9EF;">(</span>df, aes<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">&quot;x&quot;</span>, <span style="color: #E6DB74;">&quot;y&quot;</span>, fill = <span style="color: #E6DB74;">&quot;z&quot;</span><span style="color: #A6E22E;">)</span>, backend = bkCairo<span style="color: #66D9EF;">)</span> +
          geom_raster<span style="color: #66D9EF;">()</span> +
          scale_fill_continuous<span style="color: #66D9EF;">(</span>scale = <span style="color: #A6E22E;">(</span><span style="color: #F92672; font-style: italic;">low</span>: <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="color: #F92672; font-style: italic;">high</span>: quant<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span> + <span style="color: #75715E;">#</span><span style="color: #75715E;">high: 1600.0)) +</span>
          xlim<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>, <span style="color: #66D9EF;">NPix</span><span style="color: #66D9EF;">)</span> + ylim<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>, <span style="color: #66D9EF;">NPix</span><span style="color: #66D9EF;">)</span>
      <span style="color: #F92672;">if</span> <span style="color: #66D9EF;">OnlyRaster</span>:
        plt = plt + theme_void<span style="color: #66D9EF;">()</span> + hideLegend<span style="color: #66D9EF;">()</span>
      plt
  <span style="color: #AE81FF;">)</span>
  <span style="color: #75715E;">#</span><span style="color: #75715E;">ggplot(df, aes(&quot;x&quot;, &quot;y&quot;, fill = &quot;z&quot;), backend = bkCairo) +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">geom_raster() +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">scale_fill_continuous(scale = (low: 0.0, high: 1600.0)) +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">xlim(0, NPix) + ylim(0, NPix) +</span>
  <span style="color: #75715E;">#    </span><span style="color: #75715E;">ggsave(&quot;/t/test_occ_0_.pdf&quot;)</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">drawBounds</span><span style="color: #AE81FF;">(</span>v: <span style="color: #66D9EF;">Viewport</span><span style="color: #AE81FF;">)</span> =
  v.drawBoundary<span style="color: #AE81FF;">(</span>writeName = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
  <span style="color: #F92672;">for</span> ch <span style="color: #F92672;">in</span> <span style="color: #F92672;">mitems</span><span style="color: #AE81FF;">(</span>v.children<span style="color: #AE81FF;">)</span>:
    ch.drawBounds<span style="color: #AE81FF;">()</span>

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">calcQuantileChip3</span><span style="color: #AE81FF;">(</span>h5f: <span style="color: #66D9EF;">H5File</span>, fileInfo: <span style="color: #66D9EF;">FileInfo</span><span style="color: #AE81FF;">)</span>: <span style="color: #66D9EF;">float</span> =
  <span style="color: #F92672;">let</span> <span style="color: #AE81FF;">(</span>x, y, z<span style="color: #AE81FF;">)</span> = h5f.occForChip<span style="color: #AE81FF;">(</span><span style="font-style: italic;">3</span>, fileInfo<span style="color: #AE81FF;">)</span>
  <span style="color: #FD971F;">result</span> = percentile<span style="color: #AE81FF;">(</span>z, <span style="font-style: italic;">80</span><span style="color: #AE81FF;">)</span>  

<span style="color: #F92672;">proc</span> <span style="color: #A6E22E;">addRow</span><span style="color: #AE81FF;">(</span>view: <span style="color: #66D9EF;">Viewport</span>, h5f: <span style="color: #66D9EF;">H5File</span>, septem: <span style="color: #66D9EF;">seq</span><span style="color: #66D9EF;">[</span><span style="color: #66D9EF;">SeptemRow</span><span style="color: #66D9EF;">]</span>, fileInfo: <span style="color: #66D9EF;">FileInfo</span>, i, num, chipStart: <span style="color: #66D9EF;">int</span>, showEmpty = <span style="color: #AE81FF;">false</span><span style="color: #AE81FF;">)</span> =
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">width </span>= septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.right - septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.left
  <span style="color: #F92672;">let</span> <span style="color: #FD971F;">height </span>= septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.top - septem<span style="color: #AE81FF;">[</span>i<span style="color: #AE81FF;">]</span>.bottom

  <span style="color: #F92672;">var</span> <span style="color: #FD971F;">row </span>= view.addViewport<span style="color: #AE81FF;">(</span>left = septem<span style="color: #66D9EF;">[</span>i<span style="color: #66D9EF;">]</span>.left, bottom = septem<span style="color: #66D9EF;">[</span>i<span style="color: #66D9EF;">]</span>.bottom,
                             width = width, height = height<span style="color: #AE81FF;">)</span>
  row.layout<span style="color: #AE81FF;">(</span>num, <span style="font-style: italic;">1</span><span style="color: #AE81FF;">)</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">, margin = quant(septem[i].wspace, ukRelative))</span>

  <span style="color: #75715E;">#</span><span style="color: #75715E;">let quant = calcQuantileChip3()</span>
  
  <span style="color: #F92672;">for</span> j <span style="color: #F92672;">in</span> <span style="font-style: italic;">0</span> ..&lt; num:
    <span style="color: #F92672;">if</span> <span style="color: #F92672;">not</span> showEmpty:
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">plt </span>= handleOccupancy<span style="color: #AE81FF;">(</span>h5f, chipStart + j, fileInfo<span style="color: #AE81FF;">)</span> <span style="color: #75715E;">#</span><span style="color: #75715E;">, quant)</span>
      <span style="color: #F92672;">let</span> <span style="color: #FD971F;">v </span>= <span style="color: #F92672;">if</span> <span style="color: #66D9EF;">OnlyRaster</span>: plt.view<span style="color: #AE81FF;">[</span><span style="font-style: italic;">4</span><span style="color: #AE81FF;">]</span> <span style="color: #F92672;">else</span>: plt.view
      <span style="color: #F92672;">var</span> <span style="color: #FD971F;">pltView </span>= v.relativeTo<span style="color: #AE81FF;">(</span>row<span style="color: #66D9EF;">[</span>j<span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span> 
      row.embedAt<span style="color: #AE81FF;">(</span>j, pltView<span style="color: #AE81FF;">)</span>
    row<span style="color: #AE81FF;">[</span>j<span style="color: #AE81FF;">]</span>.drawBoundary<span style="color: #AE81FF;">()</span>

  view.children.<span style="color: #F92672;">add</span> row

<span style="color: #E6DB74;">## Read the data from the reconstructed H5 file of run 241</span>
<span style="color: #F92672;">const</span> <span style="color: #FD971F;">path </span>= <span style="color: #E6DB74;">&quot;/mnt/1TB/CAST/2017/development/reco_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">_sparking.h5&quot;</span> % $<span style="color: #66D9EF;">Run</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">h5f </span>= <span style="color: #66D9EF;">H5open</span><span style="color: #AE81FF;">(</span>path, <span style="color: #E6DB74;">&quot;r&quot;</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">fileInfo </span>= getFileInfo<span style="color: #AE81FF;">(</span>h5f<span style="color: #AE81FF;">)</span>

<span style="color: #F92672;">let</span>
  fig_x_size = <span style="font-style: italic;">10</span>.<span style="font-style: italic;">0</span>
  fig_y_size = <span style="font-style: italic;">12</span>.<span style="font-style: italic;">04186</span>
  ratio = fig_x_size / fig_y_size

<span style="color: #F92672;">let</span> <span style="color: #FD971F;">septem </span>= initSeptemBoard<span style="color: #AE81FF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, fig_x_size, fig_y_size, <span style="font-style: italic;">1</span>.<span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>
<span style="color: #F92672;">let</span> <span style="color: #66D9EF;">ImageSize</span> = fig_x_size * <span style="color: #66D9EF;">DPI</span>
<span style="color: #F92672;">let</span> <span style="color: #FD971F;">view </span>= initViewport<span style="color: #AE81FF;">(</span>c<span style="color: #66D9EF;">(</span><span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span>, <span style="font-style: italic;">0</span>.<span style="font-style: italic;">0</span><span style="color: #66D9EF;">)</span>,
                        quant<span style="color: #66D9EF;">(</span>fig_x_size, ukInch<span style="color: #66D9EF;">)</span>, quant<span style="color: #66D9EF;">(</span>fig_y_size, ukInch<span style="color: #66D9EF;">)</span>, backend = bkCairo,
                        wImg = <span style="color: #66D9EF;">ImageSize</span>, hImg = <span style="color: #66D9EF;">ImageSize</span> / ratio<span style="color: #AE81FF;">)</span>

view.addRow<span style="color: #AE81FF;">(</span>h5f, septem, fileInfo, <span style="font-style: italic;">0</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">5</span>, showEmpty = <span style="color: #AE81FF;">true</span><span style="color: #AE81FF;">)</span>
view.addRow<span style="color: #AE81FF;">(</span>h5f, septem, fileInfo, <span style="font-style: italic;">1</span>, <span style="font-style: italic;">3</span>, <span style="font-style: italic;">2</span><span style="color: #AE81FF;">)</span>
view.addRow<span style="color: #AE81FF;">(</span>h5f, septem, fileInfo, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">2</span>, <span style="font-style: italic;">0</span><span style="color: #AE81FF;">)</span>

view.draw<span style="color: #AE81FF;">(</span><span style="color: #E6DB74;">&quot;/home/basti/phd/Figs/detector/sparking/sparking_occupancy_80_quantile_run_</span><span style="color: #F92672;">$#</span><span style="color: #E6DB74;">.pdf&quot;</span> % $<span style="color: #66D9EF;">Run</span><span style="color: #AE81FF;">)</span>
</pre>
</div>

<p>
Running the above code for run 268 (the run we installed the fan and
had temperature readout) yields fig. <a href="#fig:detector:occupancy_sparking_run_268">22</a>.
</p>


<figure id="fig:detector:occupancy_sparking_run_268">
<img src="./figs/home/basti/phd/Figs/detector/sparking/sparking_occupancy_80_quantile_run_268.svg" class="org-svg" alt="sparking_occupancy_80_quantile_run_268.svg" />

<figcaption>Figure 22: <span class="figure-number">Figure 26: </span>Occupancy of a testing background run with \(\mathcal{O}(\SI{1}{s})\) long frames using septemboard F during development without any kind of cooling and temperature logging. Temperatures on the underside of the carrier board reached \SI{76}{\celsius} before the fan was placed next to it.</figcaption>
</figure>
</div>
</div>
</div>

<div class="outline-3" id="outline-container-sec:septem:efficiency">
<h3 id="sec:septem:efficiency"><span class="section-number-3">7.12.</span> Detector efficiency</h3>
<div class="outline-text-3" id="text-sec:septem:efficiency">
<p>
For the applications at CAST, the detector is filled with \(\ce{Ar}\) / \(\ce{iC_4 H_{10}}\) :
\(\SI{97.7}{\%} / \SI{2.3}{\%}\) gas. Combined with its \SI{300}{nm}
\(\ce{Si_3 N_4}\) window, the combined detection efficiency can be
computed, if the \(\SI{20}{nm}\) \(\ce{Al}\) coating for the detector cathode
is included by computing the product of the different
efficiencies. The efficiency of the window and coating are the
transmissions of X-rays at different energies for each material \(t_i\). For
the gas, the absorption probability of the gas \(a_i\) is needed. As such
</p>

<p>
\[
ε_{\text{tot}} = t_{\ce{Si_3 N_4}} · t_{\ce{Al}} · a_{\ce{Ar} / \ce{iC_4H_{10}}}
\]
</p>

<p>
describes the full detector efficiency assuming the parts of the
detector, which are not obstructed by the window strongbacks. For a
statistical measure of detection efficiency the occlusion of the
window needs to be taken into account. Because it is position
(and thus area) dependent, the need to include it is decided on a case
by case basis. For the absorption of a gas mixture, we can use
Dalton&apos;s law and compute the absorption of the individual gases according
to their mole fractions (their percentage as indicated by the gas
mixture) and then compute it for each partial pressure
</p>

<p>
\[
a_i = \text{Absorption}(P_{\text{total}} · f_i)
\]
</p>

<p>
where \(P_{\text{total}}\) is the total pressure of the gas mixture (in
this case \(\SI{1050}{mbar}\)) and \(f_i\) is the fraction of the gas
\(i\). &apos;Absorption&apos; simply refers to the generic function computing the
absorption for a gas at a given pressure (see
sec. <a href="./theory_detector.html#sec:theory:daltons_law">6.3.1</a> and sec. <a href="./theory_detector.html#sec:theory:xray_matter_gas">6.1.1</a>).
</p>

<p>
The full combined efficiency as presented here is shown in
fig. <a href="#fig:detector:combined_efficiency">23</a>. Different aspects dominate the
combined efficiency (purple line) in different energy ranges. At
energies above \(\SI{5}{keV}\) the probability of X-rays to not generate a
photoelectron within the \(\SI{3}{cm}\) of drift distance becomes the
major factor for a loss in efficiency. This means the combined
efficiency at \(\SI{10}{keV}\) is slightly below \(\SI{30}{\%}\). The
best combined efficiency of about \(\SI{95}{\%}\) is reached at
about \(\SI{3.75}{keV}\) where both the absorption is likely and the
energy is high enough to transmit well through the window. The argon
\(K 1s\) absorption edge is clearly visible at around \(\SI{3.2}{keV}\). At
energies below the mean free path of X-rays is significantly longer as
the \(K 1s\) absorption is a significant factor in the possible
generation of a photoelectron. The window leads to a similar, but inverse, effect
namely due to the \(K 1s\) line of \(\ce{Si}\) at around
\(\SI{1.84}{keV}\). Because transmission is desired through the window
material, the efficiency <i>increases</i> once we go below that
energy. Finally, the nitrogen \(K 1s\) line also contributes to an
increase in efficiency once we cross below about \(\SI{400}{eV}\). The
average efficiencies in the energy ranges between \(\SIrange{0}{3}{keV}\) and
\(\SIrange{0}{10}{keV}\) are \(\SI{73.42}{\%}\) and \(\SI{67.84}{\%}\), respectively.
</p>

<p>
The improvement in efficiency at energies below \(\SI{3}{keV}\) in
comparison to the mylar window used in the 2014/15 detector (see
sec. <a href="./septemboard.html#sec:detector:sin_window">7.9</a>) leads to a significant
improvement in possible signal detection at those energies, which is
especially important for searches with peak fluxes around
\(\SIrange{1}{2}{keV}\) as is the case for the axion-electron coupling or
a possible chameleon coupling.
</p>


<figure id="fig:detector:combined_efficiency">
<img src="./figs/home/basti/phd/Figs/detector/detector_efficiency.svg" class="org-svg" alt="detector_efficiency.svg" />

<figcaption>Figure 23: <span class="figure-number">Figure 27: </span>Combined detection efficiency for the full detector, taking into account the gas filling of \(\SI{1050}{mbar}\) \(\ce{Ar}\) / \(\ce{iC_4 H_{10}}\), the \(\SI{300}{nm}\) \(\ce{Si_3 N_4}\) window and its \(\SI{20}{nm}\) \(\ce{Al}\) coating.</figcaption>
</figure>
</div>
</div>

<div class="outline-3" id="outline-container-sec:detector:daq">
<h3 id="sec:detector:daq"><span class="section-number-3">7.13.</span> Data acquisition and detector monitoring</h3>
<div class="outline-text-3" id="text-sec:detector:daq">
<p>
The data acquisition software used for the Septemboard detector, the
Timepix Operating Software (TOS), is not of direct importance for the
thesis. But a longer section about it can be found in appendix
<a href="./daq.html#sec:daq">17</a>. It includes discussions about how the software works
internally, how it is used, what the data format produced looks like
and its configuration files. Further, it goes over the temperature
readout functionality and finally presents the software used for
detector monitoring, in the form of an event display used at CAST.
</p>
</div>
</div>
</div>

<div id="footnotes"><h2 class="footnotes">Footnotes: </h2><div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.1" href="#fnr.1">1</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
<a href="https://github.com/SiLab-Bonn/tpx3-daq">https://github.com/SiLab-Bonn/tpx3-daq</a> 
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.2" href="#fnr.2">2</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
The \(x\), \(y\) notation is sometimes encountered when
the exact material composition is not known. Silicon-nitride is a term
used for a range of silicon to nitride ratios. Most commonly \(\ce{Si_3 N_4}\).
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.3" href="#fnr.3">3</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
<a href="https://www.xilinx.com/products/boards-and-kits/ek-v6-ml605-g.html">https://www.xilinx.com/products/boards-and-kits/ek-v6-ml605-g.html</a>
(visited 2022/10/17)
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.4" href="#fnr.4">4</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
<a href="https://archive.org/details/manualzilla-id-5646050/">https://archive.org/details/manualzilla-id-5646050/</a>
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.5" href="#fnr.5">5</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
<a href="https://www.norcada.com/">https://www.norcada.com/</a>
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.6" href="#fnr.6">6</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
The ideal readout time for one chip is \(t =
\SI{917504}{bits} · \SI{25}{ns} = \SI{22.9942}{ms}\)
(<a href="#citeproc_bib_item_151">Lupberger 2016</a>), but this does not take into account overhead
from the FPGA, sending data to the computer and processing in TOS. We
will later see that the practical readout time of the final detector
is closer to almost \(\SI{500}{ms}\) under high rate conditions
(e.g. \cefe calibration runs) and \(\sim\SI{200}{ms}\) for low rate
background conditions.
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.7" href="#fnr.7">7</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
See the full thesis version for the
occupancy of the run with temperature readout in the subsection
after this if interested.
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.8" href="#fnr.8">8</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
The realization that the issues are
purely due to temperature effects was only after several months of
eliminating many other options, both on the software as well as the
hardware side. In particular power supply instabilities were long
considered to be a source of problems. While they possibly also had an
impact, better power supplies were built with larger capacitors to
better deal with large variations in required power. 
</p></div></div>

<div class="footdef"><sup>  <a role="doc-backlink" class="footnum" id="fn.9" href="#fnr.9">9</a></sup> <div role="doc-footnote" class="footpara">  <p class="footpara">
<a href="https://www.alphacool.com/">https://www.alphacool.com/</a>
</p></div></div>

</div>
<div class="hint-message">Click on any heading marked '<span class="extended">extended</span>' to open it</div>
</div>
</body>
</html>
