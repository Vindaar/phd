#+SETUPFILE: ~/.emacs.d/default_beamer_header.org

#+LATEX_HEADER: \usepackage{tikz}

# title and subtitle
#+TITLE: Search for solar axions using a 7-GridPix IAXO prototype detector at CAST
#+AUTHOR: Sebastian Schmidt
#+DATE: $25^{\text{th}}$ April 2024

#+LATEX_HEADER: \institute{University of Bonn}
#+BEAMER_HEADER: \titlegraphic{%
#+BEAMER_HEADER: \includegraphics[height=.15\textheight]{../../Documents/Talks/logos/PI_logo_blue}
#+BEAMER_HEADER: \hfill
#+BEAMER_HEADER: \includegraphics[height=.15\textheight]{../../Documents/Talks/logos/unibonn-logo}}

* Test talk #1 <2024-04-04 Thu 13:22>                              :noexport:

I just did a first test talk on the barely done talk today
<2024-04-04 Thu 13:22>.

It took 40:35.72 min. About 10 min too long!

The /general/ structure seems to be acceptable right now. But there is
plenty of room for improvement (of course more so in the latter half
regarding the limit than the former, it being less finalized).
Most importantly: I spent a long time talking about the
introduction. Like almost 5 min on the first 2 slides.

- [ ] How much time should I spend on introductions?
- [ ] I did not explain what a GridPix is!
- [ ] I did not really introduce the axion-electron coupling nor
  highlight the energy range and the distinction to axion-photon
  (where we knew we wouldn't be able to compete)
- [ ] I did not explain very well how the limit works. I just skipped
  over the likelihood function, but then had the plot of the
  likelihood function and it was difficult to explain.
  - [ ] Move actual limit explanation slides to backup
  - [ ] Replace limit by _ultra short_ explanation
    - what do we mean
    - likelihood function encapsulates "how likely given candidates
      match signal vs background at given coupling constant"
  - [ ]
- [ ] Did not explain well what candidates are
- [ ] "data unblinding" etc
- [ ] Shorten systematics and MCMC explanation
  - Explanation of uncertainty "might move axion image around" etc
    quite useful
- [ ] Mention TrAXer in a better way (will make more sense once
  raytracing screenshot there)
        

- [ ] How much talk about different setups and expected limits?

* Test talk #2 <2024-04-11 Thu 14:10>                              :noexport:

Just did another test talk. It took 34:47.64 min.

Time wise it was a lot better, but I think it might be too rushed.

- [ ] While I said that our detector includes the ability to detect
  individual electrons, I should show what a GridPix is!
  Otherwise things are too unclear
- [ ] I'm not convinced that talking about gas diffusion and MLP
  training data to the extent I did is valuable
- [ ] Explanation of limit method is problematic
- [ ] I did not really explain what candidates are.
- [ ] MCMC is also not well explained

* Test talk #3 <2024-04-15 Mon 20:04>                              :noexport:

And another test talk done. It took 34:04.75 min.

All in all I was reasonably happy with this one now. It's definitely
coming together. Most important points:

- [ ] I was a bit confused about the order of some slides in some
  cases (which made me wonder if the order of the slides should be
  changed after all? In particular should the 'ingredients' go
  *before* the systematics? I think it makes more sense in that sense!)
- [ ] It was definitely a bit fast. But not sure what to do about
  that.
- [ ] To cut it down a bit more, I could probably
  - shorten the beginning a bit more (or tighten it, while speaking)
  - shorten the part about MLPs a bit more?
  - remove the data reconstruction slide. Mostly not important.
- [ ] Explanation of geometric event shape and cosmics vs X-rays was a
  bit crappy. Also wasted time there!
- [ ] Explanation of MLP cut on output distribution was also a bit bad.      
- [ ] Explanation of MCMC, samples of g² was terrible
- [ ] Still not convinced I'm getting the axion-electron coupling
  across1

* Test talk #4 <2024-04-16 Tue 14:24>                              :noexport:

Another test talk, took 31:38.57 min.

The time I think is pretty good now.

I changed the structure to have the likelihood ingredients before the
systematics  etc. It think this makes it all more digestible.

Generally, _although there is still SHIT LOADS OF INFORMATION_ I think
it is approaching a talk that might be decent.

Ideally I would cut everything into about half the content, but that's
unrealistic.

- [ ] How to apply the MLP to data classification was better, but
  still a weak point.
- [ ] Explanation of MLP schematic was also not perfect  

* Talk for my PhD defense - structure                              :noexport:


1. Introduction metaphysics and how that can lead to the axion
2. Axion? Ah, can produce in the Sun!
3. Expected axion spectrum, blackbody similar
4. Helioscope experiments, example CAST
5. Show our setup at CAST, data taking there. What kind of detector?
6. Show exploded detector. Focus on GridPix functionality (slides
   showing detection we once created), and Septemboard. Other detector
   features only name them.
7. X-ray telescope! Creates image of axions! Small enough to fit on
   center chip! Show expected axion image
8. GridPix function: Can deduce expectation of signals!
   - low axion rate: background dominant
9. Try to find signal in tracking dataset! 
10. Biggest question: how find little signal in dataset?
11. Classifier needed: past used likelihood, now simple 2 layer MLP!
12. All know machine learning needs lots of data:
    - simulate X-ray events. Monte Carlo fun!
    - Background data of outer chips! Not needed for physics limit!
13. Verification based on CDL and 55Fe data
14. What happens if applied to center chip?
15. Septem veto! Show schematic from thesis what idea is!
    - improvement single -> septem full chip clusters or suppression
16. Have background. Can extract candidates.
17. Compute a limit! Quick (!) intro Bayesian unbinned likelihood
    method
18. Inclusion of systematics via nuisance parameters -> expensive
    evaluation. MCMC for rescue. MCMC example
19. Background interpolation and candidate sampling (& expected limits)
20. Mention signal inputs
21. Mention evaluated different setups etc, focus on best one. Show
    expected & observed limit
22. Method fully generic, also computed limits for axion-photon &
    chameleon.
23. Result presented, but not done: Something very important to me,
    reproducibility in science. Made sure all results reproducible,
    i.e. data and plots in theses have code snippets / commands
    associated with them, plots made available. Also as CSV for all
    plots other people can reproduce them / include them. All code
    made available. All data made available.
24. If you are physicist and only take one thing from my presentation,
    please focus on allowing your results to be reproducible. Not only
    for other people, but also 'future you'!
25. Summary and thank you.
    
** Thoughts about test talk on XXX

** Thoughts about the actual presentation

* Physics, math and philosophy?
** Physics, math and philosophy?                                  :noexport:

Mathematics has long served as a guiding tool in theoretical
physics. Symmetries, mathematical 'beauty' and the notion of
'naturalness' have long been successfully used to predict new
phenomena in physics to be verified experimentally later. Although we
may never know whether the universe actually cares about our funny
intuitions, in the lack of empirical evidence to the contrary we tend
to stick to such approaches. Arguably in the infinite space of
mathematical avenues physics /could/ express itself, this may be
considered an application of Occam's razor to physics. In a sense it
underlines the intersection between philosophy, mathematics and
physics and indicates that the term 'philosophy of nature' is not
actually wholly inapplicable to modern physics. And so we arrive at
one of our current representations of this in the form of an angle $θ$
in quantum chromodynamics. Measurements seem to indicate this angle is
essentially zero. However, we tend to reject the idea that our
universe simply /is/ such that $θ$ happens to be close to
zero. Instead we derive the simplest explanations as to why this might
be the case. And who can blame us when the result of accepting $θ = 0$
by nature would lead us precisely nowhere? Finding an explanation
spawns a new hypothetical friend in our zoo of particles, the
/axion/. The point of this thesis is to continue the search for this
zoo member by way of staring into the core of the Sun. With the help
of a very large number of /virtual/ photons we will attempt to entice
some axions to become real X-rays, directly detectable by us. And if
we fail in this quest, we can put our philosopher's hat back on and
muse about how little our axion friends want to dance with our virtual
photons.

** Physics, math and philosophy?

*** 
# - math a sort of guiding principle of physics
- find math compatible with current physics
  - $⇒$ is it realized in nature?
- example: result of such 'compatible math': neutron electric dipole moment (NEDM)
  - never measured, despite extremely precise measurements!
- 2 solutions:
  1. parameter proportional to NEDM happens to be zero! (pure chance)
  2. there exists an underlying *reason* for it to be ~zero
- physicists like solutions like 2, it allows to continue thinking
  ahead to potentially arrive at experimentally testable ideas

*** The axion
- the axion is such a 'solution 2'
- neatly 'disables' the NEDM
- new particle we might detect. Even less interactions than neutrinos!
- however: very low -- but non zero -- coupling to photons
- $⇒$ places with *large* numbers of interacting photons
  (i.e. 'light') may produce axions in large quantities!
- *bonus*: possibly a candidate for _dark matter_

*** Notes about introduction                                     :noexport:

Given the short time of 30min for this talk, I could approach it from
2 directions:
1. Dive deep into _one_ particular topic
2. Give you a broad overview about the work done in the thesis as a
   whole.

This talk focuses on approach 2. This means I won't be able to
actually explain most things in any detail, but I hope it means you
get a sense of the 'entirety' of the thesis.

1. The axion
2. The Sun
3. CAST as a means to detect axions from the Sun
4. Detect how? Gaseous detector fundamental principle
5. Septemboard detector + data taking at CAST
6. Data expectations
7. Classify data, MLP
8. MLP training data, simulation of events
9. Background rate MLP
10. Line veto
11. Computing a limit - limit method
12. Ingredients, Sun, Magnet, Telescope, Detector. Background interp
13. Systematics + MCMC
14. 
    

* Axion detection
** The Sun

#+ATTR_LATEX: :height 0.9\textheight
[[~/phd/Figs/talk/nasa_sun_GSFC_20171208_Archive.jpg]]

*** Origin of image :noexport:

The (current) image is from here:
https://science.nasa.gov/image-detail/amf-gsfc_20171208_archive_e001435/

** The Sun

*** 
:PROPERTIES:
:BEAMER_col: 0.4
:BEAMER_env: block
:END:

# - have very good models and general understanding of how the Sun works
- life time of about 10 billion years! Plenty of margin for
  error in our understanding.
- very high pressures in solar core lead to proton-proton fusion
- huge amount of photons produced in solar core
- because of extremely high density, photons take about 1 million
  years to escape from the core!
  - Why? Photons interact *constantly* with surrounding material and
    each other!
  - $⇒$ potential *'axion factory'*!
  - produced axions likely leave Sun without further interactions
- axions cause additional 'cooling' of the Sun. Too many produced and
  leave, the Sun would age too quickly!

*** 
:PROPERTIES:
:BEAMER_col: 0.6
:BEAMER_env: block
:END:

#+ATTR_LATEX: :height 0.8\textheight
[[~/phd/Figs/talk/nasa_sun_GSFC_20171208_Archive.jpg]]
  
*** TODO huh                                                     :noexport:

- have a schematic of pp fusion?
- some plot of solar model? i.e. radius vs temperature, density to
  showcase 'understanding'?
    
** CERN Axion Solar Telescope - CAST

#+ATTR_LATEX: :width 0.6\textwidth
[[~/phd/Figs/CAST_panorama_mine.jpg]]

*** If axions produced in the Sun, can we detect them?
- $γ + γ ↦ a$ implies $γ + a ↦ γ$! ($γ$: photon, $a$: axion)
- what is a \orange{magnet}? A large source of (virtual) photons!
- build a 'telescope' from a magnet and track the Sun
# - axion interacting with magnet: produces photon with energy of
#  axion. What is that energy? Energy of original photons.
- Sun 15 million K in core: as photons, *soft X-rays*
- Do we expect many X-rays? *No*
  - $⇒$ use an X-ray telescope to focus X-rays onto a tiny area

*** TODO huh                                                     :noexport:

- split this into 2 identical slides, just replace the text above?
  - [ ] Need to fix the height and placement of the CAST image
  - [ ] Set it with TikZ?

** Gaseous detectors - Working principle

#+BEGIN_EXPORT latex
\begin{figure}[H]
  \only<1>{\includegraphics[width=0.8\textwidth]{~/org/Figs/detector_explanation/detector.pdf}}
  \only<2>{\includegraphics[width=0.8\textwidth]{~/org/Figs/detector_explanation/detector_w_photon.pdf}}
  \only<3>{\includegraphics[width=0.8\textwidth]{~/org/Figs/detector_explanation/semicut_detector_photon_gas.pdf}}
  \only<4>{\includegraphics[width=0.8\textwidth]{~/org/Figs/detector_explanation/semicut_detector_gas_photoelec.pdf}}
  \only<5>{\includegraphics[width=0.8\textwidth]{~/org/Figs/detector_explanation/semicut_detector_prim_elecs.pdf}}
  \only<6>{\includegraphics[width=0.8\textwidth]{~/org/Figs/detector_explanation/semicut_detector_prim_elecs_E.pdf}}
  \only<7>{\includegraphics[width=0.8\textwidth]{~/org/Figs/detector_explanation/semicut_detector_diff_cloud.pdf}}
\end{figure}
#+END_EXPORT

*** IMPORTANT                                                    :noexport:

Important point:
When explaining this slide I will have to *emphasize* gas diffusion!
Primary electrons drift apart!

** GridPix


#+ATTR_LATEX: :width 0.8\textwidth
[[~/org/Figs/detector_explanation/semicut_detector_diff_cloud.pdf]]

# remember picuture and overlay are important!
\begin{tikzpicture}[remember picture, overlay]
  \node[anchor=north west,xshift = 1cm, yshift = -1cm] at (current page.north west) {\includegraphics[width=0.4\textwidth]{~/phd/Figs/ingrid_principle.pdf}};
\end{tikzpicture}

* Detector and data taking at CAST
** Septemboard detector
*** 
:PROPERTIES:
:BEAMER_col: 0.6
:BEAMER_env: block
:END:

- \orange{7 GridPix}, one center (contains axion image), 6 as a \orange{'veto ring'}
- shutter based readout, \SI{2.4}{\second} frames at CAST  
- FADC measuring decoupled signals from center grid
  - trigger (close shutter early)
  - theoretically as means to get longitudinal event
    shape information. Latter very problematic due to noise & required
    signal integration
- 2 scintillators
  - top veto paddle
  - SiPM behind board
  \Rightarrow only have trigger information of each, and only in 2018
  data taking

*** 
:PROPERTIES:
:BEAMER_col: 0.4
:BEAMER_env: block
:END:

#+begin_center
#+ATTR_LATEX: :height 0.8\textheight
[[~/org/Figs/detector-mk4c-assembly2_with_axion_image.png]]
#+end_center

* CAST Data taking overview
    
** Data taking

- Run-1: 2014/15 data taking with single GridPix detector (not part of
  this talk)
  
- \orange{Run-2}: October 2017 - March 2018

- \orange{Run-3}: October 2018 - December 2018

- X-ray reference data: February 2019 detector in CAST detector lab
  behind X-ray tube

#+ATTR_LATEX: :align lrrrrr :booktabs t
|       | Solar tracking [h] | Active s. [h] | Background [h] | Active b. [h] | Active [%] |
|-------+--------------------+---------------+----------------+---------------+------------|
| Run-2 |            106.006 |       93.3689 |        2391.16 |       2144.12 |      89.65 |
| Run-3 |            74.2981 |       67.0066 |        1124.93 |       1012.68 |      90.02 |
| Total |           180.3041 |      160.3755 |        3516.09 |       3157.35 |      89.52 |

* Expected data
** Example events
- X-ray & background events geometrically different
- compute properties to classify them by
- background can vary *wildly*. Majority track like

*** Typical event shapes

#+ATTR_LATEX: :width 0.8\textwidth
[[~/phd/Figs/reco/gridpix_example_events.pdf]]

\begin{tikzpicture}[remember picture, overlay]
\node[anchor=north west, xshift = 7.9cm, yshift = -4.2cm] at (current page.north west) {
  \begin{minipage}{4cm}
    \small Each point corresponds to one 'hole' activated on the GridPix
  \end{minipage}
};
\end{tikzpicture}

** Data expectations and classifiers

*** Expectations

- do we expect many X-rays? No
- what do we expect much of? Background!
  - cosmic particles (muons)
  - radioactive background
- most difficult task: find X-rays in huge 'hay stack' of background
  data
- need a *data classifier*
  - take a detector 'image': classify as X-ray or background
  
*** Multilayer Perceptron (MLP) as a classifier

- an MLP is the simplest type of neural network. 'Feed forward' and
  'fully connected'.

- well known fact that machine learning models need 2 things:
  1. a network layout with chosen input data and expected output data  
  2. lots of 'training data'

- how do we choose input data? What do we even do with our GridPix
  data? *Data reconstruction*

* Data reconstruction

** Data reconstruction                                            :noexport:

#+begin_center
#+ATTR_LATEX: :width 0.8\textwidth
[[~/org/Figs/InGridRecoExplanation/ingrid_data_reco_explanation_bigger.pdf]]
#+end_center

** Data reconstruction

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/pixels.pdf]]
#+end_center

** Data reconstruction

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/center.pdf]]
#+end_center

** Data reconstruction

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/long_short_axis.pdf]]
#+end_center

** Data reconstruction

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/rms_trans.pdf]]
#+end_center

** Data reconstruction

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/eccentricity.pdf]]
#+end_center

** Data reconstruction :noexport:

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/frac_in_trans_rms.pdf]]
#+end_center

** Data reconstruction :noexport:

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/length_div_rms_trans.pdf]]
#+end_center


* MLP continued

** MLP layout

- 2 hidden layers, 30 neurons on each, $\tanh$ activation function,
  MSE loss, Adam optimizer

*** Example: MLP with 10 neurons on each hidden layer

#+ATTR_LATEX: :height 0.8\textheight  
[[~/phd/Figs/talk/mlp_schematic_10_neuron_mlp.pdf]]

\begin{tikzpicture}[remember picture, overlay]
\node[anchor=north west, xshift = 10.5cm, yshift = -3cm] at (current page.north west) {
  \begin{minipage}{4.5cm}
    \footnotesize\orange{Hint:} This network performs almost as good as the 30 neuron network used in practice!
  \end{minipage}
};
\end{tikzpicture}

**** Generate the MLP schematic                                 :noexport:

Should be run on my desktop (files only there):
#+begin_src sh
./nn_investigate \
    --modelPath ~/org/resources/nn_devel_mixing/17_11_23_adam_tanh10_sigmoid_mse_3keV/mlp_tanh_sigmoid_MSE_Adam_10_2checkpoint_epoch_84000_loss_0.0254_acc_0.9655.pt \
    --writeTeX \
    --schematic ~/phd/Figs/talk/mlp_schematic_10_neuron_mlp.pdf
#+end_src


*** TODO huh                                                     :noexport:

Maybe create an Inkscape / graphviz graphic of our MLP architecture?

With graphviz it shouldn't be too hard, no?

Produces a schematic:
[[file:~/org/Misc/mlp_schematic_ggplotnim.nim]]

We'll merge that with ~nn_investigate.nim~ and then we can have a real
visualization of an existing model!

- [ ] Where do inputs come from?
- [ ] Where does training data come from?
    
** What actually *is* a MLP?

# push up a bit
# \vspace{-0.5cm} 
#+ATTR_LATEX: :width 1.1\textwidth
[[~/phd/Figs/talk/tex_mlp.pdf]]

** MLP training

*** But where does such a network come from?
- MLP needs training! Backpropagation using some optimization
  algorithm
- most importantly: need *training data*

- trained on 250k X-ray and background events each (plus same number
  for validation)

*** Data  
Background data:
- detector has 6 outer chips, which do not 'see' axions: use subset
  of *CAST background data of those chips*

X-ray data:
Have 2 types of data with real X-rays
- 55Fe calibration data at CAST (lots of statistics, but only
  2 [fn:not_really] energies)
- X-ray tube data with 8 energies (low statistics)

Additional problem:
Detector behavior not constant over time and different between CAST
data and X-ray tube data!

[fn:not_really] Strictly speaking only 1 energy: Escape peak events are still
5.9 keV photons!  

* Much data
** Data instability & lack of statistics for different energies: what to do?

*** Simulate X-rays!
- X-ray event shape relatively simple. *Assume*: all primary electrons
  produced in a single position
- using 3 gas parameters:
  1. gas gain
  2. target energy
  3. gas diffusion
     
- \orange{Gas gain} : determined from data via histogram of recorded charges
- \orange{Target energy} : depends on the desired X-rays to simulate
- \orange{Gas diffusion} : *Tricky*! Needs careful approach, but _can_ be
  extracted from data using an optimization routine (which itself
  depends on simulating events!)

*** Training data

Simulate X-rays of variety of gas gains, gas diffusions and uniform energies.

** Data where from?                                               :noexport:
- outer chips for background! Do not contain axion signal!
- simulate X-rays! Very simple event shapes, in theory!
- MC simulation
- [X] mention CDL data (and disagreement) as an aside  
- [X] backup slide of algorithm!
- [X] *PLOT OF* agreement between simulated and real events

* Simulated vs real data
** Simulated and real data comparison

#+ATTR_LATEX: :height 0.9\textheight
[[~/phd/Figs/fakeEventSimulation/runComparisons/ingrid_properties_run_241_ridgeline_kde_by_run.pdf]]

* Background rejection

** X-ray reference data                                           :noexport:
*** 
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:
*THIS IS LNL, NEED MLP*

- taken data behind X-ray tube w/ 8 different targets
- each target defines reference for X-rays at that energy
- energies between obtained using linear interpolation  
- use 3 geometric properties to define likelihood cluster is X-ray
\[
\mathcal{L}(ε, f, l) = \mathcal{L}_{ε}(ε) \cdot \mathcal{L}_{f}(f) \cdot \mathcal{L}_l(l)
\]
- define $-\ln\mathcal{L}$ cut based on it, such that
\[
ε_{\text{eff}} = \frac{∫_0^{L'} -\ln \mathcal{L}(ε, f, l) \,
\mathrm{d} L}{∫_0^{∞} -\ln \mathcal{L}(ε, f, l) \, \mathrm{d} L} =
\text{EDF @ } ε_{\text{eff}}
\]

*** REPLACE BY PLOT WITH ~energyFromCdl~!
:PROPERTIES:
:BEAMER_col: 0.6
:BEAMER_env: block
:END:
#+BEGIN_CENTER 
#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/CDL/calibrated_cdl_energy_histos.pdf]]
#+END_CENTER

** Background rate without vetoes

*** 
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:

**** How to apply to data?

1. determine gas gain, gas diffusion for data run
2. simulate X-rays matching parameters
3. determine output cut value based on desired efficiency (for 8 energies)

**** MLP output for one neuron
#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/neuralNetworks/17_11_23_adam_tanh30_sigmoid_mse_3keV/test_validation_log10.pdf]]

*** Background rate MLP ($ε = \SI{95}{\%}$)
:PROPERTIES:
:BEAMER_col: 0.6
:BEAMER_env: block
:END:

#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/talk/background/background_rate_gold_mlp_0.95.pdf]]

\vspace{-0.35cm}
**** Mean background rate (in $\SIrange{0.2}{8}{keV}$)

$\text{MLP}: \SI{2.01631(9537)e-05}{keV^{-1}.cm^{-2}.s^{-1}}$

**** Generate plot of background rate                           :noexport:

This is a derived command from
[[file:~/phd/thesis.org::#sec:background:gen_bck_rate_mlp]] to have a plot
with _only_ the background rate of the MLP @ 95%.

#+begin_src sh :results drawer
plotBackgroundRate \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R2_crAll_sEff_0.95_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662.h5 \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R3_crAll_sEff_0.95_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662.h5 \
    --centerChip 3 \
    --names "MLP@0.95" --names "MLP@0.95" \
    --title "Background rate in center 5·5 mm², MLP at $\epsilon = 0.95$" \
    --showNumClusters \
    --region crGold \
    --showTotalTime \
    --topMargin 1.5 \
    --energyDset energyFromCharge \
    --energyMin 0.2 \
    --outfile background_rate_gold_mlp_0.95.pdf \
    --outpath ~/phd/Figs/talk/background/ \
    --useTeX \
    --quiet
#+end_src
:RESULTS:
Manual rate = 2.04544(7810)e-05
[INFO]:Dataset: MLP@0.95
[INFO]:  Integrated background rate in range: 0.2 .. 12.0: 2.41362(9215)e-04 cm⁻²·s⁻¹
[INFO]:  Integrated background rate/keV in range: 0.2 .. 12.0: 2.04544(7810)e-05 keV⁻¹·cm⁻²·s⁻¹
Manual rate = 1.9175(1837)e-05
[INFO]:Dataset: MLP@0.95
[INFO]:  Integrated background rate in range: 0.5 .. 2.5: 3.8350(3673)e-05 cm⁻²·s⁻¹
[INFO]:  Integrated background rate/keV in range: 0.5 .. 2.5: 1.9175(1837)e-05 keV⁻¹·cm⁻²·s⁻¹
Manual rate = 2.3456(1354)e-05
[INFO]:Dataset: MLP@0.95
[INFO]:  Integrated background rate in range: 0.5 .. 5.0: 1.05552(6094)e-04 cm⁻²·s⁻¹
[INFO]:  Integrated background rate/keV in range: 0.5 .. 5.0: 2.3456(1354)e-05 keV⁻¹·cm⁻²·s⁻¹
Manual rate = 2.5088(1959)e-05
[INFO]:Dataset: MLP@0.95
[INFO]:  Integrated background rate in range: 0.2 .. 2.5: 5.7702(4506)e-05 cm⁻²·s⁻¹
[INFO]:  Integrated background rate/keV in range: 0.2 .. 2.5: 2.5088(1959)e-05 keV⁻¹·cm⁻²·s⁻¹
Manual rate = 1.02033(9474)e-05
[INFO]:Dataset: MLP@0.95
[INFO]:  Integrated background rate in range: 4.0 .. 8.0: 4.0813(3789)e-05 cm⁻²·s⁻¹
[INFO]:  Integrated background rate/keV in range: 4.0 .. 8.0: 1.02033(9474)e-05 keV⁻¹·cm⁻²·s⁻¹
Manual rate = 1.7827(1022)e-05
[INFO]:Dataset: MLP@0.95
[INFO]:  Integrated background rate in range: 2.0 .. 8.0: 1.06959(6135)e-04 cm⁻²·s⁻¹
[INFO]:  Integrated background rate/keV in range: 2.0 .. 8.0: 1.7827(1022)e-05 keV⁻¹·cm⁻²·s⁻¹
Manual rate = 2.01631(9537)e-05
[INFO]:Dataset: MLP@0.95
[INFO]:  Integrated background rate in range: 0.2 .. 8.0: 1.57272(7439)e-04 cm⁻²·s⁻¹
[INFO]:  Integrated background rate/keV in range: 0.2 .. 8.0: 2.01631(9537)e-05 keV⁻¹·cm⁻²·s⁻¹
| Classifier | ε_eff | Scinti | FADC | Septem | Line | ε_total | rateMeas | Rate |
| MLP | 0.957 | false | false | false | false | 0.957 | (2.0163 +- 0.0954)e-05 | 2.01631(9537)e-05 |

:END:

** MLP :noexport:

- Multilayer Perceptron: fully connected feed-forward network
- *MATH?*
  $n_i,k = Σ_j f(n_j,(k-1) · ω_j,(k-1)) + b_j$
  -> Neuron i on layer k is sum of all neuron inputs on layer (k-1)
  multiplied by the weight of each fed through the activation function
  f, plus a potential bias offset
- one input neuron per geometric property, plus 2 non-geometric
- 2 hidden layers, 300 neurons each, tanh (or ReLU) activation
  function, 2 output neurons, sigmoid on output layer, mean squared
  error as loss function
- trained using stochastic gradient descent (SGD) for 500k epochs
- training data 250k background and 250k X-rays (and same number for
  validation)

- background data: from actual background dataset
- X-ray data: fully simulated events, inputs:
  - gas diffusion, gas gain, target energy
- *appendix slide on simulation?*
- *HOW TO DEDUCE CUT VALUES, PURE SIMULATION TOO, PER ENERGY RANGE*
      
** 'Line veto'
*** How can we use outer ring as a veto?
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:

- ionization is statistical. May be gaps in ionization larger than
  cluster 'search range'
- \Rightarrow not only use distance (i.e. clustering). If eccentric cluster
  "points" at cluster passing
- blue cluster 'points' at red cluster in center (green line cuts
  black circle)
$↦$ efficiency: $\SI{86.02}{\%}$  

*** Example of event vetoed by 'line veto'
:PROPERTIES:
:BEAMER_col: 0.6
:BEAMER_env: block
:END:

#+begin_center
#+ATTR_LATEX: :width 0.8\textwidth
[[~/phd/Figs/background/exampleEvents/septemEvent_run_261_event_44109.pdf]]
#+end_center


** Background rates with vetoes

*** Background rate with vetoes                         :B_block:BMCOL:
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:
- scintillator
- fadc
- line veto
Mean background rates (in $\SIrange{0.2}{8}{keV}$):
- $\text{No vetoes}: \SI{2.01631(9537)e-05}{keV^{-1}.cm^{-2}.s^{-1}}$
- $\text{Vetoes}: \SI{1.05552(6900)e-05}{keV^{-1}.cm^{-2}.s^{-1}}$

*** Rates comparing MLP with and without vetoes             :B_block:BMCOL:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.6
:END:

#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/talk/background/background_rate_gold_mlp_0.95_scinti_fadc_line_vs_no_vetos.pdf]]


**** Generate plot of background rate w/ and w/o vetoes         :noexport:

Version of the above command (only MLP) with veto (line veto) added:
#+begin_src sh :results drawer
plotBackgroundRate \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R2_crAll_sEff_0.95_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662.h5 \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R3_crAll_sEff_0.95_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662.h5 \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R2_crAll_sEff_0.95_scinti_fadc_line_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662_vQ_0.99.h5 \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R3_crAll_sEff_0.95_scinti_fadc_line_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662_vQ_0.99.h5 \
    --centerChip 3 \
    --names "No vetoes" --names "No vetoes" \
    --names "Vetoes" --names "Vetoes" \
    --title "Background rate in center 5·5 mm², MLP at $\epsilon = 0.95$" \
    --showNumClusters \
    --region crGold \
    --showTotalTime \
    --topMargin 1.5 \
    --energyDset energyFromCharge \
    --energyMin 0.2 \
    --outfile background_rate_gold_mlp_0.95_scinti_fadc_line_vs_no_vetos.pdf \
    --outpath ~/phd/Figs/talk/background/ \
    --useTeX \
    --quiet
#+end_src
:RESULTS:
| Classifier | ε_eff | Scinti | FADC | Septem | Line | ε_total | rateMeas | Rate |
| MLP | 0.957 | true | true | false | true | 0.807 | (1.0555 +- 0.0690)e-05 | 1.05552(6900)e-05 |
| MLP | 0.957 | false | false | false | false | 0.957 | (2.0163 +- 0.0954)e-05 | 2.01631(9537)e-05 |
:END:

# *** Background rate with all vetoes                         :B_block:BMCOL:
# :PROPERTIES:
# :BEAMER_col: 0.45
# :BEAMER_env: block
# :END:
# - scintillator
# - fadc
# - septem veto
# - line veto
# Mean background rates (in $\SIrange{0.2}{8}{keV}$):
# - $\ln\mathcal{L}: \SI{7.98e-06}{keV^{-1}.cm^{-2}.s^{-1}}$
# - $\text{MLP}: \SI{1.14e-05}{keV^{-1}.cm^{-2}.s^{-1}}$ (and at $ε = \SI{80}{\%}: \SI{7.17e-06}{keV^{-1}.cm^{-2}.s^{-1}}$)
# *** Rates comparing $\ln\mathcal{L}$ and MLP with / without vetoes :B_block:BMCOL:
# :PROPERTIES:
# :BEAMER_env: block
# :BEAMER_col: 0.6
# :END:
# 
# #+ATTR_LATEX: :width 1.0\textwidth
[[# ~/org/Figs/statusAndProgress/backgroundRates/limitMethodTalk/background_rate_run2_3_mlp_0.99_plus_vetoes.pdf]]

** Background over whole chip
- each dot: center of a cluster
- yields $\approx 6$ times reduction in total background: $\sim{95000} ⇒ \sim{16000}$ clusters
*** Background whole chip w/o vetoes
:PROPERTIES:
:BEAMER_col: 0.5
:BEAMER_env: block
:END:
#+begin_center
#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/talk/backgroundClusters/background_cluster_centers_mlp_95_adam_tanh30_sigmoid_mse_82k.pdf]]
#+end_center
*** Background whole chip w/ line veto
:PROPERTIES:
:BEAMER_col: 0.5
:BEAMER_env: block
:END:
#+begin_center
#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/talk/backgroundClusters/background_cluster_centers_mlp_95_scinti_fadc_line_adam_tanh30_sigmoid_mse_82k.pdf]]
#+end_center

*** Generate plots of background clusters for MLP@95             :noexport:

Based on sec. [[file:~/phd/thesis.org::#sec:background:gen_bck_cluster_plots_all_vetoes]]:

No vetoes:
#+begin_src sh :results drawer 
ESCAPE_LATEX=true plotBackgroundClusters \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R2_crAll_sEff_0.95_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662.h5 \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R3_crAll_sEff_0.95_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662.h5 \
    --zMax 30 \
    --title "MLP@95%, no vetoes" \
    --outpath ~/phd/Figs/talk/backgroundClusters/ \
    --filterNoisyPixels \
    --showGoldRegion \
    --energyMin 0.2 --energyMax 12.0 \
    --suffix "_mlp_95_adam_tanh30_sigmoid_mse_82k" \
    --backgroundSuppression \
    --useTikZ
#+end_src

Scinti+FADC+Line:
#+begin_src sh :results drawer 
ESCAPE_LATEX=true plotBackgroundClusters \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R2_crAll_sEff_0.95_scinti_fadc_line_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662_vQ_0.99.h5 \
    ~/org/resources/lhood_mlp_17_11_23_adam_tanh30_sigmoid_mse_82k/lhood_c18_R3_crAll_sEff_0.95_scinti_fadc_line_mlp_mlp_tanh_sigmoid_MSE_Adam_30_2checkpoint_epoch_82000_loss_0.0249_acc_0.9662_vQ_0.99.h5 \
    --zMax 5 \
    --title "MLP@95%, vetoes" \
    --outpath ~/phd/Figs/talk/backgroundClusters/ \
    --filterNoisyPixels \
    --showGoldRegion \
    --energyMin 0.2 --energyMax 12.0 \
    --suffix "_mlp_95_scinti_fadc_line_adam_tanh30_sigmoid_mse_82k" \
    --backgroundSuppression \
    --useTikZ
#+end_src



* Background rate :noexport:

In practice not a single ideal combination of parameters & vetoes to
use. Instead: Decide on the "best" setting by their result on expected
limits! 


* Limit method :noexport:

- what's a limit?

- Show at least the basic Q = XY  

- MATH
  
- systematics
  - table of
- systematics make likelihood L more complicated! Integrating out
  parameters to get posterior distribution becomes intractable with 4
  additional parameters!
- Markov Chain MonteCarlo (MCMC) for the rescue
- Metropolis-Hastings algorithm
- used instead of integration to evaluate posterior  

- build 5(?) chains of 150k elements, burn-in is first 50k
- 

* Computing a limit
** Computing a limit

*** At this point:
- able to classify data as X-ray or background like
- \orange{Axion}?
- Classifier applied to solar tracking data: *axion candidates* 
- in absence of signal: compute limit on coupling constant

*** Limit calculation method
Bayesian unbinned likelihood approach,
\[
\Lhood(g_{ae}) = e^{-s_\text{tot}(g_{ae})} \prod_i \left(1 +
\frac{s_i(g_{ae}, E_i, \vec{x}_i)}{b_i(E_i, \vec{x}_i)}\right),
\]
where the product $\prod_i$ runs over all candidates with energies
$E_i$ and positions $\vec{x}_i$.

- $s_i$ ($s_{\text{tot}}$): Signal related to individual candidates
  (all candidates)
- $b_i$: background associated with individual candidate

** Ingredients for a limit calculation

#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/talk/CAST_annotations/CAST_panorama_annotated_sun.jpg]]


** Axion flux

- $g_{aγ} = \SI[print-unity-mantissa=false]{1e-12}{GeV^{-1}}$ kept constant and implies negligible
  contribution to axion flux (relevant only for $P_{aγ}$)

*** Axion flux from Sun

#+ATTR_LATEX: :width 0.7\textwidth
[[~/phd/Figs/axions/differential_solar_axion_flux_by_type.pdf]]

** Ingredients for a limit calculation

#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/talk/CAST_annotations/CAST_panorama_annotated_magnet.jpg]]

** Magnet and constant contributions                                

*** Area, time

- magnet bore area: $A = π · (\SI{2.15}{cm})² = \SI{14.52}{cm²}$
- tracking time: $t = \SI{160}{h}$ (dead time taken into account)

*** Axion-photon conversion probability

Conversion probability of axions to photons in CAST magnet:
\[
P_{a↦γ, \text{vacuum}} = ε_0 \hbar c^3 \left( \frac{g_{aγ} B L}{2} \right)^2.
\]
$⇒ P_{aγ}(g_{aγ} = \SI{1e-12}{GeV⁻¹}) = \num{1.78e-21}$

#+begin_src nim :exports none
import unchained, math
defUnit(GeV⁻¹)
func conversionProb(B: Tesla, L: Meter, g_aγ: GeV⁻¹): UnitLess =
  result = pow( (g_aγ * B.toNaturalUnit * L.toNaturalUnit / 2.0), 2.0 )
echo conversionProb(9.0.T, 9.26.m, 1e-12.GeV⁻¹)
#+end_src

#+RESULTS:
: 1.70182e-21 UnitLess

** Ingredients for a limit calculation

#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/talk/CAST_annotations/CAST_panorama_annotated_telescope.jpg]]

** LLNL telescope

*** Front view
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.2
:END:

[[~/phd/Figs/LLNL/llnl_open_back_rotated.jpg]]

*** Raytracing image
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:

#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/raytracing/traxer_cast_llnl_setup_sun.png]]

# [[~/phd/Figs/raytracing/traxer_cast_view_top_magnet_to_imagesensor.png]]

*** Axion image
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:

#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/raytracing/solar_axion_image_fkAxionElectronPhoton_0.989AU_1492.93mm.pdf]]



**** TODO Think about ignoring strongback                       :noexport:
[[~/phd/Figs/limit/sanity/axion_image_limit_calc_no_theta.pdf]]


*** TODO Plots / images needed                                   :noexport:

- [X] X-ray optics

- [ ] *SCREENSHOT RAYTRACER*

- [X] *AXION IMAGE*

** Ingredients for a limit calculation

#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/talk/CAST_annotations/CAST_panorama_annotated_detector.jpg]]

** Detection efficiency

*** Detection efficiency dominated by:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:
- $\SI{300}{\nano\meter}$ SiN window at low energies
- LLNL telescope efficiency at medium to high energies
- Argon absorption at high energy and around fluorescence near $\SI{3}{keV}$ 
- \orange{Note}: Software efficiencies are *not* included!
*** 
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.6
:END:
#+ATTR_LATEX: :width 1.0\textwidth
[[~/phd/Figs/limit/detection_efficiency.pdf]]


** Background $b_i$ 
Using background over whole chip, compute smooth interpolation using
weighted nearest neighbor approach.
# - [ ] redo k-d tree plot. In background_interpolation.nim
*** Cluster centers after MLP + vetoes                           :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/phd/Figs/limit/sanity/interpolation_clusters_E_3.0_keV_x_110_y_80.pdf]]

*** Interpolation of background at specific energy               :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/phd/Figs/limit/sanity/normalized_interpolation_at_3.0keV_ymax_5e-05.pdf]]

** Computing a limit

*** Limit definition                                             :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:

#+begin_comment
With this in mind the "limit" is defined as the 95-th percentile of 
$\mathcal{L}(g)$  (the region $g < 0$ is
explicitly ignored, as a coupling constant cannot be negative! This
can be "rigorously" justified in Bayesian statistics by saying the
prior $π(g)$ is 0 for $g < 0$.).
#+end_comment

- Limit: 95-th percentile of $\mathcal{L}(g)$ *within the physical region of $g$*
- unphysical region excluded by prior $π(g)$
\[
π(g) = \begin{cases}
  1 \text{ if } g \geq 0 \\
  0 \text{ else}
  \end{cases}
\]
with the limit defined at $g'$ via the relation  
\[
0.95 = \frac{∫_{-∞}^{g'} \mathcal{L}(g) π(g) \, \mathrm{d}g}{∫_{-∞}^∞ \mathcal{L}(g) π(g) \, \mathrm{d}g}
\]

*** Likelihood with limit: Easy, just scan $\mathcal{L}$ along $g$! :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.6
:END:

[[~/phd/Figs/limit/simple_likelihood_limit_example.pdf]]

** Oh, no. Systematics

| Uncertainty                                    | $s$ or $b$?    | rel. $σ$ [%] | bias?                             |
|------------------------------------------------+----------------+--------------+-----------------------------------|
| Earth $⇔$ Sun distance                         | $s$            |       0.7732 | none                              |
| Window thickness ($±\SI{10}{nm}$)              | $s$            |       0.5807 | none                              |
| Solar models                                   | $s$            |          < 1 | none                              |
| Magnet length ($-\SI{1}{cm}$)                  | $s$            |       0.2159 | likely 9.26m                      |
| Magnet bore diameter ($±\SI{0.5}{mm}$)         | $s$            |       2.3255 | measurements indicate 42.x - 43   |
| Window rotation (30° ± 0.5°)                   | $s$            |       0.1852 | none                              |
| Software efficiency                            | $s$            |        < 2.0 | exact value depends on parameters |
|------------------------------------------------+----------------+--------------+-----------------------------------|
| Gas gain time binning                          | $b$            |       0.2692 | to 0                              |
| Reference dist interp (CDL morphing)           | $b$            |       0.0844 | none                              |
|------------------------------------------------+----------------+--------------+-----------------------------------|
| Alignment (signal, related mounting)           | $s$ (position) |       0.5 mm | none                              |
| Detector mounting precision ($±\SI{0.25}{mm}$) | $s$ (position) |      0.25 mm | none                              |

** Computing the likelihood function is easy?

*** Likelihood with nuisance parameters is problematic
- $\mathcal{L'}$ a function of 5 parameters!
- $\text{EDF}(g_{ae}') \text{ @ } \SI{95}{\%}$ not well defined, infinite
  $g_{ae}'$
- need to remove nuisance parameters, but keep their effect on the likelihood  

*** Integration yields "marginal posterior likelihood"

[[~/org/Figs/statusAndProgress/limitCalculation/posterior_likelihood_annotated.pdf]]

*** Solution: Metropolis-Hastings (Markov Chain Monte Carlo)

Allows to sample integration space in regions of high likelihood, such
that $g_{ae}$ samples follow distribution of marginal posterior
likelihood!

** Example MCMCs

MCMC will sample most in space of high likelihood.

*** $g_{ae}², θ_y, θ_x$                                          :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/phd/Figs/limit/sanity/mcmc_lines_thetas_gy_real_syst_real_random_cands_0.pdf]]

*** $θ_s, θ_b, g_{ae}²$                                          :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/phd/Figs/limit/sanity/mcmc_lines_thetas_sb_real_syst_real_random_cands_0.pdf]]

** A limit, but which?

*** In reality not *a* single limit

Usage of different \orange{classifier}, \orange{software efficiencies}
and \orange{vetoes} yield different limits!

*** "Expected limits" to evaluate final approach

- generate fake candidates following background distribution
- compute limit for each
- *median* of all: \orange{expected limit}
- best expected limit: final setup
- only unblind data *after* selected ('blind analysis')

** Ingredients and method in place: Limit

Based on the expected limit, the method I presented was selected and
the data unblinded...

** Observed candidates

***                            :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:

- \orange{Energy of interest}: $\SIrange{1}{4}{keV}$ for axions,
  depending on model
- applying MLP @ $\SI{95}{\%}$ efficiency + line veto: 850 candidates
  in $\SI{160}{h}$ of solar tracking data
- 2 candidates in exact center, but energy too high ($\SI{8}{keV}$, copper
  fluorescence)
- 2 candidates at $\SI{3}{keV}$ at border of region of interest, but
  likely argon fluorescence

***                                           :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.6
:END:


#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/trackingCandidates/background_cluster_centersmlp_0.95_scinti_fadc_line_tracking_candidates_axion_image_with_energy_radius_85.pdf]]

** Observed limit

*** Limit for the axion-electron coupling
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:

\[
\left(g_{ae} · g_{aγ}\right)_{\text{observed}} \lesssim \SI{7.35e-23}{GeV^{-1}}
\]

compared to previous best limit (CAST 2013):

\[
\left(g_{ae} · g_{aγ}\right)_{\text{CAST2013}} \lesssim \SI{8.1e-23}{GeV^{-1}}.
\]


*** Posterior marginal likelihood
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.6
:END:

[[~/phd/Figs/trackingCandidates/mcmc_real_limit_likelihood_ck_g_ae².pdf]]

** Other limits

*** Axion-photon coupling
  \[
  g_{aγ, \text{observed}} \lesssim \SI{9.0e-11}{GeV⁻¹} \text{ at } \SI{95}{\%} \text{ CL}.
  \]
  (current best: $g_{aγ, \text{Nature, 2017}} < \SI{6.6e-11}{GeV⁻¹}$)
  
  *but*: our data will be used for a combined axion-photon limit with
  current Micromegas data!

*** Chameleon coupling
  \[
  β_{γ, \text{observed}} \lesssim \num{3.1e+10} \text{ at } \SI{95}{\%} \text{ CL}.
  \]
  *Good improvement* over previous best limit:
  \[
  β_{γ, \text{Krieger}} < \num{5.74e10} \text{ at } \SI{95}{\%} \text{ CL},
  \]


** 1 minute aside - reproducibility in science / physics          :noexport:

- want to mention one thing important to me
- reproducibility in science is often very bad
- plots, tables, numbers in papers / theses often very hard to
  reproduce few years down the line *even for the same working group*
- went to great lengths in my thesis to allow reproducing data
- \orange{Extended thesis}:
  - 
  - subsections after every plot, table, etc. showing code / commands
    to produce them
  - repository of thesis contains every plot as a vector graphic
  - + CSV files for data in every plot
- *please* keep this point in mind in your own work!

* Summary & conclusion

** Summary & conclusion

*** Summary
- Axion an interesting candidate to 'clean up' physics!
- Septemboard detector successfully deployed at CAST
- MLP trained as classifier based on synthetic data  
- (Unbinned) Bayesian statistics based limit calculation method,
  including systematics via nuisance parameters
- position dependent signal (raytracing) and background
  (interpolation) models
- MCMC to sample 5 dim. integral
- best 'setup' selected based on best expected limit (blind)
- axion-electron limit improved over previous best:  
  \[
  \left(g_{ae} · g_{aγ}\right)_{\text{observed}} \lesssim \SI{7.35e-23}{GeV^{-1}}
  \]
  compared to CAST 2013:
  \[
  \left(g_{ae} · g_{aγ}\right)_{\text{CAST2013}} \lesssim \SI{8.1e-23}{GeV^{-1}}.
  \]
- (plus improved chameleon limit)  

** Summary & conlusion

*** More information?

https://phd.vindaar.de

Will soon include 'extended thesis' with code / commands for every
plot & table + extra information.

*** Conclusion
- detector competitive in background rate compared to similar
  detectors
- despite detector instabilities, managed to utilize all data  
- 7-GridPix layout highly recommended for future detectors
- MLPs (and likely more advanced ML models) extremely useful for
  classification
- significant advances in limit calculation method: 'all encompassing'

** Outlook

*Someone else gets to do it all again for BabyIAXO!*

#+ATTR_LATEX: :width 0.8\textwidth
[[~/phd/Figs/IAXO/babyIAXO_schematic_annotated_ringwald23.png]]

# [[~/phd/Figs/IAXO/iaxo_annotated_schematic.png]]

* Backup     :B_appendix:
:PROPERTIES:
:BEAMER_env: appendix
:END:

** Data instability

*** 
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:

- minor detector instabilities observed
- variation in gas gain   
- recorded charge (small dots, each chip different color) shows
  inverse correlation to temperature in CAST hall $T_{\text{amb}}$
  (purple line)

*** Temperature dependence of observed charge
:PROPERTIES:
:BEAMER_col: 0.6
:BEAMER_env: block
:END:

# #+ATTR_LATEX: :width 1\textwidth
[[~/phd/Figs/behavior_over_time/correlation_fePixel_all_chips_gasgain_period_2018-10-19.pdf]]

# [[~/phd/Figs/behavior_over_time/correlation_feCharge_all_chips_gasgain.pdf]]

** Data instability

Gas gain $⇒$ cluster energy. Multiple gas gains per run (instead of a single) to improve stability.

*** Median cluster energy stability improved by $\SI{90}{min}$ time bins

#+ATTR_LATEX: :width 0.8\textwidth
[[~/phd/Figs/behavior_over_time/median_energy_binned_vs_unbinned.pdf]]

# * Old
# ROPERTIES:
# EAMER_col: 0.5
# EAMER_env: block
# ND:
# BEGIN_CENTER 
# ATTR_LATEX: :width 1.0\textwidth
# [[~/org/Figs/SPSC_Jan_2021/background_mean_energy_binned_90_min_filtered_crSilver_gasgain_runWide.pdf]]
# END_CENTER
# 
# * New 
# ROPERTIES:
# EAMER_col: 0.5
# EAMER_env: block
# ND:
# BEGIN_CENTER 
# ATTR_LATEX: :width 1.0\textwidth
# [[~/org/Figs/SPSC_Jan_2021/background_mean_energy_binned_90_min_filtered_crSilver_gasgain_90min.pdf]]
# END_CENTER

** Main properties for background rejection

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/pixels.pdf]]
#+end_center

** Main properties for background rejection

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/center.pdf]]
#+end_center

** Main properties for background rejection

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/long_short_axis.pdf]]
#+end_center

** Main properties for background rejection

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/rms_trans.pdf]]
#+end_center

** Main properties for background rejection

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/eccentricity.pdf]]
#+end_center

** Main properties for background rejection

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/frac_in_trans_rms.pdf]]
#+end_center

** Main properties for background rejection

#+begin_center
#+ATTR_LATEX: :width 0.75\textwidth
[[~/org/Figs/InGridPropExplanation/length_div_rms_trans.pdf]]
#+end_center

** How to extract gas diffusion  
  
*** Gas diffusion extraction

- one cluster property: 'transverse RMS' ($\mathtt{RMS}_t$) $⇒$ standard distribution of
  pixels in a cluster in the transverse direction (i.e. along the short axis)
- directly proportional to the gas diffusion constant
- problem: distribution is an ensemble. Each individual event is
  statistical!
- Idea: determine diffusion for *a single run* by
  1. Guess a starting diffusion, $σ_T$
  2. Simulate many fake events based on $σ_T$
  3. Compute $\mathtt{RMS}_t$' distribution of fake data
  4. Compute test statistic comparing fake distribution and real data
  5. Compute gradient of test statistic
  6. Update $σ_T$ based on gradient
  7. Stop when fake $\mathtt{RMS}_t$ compatible with real
     $\mathtt{RMS}_t$
  8. Final $σ_T$ value: represents diffusion of real dataset!
     
** MC algorithm fake events

\tiny
1. (optional) sample from different fluorescence lines for an element
   given their relative intensities to define a target energy $E$.
2. sample from the exponential distribution of the absorption length
   for the used gas mixture and target photon energy to get the
   conversion point of the X-ray in the gas (Note: we only sample
   X-rays that convert; those that would traverse the whole chamber
   without conversion are ignored).
3. sample a target charge to achieve for the cluster, based on target energy by sampling from a
   normal distribution with a mean roughly matching detector energy resolution (target energy
   inverted to a charge).
4. sample center position of the cluster within a uniform radius of
   $\SI{4.5}{mm}$ around the chip center.
5. begin the sampling of each electron in the cluster.
6. sample a charge (in number of electrons after amplification) for
   the electron based on a Pòlya distribution of input gas gain (and
   matching normalization & $θ$ constant). Reject the electron if not
   crossing activation threshold (based on real data).
7. sample a radial distance from the cluster center based on gas
   diffusion constant $D_T$ and diffusion after the remaining drift
   distance to the readout plane $z_{\text{drift}}$. Sample twice from
   the 1D version using a normal distribution $\mathcal{N}(μ = 0, σ =
   D_T · \sqrt{z_{\text{drift}}})$ for each dimension. Combine to a
   radius from center, $r = \sqrt{x² + y²}$.
8. sample a random angle, uniform in $(0, 2π]$.
9. convert radius and angle to an $(x, y)$ position of the electron,
   add to the cluster.
10. based on a linear approximation activate between 0 to 4
    neighboring pixels with a slightly reduced gas gain. We never
    activate any neighbors at a charge of $\SI{1000}{e⁻}$ and always
    activate at least one at $\SI{10000}{e⁻}$. Number of activated
    pixels depends on a uniform random number being below one of 4
    different thresholds:
    \[
    N_{\text{neighbor}} = \text{rand}(0, 1) · N < \text{threshold}
    \]
    where the threshold is determined by the linear function described
    by the mentioned condition and $\text{rand}(0, 1)$ is a uniform random
    number in $(0, 1)$.
11. continue sampling electrons until the total charge adds up to the
    target charge. We stop at the value closest to the target
    (before or after adding a final pixel that crosses the target
    charge) to avoid biasing us towards values always larger than the
    target.
12. The final cluster is reconstructed just like any other real
    cluster, using the same calibration functions as the real chip
    (depending on which dataset it should correspond to).
\normalsize

** Cluster discrimination methods

*** Likelihood cut - $\ln\mathcal{L}$ 
:PROPERTIES:
:BEAMER_col: 0.52
:BEAMER_env: block
:END:

- use 3 geometric properties to define likelihood cluster is X-ray
  ($ε, f, l$ referring to 3 variables introduced before)
\[
\mathcal{L}(ε, f, l) = \mathcal{P}_{ε}(ε) \cdot \mathcal{P}_{f}(f) \cdot \mathcal{P}_l(l)
\]
- define $-\ln\mathcal{L}$ cut based on it, such that
\[
ε_{\text{eff}} = \frac{∫_0^{L'} -\ln \mathcal{L}(ε, f, l) \,
\mathrm{d} L}{∫_0^{∞} -\ln \mathcal{L}(ε, f, l) \, \mathrm{d} L} =
\text{EDF @ } ε_{\text{eff}}
\]
- data to define cuts: *calibration data* behind X-ray tube

*** MultiLayer Perceptron - MLP
:PROPERTIES:
:BEAMER_col: 0.52
:BEAMER_env: block
:END:

- fully connected feed-forward network
- 1 input neuron per geometric property, plus 2 non-geometric
- 2 hidden layers (300 neurons each), tanh (or ReLU) activation
  function, 2 output neurons, sigmoid on output layer, mean squared
  error as loss function
- trained using stochastic gradient descent (SGD) for 500k epochs
- training data 250k background and 250k X-rays (and same number for
  validation)

- background data: from actual background dataset 
- X-ray training data: *fully simulated events*, inputs:
  - gas diffusion, gas gain, target energy



** Vetoes

*** Scintillator veto
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:

- scintillators used as pure cut
- for every event passing $\ln\mathcal{L}$, veto if there was
  scintillator trigger $\SI{2.5}{\micro\second}$ before event
- very likely event caused by cosmic
- indeed: most effective in $\sim\SI{3}{keV}$ Ar & $\sim\SI{8}{keV}$
  Cu lines

*** FADC veto
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:

- FADC records induced charge on grid
- only triggers above ~1.5 keV  
- amount of charge and time information
- for X-rays expected FADC signals estimated from X-ray energy and diffusion
- using calibration data determine 1st & 99th percentile of signal
  rise time, cut anything outside
$↦$ efficiency: $\SI{98}{\percent}$

# *** Background rate for end of 2018 data using 'scinti veto'
# :PROPERTIES:
# :BEAMER_col: 0.6
# :BEAMER_env: block
# :END:
#   #+begin_center
# #+ATTR_LATEX: :width 1.0\textwidth
# [[~/org/Figs/statusAndProgress/backgroundRates/IAXO_CM_2022/background_rate_crGold_scinti.pdf]]
# #+end_center

** 'Septem veto'

*** 
:PROPERTIES:
:BEAMER_col: 0.45
:BEAMER_env: block
:END:

$\ln\mathcal{L}$ method looks at *individual* chips. The 'septem veto'
extends this by:
1. perform $\ln\mathcal{L}$ cut on center chip as usual
2. for all clusters $c_i$ on center chip passing $\ln\mathcal{L}$ cut, read
   event data from all chips, build a 'septem event'
3. perform *full* reconstruction (clustering, geometry & energy
   calc. of found clusters) on the 'septem event'
4. if data outside center chip is clustered together with $c_i$, it
   likely now *won't* pass $\ln\mathcal{L}$ cut
5. veto the original cluster $c_i$

$↦$ efficiency: $\SI{78.41}{\%}$
   
*** Example of event vetoed by 'septem veto'
:PROPERTIES:
:BEAMER_col: 0.6
:BEAMER_env: block
:END:

#+begin_center
#+ATTR_LATEX: :width 0.8\textwidth
[[~/phd/Figs/background/exampleEvents/septemEvent_run_162_event_80301.pdf]]
#+end_center


** Efficiencies of Septem and line veto

*** Septem and line veto are not "free"
- efficiencies of septem and line veto come down to random coincidence
  rates
- only center chip has FADC as trigger
- if no trigger: $\SI{2.2}{s}$ long shuttered readout (due to
  full readout of all 7 GridPix taking $>\SI{200}{ms}$; low rate
  experiment therefore reduce dead time)
- X-ray like cluster on center chip: correlation on outside
  chips might be random coincidence!
*** How to estimate efficiency? Generate events with guaranteed random coinc.
- take center chip events with X-ray like clusters
- bootstrap new 'septem events' by combining with outer GridPix data
  of *other events*
- resulting events either do \green{not trigger} septem / line veto or \orange{trigger} $⇒$ *random coincidence*
- fraction of septem / line veto triggers of these events: _random
  coincidence rate_ ($= 1 - \text{efficiency}$)
*** Efficiencies of both vetoes
- septem veto: $\SI{78.41}{\%}$
- line veto: $\SI{86.02}{\%}$
- $⇒$ good improvement to background rate, but high loss in sensitivity!
  

** Axion flux                                                     :noexport:

- $g_{aγ} = \SI[print-unity-mantissa=false]{1e-12}{GeV^{-1}}$ kept constant and implies negligible
  contribution to axion flux (relevant only for $P_{aγ}$)
- LLNL telescope focus point in center of detector chamber
- axion image computed at median conversion point of axion produced
  X-rays, $\sim\SI{0.3}{cm}$ behind detector window
  ($\sim\SI{1.2}{cm}$ from focal spot)

*** Axion flux from Sun                                           :B_block:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :width 1\textwidth
[[~/phd/Figs/axions/differential_solar_axion_flux_by_type.pdf]]

*** Axion image from raytracing
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
[[~/phd/Figs/limit/sanity/axion_image_limit_calc_no_theta.pdf]]

** Detection efficiency and constant contributions                :noexport:

*** 
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:

**** Area, time and conversion

- magnet bore area: $A = π · (\SI{2.15}{cm})² = \SI{14.52}{cm²}$
- tracking time: $t = \SI{161}{h}$ (dead time taken into account)
- $P_{aγ}(g_{aγ} = \SI{1e-12}{GeV⁻¹}) = \num{1.78e-21}$

#+begin_src nim :exports none
import unchained, math
defUnit(GeV⁻¹)
func conversionProb(B: Tesla, L: Meter, g_aγ: GeV⁻¹): UnitLess =
  result = pow( (g_aγ * B.toNaturalUnit * L.toNaturalUnit / 2.0), 2.0 )
echo conversionProb(9.0.T, 9.26.m, 1e-12.GeV⁻¹)
#+end_src

#+RESULTS:
: 1.70182e-21 UnitLess
**** Detection efficiency dominated by:
- $\SI{300}{\nano\meter}$ SiN window at low energie
- LLNL telescope efficiency at medium to high energies
- Argon absorption at high energy and around fluorescence near $\SI{3}{keV}$ 

*** 
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.6
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/phd/Figs/detector/detector_efficiency.pdf]]


** How to compute marginal likelihood?
# *** Calculating the marginal likelihood
# - marginal likelihood a 4-fold integral
# -   

*** Problems of computing the marginal likelihood
- marginal likelihood a 4-fold integral
- evaluation of single likelihood value non trivial
- $⇒$ regular numerical integration routines (simpson, adaptive
  Gauss-Kronrod quadrature etc.) way too slow
  $↦$ "curse of dimensionality"!
*** Solution: Monte Carlo!
In particular: Metropolis-Hastings (Markov Chain Monte Carlo) to
  evaluate integration space
1. let $\vec{x}$ be a random vector in the integration space and
  $f(\vec{x})$ the function to evaluate
2. pick new point $\vec{x}'$ in vicinity of $\vec{x}$
3. sample from random uniform in $[0, 1]$: $u$
4. accept $\vec{x}'$ if $u < \frac{f(\vec{x}')}{f(\vec{x})}$, add
  $\vec{x}'$ to chain and iterate (if $f(\vec{x}') > f(\vec{x})$ every
   new link accepted!)
5. long enough chain samples integration space well
6. throw away first N elements as "burn in"
7. generate multiple chains to be less dependent on starting position

$⇒$ $\mathcal{L}_m$ computed by histogram of sampled $g_{ae}²$ values


** Fun examples!

... but with certain conditions it can get lost!

If MCMC enters region where $f(\vec{x}') \approx f(\vec{x})$ (e.g. no
contribution to $f$ anymore) *every* new link will be accepted,
because $\frac{f(\vec{x}')}{f(\vec{x})} \approx 1$!

*** $θ_s, θ_b, g_{ae}²$                                          :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/org/Figs/statusAndProgress/limitCalculation/MCMC/mcmc_lines_long_0_likelihood_chain_thetas_sb.png]]

*** $θ_x, θ_y, g_{ae}²$                                          :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/org/Figs/statusAndProgress/limitCalculation/MCMC/mcmc_lines_long_0_likelihood_chain_thetas_xy.png]]



** Signal $s_i$

  Each parameter with a subscript $i$ is the corresponding value that
  the candidate has we are currently looking at (e.g. $E_i$ is the energy
  of the recorded candidate $i$ used to compute the expected signal).
  #+NAME: eq:limit_method_signal_si
  \begin{equation}
  s_i(g_{ae}) = f(g_{ae}, E_i) · A · t · P_{a \rightarrow γ} · ε(E_i) · r(x_i, y_i)
  \end{equation}
  where:
  - $f(g_{ae}, E_i)$: axion flux at energy $E_i$ in units of
    $\si{keV^{-1}.cm^{-2}.s^{-1}}$ and function of $g_{ae}²$
  - $A$: area of the magnet bore in $\si{cm²}$
  - $t$: tracking time in $\si{s}$
  - $P_{a \rightarrow γ}$: conversion probability of the axion
    converting into a photon computed via
    \[
    P_{a \rightarrow γ} = \left( \frac{g_{aγ} B L}{2} \right)²
    \]
    written in *natural units* ($B, L$ need conversion!)
    #+begin_comment
    (meaning if we wish to use the equation
    as written here we need to convert $B = \SI{9}{T}$ and $L =
    \SI{9.26}{m}$ into values expressed in powers of electronvolt
    $\si{eV}$.
    #+end_comment
  - $ε(E_i)$: combined detection efficiency, i.e. the
    combination of X-ray telescope effective area, the transparency of
    the detector window and the absorption probability of an X-ray in
    the gas.
  - $r(x_i, y_i)$: expected amount of flux from the solar axion
    flux after it is focused by the X-ray telescope in the readout
    plane of the detector at the candidate's position $(x_i, y_i)$
    (this requires a raytracing model). It should be expressed as a
    fractional value in units of $\si{cm^{-2}}$.
  As a result the units of $s_i$ are then given in
  $\si{keV^{-1}.cm^{-2}}$ with the tracking time integrated out.

** Ingredients in detail :noexport:

*** Axion flux

- rescale by $\frac{g_{ae}²}{g^{'2}_{ae}}$
   
*** Area, tracking time and conversion probability

- magnet bore area: $A = π · (\SI{2.15}{cm})² = \SI{14.52}{cm²}$
- tracking time: $t = \SI{161}{h}$ (dead time taken into account)
- $P_{aγ}(g_{aγ} = \SI{1e-12}{GeV⁻¹}) = \num{1.78e-21}$

#+begin_src nim :exports none
import unchained, math
defUnit(GeV⁻¹)
func conversionProb(B: Tesla, L: Meter, g_aγ: GeV⁻¹): UnitLess =
  result = pow( (g_aγ * B.toNaturalUnit * L.toNaturalUnit / 2.0), 2.0 )
echo conversionProb(9.0.T, 9.26.m, 1e-12.GeV⁻¹)
#+end_src

#+RESULTS:
: 1.70182e-21 UnitLess
  
*** Efficiency

- plot of combined efficiencies with constituents
  
*** Axion image

- plot with strongback

*** Background

- 2D interpolation plot at one energy

** Background $b_i$ interpolation algo

Background dataset: define background hypothesis $b_i$, as a
function of candidate pos. $(x_i, y_i)$ and energy $E_i$,

\[
b_i(x_i, y_i, E_i) = \frac{I(x_i, y_i, E_i)}{W(x_i, y_i, E_i)}
\]

where $I$ is an 'intensity' defined over clusters within a range $R$
and a normalization weight $W$:

\[
I(x, y, E) = \sum_{b ∈ \{ \mathcal{D}(\vec{x}_b, \vec{x}) \leq R \}}\mathcal{M}(\vec{x}_b, E_b)
  = \sum_{b ∈ \{ \mathcal{D}(\vec{x}_b, \vec{x}) \leq R \} } \exp \left[ -\frac{1}{2} \mathcal{D}² / σ² \right] \text{ for clarity w/o arguments}
\]

where we introduce $\mathcal{M}$ to refer to the measure we use and
$\mathcal{D}$ to our metric:

\begin{equation*}
\mathcal{D}( (\vec{x}_1, E_1), (\vec{x}_2, E_2)) =
  \begin{cases}
    (\vec{x}_1 - \vec{x}_2)² \text{ if } |E_1 - E_2| \leq R \\
    ∞ \text{ if } (\vec{x}_1 - \vec{x}_2)² > R² \\
    ∞ \text{ if } |E_1 - E_2| > R
  \end{cases}
\end{equation*}

Finally, the normalization weight is the 'volume' of our 'cylinder'
described by $\mathcal{M}$ and $\mathcal{D}$:

\[
W(x', y', E') = ∫_{\mathcal{D}(\vec{x'}, \vec{x}) \leq R} ∫_{E' - E_c}^{E' + E_c} \mathcal{M}(x', y')\, \mathrm{d}x\, \mathrm{d}y\, \mathrm{d} E
\]

** Expected limit? Sampling toy candidates from background model
*** Example: Background model of energy bins $E_i$, then:
  
  \[
  B = \{ P_{\text{Pois}}(k; λ = b_i) \: | \: \text{for all energy bins } E_i \},
  \]

- background is the set of all energy bins $E_i$,
- each bin content a Poisson distribution with a mean and expectation value of $λ = b_i$ counts

- toy candidates: sample from each channel's Poisson distribution   

# *** In practice
# - sample from $(x, y, E)$ dependent background model by
#   generating a grid
# - in each grid volume distribute all drawn candidates uniformly in
#   position and energy

*** Expected limit:  
Median of sets of representative toy candidates. If $L_{t_i}$ is
the limit of the toy candidate set $t_i$, the expected limit
$\langle L \rangle$ is
defined as

\[
\langle L \rangle = \mathrm{median}( \{ L_{t_i} \} )
\]

If the number of toy candidate sets is large enough the expected
limit should prove accurate. The real limit will then be below or
above with $\SI{50}{\%}$ chance each.

** Candidate sampling

Build $(x, y, E)$ grid of $(10, 10, 20)$ cells. Each cell defines its
own expected counts as a Poisson distribution based on clusters in
that cell.

*** Slice (in energy) of sampling grid                           :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/limit/sanity/candidate_sampling_grid_index_5.pdf]]

*** Example toy candidates                                       :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :width 0.9\textwidth
[[~/phd/Figs/limit/sanity/example_candidates_1.pdf]]

** Example of expected limit

Computing many limits based on different toy candidate sets yields a
histogram whose median is the expected limit.

*** Histogram of $\num{50000}$ MC limits
#+ATTR_LATEX: :width 0.7\textwidth
[[~/phd/Figs/limit/mc_limit_lkMCMC_skInterpBackground_nmc_50000_uncertainty_ukUncertain_σs_0.0276_σb_0.0028_posUncertain_puUncertain_σp_0.0500_nmc_50k_pretty.pdf]]

** Different expected limits
\vspace{-0.1cm}
*** \normalsize Many different parameters (plus a large selection of additional parameters)
\small
- $\ln \mathcal{L}$ or MLP
- software efficiency of method
- FADC veto software efficiency
- Septem veto: yes/no 
- Line veto: yes/no

Each may improve background rate, but limits sensitivity.

Compute expected limit for each setup: method with \green{best expected limit} $⇒$ *final method*
\normalsize

*** \normalsize Limit given as $g_{ae}·g_{aγ}$ with $g_{aγ} = \SI{1e-12}{GeV^{-1}}$ 

\footnotesize
#+ATTR_LATEX: :align lrllrrr :booktabs t
| Method |  $ε_S$ | Septem | Line | Total eff. | Limit no signal [$\si{GeV^{-1}}$] | Expected limit [$\si{GeV^{-1}}$] |
|--------+--------+--------+------+------------+-----------------------------------+----------------------------------|
| MLP    | 0.9107 | false  | true |     0.7677 | \num{5.96e-23}                    | \num{7.58e-23}                   |
| MLP    | 0.9718 | false  | true |     0.8192 | \num{5.84e-23}                    | \num{7.62e-23}                   |
| MLP    | 0.8473 | false  | true |     0.7142 | \num{6.14e-23}                    | \num{7.67e-23}                   |
| LnL    |    0.9 | false  | true |     0.7586 | \num{6.04e-23}                    | \num{7.74e-23}                   |
| MLP    | 0.7925 | false  | true |     0.6681 | \num{6.28e-23}                    | \num{7.82e-23}                   |
| MLP    | 0.7398 | false  | true |     0.6236 | \num{6.57e-23}                    | \num{7.99e-23}                   |
| LnL    |    0.8 | false  | true |     0.6743 | \num{6.31e-23}                    | \num{8.02e-23}                   |
| MLP    | 0.9718 | true   | true |     0.6976 | \num{6.24e-23 }                   | \num{8.06e-23}                   |
# | MLP    | 0.9107 | true   | true  |     0.6537 |      4.1370e-21 |                       8.0878e-23 |
# | MLP    | 0.9718 | true   | false |     0.7467 |      3.5802e-21 |                       8.1653e-23 |
# | MLP    | 0.9107 | true   | false |     0.6998 |      3.9193e-21 |                       8.2216e-23 |

\vspace{-0.15cm}
to compare: $g_{ae}·g_{aγ} = \SI{8.1e-23}{GeV^{-1}}$ CAST 2013

# OLd table
# | Method |  $ε_S$ | FADC  | $ε_{\text{FADC}}$ | Septem | Line | Total eff. | Limit no signal | Expected Limit |
# |--------+--------+-------+-------------------+--------+------+------------+-----------------+----------------|
# | MLP    | 0.9107 | true  |              0.98 | false  | true |     0.7677 |      6.0315e-23 |     7.7467e-23 |
# | MLP    | 0.9718 | true  |              0.98 | false  | true |     0.8192 |      5.7795e-23 |     7.8596e-23 |
# | MLP    | 0.8474 | true  |              0.98 | false  | true |     0.7143 |      6.1799e-23 |     7.8876e-23 |
# | LnL    |    0.9 | true  |              0.98 | false  | true |     0.7587 |      6.1524e-23 |     7.9443e-23 |
# | LnL    |    0.9 | false |              0.98 | false  | true |     0.7742 |      6.0733e-23 |     8.0335e-23 |
# | MLP    | 0.7926 | true  |              0.98 | false  | true |     0.6681 |      6.5733e-23 |     8.1569e-23 |
# | MLP    | 0.7398 | true  |              0.98 | false  | true |     0.6237 |      6.8165e-23 |     8.1907e-23 |
\normalsize

*** Expected limits :noexport:

The first row has 30k samples, the rest 15k. All other entries in the
table on the slide above only 1k samples.

|      ε | Type | Scinti | FADC | ε_FADC | Septem | Line | eccLineCut | ε_Septem | ε_Line | ε_SeptemLine | Total eff. | Limit no signal [GeV⁻¹] | Expected limit [GeV⁻¹] | Exp. limit variance [GeV⁻¹] | Exp. limit σ [GeV⁻¹] |
|--------+------+--------+------+--------+--------+------+------------+----------+--------+--------------+------------+-------------------------+------------------------+-----------------------------+----------------------|
| 0.9107 | MLP  | true   | true |   0.98 | false  | true |          1 |   0.7841 | 0.8602 |       0.7325 |     0.7677 |              5.9559e-23 |             7.5824e-23 |                  6.0632e-51 |           7.7866e-26 |
| 0.9718 | MLP  | true   | true |   0.98 | false  | true |          1 |   0.7841 | 0.8602 |       0.7325 |     0.8192 |              5.8374e-23 |             7.6252e-23 |                  1.6405e-50 |           1.2808e-25 |
| 0.8474 | MLP  | true   | true |   0.98 | false  | true |          1 |   0.7841 | 0.8602 |       0.7325 |     0.7143 |              6.1381e-23 |             7.6698e-23 |                  1.4081e-50 |           1.1866e-25 |
| 0.7926 | MLP  | true   | true |   0.98 | false  | true |          1 |   0.7841 | 0.8602 |       0.7325 |     0.6681 |              6.2843e-23 |             7.8222e-23 |                  1.3589e-50 |           1.1657e-25 |
| 0.7398 | MLP  | true   | true |   0.98 | false  | true |          1 |   0.7841 | 0.8602 |       0.7325 |     0.6237 |              6.5704e-23 |             7.9913e-23 |                  1.6073e-50 |           1.2678e-25 |


** Sun $⇔$ Earth distance during CAST data taking

#+ATTR_LATEX: :width 0.7\textwidth
[[~/phd/Figs/systematics/sun_earth_distance_cast_solar_tracking.pdf]]

** Background rate without vetoes

*** Background rate MLP ($ε = \SI{80}{\%}$) vs. LnL ($ε = \SI{80}{\%}$)
#+ATTR_LATEX: :width 0.7\textwidth
[[~/org/Figs/statusAndProgress/backgroundRates/limitMethodTalk/background_rate_run2_3_mlp_0.85_plus_vetoes.pdf]]

** Systematics. s/b for candidates

#+ATTR_LATEX: :width 0.7\textwidth
[[~/org/Figs/statusAndProgress/limitSanityChecks/candidates_signal_over_background_many_sens.pdf]]


** Real candidates signal over background

[[~/phd/Figs/trackingCandidates/real_candidates_signal_over_background.pdf]]

** Real candidates rate vs background rate

[[~/phd/Figs/trackingCandidates/rate_real_candidates_vs_background_rate_crAll_mlp_0.95_scinti_fadc_line.pdf]]


** A limit?

Context:
- experiment looking for new physics
- 1 dataset sensitive, 1 dataset insensitive
- any entry in sensitive dataset (after cleaning) a _candidate_ drawn
  from $s + b$ (signal + background) distribution
- any entry in insensitive dataset drawn from background only

Goal:
- compute upper limit on parameter describing new physics
  (e.g. coupling constant) 
- at \SI{95}{\%} confidence $s + b$ compatible with $b$ only

Condition and definition:
- assume experiment has some "channels" of our choice, modeled by
  Poisson distribution
  
  \[
  P_{\text{Pois}}(k; λ) = \frac{λ^k e^{-λ}}{k!}.
  \]
  
- probability for $k$ counts given mean counts $λ$
- $λ$ defined by our signal (theory!) & background hypotheses (data!)
- $k$ given by experimental data (candidates!)

- likelihood to measure experimental data given hypotheses: product of
  all channels
  \[
  \mathcal{L}(λ) = \prod_i P_{i, \text{Pois}}(k_i; λ_i) = \prod_i \frac{λ_i^{k_i} e^{-λ_i}}{k_i!}
  \]
- function of $λ$ and not $k$! 
  
** Practical likelihood

Now define likelihood for a limit calculation (technically extended
likelihood function):

\[
\Lhood(g_{ae}) = \prod_i \frac{P_{\text{pois}}(c_i; s_i(g_{ae}) + b_i)}{P_{\text{pois}}(c_i; b_i)}
\]

- $s_i, b_i, c_i$ signal, background, candidates in channel $i$
- $s_i(g_{ae})$ depends on the coupling constant
- _important_: $\Lhood$ explicitly is *not* a function of the candidates
  $c_i$. Our intent is to ask "likelihood to measure *our data* given
  our model".
  
  $⇒$ $\Lhood(g_{ae})$ encodes all relevant info about an experiment,
  multiple $\Lhood$  can be combined!

Simplify to:

\[
\Lhood(g_{ae}) = e^{-s_\text{tot}} \prod_i \left(1 + \frac{s_i}{b_i}\right)^{c_i}
\]

Choice of channels $i$ is ours! Choose bins in time, s.t. either 0 or
1 candidates in bin:

\[
\Lhood(g_{ae}) = e^{-s_\text{tot}} \prod_i \left(1 +
\frac{s_i}{b_i}\right)^{\orange{c_i =\, 0 \text{ or } 1}}
\]


** Systematics

| Uncertainty                                    | $s$ or $b$?    | rel. $σ$ [%] | bias?                             |
|------------------------------------------------+----------------+--------------+-----------------------------------|
| Earth $⇔$ Sun distance                         | $s$            |       0.7732 | none                              |
| Window thickness ($±\SI{10}{nm}$)              | $s$            |       0.5807 | none                              |
| Solar models                                   | $s$            |          < 1 | none                              |
| Magnet length ($-\SI{1}{cm}$)                  | $s$            |       0.2159 | likely 9.26m                      |
| Magnet bore diameter ($±\SI{0.5}{mm}$)         | $s$            |       2.3255 | measurements indicate 42.x - 43   |
| Window rotation (30° ± 0.5°)                   | $s$            |       0.1852 | none                              |
| Software efficiency                            | $s$            |        < 2.0 | exact value depends on parameters |
|------------------------------------------------+----------------+--------------+-----------------------------------|
| Gas gain time binning                          | $b$            |       0.2692 | to 0                              |
| Reference dist interp (CDL morphing)           | $b$            |       0.0844 | none                              |
|------------------------------------------------+----------------+--------------+-----------------------------------|
| Alignment (signal, related mounting)           | $s$ (position) |       0.5 mm | none                              |
| Detector mounting precision ($±\SI{0.25}{mm}$) | $s$ (position) |      0.25 mm | none                              |

*** Combined systematic $σ_i$
Compute based on sum of squares: $\bar{σ} = \sqrt{\sum_i σ_i²}$:
- $σ_s \leq \SI{3.38}{\percent}$ (assuming $σ_{\text{software}} = \SI{2}{\%}$)
- $σ_b = \SI{0.28}{\percent}$
- $σ_{xy} = \SI{5}{\percent}$ (chosen, uncertainty numbers are bounds)

** Likelihood with systematics

*** Bayesian approach to systematics
"Nuisance parameters" (NP) for each systematic $σ$:
  - signal (1): $θ_s$ with $σ_s$
  - background (1): $θ_b$ with $σ_b$
  - position (2): $θ_x, θ_y$ with $σ_{x,y}$
  ("Nuisance" $⇐$ do not care about their "value")

One normal distribution for each NP:
  \begin{align*}
  \mathcal{L}' &= \left(\prod_i \frac{P_{\text{pois}}(n_i; s_i'' + b_i')}{P_{\text{pois}}(n_i; b_i')}\right) \cdot \mathcal{N}(θ_s, σ_s)
  \cdot \mathcal{N}(θ_b, σ_b) \cdot \mathcal{N}(θ_x, σ_x) \cdot \mathcal{N}(θ_y, σ_y) \\
  \mathcal{L}'(g, θ_s, θ_b, θ_x, θ_y) &= e^{s'_\text{tot}} \prod_i (1 + \frac{s_i''}{b_i'}) ·
    \exp\left[-\frac{1}{2} \left(\frac{θ_s}{σ_s}\right)² 
      -\frac{1}{2} \left(\frac{θ_b}{σ_b}\right)² 
      -\frac{1}{2} \left(\frac{θ_x}{σ_x}\right)² 
      -\frac{1}{2} \left(\frac{θ_y}{σ_y}\right)² \right]
  \end{align*}

with $a' = a ( 1 + θ_a )$ and $a'' = a ( 1 + θ_a ) ( 1 + θ_x ) ( 1 + θ_y )$

- s.t. 0 yields our "best guess", $\mathcal{N}(θ_a = 0, σ_a) = 1$ ($\mathcal{L}$ unchanged) 
- deviation inc. / dec. related parameter (e.g. signal), but penalizes
  likelihood
  $\mathcal{N}(θ_a \neq 0, σ_a) < 1$

** Example of nuisance parameter effect

*** Position nuisance parameters $θ_x, θ_y$
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.4
:END:

- $θ_x = θ_y = 0 ⇒$ axion image in chip center
- $θ_x, θ_y \neq 0 ⇒$ axion image moves, at $0.5$ on chip boundary
- *but* likelihood penalized by $\exp\left[ -\frac{θ_{x,y}}{2 σ_{x,y}²} \right]$

*** Axion image at $θ_x = θ_y = 0.6$
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.6
:END:
[[~/phd/Figs/limit/sanity/axion_image_limit_calc_theta_0_6.pdf]]

** Effect of $θ_x, θ_y$ on likelihood 

Comparison of examples with many candidates in signal sensitive
region. The larger the systematic ($σ_{x,y}$), the more spread out
contribution to $\mathcal{L}$ become. More sensitive to "regions of
large $s/b$"!

*** $σ_{x,y} = 0.05$                                             :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/org/Figs/statusAndProgress/limitSanityChecks/likelihood_sigma_0.05_manyθx_θy.pdf]]

*** $σ_{x,y} = 0.25$                                             :B_column:
:PROPERTIES:
:BEAMER_env: block
:BEAMER_col: 0.5
:END:
#+ATTR_LATEX: :width 1\textwidth
[[~/org/Figs/statusAndProgress/limitSanityChecks/likelihood_sigma_0.25_manyθx_θy.pdf]]

